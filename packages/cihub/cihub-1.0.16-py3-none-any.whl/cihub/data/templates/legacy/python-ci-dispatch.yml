# ============================================================================
# CI/CD Hub - Python Dispatch Workflow Template
# ============================================================================
# Copy this file to your repo: .github/workflows/python-ci-dispatch.yml
# This enables the hub orchestrator to dispatch CI runs to your repo.
#
# This workflow is ONLY triggered by hub dispatch - it won't run on push/PR.
# Your existing workflows remain untouched.
#
# All tools are controlled by input toggles (run_*). Results are captured
# in report.json for aggregation back to the hub.
# ============================================================================

name: "Hub: Python CI"

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      run_pytest:
        description: 'Run pytest with coverage'
        required: false
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        required: false
        type: boolean
        default: true
      run_black:
        description: 'Run Black format check'
        required: false
        type: boolean
        default: true
      run_isort:
        description: 'Run isort import check'
        required: false
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit security scan'
        required: false
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit'
        required: false
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy type checking'
        required: false
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        required: false
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST'
        required: false
        type: boolean
        default: true
      run_trivy:
        description: 'Run Trivy scan'
        required: false
        type: boolean
        default: true
      run_codeql:
        description: 'Run CodeQL analysis'
        required: false
        type: boolean
        default: true
      run_docker:
        description: 'Run Docker build/test (requires docker-compose.yml)'
        required: false
        type: boolean
        default: false
      coverage_min:
        description: 'Minimum coverage threshold'
        required: false
        type: number
        default: 70
      retention_days:
        description: 'Artifact retention days'
        required: false
        type: number
        default: 30
      workdir:
        description: 'Working directory'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    env:
      WORKDIR: ${{ inputs.workdir || '.' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      # ========================================================================
      # Install Dependencies
      # ========================================================================
      - name: Install Dependencies
        working-directory: ${{ env.WORKDIR }}
        run: |
          pip install --upgrade pip
          # Core testing
          pip install pytest pytest-cov
          # Linting & formatting
          pip install ruff black isort
          # Security
          pip install bandit pip-audit
          # Type checking
          pip install mypy
          # Mutation testing
          pip install mutmut
          # Install repo dependencies
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "requirements-dev.txt" ]; then pip install -r requirements-dev.txt; fi
          if [ -f "pyproject.toml" ]; then pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true; fi

      # ========================================================================
      # pytest with coverage
      # ========================================================================
      - name: Run pytest with coverage
        if: inputs.run_pytest
        working-directory: ${{ env.WORKDIR }}
        id: pytest
        continue-on-error: true
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term -v 2>&1 | tee test-output.txt || true

          COVERAGE=0
          PASSED=0; FAILED=0; SKIPPED=0
          if [ -f "coverage.xml" ]; then
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1 | awk '{printf "%.0f", $1 * 100}')
          fi
          # Extract test counts from output
          PASSED=$(grep -oP '\d+(?= passed)' test-output.txt | head -1 || echo 0)
          FAILED=$(grep -oP '\d+(?= failed)' test-output.txt | head -1 || echo 0)
          SKIPPED=$(grep -oP '\d+(?= skipped)' test-output.txt | head -1 || echo 0)

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%, Tests: $PASSED passed, $FAILED failed, $SKIPPED skipped"

      # ========================================================================
      # Ruff Linter
      # ========================================================================
      - name: Run Ruff
        if: inputs.run_ruff
        working-directory: ${{ env.WORKDIR }}
        id: ruff
        continue-on-error: true
        run: |
          ruff check . --output-format=json > ruff-report.json 2>/dev/null || true
          ERRORS=0
          if [ -f "ruff-report.json" ]; then
            ERRORS=$(jq 'length' ruff-report.json 2>/dev/null || echo 0)
          fi
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Ruff issues: $ERRORS"

      # ========================================================================
      # Black Format Check
      # ========================================================================
      - name: Run Black
        if: inputs.run_black
        working-directory: ${{ env.WORKDIR }}
        id: black
        continue-on-error: true
        run: |
          black --check . 2>&1 | tee black-output.txt || true
          # Count files that would be reformatted
          ISSUES=$(grep -c "would reformat" black-output.txt 2>/dev/null || echo 0)
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Black formatting issues: $ISSUES"

      # ========================================================================
      # isort Import Check
      # ========================================================================
      - name: Run isort
        if: inputs.run_isort
        working-directory: ${{ env.WORKDIR }}
        id: isort
        continue-on-error: true
        run: |
          isort --check-only --diff . 2>&1 | tee isort-output.txt || true
          # Count files with import issues
          ISSUES=$(grep -c "^---" isort-output.txt 2>/dev/null || echo 0)
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "isort import issues: $ISSUES"

      # ========================================================================
      # Bandit Security Scan
      # ========================================================================
      - name: Run Bandit
        if: inputs.run_bandit
        working-directory: ${{ env.WORKDIR }}
        id: bandit
        continue-on-error: true
        run: |
          bandit -r . -f json -o bandit-report.json 2>/dev/null || true
          HIGH=0; MEDIUM=0; LOW=0
          if [ -f "bandit-report.json" ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json 2>/dev/null || echo 0)
            LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-report.json 2>/dev/null || echo 0)
          fi
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Bandit: High=$HIGH, Medium=$MEDIUM, Low=$LOW"

      # ========================================================================
      # pip-audit Dependency Check
      # ========================================================================
      - name: Run pip-audit
        if: inputs.run_pip_audit
        working-directory: ${{ env.WORKDIR }}
        id: pipaudit
        continue-on-error: true
        run: |
          pip-audit --format=json --output=pip-audit-report.json 2>/dev/null || true
          VULNS=0
          if [ -f "pip-audit-report.json" ]; then
            # pip-audit can have different formats, try both
            VULNS=$(jq 'if type == "array" then length else .dependencies | map(select(.vulns | length > 0)) | length end' pip-audit-report.json 2>/dev/null || echo 0)
          fi
          echo "vulns=$VULNS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "pip-audit vulnerabilities: $VULNS"

      # ========================================================================
      # mypy Type Checking
      # ========================================================================
      - name: Run mypy
        if: inputs.run_mypy
        working-directory: ${{ env.WORKDIR }}
        id: mypy
        continue-on-error: true
        run: |
          mypy . --ignore-missing-imports 2>&1 | tee mypy-output.txt || true
          # Count error lines
          ERRORS=$(grep -c ": error:" mypy-output.txt 2>/dev/null || echo 0)
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "mypy errors: $ERRORS"

      # ========================================================================
      # mutmut Mutation Testing
      # ========================================================================
      - name: Run mutmut
        if: inputs.run_mutmut
        working-directory: ${{ env.WORKDIR }}
        id: mutmut
        continue-on-error: true
        timeout-minutes: 15
        run: |
          KILLED=0; SURVIVED=0; SCORE=0; TOTAL=0

          # mutmut 3.x reads config from pyproject.toml [tool.mutmut] section
          timeout 600 mutmut run 2>&1 | tee mutmut-run.log || true

          if command -v mutmut &> /dev/null; then
            mutmut results > mutmut-results.txt 2>&1 || true
            RESULTS=$(cat mutmut-results.txt 2>/dev/null || echo "")
            KILLED=$(echo "$RESULTS" | grep -oP 'Killed:\s*\K\d+' || echo 0)
            SURVIVED=$(echo "$RESULTS" | grep -oP 'Survived:\s*\K\d+' || echo 0)
            # Try alternate format
            if [ "$KILLED" = "0" ] && [ "$SURVIVED" = "0" ]; then
              KILLED=$(echo "$RESULTS" | grep -oE '[0-9]+ killed' | grep -oE '[0-9]+' | head -1 || echo 0)
              SURVIVED=$(echo "$RESULTS" | grep -oE '[0-9]+ survived' | grep -oE '[0-9]+' | head -1 || echo 0)
            fi
            TOTAL=$((KILLED + SURVIVED))
            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$((KILLED * 100 / TOTAL))
            fi
          fi

          if [ "$TOTAL" -eq 0 ]; then
            echo "::warning::mutmut found 0 mutations. Ensure [tool.mutmut] is configured in pyproject.toml."
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Mutation Score: $SCORE% (Killed: $KILLED, Survived: $SURVIVED)"

      # ========================================================================
      # Semgrep SAST
      # ========================================================================
      - name: Run Semgrep
        if: inputs.run_semgrep
        working-directory: ${{ env.WORKDIR }}
        id: semgrep
        continue-on-error: true
        run: |
          pip install semgrep --quiet
          semgrep --config=auto --json --output=semgrep-report.json . 2>/dev/null || true

          FINDINGS=0
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)
          fi
          echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Semgrep findings: $FINDINGS"

      # ========================================================================
      # Trivy Filesystem Scan
      # ========================================================================
      - name: Run Trivy
        if: inputs.run_trivy
        working-directory: ${{ env.WORKDIR }}
        id: trivy
        continue-on-error: true
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          trivy fs --format json --output trivy-report.json . 2>/dev/null || true

          CRITICAL=0; HIGH=0
          if [ -f "trivy-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-report.json 2>/dev/null || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-report.json 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Trivy vulns: Critical=$CRITICAL, High=$HIGH"

      # ========================================================================
      # Generate CI Report (captures ALL tool results)
      # ========================================================================
      - name: Generate CI Report
        if: always()
        working-directory: ${{ env.WORKDIR }}
        run: |
          mkdir -p reports
          cat > reports/report.json << 'JSONEOF'
          {
            "repo": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "run_id": "${{ github.run_id }}",
            "language": "python",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "results": {
              "coverage": ${{ steps.pytest.outputs.ran == 'true' && steps.pytest.outputs.coverage || 'null' }},
              "tests_passed": ${{ steps.pytest.outputs.ran == 'true' && steps.pytest.outputs.passed || 'null' }},
              "tests_failed": ${{ steps.pytest.outputs.ran == 'true' && steps.pytest.outputs.failed || 'null' }},
              "mutation_score": ${{ steps.mutmut.outputs.ran == 'true' && steps.mutmut.outputs.score || 'null' }},
              "ruff_errors": ${{ steps.ruff.outputs.ran == 'true' && steps.ruff.outputs.errors || 'null' }},
              "black_issues": ${{ steps.black.outputs.ran == 'true' && steps.black.outputs.issues || 'null' }},
              "isort_issues": ${{ steps.isort.outputs.ran == 'true' && steps.isort.outputs.issues || 'null' }},
              "mypy_errors": ${{ steps.mypy.outputs.ran == 'true' && steps.mypy.outputs.errors || 'null' }},
              "bandit_high": ${{ steps.bandit.outputs.ran == 'true' && steps.bandit.outputs.high || 'null' }},
              "bandit_medium": ${{ steps.bandit.outputs.ran == 'true' && steps.bandit.outputs.medium || 'null' }},
              "pip_audit_vulns": ${{ steps.pipaudit.outputs.ran == 'true' && steps.pipaudit.outputs.vulns || 'null' }},
              "semgrep_findings": ${{ steps.semgrep.outputs.ran == 'true' && steps.semgrep.outputs.findings || 'null' }},
              "trivy_critical": ${{ steps.trivy.outputs.ran == 'true' && steps.trivy.outputs.critical || 'null' }},
              "trivy_high": ${{ steps.trivy.outputs.ran == 'true' && steps.trivy.outputs.high || 'null' }}
            },
            "tools_ran": {
              "pytest": ${{ steps.pytest.outputs.ran == 'true' }},
              "ruff": ${{ steps.ruff.outputs.ran == 'true' }},
              "black": ${{ steps.black.outputs.ran == 'true' }},
              "isort": ${{ steps.isort.outputs.ran == 'true' }},
              "bandit": ${{ steps.bandit.outputs.ran == 'true' }},
              "pip_audit": ${{ steps.pipaudit.outputs.ran == 'true' }},
              "mypy": ${{ steps.mypy.outputs.ran == 'true' }},
              "mutmut": ${{ steps.mutmut.outputs.ran == 'true' }},
              "semgrep": ${{ steps.semgrep.outputs.ran == 'true' }},
              "trivy": ${{ steps.trivy.outputs.ran == 'true' }}
            }
          }
          JSONEOF

      # ========================================================================
      # Upload Artifacts
      # ========================================================================
      - name: Upload CI Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: |
            ${{ env.WORKDIR }}/reports/
            ${{ env.WORKDIR }}/coverage.xml
            ${{ env.WORKDIR }}/*-report.json
            ${{ env.WORKDIR }}/*-output.txt
            ${{ env.WORKDIR }}/mutmut-*.txt
            ${{ env.WORKDIR }}/mutmut-*.log
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      # ========================================================================
      # Generate Summary
      # ========================================================================
      - name: Generate Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Hub CI Report: ${{ github.repository }}

          **Branch:** \`${{ github.ref_name }}\` | **Python:** \`${{ inputs.python_version }}\`

          ## Quality Metrics
          | Metric | Value | Status |
          |--------|-------|--------|
          | Coverage | ${{ steps.pytest.outputs.coverage || '-' }}% | ${{ steps.pytest.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Tests Passed | ${{ steps.pytest.outputs.passed || '-' }} | ${{ steps.pytest.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Tests Failed | ${{ steps.pytest.outputs.failed || '-' }} | ${{ steps.pytest.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Mutation Score | ${{ steps.mutmut.outputs.score || '-' }}% | ${{ steps.mutmut.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |

          ## Code Quality
          | Tool | Issues | Status |
          |------|--------|--------|
          | Ruff | ${{ steps.ruff.outputs.errors || '-' }} | ${{ steps.ruff.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Black | ${{ steps.black.outputs.issues || '-' }} | ${{ steps.black.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | isort | ${{ steps.isort.outputs.issues || '-' }} | ${{ steps.isort.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | mypy | ${{ steps.mypy.outputs.errors || '-' }} | ${{ steps.mypy.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |

          ## Security
          | Tool | High | Medium | Status |
          |------|------|--------|--------|
          | Bandit | ${{ steps.bandit.outputs.high || '-' }} | ${{ steps.bandit.outputs.medium || '-' }} | ${{ steps.bandit.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | pip-audit | ${{ steps.pipaudit.outputs.vulns || '-' }} vulns | - | ${{ steps.pipaudit.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Trivy | ${{ steps.trivy.outputs.critical || '-' }} crit / ${{ steps.trivy.outputs.high || '-' }} high | - | ${{ steps.trivy.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Semgrep | ${{ steps.semgrep.outputs.findings || '-' }} findings | - | ${{ steps.semgrep.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          EOF
