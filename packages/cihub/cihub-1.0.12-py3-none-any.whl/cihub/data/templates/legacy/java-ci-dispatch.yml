# ============================================================================
# CI/CD Hub - Java Dispatch Workflow Template
# ============================================================================
# Copy this file to your repo: .github/workflows/java-ci-dispatch.yml
# This enables the hub orchestrator to dispatch CI runs to your repo.
#
# This workflow is ONLY triggered by hub dispatch - it won't run on push/PR.
# Your existing workflows remain untouched.
#
# All tools are controlled by input toggles (run_*). Results are captured
# in report.json for aggregation back to the hub.
# ============================================================================

name: "Hub: Java CI"

on:
  workflow_dispatch:
    inputs:
      java_version:
        description: 'Java version'
        required: false
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven/gradle)'
        required: false
        type: string
        default: 'maven'
      run_jacoco:
        description: 'Run JaCoCo coverage'
        required: false
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        required: false
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        required: false
        type: boolean
        default: true
      run_pmd:
        description: 'Run PMD analysis'
        required: false
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP dependency check'
        required: false
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing'
        required: false
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST'
        required: false
        type: boolean
        default: true
      run_trivy:
        description: 'Run Trivy scan'
        required: false
        type: boolean
        default: true
      run_codeql:
        description: 'Run CodeQL analysis'
        required: false
        type: boolean
        default: true
      run_docker:
        description: 'Run Docker build/test (requires docker-compose.yml)'
        required: false
        type: boolean
        default: false
      coverage_min:
        description: 'Minimum coverage threshold'
        required: false
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        required: false
        type: number
        default: 70
      owasp_cvss_fail:
        description: 'OWASP CVSS fail threshold'
        required: false
        type: number
        default: 7
      docker_compose_file:
        description: 'Docker compose file'
        required: false
        type: string
        default: 'docker-compose.yml'
      docker_health_endpoint:
        description: 'Docker health endpoint'
        required: false
        type: string
        default: '/actuator/health'
      retention_days:
        description: 'Artifact retention days'
        required: false
        type: number
        default: 30
      workdir:
        description: 'Working directory'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    env:
      WORKDIR: ${{ inputs.workdir || '.' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}
          cache: ${{ inputs.build_tool }}

      # ========================================================================
      # Build and Test
      # ========================================================================
      - name: Build and Test
        working-directory: ${{ env.WORKDIR }}
        id: build
        run: |
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew build test && echo "status=success" >> $GITHUB_OUTPUT || echo "status=failure" >> $GITHUB_OUTPUT
          else
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp verify && echo "status=success" >> $GITHUB_OUTPUT || echo "status=failure" >> $GITHUB_OUTPUT
            else
              mvn -B -ntp verify && echo "status=success" >> $GITHUB_OUTPUT || echo "status=failure" >> $GITHUB_OUTPUT
            fi
          fi

      # ========================================================================
      # JaCoCo Coverage
      # ========================================================================
      - name: Run JaCoCo Coverage
        if: inputs.run_jacoco
        working-directory: ${{ env.WORKDIR }}
        id: jacoco
        run: |
          COVERED=0; MISSED=0; PERCENT=0
          JACOCO=$(find . -name "jacoco.xml" -path "*/site/*" 2>/dev/null | head -1)
          if [ -n "$JACOCO" ] && [ -f "$JACOCO" ]; then
            COVERED=$(grep -oP 'INSTRUCTION.*?covered="\K[0-9]+' "$JACOCO" 2>/dev/null | awk '{s+=$1} END {print s+0}')
            MISSED=$(grep -oP 'INSTRUCTION.*?missed="\K[0-9]+' "$JACOCO" 2>/dev/null | awk '{s+=$1} END {print s+0}')
            TOTAL=$((COVERED + MISSED))
            if [ "$TOTAL" -gt 0 ]; then
              PERCENT=$((COVERED * 100 / TOTAL))
            fi
          fi
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Coverage: $PERCENT%"

      # ========================================================================
      # Checkstyle
      # ========================================================================
      - name: Run Checkstyle
        if: inputs.run_checkstyle
        working-directory: ${{ env.WORKDIR }}
        id: checkstyle
        continue-on-error: true
        run: |
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew checkstyleMain checkstyleTest 2>&1 || true
          else
            mvn -B -ntp checkstyle:checkstyle 2>&1 || true
          fi

          # Count violations from XML report
          VIOLATIONS=0
          for xml in $(find . -name "checkstyle-result.xml" 2>/dev/null); do
            COUNT=$(grep -c '<error ' "$xml" 2>/dev/null || echo 0)
            VIOLATIONS=$((VIOLATIONS + COUNT))
          done
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Checkstyle violations: $VIOLATIONS"

      # ========================================================================
      # SpotBugs
      # ========================================================================
      - name: Run SpotBugs
        if: inputs.run_spotbugs
        working-directory: ${{ env.WORKDIR }}
        id: spotbugs
        continue-on-error: true
        run: |
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew spotbugsMain 2>&1 || true
          else
            mvn -B -ntp com.github.spotbugs:spotbugs-maven-plugin:spotbugs 2>&1 || true
          fi

          # Count bugs from XML report
          BUGS=0
          for xml in $(find . -name "spotbugsXml.xml" 2>/dev/null); do
            COUNT=$(grep -c '<BugInstance' "$xml" 2>/dev/null || echo 0)
            BUGS=$((BUGS + COUNT))
          done
          echo "bugs=$BUGS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "SpotBugs bugs: $BUGS"

      # ========================================================================
      # PMD
      # ========================================================================
      - name: Run PMD
        if: inputs.run_pmd
        working-directory: ${{ env.WORKDIR }}
        id: pmd
        continue-on-error: true
        run: |
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew pmdMain 2>&1 || true
          else
            mvn -B -ntp pmd:pmd 2>&1 || true
          fi

          # Count violations from XML report
          VIOLATIONS=0
          for xml in $(find . -name "pmd.xml" 2>/dev/null); do
            COUNT=$(grep -c '<violation' "$xml" 2>/dev/null || echo 0)
            VIOLATIONS=$((VIOLATIONS + COUNT))
          done
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "PMD violations: $VIOLATIONS"

      # ========================================================================
      # OWASP Dependency Check
      # ========================================================================
      - name: Run OWASP Dependency Check
        if: inputs.run_owasp
        working-directory: ${{ env.WORKDIR }}
        id: owasp
        continue-on-error: true
        run: |
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew dependencyCheckAnalyze 2>&1 || true
          else
            mvn -B -ntp org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=11 -Dformat=JSON 2>&1 || true
          fi

          # Count vulnerabilities by severity from JSON report
          CRITICAL=0; HIGH=0; MEDIUM=0; LOW=0
          REPORT=$(find . -name "dependency-check-report.json" 2>/dev/null | head -1)
          if [ -n "$REPORT" ] && [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")] | length' "$REPORT" 2>/dev/null || echo 0)
            LOW=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "LOW")] | length' "$REPORT" 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "OWASP vulns: Critical=$CRITICAL, High=$HIGH, Medium=$MEDIUM, Low=$LOW"

      # ========================================================================
      # PITest Mutation Testing
      # ========================================================================
      - name: Run PITest Mutation Testing
        if: inputs.run_pitest
        working-directory: ${{ env.WORKDIR }}
        id: pitest
        continue-on-error: true
        run: |
          KILLED=0; SURVIVED=0; SCORE=0
          if [ "${{ inputs.build_tool }}" = "gradle" ]; then
            ./gradlew pitest 2>&1 || true
          else
            mvn -B -ntp org.pitest:pitest-maven:mutationCoverage 2>&1 || true
          fi

          # Note: PITest uses single quotes in XML (status='KILLED'), so we match both quote styles
          for xml in $(find . -name "mutations.xml" 2>/dev/null); do
            KILLED=$((KILLED + $(grep -cE "status=['\"]KILLED['\"]" "$xml" 2>/dev/null || echo 0)))
            SURVIVED=$((SURVIVED + $(grep -cE "status=['\"]SURVIVED['\"]" "$xml" 2>/dev/null || echo 0)))
          done

          TOTAL=$((KILLED + SURVIVED))
          if [ "$TOTAL" -gt 0 ]; then
            SCORE=$((KILLED * 100 / TOTAL))
          fi
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Mutation Score: $SCORE% (Killed: $KILLED, Survived: $SURVIVED)"

      # ========================================================================
      # Semgrep SAST
      # ========================================================================
      - name: Run Semgrep
        if: inputs.run_semgrep
        working-directory: ${{ env.WORKDIR }}
        id: semgrep
        continue-on-error: true
        run: |
          pip install semgrep --quiet
          semgrep --config=auto --json --output=semgrep-report.json . 2>/dev/null || true

          FINDINGS=0
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)
          fi
          echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Semgrep findings: $FINDINGS"

      # ========================================================================
      # Trivy Filesystem Scan
      # ========================================================================
      - name: Run Trivy
        if: inputs.run_trivy
        working-directory: ${{ env.WORKDIR }}
        id: trivy
        continue-on-error: true
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          trivy fs --format json --output trivy-report.json . 2>/dev/null || true

          CRITICAL=0; HIGH=0
          if [ -f "trivy-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-report.json 2>/dev/null || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-report.json 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "ran=true" >> $GITHUB_OUTPUT
          echo "Trivy vulns: Critical=$CRITICAL, High=$HIGH"

      # ========================================================================
      # Generate CI Report (captures ALL tool results)
      # ========================================================================
      - name: Generate CI Report
        if: always()
        run: |
          mkdir -p reports
          cat > reports/report.json << 'JSONEOF'
          {
            "repo": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "run_id": "${{ github.run_id }}",
            "language": "java",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "results": {
              "build_status": "${{ steps.build.outputs.status || 'unknown' }}",
              "coverage": ${{ steps.jacoco.outputs.ran == 'true' && steps.jacoco.outputs.percent || 'null' }},
              "mutation_score": ${{ steps.pitest.outputs.ran == 'true' && steps.pitest.outputs.score || 'null' }},
              "checkstyle_violations": ${{ steps.checkstyle.outputs.ran == 'true' && steps.checkstyle.outputs.violations || 'null' }},
              "spotbugs_bugs": ${{ steps.spotbugs.outputs.ran == 'true' && steps.spotbugs.outputs.bugs || 'null' }},
              "pmd_violations": ${{ steps.pmd.outputs.ran == 'true' && steps.pmd.outputs.violations || 'null' }},
              "owasp_critical": ${{ steps.owasp.outputs.ran == 'true' && steps.owasp.outputs.critical || 'null' }},
              "owasp_high": ${{ steps.owasp.outputs.ran == 'true' && steps.owasp.outputs.high || 'null' }},
              "owasp_medium": ${{ steps.owasp.outputs.ran == 'true' && steps.owasp.outputs.medium || 'null' }},
              "semgrep_findings": ${{ steps.semgrep.outputs.ran == 'true' && steps.semgrep.outputs.findings || 'null' }},
              "trivy_critical": ${{ steps.trivy.outputs.ran == 'true' && steps.trivy.outputs.critical || 'null' }},
              "trivy_high": ${{ steps.trivy.outputs.ran == 'true' && steps.trivy.outputs.high || 'null' }}
            },
            "tools_ran": {
              "jacoco": ${{ steps.jacoco.outputs.ran == 'true' }},
              "checkstyle": ${{ steps.checkstyle.outputs.ran == 'true' }},
              "spotbugs": ${{ steps.spotbugs.outputs.ran == 'true' }},
              "pmd": ${{ steps.pmd.outputs.ran == 'true' }},
              "owasp": ${{ steps.owasp.outputs.ran == 'true' }},
              "pitest": ${{ steps.pitest.outputs.ran == 'true' }},
              "semgrep": ${{ steps.semgrep.outputs.ran == 'true' }},
              "trivy": ${{ steps.trivy.outputs.ran == 'true' }}
            }
          }
          JSONEOF

      # ========================================================================
      # Upload Artifacts
      # ========================================================================
      - name: Upload CI Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: |
            reports/
            **/target/surefire-reports/
            **/target/site/jacoco/
            **/target/pit-reports/
            **/target/dependency-check-report.*
            **/target/spotbugsXml.xml
            **/target/checkstyle-result.xml
            **/target/pmd.xml
            **/semgrep-report.json
            **/trivy-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      # ========================================================================
      # Generate Summary
      # ========================================================================
      - name: Generate Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Hub CI Report: ${{ github.repository }}

          **Branch:** \`${{ github.ref_name }}\` | **Java:** \`${{ inputs.java_version }}\` | **Build Tool:** \`${{ inputs.build_tool }}\`

          ## Quality Metrics
          | Metric | Value | Status |
          |--------|-------|--------|
          | Coverage | ${{ steps.jacoco.outputs.percent || '-' }}% | ${{ steps.jacoco.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Mutation Score | ${{ steps.pitest.outputs.score || '-' }}% | ${{ steps.pitest.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |

          ## Code Quality
          | Tool | Issues | Status |
          |------|--------|--------|
          | Checkstyle | ${{ steps.checkstyle.outputs.violations || '-' }} | ${{ steps.checkstyle.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | SpotBugs | ${{ steps.spotbugs.outputs.bugs || '-' }} | ${{ steps.spotbugs.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | PMD | ${{ steps.pmd.outputs.violations || '-' }} | ${{ steps.pmd.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |

          ## Security
          | Tool | Critical | High | Medium | Status |
          |------|----------|------|--------|--------|
          | OWASP DC | ${{ steps.owasp.outputs.critical || '-' }} | ${{ steps.owasp.outputs.high || '-' }} | ${{ steps.owasp.outputs.medium || '-' }} | ${{ steps.owasp.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Trivy | ${{ steps.trivy.outputs.critical || '-' }} | ${{ steps.trivy.outputs.high || '-' }} | - | ${{ steps.trivy.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          | Semgrep | ${{ steps.semgrep.outputs.findings || '-' }} findings | - | - | ${{ steps.semgrep.outputs.ran == 'true' && 'Ran' || 'Skipped' }} |
          EOF
