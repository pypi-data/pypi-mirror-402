name: Generate Connector Models

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "PR Number"
        type: string
        required: false
      comment-id:
        description: "Comment ID (Optional)"
        type: string
        required: false
  workflow_call:
    inputs:
      trigger:
        description: 'Trigger type: nightly or slash'
        required: true
        type: string
      pull_number:
        description: 'PR number (for slash mode)'
        required: false
        type: number
      connector:
        description: 'Specific connector to generate (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: generate-command-${{ github.event_name }}-${{ github.event.inputs.pr || inputs.trigger }}
  cancel-in-progress: true

jobs:
  # Slash command job - uses poe-command-processor
  run-generate-slash:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate as GitHub App (if available)
        uses: actions/create-github-app-token@v1
        id: get-app-token
        continue-on-error: true
        with:
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Run Poe Generate Command
        uses: aaronsteers/poe-command-processor@v1.3.3
        with:
          pr: ${{ github.event.inputs.pr }}
          comment-id: ${{ github.event.inputs.comment-id }}
          github-token: ${{ steps.get-app-token.outputs.token || secrets.GITHUB_TOKEN }}
          command: generate

  # Nightly job - keeps existing PR creation with auto-merge
  generate-nightly:
    if: github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR branch (slash mode)
        if: inputs.trigger == 'slash'
        id: get-pr-branch
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pull_number }}
            });
            return pr.head.ref;
      
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.trigger == 'slash' && steps.get-pr-branch.outputs.result || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout Airbyte monorepo
        uses: actions/checkout@v6
        with:
          repository: airbytehq/airbyte
          path: airbyte-monorepo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"
      
      - name: Generate models
        env:
          AIRBYTE_MONOREPO_PATH: ${{ github.workspace }}/airbyte-monorepo
        run: |
          if [ -n "${{ inputs.connector }}" ]; then
            python scripts/generate_models.py --connector "${{ inputs.connector }}"
          else
            python scripts/generate_models.py
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --exit-code; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create or update pull request (nightly mode)
        if: inputs.trigger == 'nightly' && steps.check_changes.outputs.has_changes == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate connector models"
          title: "chore: nightly regeneration of connector models"
          body: |
            This PR was automatically generated by the nightly model generation workflow.
            
            The workflow regenerates connector models from the latest Airbyte connector specifications.
            
            If tests pass, this PR will be automatically merged.
          branch: automation/nightly-model-regeneration
          delete-branch: true
          add-paths: |
            airbyte_connector_models/connectors/
      
      - name: Enable auto-merge (nightly mode)
        if: inputs.trigger == 'nightly' && steps.create_pr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash
      
      - name: Commit and push changes (slash mode)
        if: inputs.trigger == 'slash' && steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add airbyte_connector_models/connectors/
          git commit -m "chore: regenerate connector models"
          git push
      
      - name: Comment on PR (slash mode)
        if: inputs.trigger == 'slash'
        uses: actions/github-script@v8
        with:
          script: |
            const hasChanges = '${{ steps.check_changes.outputs.has_changes }}' === 'true';
            const emoji = hasChanges ? '✅' : 'ℹ️';
            const message = hasChanges 
              ? 'Connector models have been regenerated and pushed to this PR.'
              : 'No changes detected - connector models are already up to date.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pull_number }},
              body: `${emoji} **Model generation complete**\n\n${message}`
            });
