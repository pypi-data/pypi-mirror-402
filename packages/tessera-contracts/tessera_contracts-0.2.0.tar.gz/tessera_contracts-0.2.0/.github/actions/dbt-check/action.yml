name: 'Tessera dbt Check'
description: 'Check dbt models for breaking schema changes against Tessera contracts'
author: 'Tessera'

branding:
  icon: 'check-circle'
  color: 'blue'

inputs:
  tessera-url:
    description: 'URL of the Tessera API'
    required: true
  tessera-api-key:
    description: 'API key for Tessera authentication'
    required: false
    default: ''
  team-id:
    description: 'Team ID for the dbt project'
    required: true
  manifest-path:
    description: 'Path to dbt manifest.json'
    required: false
    default: 'target/manifest.json'
  create-proposals:
    description: 'Create proposals for breaking changes'
    required: false
    default: 'false'
  fail-on-breaking:
    description: 'Fail the action on breaking changes'
    required: false
    default: 'true'
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.11'

outputs:
  has-breaking-changes:
    description: 'Whether breaking changes were detected'
    value: ${{ steps.check.outputs.has-breaking-changes }}
  breaking-count:
    description: 'Number of breaking changes detected'
    value: ${{ steps.check.outputs.breaking-count }}
  results-json:
    description: 'Full results as JSON'
    value: ${{ steps.check.outputs.results-json }}

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: 'latest'

    - name: Install Tessera CLI
      shell: bash
      run: |
        uv pip install tessera-contracts[cli] --system

    - name: Run dbt check
      id: check
      shell: bash
      env:
        TESSERA_URL: ${{ inputs.tessera-url }}
        TESSERA_API_KEY: ${{ inputs.tessera-api-key }}
        TESSERA_TEAM_ID: ${{ inputs.team-id }}
      run: |
        set +e  # Don't exit on error, we want to capture the output

        # Build command
        CMD="tessera dbt check --manifest ${{ inputs.manifest-path }}"

        if [ "${{ inputs.create-proposals }}" = "true" ]; then
          CMD="$CMD --create-proposals"
        fi

        if [ "${{ inputs.fail-on-breaking }}" = "false" ]; then
          CMD="$CMD --no-fail-on-breaking"
        fi

        # Run check and capture output
        OUTPUT=$(${CMD} --json 2>&1)
        EXIT_CODE=$?

        # Parse JSON output
        if echo "$OUTPUT" | jq . > /dev/null 2>&1; then
          RESULTS_JSON="$OUTPUT"
          BREAKING_COUNT=$(echo "$OUTPUT" | jq '.breaking | length')
          HAS_BREAKING=$([ "$BREAKING_COUNT" -gt 0 ] && echo "true" || echo "false")
        else
          # Not valid JSON, probably an error message
          echo "::warning::Could not parse output as JSON"
          RESULTS_JSON="{}"
          BREAKING_COUNT=0
          HAS_BREAKING="false"
        fi

        # Set outputs
        echo "has-breaking-changes=$HAS_BREAKING" >> $GITHUB_OUTPUT
        echo "breaking-count=$BREAKING_COUNT" >> $GITHUB_OUTPUT

        # For multi-line JSON, use heredoc
        {
          echo "results-json<<EOF"
          echo "$RESULTS_JSON"
          echo "EOF"
        } >> $GITHUB_OUTPUT

        # Exit with original code if fail-on-breaking is true
        if [ "${{ inputs.fail-on-breaking }}" = "true" ]; then
          exit $EXIT_CODE
        fi

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.check.outputs.breaking-count != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const breakingCount = ${{ steps.check.outputs.breaking-count }};
          const results = ${{ steps.check.outputs.results-json }};

          let body = `## Tessera Schema Check\n\n`;
          body += `**${breakingCount} breaking change(s) detected**\n\n`;

          if (results.breaking && results.breaking.length > 0) {
            body += `### Breaking Changes\n\n`;
            for (const model of results.breaking) {
              body += `#### \`${model.fqn}\`\n`;
              if (model.breaking_changes) {
                for (const bc of model.breaking_changes) {
                  body += `- ${bc.message || bc}\n`;
                }
              }
              if (model.impacted_consumers && model.impacted_consumers.length > 0) {
                body += `\n**Impacted consumers:**\n`;
                for (const consumer of model.impacted_consumers) {
                  body += `- ${consumer.team_name || consumer}\n`;
                }
              }
              body += `\n`;
            }
          }

          body += `---\n`;
          body += `*This check was performed by [Tessera](https://github.com/ashita-ai/tessera)*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
