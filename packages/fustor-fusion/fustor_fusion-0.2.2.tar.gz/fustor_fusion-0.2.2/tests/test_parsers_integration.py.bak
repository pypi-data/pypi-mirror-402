"""
Test script to verify that the parsers module integration works correctly
"""
import asyncio
from datetime import datetime
from fustor_fusion.parsers.manager import process_event, get_directory_tree, get_parser_with_db
from fustor_fusion.parsers.services import process_new_events


async def test_integration():
    print("Testing parsers integration...")
    
    # For this test, we'll work without a database session to test in-memory functionality
    # In a real application, you would have a database session
    
    # Test 1: Process events using the main process_event function
    print("\n1. Testing individual event processing...")
    events = [
        {
            "event_type": "create",
            "payload": {
                "path": "/home/user/test_dir",
                "name": "test_dir",
                "modified_time": datetime.now().isoformat(),
                "created_time": datetime.now().isoformat(),
                "content_type": "directory",
                "metadata": {"owner": "user"}
            }
        },
        {
            "event_type": "create",
            "payload": {
                "path": "/home/user/test_dir/file1.txt",
                "name": "file1.txt",
                "size": 1024,
                "modified_time": datetime.now().isoformat(),
                "created_time": datetime.now().isoformat(),
                "content_type": "file",
                "metadata": {"owner": "user", "permissions": "rw-r--r--"}
            }
        }
    ]
    
    for event in events:
        result = await process_event(event)
        print(f"Event processing result: {result}")
    
    # Check the resulting directory structure
    print("\n2. Directory structure after processing events:")
    tree = await get_directory_tree("/")
    print(f"Directory tree: {tree}")
    
    # Test 2: Process events using the service function
    print("\n3. Testing service-level event processing...")
    additional_events = [
        {
            "event_type": "create",
            "payload": {
                "path": "/home/user/test_dir/file2.txt",
                "name": "file2.txt",
                "size": 2048,
                "modified_time": datetime.now().isoformat(),
                "created_time": datetime.now().isoformat(),
                "content_type": "file",
                "metadata": {"owner": "user", "permissions": "rw-r--r--"}
            }
        },
        {
            "event_type": "update",
            "payload": {
                "path": "/home/user/test_dir/file1.txt",
                "name": "file1.txt",
                "size": 1536,  # Updated size
                "modified_time": datetime.now().isoformat(),
                "created_time": datetime.now().isoformat(),
                "content_type": "file",
                "metadata": {"owner": "user", "permissions": "rw-r--r--", "updated": True}
            }
        }
    ]
    
    service_result = await process_new_events(additional_events, datastore_id=1)
    print(f"Service processing result: {service_result}")
    
    # Check the updated directory structure
    print("\n4. Directory structure after additional events:")
    updated_tree = await get_directory_tree("/")
    print(f"Updated directory tree: {updated_tree}")
    
    # Test 5: Process a delete event
    print("\n5. Testing delete event...")
    delete_event = {
        "event_type": "delete",
        "payload": {
            "path": "/home/user/test_dir/file1.txt",
            "name": "file1.txt"
        }
    }
    
    delete_result = await process_event(delete_event)
    print(f"Delete event processing result: {delete_result}")
    
    # Check the directory structure after deletion
    print("\n6. Directory structure after deletion:")
    final_tree = await get_directory_tree("/")
    print(f"Final directory tree: {final_tree}")
    
    print("\nIntegration test completed!")


if __name__ == "__main__":
    asyncio.run(test_integration())