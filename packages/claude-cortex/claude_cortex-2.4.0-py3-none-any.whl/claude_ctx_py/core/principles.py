"""Principles snippet management and build helpers."""

from __future__ import annotations

from pathlib import Path
from typing import List, Tuple

from .base import (
    GREEN,
    YELLOW,
    RED,
    _color,
    _iter_md_files,
    _parse_active_entries,
    _resolve_claude_dir,
    _write_active_entries,
)
from .components import ref_activate, ref_deactivate, ref_list, ref_status

COMPONENT_TYPE = "principles"
BASE_PATH = "principles"


def _available_principles(claude_dir: Path) -> List[str]:
    """Return available principle snippet names (without .md)."""
    return [path.stem for path in _iter_md_files(claude_dir / BASE_PATH)]


def _load_active_principles(claude_dir: Path) -> List[str]:
    """Load active principles; default to all available if empty."""
    active_path = claude_dir / ".active-principles"
    active = _parse_active_entries(active_path)
    if active:
        return active

    available = _available_principles(claude_dir)
    if available:
        _write_active_entries(active_path, available)
    return available


def principles_activate(name: str, home: Path | None = None) -> Tuple[int, str]:
    """Activate a principle snippet by adding it to .active-principles."""
    exit_code, message = ref_activate(COMPONENT_TYPE, name, BASE_PATH, home)
    if exit_code == 0:
        build_code, build_message = principles_build(home=home)
        if build_code != 0:
            message = f"{message}\n{build_message}"
    return exit_code, message


def principles_deactivate(name: str, home: Path | None = None) -> Tuple[int, str]:
    """Deactivate a principle snippet by removing it from .active-principles."""
    exit_code, message = ref_deactivate(COMPONENT_TYPE, name, home)
    if exit_code == 0:
        build_code, build_message = principles_build(home=home)
        if build_code != 0:
            message = f"{message}\n{build_message}"
    return exit_code, message


def list_principles(home: Path | None = None) -> str:
    """List all principle snippets with their status."""
    return ref_list(COMPONENT_TYPE, BASE_PATH, home)


def principles_status(home: Path | None = None) -> str:
    """Show active principle snippets."""
    return ref_status(COMPONENT_TYPE, home)


def principles_build(home: Path | None = None) -> Tuple[int, str]:
    """Build PRINCIPLES.md by concatenating active snippet files."""
    claude_dir = _resolve_claude_dir(home)
    principles_dir = claude_dir / BASE_PATH
    if not principles_dir.is_dir():
        return 1, _color(
            "Principles directory not found. Create principles/*.md first.", RED
        )

    active = _load_active_principles(claude_dir)
    if not active:
        return 1, _color("No principle snippets found to build.", RED)

    missing: List[str] = []
    snippets: List[str] = []

    for entry in active:
        name = entry[:-3] if entry.endswith(".md") else entry
        snippet_path = principles_dir / f"{name}.md"
        if not snippet_path.is_file():
            missing.append(name)
            continue
        try:
            text = snippet_path.read_text(encoding="utf-8").strip()
        except OSError:
            missing.append(name)
            continue
        if text:
            snippets.append(text)

    if not snippets:
        return 1, _color("No active principle snippets could be read.", RED)

    header = (
        "<!-- Generated by cortex principles build. "
        "Edit snippets in principles/ -->"
    )
    content = "\n\n".join([header, *snippets]) + "\n"

    output_path = claude_dir / "PRINCIPLES.md"
    output_path.write_text(content, encoding="utf-8")

    if missing:
        missing_list = ", ".join(sorted(set(missing)))
        message = (
            f"Built PRINCIPLES.md from {len(snippets)} snippet(s) "
            f"(missing: {missing_list})"
        )
        return 0, _color(message, YELLOW)

    return 0, _color(f"Built PRINCIPLES.md from {len(snippets)} snippet(s)", GREEN)
