Metadata-Version: 2.4
Name: api-sos
Version: 1.1.0
Summary: Add your description here
Requires-Python: >=3.12
Requires-Dist: aiohttp>=3.11.12
Requires-Dist: click>=8.1.8
Requires-Dist: faker>=36.1.1
Requires-Dist: jinja2>=3.1.6
Requires-Dist: loguru>=0.7.3
Requires-Dist: openapi-spec-validator>=0.7.1
Requires-Dist: prance>=23.6.21.0
Requires-Dist: pydantic>=2.10.6
Requires-Dist: ruamel-yaml>=0.18.10
Description-Content-Type: text/markdown

# ğŸš€ API-SOS

API-SOS æ˜¯ä¸€ä¸ªç”¨äº API æµ‹è¯•çš„å·¥å…·ï¼Œå®ƒå¯ä»¥ä» OpenAPI è§„èŒƒç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶æ”¯æŒè®°å½•å’ŒéªŒè¯ API å“åº”ã€‚

## ğŸ“¦ å®‰è£…

```bash
pip install api-sos
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

## ğŸ“š ä½œä¸º Python åº“ä½¿ç”¨

API-SOS æ—¢å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºåº“ç›´æ¥é›†æˆåˆ°ä½ çš„ä»£ç ä¸­ã€‚ä½œä¸ºåº“è°ƒç”¨æ—¶ï¼Œå®ƒä¸ä¼šä¸»åŠ¨ `sys.exit(1)`ï¼Œè€Œæ˜¯è¿”å›ç»“æœï¼Œä½ å¯ä»¥è‡ªè¡Œå†³å®šå¦‚ä½•å¤„ç†é”™è¯¯æˆ–å¤±è´¥ã€‚

### âœ… åŸºç¡€ç¤ºä¾‹ï¼šè¿è¡Œå·²ç”Ÿæˆçš„ç”¨ä¾‹

```python
import asyncio

from api_sos import has_failures, run_checks


async def main() -> None:
    results = await run_checks(
        "output.yaml",
        concurrent=5,
        endpoint="http://localhost:8000",
        variables="vars.yaml",
        interactive=False,
        verbose=True,
    )

    if has_failures(results):
        # è¿™é‡Œç”±ä½ å†³å®šå¦‚ä½•å¤„ç†å¤±è´¥ï¼Œä¾‹å¦‚æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›é”™è¯¯ç 
        raise RuntimeError("API checks failed")


asyncio.run(main())
```

### âœ… ç”Ÿæˆç”¨ä¾‹å¹¶å†™å…¥æ–‡ä»¶

```python
import asyncio

from api_sos import generate_checks


async def main() -> None:
    await generate_checks(
        "openapi.yaml",
        "output.yaml",
        endpoint="http://localhost:8000",
        concurrent=3,
        headers="headers.yaml",
        headers_variables="vars.yaml",
        no_record=False,
        no_example=False,
        verbose=True,
    )


asyncio.run(main())
```

### ğŸ” ç›´æ¥ä½¿ç”¨åº•å±‚è¿è¡Œå‡½æ•°

å¦‚æœä½ æƒ³å®Œå…¨æŒæ§è¿è¡Œè¿‡ç¨‹ï¼ˆæ¯”å¦‚æ‰¹é‡å¤„ç†å¤šä¸ª `Input`ï¼‰ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ `api_sos.run`ï¼š

```python
import asyncio

from api_sos import Input, run


async def main() -> None:
    input_ = Input.load("output.yaml")
    results = await run(input_, concurrent=2, variables={"token": "xxx"})
    # results æ˜¯ CheckResult æˆ– Exception çš„åˆ—è¡¨


asyncio.run(main())
```

### ğŸ¯ ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹

ä» OpenAPI è§„èŒƒç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼š

```bash
# æŒ‡å®šç«¯ç‚¹å¹¶è®°å½•å“åº”
api-sos generate openapi.yaml output.yaml --endpoint http://localhost:8000

# ä½¿ç”¨å¹¶å‘è¯·æ±‚è®°å½•å“åº”
api-sos generate openapi.yaml output.yaml --endpoint http://localhost:8000 --concurrent 5

# ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´
api-sos generate openapi.yaml output.yaml --headers headers.yaml --endpoint http://localhost:8000

# ä½¿ç”¨å¸¦æ¨¡æ¿å˜é‡çš„è¯·æ±‚å¤´(secretesåœºæ™¯)
api-sos generate openapi.yaml output.yaml --headers headers.yaml --headers-variables vars.yaml --endpoint http://localhost:8000

# è·³è¿‡å“åº”è®°å½•
api-sos generate openapi.yaml output.yaml --no-record

# è·³è¿‡ä»ç¤ºä¾‹ç”Ÿæˆæ£€æŸ¥
api-sos generate openapi.yaml output.yaml --no-example --endpoint http://localhost:8000
```

### â–¶ï¸ è¿è¡Œæµ‹è¯•

è¿è¡Œç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ï¼š

```bash
# åŸºæœ¬ç”¨æ³•
api-sos run output.yaml

# ä½¿ç”¨å¹¶å‘æ‰§è¡Œ
api-sos run output.yaml --concurrent 5

# æŒ‡å®šç«¯ç‚¹
api-sos run output.yaml --endpoint http://localhost:8000

# ä½¿ç”¨å˜é‡æ›¿æ¢
api-sos run output.yaml --variables vars.yaml

# äº¤äº’å¼ç¼–è¾‘
api-sos run output.yaml --interactive
```

### ğŸ”„ äº¤äº’å¼ç¼–è¾‘æ¨¡å¼

å½“ä½¿ç”¨`--interactive`æˆ–`-i`å‚æ•°è¿è¡Œæµ‹è¯•æ—¶ï¼Œå¦‚æœæ£€æŸ¥ç»“æœä¸é¢„æœŸä¸ç¬¦ï¼ˆå­˜åœ¨å·®å¼‚ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€ç¼–è¾‘å™¨è®©ä½ ä¿®æ”¹æ–­è¨€ï¼š

```bash
# å¯ç”¨äº¤äº’å¼ç¼–è¾‘æ¨¡å¼
api-sos run output.yaml -i

# ä½¿ç”¨è‡ªå®šä¹‰ç¼–è¾‘å™¨ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ï¼‰
EDITOR=vim api-sos run output.yaml -i
```

#### äº¤äº’å¼ç¼–è¾‘å·¥ä½œæµç¨‹

1. å½“æ£€æµ‹åˆ°æ–­è¨€ä¸å®é™…ç»“æœä¸åŒ¹é…æ—¶ï¼Œç³»ç»Ÿä¼šæ‰“å¼€ä½ çš„ç¼–è¾‘å™¨
2. ç¼–è¾‘å™¨ä¸­ä¼šæ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š

   - `assert`: å½“å‰çš„æ–­è¨€å†…å®¹ï¼Œä½ å¯ä»¥ä¿®æ”¹è¿™éƒ¨åˆ†
   - `actual`: å®é™…å“åº”å†…å®¹ï¼ˆä»…ä¾›å‚è€ƒï¼Œä¿å­˜æ—¶ä¼šè¢«ä¸¢å¼ƒï¼‰
   - `name`: æ£€æŸ¥é¡¹åç§°ï¼ˆä»…ä¾›å‚è€ƒï¼Œä¿å­˜æ—¶ä¼šè¢«ä¸¢å¼ƒï¼‰
   - ä½¿ç”¨è¯´æ˜

3. ä½ å¯ä»¥ï¼š

   - ä»`actual`éƒ¨åˆ†å¤åˆ¶å€¼åˆ°`assert`éƒ¨åˆ†
   - ä¿®æ”¹æ–­è¨€ä¸­çš„ç‰¹å®šå­—æ®µ
   - ä½¿ç”¨Jinja2æ¨¡æ¿è¡¨è¾¾å¼åˆ›å»ºåŠ¨æ€æ–­è¨€ï¼Œå¦‚`{{ actual|is_type('int') }}`

4. ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨åï¼Œä¿®æ”¹å°†è‡ªåŠ¨åº”ç”¨åˆ°åŸå§‹æ–‡ä»¶ä¸­

è¿™ç§äº¤äº’å¼æ–¹å¼éå¸¸é€‚åˆåˆå§‹æµ‹è¯•å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ã€‚

## ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹

æ‰€æœ‰é…ç½®çš„æ–‡ä»¶åå¯ä»¥æ˜¯ä»»æ„åç§°ï¼Œè¯·é€šè¿‡å‘½ä»¤çš„å‚æ•°è¿›è¡Œä¼ é€’

### ğŸ”‘ è¯·æ±‚å¤´é…ç½® (headers.yaml) åœ¨è°ƒç”¨generateæ—¶ï¼Œè¿™éƒ¨åˆ†è¯·æ±‚å¤´ä¼šè‡ªåŠ¨è¢«æ’å…¥åˆ°ç”Ÿæˆçš„ç»“æ„ä¸­

```yaml
Authorization: Bearer {{token}}
Content-Type: application/json
X-Custom-Header: xxx
```

### ğŸ”„ å˜é‡é…ç½® (vars.yaml)

```yaml
token: "your-token-here"
custom_value: "test"
```

### âœ… æµ‹è¯•ç”¨ä¾‹é…ç½® (output.yaml)

```yaml
version: "1.0.0"
endpoint: "http://localhost:8000"
checks:
  - name: "Get User"
    pathname: "/api/users/1"
    method: "GET"
    headers:
      Authorization: "Bearer {{token}}"
    assert_:
      http_status: 200
      content:
        id: 1
        name: "John Doe"
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ä» OpenAPI è§„èŒƒè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
- æ”¯æŒè®°å½•å’ŒéªŒè¯ API å“åº”
- æ”¯æŒå¹¶å‘è¯·æ±‚
- æ”¯æŒè¯·æ±‚å¤´æ¨¡æ¿å˜é‡
- æ”¯æŒå˜é‡æ›¿æ¢
- æ”¯æŒäº¤äº’å¼ç¼–è¾‘
- æ”¯æŒè‡ªå®šä¹‰ç«¯ç‚¹
- æ”¯æŒå¤šç§ HTTP æ–¹æ³•ï¼ˆGET, POST, PUT, DELETE ç­‰ï¼‰
- çµæ´»çš„å“åº”æ–­è¨€ç³»ç»Ÿ
- æ”¯æŒ Jinja2 æ¨¡æ¿è¡¨è¾¾å¼
- å†…ç½®ä¸°å¯Œçš„æ–­è¨€è¿‡æ»¤å™¨
- æ”¯æŒä»£ç†å’Œè®¤è¯
- æ”¯æŒè¶…æ—¶é…ç½®

## ğŸ”§ é«˜çº§ç”¨æ³•

### ğŸ¯ æ–­è¨€ç³»ç»Ÿ

#### ğŸ¨ æ”¯æŒçš„è¿‡æ»¤å™¨

- `matches(pattern)`: æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- `contains(substr)`: åŒ…å«å­å­—ç¬¦ä¸²
- `gt(other)`: å¤§äº
- `lt(other)`: å°äº
- `gte(other)`: å¤§äºç­‰äº
- `lte(other)`: å°äºç­‰äº
- `ne(other)`: ä¸ç­‰äº
- `is_numeric()`: æ˜¯å¦ä¸ºæ•°å­—
- `is_date()`: æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼
- `is_email()`: æ˜¯å¦ä¸ºé‚®ç®±æ ¼å¼
- `length()`: è·å–é•¿åº¦
- `starts_with(prefix)`: æ˜¯å¦ä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´
- `ends_with(suffix)`: æ˜¯å¦ä»¥æŒ‡å®šå­—ç¬¦ä¸²ç»“å°¾
- `in_range(min_val, max_val)`: æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
- `is_empty()`: æ˜¯å¦ä¸ºç©º
- `is_type(expected_type)`: æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæŒ‡å®šçš„ Python ç±»å‹ï¼ˆå¦‚ 'str', 'int', 'float', 'list', 'dict' ç­‰ï¼‰

#### ğŸ“Š ä¸Šä¸‹æ–‡å˜é‡

åœ¨è¡¨è¾¾å¼ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å˜é‡ï¼š

- `actual`: å½“å‰å­—æ®µçš„å®é™…å€¼
- `response`: æ•´ä¸ªå“åº”å¯¹è±¡
- `status`: HTTP çŠ¶æ€ç 
- `headers`: å“åº”å¤´
- `body`: å“åº”ä½“

### ğŸ“‹ é«˜çº§é…ç½®ç¤ºä¾‹

#### ğŸ”„ ä½¿ç”¨å˜é‡

```yaml
version: "1.0.0"
endpoint: "https://api.example.com"
variables:
  min_age: 18
  valid_status: ["active", "pending"]
checks:
  - name: "åˆ›å»ºç”¨æˆ·"
    pathname: "/users"
    method: POST
    payload:
      value:
        name: "test_user"
        email: "test@example.com"
    assert:
      http_status: 201
      content:
        age: "{{ actual|gte(min_age) }}"
        status: "{{ actual in valid_status }}"
```

#### ğŸŒ ä»£ç†è®¾ç½®

```yaml
checks:
  - name: "ä½¿ç”¨ä»£ç†"
    pathname: "/api"
    method: GET
    proxy: "http://proxy.example.com:8080"
    proxy_auth:
      login: "user"
      password: "pass"
```

#### â±ï¸ è¶…æ—¶è®¾ç½®

```yaml
checks:
  - name: "è®¾ç½®è¶…æ—¶"
    pathname: "/api"
    method: GET
    timeout:
      total: 30
      connect: 10
      sock_read: 20
```

#### ğŸ¯ å¤æ‚æ–­è¨€ç¤ºä¾‹

```yaml
checks:
  - name: "å¤æ‚æ–­è¨€ç¤ºä¾‹"
    pathname: "/orders"
    method: POST
    assert:
      http_status: 201
      content:
        # ä½¿ç”¨å¤šä¸ªæ¡ä»¶
        is_valid: "{{ actual.amount >= 100 and actual.status in ['pending', 'processing'] }}"

        # ä½¿ç”¨è¿‡æ»¤å™¨é“¾
        is_valid_email: "{{ actual.email|is_email and actual.email|contains('@example.com') }}"

        # ä½¿ç”¨èŒƒå›´æ£€æŸ¥
        is_valid_amount: "{{ actual.amount|in_range(100, 1000) }}"

        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼
        is_valid_date: "{{ actual.created_at|matches('^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$') }}"
```

## ğŸ› ï¸ å¼€å‘

```bash
# å®‰è£…å¼€å‘ä¾èµ–
uv sync --dev

# è¿è¡Œä»£ç æ ¼å¼åŒ–
black src
isort src
```

## ğŸ“„ è®¸å¯è¯

MIT
