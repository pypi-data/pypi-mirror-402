name: Auto Version and Release

# Triggered manually by CI/CD Pipeline after tests pass
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number (if from PR merge)'
        required: false
        type: string
      pr_title:
        description: 'PR Title'
        required: false
        type: string
      pr_merged:
        description: 'Was PR merged'
        required: false
        type: string
        default: 'true'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-version:
    name: Auto Version Bump and Tag
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          # Use default GITHUB_TOKEN - we'll work around branch protection
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Determine version bump type
        id: bump_type
        run: |
          PR_TITLE="${{ github.event.inputs.pr_title }}"

          echo "PR Title: $PR_TITLE"

          BUMP_TYPE="patch"

          # Check PR title for conventional commit prefixes
          if echo "$PR_TITLE" | grep -qiE "^(breaking|feat|feature)(\(.*\))?!:"; then
            BUMP_TYPE="major"
          elif echo "$PR_TITLE" | grep -qiE "^(feat|feature)(\(.*\))?:"; then
            BUMP_TYPE="minor"
          elif echo "$PR_TITLE" | grep -qiE "^(fix|bugfix|chore|perf|refactor|docs)(\(.*\))?:"; then
            BUMP_TYPE="patch"
          fi

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Bump type: $BUMP_TYPE"

      - name: Calculate new version
        id: version
        run: |
          # Get current version from pyproject.toml
          CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

          # Parse and increment version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ†• New version: $NEW_VERSION"

      - name: Check if version already exists
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Check if tag exists
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag v$NEW_VERSION already exists"
            exit 0
          fi

          # Check if version matches what's in main
          MAIN_VERSION=$(git show origin/main:pyproject.toml | grep '^version = ' | sed 's/version = "\(.*\)"/\1/')
          if [ "$NEW_VERSION" == "$MAIN_VERSION" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Version $NEW_VERSION already in main"
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Version $NEW_VERSION is new"

      - name: Update version files
        if: steps.check.outputs.skip == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml

          # Update __init__.py
          if [ -f "src/msn_weather_wrapper/__init__.py" ]; then
            sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" src/msn_weather_wrapper/__init__.py
          fi

          echo "âœï¸  Updated version files to $NEW_VERSION"

      - name: Create version bump pull request
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"
          BRANCH_NAME="chore/version-bump-$NEW_VERSION"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and checkout new branch
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add pyproject.toml src/msn_weather_wrapper/__init__.py
          git commit -m "chore: bump version to $NEW_VERSION" \
                     -m "Auto-generated version bump" \
                     -m "Version: ${{ steps.version.outputs.current }} â†’ $NEW_VERSION" \
                     -m "Bump Type: ${{ steps.bump_type.outputs.bump_type }}" \
                     -m "Triggered by: PR #${{ github.event.inputs.pr_number }} - ${{ github.event.inputs.pr_title }}"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "chore: bump version to $NEW_VERSION" \
            --body "## Version Bump

          - **Previous**: v${{ steps.version.outputs.current }}
          - **New**: v$NEW_VERSION
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}
          - **Triggered by**: PR #${{ github.event.inputs.pr_number }} - ${{ github.event.inputs.pr_title }}

          This PR was automatically generated by the auto-version workflow. Once approved and merged, it will trigger the publish-release workflow to create a release tag." \
            --base main \
            --head "$BRANCH_NAME"

          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number -q '.[0].number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "âœ… Created version bump PR #$PR_NUMBER"
          echo "ðŸ“¦ Version: ${{ steps.version.outputs.current }} â†’ $NEW_VERSION"

      - name: Auto-merge version bump PR
        if: steps.check.outputs.skip == 'false'
        id: merge_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"
          BRANCH_NAME="chore/version-bump-$NEW_VERSION"

          # Get the PR number
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number -q '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ Could not find PR for branch $BRANCH_NAME"
            exit 1
          fi

          # Enable auto-merge (requires repo settings to allow this)
          gh pr merge "$PR_NUMBER" --auto --squash || {
            echo "âš ï¸  Auto-merge not configured, attempting regular merge..."
            gh pr merge "$PR_NUMBER" --squash
          }

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… Merged version bump PR #$PR_NUMBER"

      - name: Clean up release branch
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"
          BRANCH_NAME="chore/version-bump-$NEW_VERSION"

          # Delete the remote branch
          gh api repos/{owner}/{repo}/git/refs/heads/"$BRANCH_NAME" -X DELETE || {
            echo "âš ï¸  Could not delete branch via API, attempting via git..."
            git push origin --delete "$BRANCH_NAME" || echo "âš ï¸  Branch deletion failed, but release process continues"
          }

          echo "ðŸ—‘ï¸  Deleted release branch: $BRANCH_NAME"

      - name: Create release tag
        if: steps.check.outputs.skip == 'false'
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Wait for merge to be processed
          echo "â³ Waiting for PR merge to be processed..."
          sleep 5

          # Fetch latest main
          git fetch origin main
          git checkout main
          git pull origin main

          # Get the latest commit SHA on main
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "ðŸ“ Tagging commit: $COMMIT_SHA"

          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v$NEW_VERSION" "$COMMIT_SHA" \
                  -m "Release v$NEW_VERSION" \
                  -m "Auto-generated from PR #${{ steps.merge_pr.outputs.pr_number }}: ${{ github.event.inputs.pr_title }}" \
                  -m "Bump type: ${{ steps.bump_type.outputs.bump_type }}"

          git push origin "v$NEW_VERSION"
          echo "tag=${{ steps.merge_pr.outputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Created and pushed tag v$NEW_VERSION at commit $COMMIT_SHA"

      - name: Trigger publish-release workflow
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Wait a moment for tag to be fully processed
          sleep 5

          # Trigger publish-release workflow with the new version tag
          gh workflow run publish-release.yml \
            -f tag="v$NEW_VERSION"

          echo "ðŸš€ Triggered publish-release workflow for v$NEW_VERSION"

      - name: Generate summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.skip }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # â„¹ï¸  No Version Bump Needed

          Version ${{ steps.version.outputs.new }} already exists or is already in main.

          **Current version**: ${{ steps.version.outputs.current }}
          **Would-be version**: ${{ steps.version.outputs.new }}
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ Version Bump Complete!

          ## Version Change
          - **Previous**: v${{ steps.version.outputs.current }}
          - **New**: v${{ steps.version.outputs.new }}
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}

          ## Actions Taken
          1. âœ… Version bump PR #${{ steps.merge_pr.outputs.pr_number }} created and merged
          2. ðŸ·ï¸ Tag v${{ steps.version.outputs.new }} created
          3. ðŸš€ Publish workflow triggered

          ## Bump Type Rules
          - **Major (X.0.0)**: breaking changes, labels: `major`, `breaking`
          - **Minor (0.X.0)**: new features, labels: `minor`, `feature`
          - **Patch (0.0.X)**: bug fixes, everything else (default)
          EOF
          fi
