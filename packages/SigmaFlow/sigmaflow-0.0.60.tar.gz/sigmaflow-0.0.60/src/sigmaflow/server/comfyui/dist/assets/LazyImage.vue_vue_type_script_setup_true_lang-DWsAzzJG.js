var de=Object.defineProperty;var p=(i,e)=>de(i,"name",{value:e,configurable:!0});import{cC as D,a as I,c as te,_ as F,k as ue,cq as ce,l as pe,h as q,s as me,u as Z,d as ee,m as fe}from"./index-Btwre5kD.js";import{b as oe,E as j,a as ge,bx as B,cM as W,cN as O,j as S,d,by as c,m as ve,k as y,e as r,G as X,c as g,q as w,u,p as he,d3 as be,cw as ye,z as _,w as N,d2 as we,eD as _e,r as U,A as E,f as le,o as $e,bg as ke,dc as Me,cd as Ue,s as Q}from"./vendor-other-PcOcwbNM.js";import{i as xe,y as Se,e as re,a as Ce}from"./vendor-primevue-6nO4LMK3.js";import{u as ne}from"./vendor-vue-Cz2Pyvdp.js";function A(){const i=oe({get supportsPreviewMetadata(){return I.getServerFeature("supports_preview_metadata")},get maxUploadSize(){return I.getServerFeature("max_upload_size")},get supportsManagerV4(){return I.getServerFeature("extension.manager.supports_v4")},get modelUploadButtonEnabled(){return D.value.model_upload_button_enabled??I.getServerFeature("model_upload_button_enabled",!1)},get assetDeletionEnabled(){return D.value.asset_deletion_enabled??I.getServerFeature("asset_deletion_enabled",!1)},get assetRenameEnabled(){return D.value.asset_rename_enabled??I.getServerFeature("asset_rename_enabled",!1)},get privateModelsEnabled(){return D.value.private_models_enabled??I.getServerFeature("private_models_enabled",!1)},get onboardingSurveyEnabled(){return D.value.onboarding_survey_enabled??I.getServerFeature("onboarding_survey_enabled",!0)},get huggingfaceModelImportEnabled(){return D.value.huggingface_model_import_enabled??I.getServerFeature("huggingface_model_import_enabled",!1)},get asyncModelUploadEnabled(){return D.value.async_model_upload_enabled??I.getServerFeature("async_model_upload_enabled",!1)}}),e=p((n,a)=>j(()=>I.getServerFeature(n,a)),"featureFlag");return{flags:ge(i),featureFlag:e}}p(A,"useFeatureFlags");const Ie={class:"flex items-center gap-2 text-sm"},Be={key:0,class:"text-base-foreground"},Fe={key:1,class:"text-base-foreground"},Ve={class:"truncate"},je={key:0,class:"icon-[lucide--check] text-base-foreground"},Le=B({inheritAttrs:!1,__name:"SingleSelect",props:W({label:{},options:{},listMaxHeight:{default:"28rem"},popoverMinWidth:{},popoverMaxWidth:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=O(i,"modelValue"),{t:n}=ne(),a=p(o=>{if(o==null||!i.options)return i.label??"";const t=i.options.find(l=>l.value===o);return t?t.name:i.label??""},"getLabel"),s=j(()=>{if(!i.popoverMinWidth&&!i.popoverMaxWidth)return;const o=[];return i.popoverMinWidth&&o.push(`min-width: ${i.popoverMinWidth}`),i.popoverMaxWidth&&o.push(`max-width: ${i.popoverMaxWidth}`),o.join("; ")});return(o,t)=>(d(),S(c(xe),ve({modelValue:e.value,"onUpdate:modelValue":t[0]||(t[0]=l=>e.value=l)},o.$attrs,{options:o.options,"option-label":"name","option-value":"value",unstyled:"",pt:{root:p(({props:l})=>({class:["h-10 relative inline-flex cursor-pointer select-none items-center","rounded-lg","bg-secondary-background text-base-foreground","border-[2.5px] border-solid border-transparent","transition-all duration-200 ease-in-out","focus-within:border-node-component-border",{"opacity-60 cursor-default":l.disabled}]}),"root"),label:{class:"flex-1 flex items-center whitespace-nowrap pl-4 py-2 outline-hidden"},dropdown:{class:"flex shrink-0 items-center justify-center px-3 py-2"},overlay:{class:c(te)("mt-2 p-2 rounded-lg","bg-base-background text-base-foreground","border border-solid border-border-default")},listContainer:p(()=>({style:`max-height: min(${o.listMaxHeight}, 50vh)`,class:"scrollbar-custom"}),"listContainer"),list:{class:"flex flex-col gap-0 p-0 m-0 list-none border-none text-sm"},option:p(({context:l})=>({class:c(te)("flex items-center justify-between gap-3 px-2 py-3 rounded","hover:bg-secondary-background-hover",l.focused&&"bg-secondary-background-hover",l.selected&&"bg-secondary-background-selected hover:bg-secondary-background-selected")}),"option"),optionLabel:{class:"truncate"},optionGroupLabel:{class:"px-3 py-2 text-xs uppercase tracking-wide text-muted-foreground"},emptyMessage:{class:"px-3 py-2 text-sm text-muted-foreground"}},"aria-label":o.label||c(n)("g.singleSelectDropdown"),role:"combobox","aria-expanded":!1,"aria-haspopup":"listbox",tabindex:0}),{value:y(l=>[r("div",Ie,[he(o.$slots,"icon"),l.value!==null&&l.value!==void 0?(d(),g("span",Be,u(a(l.value)),1)):(d(),g("span",Fe,u(o.label),1))])]),dropdownicon:y(()=>t[1]||(t[1]=[r("i",{class:"icon-[lucide--chevron-down] text-muted-foreground"},null,-1)])),option:y(({option:l,selected:v})=>[r("div",{class:"flex w-full items-center justify-between gap-3",style:X(s.value)},[r("span",Ve,u(l.name),1),v?(d(),g("i",je)):w("",!0)],4)]),_:3},16,["modelValue","options","pt","aria-label"]))}});function De(i){const e={loras:"LoRA",ipadapter:"IP-Adapter",sams:"SAM",clip_vision:"CLIP Vision",animatediff_motion_lora:"AnimateDiff Motion LoRA",animatediff_models:"AnimateDiff Model",vae:"VAE",sam2:"SAM 2",controlnet:"ControlNet",gligen:"GLIGEN"};return e[i]?e[i]:i.split("_").map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}p(De,"formatDisplayName");const Ee=["nlf"],ie=be(()=>{const{state:i,isLoading:e,error:n,execute:a}=ye(async()=>(await I.getModelFolders()).filter(o=>!Ee.includes(o.name)).map(o=>({name:De(o.name),value:o.name})).sort((o,t)=>o.name.localeCompare(t.name)),[],{immediate:!1,onError:p(s=>{console.error("Failed to fetch model types:",s)},"onError")});return{modelTypes:i,isLoading:e,error:n,fetchModelTypes:a}}),Ae={class:"flex flex-col gap-4 text-sm text-muted-foreground"},Re={class:"flex flex-col gap-2"},ze={class:"m-0"},Te={class:"flex items-center gap-3 bg-secondary-background p-3 rounded-lg"},He=["src","alt"],Pe={class:"m-0 text-base-foreground"},qe={class:"flex flex-col gap-2"},We={class:""},Oe={class:"flex items-center gap-2"},Ne=B({__name:"UploadModelConfirmation",props:W({metadata:{},previewImage:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=O(i,"modelValue"),{modelTypes:n,isLoading:a}=ie();return(s,o)=>(d(),g("div",Ae,[r("div",Re,[r("p",ze,u(s.$t("assetBrowser.modelAssociatedWithLink")),1),r("div",Te,[s.previewImage?(d(),g("img",{key:0,src:s.previewImage,alt:s.metadata?.filename||s.metadata?.name||"Model preview",class:"w-14 h-14 rounded object-cover flex-shrink-0"},null,8,He)):w("",!0),r("p",Pe,u(s.metadata?.filename||s.metadata?.name),1)])]),r("div",qe,[r("label",We,u(s.$t("assetBrowser.modelTypeSelectorLabel")),1),_(Le,{modelValue:e.value,"onUpdate:modelValue":o[0]||(o[0]=t=>e.value=t),label:c(a)?s.$t("g.loading"):s.$t("assetBrowser.modelTypeSelectorPlaceholder"),options:c(n),disabled:c(a),"data-attr":"upload-model-step2-type-selector"},null,8,["modelValue","label","options","disabled"]),r("div",Oe,[o[1]||(o[1]=r("i",{class:"icon-[lucide--circle-question-mark]"},null,-1)),r("span",null,u(s.$t("assetBrowser.notSureLeaveAsIs")),1)])])]))}}),Ge={class:"relative"},Ke=["aria-label","src"],ae=B({__name:"VideoHelpDialog",props:W({videoUrl:{},ariaLabel:{default:"Help video"}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=O(i,"modelValue"),n=p(a=>{a.key==="Escape"&&(a.stopImmediatePropagation(),a.stopPropagation(),a.preventDefault(),e.value=!1)},"handleEscapeKey");return N(e,a=>{if(a){const s=we(document,"keydown",n,{capture:!0});_e(s)}},{immediate:!0}),(a,s)=>(d(),S(c(Se),{visible:e.value,"onUpdate:visible":s[1]||(s[1]=o=>e.value=o),modal:"",closable:!1,"close-on-escape":!1,"dismissable-mask":!0,pt:{root:{class:"video-help-dialog"},header:{class:"!hidden"},content:{class:"!p-0"},mask:{class:"!bg-black/70"}},style:{width:"90vw",maxWidth:"800px"}},{default:y(()=>[r("div",Ge,[_(F,{variant:"textonly",size:"icon",class:"absolute top-4 right-6 z-10","aria-label":a.$t("g.close"),onClick:s[0]||(s[0]=o=>e.value=!1)},{default:y(()=>s[2]||(s[2]=[r("i",{class:"pi pi-times text-sm"},null,-1)])),_:1},8,["aria-label"]),r("video",{autoplay:"",muted:"",loop:"","aria-label":a.ariaLabel,class:"w-full rounded-lg",src:a.videoUrl},u(a.$t("g.videoFailedToLoad")),9,Ke)])]),_:1},8,["visible"]))}}),Ye={class:"flex justify-end gap-2 w-full"},Je={key:0,class:"mr-auto flex items-center gap-2"},Qe={key:4},Xe={key:0,class:"icon-[lucide--loader-circle] animate-spin"},Ze={key:0,class:"icon-[lucide--loader-circle] animate-spin"},et=B({__name:"UploadModelFooter",props:{currentStep:{},isFetchingMetadata:{type:Boolean},isUploading:{type:Boolean},canFetchMetadata:{type:Boolean},canUploadModel:{type:Boolean},uploadStatus:{}},emits:["back","fetchMetadata","upload","close"],setup(i,{emit:e}){const{flags:n}=A(),a=U(!1),s=U(!1),o=e;return(t,l)=>(d(),g("div",Ye,[t.currentStep===1&&c(n).huggingfaceModelImportEnabled?(d(),g("div",Je,[l[10]||(l[10]=r("i",{class:"icon-[lucide--circle-question-mark] text-muted-foreground"},null,-1)),_(F,{variant:"muted-textonly",size:"sm","data-attr":"upload-model-step1-help-civitai",onClick:l[0]||(l[0]=v=>a.value=!0)},{default:y(()=>[E(u(t.$t("assetBrowser.providerCivitai")),1)]),_:1}),_(F,{variant:"muted-textonly",size:"sm","data-attr":"upload-model-step1-help-huggingface",onClick:l[1]||(l[1]=v=>s.value=!0)},{default:y(()=>[E(u(t.$t("assetBrowser.providerHuggingFace")),1)]),_:1})])):t.currentStep===1?(d(),S(F,{key:1,variant:"muted-textonly",size:"lg",class:"mr-auto underline","data-attr":"upload-model-step1-help-link",onClick:l[2]||(l[2]=v=>a.value=!0)},{default:y(()=>[l[11]||(l[11]=r("i",{class:"icon-[lucide--circle-question-mark]"},null,-1)),r("span",null,u(t.$t("assetBrowser.uploadModelHowDoIFindThis")),1)]),_:1})):w("",!0),t.currentStep===1?(d(),S(F,{key:2,variant:"muted-textonly",size:"lg","data-attr":"upload-model-step1-cancel-button",disabled:t.isFetchingMetadata||t.isUploading,onClick:l[3]||(l[3]=v=>o("close"))},{default:y(()=>[E(u(t.$t("g.cancel")),1)]),_:1},8,["disabled"])):w("",!0),t.currentStep!==1&&t.currentStep!==3?(d(),S(F,{key:3,variant:"muted-textonly",size:"lg","data-attr":`upload-model-step${t.currentStep}-back-button`,disabled:t.isFetchingMetadata||t.isUploading,onClick:l[4]||(l[4]=v=>o("back"))},{default:y(()=>[E(u(t.$t("g.back")),1)]),_:1},8,["data-attr","disabled"])):(d(),g("span",Qe)),t.currentStep===1?(d(),S(F,{key:5,variant:"secondary",size:"lg","data-attr":"upload-model-step1-continue-button",disabled:!t.canFetchMetadata||t.isFetchingMetadata,onClick:l[5]||(l[5]=v=>o("fetchMetadata"))},{default:y(()=>[t.isFetchingMetadata?(d(),g("i",Xe)):w("",!0),r("span",null,u(t.$t("g.continue")),1)]),_:1},8,["disabled"])):t.currentStep===2?(d(),S(F,{key:6,variant:"secondary",size:"lg","data-attr":"upload-model-step2-confirm-button",disabled:!t.canUploadModel||t.isUploading,onClick:l[6]||(l[6]=v=>o("upload"))},{default:y(()=>[t.isUploading?(d(),g("i",Ze)):w("",!0),r("span",null,u(t.$t("assetBrowser.upload")),1)]),_:1},8,["disabled"])):t.currentStep===3&&(t.uploadStatus==="success"||t.uploadStatus==="processing")?(d(),S(F,{key:7,variant:"secondary","data-attr":"upload-model-step3-finish-button",onClick:l[7]||(l[7]=v=>o("close"))},{default:y(()=>[E(u(t.uploadStatus==="processing"?t.$t("g.close"):t.$t("assetBrowser.finish")),1)]),_:1})):w("",!0),_(ae,{modelValue:a.value,"onUpdate:modelValue":l[8]||(l[8]=v=>a.value=v),"video-url":"https://media.comfy.org/compressed_768/civitai_howto.webm","aria-label":t.$t("assetBrowser.uploadModelHelpVideo")},null,8,["modelValue","aria-label"]),_(ae,{modelValue:s.value,"onUpdate:modelValue":l[9]||(l[9]=v=>s.value=v),"video-url":"https://media.comfy.org/byom/huggingfacehowto.mp4","aria-label":t.$t("assetBrowser.uploadModelHelpVideo")},null,8,["modelValue","aria-label"])]))}}),tt={class:"flex flex-1 flex-col gap-6 text-sm text-muted-foreground"},at={key:0,class:"flex flex-col gap-2"},st={class:"m-0 font-bold"},ot={class:"m-0"},lt={class:"flex flex-row items-center gap-3 p-4 bg-modal-card-background rounded-lg"},rt=["src","alt"],nt={class:"flex flex-col justify-center items-start gap-1 flex-1"},it={class:"text-base-foreground m-0"},dt={class:"text-sm text-muted m-0"},ut={key:1,class:"flex flex-col gap-2"},ct={class:"m-0 font-bold"},pt={class:"m-0"},mt={class:"flex flex-row items-center gap-3 p-4 bg-modal-card-background rounded-lg"},ft=["src","alt"],gt={class:"flex flex-col justify-center items-start gap-1 flex-1"},vt={class:"text-base-foreground m-0"},ht={class:"text-sm text-muted m-0"},bt={key:2,class:"flex flex-1 flex-col items-center justify-center gap-6"},yt={class:"text-center"},wt={class:"m-0 text-sm font-bold"},_t={key:0,class:"text-sm text-muted mb-0"},$t=B({__name:"UploadModelProgress",props:{result:{},error:{},metadata:{},modelType:{},previewImage:{}},setup(i){return(e,n)=>(d(),g("div",tt,[e.result==="processing"?(d(),g("div",at,[r("p",st,u(e.$t("assetBrowser.processingModel")),1),r("p",ot,u(e.$t("assetBrowser.processingModelDescription")),1),r("div",lt,[e.previewImage?(d(),g("img",{key:0,src:e.previewImage,alt:e.metadata?.filename||e.metadata?.name||"Model preview",class:"w-14 h-14 rounded object-cover flex-shrink-0"},null,8,rt)):w("",!0),r("div",nt,[r("p",it,u(e.metadata?.filename||e.metadata?.name),1),r("p",dt,u(e.modelType),1)])])])):e.result==="success"?(d(),g("div",ut,[r("p",ct,u(e.$t("assetBrowser.modelUploaded")),1),r("p",pt,u(e.$t("assetBrowser.findInLibrary",{type:e.modelType})),1),r("div",mt,[e.previewImage?(d(),g("img",{key:0,src:e.previewImage,alt:e.metadata?.filename||e.metadata?.name||"Model preview",class:"w-14 h-14 rounded object-cover flex-shrink-0"},null,8,ft)):w("",!0),r("div",gt,[r("p",vt,u(e.metadata?.filename||e.metadata?.name),1),r("p",ht,u(e.modelType),1)])])])):e.result==="error"?(d(),g("div",bt,[n[0]||(n[0]=r("i",{class:"icon-[lucide--x-circle] text-6xl text-error"},null,-1)),r("div",yt,[r("p",wt,u(e.$t("assetBrowser.uploadFailed")),1),e.error?(d(),g("p",_t,u(e.error),1)):w("",!0)])])):w("",!0)]))}}),kt={class:"flex flex-col justify-between h-full gap-6 text-sm"},Mt={class:"flex flex-col gap-6"},Ut={class:"flex flex-col gap-2"},xt={class:"m-0 text-foreground"},St={class:"m-0"},Ct={class:"m-0 text-muted-foreground"},It={class:"inline-flex items-center gap-1 flex-wrap mt-2"},Bt={class:"inline-flex items-center gap-1"},Ft=["alt"],Vt={class:"inline-flex items-center gap-1"},jt=["alt"],Lt={class:"flex flex-col gap-2"},Dt={key:0,class:"text-xs text-error"},Et={key:1,class:"text-foreground"},At={class:"font-bold italic"},Rt={class:"text-sm text-muted"},zt="/assets/images/civitai.svg",Tt="https://civitai.com/models",Ht="/assets/images/hf-logo.svg",Pt="https://huggingface.co",qt=B({__name:"UploadModelUrlInput",props:{modelValue:{},error:{}},emits:["update:modelValue"],setup(i,{emit:e}){const{flags:n}=A(),a=i,s=e,o=j({get:p(()=>a.modelValue,"get"),set:p(t=>s("update:modelValue",t),"set")});return(t,l)=>{const v=le("i18n-t");return d(),g("div",kt,[r("div",Mt,[r("div",Ut,[r("p",xt,u(t.$t("assetBrowser.uploadModelDescription1Generic")),1),r("div",St,[r("p",Ct,u(t.$t("assetBrowser.uploadModelDescription2Generic")),1),r("span",It,[r("span",Bt,[r("img",{src:zt,alt:t.$t("assetBrowser.providerCivitai"),class:"w-4 h-4"},null,8,Ft),r("a",{href:Tt,target:"_blank",rel:"noopener noreferrer",class:"text-muted underline"},u(t.$t("assetBrowser.providerCivitai")),1),l[1]||(l[1]=r("span",null,",",-1))]),r("span",Vt,[r("img",{src:Ht,alt:t.$t("assetBrowser.providerHuggingFace"),class:"w-4 h-4"},null,8,jt),r("a",{href:Pt,target:"_blank",rel:"noopener noreferrer",class:"text-muted underline"},u(t.$t("assetBrowser.providerHuggingFace")),1)])])])]),r("div",Lt,[_(c(re),{modelValue:o.value,"onUpdate:modelValue":l[0]||(l[0]=M=>o.value=M),autofocus:"",placeholder:t.$t("assetBrowser.genericLinkPlaceholder"),class:"w-full bg-secondary-background border-0 p-4","data-attr":"upload-model-step1-url-input"},null,8,["modelValue","placeholder"]),t.error?(d(),g("p",Dt,u(t.error),1)):c(n).asyncModelUploadEnabled?w("",!0):(d(),g("p",Et,[_(v,{keypath:"assetBrowser.maxFileSize",tag:"span"},{size:y(()=>[r("span",At,u(t.$t("assetBrowser.maxFileSizeValue")),1)]),_:1})]))])]),r("div",Rt,u(t.$t("assetBrowser.uploadModelHelpFooterText")),1)])}}}),Wt={class:"flex flex-col gap-6 text-sm text-muted-foreground"},Ot={class:"flex flex-col gap-2"},Nt={class:"m-0"},Gt={class:"list-disc space-y-1 pl-5 mt-0"},Kt={href:"https://civitai.com/models",target:"_blank",class:"text-muted-foreground"},Yt={key:0},Jt={class:"font-bold italic"},Qt={class:"flex flex-col gap-2"},Xt={class:"font-bold italic"},Zt={key:0,class:"text-xs text-error"},ea={href:"https://civitai.com/models/10706/luisap-z-image-and-qwen-pixel-art-refiner?modelVersionId=2225295",target:"_blank",class:"text-muted-foreground"},ta=B({__name:"UploadModelUrlInputCivitai",props:W({error:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const{flags:e}=A(),n=O(i,"modelValue");return(a,s)=>{const o=le("i18n-t");return d(),g("div",Wt,[r("div",Ot,[r("p",Nt,u(a.$t("assetBrowser.uploadModelDescription1")),1),r("ul",Gt,[r("li",null,[_(o,{keypath:"assetBrowser.uploadModelDescription2",tag:"span"},{link:y(()=>[r("a",Kt,u(a.$t("assetBrowser.uploadModelDescription2Link")),1)]),_:1})]),c(e).asyncModelUploadEnabled?w("",!0):(d(),g("li",Yt,[_(o,{keypath:"assetBrowser.uploadModelDescription3",tag:"span"},{size:y(()=>[r("span",Jt,u(a.$t("assetBrowser.maxFileSizeValue")),1)]),_:1})]))])]),r("div",Qt,[_(o,{keypath:"assetBrowser.civitaiLinkLabel",tag:"label",class:"mb-0"},{download:y(()=>[r("span",Xt,u(a.$t("assetBrowser.civitaiLinkLabelDownload")),1)]),_:1}),_(c(re),{modelValue:n.value,"onUpdate:modelValue":s[0]||(s[0]=t=>n.value=t),autofocus:"",placeholder:a.$t("assetBrowser.civitaiLinkPlaceholder"),class:"w-full bg-secondary-background border-0 p-4","data-attr":"upload-model-step1-url-input"},null,8,["modelValue","placeholder"]),a.error?(d(),g("p",Zt,u(a.error),1)):(d(),S(o,{key:1,keypath:"assetBrowser.civitaiLinkExample",tag:"p",class:"text-xs"},{example:y(()=>[r("strong",null,u(a.$t("assetBrowser.civitaiLinkExampleStrong")),1)]),link:y(()=>[r("a",ea,u(a.$t("assetBrowser.civitaiLinkExampleUrl")),1)]),_:1}))])])}}}),se={type:"civitai",name:"Civitai",hostnames:["civitai.com"]},aa={type:"huggingface",name:"Hugging Face",hostnames:["huggingface.co"]};function sa(i,e){try{const n=new URL(i).hostname.toLowerCase();return e.hostnames.some(a=>n===a||n.endsWith(`.${a}`))}catch{return!1}}p(sa,"validateSourceUrl");function oa(i){const{t:e}=ne(),n=ue(),a=ce(),s=pe(),{flags:o}=A(),t=U(1),l=U(!1),v=U(!1),M=U(),x=U(""),h=U({url:"",name:"",tags:[]}),f=U(),$=o.huggingfaceModelImportEnabled?[se,aa]:[se],L=j(()=>{const k=h.value.url.trim();return k?$.find(b=>sa(k,b))??null:null});N(()=>h.value.url,()=>{x.value=""});const T=j(()=>h.value.url.trim().length>0),H=j(()=>!!f.value);async function G(){if(!T.value)return;let k=h.value.url.trim();try{k=new URL(encodeURI(k)).toString()}catch{}if(h.value.url=k,!L.value){const m=$.map(C=>C.name).join(", ");x.value=e("assetBrowser.unsupportedUrlSource",{sources:m});return}l.value=!0;try{const m=await q.getAssetMetadata(h.value.url);if(m.filename)try{m.filename=decodeURIComponent(m.filename)}catch{}if(m.name)try{m.name=decodeURIComponent(m.name)}catch{}if(h.value.metadata=m,h.value.name=m.filename||m.name||"",h.value.previewImage=m.preview_image,m.tags&&m.tags.length>0){h.value.tags=m.tags;const C=m.tags.find(R=>i.value.some(z=>z.value===R));C&&(f.value=C)}t.value=2}catch(m){console.error("Failed to retrieve metadata:",m),x.value=m instanceof Error?m.message:me("assetBrowser.uploadModelFailedToRetrieveMetadata","Failed to retrieve metadata. Please check the link and try again."),t.value=1}finally{l.value=!1}}p(G,"fetchMetadata");async function K(k){if(h.value.previewImage)try{const b=k.split(".")[0];let m="png";const C=h.value.previewImage.match(/^data:image\/([^;]+);/);return C&&(m=C[1]==="jpeg"?"jpg":C[1]),(await q.uploadAssetFromBase64({data:h.value.previewImage,name:`${b}_preview.${m}`,tags:["preview"]})).id}catch(b){console.error("Failed to upload preview image:",b);return}}p(K,"uploadPreviewImage");async function P(){if(!f.value)return;const k=s.getAllNodeProviders(f.value);(await Promise.allSettled(k.map(m=>n.updateModelsForNodeType(m.nodeDef.name)))).forEach((m,C)=>{m.status==="rejected"&&console.error(`Failed to refresh ${k[C].nodeDef.name}:`,m.reason)})}p(P,"refreshModelCaches");async function Y(){if(!H.value)return!1;const k=L.value;if(!k)return x.value=e("assetBrowser.noValidSourceDetected"),!1;v.value=!0;try{const b=f.value?["models",f.value]:["models"],m=h.value.metadata?.filename||h.value.metadata?.name||"model",C=await K(m),R={source:k.type,source_url:h.value.url,model_type:f.value};if(o.asyncModelUploadEnabled){const z=await q.uploadAssetAsync({source_url:h.value.url,tags:b,user_metadata:R,preview_id:C});z.type==="async"&&z.task.status!=="completed"?(f.value&&a.trackDownload(z.task.task_id,f.value),M.value="processing"):(M.value="success",await P()),t.value=3}else await q.uploadAssetFromUrl({url:h.value.url,name:m,tags:b,user_metadata:R,preview_id:C}),M.value="success",await P(),t.value=3}catch(b){console.error("Failed to upload asset:",b),M.value="error",x.value=b instanceof Error?b.message:"Failed to upload model",t.value=3}finally{v.value=!1}return M.value!=="error"}p(Y,"uploadModel");function J(){t.value>1&&(t.value=t.value-1)}return p(J,"goToPreviousStep"),{currentStep:t,isFetchingMetadata:l,isUploading:v,uploadStatus:M,uploadError:x,wizardData:h,selectedModelType:f,canFetchMetadata:T,canUploadModel:H,detectedSource:L,fetchMetadata:G,uploadModel:Y,goToPreviousStep:J}}p(oa,"useUploadModelWizard");const la={class:"upload-model-dialog flex flex-col justify-between gap-6 p-4 pt-6 border-t border-border-default"},ra=B({__name:"UploadModelDialog",emits:["upload-success"],setup(i,{emit:e}){const{flags:n}=A(),a=Z(),{modelTypes:s,fetchModelTypes:o}=ie(),t=e,{currentStep:l,isFetchingMetadata:v,isUploading:M,uploadStatus:x,uploadError:h,wizardData:f,selectedModelType:$,canFetchMetadata:L,canUploadModel:T,fetchMetadata:H,uploadModel:G,goToPreviousStep:K}=oa(s);async function P(){await H()}p(P,"handleFetchMetadata");async function Y(){await G()&&t("upload-success")}p(Y,"handleUploadModel");function J(){a.closeDialog({key:"upload-model"})}return p(J,"handleClose"),$e(()=>{o()}),(k,b)=>(d(),g("div",la,[c(l)===1&&c(n).huggingfaceModelImportEnabled?(d(),S(qt,{key:0,modelValue:c(f).url,"onUpdate:modelValue":b[0]||(b[0]=m=>c(f).url=m),error:c(h),class:"flex-1"},null,8,["modelValue","error"])):c(l)===1?(d(),S(ta,{key:1,modelValue:c(f).url,"onUpdate:modelValue":b[1]||(b[1]=m=>c(f).url=m),error:c(h)},null,8,["modelValue","error"])):c(l)===2?(d(),S(Ne,{key:2,modelValue:c($),"onUpdate:modelValue":b[2]||(b[2]=m=>ke($)?$.value=m:null),metadata:c(f).metadata,"preview-image":c(f).previewImage},null,8,["modelValue","metadata","preview-image"])):c(l)===3&&c(x)!=null?(d(),S($t,{key:3,result:c(x),error:c(h),metadata:c(f).metadata,"model-type":c($),"preview-image":c(f).previewImage},null,8,["result","error","metadata","model-type","preview-image"])):w("",!0),_(et,{"current-step":c(l),"is-fetching-metadata":c(v),"is-uploading":c(M),"can-fetch-metadata":c(L),"can-upload-model":c(T),"upload-status":c(x),onBack:c(K),onFetchMetadata:P,onUpload:Y,onClose:J},null,8,["current-step","is-fetching-metadata","is-uploading","can-fetch-metadata","can-upload-model","upload-status","onBack"])]))}}),na=ee(ra,[["__scopeId","data-v-9c39272c"]]),ia="/workspace/assets/images/civitai.svg",da={class:"flex items-center gap-2 p-4 font-bold"},ua={key:0,src:ia,class:"size-4"},ca={class:"rounded-full bg-white px-1.5 py-0 text-xxs font-inter font-semibold uppercase text-black"},pa=B({__name:"UploadModelDialogHeader",setup(i){const{flags:e}=A(),n=j(()=>e.huggingfaceModelImportEnabled?"assetBrowser.uploadModelGeneric":"assetBrowser.uploadModelFromCivitai");return(a,s)=>(d(),g("div",da,[c(e).huggingfaceModelImportEnabled?w("",!0):(d(),g("img",ua)),r("span",null,u(a.$t(n.value)),1),r("span",ca,u(a.$t("g.beta")),1)]))}}),ma={},fa={class:"flex flex-1 flex-col items-center justify-center text-base text-muted-foreground"},ga={class:"m-0 max-w-md"};function va(i,e){return d(),g("div",fa,[r("p",ga,u(i.$t("assetBrowser.upgradeFeatureDescription")),1)])}p(va,"_sfc_render$1");const ha=ee(ma,[["render",va]]),ba={class:"flex flex-wrap justify-end gap-2 w-full"},ya={href:"https://blog.comfy.org/p/comfy-cloud-new-features-and-pricing",target:"_blank",rel:"noopener noreferrer",class:"text-muted-foreground mr-auto underline flex items-center gap-2"},wa=B({__name:"UploadModelUpgradeModalFooter",emits:["close","subscribe"],setup(i,{emit:e}){const n=e;return(a,s)=>(d(),g("div",ba,[r("a",ya,[s[2]||(s[2]=r("i",{class:"icon-[lucide--external-link]"},null,-1)),r("span",null,u(a.$t("g.learnMore")),1)]),_(F,{variant:"textonly",onClick:s[0]||(s[0]=o=>n("close"))},{default:y(()=>[E(u(a.$t("g.close")),1)]),_:1}),_(F,{variant:"secondary",onClick:s[1]||(s[1]=o=>n("subscribe"))},{default:y(()=>[E(u(a.$t("subscription.required.subscribe")),1)]),_:1})]))}}),_a={class:"flex flex-col justify-between gap-10 p-4 border-t border-border-default w-auto max-w-[min(500px,90vw)]"},$a=B({__name:"UploadModelUpgradeModal",setup(i){const e=Z(),{showSubscriptionDialog:n}=fe();function a(){e.closeDialog({key:"upload-model-upgrade"})}p(a,"handleClose");function s(){n()}return p(s,"handleSubscribe"),(o,t)=>(d(),g("div",_a,[_(ha),_(wa,{onClose:a,onSubscribe:s})]))}}),ka={},Ma={class:"flex items-center gap-2 p-4 font-bold"};function Ua(i,e){return d(),g("div",Ma,[r("span",null,u(i.$t("assetBrowser.upgradeToUnlockFeature")),1)])}p(Ua,"_sfc_render");const xa=ee(ka,[["render",Ua]]);function za(i){const e=Z(),{flags:n}=A(),a=j(()=>n.modelUploadButtonEnabled);function s(){n.privateModelsEnabled?e.showDialog({key:"upload-model",headerComponent:pa,component:na,props:{onUploadSuccess:p(async()=>{await i?.()},"onUploadSuccess")},dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0!"}}}):e.showDialog({key:"upload-model-upgrade",headerComponent:xa,component:$a,dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0!"}}})}return p(s,"showUploadDialog"),{isUploadButtonEnabled:a,showUploadDialog:s}}p(za,"useModelUpload");const Sa="/workspace/assets/images/default-template.png";function Ca(i,e,n={}){const{immediate:a=!0,...s}=n,o=typeof window<"u"&&"IntersectionObserver"in window,t=U(!1);let l=null;const v=p(()=>{l&&(l.disconnect(),l=null)},"cleanup"),M=p(()=>{v(),!(!o||!i.value)&&(l=new IntersectionObserver(h=>{t.value=h.some(f=>f.isIntersecting),e(h,l)},s),l.observe(i.value))},"observe"),x=p(()=>{l&&i.value&&l.unobserve(i.value)},"unobserve");return a&&N(i,M,{immediate:!0,flush:"post"}),Me(v),{isSupported:o,isIntersecting:t,observe:M,unobserve:x,cleanup:v}}p(Ca,"useIntersectionObserver");class Ia{static{p(this,"MediaCacheService")}cache=oe(new Map);maxSize;maxAge;cleanupInterval=null;urlRefCount=new Map;constructor(e={}){this.maxSize=e.maxSize??100,this.maxAge=e.maxAge??1800*1e3,this.startCleanupInterval()}startCleanupInterval(){this.cleanupInterval=window.setInterval(()=>{this.cleanup()},300*1e3)}cleanup(){const e=Date.now(),n=[];for(const[a,s]of Array.from(this.cache.entries()))e-s.lastAccessed>this.maxAge&&(s.objectUrl?(this.urlRefCount.get(s.objectUrl)||0)===0&&(URL.revokeObjectURL(s.objectUrl),this.urlRefCount.delete(s.objectUrl),n.push(a)):n.push(a));if(n.forEach(a=>this.cache.delete(a)),this.cache.size>this.maxSize){const a=Array.from(this.cache.entries());a.sort((t,l)=>t[1].lastAccessed-l[1].lastAccessed);let s=0;const o=this.cache.size-this.maxSize;for(const[t,l]of a){if(s>=o)break;l.objectUrl?(this.urlRefCount.get(l.objectUrl)||0)===0&&(URL.revokeObjectURL(l.objectUrl),this.urlRefCount.delete(l.objectUrl),this.cache.delete(t),s++):(this.cache.delete(t),s++)}}}async getCachedMedia(e){let n=this.cache.get(e);if(n)return n.lastAccessed=Date.now(),n;n={src:e,isLoading:!0,lastAccessed:Date.now()},this.cache.set(e,n);try{const a=await fetch(e,{cache:"force-cache"});if(!a.ok)throw new Error(`Failed to fetch: ${a.status}`);const s=await a.blob(),o=URL.createObjectURL(s),t={src:e,blob:s,objectUrl:o,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,t),t}catch(a){console.warn("Failed to cache media:",e,a);const s={src:e,error:!0,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,s),s}}acquireUrl(e){const n=this.cache.get(e);if(n?.objectUrl){const a=this.urlRefCount.get(n.objectUrl)||0;return this.urlRefCount.set(n.objectUrl,a+1),n.objectUrl}}releaseUrl(e){const n=this.cache.get(e);if(n?.objectUrl){const a=(this.urlRefCount.get(n.objectUrl)||1)-1;a<=0?(URL.revokeObjectURL(n.objectUrl),this.urlRefCount.delete(n.objectUrl),this.cache.delete(e)):this.urlRefCount.set(n.objectUrl,a)}}clearCache(){for(const e of Array.from(this.cache.values()))e.objectUrl&&URL.revokeObjectURL(e.objectUrl);this.cache.clear(),this.urlRefCount.clear()}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clearCache()}}let V=null;function Ba(i){return V||(V=new Ia(i)),{getCachedMedia:p(o=>V.getCachedMedia(o),"getCachedMedia"),clearCache:p(()=>V.clearCache(),"clearCache"),acquireUrl:p(o=>V.acquireUrl(o),"acquireUrl"),releaseUrl:p(o=>V.releaseUrl(o),"releaseUrl"),cache:V.cache}}p(Ba,"useMediaCache");typeof window<"u"&&window.addEventListener("beforeunload",()=>{V&&V.destroy()});const Fa=["src","alt"],Va={key:2,class:"absolute inset-0 flex items-center justify-center"},ja=["alt"],Ta=B({__name:"LazyImage",props:{src:{},alt:{default:""},containerClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageStyle:{},rootMargin:{default:"300px"}},setup(i){const e=U(null),n=U(!1),a=U(!1),s=U(!1),o=U(void 0),{getCachedMedia:t,acquireUrl:l,releaseUrl:v}=Ba();Ca(e,f=>{const $=f[0];n.value=$?.isIntersecting??!1},{rootMargin:i.rootMargin,threshold:.1});const M=j(()=>n.value);N(M,async f=>{if(f&&i.src&&!o.value&&!s.value)try{const $=await t(i.src);if($.error)s.value=!0;else if($.objectUrl){const L=l(i.src);o.value=L||$.objectUrl}else o.value=i.src}catch($){console.warn("Failed to load cached media:",$),o.value=i.src}else f||(o.value?.startsWith("blob:")&&v(i.src),a.value=!1,o.value=void 0,s.value=!1)},{immediate:!0});const x=p(()=>{a.value=!0,s.value=!1},"onImageLoad"),h=p(()=>{s.value=!0,a.value=!1},"onImageError");return Ue(()=>{o.value?.startsWith("blob:")&&v(i.src)}),(f,$)=>(d(),g("div",{ref_key:"containerRef",ref:e,class:Q(["relative flex h-full w-full items-center justify-center overflow-hidden",f.containerClass])},[a.value?w("",!0):(d(),S(c(Ce),{key:0,width:"100%",height:"100%",class:"absolute inset-0"})),o.value?(d(),g("img",{key:1,src:o.value,alt:f.alt,draggable:"false",class:Q(f.imageClass),style:X(f.imageStyle),onLoad:x,onError:h},null,46,Fa)):w("",!0),s.value?(d(),g("div",Va,[r("img",{src:Sa,alt:f.alt,draggable:"false",class:Q(f.imageClass),style:X(f.imageStyle)},null,14,ja)])):w("",!0)],2))}});export{Le as _,za as a,Sa as b,Ta as c,Ca as d,A as u};
//# sourceMappingURL=LazyImage.vue_vue_type_script_setup_true_lang-DWsAzzJG.js.map
