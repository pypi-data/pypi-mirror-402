{"version":3,"file":"audioService-DI4fNrym.js","sources":["../../../../../../../ComfyUI_frontend/src/services/audioService.ts"],"sourcesContent":["import { register } from 'extendable-media-recorder'\nimport { connect } from 'extendable-media-recorder-wav-encoder'\n\nimport { useToastStore } from '@/platform/updates/common/toastStore'\nimport { api } from '@/scripts/api'\n\nexport interface AudioRecordingError {\n  type: 'permission' | 'not_supported' | 'encoder' | 'recording' | 'unknown'\n  message: string\n  originalError?: unknown\n}\n\nlet isEncoderRegistered: boolean = false\n\nexport const useAudioService = () => {\n  const handleError = (\n    type: AudioRecordingError['type'],\n    message: string,\n    originalError?: unknown\n  ) => {\n    console.error(`Audio Service Error (${type}):`, message, originalError)\n  }\n\n  const stopAllTracks = (currentStream: MediaStream | null) => {\n    if (currentStream) {\n      currentStream.getTracks().forEach((track) => {\n        track.stop()\n      })\n      currentStream = null\n    }\n  }\n\n  const registerWavEncoder = async (): Promise<void> => {\n    if (isEncoderRegistered) {\n      return\n    }\n\n    try {\n      await register(await connect())\n      isEncoderRegistered = true\n    } catch (err) {\n      if (\n        err instanceof Error &&\n        err.message.includes('already an encoder stored')\n      ) {\n        isEncoderRegistered = true\n      } else {\n        handleError('encoder', 'Failed to register WAV encoder', err)\n      }\n    }\n  }\n\n  const convertBlobToFileAndSubmit = async (blob: Blob): Promise<string> => {\n    const name = `recording-${Date.now()}.wav`\n    const file = new File([blob], name, { type: blob.type || 'audio/wav' })\n\n    const body = new FormData()\n    body.append('image', file)\n    body.append('subfolder', 'audio')\n    body.append('type', 'temp')\n\n    const resp = await api.fetchApi('/upload/image', {\n      method: 'POST',\n      body\n    })\n\n    if (resp.status !== 200) {\n      const err = `Error uploading temp file: ${resp.status} - ${resp.statusText}`\n      useToastStore().addAlert(err)\n      throw new Error(err)\n    }\n\n    const tempAudio = await resp.json()\n\n    return `audio/${tempAudio.name} [temp]`\n  }\n\n  return {\n    // Methods\n    convertBlobToFileAndSubmit,\n    registerWavEncoder,\n    stopAllTracks\n  }\n}\n"],"names":["isEncoderRegistered","useAudioService","__name","handleError","type","message","originalError","blob","name","file","body","resp","api","err","useToastStore","register","connect","currentStream","track"],"mappings":"iLAYA,IAAIA,EAA+B,GAE5B,MAAMC,EAAkBC,EAAA,IAAM,CACnC,MAAMC,EAAcD,EAAA,CAClBE,EACAC,EACAC,IACG,CACH,QAAQ,MAAM,wBAAwBF,CAAI,KAAMC,EAASC,CAAa,CACxE,EANoB,eA8DpB,MAAO,CAEL,2BA3BiCJ,EAAA,MAAOK,GAAgC,CACxE,MAAMC,EAAO,aAAa,KAAK,IAAA,CAAK,OAC9BC,EAAO,IAAI,KAAK,CAACF,CAAI,EAAGC,EAAM,CAAE,KAAMD,EAAK,MAAQ,WAAA,CAAa,EAEhEG,EAAO,IAAI,SACjBA,EAAK,OAAO,QAASD,CAAI,EACzBC,EAAK,OAAO,YAAa,OAAO,EAChCA,EAAK,OAAO,OAAQ,MAAM,EAE1B,MAAMC,EAAO,MAAMC,EAAI,SAAS,gBAAiB,CAC/C,OAAQ,OACR,KAAAF,CAAA,CACD,EAED,GAAIC,EAAK,SAAW,IAAK,CACvB,MAAME,EAAM,8BAA8BF,EAAK,MAAM,MAAMA,EAAK,UAAU,GAC1E,MAAAG,EAAA,EAAgB,SAASD,CAAG,EACtB,IAAI,MAAMA,CAAG,CACrB,CAIA,MAAO,UAFW,MAAMF,EAAK,KAAA,GAEH,IAAI,SAChC,EAvBmC,8BA4BjC,mBAhDyBT,EAAA,SAA2B,CACpD,GAAI,CAAAF,EAIJ,GAAI,CACF,MAAMe,EAAS,MAAMC,GAAS,EAC9BhB,EAAsB,EACxB,OAASa,EAAK,CAEVA,aAAe,OACfA,EAAI,QAAQ,SAAS,2BAA2B,EAEhDb,EAAsB,GAEtBG,EAAY,UAAW,iCAAkCU,CAAG,CAEhE,CACF,EAlB2B,sBAiDzB,cA1DoBX,EAACe,GAAsC,CACvDA,IACFA,EAAc,UAAA,EAAY,QAASC,GAAU,CAC3CA,EAAM,KAAA,CACR,CAAC,EACDD,EAAgB,KAEpB,EAPsB,gBA0DpB,CAEJ,EArE+B"}