var At=Object.defineProperty;var u=(t,e)=>At(t,"name",{value:e,configurable:!0});import{r as f,cL as T,cM as ut,cN as b,aq as I,au as F,cO as Pt,ai as te,aO as H,cP as Gt,cQ as Wt,bk as pt,a8 as Rt,w as Ft,f as S,a0 as Bt,t as x,p as de,am as Ut,by as zt,at as $t,cR as Vt,cS as jt,cT as G,cU as P,b4 as Ht,cV as Pe,cW as Yt,cX as qt,cY as Xt,cZ as Kt,c_ as Ye,c$ as ce,d0 as U,d1 as $,aE as be,d2 as gt,d3 as Jt,d4 as Qt,d5 as Zt,d6 as R,B as ft,a as E,D as eo,d7 as to,d8 as ht,d9 as oo,aA as no,aF as io,e as ae,da as j,cJ as fe,db as so,cI as Ne,dc as he,dd as me,de as ro,u as mt,cH as ao,d as yt,aj as se,aT as Se,K as Me,df as wt,dg as lo,T as qe,dh as co,c3 as uo,di as po,dj as go,dk as fo,dl as ho}from"./index-Btwre5kD.js";import{bz as mo,cD as Xe,d4 as X,w as yo,n as xe,bx as vt,r as K,o as Ce,E as bt,dc as Nt,c as J,d as Q,e as A,u as B,by as Z,q as Ct,F as It,y as xt,A as kt,I as _t,G as Dt,d5 as wo,eF as vo}from"./vendor-other-PcOcwbNM.js";import{_ as Be}from"./Load3D.vue_vue_type_script_setup_true_lang-Bxfi2BNt.js";import{g as Ie,s as Tt}from"./audioUtils-DI1f8_g7.js";import{u as re}from"./audioService-DI4fNrym.js";import"./vendor-primevue-6nO4LMK3.js";import"./vendor-vue-Cz2Pyvdp.js";import"./vendor-xterm-CWYFmgbN.js";import"./vendor-three-Bbe9LX3q.js";import"./vendor-tiptap-BsEBJZ_K.js";class M extends ut{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,s,o){const n=b("button",{type:"button",textContent:e,contextPredicate:s,onclick:o});M.items.push(n)}static invalidatePreview(){if(T.clipspace&&T.clipspace.imgs&&T.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=T.clipspace.imgs[T.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(M.instance){const e=M.instance,s=b("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(s)):e.element=b("div.comfy-modal",{parent:document.body},[s]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(b("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),M.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let s in M.items){const o=M.items[s];(!o.contextPredicate||o.contextPredicate())&&e.push(M.items[s])}return e.push(b("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(T.clipspace?.imgs){const e=[],s=T.clipspace.imgs;for(let d=0;d<s.length;d++)e.push(b("option",{value:d},[`${d}`]));const o=b("select",{id:"clipspace_img_selector",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.selectedIndex=d.target.selectedIndex,M.invalidatePreview())},"onchange")},e),n=b("tr",{},[b("td",{},[b("font",{color:"white"},["Select Image"])]),b("td",{},[o])]),i=b("select",{id:"clipspace_img_paste_mode",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.img_paste_mode=d.target.value)},"onchange")},[b("option",{value:"selected"},"selected"),b("option",{value:"all"},"all")]);i.value=T.clipspace.img_paste_mode;const r=b("tr",{},[b("td",{},[b("font",{color:"white"},["Paste Mode"])]),b("td",{},[i])]),a=b("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=b("tr",{},[a]);return b("table",{},[n,r,l])}else return[]}createImgPreview(){return T.clipspace?.imgs?b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){M.invalidate(),this.element.style.display="block"}}f.registerExtension({name:"Comfy.Clipspace",init(t){t.openClipspace=function(){M.instance||(M.instance=new M,T.clipspace_invalidate_handler=M.invalidate),T.clipspace?M.instance.show():t.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=M;const bo={name:"Comfy.ContextMenuFilter",init(){const t=I.ContextMenu;I.ContextMenu=function(e,s){const o=new t(e,s);if(s?.className==="dark"&&e?.length>4){const n=document.createElement("input");n.classList.add("comfy-context-menu-filter"),n.placeholder="Filter list",o.root.prepend(n);const i=Array.from(o.root.querySelectorAll(".litemenu-entry"));let r=[...i],a=r.length;requestAnimationFrame(()=>{const d=F.active_canvas.current_node?.widgets?.filter(g=>Pt(g)&&g.options.values?.length===e.length).find(g=>g.options.values?.every((y,w)=>y===e[w]))?.value;let c=d?e.findIndex(g=>g===d):0;c<0&&(c=0);let h=r[c];m();function m(){h?.style.setProperty("background-color",""),h?.style.setProperty("color",""),h=r[c],h?.style.setProperty("background-color","#ccc","important"),h?.style.setProperty("color","#000","important")}u(m,"updateSelected");const p=u(()=>{if(o.root.getBoundingClientRect().top<0){const y=1-o.root.getBoundingClientRect().height/o.root.clientHeight,w=o.root.clientHeight*y/2;o.root.style.top=-w+"px"}},"positionList");n.addEventListener("keydown",g=>{switch(g.key){case"ArrowUp":g.preventDefault(),c===0?c=a-1:c--,m();break;case"ArrowRight":g.preventDefault(),c=a-1,m();break;case"ArrowDown":g.preventDefault(),c===a-1?c=0:c++,m();break;case"ArrowLeft":g.preventDefault(),c=0,m();break;case"Enter":h?.click();break;case"Escape":o.close();break}}),n.addEventListener("input",()=>{const g=n.value.toLocaleLowerCase();if(r=i.filter(y=>{const w=!g||y.textContent?.toLocaleLowerCase().includes(g);return y.style.display=w?"block":"none",w}),c=0,r.includes(h)&&(c=r.findIndex(y=>y===h)),a=r.length,m(),s.event){let y=s.event.clientY-10;const w=document.body.getBoundingClientRect(),v=o.root.getBoundingClientRect();w.height&&y>w.height-v.height-10&&(y=Math.max(0,w.height-v.height-10)),o.root.style.top=y+"px",p()}}),requestAnimationFrame(()=>{n.focus(),p()})})}return o},I.ContextMenu.prototype=t.prototype}};f.registerExtension(bo);function No(t=[]){if(!this.outputs[0].links?.length||!this.graph)return;const e=[...this.outputs[0].links.map(o=>this.graph.links[o]),...t];let s=this.widgets?.[0].value;for(const o of e){const n=this.graph?.getNodeById(o.target_id),i=n?.inputs[o.target_slot];if(!i){console.warn("Unable to resolve node or input for link",o);continue}const r=i.widget?.name;if(!r){console.warn("Invalid widget or widget name",i.widget);continue}const a=n.widgets?.find(l=>l.name===r);if(!a){console.warn(`Unable to find widget "${r}" on node [${n.id}]`);continue}a.value=s,a.callback?.(a.value,f.canvas,n,f.canvas.graph_mouse,{})}}u(No,"applyToGraph");function Co(){this.applyToGraph=te(this.applyToGraph,No);const t=this.widgets[0],e=mo([]);t.options.values=e;const s=u(()=>{e.splice(0,e.length,...this.widgets.filter(n=>n.name.startsWith("option")&&n.value).map(n=>`${n.value}`)),!f.configuringGraph&&(e.includes(`${t.value}`)||(t.value=e[0]??"",t.callback?.(t.value)))},"updateCombo");t.callback=te(t.callback,()=>this.applyToGraph());function o(n){if(!n.widgets)return;const i=n.widgets.length-1;n.addWidget("string",`option${i}`,"",()=>{});const r=n.widgets.at(-1);if(!r)return;let a="";Object.defineProperty(r,"value",{get(){return a},set(l){if(a=l,s(),!n.widgets)return;const d=n.widgets.at(-1);if(d===this){l&&o(n);return}l||n.widgets.at(-2)!==this||d?.value||(n.widgets.pop(),n.computeSize(n.size),this.callback(l))}})}u(o,"addOption"),o(this)}u(Co,"onNodeCreated");f.registerExtension({name:"Comfy.CustomCombo",beforeRegisterNodeDef(t,e){e?.name==="CustomCombo"&&(t.prototype.onNodeCreated=te(t.prototype.onNodeCreated,Co))}});H().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(t){if(t.widgets){const e=t.widgets.filter(s=>s.dynamicPrompts);for(const s of e)s.serializeValue=(o,n)=>{if(typeof s.value!="string")return s.value;const i=Gt(s.value);return o?.widgets_values&&(o.widgets_values[n]=i),i}}}});f.registerExtension({name:"Comfy.EditAttention",init(){const t=f.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(i,r){const a=parseFloat(i);if(isNaN(a))return i;const l=a+r;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function s(i,r){let a=r,l=r,d=0,c=0;for(;a>=0&&(a--,!(i[a]==="("&&d===c));)i[a]==="("&&d++,i[a]===")"&&c++;if(a<0)return null;for(d=0,c=0;l<i.length&&!(i[l]===")"&&d===c);)i[l]==="("&&d++,i[l]===")"&&c++,l++;return l===i.length?null:{start:a+1,end:l}}u(s,"findNearestEnclosure");function o(i){const r=/^\((.*)\)$/,a=i.match(r),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,d=i.match(l);return a&&!d?`(${a[1]}:1.0)`:i}u(o,"addWeightToParentheses");function n(i){const r=i.composedPath()[0],a=parseFloat(t.value);if(r.tagName!=="TEXTAREA"||!(i.key==="ArrowUp"||i.key==="ArrowDown")||!i.ctrlKey&&!i.metaKey)return;i.preventDefault();let l=r.selectionStart,d=r.selectionEnd,c=r.value.substring(l,d);if(!c){const p=s(r.value,l);if(p)l=p.start,d=p.end,c=r.value.substring(l,d);else{const g=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!g.includes(r.value[l-1])&&l>0;)l--;for(;!g.includes(r.value[d])&&d<r.value.length;)d++;if(c=r.value.substring(l,d),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),d-=1),r.value[l-1]==="("&&r.value[d]===")"&&(l-=1,d+=1,c=r.value.substring(l,d)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=o(c);const h=i.key==="ArrowUp"?a:-a,m=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(p,g,y)=>(y=e(y,h),y==1?g:`(${g}:${y})`));r.setSelectionRange(l,d),document.execCommand("insertText",!1,m),r.setSelectionRange(l,l+m.length)}u(n,"editAttention"),window.addEventListener("keydown",n)}});const Io={validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},Ee=u(async t=>Wt(t)&&await pt().NetWork.canAccessUrl(t),"checkMirrorReachable");(async()=>{if(!Rt())return;const t=pt(),e=await t.getElectronVersion(),s=Ft(),o=S(),{staticUrls:n,buildDocsUrl:i}=Bt(),r=u((a,l)=>{l!==void 0&&a!==l&&t.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");f.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:r},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:r},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((a,l)=>{l&&t.Config.setWindowStyle(a)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(a){return Ee(a+Io.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:Ee}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:Ee}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){t.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){t.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){t.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){t.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){t.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){t.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){t.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(i("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const a=await t.checkForUpdates({disableUpdateReadyAction:!0});if(!a.isUpdateAvailable){o.add({severity:"info",summary:x("desktopUpdate.noUpdateFound"),life:5e3});return}if(await de().confirm({title:x("desktopUpdate.updateFoundTitle",{version:a.version}),message:x("desktopUpdate.updateAvailableMessage"),type:"default"}))try{t.restartAndInstall()}catch(d){Xe.error("Error installing update:",d),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(a){Xe.error("Error checking for updates:",a),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await de().confirm({message:x("desktopMenu.confirmReinstall"),title:x("desktopMenu.reinstall"),type:"reinstall"})&&t.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){t.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){s.modifiedWorkflows.length>0&&!await de().confirm({message:x("desktopMenu.confirmQuit"),title:x("desktopMenu.quit"),type:"default"})||t.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:n.githubElectron,icon:"pi pi-github"}]})})();const Ge=new Image;Ge.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='9' fill='none' stroke='oklch(83.01%25 0.163 83.16)' stroke-width='2'/%3E%3Cpath fill='none' stroke='oklch(83.01%25 0.163 83.16)' stroke-linecap='round' stroke-width='2' d='M12 7v5l3 2'/%3E%3C/svg%3E";const xo=u(()=>{function t(i){return i?i<1e3?`${Math.round(i)}ms`:`${(i/1e3).toFixed(2)}s`:"0ms"}u(t,"getExecutionTimeText");function e(i){return(typeof i=="function"?i():i).icon?.image===Ge}u(e,"isExecutionTimeBadge");const s=Ut();function o(i){const r=s.completedActivePalette.light_theme,a=t(i);return new zt({text:a,iconOptions:{image:Ge,size:8},fgColor:s.completedActivePalette.colors.litegraph_base.BADGE_FG_COLOR,bgColor:r?$t("#4A90D9",{lightness:.5}):"#4A90D9"})}u(o,"getExecutionTimeBadge");function n(i,r){i.badges||(i.badges=[]);const a=i.badges.findIndex(d=>e(d));if(r==null){a!==-1&&i.badges.splice(a,1);return}const l=o(r);a!==-1?i.badges[a]=l:i.badges.push(l)}return u(n,"updateOrAddExecutionTimeBadge"),{getExecutionTimeBadge:o,getExecutionTimeText:t,isExecutionTimeBadge:e,updateOrAddExecutionTimeBadge:n}},"useExecutionTimeBadge"),Ke="__comfy_execution_time__";H().registerExtension({name:"Comfy.ExecutionTime",async nodeCreated(t){t[Ke]=0,t.badges||(t.badges=[]);const e=xo();e.updateOrAddExecutionTimeBadge(t,0);const s=t.onExecuted;t.onExecuted=function(o){if(s?.call(this,o),!o||typeof o!="object")return;const n=o;`${this.id}`,Object.keys(n);let i;typeof n.execution_time=="number"?i=n.execution_time:typeof n.exec_time=="number"?i=n.exec_time:typeof n.time=="number"&&(i=n.time),i&&typeof i=="number"&&i>0&&(this[Ke]=i,e.updateOrAddExecutionTimeBadge(this,i),f.canvas?.setDirty(!0,!0))}}});class ko extends Vt{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,s,o,n,i){super(e,s,o,n),this.groupNodeHandler=i}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const s=this.node.getInputNode(e);if(!s)return;const o=this.node.getInputLink(e);if(!o)throw new Error("Failed to get input link");const n=String(s.id);let i=this.nodesByExecutionId?.get(n);if(!i){const r=n.split(":").at(-1);r!==void 0&&(i=this.nodesByExecutionId?.get(r))}if(!i)throw new Error(`Failed to get input node ${n} for group node child ${this.id} with slot ${e}`);return{node:i,origin_id:n,origin_slot:o.origin_slot}}}const Oe=Symbol();function St(t,e){if(typeof t=="object"&&typeof e=="object")for(const s in e){const o=e[s];if(typeof o=="object"){let n=t[s];n||(n=t[s]={}),St(n,e[s])}else t[s]=o}return t}u(St,"merge");class Mt extends jt{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=b("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,s){!s&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=I.registered_node_types[`${G}${P}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=z.getGroupData(this.groupNodeType)}changeGroup(e,s=!0){this.selectedGroup=e,this.getGroupData();const o=this.groupData.nodeData.nodes;if(this.nodeItems=o.map((i,r)=>b("li.draggable-item",{dataset:{nodeindex:i.index+""},onclick:u(()=>{this.changeNode(r)},"onclick")},[b("span.drag-handle"),b("div",{textContent:i.title??i.type},i.title?b("span",{textContent:i.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),s)this.selectedNodeIndex=null,this.changeNode(0);else{let r=this.draggable.getAllItems().findIndex(a=>a.classList.contains("selected"));r===-1&&(r=this.selectedNodeIndex),this.changeNode(r,!0)}const n=[...o];this.draggable?.dispose(),this.draggable=new Ht(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:i,newPosition:r}})=>{if(i!==r){n.splice(r,0,n.splice(i,1)[0]);for(let a=0;a<n.length;a++)this.storeModification({nodeIndex:n[a].index,section:Oe,prop:"order",value:a})}})}storeModification(e){const{nodeIndex:s,section:o,prop:n,value:i}=e,r=this.modifications[this.selectedGroup]??={},a=r.nodes??={},l=a[s??this.selectedNodeInnerIndex]??={},d=l[o]??={};if(typeof i=="object"){const c=d[n]??={};Object.assign(c,i)}else d[n]=i}getEditElement(e,s,o,n,i,r=!0){o===n&&(o="");const a=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[s];return a&&(a.name!=null&&(o=a.name),a.visible!=null&&(i=a.visible)),b("div",[b("input",{value:o,placeholder:n,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:s,value:{name:l.target.value}})},"onchange")}),b("label",{textContent:"Visible"},[b("input",{type:"checkbox",checked:i,disabled:!r,onchange:u(l=>{this.storeModification({section:e,prop:s,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],s=Object.keys(e??{}),n=f.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...s.map(i=>this.getEditElement("input",i,e[i],i,n?.[i]?.visible!==!1))),!!s.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],s=Object.keys(e??{}),n=f.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...s.map(i=>{let r=e[i];if(r)return this.getEditElement("input",i,r,i,n?.[i]?.visible!==!1)}).filter(Boolean)),!!s.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,s=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),o=s?.output??[],n=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],r=f.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...o.map((d,c)=>{const h=n?.[c],m=s.output_name?.[c]??d;let p=r?.[c]?.name;const g=r?.[c]?.visible||h!=null;return(!p||p===m)&&(p=""),this.getEditElement("output",c,p,m,g,l)}).filter(Boolean)),!!o.length}show(e){const s=Object.keys(f.rootGraph.extra?.groupNodes??{}).sort((i,r)=>i.localeCompare(r));this.innerNodesList=b("ul.comfy-group-manage-list-items"),this.widgetsPage=b("section.comfy-group-manage-node-page"),this.inputsPage=b("section.comfy-group-manage-node-page"),this.outputsPage=b("section.comfy-group-manage-node-page");const o=b("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((i,[r,a])=>(i[r]={tab:b("a",{onclick:u(()=>{this.changeTab(r)},"onclick"),textContent:r}),page:a},i),{});const n=b("div.comfy-group-manage-outer",[b("header",[b("h2","Group Nodes"),b("select",{onchange:u(i=>{this.changeGroup(i.target.value)},"onchange")},s.map(i=>b("option",{textContent:i,selected:`${G}${P}${i}`===e,value:i})))]),b("main",[b("section.comfy-group-manage-list",this.innerNodesList),b("section.comfy-group-manage-node",[b("header",Object.values(this.tabs).map(i=>i.tab)),o])]),b("footer",[b("button.comfy-btn",{onclick:u(()=>{if(f.rootGraph.nodes.find(r=>r.type===`${G}${P}`+this.selectedGroup)){S().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete f.rootGraph.extra.groupNodes[this.selectedGroup],I.unregisterNodeType(`${G}${P}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),b("button.comfy-btn",{onclick:u(async()=>{let i,r=[];const a={};for(const l in this.modifications){const d=f.rootGraph.extra.groupNodes[l];let c=d.config??={},h=this.modifications[l]?.nodes;if(h){const p=Object.keys(h);if(h[p[0]][Oe]){const g=[],y={},w={};for(const v of p){const N=h[v][Oe].order;g[N]=d.nodes[+v],y[N]=h[v],g[N].index=N}for(const v of d.links)v[0]!=null&&(v[0]=d.nodes[v[0]].index),v[2]!=null&&(v[2]=d.nodes[v[2]].index);if(d.external)for(const v of d.external)v[0]=d.nodes[v[0]];for(const v of p)c[v]&&(w[d.nodes[v].index]=c[v]),delete c[v];d.nodes=g,h=y,d.config=c=w}St(c,h)}a[l]=d,i||(i=f.rootGraph.nodes.reduce((p,g)=>(p[g.type]??=[],p[g.type].push(g),p),{}));const m=i[`${G}${P}`+l];m&&r.push(...m)}await oe.registerFromWorkflow(a,{});for(const l of r)l.recreate();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),b("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(n),this.changeGroup(e?s.find(i=>`${G}${P}${i}`===e)??s[0]:s[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=Mt;const _o=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),Je=u(t=>{const e=t.min??-1/0,s=t.max??1/0;return{min:e,max:s}},"getRange"),Do=u((t,e)=>{const s=t[0],o=t[1]??{},n=e[1]??{},i=Je(o),r=Je(n);if(i.min>r.max||i.max<r.min)return null;const a=o.step??1,l=n.step??1,d={min:Math.max(i.min,r.min),max:Math.min(i.max,r.max),step:Kt(a,l)};return Ue([s,{...o,...d}],[s,{...n,...d}])},"mergeNumericInputSpec"),To=u((t,e)=>{const s=t[1]??{},o=e[1]??{},n=Ye(t),i=Ye(e),r=X.intersection(n,i);return r.length===0?null:Ue(["COMBO",{...s,options:r}],["COMBO",{...o,options:r}])},"mergeComboInputSpec"),Ue=u((t,e)=>{const s=Pe(t),o=t[1]??{},n=e[1]??{};return X.union(X.keys(o),X.keys(n)).filter(a=>!_o.has(a)).every(a=>{const l=o[a],d=n[a];return l===d||X.isNil(l)&&X.isNil(d)})?[s,{...o,...n}]:null},"mergeCommonInputSpec"),So=u((t,e)=>{const s=Pe(t),o=Pe(e);return s!==o?null:Yt(t)||qt(t)?Do(t,e):Xt(t)?To(t,e):Ue(t,e)},"mergeInputSpec"),Mo=u(t=>t.type==="PrimitiveNode","isPrimitiveNode"),Le="Run widget replace on values";class We extends be{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(Le in this.properties))&&this.addProperty(Le,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const s=[...this.outputs[0].links.map(n=>this.graph.links[n]),...e];let o=this.widgets?.[0].value;o&&this.properties[Le]&&(o=gt(this.graph,o));for(const n of s){const i=this.graph?.getNodeById(n.target_id),r=i?.inputs[n.target_slot];if(!r){console.warn("Unable to resolve node or input for link",n);continue}const a=r.widget?.name;if(!a){console.warn("Invalid widget or widget name",r.widget);continue}const l=i.widgets?.find(d=>d.name===a);if(!l){console.warn(`Unable to find widget "${a}" on node [${i.id}]`);continue}l.value=o,l.callback?.(l.value,f.canvas,i,f.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[U]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const s=this.widgets[e];s&&(s.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,s,o){if(f.configuringGraph)return;const n=this.outputs[0].links;o?n?.length&&!this.widgets?.length&&this.#e():(this.#t(),n?.length||this.onLastDisconnect())}onConnectOutput(e,s,o,n,i){if(!o.widget&&!(o.type in $))return!1;if(this.outputs[e].links?.length){const r=this.#o(o);return r&&this.applyToGraph([{target_id:n.id,target_slot:i}]),r}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const s=this.outputs[0].links[0],o=this.graph.links[s];if(!o)return;const n=this.graph.getNodeById(o.target_id);if(!n||!n.inputs)return;const i=n.inputs[o.target_slot];if(!i)return;let r;if(i.widget)r=i.widget;else{if(!(i.type in $))return;r={name:i.name,[U]:()=>[i.type,{}]}}const a=r[U]?.();if(!a)return;const{type:l}=Oo(a);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=r,this.#i(r[ce]??a,n,r.name,e)}#i(e,s,o,n){let i=e[0];i instanceof Array&&(i="COMBO");const[r,a]=this.size;let l;if(Jt(i)?l=($[i](this,"value",e,f)||{}).widget:l=this.addWidget(i,"value",null,()=>{},{}),s?.widgets&&l){const c=s.widgets.find(h=>h.name===o);c&&(l.value=c.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),Qt(this,l,c,void 0,e),this.widgets?.[1]&&(l.linkedWidgets=[this.widgets[1]]);let h=this.widgets_values?.[2];h&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=h)}const d=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&d?.length===this.widgets.length-1)for(let c=0;c<d.length;c++)this.widgets[c+1].value=d[c];if(l.callback=te(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],r),Math.max(this.size[1],a)]),!n){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(s=>s.value);if(this.#n(),this.#e(!0),e?.length&&this.widgets)for(let s=0;s<this.widgets.length;s++)this.widgets[s].value=e[s];return this.widgets?.[0]}#t(){const e=this.outputs[0],s=e.links??[],o=!!e.widget?.[ce];if(o&&delete e.widget?.[ce],s?.length<2&&o){s.length&&this.recreateWidget();return}const n=e.widget?.[U]?.();if(!(!n||!(n[0]==="INT"||n[0]==="FLOAT")||!this.graph))for(const r of s){const a=this.graph.links[r];if(!a)continue;const l=this.graph.getNodeById(a.target_id);if(!l)continue;const d=l.inputs[a.target_slot];this.#o(d,o)}}#o(e,s){const o=this.outputs?.[0],n=e.widget?.[U]?.();return n?!!ye.call(this,o,n,s,this.recreateWidget):!1}#n(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#n()}}function ze(t){return t.widget?.[ce]??t.widget?.[U]?.()??["*",{}]}u(ze,"getWidgetConfig");function Qe(t){const{nodeData:e}=this.constructor;return e?.input?.required?.[t]??e?.input?.optional?.[t]}u(Qe,"getConfig");function Eo(t,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),t.inputs.find(s=>s.widget?.name===e.name)}u(Eo,"convertToInput");function Oo(t){let e=t[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(Oo,"getWidgetType");function Re(t,e){if(!t.widget||(e?t.widget[U]=()=>e:delete t.widget,!(t instanceof Zt)))return;const s=t.node.graph;if(!s)return;const o=s.links[t.link??-1];if(!o)return;const n=s.getNodeById(o.origin_id);!n||!Mo(n)||(e?n.recreateWidget():f.configuringGraph||(n.disconnectOutput(0),n.onLastDisconnect()))}u(Re,"setWidgetConfig");function ye(t,e,s,o,n){n||(n=ze(t));const i=So(n,e);if(i||s){i&&(t.widget[ce]=i);const r=o?.call(this);if(r){const a=r.options.min,l=r.options.max;a!=null&&r.value<a&&(r.value=a),l!=null&&r.value>l&&(r.value=l),r.callback(r.value)}}return{customConfig:i?.[1]??{}}}u(ye,"mergeIfValid");f.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(t,e,s){t.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},t.prototype.onGraphConfigured=te(t.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const n of this.inputs)if(n.widget){const i=n.widget.name;n.widget[U]||(n.widget[U]=()=>Qe.call(this,i)),this.widgets?.find(a=>a.name===i)||this.removeInput(this.inputs.findIndex(a=>a===n))}}}),t.prototype.onConfigure=te(t.prototype.onConfigure,function(){if(!s.configuringGraph&&this.inputs){for(const n of this.inputs)if(n.widget&&!n.widget[U]){const i=n.widget.name;n.widget[U]=()=>Qe.call(this,i)}}});const o=t.prototype.onInputDblClick;t.prototype.onInputDblClick=function(...[n,...i]){const r=o?.apply(this,[n,...i]),a=this.inputs[n];if(!a.widget&&!(a.type in $)&&!(a.widget?.[U]?.()?.[0]instanceof Array))return r;const l=I.createNode("PrimitiveNode"),d=s.canvas.graph;if(!l||!d)return r;d?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;d.getNodeOnPos(c[0],c[1],d.nodes);)c[1]+=I.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,n),l.title=a.name,r}},registerCustomNodes(){I.registerNodeType("PrimitiveNode",Object.assign(We,{title:"Primitive"})),We.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=We;window.comfyAPI.widgetInputs.getWidgetConfig=ze;window.comfyAPI.widgetInputs.convertToInput=Eo;window.comfyAPI.widgetInputs.setWidgetConfig=Re;window.comfyAPI.widgetInputs.mergeIfValid=ye;const ee={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(t){const e=`${G}${P}${t}`;return f.rootGraph.extra?.groupNodes?.[t]?f.rootGraph.nodes.find(s=>s.type===e)?ee.InUse.InWorkflow:ee.InUse.Registered:ee.InUse.Free},storeGroupNode(t,e){let s=f.rootGraph.extra;s||(f.rootGraph.extra=s={});let o=s.groupNodes;o||(s.groupNodes=o={}),o[t]=e}};class Ze{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),ee.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await de().prompt({title:x("groupNode.create"),message:x("groupNode.enterName"),defaultValue:""});if(!e)return;switch(ee.isInUseGroupNode(e)){case ee.InUse.InWorkflow:S().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case ee.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=f.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(s=>({index:e.indexOf(s),node:s})).sort((s,o)=>s.index-o.index||s.node.id-o.node.id).map(({node:s})=>s)}getNodeData(){const e=u(o=>{for(const n of o.links){const r=f.rootGraph.getNodeById(n[4]).outputs[n[1]].type;n.push(r)}},"storeLinkTypes"),s=u(o=>{o.external=[];for(let n=0;n<this.nodes.length;n++){const i=this.nodes[n];if(i.outputs?.length)for(let r=0;r<i.outputs.length;r++){let a=!1;const l=i.outputs[r];let d=l.type;if(l.links?.length){for(const c of l.links){const h=f.rootGraph.links[c];if(h&&(d==="*"&&(d=h.type),!f.canvas.selected_nodes[h.target_id])){a=!0;break}}a&&o.external.push([n,r,d])}}}},"storeExternalLinks");{const o=oo(this.nodes,f.canvas?.graph),n=JSON.parse(o);return e(n),s(n),n}}}class oe{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,s){this.name=e,this.nodeData=s,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=G){this.nodeDef={output:[],output_name:[],output_is_list:[],output_node:!1,name:e+P+this.name,display_name:this.name,category:"group nodes"+(P+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(n=>n.type).join(", ")}`,python_module:"custom_nodes."+this.name,[R]:this},this.inputs=[];const s={},o={};for(let n=0;n<this.nodeData.nodes.length;n++){const i=this.nodeData.nodes[n];i.index=n,this.processNode(i,s,o)}for(const n of this.#e)n();this.#e=null,this.nodeDef&&(await f.registerNodeDef(`${G}${P}`+this.name,this.nodeDef),eo().addNodeDef(this.nodeDef))}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[s,o,n,i]=e;s!=null&&(this.linksFrom[s]||(this.linksFrom[s]={}),this.linksFrom[s][o]||(this.linksFrom[s][o]=[]),this.linksFrom[s][o].push(e),this.linksTo[n]||(this.linksTo[n]={}),this.linksTo[n][i]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,s,o){const n=this.getNodeDef(e);if(!n)return;const i={...n.input?.required,...n.input?.optional};this.inputs.push(this.processNodeInputs(e,s,i)),n.output?.length&&this.processNodeOutputs(e,o,n)}getNodeDef(e){const s=ue[e.type];if(s)return s;const o=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!o)return;let n=o[0][0][5];if(n==="COMBO"){const r=e.outputs[0].widget.name,a=this.nodeData.nodes[o[0][0][2]].type,l=ue[a];n=(l.input.required[r]??l.input.optional[r])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[n,{}]}},output:[n],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const n=this.linksTo[e.index];if(n&&o&&!this.externalFrom[e.index]?.[0])return null;let i={},r="*";if(o)for(const[,,a,l]of o[0]){const d=this.nodeData.nodes[a],c=d.inputs[l];if(r==="*"&&(r=c.type),c.widget){const h=ue[d.type],m=h.input.required[c.widget.name]??h.input.optional[c.widget.name],p=[m[0],i];i=ye({widget:p},m,!1,null,p)?.customConfig??i}}else if(n){const[a,l]=n[0];r=this.nodeData.nodes[a].outputs[l].type}else{for(const a of this.nodeData.links)if(a[2]===e.index){r=a[5];break}if(r==="*"){const a=this.externalFrom[e.index]?.[0];a&&(r=a)}}return i.forceInput=!0,{input:{required:{[r]:[r,i]}},output:[r],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,s,o,n,i){const r=this.nodeData.config?.[e.index]?.input?.[s];let a=r?.name??e.inputs?.find(c=>c.name===s)?.label??s,l=a,d="";return(e.type==="PrimitiveNode"&&e.title||a in o)&&(d=`${e.title??e.type} `,l=a=`${d}${s}`,a in o&&(a=`${d}${o[a]} ${s}`)),o[l]=(o[l]??1)+1,(s==="seed"||s==="noise_seed")&&(i||(i={}),i.control_after_generate=`${d}control_after_generate`),n[0]==="IMAGEUPLOAD"&&(i||(i={}),i.widget=this.oldToNewWidgetMap[e.index]?.[n[1]?.widget??"image"]??"image"),i&&(n=[n[0],{...n[1],...i}]),{name:a,config:n,customConfig:r}}processWidgetInputs(e,s,o,n){const i=[],r=new Map,a=this.oldToNewWidgetMap[s.index]={};for(const l of o)if(to().inputIsWidget(e[l])){const d=s.inputs?.findIndex(c=>c.name===l&&c.widget?.name===l);if(d>-1)r.set(d,l),a[l]=null;else{const{name:c,config:h}=this.getInputConfig(s,l,n,e[l]);this.nodeDef.input.required[c]=h,a[l]=c,this.newToOldWidgetMap[c]={node:s,inputName:l}}}else i.push(l);return{converted:r,slots:i}}checkPrimitiveConnection(e,s,o){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[i,r,a,l]=e,d=this.primitiveDefs[i],c=o[s],h=d.input.required.value,p=ye({widget:h},c,!1,null,h);h[1]=p?.customConfig??o[s][1]?{...o[s][1]}:{};let g=this.oldToNewWidgetMap[i].value;g=g.substr(0,g.length-6),h[1].control_after_generate=!0,h[1].control_prefix=g;let y=this.widgetToPrimitive[a];y||(y=this.widgetToPrimitive[a]={}),y[s]&&y[s].push(i),y[s]=i;let w=this.primitiveToWidget[i];w||(w=this.primitiveToWidget[i]=[]),w.push({nodeId:a,inputName:s})}}processInputSlots(e,s,o,n,i,r){this.nodeInputs[s.index]={};for(let a=0;a<o.length;a++){const l=o[a];if(n[a]){this.checkPrimitiveConnection(n[a],l,e);continue}const{name:d,config:c,customConfig:h}=this.getInputConfig(s,l,r,e[l]);this.nodeInputs[s.index][l]=d,h?.visible!==!1&&(this.nodeDef.input.required[d]=c,i[a]=this.inputCount++)}}processConvertedWidgets(e,s,o,n,i,r,a){const l=[...n.keys()].sort().map(d=>n.get(d));for(let d=0;d<l.length;d++){const c=l[d];if(i[o.length+d]){this.checkPrimitiveConnection(i[o.length+d],c,e);continue}const{name:h,config:m}=this.getInputConfig(s,c,a,e[c],{defaultInput:!0});this.nodeDef.input.required[h]=m,this.newToOldWidgetMap[h]={node:s,inputName:c},this.oldToNewWidgetMap[s.index]||(this.oldToNewWidgetMap[s.index]={}),this.oldToNewWidgetMap[s.index][c]=h,r[o.length+d]=this.inputCount++}}#e=[];processNodeInputs(e,s,o){const n=[],i=Object.keys(o);if(!i.length)return;const{converted:r,slots:a}=this.processWidgetInputs(o,e,i,s),l=this.linksTo[e.index]??{},d=this.oldToNewInputMap[e.index]={};return this.processInputSlots(o,e,a,l,d,s),this.#e.push(()=>this.processConvertedWidgets(o,e,a,r,l,d,s)),n}processNodeOutputs(e,s,o){const n=this.oldToNewOutputMap[e.index]={};for(let i=0;i<o.output.length;i++){const a=this.linksFrom[e.index]?.[i]&&!this.externalFrom[e.index]?.[i],l=this.nodeData.config?.[e.index]?.output?.[i],d=l?.visible??!a;if(this.outputVisibility.push(d),!d)continue;n[i]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:i},this.nodeDef.output.push(o.output[i]),this.nodeDef.output_is_list.push(o.output_is_list[i]);let c=l?.name;if(!c){c=o.output_name?.[i]??o.output[i];const m=e.outputs.find(p=>p.name===c);m?.label&&(c=m.label)}let h=c;if(h in s){const m=`${e.title??e.type} `;h=`${m}${c}`,h in s&&(h=`${m}${e.index} ${c}`)}s[h]=1,this.nodeDef.output_name.push(h)}}static async registerFromWorkflow(e,s){for(const o in e){const n=e[o];let i=!1;for(const a of n.nodes)a.type in I.registered_node_types||(s.push({type:a.type,hint:` (In group node '${G}${P}${o}')`}),s.push({type:`${G}${P}`+o,action:{text:"Remove from workflow",callback:u(l=>{delete e[o],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),i=!0);if(i)continue;await new oe(o,n).registerType()}}}class z{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[R],this.node.setInnerNodes=p=>{this.innerNodes=p;for(let g=0;g<this.innerNodes.length;g++){const y=this.innerNodes[g];y.graph??=this.node.graph;for(const w of y.widgets??[])w.type==="converted-widget"&&(w.serializeValue=w.origSerializeValue);y.index=g,y.getInputNode=w=>{const v=this.groupData.oldToNewInputMap[y.index]?.[w];if(v!=null)return this.node.getInputNode(v);const N=this.groupData.linksTo[y.index]?.[w];if(!N)return null;const C=p[N[0]];return C.type==="PrimitiveNode"?null:C},y.getInputLink=w=>{const v=this.groupData.oldToNewInputMap[y.index]?.[w];if(v!=null){const C=this.node.inputs[v].link;let k=f.rootGraph.links[C];return k={...k,target_id:y.id,target_slot:+w},k}let N=this.groupData.linksTo[y.index]?.[w];return N?(N={origin_id:p[N[0]].id,origin_slot:N[1],target_id:y.id,target_slot:+w},N):null}}},this.node.updateLink=p=>{p={...p};const g=this.groupData.newToOldOutputMap[p.origin_slot];let y=this.innerNodes[g.node.index],w;for(;y?.type==="Reroute";)w=y.getInputLink(0),y=y.getInputNode(0);return y?w&&z.isGroupNode(y)?y.updateLink(w):(p.origin_id=y.id,p.origin_slot=w?.origin_slot??g.slot,p):null},this.node.getInnerNodes=(p,g=[],y=[],w=new Set)=>{if(w.has(this.node))throw new Error("RecursionError: while flattening subgraph");w.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((C,k)=>{const _=I.createNode(C.type);return _.configure(C),_.id=`${this.node.id}:${k}`,_.graph=this.node.graph,_})),this.updateInnerWidgets();const v=[...g,this.node.id],N=this.node.graph?.getNodeById(g.at(-1))??void 0;for(const C of this.innerNodes){C.graph??=this.node.graph;const k=String(C.id);C.id=k.split(":").at(-1);const _=new ko(C,v,p,N);C.id=k,_.groupNodeHandler=this,y.push(_)}return y},this.node.recreate=async()=>{const p=this.node.id,g=this.node.size,y=this.node.convertToNodes(),w=I.createNode(this.node.type);w.id=p,w.setInnerNodes(y),w[R].populateWidgets(),f.rootGraph.add(w),w.setSize([Math.max(w.size[0],g[0]),Math.max(w.size[1],g[1])]);const N=new Ze(y).getNodeData();return w[R].groupData.nodeData.links=N.links,w[R].replaceNodes(y),w},this.node.convertToNodes=()=>{const p=u(()=>{const w={...this.groupData.nodeData};w.nodes=[...w.nodes];const v=this.node.getInnerNodes();let N=[];for(let L=0;L<w.nodes.length;L++){let ne=v?.[L]?.id;ne==null||isNaN(ne)?ne=void 0:N.push(ne),w.nodes[L]={...w.nodes[L],id:ne}}ht(JSON.stringify(w),f.canvas);const[C,k]=this.node.pos;let _,D;const O=N.length?N:Object.keys(f.canvas.selected_nodes),q=[];for(let L=0;L<O.length;L++){const ne=O[L],Y=f.rootGraph.getNodeById(ne),Ve=v[L];if(q.push(Y),(D==null||Y.pos[0]<D)&&(D=Y.pos[0]),(_==null||Y.pos[1]<_)&&(_=Y.pos[1]),!Y.widgets)continue;const _e=this.groupData.oldToNewWidgetMap[Ve.index];if(_e){const Lt=Object.keys(_e);for(const je of Lt){const He=_e[je];if(!He)continue;const De=this.node.widgets.findIndex(V=>V.name===He);if(De!==-1)if(Ve.type==="PrimitiveNode")for(let V=0;V<Y.widgets.length;V++)Y.widgets[V].value=this.node.widgets[De+V].value;else{const V=this.node.widgets[De],Te=Y.widgets.find(ie=>ie.name===je);if(!Te)continue;Te.value=V.value;for(let ie=0;ie<V.linkedWidgets?.length;ie++)Te.linkedWidgets[ie].value=V.linkedWidgets[ie].value}}}}for(const L of q)L.pos[0]-=D-C,L.pos[1]-=_-k;return{newNodes:q,selectedIds:O}},"addInnerNodes"),g=u(w=>{for(const v in this.groupData.oldToNewInputMap){const N=w[v],C=f.rootGraph.getNodeById(N),k=this.groupData.oldToNewInputMap[v];for(const _ in k){const D=k[_];if(D==null)continue;const O=e.inputs[D];if(O.link==null)continue;const q=f.rootGraph.links[O.link];if(!q)continue;f.rootGraph.getNodeById(q.origin_id).connect(q.origin_slot,C,+_)}}},"reconnectInputs"),y=u(w=>{for(let v=0;v<e.outputs?.length;v++){const N=e.outputs[v];if(!N.links)continue;const C=[...N.links];for(const k of C){const _=this.groupData.newToOldOutputMap[v],D=f.rootGraph.links[k],O=f.rootGraph.getNodeById(D.target_id);f.rootGraph.getNodeById(w[_.node.index]).connect(_.slot,O,D.target_slot)}}},"reconnectOutputs");f.canvas.emitBeforeChange();try{const{newNodes:w,selectedIds:v}=p();return g(v),y(v),f.rootGraph.remove(this.node),w}finally{f.canvas.emitAfterChange()}};const s=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(p,g){s?.apply(this,arguments);let y=g.findIndex(w=>w?.content==="Outputs");y===-1?y=g.length:y++,g.splice(y,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Fe(this.type),"callback")})};const o=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(p,g){o?.apply(this,arguments);const y=p.fillStyle;p.beginPath(),p.rect(11,-g+11,2,2),p.rect(14,-g+11,2,2),p.rect(17,-g+11,2,2),p.rect(11,-g+14,2,2),p.rect(14,-g+14,2,2),p.rect(17,-g+14,2,2),p.rect(11,-g+17,2,2),p.rect(14,-g+17,2,2),p.rect(17,-g+17,2,2),p.fillStyle=this.boxcolor||I.NODE_DEFAULT_BOXCOLOR,p.fill(),p.fillStyle=y};const n=e.onDrawForeground,i=this.groupData.nodeData;e.onDrawForeground=function(p){n?.apply?.(this,arguments);const g=ft().nodeProgressStates[this.id];if(g&&g.state==="running"&&this.runningInternalNodeId!==null){const y=i.nodes[this.runningInternalNodeId];if(!y)return;const w=`Running ${y.title||y.type} (${this.runningInternalNodeId}/${i.nodes.length})`;p.save(),p.font="12px sans-serif";const v=p.measureText(w);p.fillStyle=e.boxcolor||I.NODE_DEFAULT_BOXCOLOR,p.beginPath(),p.roundRect(0,-I.NODE_TITLE_HEIGHT-20,v.width+12,20,5),p.fill(),p.fillStyle="#fff",p.fillText(w,6,-I.NODE_TITLE_HEIGHT-6),p.restore()}};const r=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,r?.apply(this,arguments)};const a=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const p=a.groupData.nodeData.config;if(p)for(const g in p){const y=p[g]?.input;for(const w in y){if(y[w].visible!==!1)continue;const v=a.groupData.oldToNewWidgetMap[g][w],N=this.widgets.find(C=>C.name===v);N&&(N.type="hidden",N.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function d(p,g,y){const w=u(({detail:v})=>{const N=g(v);if(!N||f.rootGraph.getNodeById(N))return;const k=this.innerNodes?.findIndex(_=>_.id==N);k>-1&&(this.node.runningInternalNodeId=k,E.dispatchCustomEvent(p,y(v,`${this.node.id}`,this.node)))},"handler");return E.addEventListener(p,w),w}u(d,"handleEvent");const c=d.call(this,"executing",p=>p,(p,g)=>g),h=d.call(this,"executed",p=>p?.display_node||p?.node,(p,g,y)=>({...p,node:g,display_node:g,merge:!y.resetExecution})),m=e.onRemoved;this.node.onRemoved=function(){m?.apply(this,arguments),E.removeEventListener("executing",c),E.removeEventListener("executed",h)},this.node.refreshComboInNode=p=>{for(const g in this.groupData.newToOldWidgetMap){const y=this.node.widgets.find(w=>w.name===g);if(y?.type==="combo"){const w=this.groupData.newToOldWidgetMap[g],v=p[w.node.type],N=v?.input?.required?.[w.inputName]??v?.input?.optional?.[w.inputName];if(!N)continue;y.options.values=N[0],w.inputName!=="image"&&!y.options.values.includes(y.value)&&(y.value=y.options.values[0],y.callback(y.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const s=this.node.widgets.find(a=>a.name===e);if(!s)continue;const o=s.value,n=this.groupData.newToOldWidgetMap[e];let i=this.innerNodes[n.node.index];if(i.type==="PrimitiveNode"){i.primitiveValue=o;const a=this.groupData.primitiveToWidget[n.node.index];for(const l of a??[]){const c=this.innerNodes[l.nodeId].widgets.find(h=>h.name===l.inputName);c&&(c.value=o)}continue}else if(i.type==="Reroute"){const a=this.groupData.linksFrom[n.node.index];if(a)for(const[l,,d,c]of a[0]){const h=this.innerNodes[d],m=h.inputs[c];if(m.widget){const p=h.widgets?.find(g=>g.name===m.widget.name);p&&(p.value=o)}}}const r=i.widgets?.find(a=>a.name===n.inputName);r&&(r.value=o)}}populatePrimitive(e,s,o){const n=this.groupData.widgetToPrimitive[s]?.[o];if(n==null)return;const i=this.groupData.oldToNewWidgetMap[n].value,r=this.node.widgets.findIndex(a=>a.name===i);if(r>-1){const a=this.innerNodes[n];let l=a.widgets.length;l-1!==this.node.widgets[r].linkedWidgets?.length&&(l=1);for(let d=0;d<l;d++)this.node.widgets[r+d].value=a.widgets[d].value}return!0}populateReroute(e,s,o){if(e.type!=="Reroute")return;const n=this.groupData.linksFrom[s]?.[0]?.[0];if(!n)return;const[,,i,r]=n,a=this.groupData.nodeData.nodes[i],l=a.inputs;if(!l?.[r]?.widget)return;const c=l.length-(a.widgets_values?.length??0),h=a.widgets_values?.[r-c];if(h==null)return;const m=Object.values(o)[0],p=this.node.widgets.find(g=>g.name===m);p&&(p.value=h)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const s=this.groupData.nodeData.nodes[e],o=this.groupData.oldToNewWidgetMap[e]??{},n=Object.keys(o);if(!s.widgets_values?.length){this.populateReroute(s,e,o);continue}let i=0;for(let r=0;r<n.length;r++){const a=n[r],l=o[a],d=this.node.widgets.findIndex(h=>h.name===l),c=this.node.widgets[d];if(this.populatePrimitive(s,e,a)||d===-1){const h=this.innerNodes[e].widgets?.find(m=>m.name===a);i+=h?.linkedWidgets?.length??0}if(d!==-1){c.value=s.widgets_values[r+i];for(let h=0;h<c.linkedWidgets?.length;h++)this.node.widgets[d+h+1].value=s.widgets_values[r+ ++i]}}}}replaceNodes(e){let s,o;for(let n=0;n<e.length;n++){const i=e[n];(o==null||i.pos[0]<o)&&(o=i.pos[0]),(s==null||i.pos[1]<s)&&(s=i.pos[1]),this.linkOutputs(i,n),f.rootGraph.remove(i),i.id=`${this.node.id}:${n}`}this.linkInputs(),this.node.pos=[o,s]}linkOutputs(e,s){if(e.outputs)for(const o of e.outputs){if(!o.links)continue;const n=[...o.links];for(const i of n){const r=f.rootGraph.links[i];if(!r)continue;const a=f.rootGraph.getNodeById(r.target_id),l=this.groupData.oldToNewOutputMap[s]?.[r.origin_slot];l!=null&&this.node.connect(l,a,r.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,s,o,n,i]=e,r=f.rootGraph.getNodeById(i);r&&r.connect(s,this.node.id,this.groupData.oldToNewInputMap[o][n])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[R]}static isGroupNode(e){return!!e.constructor?.nodeData?.[R]}static async fromNodes(e){const s=new Ze(e),o=await s.build();if(!o)return;const{name:n,nodeData:i}=o;await new oe(n,i).registerType();const a=I.createNode(`${G}${P}${n}`);return a.setInnerNodes(s.nodes),a[R].populateWidgets(),f.rootGraph.add(a),a[R].replaceNodes(s.nodes),a}}const Lo=u(t=>{for(const e of t)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${G}${P}`))},"replaceLegacySeparators");async function Ae(){const t=Object.values(f.canvas.selected_nodes??{});if(t.length===0)throw new Error("No nodes selected");if(t.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of t){if(e instanceof no)throw new Error("Selected nodes contain a subgraph node");if(z.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await z.fromNodes(t)}u(Ae,"convertSelectedNodesToGroupNode");const et=u(t=>t.length<2||!!t.find(e=>z.isGroupNode(e)),"convertDisabled");function Ao(){const t=Object.values(f.canvas.selected_nodes??{});for(const e of t)z.isGroupNode(e)&&e.convertToNodes?.()}u(Ao,"ungroupSelectedGroupNodes");function Fe(t){new Mt(f).show(t)}u(Fe,"manageGroupNodes");const Po="Comfy.GroupNode";let ue;const Go={name:Po,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>Ae(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>Ao(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...t)=>Fe(t[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(t){const e=[],s=Object.values(t.selected_nodes??{}),o=!et(s);e.push({content:"Convert to Group Node (Deprecated)",disabled:!o,callback:u(()=>Ae(),"callback")});const n=t.graph?.extra?.groupNodes,i=!n||!Object.keys(n).length;return e.push({content:"Manage Group Nodes",disabled:i,callback:u(()=>Fe(),"callback")}),e},getNodeMenuItems(t){if(z.isGroupNode(t))return[];const e=Object.values(f.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!et(e),callback:u(()=>Ae(),"callback")}]},async beforeConfigureGraph(t,e){const s=t?.extra?.groupNodes;s&&(Lo(t.nodes),await oe.registerFromWorkflow(s,e))},addCustomNodeDefs(t){ue=t},nodeCreated(t){z.isGroupNode(t)&&(t[R]=new z(t),t.title&&t[R]?.groupData?.nodeData&&ee.storeGroupNode(t.title,t[R].groupData.nodeData))},async refreshComboInNodes(t){Object.assign(ue,t);const e=f.rootGraph.extra?.groupNodes;e&&await oe.registerFromWorkflow(e,{})}};f.registerExtension(Go);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=oe;window.comfyAPI.groupNode.GroupNodeHandler=z;function W(t,e){t.mode=e,t.graph?.change()}u(W,"setNodeMode");function tt(t,e){const s=ae().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo([...t.children,...e],s)}u(tt,"addNodesToGroup");const Wo={name:"Comfy.GroupOptions",getCanvasMenuItems(t){const e=[],s=t.graph.getGroupOnPos(t.graph_mouse[0],t.graph_mouse[1]);if(!s)return t.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const i=new io;tt(i,t.selectedItems),t.graph.add(i),t.graph.change(),i.recomputeInsideNodes()},"callback")}),e;s.recomputeInsideNodes();const o=s.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!t.selectedItems?.size,callback:u(()=>{tt(s,t.selectedItems),t.graph.change()},"callback")}),o.length===0)return e;e.push(null);let n=!0;for(let i=1;i<o.length;i++)if(o[i].mode!==o[0].mode){n=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{s.recomputeInsideNodes();const i=ae().get("Comfy.GroupSelectedNodes.Padding");s.resizeTo(s.children,i),t.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{t.selectNodes(o),t.graph.change(),t.canvas.focus()},"callback")}),n)switch(o[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of o)W(r,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of o)W(r,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of o)W(r,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of o)W(r,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of o)W(r,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of o)W(r,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of o)W(r,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of o)W(r,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of o)W(r,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const i of o)W(i,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const i of o)W(i,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const i of o)W(i,4)},"callback")});return e}};f.registerExtension(Wo);H().registerExtension({name:"Comfy.HighlightRunningNodes",async init(){const t=ft();yo(()=>t.executingNodeIds,e=>{if(!(!f.canvas||!f.canvas.graph)&&(f.canvas.selectNodes([]),e.length>0)){const s=[];for(const o of e){const n=f.canvas.graph.getNodeById(o);n&&s.push(n)}s.length>0&&f.canvas.selectNodes(s)}},{immediate:!0})}});H().registerExtension({name:"Comfy.ImageCompare",async nodeCreated(t){if(t.constructor.comfyClass!=="ImageCompare")return;const[e,s]=t.size;t.setSize([Math.max(e,400),Math.max(s,350)]);const o=t.onExecuted;t.onExecuted=function(n){o?.call(this,n);const i=n.a_images,r=n.b_images,a=f.getRandParam(),l=i&&i.length>0?E.apiURL(`/view?${new URLSearchParams(i[0])}${a}`):"",d=r&&r.length>0?E.apiURL(`/view?${new URLSearchParams(r[0])}${a}`):"",c=t.widgets?.find(h=>h.type==="imagecompare");c&&(c.value={before:l,after:d},c.callback?.(c.value))}}});const Ro=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function ke(t){return[null,{content:"Save",has_submenu:!0,callback:u((e,s,o,n)=>{const i=Ro.map(r=>({content:r.label,callback:u(()=>{(async()=>{try{await t.exportModel(r.value),S().add({severity:"success",summary:x("toastMessages.exportSuccess",{format:r.label})})}catch(a){console.error("Export failed:",a),S().addAlert(x("toastMessages.failedToExportModel",{format:r.label}))}})()},"callback")}));new I.ContextMenu(i,{event:o,parentMenu:n})},"callback")}]}u(ke,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=ke;class $e{static{u(this,"Load3DConfiguration")}constructor(e,s){this.load3d=e,this.properties=s}configureForSaveMesh(e,s){this.setupModelHandlingForSaveMesh(s,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,s){e&&s&&(this.load3d.setTargetSize(e.value,s.value),e.callback=o=>{this.load3d.setTargetSize(o,s.value)},s.callback=o=>{this.load3d.setTargetSize(e.value,o)})}setupModelHandlingForSaveMesh(e,s){const o=this.createModelUpdateHandler(s);e&&o(e)}setupModelHandling(e,s,o){const n=this.createModelUpdateHandler(s,o);e.value&&n(e.value);const i=e.callback;let r=e.value;Object.defineProperty(e,"value",{get(){return r},set(a){r=a,e.callback&&a!==void 0&&a!==""&&e.callback(a)},enumerable:!0,configurable:!0}),e.callback=a=>{n(a),i&&i(a)}}setupDefaultProperties(e){const s=this.loadSceneConfig();this.applySceneConfig(s,e);const o=this.loadCameraConfig();this.applyCameraConfig(o);const n=this.loadLightConfig();this.applyLightConfig(n)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:ae().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+ae().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:ae().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:ae().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original",showSkeleton:!1}}applySceneConfig(e,s){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(s&&s!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,s){let o=!0;return async n=>{if(!n)return;const i=n;this.setResourceFolder(i);const r=E.apiURL(j.getResourceURL(...j.splitFilePath(i),e));await this.load3d.loadModel(r,i);const a=this.loadModelConfig();if(this.applyModelConfig(a),o&&s){try{this.load3d.setCameraState(s)}catch(l){console.warn("Failed to restore camera state:",l)}o=!1}}}setResourceFolder(e){const s=e.split("/").filter(i=>i.trim());if(s.length<=2)return;const n=s.slice(1,-1).join("/");n&&this.properties&&(this.properties["Resource Folder"]=n)}}const Fo={name:"image",type:"Load3D",isPreview:!1},ot={name:"image",type:"Preview3D",isPreview:!0};async function Bo(t,e){if(!t?.length)return;const s=e.widgets?.find(o=>o.name==="model_file");try{const o=e.properties["Resource Folder"]||"",n=o.trim()?`3d/${o.trim()}`:"3d",i=await j.uploadFile(t[0],n);if(!i){S().addAlert(x("toastMessages.fileUploadFailed"));return}const r=E.apiURL(j.getResourceURL(...j.splitFilePath(i),"input"));fe(e).waitForLoad3d(a=>{try{a.loadModel(r)}catch{S().addAlert(x("toastMessages.failedToLoadModel"))}}),i&&s&&(s.options?.values?.includes(i)||s.options?.values?.push(i),s.value=i)}catch(o){console.error("Model upload failed:",o),S().addAlert(x("toastMessages.fileUploadFailed"))}}u(Bo,"handleModelUpload");async function Uo(t,e){if(t?.length)try{const s=e.properties["Resource Folder"]||"",o=s.trim()?`3d/${s.trim()}`:"3d";await j.uploadMultipleFiles(t,o)}catch(s){console.error("Extra resources upload failed:",s),S().addAlert(x("toastMessages.extraResourcesUploadFailed"))}}u(Uo,"handleResourcesUpload");function nt(t,e=!1){const s=document.createElement("input");return s.type="file",s.accept=t,s.multiple=e,s.style.display="none",s}u(nt,"createFileInput");H().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0},{id:"Comfy.Load3D.PLYEngine",category:["3D","PLY","PLY Engine"],name:"PLY Engine",tooltip:'Select the engine for loading PLY files. "threejs" uses the native Three.js PLYLoader (best for mesh PLY files). "fastply" uses an optimized loader for ASCII point cloud PLY files. "sparkjs" uses Spark.js for 3D Gaussian Splatting PLY files.',type:"combo",options:["threejs","fastply","sparkjs"],defaultValue:"threejs",experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const t=f.canvas.selected_nodes;if(!t||Object.keys(t).length!==1)return;const e=t[Object.keys(t)[0]];if(!ro(e))return;T.copyToClipspace(e),T.clipspace_return_node=e;const s={node:e};mt().showDialog({key:"global-load3d-viewer",title:x("load3d.viewer.title"),component:ao,props:s,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await Ne().handleViewerClose(s.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(t){const e=nt(".gltf,.glb,.obj,.fbx,.stl,.ply,.spz,.splat,.ksplat",!1);t.properties["Resource Folder"]="",e.onchange=async()=>{await Bo(e.files,t)},t.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const s=nt("*",!0);s.onchange=async()=>{await Uo(s.files,t),s.value=""},t.addWidget("button","upload extra resources","uploadExtraResources",()=>{s.click()}),t.addWidget("button","clear","clear",()=>{fe(t).waitForLoad3d(i=>{i.clearModel()});const n=t.widgets?.find(i=>i.name==="model_file");n&&(n.value="")});const o=new he({node:t,name:"image",component:Be,inputSpec:Fo,options:{}});return o.type="load3D",me(t,o),{widget:o}}}},getNodeMenuItems(t){if(t.constructor.comfyClass!=="Load3D")return[];const e=Ne().getLoad3d(t);return e?e.isSplatModel()?[]:ke(e):[]},async nodeCreated(t){if(t.constructor.comfyClass!=="Load3D")return;const[e,s]=t.size;t.setSize([Math.max(e,300),Math.max(s,600)]),await xe(),fe(t).waitForLoad3d(o=>{const i=t.properties["Camera Config"]?.state,r=new $e(o,t.properties),a=t.widgets?.find(h=>h.name==="model_file"),l=t.widgets?.find(h=>h.name==="width"),d=t.widgets?.find(h=>h.name==="height"),c=t.widgets?.find(h=>h.name==="image");if(a&&l&&d&&c){const h={loadFolder:"input",modelWidget:a,cameraState:i,width:l,height:d};r.configure(h),c.serializeValue=async()=>{const m=so.get(t);if(!m)return console.error("No load3d instance found for node"),null;const p=t.properties["Camera Config"]||{cameraType:m.getCurrentCameraType(),fov:m.cameraManager.perspectiveCamera.fov};p.state=m.getCameraState(),t.properties["Camera Config"]=p,m.stopRecording();const{scene:g,mask:y,normal:w}=await m.captureScene(l.value,d.value),[v,N,C]=await Promise.all([j.uploadTempImage(g,"scene"),j.uploadTempImage(y,"scene_mask"),j.uploadTempImage(w,"scene_normal")]);m.handleResize();const k={image:`threed/${v.name} [temp]`,mask:`threed/${N.name} [temp]`,normal:`threed/${C.name} [temp]`,camera_info:t.properties["Camera Config"]?.state||null,recording:""},_=m.getRecordingData();if(_){const[D]=await Promise.all([j.uploadTempImage(_,"recording","mp4")]);k.recording=`threed/${D.name} [temp]`}return k}}})}});H().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(t,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(t){if(t.constructor.comfyClass!=="Preview3D")return[];const e=Ne().getLoad3d(t);return e?e.isSplatModel()?[]:ke(e):[]},getCustomWidgets(){return{PREVIEW_3D(t){const e=new he({node:t,name:ot.name,component:Be,inputSpec:ot,options:{}});return e.type="load3D",me(t,e),{widget:e}}}},async nodeCreated(t){if(t.constructor.comfyClass!=="Preview3D")return;const[e,s]=t.size;t.setSize([Math.max(e,400),Math.max(s,550)]),await xe();const o=t.onExecuted;fe(t).waitForLoad3d(n=>{const i=new $e(n,t.properties),r=t.widgets?.find(a=>a.name==="model_file");if(r){const a=t.properties["Last Time Model File"];if(a){r.value=a;const d=t.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:r,cameraState:d};i.configure(c)}t.onExecuted=function(l){o?.apply(this,arguments);let d=l.result[0];if(!d){const p=x("toastMessages.unableToGetModelFilePath");console.error(p),S().addAlert(p)}let c=l.result[1],h=l.result[2];r.value=d.replaceAll("\\","/"),t.properties["Last Time Model File"]=r.value;const m={loadFolder:"output",modelWidget:r,cameraState:c,bgImagePath:h};i.configure(m),h&&n.setBackgroundImage(h)}}})}});const zo={class:"flex items-center justify-between mb-2"},$o={class:"font-medium"},Vo={class:"text-xs text-gray-400"},jo={class:"space-y-2"},Ho={key:0,class:"text-sm text-gray-500"},Yo={class:"flex-1 truncate text-sm"},qo={class:"text-xs text-gray-400"},Xo=["onClick"],we="Loop Nodes",Ko=vt({__name:"LoopNodeWidget",props:{widget:{}},setup(t){const e=t;function s(m){return"node"in m&&m.node!==void 0}u(s,"isComponentWidget");const o=K(null);s(e.widget)?o.value=e.widget.node:Ce(()=>{o.value=f.rootGraph?.getNodeById(e.widget.node)||null});const n=K(0),i=K("40px"),r=K(""),a=bt(()=>(n.value,((o.value?.properties?.[we]||[])??[]).map(p=>f.rootGraph?.getNodeById(p)).filter(Boolean)));function l(m){const p=f.rootGraph?.getNodeById(String(m));p&&f.canvas.selectNodes([p])}u(l,"selectNode");function d(){if(!o.value||!s(e.widget))return;const m=e.widget,p=o.value.size[1],g=m.options?.getHeight?.();if(typeof g=="string"&&g.endsWith("%")){const y=parseFloat(g.substring(0,g.length-1)),w=p*(y/100),v=m.options?.getMinHeight?.()??40;i.value=`${Math.max(w,v)}px`}else if(typeof g=="number")i.value=`${g}px`;else{const y=m.options?.getMinHeight?.()??40;i.value=`${y}px`}}u(d,"updateWidgetMinHeight");function c(){if(!o.value)return;const m=o.value,p=m.recomputeLoopNodes;p&&(m.recomputeLoopNodes=function(...g){const y=p.apply(this,g),w=JSON.stringify(this.properties?.[we]||[]);return w!==r.value&&(r.value=w,n.value++),y})}u(c,"setupLoopNodeHook");let h;return Ce(()=>{c();const m=o.value?.properties?.[we]||[];if(r.value=JSON.stringify(m),d(),o.value){const p=o.value.onResize;o.value.onResize=function(g){p?.call(this,g),d()}}f.rootGraph&&(h=f.rootGraph.onTrigger,f.rootGraph.onTrigger=p=>{h?.(p),p?.type==="node:property:changed"&&p.property==="title"&&(o.value?.properties?.[we]||[]).includes(String(p.nodeId))&&n.value++})}),Nt(()=>{f.rootGraph&&(f.rootGraph.onTrigger=h??void 0)}),(m,p)=>(Q(),J("div",{class:"loop-node-widget h-full",style:Dt({minHeight:i.value})},[A("div",zo,[A("div",$o,B(Z(x)("loopNode.widget.title")),1),A("div",Vo,B(Z(x)("loopNode.widget.contains")),1)]),A("div",jo,[a.value.length===0?(Q(),J("div",Ho,B(Z(x)("loopNode.widget.noNodes")),1)):Ct("",!0),(Q(!0),J(It,null,xt(a.value,g=>(Q(),J("div",{key:g.id,class:"flex items-center gap-2"},[A("div",Yo,[kt(B(g.title||g.type)+" ",1),A("span",qo,"#"+B(g.id),1)]),A("button",{class:"btn btn-ghost btn-xs",onClick:_t(y=>l(g.id),["stop"])},B(Z(x)("loopNode.widget.select")),9,Xo)]))),128))])],4))}}),Jo=yt(Ko,[["__scopeId","data-v-9ffde69a"]]),Qo={class:"flex items-center justify-between mb-2"},Zo={class:"font-medium"},en={class:"text-xs text-gray-400"},tn={class:"space-y-2"},on={key:0,class:"text-sm text-gray-500"},nn={class:"flex-1 truncate text-sm"},sn={class:"text-xs text-gray-400"},rn=["onClick"],le="Next Nodes",an=vt({__name:"LoopNodeNextWidget",props:{widget:{}},setup(t){const e=t;function s(m){return"node"in m&&m.node!==void 0}u(s,"isComponentWidget");const o=K(null);s(e.widget)?o.value=e.widget.node:Ce(()=>{o.value=f.rootGraph?.getNodeById(e.widget.node)||null});const n=K(0),i=K("40px"),r=K(""),a=bt(()=>(n.value,((o.value?.properties?.[le]||[])??[]).map(p=>f.rootGraph?.getNodeById(p)).filter(Boolean)));function l(m){const p=f.rootGraph?.getNodeById(String(m));p&&f.canvas.selectNodes([p])}u(l,"selectNode");function d(){if(!o.value||!s(e.widget))return;const m=e.widget,p=o.value.size[1],g=m.options?.getHeight?.();if(typeof g=="string"&&g.endsWith("%")){const y=parseFloat(g.substring(0,g.length-1)),w=p*(y/100),v=m.options?.getMinHeight?.()??40;i.value=`${Math.max(w,v)}px`}else if(typeof g=="number")i.value=`${g}px`;else{const y=m.options?.getMinHeight?.()??40;i.value=`${y}px`}}u(d,"updateWidgetMinHeight");function c(){if(!o.value)return;const m=o.value,p=m.recomputeNextNodes;p&&(m.recomputeNextNodes=function(...y){const w=p.apply(this,y),v=JSON.stringify(this.properties?.[le]||[]);return v!==r.value&&(r.value=v,n.value++),w});const g=m.recomputeLoopNodes;g&&(m.recomputeLoopNodes=function(...y){const w=g.apply(this,y);if(m.recomputeNextNodes){m.recomputeNextNodes.call(this);const v=JSON.stringify(this.properties?.[le]||[]);v!==r.value&&(r.value=v,n.value++)}return w})}u(c,"setupLoopNodeHook");let h;return Ce(()=>{c();const m=o.value?.properties?.[le]||[];if(r.value=JSON.stringify(m),d(),o.value){const p=o.value.onResize;o.value.onResize=function(g){p?.call(this,g),d()}}f.rootGraph&&(h=f.rootGraph.onTrigger,f.rootGraph.onTrigger=p=>{h?.(p),p?.type==="node:property:changed"&&p.property==="title"&&(o.value?.properties?.[le]||[]).includes(String(p.nodeId))&&n.value++})}),Nt(()=>{f.rootGraph&&(f.rootGraph.onTrigger=h??void 0)}),(m,p)=>(Q(),J("div",{class:"loop-node-widget h-full",style:Dt({minHeight:i.value})},[A("div",Qo,[A("div",Zo,B(Z(x)("loopNode.nextWidget.title")),1),A("div",en,B(Z(x)("loopNode.nextWidget.contains")),1)]),A("div",tn,[a.value.length===0?(Q(),J("div",on,B(Z(x)("loopNode.nextWidget.noNodes")),1)):Ct("",!0),(Q(!0),J(It,null,xt(a.value,g=>(Q(),J("div",{key:g.id,class:"flex items-center gap-2"},[A("div",nn,[kt(B(g.title||g.type)+" ",1),A("span",sn,"#"+B(g.id),1)]),A("button",{class:"btn btn-ghost btn-xs",onClick:_t(y=>l(g.id),["stop"])},B(Z(x)("loopNode.nextWidget.select")),9,rn)]))),128))])],4))}}),ln=yt(an,[["__scopeId","data-v-7a81bd8b"]]),it={name:"node_in_loop",type:"LOOP_NODE_WIDGET",isPreview:!1},st={name:"next",type:"LOOP_NODE_NEXT_WIDGET",isPreview:!1};H().registerExtension({name:"Comfy.LoopNode",async beforeRegisterNodeDef(t,e){e.name==="LoopNode"&&(e.input.required.node_in_loop=["LOOP_NODE_WIDGET"],e.input.required.next=["LOOP_NODE_NEXT_WIDGET"])},getCustomWidgets(){return{LOOP_NODE_WIDGET(t){const e=new he({node:t,name:it.name,component:Jo,inputSpec:it,options:{getHeight:u(()=>"40%","getHeight"),getMinHeight:u(()=>40,"getMinHeight"),afterResize(s){s.graph?.change()}}});return e.type="loopNode",e.serializeValue=()=>t.properties?.["Loop Nodes"]||[],me(t,e),{widget:e}},LOOP_NODE_NEXT_WIDGET(t){const e=new he({node:t,name:st.name,component:ln,inputSpec:st,options:{getHeight:u(()=>"40%","getHeight"),getMinHeight:u(()=>40,"getMinHeight"),afterResize(s){s.graph?.change()}}});return e.type="loopNodeNext",e.serializeValue=()=>t.properties?.["Next Nodes"]||[],me(t,e),{widget:e}}}},init(){const t=Me();wo(()=>t.canvas,e=>{e.onDrawBackground=te(e.onDrawBackground,function(){const s=this.graph;if(s){for(const o of s.nodes)if(o.constructor.comfyClass==="LoopNode"){o.recomputeLoopNodes?.(),o.recomputeNextNodes?.();const n=o._loopChildren||[],i=o._nextChildren||[];[...n,...i].forEach(a=>{const l=s.nodes.indexOf(a);l!==-1&&(s.nodes.splice(l,1),s.nodes.push(a))})}}})},{immediate:!0})},getNodeMenuItems(t){return t.constructor.comfyClass!=="LoopNode"?[]:[{content:"Fit Loop To Nodes",callback:u(()=>{try{t.recomputeLoopNodes?.();const e=t._loopChildren||[];if(!e.length)return;const s=10;let o=1/0,n=1/0,i=-1/0,r=-1/0;for(const l of e)o=Math.min(o,l.pos[0]),n=Math.min(n,l.pos[1]),i=Math.max(i,l.pos[0]+(l.size?.[0]??0)),r=Math.max(r,l.pos[1]+(l.size?.[1]??0));t.pos=[o-s,n-s],t.setSize([Math.max(100,i-o+s*2),Math.max(80,r-n+s*2)]),Me().getCanvas()?.setDirty(!0,!0),t.graph?.change()}catch(e){console.warn("Failed to fit loop to nodes",e)}},"callback")},{content:"Select Nodes",callback:u(()=>{t.recomputeLoopNodes?.();const e=t._loopChildren||[],s=Me().getCanvas();e.length&&s&&s.selectNodes(e)},"callback")}]},async nodeCreated(t){if(t.constructor.comfyClass!=="LoopNode")return;const[e,s]=t.size;if(t.setSize([Math.max(e,300),Math.max(s,200)]),t.inputs&&t.inputs[0]){const o=t.inputs[0];t.outputs||(t.outputs=[]),t.outputs.find(i=>i.name==="items")||t.addOutput("items",o.type)}if(t.recomputeLoopNodes=function(){const o=[];if(!this.graph||!Array.isArray(this.graph._nodes))return o;const n=this.pos[0],i=this.pos[0]+this.size[0],r=this.pos[1],a=this.size[1]/2,l=r+a;for(const d of this.graph._nodes){if(d===this)continue;const c=d.pos[0]+(d.size&&d.size[0]||0)/2,h=d.pos[1]+(d.size&&d.size[1]||0)/2;c>n&&c<i&&h>r&&h<l&&o.push(d)}return this.properties=this.properties||{},this.properties["Loop Nodes"]=o.map(d=>String(d.id)),this._loopChildren=o,this.graph&&this.graph.change(),o},t.recomputeNextNodes=function(){const o=[];if(!this.graph||!Array.isArray(this.graph._nodes))return o;const n=this.pos[0],i=this.pos[0]+this.size[0],r=this.pos[1],a=this.size[1]/2,l=r+a,d=r+this.size[1];for(const c of this.graph._nodes){if(c===this)continue;const h=c.pos[0]+(c.size&&c.size[0]||0)/2,m=c.pos[1]+(c.size&&c.size[1]||0)/2;h>n&&h<i&&m>=l&&m<d&&o.push(c)}return this.properties=this.properties||{},this.properties["Next Nodes"]=o.map(c=>String(c.id)),this._nextChildren=o,this.graph&&this.graph.change(),o},t.onConnectOutput=function(o,n,i,r,a){return!!(o!==0||(this.recomputeLoopNodes?.(),(this._loopChildren||[]).includes(r)))},t.__lastPos=t.pos.slice(),t.recomputeLoopNodes(),t.recomputeNextNodes(),I.vueNodesMode){const o=String(t.id);let n=se.getNodeLayoutRef(o).value?.position||{x:t.pos[0],y:t.pos[1]},i=!1;const r=se.onChange(l=>{if(i||l.source!==Se.Vue&&l.source!==Se.Canvas||!l.nodeIds.includes(o))return;const d=se.getNodeLayoutRef(o).value;if(!d)return;const c=d.position.x-n.x,h=d.position.y-n.y;if(Math.abs(c)<.01&&Math.abs(h)<.01)return;n={...d.position},t.recomputeLoopNodes?.();const m=t._loopChildren||[];if(m.length!==0){i=!0;try{const p=m.map(g=>{const y=String(g.id),w=se.getNodeLayoutRef(y).value;return w?{nodeId:y,bounds:{x:w.position.x+c,y:w.position.y+h,width:w.size.width,height:w.size.height}}:null}).filter(Boolean);p.length>0&&(se.setSource(Se.Canvas),se.batchUpdateNodeBounds(p))}finally{i=!1}}}),a=t.onRemoved;t.onRemoved=function(){r(),a?.call(this)}}t.move=function(o,n,i){if(I.vueNodesMode)return;this.pos[0]+=o,this.pos[1]+=n,this.recomputeLoopNodes?.(),this.recomputeNextNodes?.();const r=this._loopChildren||[],a=this._nextChildren||[];for(const l of r)l.pos[0]+=o,l.pos[1]+=n;for(const l of a)l.pos[0]+=o,l.pos[1]+=n;this.graph&&this.graph.change()},await xe()}});function Et(t){if(!t){console.error("[MaskEditor] No node provided");return}if(!t.imgs?.length&&t.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}lo().openMaskEditor(t)}u(Et,"openMaskEditor");function dn(){const t=T.clipspace_return_node;if(!t){console.error("[MaskEditor] No clipspace_return_node found");return}Et(t)}u(dn,"openMaskEditorFromClipspace");function Ot(){return mt().isDialogOpen("global-mask-editor")}u(Ot,"isOpened");const rt=u(async t=>{if(!Ot())return;const e=wt(),s=e.brushSettings.size,o=t(s);e.setBrushSize(o)},"changeBrushSize");f.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const t=f.canvas.selected_nodes;if(!t||Object.keys(t).length!==1)return;const e=t[Object.keys(t)[0]];Et(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>rt(t=>X.clamp(t+2,1,250)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>rt(t=>X.clamp(t-2,1,250)),"function")},{id:"Comfy.MaskEditor.ColorPicker",icon:"pi pi-palette",label:"Open Color Picker in MaskEditor",function:u(()=>{if(!Ot())return;wt().colorInput?.click()},"function")}],init(){T.open_maskeditor=dn,console.warn("[MaskEditor] ComfyApp.open_maskeditor is deprecated. Plugins should migrate to using the command system or direct node context menu integration.")}});const cn="Comfy.NodeTemplates",at="comfy.templates.json";class un extends ut{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=b("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(b("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(b("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const s=await E.getUserData(at);if(s.status===200)try{e=await s.json()}catch{}else s.status!==404&&console.error(s.status+" "+s.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await E.storeUserData(at,e,{stringify:!1})}catch(s){console.error(s),S().addAlert(s.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const s=new FileReader;s.onload=async()=>{const o=JSON.parse(s.result);if(o?.templates){for(const n of o.templates)n?.name&&n?.data&&this.templates.push(n);await this.store()}},await s.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){S().addAlert(x("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),s=new Blob([e],{type:"application/json"});qe("node_templates.json",s)}show(){super.show(b("div",{},this.templates.flatMap((e,s)=>{let o;return[b("div",{dataset:{id:s.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(n=>{this.draggedEl=n.currentTarget,n.currentTarget.style.opacity="0.6",n.currentTarget.style.border="1px dashed yellow",n.dataTransfer.effectAllowed="move",n.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(n=>{n.target.style.opacity="1",n.currentTarget.style.border="1px dashed transparent",n.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((i,r)=>{var a=Number.parseInt(i.dataset.id);i==this.draggedEl&&a!=r&&this.templates.splice(r,0,this.templates.splice(a,1)[0]),i.dataset.id=r.toString()}),this.store()},"ondragend"),ondragover:u(n=>{if(n.preventDefault(),n.currentTarget==this.draggedEl)return;let i=n.currentTarget.getBoundingClientRect();n.clientY>i.top+i.height/2?n.currentTarget.parentNode.insertBefore(this.draggedEl,n.currentTarget.nextSibling):n.currentTarget.parentNode.insertBefore(this.draggedEl,n.currentTarget)},"ondragover")},[b("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(n=>{n.target.localName=="label"&&(n.currentTarget.parentNode.draggable="true")},"onmousedown")},[b("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(n=>{clearTimeout(this.saveVisualCue);var i=n.target,r=i.parentNode.parentNode;this.templates[r.dataset.id].name=i.value.trim()||"untitled",this.store(),i.style.backgroundColor="rgb(40, 95, 40)",i.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){i.style.transitionDuration=".7s",i.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(n=>{var i=n.target;clearTimeout(this.saveVisualCue),i.style.transitionDuration="0s",i.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(n=>o=n,"$")})]),b("div",{},[b("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const n=JSON.stringify({templates:[e]},null,2),i=new Blob([n],{type:"application/json"}),r=(o.value||e.name)+".json";qe(r,i)},"onclick")}),b("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(n=>{const i=n.target.parentNode.parentNode;i.parentNode.removeChild(i),this.templates.splice(i.dataset.id*1,1),this.store();var r=this;setTimeout(function(){r.element.querySelectorAll(".templateManagerRow").forEach((a,l)=>{a.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const ve=new un,lt=u(async t=>{const e=localStorage.getItem("litegrapheditor_clipboard");await t(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),pn={name:cn,getCanvasMenuItems(t){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(f.canvas.selected_nodes||{}).length,callback:u(async()=>{const o=await de().prompt({title:x("nodeTemplates.saveAsTemplate"),message:x("nodeTemplates.enterName"),defaultValue:""});o?.trim()&&lt(()=>{f.canvas.copyToClipboard();let n=localStorage.getItem("litegrapheditor_clipboard");n=JSON.parse(n||"{}");const i=Object.keys(f.canvas.selected_nodes);for(let r=0;r<i.length;r++){const a=f.canvas.graph?.getNodeById(i[r]),l=a?.constructor.nodeData;let d=z.getGroupData(a);if(d){if(d=d.nodeData,n.groupNodes||(n.groupNodes={}),l==null)throw new TypeError("nodeData is not set");n.groupNodes[l.name]=d,n.nodes[r].type=l.name}}ve.templates.push({name:o,data:JSON.stringify(n)}),ve.store()})},"callback")});const s=ve.templates.map(o=>({content:o.name,callback:u(()=>{lt(async()=>{const n=JSON.parse(o.data);await oe.registerFromWorkflow(n.groupNodes,{}),n.reroutes?(localStorage.setItem("litegrapheditor_clipboard",o.data),f.canvas.pasteFromClipboard()):ht(o.data,f.canvas)})},"callback")}));return s.push(null,{content:"Manage",callback:u(()=>ve.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:s}}),e}};f.registerExtension(pn);f.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class t extends be{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;groupcolor=F.node_colors.yellow.groupcolor;isVirtualNode;constructor(o){super(o),this.color=F.node_colors.yellow.color,this.bgcolor=F.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],f),this.serialize_widgets=!0,this.isVirtualNode=!0}}I.registerNodeType("Note",Object.assign(t,{title_mode:I.NORMAL_TITLE,title:"Note",collapsable:!0})),t.category="utils";class e extends be{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";groupcolor=F.node_colors.yellow.groupcolor;constructor(o){super(o),this.color=F.node_colors.yellow.color,this.bgcolor=F.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],f),this.serialize_widgets=!0,this.isVirtualNode=!0}}I.registerNodeType("MarkdownNote",e),e.category="utils"}});H().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(t,e){if(e.name==="PreviewAny"){const s=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){s&&s.apply(this,[]);const n=$.MARKDOWN(this,"preview",["MARKDOWN",{}],f).widget,i=$.STRING(this,"preview",["STRING",{multiline:!0}],f).widget,r=$.BOOLEAN(this,"previewMode",["BOOLEAN",{label_on:"Markdown",label_off:"Plaintext",default:!1}],f);r.widget.callback=a=>{n.hidden=!a,n.options.hidden=!a,i.hidden=a,i.options.hidden=a},n.hidden=!0,n.options.hidden=!0,n.options.read_only=!0,n.element.readOnly=!0,n.element.disabled=!0,n.serialize=!1,i.hidden=!1,i.options.hidden=!1,i.options.read_only=!0,i.element.readOnly=!0,i.element.disabled=!0,i.serialize=!1};const o=t.prototype.onExecuted;t.prototype.onExecuted=function(n){o?.apply(this,[n]);const i=this.widgets?.filter(r=>r.name==="preview")??[];for(const r of i){const a=n.text??"";r.value=Array.isArray(a)?a[0]??"":a}}}}});f.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(t){class e extends be{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(o){super(o??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(I.INPUT,void 0,!0)})}clone(){const o=super.clone();return o&&(o.removeOutput(0),o.addOutput(this.properties.showOutputText?"*":"","*"),o.setSize(o.computeSize()),o)}onConnectionsChange(o,n,i){const{graph:r}=this;if(!r||t.configuringGraph)return;if(i&&o===I.OUTPUT&&new Set(this.outputs[0].links?.map(N=>r.links[N]?.type)?.filter(N=>N&&N!=="*")??[]).size>1){const N=[];for(const C of this.outputs[0].links??[]){const k=r.links[C];N.push(k)}N.pop();for(const C of N)r.getNodeById(C.target_id)?.disconnectInput(C.target_slot)}let a=this,l=[],d=null,c=null;for(;a;){l.unshift(a);const v=a.inputs[0].link;if(v!==null){const N=r.links[v];if(!N)return;const C=r.getNodeById(N.origin_id);if(!C)return;if(C instanceof e)C===this?(a.disconnectInput(N.target_slot),a=null):a=C;else{c=a,d=C.outputs[N.origin_slot]?.type??null;break}}else{a=null;break}}const h=[this];let m=null;for(;h.length;){a=h.pop();const v=a.outputs?.[0]?.links??[];for(const N of v){const C=r.links[N];if(!C)continue;const k=r.getNodeById(C.target_id);if(k)if(k instanceof e)h.push(k),l.push(k);else{const _=k.inputs[C.target_slot],D=_.type,O=!d||!D||I.isValidConnection(d,D);if(!O){k.disconnectInput(C.target_slot);continue}k.onConnectionsChange?.(I.INPUT,C.target_slot,O,C,_),m=k.inputs[C.target_slot].type}}}const p=d||m||"*",g=F.link_type_colors[p];let y,w;for(const v of l){v.outputs[0].type=d||"*",v.__outputType=p,v.outputs[0].name=v.properties.showOutputText?`${p}`:"",v.setSize(v.computeSize());for(const N of v.outputs[0].links||[]){const C=r.links[N];if(!C||(C.color=g,t.configuringGraph))continue;const k=r.getNodeById(C.target_id);if(!k)continue;const _=k.inputs?.[C.target_slot];if(_?.widget){const D=ze(_);y||(y=D[1]??{},w=D[0]);const O=ye(_,[D[0],y]);O.customConfig&&(y=O.customConfig)}}}for(const v of l)y&&m?(v.inputs[0].widget={name:"value"},Re(v.inputs[0],[w??`${p}`,y])):Re(v.inputs[0],void 0);if(c?.inputs?.[0]?.link){const v=r.links[c.inputs[0].link];v&&(v.color=g)}}getExtraMenuOptions(o,n){return n.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),t.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,I.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(o){e.defaultVisibility=o,o?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),I.registerNodeType("Reroute",Object.assign(e,{title_mode:I.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const gn=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);f.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(t,e,s){if(gn.has(e.name)){const o=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){const n=o?o.apply(this,arguments):void 0,i=this.widgets.find(r=>r.name==="filename_prefix");return i.serializeValue=()=>gt(s.graph,i.value),n}}else{const o=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){const n=o?o.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),n}}}});const dt={name:"image",type:"Preview3D",isPreview:!0};H().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(t,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(t){const e=new he({node:t,name:dt.name,component:Be,inputSpec:dt,options:{}});return e.type="load3D",me(t,e),{widget:e}}}},getNodeMenuItems(t){if(t.constructor.comfyClass!=="SaveGLB")return[];const e=Ne().getLoad3d(t);return e?e.isSplatModel()?[]:ke(e):[]},async nodeCreated(t){if(t.constructor.comfyClass!=="SaveGLB")return;const[e,s]=t.size;t.setSize([Math.max(e,400),Math.max(s,550)]),await xe();const o=t.onExecuted;t.onExecuted=function(n){o?.apply(this,arguments);const i=n["3d"][0];fe(t).waitForLoad3d(r=>{const a=t.widgets?.find(l=>l.name==="image");if(r&&a){const l=i.subfolder+"/"+i.filename;a.value=l,new $e(r,t.properties).configureForSaveMesh(i.type,l)}})}}});function fn(t,e){const s=e.selectedItems;if(s.size<=1)return;const o=co(s,10);if(!o)return;const[n,i,r,a]=o;t.save();const l=2/e.ds.scale;t.lineWidth=l,t.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const d=5/e.ds.scale;t.setLineDash([d,d]),t.beginPath(),t.roundRect(n,i,r,a,8/e.ds.scale),t.stroke(),t.restore()}u(fn,"drawSelectionBorder");const hn={name:"Comfy.SelectionBorder",async init(){const t=f.canvas.onDrawForeground;f.canvas.onDrawForeground=function(e,s){t?.call(this,e,s),fn(e,f.canvas)}}};f.registerExtension(hn);let pe=!1,ge=0;f.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let t=null,e=null,s=null,o=null;function n(a){return Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY)}u(n,"getMultiTouchPos");function i(a){return{clientX:(a.touches[0].clientX+a.touches[1].clientX)/2,clientY:(a.touches[0].clientY+a.touches[1].clientY)/2}}u(i,"getMultiTouchCenter"),f.canvasEl.parentElement?.addEventListener("touchstart",a=>{ge+=a.changedTouches.length,s=null,o=null,a.touches?.length===1?(e=new Date,s=a.touches[0]):(e=null,a.touches?.length===2&&(o=f.canvas.ds.scale,s=i(a),t=n(a),f.canvas.pointer.isDown=!1))},!0),f.canvasEl.parentElement?.addEventListener("touchend",a=>{if(ge-=a.changedTouches.length,a.touches?.length!==1&&(pe=!1),e&&!a.touches?.length){if(new Date().getTime()-e.getTime()>600&&a.target===f.canvasEl){const l={button:2,clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,pointerId:1,isPrimary:!0};f.canvasEl.dispatchEvent(new PointerEvent("pointerdown",l)),setTimeout(()=>{f.canvasEl.dispatchEvent(new PointerEvent("pointerup",l))}),a.preventDefault()}e=null}});const r=u(()=>{ge=0,pe=!1,e=null,s=null,o=null,t=null},"resetTouchState");document.addEventListener("visibilitychange",()=>{document.hidden&&r()}),f.canvasEl.parentElement?.addEventListener("touchcancel",r),f.canvasEl.parentElement?.addEventListener("touchmove",a=>{if(e&&s&&a.touches?.length===1){const c=a.touches[0],h=c.clientX-s.clientX,m=c.clientY-s.clientY;h*h+m*m>30&&(e=null)}if(a.touches?.length===2&&s&&!a.ctrlKey&&!a.shiftKey){a.preventDefault(),f.canvas.pointer.isDown=!1,pe=!0,I.closeAllContextMenus(window),f.canvas.search_box?.close();const c=n(a),h=i(a);if(o===null||t===null)return;let m=o*c/t;const p=(h.clientX-s.clientX)/m,g=(h.clientY-s.clientY)/m;m<f.canvas.ds.min_scale?m=f.canvas.ds.min_scale:m>f.canvas.ds.max_scale&&(m=f.canvas.ds.max_scale);const y=f.canvas.ds.scale;f.canvas.ds.scale=m,Math.abs(f.canvas.ds.scale-1)<.01&&(f.canvas.ds.scale=1);const w=f.canvas.ds.scale,v=u(N=>[h.clientX/N-f.canvas.ds.offset[0],h.clientY/N-f.canvas.ds.offset[1]],"convertScaleToOffset");var l=v(y),d=v(w);f.canvas.ds.offset[0]+=p+d[0]-l[0],f.canvas.ds.offset[1]+=g+d[1]-l[1],s.clientX=h.clientX,s.clientY=h.clientY,f.canvas.setDirty(!0,!0)}},!0)}});const mn=F.prototype.processMouseDown;F.prototype.processMouseDown=function(t){if(!(pe||ge))return f.canvas.pointer.isDown=!1,mn.apply(this,[t])};const yn=F.prototype.processMouseMove;F.prototype.processMouseMove=function(t){if(!(pe||ge>1))return yn.apply(this,[t])};f.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){I.search_filter_enabled=!0,I.middle_click_slot_add_default_node=!0,this.suggestionsNumber=f.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(t=>{this.setDefaults(t)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(t,e){var s=e.name;const o=e.input?.required;for(const d in o){var n=o[d];if(typeof n[0]!="string")continue;var i=n[0];if(i in $){var r=n[1];if(!r?.forceInput)continue}if(i in this.slot_types_default_out||(this.slot_types_default_out[i]=["Reroute"]),this.slot_types_default_out[i].includes(s))continue;this.slot_types_default_out[i].push(s);const c=i.toLocaleLowerCase();c in I.registered_slot_in_types||(I.registered_slot_in_types[c]={nodes:[]}),I.registered_slot_in_types[c].nodes.push(t.comfyClass)}var a=e.output??[];for(const d of a){const c=d;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(s)&&(this.slot_types_default_in[c].push(s),c in I.registered_slot_out_types||(I.registered_slot_out_types[c]={nodes:[]}),I.registered_slot_out_types[c].nodes.push(t.comfyClass),I.slot_types_out.includes(c)||I.slot_types_out.push(c))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(t){I.slot_types_default_out={},I.slot_types_default_in={};for(const e in this.slot_types_default_out)I.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,t);for(const e in this.slot_types_default_in)I.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,t)}});async function wn(t,e,s,o,n=!1){try{const i=new FormData;i.append("image",s),n&&i.append("subfolder","pasted");const r=await E.fetchApi("/upload/image",{method:"POST",body:i});if(r.status===200){const a=await r.json();let l=a.name;a.subfolder&&(l=a.subfolder+"/"+l),t.options.values.includes(l)||t.options.values.push(l),o&&(e.element.src=E.apiURL(Ie(...Tt(l))),t.value=l,t.callback?.(l))}else S().addAlert(r.status+" - "+r.statusText)}catch(i){S().addAlert(i)}}u(wn,"uploadFile");f.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(t,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(t.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(t,e){const s=document.createElement("audio");s.controls=!0,s.classList.add("comfy-audio"),s.setAttribute("name","media");const o=t.addDOMWidget(e,"audioUI",s);o.serialize=!1;const{nodeData:n}=t.constructor;if(n==null)throw new TypeError("nodeData is null");if(n.output_node){o.element.classList.add("empty-audio-widget");const r=t.onExecuted;t.onExecuted=function(a){r?.apply(this,arguments);const l=a.audio;if(!l)return;const d=l[0];o.element.src=E.apiURL(Ie(d.subfolder,d.filename,d.type)),o.element.classList.remove("empty-audio-widget")}}return o.onRemove=te(o.onRemove,()=>{o.element&&(o.element.pause(),o.element.src="",o.element.remove())}),{widget:o}}}},onNodeOutputsUpdated(t){for(const[e,s]of Object.entries(t))if("audio"in s){const o=uo(f.rootGraph,e);if(!o)continue;const n=o.widgets.find(r=>r.name==="audioUI"),i=s.audio[0];n.element.src=E.apiURL(Ie(i.subfolder,i.filename,i.type)),n.element.classList.remove("empty-audio-widget")}}});f.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(t,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(t,e){const s=t.widgets.find(c=>c.name==="audio"),o=t.widgets.find(c=>c.name==="audioUI");o.options.canvasOnly=!0;const n=u(()=>{typeof s.value=="string"&&(o.element.src=E.apiURL(Ie(...Tt(s.value))))},"onAudioWidgetUpdate");s.value&&n(),s.callback=n;const i=t.onGraphConfigured;t.onGraphConfigured=function(){i?.apply(this,arguments),s.value&&n()};const r=u(async c=>(c?.length&&wn(s,o,c[0],!0),c),"handleUpload"),a=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=po(t,{accept:"audio/*",onSelect:r}),d=t.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return d.label=x("g.choose_file_to_upload"),go(t,{fileFilter:a,onDrop:r}),fo(t,{fileFilter:a,onPaste:r}),t.previewMediaType="audio",{widget:d}}}}});f.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(t,e){const s=document.createElement("audio");s.controls=!0,s.classList.add("comfy-audio"),s.setAttribute("name","media");const o=t.addDOMWidget(e,"audioUI",s);o.options.canvasOnly=!1;let n=null,i=!1,r=[],a=null,l=null,d=null,c=null;o.serializeValue=async()=>{i&&n&&(d=new Promise(g=>{c=g}),n.stop(),await d);const m=o.element.src;if(!m)return S().addAlert(x("g.noAudioRecorded")),"";const p=await fetch(m).then(g=>g.blob());return await re().convertBlobToFileAndSubmit(p)},l=t.addWidget("button",e,"",async()=>{if(i)n&&i&&n.stop();else try{a=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new vo(a,{mimeType:"audio/wav"}),r=[],n.ondataavailable=m=>{r.push(m.data)},n.onstop=async()=>{const m=new Blob(r,{type:"audio/wav"});re().stopAllTracks(a),o.element.src&&o.element.src.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),o.element.src=URL.createObjectURL(m),i=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},n.onerror=m=>{console.error("MediaRecorder error:",m),re().stopAllTracks(a),i=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},n.start(),i=!0,l&&(l.label=x("g.stopRecording"))}catch(m){if(console.error("Error accessing microphone:",m),S().addAlert(x("g.micPermissionDenied")),n)try{n.stop()}catch{}re().stopAllTracks(a),a=null,i=!1,l&&(l.label=x("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=x("g.startRecording"),l.type="audiorecord";const h=t.onRemoved;return t.onRemoved=function(){i&&n&&n.stop(),re().stopAllTracks(a),o.element.src?.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),h?.call(this)},{widget:l}}}},async nodeCreated(t){t.constructor.comfyClass==="RecordAudio"&&await re().registerWavEncoder()}});const vn=u(t=>{const[e,s]=t;return s?(s.image_upload===!0||s.video_upload===!0||s.animated_image_upload===!0)&&(ho(t)||e==="COMBO"):!1},"isMediaUploadComboInput"),bn=u((t,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:t}],"createUploadInput");f.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(t,e){const{input:s}=e??{},{required:o}=s??{};if(!o)return;const n=Object.entries(o).find(([i,r])=>vn(r));if(n){const[i,r]=n;o.upload=bn(i,r)}}});const ct=Symbol();f.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(t,e){let s;t[ct]=new Promise(r=>s=r);const o=document.createElement("div");o.style.background="rgba(0,0,0,0.25)",o.style.textAlign="center";const n=document.createElement("video");return n.style.height=n.style.width="100%",u(async()=>{try{const r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});o.replaceChildren(n),setTimeout(()=>s(n),500),n.addEventListener("loadedmetadata",()=>s(n),!1),n.srcObject=r,n.play()}catch(r){const a=document.createElement("div");a.style.color="red",a.style.overflow="auto",a.style.maxHeight="100%",a.style.whiteSpace="pre-wrap",window.isSecureContext?a.textContent=`Unable to load webcam, please ensure access is granted:
`+r.message:a.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+r.message,o.replaceChildren(a)}},"loadVideo")(),{widget:t.addDOMWidget(e,"WEBCAM",o)}}}},nodeCreated(t){if(t.type,t.constructor.comfyClass!=="WebcamCapture")return;let e;const s=t.widgets.find(d=>d.name==="image"),o=t.widgets.find(d=>d.name==="width"),n=t.widgets.find(d=>d.name==="height"),i=t.widgets.find(d=>d.name==="capture_on_queue"),r=document.createElement("canvas"),a=u(()=>{r.width=o.value,r.height=n.value,r.getContext("2d").drawImage(e,0,0,o.value,n.value);const c=r.toDataURL("image/png"),h=new Image;h.onload=()=>{t.imgs=[h],f.canvas.setDirty(!0)},h.src=c},"capture"),l=t.addWidget("button","waiting for camera...","capture",a,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},s.serializeValue=async()=>{if(i.value)a();else if(!t.imgs?.length){const g="No webcam image captured";throw S().addAlert(g),new Error(g)}const d=await new Promise(g=>r.toBlob(g)),c=`${+new Date}.png`,h=new File([d],c),m=new FormData;m.append("image",h),m.append("subfolder","webcam"),m.append("type","temp");const p=await E.fetchApi("/upload/image",{method:"POST",body:m});if(p.status!==200){const g=`Error uploading camera image: ${p.status} - ${p.statusText}`;throw S().addAlert(g),new Error(g)}return`webcam/${c} [temp]`},t[ct].then(d=>{e=d,o.value||(o.value=e.videoWidth||640,n.value=e.videoHeight||480),l.disabled=!1,l.label=x("g.capture")})}});H().registerExtension({name:"Comfy.LLMNodePreview",async beforeRegisterNodeDef(t,e){if(e.name==="LLMNode"){const s=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){s&&s.apply(this,[]);const n=$.MARKDOWN(this,"preview",["MARKDOWN",{}],f).widget;n.element.readOnly=!0,n.serialize=!1,n.beforeQueued=()=>{n.value="",n.callback?.("")}};const o=t.prototype.onExecuted;t.prototype.onExecuted=function(n){o?.apply(this,[n]);const i=this.widgets?.find(r=>r.name==="preview");i&&n.text&&Array.isArray(n.text)&&n.text.length>0&&(i.value=n.text[0])}}}});
//# sourceMappingURL=index-BRjWIQdJ.js.map
