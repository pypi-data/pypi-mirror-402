name: å®šæ—¶æ£€æŸ¥

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆUTC 18:00ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  health-check:
    name: å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: å®‰è£…uv
      uses: astral-sh/setup-uv@v3

    - name: åŒæ­¥ä¾èµ–
      run: |
        uv sync

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "::group::Ruff Linting"
        uv run ruff check src/
        echo "::endgroup::"

        echo "::group::Ruff Format"
        uv run ruff format src/ --check
        echo "::endgroup::"

    - name: CLIå‘½ä»¤å¥åº·æ£€æŸ¥
      run: |
        echo "::group::CLI Help"
        uv run df-test --help
        echo "::endgroup::"

        echo "::group::Initå‘½ä»¤"
        # CIç¯å¢ƒè‡ªåŠ¨æ£€æµ‹ï¼šæ¡†æ¶ä¼šä½¿ç”¨æœ¬åœ°è·¯å¾„ä¾èµ–ï¼ˆCI=trueï¼‰
        uv run df-test init health-check-api --type api
        # pytest é…ç½®å·²æ•´åˆåˆ° pyproject.toml
        test -f health-check-api/pyproject.toml || exit 1
        echo "::endgroup::"

        echo "::group::éªŒè¯ä¾èµ–é…ç½®"
        # éªŒè¯ç”Ÿæˆçš„é¡¹ç›®ä½¿ç”¨äº†æœ¬åœ°è·¯å¾„ä¾èµ–
        grep 'df-test-framework @ file://..' health-check-api/pyproject.toml || exit 1
        echo "âœ… å·²æ­£ç¡®ä½¿ç”¨æœ¬åœ°è·¯å¾„ä¾èµ–"
        echo "::endgroup::"

        echo "::group::Genå‘½ä»¤"
        # åœ¨çˆ¶ç›®å½•æ‰§è¡Œ gen å‘½ä»¤ï¼ŒæŒ‡å®šè¾“å‡ºç›®å½•
        uv run df-test gen test health_check --output-dir health-check-api/tests/api/
        test -f health-check-api/tests/api/test_health_check.py || exit 1
        echo "::endgroup::"

    - name: æ£€æŸ¥æ–‡æ¡£é“¾æ¥
      run: |
        echo "::group::æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶"
        test -f README.md
        test -f CHANGELOG.md
        test -f docs/README.md
        echo "::endgroup::"

    - name: æ£€æŸ¥ç¤ºä¾‹ä»£ç 
      run: |
        echo "::group::æ£€æŸ¥ç¤ºä¾‹ç›®å½•"
        test -d examples/
        find examples/ -name "*.py" -type f | head -5
        echo "::endgroup::"

    - name: å¥åº·æ£€æŸ¥æ€»ç»“
      if: always()
      run: |
        echo "## ğŸ¥ æ¯æ—¥å¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ—¥æœŸ**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ£€æŸ¥é¡¹" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç è´¨é‡ï¼ˆRuffï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CLIå·¥å…·å¯ç”¨æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é¡¹ç›®åˆå§‹åŒ–åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç ç”ŸæˆåŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ–‡æ¡£å®Œæ•´æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç¤ºä¾‹ä»£ç å­˜åœ¨æ€§" >> $GITHUB_STEP_SUMMARY

  dependency-check:
    name: ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: å®‰è£…pip-audit
      run: |
        pip install pip-audit

    - name: æ£€æŸ¥ä¾èµ–å®‰å…¨æ¼æ´
      run: |
        pip install -e .
        pip-audit --desc
      continue-on-error: true  # å…è®¸æœ‰æ¼æ´ï¼Œä½†ä¼šè®°å½•

    - name: ä¾èµ–æ£€æŸ¥æ€»ç»“
      if: always()
      run: |
        echo "## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "å·²æ‰«ææ‰€æœ‰ä¾èµ–åŒ…çš„å·²çŸ¥å®‰å…¨æ¼æ´" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: å¤±è´¥é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [health-check, dependency-check]
    if: failure() && github.event_name == 'schedule'

    steps:
    - name: å‘é€é’‰é’‰é€šçŸ¥
      if: env.DINGTALK_WEBHOOK != ''
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        curl -X POST "$DINGTALK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"msgtype\": \"markdown\",
            \"markdown\": {
              \"title\": \"âš ï¸ DF Test Framework å®šæ—¶æ£€æŸ¥å¤±è´¥\",
              \"text\": \"## âš ï¸ å®šæ—¶å¥åº·æ£€æŸ¥å¤±è´¥\\n\\n**æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')\\n\\n**æŸ¥çœ‹**: [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\\n\\nè¯·åŠæ—¶å¤„ç†ï¼\"
            }
          }"
