name: å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v2.0.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (å¦‚ 2.0.0)'
        required: true
        type: string

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„æº

jobs:
  test:
    name: å‘å¸ƒå‰æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: å®‰è£…uv
      uses: astral-sh/setup-uv@v3

    - name: åŒæ­¥ä¾èµ–
      run: |
        uv sync

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        uv run ruff check src/
        uv run ruff format src/ --check

    - name: CLIåŠŸèƒ½æµ‹è¯•
      run: |
        uv run df-test --help
        uv run df-test init test-release-project --type api
        test -f test-release-project/pyproject.toml
        test -d test-release-project/src

  build:
    name: æ„å»ºåˆ†å‘åŒ…
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: å®‰è£…æ„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: æ„å»ºåˆ†å‘åŒ…
      run: |
        python -m build

    - name: æ£€æŸ¥åˆ†å‘åŒ…
      run: |
        twine check dist/*

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 7

    - name: æ„å»ºæ€»ç»“
      run: |
        echo "## æ„å»ºå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ„å»ºäº§ç‰©**:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh dist/
        echo '```' >> $GITHUB_STEP_SUMMARY

  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    runs-on: ubuntu-latest
    needs: build
    environment: release  # ä½¿ç”¨GitHubç¯å¢ƒä¿æŠ¤è§„åˆ™
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: å‘å¸ƒåˆ°PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true

    - name: å‘å¸ƒæ€»ç»“
      run: |
        echo "## ğŸ‰ å‘å¸ƒåˆ°PyPIæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ç‰ˆæœ¬: \`${GITHUB_REF#refs/tags/}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®‰è£…å‘½ä»¤**:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install df-test-framework" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆchangelog

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/

    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # æå–CHANGELOG.mdä¸­çš„å½“å‰ç‰ˆæœ¬å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f CHANGELOG.md ]; then
          # æå–## [VERSION]åˆ°ä¸‹ä¸€ä¸ª## [ä¹‹é—´çš„å†…å®¹
          CHANGES=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$ d' | tail -n +2)
          if [ -n "$CHANGES" ]; then
            echo "$CHANGES" > release_notes.md
          else
            echo "æŸ¥çœ‹å®Œæ•´å˜æ›´æ—¥å¿—: [CHANGELOG.md](CHANGELOG.md)" > release_notes.md
          fi
        else
          echo "æŸ¥çœ‹å®Œæ•´å˜æ›´å†å²: [Commits](https://github.com/${{ github.repository }}/commits/v${VERSION})" > release_notes.md
        fi

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: v${{ steps.changelog.outputs.version }}
        body_path: release_notes.md
        files: |
          dist/*
        draft: false
        prerelease: false
        generate_release_notes: true

    - name: Releaseæ€»ç»“
      run: |
        echo "## ğŸ‰ GitHub Releaseåˆ›å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬**: v${{ steps.changelog.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**æŸ¥çœ‹**: [Releaseé¡µé¢](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.changelog.outputs.version }})" >> $GITHUB_STEP_SUMMARY

  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [publish-pypi, create-release]
    if: always()

    steps:
    - name: å‘é€é’‰é’‰é€šçŸ¥
      if: env.DINGTALK_WEBHOOK != ''
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        STATUS="âœ… æˆåŠŸ"
        if [ "${{ needs.publish-pypi.result }}" != "success" ] || [ "${{ needs.create-release.result }}" != "success" ]; then
          STATUS="âŒ å¤±è´¥"
        fi

        curl -X POST "$DINGTALK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"msgtype\": \"markdown\",
            \"markdown\": {
              \"title\": \"DF Test Framework å‘å¸ƒé€šçŸ¥\",
              \"text\": \"## DF Test Framework å‘å¸ƒé€šçŸ¥\\n\\n**ç‰ˆæœ¬**: v${VERSION}\\n\\n**çŠ¶æ€**: ${STATUS}\\n\\n**å®‰è£…**: \\\`pip install df-test-framework\\\`\\n\\n**æŸ¥çœ‹**: [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})\"
            }
          }"
