[project]
name = "df-test-framework"
version = "4.0.0"
description = "基于交互模式的现代化测试自动化框架，支持多种测试场景"
authors = [{name = "DF QA Team", email = "qa@example.com"}]
readme = "README_PYPI.md"
requires-python = ">=3.12"
license = {text = "MIT"}
keywords = ["testing", "automation", "api", "ui", "pytest", "framework"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Software Development :: Testing",
    "Topic :: Software Development :: Quality Assurance",
    "Framework :: Pytest",
]

dependencies = [
    # 核心测试依赖
    "pytest>=9.0.1",
    "pytest-timeout>=2.2.0",
    "pytest-asyncio>=1.3.0", # 异步测试支持
    "allure-pytest>=2.13.0",
    "assertpy>=1.1",
    # HTTP 客户端
    "httpx>=0.27.0",
    "h2>=4.3.0", # HTTP/2 协议支持 (AsyncHttpClient)
    "hpack>=4.1.0", # HTTP/2 头部压缩
    "hyperframe>=6.1.0", # HTTP/2 帧解析
    # 配置与验证
    "pydantic>=2.0.0",
    "pydantic-settings>=2.0.0",
    "python-dotenv>=1.0.0",
    "jsonschema>=4.25.1",
    "jsonschema-spec>=0.2.4",
    # 数据库
    "sqlalchemy>=2.0.0",
    "pymysql>=1.1.0",
    "redis>=5.0.0",
    # 工具库
    "structlog>=25.4.0",  # 现代化结构化日志 (v3.38.5: 升级支持 Python 3.14)
    "freezegun>=1.5.0",   # 时间 Mock (v3.38.4, time_mock fixture)
    "openpyxl>=3.1.0",
    "faker>=38.2.0",
    "pluggy>=1.5.0",
    "questionary>=2.0.0", # 交互式命令行工具
    "prance[osv]>=23.6.0", # OpenAPI/Swagger 解析器
    "pyyaml>=6.0.0", # YAML 支持（OpenAPI 规范）
    "jsonpath-ng>=1.7.0",
    "pypinyin>=0.53.0",  # 中文转拼音，用于 CLI 代码生成器处理中文 tag
    # 安全依赖版本约束 (CVE 修复)
    "requests>=2.32.4",  # CVE-2024-47081
    "urllib3>=2.6.0",    # CVE-2025-50182, CVE-2025-50181, CVE-2025-66418, CVE-2025-66471
    "filelock>=3.20.1",  # CVE-2025-68146
]

[project.urls]
Homepage = "https://github.com/yourorg/df-test-framework"
Repository = "https://github.com/yourorg/df-test-framework"
Documentation = "https://github.com/yourorg/df-test-framework#readme"
"Bug Tracker" = "https://github.com/yourorg/df-test-framework/issues"

[project.optional-dependencies]
ui = [
    "playwright>=1.40.0",
    "selenium>=4.0.0",
]
# v4.0.0: 异步数据库驱动
database-async = [
    "aiomysql>=0.2.0",      # MySQL 异步驱动
    "asyncpg>=0.29.0",      # PostgreSQL 异步驱动
    "aiosqlite>=0.20.0",    # SQLite 异步驱动
]
kafka = [
    "confluent-kafka>=2.12.0",  # Kafka客户端 - 最新版本，提供 Windows 预编译 wheel
]
rabbitmq = [
    "pika>=1.3.0",  # RabbitMQ客户端
]
rocketmq = [
    "rocketmq-python-client>=5.0.0",  # RocketMQ客户端
]
mq = [
    "confluent-kafka>=2.12.0",
    "pika>=1.3.0",
    "rocketmq-python-client>=5.0.0",
]
# v3.10.0 新增依赖组
opentelemetry = [
    "opentelemetry-api>=1.20.0",  # OpenTelemetry API
    "opentelemetry-sdk>=1.20.0",  # OpenTelemetry SDK
    "opentelemetry-instrumentation-httpx>=0.41b0",  # HTTPX 自动埋点
]
prometheus = [
    "prometheus-client>=0.19.0",  # Prometheus 指标客户端
]
storage = [
    "boto3>=1.34.0",  # AWS S3 客户端（也支持 MinIO）
    "oss2>=2.18.0",  # 阿里云 OSS 客户端
]
codegen = [
    "pypinyin>=0.53.0",  # 中文转拼音，用于 OpenAPI 代码生成器处理中文 tag
]
performance = [
    "orjson>=3.9.0",  # 高性能 JSON 序列化（v3.38.4），比标准库快 5-10 倍
]
observability = [
    "opentelemetry-api>=1.20.0",
    "opentelemetry-sdk>=1.20.0",
    "opentelemetry-instrumentation-httpx>=0.41b0",
    "prometheus-client>=0.19.0",
]
all = [
    # UI 测试
    "playwright>=1.40.0",
    "selenium>=4.0.0",
    # 异步数据库驱动（v4.0.0）
    "aiomysql>=0.2.0",
    "asyncpg>=0.29.0",
    "aiosqlite>=0.20.0",
    # 消息队列
    "confluent-kafka>=2.12.0",
    "pika>=1.3.0",
    "rocketmq-python-client>=5.0.0",
    # 可观测性
    "opentelemetry-api>=1.20.0",
    "opentelemetry-sdk>=1.20.0",
    "opentelemetry-instrumentation-httpx>=0.41b0",
    "prometheus-client>=0.19.0",
    # 存储客户端
    "boto3>=1.34.0",
    "oss2>=2.18.0",
    # 代码生成
    "pypinyin>=0.53.0",
    # 性能优化
    "orjson>=3.9.0",
]

# uv dependency groups (用于 uv sync)
[dependency-groups]
dev = [
    "ruff>=0.1.0",
    "mypy>=1.7.0",
    "pytest-cov>=4.1.0",
    "pytest-xdist>=3.5.0",
    "pytest-mock>=3.12.0",
    "pre-commit>=3.6.0",
    # freezegun 已移至核心依赖 (v3.38.4)
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["src/df_test_framework"]

[tool.ruff]
line-length = 100
target-version = "py312"
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    "*.pyc",
]

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W", "UP"]
ignore = [
    "E501",  # 行长度限制
    "N818",  # 异常命名规范 - MockResponse 是携带数据的异常，不需要 Error 后缀
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

# pytest 9.0+ 原生 TOML 配置
[tool.pytest]
minversion = "9.0"
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = ["-v", "--strict-markers", "--tb=short"]
markers = [
    "unit: 单元测试 - 独立模块功能测试",
    "smoke: 冒烟测试 - 核心功能快速验证",
    "regression: 回归测试 - 完整功能验证",
    "integration: 集成测试 - 多模块协作测试",
    "e2e: 端到端测试 - 完整业务流程测试",
    "slow: 慢速测试 - 执行时间较长的测试",
    "performance: 性能测试 - 性能指标验证",
    "asyncio: 异步测试 - 使用 async/await 的测试",
    "keep_data: 保留此测试的所有数据（调试用）",
    "debug: 调试模式 - 强制启用控制台调试输出",
]
timeout = "30"
timeout_method = "thread"
# v3.46.3: 改为 "strict" 避免与 Playwright 同步 API 冲突
# - "auto": 自动检测异步测试（pytest-asyncio 1.3.0+ 可能误判 UI fixtures）
# - "strict": 只有显式标记 @pytest.mark.asyncio 的测试才在事件循环中运行
asyncio_mode = "strict"
asyncio_default_fixture_loop_scope = "function"
norecursedirs = [".git", ".tox", "dist", "build", "*.egg"]
filterwarnings = [
    "ignore:Module already imported so cannot be rewritten.*allure:pytest.PytestAssertRewriteWarning",
    "ignore:invalid escape sequence.*:SyntaxWarning",
]

[tool.coverage.run]
source = ["src/df_test_framework"]
omit = [
    "*/tests/*",
    "*/__init__.py",
    "*/conftest.py",
    # CLI 入口点 - 无需测试覆盖
    "*/cli/__main__.py",
]
branch = true

[tool.coverage.report]
fail_under = 80
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
]

[tool.coverage.html]
directory = "reports/coverage"

[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false

# Bandit 安全扫描配置
[tool.bandit]
exclude_dirs = ["tests", "docs", "examples"]
skips = [
    "B101",  # assert_used - 测试框架需要使用 assert
    "B105",  # hardcoded_password_string - 误报：枚举值和参数名不是硬编码密码
    "B107",  # hardcoded_password_default - 误报：默认参数值不是密码
    "B110",  # try_except_pass - 静默失败是有意为之（事件发布、清理操作等）
    "B311",  # random - 测试数据生成使用伪随机是可接受的
    "B608",  # hardcoded_sql_expressions - 误报：使用了命名参数化查询（:key），是安全的
]

# Commitizen 提交信息规范
[tool.commitizen]
name = "cz_conventional_commits"
version = "3.10.0"
version_files = [
    "src/df_test_framework/__init__.py:__version__",
    "pyproject.toml:version",
]
tag_format = "v$version"
update_changelog_on_bump = false

[project.scripts]
df-test = "df_test_framework.cli:main"

# pytest11 Entry Points - pip install 后自动加载
[project.entry-points.pytest11]
df_test_framework_core = "df_test_framework.testing.fixtures.core"
df_test_framework_env = "df_test_framework.testing.plugins.env_plugin"
df_test_framework_logging = "df_test_framework.testing.plugins.logging_plugin"
df_test_framework_markers = "df_test_framework.testing.plugins.markers"
df_test_framework_allure = "df_test_framework.testing.fixtures.allure"
df_test_framework_debugging = "df_test_framework.testing.fixtures.debugging"
df_test_framework_metrics = "df_test_framework.testing.fixtures.metrics"
df_test_framework_monitoring = "df_test_framework.testing.fixtures.monitoring"
df_test_framework_ui = "df_test_framework.testing.fixtures.ui"  # v3.46.3: UI fixtures + 失败诊断 hooks
