# DF Test Framework v4.0 æ¶æ„æ€»è§ˆ

> **ç‰ˆæœ¬**: v4.0.0
> **æ›´æ–°æ—¶é—´**: 2026-01-16
> **æ¶æ„ç±»å‹**: äº”å±‚æ¶æ„ + äº‹ä»¶é©±åŠ¨ + ä¾èµ–æ³¨å…¥

---

## ğŸ“‹ æ ¸å¿ƒæ¶æ„ç†å¿µ

DF Test Framework v4.0 é‡‡ç”¨**æ¸…æ™°åˆ†å±‚ã€èŒè´£å•ä¸€ã€ä¾èµ–å€’ç½®**çš„æ¶æ„è®¾è®¡ï¼Œé€šè¿‡äº”å±‚æ¶æ„å®ç°é«˜å†…èšä½è€¦åˆï¼Œç¡®ä¿æ¡†æ¶çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### è®¾è®¡åŸåˆ™

1. **åˆ†å±‚éš”ç¦»**: æ¯å±‚èŒè´£æ˜ç¡®ï¼Œé«˜å±‚å¯ä¾èµ–ä½å±‚ï¼Œåä¹‹ä¸è¡Œ
2. **ä¾èµ–å€’ç½®**: æ ¸å¿ƒå±‚å®šä¹‰æŠ½è±¡ï¼Œä¸Šå±‚ä¾èµ–æŠ½è±¡è€Œéå®ç°
3. **äº‹ä»¶é©±åŠ¨**: é€šè¿‡ EventBus è§£è€¦ç»„ä»¶é—´é€šä¿¡
4. **å¼‚æ­¥ä¼˜å…ˆ**: v4.0.0 å…¨é¢æ”¯æŒå¼‚æ­¥ï¼Œæ€§èƒ½æå‡ 2-30 å€
5. **å‘åå…¼å®¹**: åŒæ­¥ API å®Œå…¨ä¿ç•™ï¼Œå¹³æ»‘å‡çº§

---

## ğŸ—ï¸ äº”å±‚æ¶æ„

```
Layer 4 â”€â”€â”€ bootstrap/          # å¼•å¯¼å±‚ï¼šBootstrapã€Providersã€Runtime
Layer 3 â”€â”€â”€ testing/ + cli/     # é—¨é¢å±‚ï¼šFixturesã€CLI å·¥å…·ã€è„šæ‰‹æ¶
Layer 2 â”€â”€â”€ capabilities/       # èƒ½åŠ›å±‚ï¼šHTTP/UI/DB/MQ/Storage
Layer 1 â”€â”€â”€ infrastructure/     # åŸºç¡€è®¾æ–½ï¼šconfig/logging/events/plugins
Layer 0 â”€â”€â”€ core/               # æ ¸å¿ƒå±‚ï¼šçº¯æŠ½è±¡ï¼ˆæ— ä¾èµ–ï¼‰
æ¨ªåˆ‡ â”€â”€â”€â”€â”€ plugins/             # æ’ä»¶ï¼šMonitoringPluginã€AllurePlugin
```

### ä¾èµ–è§„åˆ™

- âœ… **å‘ä¸‹ä¾èµ–**: Layer 4 å¯ä¾èµ– 0-3ï¼ŒLayer 3 å¯ä¾èµ– 0-2ï¼Œä»¥æ­¤ç±»æ¨
- âŒ **ç¦æ­¢å‘ä¸Šä¾èµ–**: Layer 0 ä¸ä¾èµ–ä»»ä½•å±‚ï¼ŒLayer 1 åªèƒ½ä¾èµ– Layer 0
- âœ… **æ¨ªåˆ‡ç‹¬ç«‹**: Plugins å¯ä¾èµ–æ‰€æœ‰å±‚ï¼Œæä¾›è·¨å±‚èƒ½åŠ›å¢å¼º

---

## ğŸ“¦ å„å±‚èŒè´£

### Layer 0: Core æ ¸å¿ƒå±‚

**èŒè´£**: å®šä¹‰çº¯æŠ½è±¡å’Œåè®®ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–

**åŒ…å«**:
- `protocols/` - å®¢æˆ·ç«¯ã€äº‹ä»¶ã€æ’ä»¶ã€ä»“åº“ç­‰åè®®å®šä¹‰
- `middleware/` - ä¸­é—´ä»¶åŸºç±»å’Œé“¾å¼è°ƒç”¨æœºåˆ¶
- `context/` - æ‰§è¡Œä¸Šä¸‹æ–‡å’Œä¼ æ’­æœºåˆ¶
- `events/` - äº‹ä»¶ç±»å‹å®šä¹‰ï¼ˆHTTP/DB/æµ‹è¯•äº‹ä»¶ï¼‰
- `models/` - åŸºç¡€æ•°æ®æ¨¡å‹ï¼ˆBaseRequest/BaseResponseï¼‰
- `exceptions.py` - å¼‚å¸¸ä½“ç³»
- `types.py` - ç±»å‹å®šä¹‰å’Œæšä¸¾

**è®¾è®¡ç†å¿µ**: çº¯æŠ½è±¡ï¼Œä¸ºä¸Šå±‚æä¾›å¥‘çº¦

---

### Layer 1: Infrastructure åŸºç¡€è®¾æ–½å±‚

**èŒè´£**: æä¾›é…ç½®ã€æ—¥å¿—ã€äº‹ä»¶ã€æ’ä»¶ç­‰åŸºç¡€èƒ½åŠ›

**åŒ…å«**:
- `config/` - Pydantic é…ç½®æ¨¡å‹ + YAML åˆ†å±‚é…ç½®
- `logging/` - structlog + OpenTelemetry é›†æˆ
- `events/` - EventBus å‘å¸ƒ-è®¢é˜…å®ç°
- `telemetry/` - OpenTelemetry è¿½è¸ªé›†æˆ
- `plugins/` - Pluggy æ’ä»¶ç³»ç»Ÿ
- `sanitize/` - æ•æ„Ÿä¿¡æ¯è„±æ•æœåŠ¡
- `resilience/` - ç†”æ–­å™¨ç­‰å®¹é”™æœºåˆ¶
- `metrics/` - æ€§èƒ½æŒ‡æ ‡æ”¶é›†

**è®¾è®¡ç†å¿µ**: æ¨ªå‘æ”¯æ’‘ï¼Œä¸ºæ‰€æœ‰å±‚æä¾›åŸºç¡€æœåŠ¡

---

### Layer 2: Capabilities èƒ½åŠ›å±‚

**èŒè´£**: ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„å…·ä½“å®ç°

**åŒ…å«**:
- `clients/` - HTTP/GraphQL/gRPC å®¢æˆ·ç«¯
  - `http/` - **AsyncHttpClient** (v4.0+) / HttpClient (v2.0+)
  - `graphql/` - GraphQL æŸ¥è¯¢æ‰§è¡Œ
  - `grpc/` - gRPC æœåŠ¡è°ƒç”¨
- `databases/` - æ•°æ®åº“è®¿é—®
  - **AsyncDatabase** (v4.0+) / Database (v2.0+)
  - Repository æ¨¡å¼ã€Unit of Work æ¨¡å¼
- `drivers/` - UI è‡ªåŠ¨åŒ–é©±åŠ¨
  - **AsyncAppActions** (v4.0+) / AppActions (v3.0+)
  - **AsyncBasePage** (v4.0+) / BasePage (v3.0+)
  - BaseComponent ç»„ä»¶æ¨¡å¼
- `messengers/` - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQ/RocketMQï¼‰
- `storages/` - å¯¹è±¡å­˜å‚¨ï¼ˆLocalFile/S3/OSSï¼‰
- `engines/` - æ•°æ®å¤„ç†å¼•æ“ï¼ˆé¢„ç•™ï¼‰

**è®¾è®¡ç†å¿µ**: èƒ½åŠ›èšåˆï¼Œæ¯ä¸ªæ¨¡å—è§£å†³ä¸€ç±»å¤–éƒ¨äº¤äº’é—®é¢˜

---

### Layer 3: Testing + CLI é—¨é¢å±‚

**èŒè´£**: ä¸ºæµ‹è¯•å¼€å‘æä¾›ä¾¿æ·çš„å·¥å…·å’Œæ¥å£

**åŒ…å«**:

**testing/** - æµ‹è¯•æ”¯æŒ
- `fixtures/` - Pytest Fixturesï¼ˆasync_http_client, async_database, etc.ï¼‰
- `decorators/` - ç±»å’Œæ–¹æ³•è£…é¥°å™¨ï¼ˆ@api_class, @actions_classï¼‰
- `data/` - æµ‹è¯•æ•°æ®ç®¡ç†
  - `builders/` - Builder æ¨¡å¼
  - `factories/` - Factory æ¨¡å¼ï¼ˆv3.31+ï¼‰
  - `generators/` - éšæœºæ•°æ®ç”Ÿæˆ
  - `loaders/` - YAML/JSON/CSV åŠ è½½
- `assertions/` - æ–­è¨€å·¥å…·ï¼ˆSchemaValidator, åŒ¹é…å™¨ï¼‰
- `mocking/` - Mock å·¥å…·
- `debugging/` - è°ƒè¯•å·¥å…·ï¼ˆConsoleDebugObserverï¼‰
- `reporting/` - Allure æŠ¥å‘Šé›†æˆ

**cli/** - å‘½ä»¤è¡Œå·¥å…·
- `commands/` - df-test å‘½ä»¤é›†ï¼ˆinit, gen, envï¼‰
- `templates/` - é¡¹ç›®å’Œä»£ç æ¨¡æ¿

**è®¾è®¡ç†å¿µ**: ç®€åŒ–ä½¿ç”¨ï¼Œæä¾›æœ€ä½³å®è·µ

---

### Layer 4: Bootstrap å¼•å¯¼å±‚

**èŒè´£**: æ¡†æ¶åˆå§‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€è¿è¡Œæ—¶ç»„è£…

**åŒ…å«**:
- `bootstrap.py` - Bootstrap åˆå§‹åŒ–å™¨
- `providers.py` - Provider ä¾èµ–æ³¨å…¥
- `runtime.py` - RuntimeContext è¿è¡Œæ—¶ç®¡ç†

**è®¾è®¡ç†å¿µ**: ç‰¹æƒå±‚ï¼Œå¯ä¾èµ–æ‰€æœ‰å±‚ï¼Œè´Ÿè´£ç»„è£…æ•´ä¸ªæ¡†æ¶

---

### æ¨ªåˆ‡å…³æ³¨ç‚¹: Plugins æ’ä»¶

**èŒè´£**: è·¨å±‚çº§çš„åŠŸèƒ½å¢å¼º

**åŒ…å«**:
- `builtin/monitoring/` - MonitoringPluginï¼ˆæ€§èƒ½ç›‘æ§ï¼‰
- `builtin/reporting/` - AllurePluginï¼ˆæŠ¥å‘Šç”Ÿæˆï¼‰

**è®¾è®¡ç†å¿µ**: é€šè¿‡ Pluggy Hooks å®ç°å¯æ’æ‹”çš„åŠŸèƒ½å¢å¼º

---

## ğŸš€ v4.0.0 é‡å¤§å˜æ›´

### 1. å…¨é¢å¼‚æ­¥åŒ–

**æ ¸å¿ƒå¼‚æ­¥ç»„ä»¶**:
- âœ… **AsyncHttpClient** - åŸºäº httpx.AsyncClient
  - æ€§èƒ½æå‡ï¼šå¹¶å‘ 100 è¯·æ±‚ä» 30 ç§’ â†’ 1 ç§’ï¼ˆ**30 å€**ï¼‰
  - æ”¯æŒ HTTP/2ã€è¿æ¥æ± ã€å¹¶å‘æ§åˆ¶
  - å®Œå…¨å…¼å®¹ä¸­é—´ä»¶ç³»ç»Ÿ

- âœ… **AsyncDatabase** - åŸºäº SQLAlchemy 2.0 AsyncEngine
  - æ€§èƒ½æå‡ï¼šæ•°æ®åº“æ“ä½œ **5-10 å€**
  - æ”¯æŒ MySQL (aiomysql), PostgreSQL (asyncpg), SQLite (aiosqlite)
  - async with ä¸Šä¸‹æ–‡ç®¡ç†å™¨

- âœ… **AsyncRedis** - åŸºäº redis.asyncio
  - æ€§èƒ½æå‡ï¼šç¼“å­˜æ“ä½œ **5-10 å€**
  - å®Œæ•´çš„å¼‚æ­¥æ“ä½œæ”¯æŒ

- âœ… **AsyncAppActions + AsyncBasePage** - åŸºäº playwright.async_api
  - æ€§èƒ½æå‡ï¼šUI æµ‹è¯• **2-3 å€**
  - æ›´å¥½çš„èµ„æºç®¡ç†

**å‘åå…¼å®¹ç­–ç•¥**:
- âœ… åŒæ­¥ API å®Œå…¨ä¿ç•™ï¼ˆHttpClient, Database, AppActionsï¼‰
- âœ… Fixtures åŒæ—¶æä¾›åŒæ­¥å’Œå¼‚æ­¥ç‰ˆæœ¬
- âœ… å‡çº§è·¯å¾„ï¼šæ¸è¿›å¼è¿ç§»ï¼Œæ— éœ€ä¸€æ¬¡æ€§é‡å†™

### 2. æ¶æ„ä¼˜åŒ–

- âœ… **Layer 4 Bootstrap å¼•å¯¼å±‚** (v3.16)
  - è§£å†³ä¾èµ–è¿è§„é—®é¢˜
  - æ¸…æ™°çš„åˆå§‹åŒ–æµç¨‹

- âœ… **ä¸­é—´ä»¶ç³»ç»Ÿç»Ÿä¸€** (v3.14-v3.16)
  - ç§»é™¤ Interceptorï¼Œç»Ÿä¸€ä¸º Middleware
  - æ´‹è‘±æ¨¡å‹ï¼Œæ”¯æŒè¯·æ±‚/å“åº”æ‹¦æˆª

- âœ… **äº‹ä»¶ç³»ç»Ÿé‡æ„** (v3.17)
  - correlation_id å…³è”è¿½è¸ª
  - æµ‹è¯•éš”ç¦»ï¼ˆContextVarï¼‰
  - AllureObserver è‡ªåŠ¨é›†æˆ

### 3. å¯è§‚æµ‹æ€§å¢å¼º

- âœ… **OpenTelemetry æ·±åº¦é›†æˆ**
  - trace_id/span_id è‡ªåŠ¨æ³¨å…¥
  - W3C TraceContext ä¼ æ’­
  - Jaeger/Zipkin/Tempo æ”¯æŒ

- âœ… **Structured Logging** (v3.38)
  - structlog é›†æˆ
  - è‡ªåŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥

- âœ… **ç»Ÿä¸€è„±æ•æœåŠ¡** (v3.40)
  - æ—¥å¿—ã€Consoleã€Allure ç»Ÿä¸€è„±æ•
  - partial/full/hash ä¸‰ç§ç­–ç•¥

---

## ğŸ”„ æ•°æ®æµ

### HTTP è¯·æ±‚æµç¨‹

```
æµ‹è¯•ç”¨ä¾‹
  â†“
@api_class è£…é¥°å™¨åŠ è½½
  â†“
BaseAPI.request()
  â†“
ä¸­é—´ä»¶é“¾ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰
  â”œâ”€ SignatureMiddleware (ç­¾å)
  â”œâ”€ BearerTokenMiddleware (è®¤è¯)
  â”œâ”€ RetryMiddleware (é‡è¯•)
  â”œâ”€ LoggingMiddleware (æ—¥å¿—)
  â””â”€ HttpTelemetryMiddleware (è¿½è¸ª)
  â†“
AsyncHttpClient.request()
  â†“
httpx.AsyncClient
  â†“
EventBus å‘å¸ƒ HttpRequestStartEvent
  â†“
å¤–éƒ¨ API
  â†“
EventBus å‘å¸ƒ HttpRequestEndEvent
  â†“
AllureObserver è‡ªåŠ¨è®°å½•
  â†“
è¿”å› Response
```

### UI æµ‹è¯•æµç¨‹

```
æµ‹è¯•ç”¨ä¾‹
  â†“
@actions_class è£…é¥°å™¨åŠ è½½
  â†“
AsyncAppActions.goto()
  â†“
EventBus å‘å¸ƒ WebNavigationStartEvent
  â†“
playwright.async_api.Page
  â†“
EventBus å‘å¸ƒ WebNavigationEndEvent
  â†“
AllureObserver è‡ªåŠ¨æˆªå›¾
  â†“
æµ‹è¯•ç»§ç»­
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | åŒæ­¥ç‰ˆæœ¬ | å¼‚æ­¥ç‰ˆæœ¬ | æå‡ |
|------|---------|---------|------|
| **100 å¹¶å‘ HTTP è¯·æ±‚** | 30 ç§’ | 1 ç§’ | **30x** |
| **æ•°æ®åº“æ‰¹é‡æŸ¥è¯¢** | 10 ç§’ | 1.5 ç§’ | **6-7x** |
| **Redis æ‰¹é‡æ“ä½œ** | 5 ç§’ | 0.8 ç§’ | **6x** |
| **UI è‡ªåŠ¨åŒ–æµ‹è¯•** | 120 ç§’ | 50 ç§’ | **2.4x** |

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. æ¸…æ™°çš„èŒè´£åˆ’åˆ†
- æ¯å±‚èŒè´£æ˜ç¡®ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- æ–°åŠŸèƒ½å¼€å‘æ—¶å¿«é€Ÿå®šä½åº”è¯¥æ”¾åœ¨å“ªä¸€å±‚

### 2. è‰¯å¥½çš„å¯æ‰©å±•æ€§
- é€šè¿‡åè®®å®šä¹‰å®ç°ä¾èµ–å€’ç½®
- Pluggy æ’ä»¶ç³»ç»Ÿæ”¯æŒç¬¬ä¸‰æ–¹æ‰©å±•
- EventBus æ”¯æŒæ¾è€¦åˆçš„åŠŸèƒ½å¢å¼º

### 3. é«˜æ€§èƒ½
- å¼‚æ­¥ä¼˜å…ˆè®¾è®¡ï¼Œå……åˆ†åˆ©ç”¨ Python 3.12+ asyncio
- è¿æ¥æ± ã€å¹¶å‘æ§åˆ¶ç­‰ä¼˜åŒ–
- æ€§èƒ½æå‡ 2-30 å€

### 4. å®Œæ•´çš„å¯è§‚æµ‹æ€§
- OpenTelemetry è¿½è¸ª
- Structured Logging
- EventBus äº‹ä»¶æµ
- Allure æŠ¥å‘Šè‡ªåŠ¨é›†æˆ

### 5. å‘åå…¼å®¹
- åŒæ­¥ API å®Œå…¨ä¿ç•™
- æ¸è¿›å¼å‡çº§è·¯å¾„
- é™ä½è¿ç§»æˆæœ¬

---

## ğŸ“š è¿›ä¸€æ­¥é˜…è¯»

- **[äº”å±‚æ¶æ„è¯¦è§£](./äº”å±‚æ¶æ„è¯¦è§£.md)** - æ¯å±‚çš„è¯¦ç»†è¯´æ˜
- **[ä¸­é—´ä»¶ç³»ç»Ÿè®¾è®¡](./MIDDLEWARE_V3.14_DESIGN.md)** - æ´‹è‘±æ¨¡å‹å®ç°
- **[å¯è§‚æµ‹æ€§æ¶æ„](./observability-architecture.md)** - EventBus + OpenTelemetry
- **[æ’ä»¶ç³»ç»Ÿ](./PLUGIN_SYSTEM_V3.37.md)** - Pluggy é›†æˆ
- **[æµ‹è¯•æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ](./TEST_EXECUTION_LIFECYCLE.md)** - ä»åˆå§‹åŒ–åˆ°æŠ¥å‘Šç”Ÿæˆ

---

**ç‰ˆæœ¬å†å²**:
- v4.0.0 (2026-01-16): å…¨é¢å¼‚æ­¥åŒ–
- v3.17.0 (2025-12-05): äº‹ä»¶ç³»ç»Ÿé‡æ„
- v3.16.0 (2025-12-03): Layer 4 Bootstrap å¼•å¯¼å±‚
- v3.14.0 (2025-11-28): ä¸­é—´ä»¶ç³»ç»Ÿç»Ÿä¸€

**å½’æ¡£æ–‡æ¡£**: [æ¶æ„å†å²ç‰ˆæœ¬](./archive/versions/)
