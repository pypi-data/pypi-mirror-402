# DF Test Framework äº”å±‚æ¶æ„è¯¦è§£

> **æœ€åæ›´æ–°**: 2026-01-16
> **é€‚ç”¨ç‰ˆæœ¬**: v4.0.0+
> **å‰ç½®é˜…è¯»**: [v4.0 æ¶æ„æ€»è§ˆ](./ARCHITECTURE_V4.0.md)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ DF Test Framework çš„äº”å±‚æ¶æ„è®¾è®¡ï¼ŒåŒ…å«æ¯ä¸€å±‚çš„èŒè´£ã€åŒ…å«çš„æ¨¡å—ã€å…³é”®ç±»å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

**æ¶æ„å±‚çº§**:
```
Layer 4 â”€â”€â”€ bootstrap/          # å¼•å¯¼å±‚
Layer 3 â”€â”€â”€ testing/ + cli/     # é—¨é¢å±‚
Layer 2 â”€â”€â”€ capabilities/       # èƒ½åŠ›å±‚
Layer 1 â”€â”€â”€ infrastructure/     # åŸºç¡€è®¾æ–½å±‚
Layer 0 â”€â”€â”€ core/               # æ ¸å¿ƒå±‚
æ¨ªåˆ‡ â”€â”€â”€â”€â”€ plugins/             # æ’ä»¶å±‚
```

**ä¾èµ–è§„åˆ™**:
- âœ… é«˜å±‚å¯ä¾èµ–ä½å±‚ï¼Œåä¹‹ä¸è¡Œ
- âœ… Layer 0 æ— ä»»ä½•ç¬¬ä¸‰æ–¹ä¾èµ–
- âœ… Plugins å¯ä¾èµ–æ‰€æœ‰å±‚

---

## ğŸ”· Layer 0: Core æ ¸å¿ƒå±‚

### èŒè´£

å®šä¹‰**çº¯æŠ½è±¡å’Œåè®®**ï¼Œä¸ºä¸Šå±‚æä¾›å¥‘çº¦ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚

### ç›®å½•ç»“æ„

```
core/
â”œâ”€â”€ protocols/      # åè®®å®šä¹‰ï¼ˆclient, event, plugin, repository, telemetryï¼‰
â”œâ”€â”€ middleware/     # ä¸­é—´ä»¶ç³»ç»Ÿï¼ˆbase, chain, decorator, protocolï¼‰
â”œâ”€â”€ context/        # ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ˆexecution, propagationï¼‰
â”œâ”€â”€ events/         # äº‹ä»¶ç±»å‹å®šä¹‰
â”œâ”€â”€ models/         # åŸºç¡€æ•°æ®æ¨¡å‹ï¼ˆBaseRequest, BaseResponseï¼‰
â”œâ”€â”€ decorators.py   # é€šç”¨è£…é¥°å™¨
â”œâ”€â”€ exceptions.py   # å¼‚å¸¸ä½“ç³»
â””â”€â”€ types.py        # ç±»å‹å®šä¹‰å’Œæšä¸¾
```

### å…³é”®ç»„ä»¶

**1. åè®®å®šä¹‰ï¼ˆprotocols/ï¼‰** - ä¾èµ–åè½¬åŸºç¡€

```python
from typing import Protocol

class HttpClientProtocol(Protocol):
    """HTTP å®¢æˆ·ç«¯åè®®"""
    def request(self, method: str, url: str, **kwargs) -> Response:
        ...
```

**2. ä¸­é—´ä»¶ç³»ç»Ÿï¼ˆmiddleware/ï¼‰** - æ´‹è‘±æ¨¡å‹

```python
from df_test_framework.core.middleware import BaseMiddleware

class CustomMiddleware(BaseMiddleware):
    async def __call__(self, request, call_next):
        # è¯·æ±‚å‰å¤„ç†
        print(f"Before: {request.url}")

        # æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶
        response = await call_next(request)

        # å“åº”åå¤„ç†
        print(f"After: {response.status_code}")
        return response
```

**3. äº‹ä»¶ç±»å‹ï¼ˆevents/ï¼‰**

ä¸»è¦äº‹ä»¶ï¼š
- `HttpRequestStartEvent` / `HttpRequestEndEvent`
- `DatabaseQueryEvent`
- `TestStartEvent` / `TestEndEvent`

### è®¾è®¡åŸåˆ™

1. âœ… æ— ç¬¬ä¸‰æ–¹ä¾èµ–
2. âœ… çº¯æŠ½è±¡ï¼Œåªå®šä¹‰æ¥å£
3. âœ… æ¥å£ç¨³å®šï¼Œå‘ä¸‹å…¼å®¹

---

## ğŸ”· Layer 1: Infrastructure åŸºç¡€è®¾æ–½å±‚

### èŒè´£

æä¾›**æ¨ªå‘æ”¯æ’‘èƒ½åŠ›**ï¼šé…ç½®ã€æ—¥å¿—ã€äº‹ä»¶ã€æ’ä»¶ç­‰ã€‚

### ç›®å½•ç»“æ„

```
infrastructure/
â”œâ”€â”€ config/         # é…ç½®ç³»ç»Ÿï¼ˆschema, registry, loadersï¼‰
â”œâ”€â”€ logging/        # æ—¥å¿—ç³»ç»Ÿï¼ˆstructlog é…ç½®ï¼‰
â”œâ”€â”€ events/         # äº‹ä»¶æ€»çº¿ï¼ˆEventBus å®ç°ï¼‰
â”œâ”€â”€ telemetry/      # å¯è§‚æµ‹æ€§ï¼ˆOpenTelemetryï¼‰
â”œâ”€â”€ plugins/        # æ’ä»¶ç³»ç»Ÿï¼ˆPluggyï¼‰
â”œâ”€â”€ sanitize/       # è„±æ•æœåŠ¡
â”œâ”€â”€ resilience/     # å®¹é”™æœºåˆ¶ï¼ˆç†”æ–­å™¨ï¼‰
â””â”€â”€ metrics/        # æ€§èƒ½æŒ‡æ ‡
```

### å…³é”®ç»„ä»¶

**1. é…ç½®ç³»ç»Ÿï¼ˆconfig/ï¼‰**

```python
from df_test_framework.infrastructure.config import ConfigRegistry

registry = ConfigRegistry()
registry.load_from_yaml("config/base.yaml")
registry.load_from_env()

http_config = registry.get("http")
```

**é…ç½®ç»§æ‰¿**:
```yaml
# config/environments/dev.yaml
_extends: base.yaml

http:
  base_url: https://dev-api.example.com
```

**2. EventBus äº‹ä»¶æ€»çº¿ï¼ˆevents/ï¼‰**

```python
from df_test_framework.infrastructure.events import get_global_event_bus
from df_test_framework.core.events.types import HttpRequestEndEvent

def on_request_end(event: HttpRequestEndEvent):
    print(f"è¯·æ±‚è€—æ—¶: {event.duration}s")

bus = get_global_event_bus()
bus.subscribe(HttpRequestEndEvent, on_request_end)
```

**3. Logging æ—¥å¿—ç³»ç»Ÿï¼ˆlogging/ï¼‰**

```python
from df_test_framework.infrastructure.logging import get_logger

logger = get_logger(__name__)
logger.info("user_created", user_id=123)  # è‡ªåŠ¨åŒ…å« trace_id
```

### è®¾è®¡åŸåˆ™

1. âœ… æ¨ªå‘æ”¯æ’‘æ‰€æœ‰å±‚
2. âœ… å¯é…ç½®åŒ–
3. âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§

---

## ğŸ”· Layer 2: Capabilities èƒ½åŠ›å±‚

### èŒè´£

ä¸**å¤–éƒ¨ç³»ç»Ÿäº¤äº’**çš„å…·ä½“å®ç°ï¼ŒæŒ‰äº¤äº’æ¨¡å¼ç»„ç»‡ã€‚

### ç›®å½•ç»“æ„

```
capabilities/
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ http/           # HTTP å®¢æˆ·ç«¯ï¼ˆAsyncHttpClient / HttpClientï¼‰
â”‚   â”œâ”€â”€ graphql/        # GraphQL å®¢æˆ·ç«¯
â”‚   â””â”€â”€ grpc/           # gRPC å®¢æˆ·ç«¯
â”œâ”€â”€ databases/          # æ•°æ®åº“ï¼ˆAsyncDatabase / Database, Repository, UoWï¼‰
â”œâ”€â”€ drivers/web/        # UI é©±åŠ¨ï¼ˆAsyncAppActions / AppActionsï¼‰
â”œâ”€â”€ messengers/         # æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQ/RocketMQï¼‰
â””â”€â”€ storages/           # å¯¹è±¡å­˜å‚¨ï¼ˆLocalFile/S3/OSSï¼‰
```

### å…³é”®ç»„ä»¶

**1. HTTP å®¢æˆ·ç«¯ï¼ˆclients/http/ï¼‰**

**AsyncHttpClient (v4.0+, æ¨è)**:
```python
from df_test_framework.capabilities.clients.http import AsyncHttpClient

async def test_concurrent_requests():
    async with AsyncHttpClient("https://api.example.com") as client:
        # å¹¶å‘ 100 ä¸ªè¯·æ±‚ï¼ˆä»…éœ€ 1 ç§’ï¼ï¼‰
        tasks = [client.get(f"/users/{i}") for i in range(100)]
        responses = await asyncio.gather(*tasks)

        assert len(responses) == 100
```

**BaseAPI / AsyncBaseAPI**:
```python
from df_test_framework.capabilities.clients.http import AsyncBaseAPI
from df_test_framework.testing import api_class

@api_class()
class UserAPI(AsyncBaseAPI):
    async def get_user(self, user_id: int):
        return await self.get(f"/users/{user_id}")

    async def create_user(self, data: dict):
        return await self.post("/users", json=data)

# æµ‹è¯•ä¸­ä½¿ç”¨ï¼ˆè‡ªåŠ¨åŠ è½½ä¸º fixtureï¼‰
async def test_user_api(user_api: UserAPI):
    user = await user_api.get_user(1)
    assert user.data["id"] == 1
```

**2. æ•°æ®åº“è®¿é—®ï¼ˆdatabases/ï¼‰**

**AsyncDatabase (v4.0+, æ¨è)**:
```python
from df_test_framework.capabilities.databases import AsyncDatabase

async def test_user_query(async_database: AsyncDatabase):
    async with async_database.session() as session:
        result = await session.execute(
            "SELECT * FROM users WHERE id = :id",
            {"id": 1}
        )
        user = result.fetchone()
        assert user.name == "John"
```

**Repository æ¨¡å¼**:
```python
from df_test_framework.capabilities.databases import BaseRepository

class UserRepository(BaseRepository[User]):
    async def find_by_email(self, email: str) -> User | None:
        return await self.query_one({"email": email})

# ä½¿ç”¨
async def test_user_repo(user_repository: UserRepository):
    user = await user_repository.find_by_email("john@example.com")
    assert user.name == "John"
```

**3. UI é©±åŠ¨ï¼ˆdrivers/web/ï¼‰**

**AsyncAppActions + AsyncBasePage (v4.0+, æ¨è)**:
```python
from df_test_framework.capabilities.drivers.web import AsyncAppActions, AsyncBasePage
from df_test_framework.testing import actions_class

class LoginPage(AsyncBasePage):
    async def login(self, username: str, password: str):
        await self.fill_input("#username", username)
        await self.fill_input("#password", password)
        await self.click("#login-btn")
        await self.wait_for_url("/dashboard")

@actions_class()
class AppActions(AsyncAppActions):
    async def login_as_admin(self):
        login_page = LoginPage(self.page)
        await login_page.login("admin", "password")

# æµ‹è¯•ä¸­ä½¿ç”¨
async def test_login(app_actions: AppActions):
    await app_actions.login_as_admin()
```

### è®¾è®¡åŸåˆ™

1. âœ… å¼‚æ­¥ä¼˜å…ˆï¼ˆv4.0+ï¼‰
2. âœ… å‘åå…¼å®¹ï¼ˆåŒæ­¥ç‰ˆæœ¬ä¿ç•™ï¼‰
3. âœ… å®ç° Layer 0 åè®®

---

## ğŸ”· Layer 3: Testing + CLI é—¨é¢å±‚

### èŒè´£

ä¸ºæµ‹è¯•å¼€å‘æä¾›**ä¾¿æ·å·¥å…·å’Œæœ€ä½³å®è·µ**ã€‚

### ç›®å½•ç»“æ„

```
testing/
â”œâ”€â”€ fixtures/       # Pytest Fixtures
â”œâ”€â”€ decorators.py   # @api_class, @actions_class
â”œâ”€â”€ data/           # æµ‹è¯•æ•°æ®ï¼ˆbuilders, factories, generators, loadersï¼‰
â”œâ”€â”€ assertions/     # æ–­è¨€å·¥å…·ï¼ˆSchemaValidator, åŒ¹é…å™¨ï¼‰
â”œâ”€â”€ mocking/        # Mock å·¥å…·
â”œâ”€â”€ debugging/      # è°ƒè¯•å·¥å…·
â””â”€â”€ reporting/      # Allure é›†æˆ

cli/
â”œâ”€â”€ commands/       # CLI å‘½ä»¤ï¼ˆinit, gen, envï¼‰
â””â”€â”€ templates/      # é¡¹ç›®å’Œä»£ç æ¨¡æ¿
```

### å…³é”®ç»„ä»¶

**1. Fixturesï¼ˆfixtures/ï¼‰**

ä¸»è¦ Fixtures:
- `async_http_client` / `http_client`
- `async_database` / `database`
- `async_redis_client` / `redis_client`
- `browser_manager` / `async_browser_manager`
- `page` - Playwright Page
- `runtime` - è¿è¡Œæ—¶ä¸Šä¸‹æ–‡

**2. è£…é¥°å™¨ï¼ˆdecorators.pyï¼‰**

**@api_class()** - è‡ªåŠ¨åŠ è½½ BaseAPI ä¸º fixture:
```python
@api_class()
class UserAPI(AsyncBaseAPI):
    async def get_user(self, user_id: int):
        return await self.get(f"/users/{user_id}")

# è‡ªåŠ¨ç”Ÿæˆ user_api fixtureï¼ˆscope=sessionï¼‰
```

**@actions_class()** - è‡ªåŠ¨åŠ è½½ AppActions ä¸º fixture:
```python
@actions_class()
class AppActions(AsyncAppActions):
    async def login_as_admin(self):
        # ...

# è‡ªåŠ¨ç”Ÿæˆ app_actions fixtureï¼ˆscope=functionï¼‰
```

**3. æµ‹è¯•æ•°æ®ï¼ˆdata/ï¼‰**

**Factory æ¨¡å¼**:
```python
from df_test_framework.testing.data.factories import DataFactory

class UserFactory(DataFactory):
    class Meta:
        model = User

    name = "John Doe"
    email = LazyAttribute(lambda o: f"{o.name.lower()}@example.com")
    age = Sequence(lambda n: 20 + n)

# ä½¿ç”¨
user = UserFactory.build()
users = UserFactory.build_batch(10)
```

**4. CLI å·¥å…·ï¼ˆcli/ï¼‰**

```bash
# é¡¹ç›®åˆå§‹åŒ–
df-test init my-project --type api
df-test init my-project --type ui
df-test init my-project --type full

# ä»£ç ç”Ÿæˆ
df-test gen test --name user
df-test gen builder --name Order
df-test gen api --name User
```

### è®¾è®¡åŸåˆ™

1. âœ… å¼€ç®±å³ç”¨
2. âœ… å¼•å¯¼æœ€ä½³å®è·µ
3. âœ… æ”¯æŒå®šåˆ¶æ‰©å±•

---

## ğŸ”· Layer 4: Bootstrap å¼•å¯¼å±‚

### èŒè´£

**æ¡†æ¶åˆå§‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€è¿è¡Œæ—¶ç»„è£…**ã€‚

### ç›®å½•ç»“æ„

```
bootstrap/
â”œâ”€â”€ bootstrap.py    # Bootstrap åˆå§‹åŒ–å™¨
â”œâ”€â”€ providers.py    # Provider ä¾èµ–æ³¨å…¥
â””â”€â”€ runtime.py      # RuntimeContext
```

### å…³é”®ç»„ä»¶

**Bootstrap åˆå§‹åŒ–å™¨**:
```python
from df_test_framework import Bootstrap, FrameworkSettings

class MySettings(FrameworkSettings):
    api_base_url: str = "https://api.example.com"

runtime = (
    Bootstrap()
    .with_settings(MySettings)
    .with_plugins([MyPlugin()])
    .build()
    .run()
)

# è·å–æœåŠ¡
http_client = runtime.http_client()
database = runtime.database()
```

**Provider ä¾èµ–æ³¨å…¥**:
```python
from df_test_framework.bootstrap import Provider

class CustomProvider(Provider):
    def provide_http_client(self, config):
        return MyCustomHttpClient(config)

Bootstrap().with_providers([CustomProvider()])
```

### è®¾è®¡åŸåˆ™

1. âœ… ç‰¹æƒå±‚ï¼Œå¯ä¾èµ–æ‰€æœ‰å±‚
2. âœ… ç»Ÿä¸€å…¥å£
3. âœ… å¯æ‰©å±•

---

## ğŸ”· æ¨ªåˆ‡å…³æ³¨ç‚¹: Plugins æ’ä»¶å±‚

### èŒè´£

**è·¨å±‚çº§åŠŸèƒ½å¢å¼º**ï¼Œé€šè¿‡ Pluggy Hooks å®ç°ã€‚

### ç›®å½•ç»“æ„

```
plugins/
â””â”€â”€ builtin/
    â”œâ”€â”€ monitoring/     # MonitoringPlugin
    â””â”€â”€ reporting/      # AllurePlugin
```

### å…³é”®ç»„ä»¶

**AllurePlugin** - è‡ªåŠ¨è®°å½• HTTP/DB/UI äº‹ä»¶

**MonitoringPlugin** - æ€§èƒ½ç›‘æ§å’Œ OpenTelemetry é›†æˆ

### è®¾è®¡åŸåˆ™

1. âœ… å¯æ’æ‹”
2. âœ… è·¨å±‚å¢å¼º
3. âœ… æ— ä¾µå…¥

---

## ğŸ“Š æ¶æ„æœ€ä½³å®è·µ

### 1. æ–°åŠŸèƒ½åº”è¯¥æ”¾åœ¨å“ªä¸€å±‚ï¼Ÿ

| åŠŸèƒ½ç±»å‹ | æ¨èå±‚çº§ | ç¤ºä¾‹ |
|---------|---------|------|
| å®šä¹‰æ–°çš„æŠ½è±¡åè®® | Layer 0 | å®šä¹‰æ–°çš„å®¢æˆ·ç«¯åè®® |
| æ·»åŠ é…ç½®é¡¹ | Layer 1 | æ–°å¢é…ç½®æ¨¡å‹ |
| ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ | Layer 2 | æ–°å¢ Elasticsearch å®¢æˆ·ç«¯ |
| æµ‹è¯•è¾…åŠ©å·¥å…· | Layer 3 | æ–°å¢æ•°æ®ç”Ÿæˆå™¨ |
| è·¨å±‚åŠŸèƒ½å¢å¼º | Plugins | æ–°å¢æ€§èƒ½åˆ†ææ’ä»¶ |

### 2. å¦‚ä½•éµå¾ªä¾èµ–è§„åˆ™ï¼Ÿ

âœ… **æ­£ç¡®ç¤ºä¾‹**:
```python
# Layer 2 ä¾èµ– Layer 0 çš„åè®®
from df_test_framework.core.protocols import HttpClientProtocol  # âœ…

class MyHttpClient(HttpClientProtocol):
    ...
```

âŒ **é”™è¯¯ç¤ºä¾‹**:
```python
# Layer 0 ä¸èƒ½ä¾èµ– Layer 2
from df_test_framework.capabilities.clients.http import HttpClient  # âŒ
```

### 3. å¦‚ä½•æ‰©å±•æ¡†æ¶ï¼Ÿ

**æ–¹å¼ 1: ç»§æ‰¿åŸºç±»**
```python
from df_test_framework.capabilities.clients.http import AsyncBaseAPI

class MyAPI(AsyncBaseAPI):
    async def custom_method(self):
        ...
```

**æ–¹å¼ 2: å®ç°åè®®**
```python
from df_test_framework.core.protocols import HttpClientProtocol

class MyHttpClient(HttpClientProtocol):
    def request(self, method, url, **kwargs):
        ...
```

**æ–¹å¼ 3: å¼€å‘æ’ä»¶**
```python
from df_test_framework.plugins import Plugin

class MyPlugin(Plugin):
    @hookimpl
    def df_post_bootstrap(self, runtime):
        # è‡ªå®šä¹‰åˆå§‹åŒ–é€»è¾‘
        ...
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **[v4.0 æ¶æ„æ€»è§ˆ](./ARCHITECTURE_V4.0.md)** - æ¶æ„å…¨å±€è§†è§’
- **[ä¸­é—´ä»¶ç³»ç»Ÿè®¾è®¡](./MIDDLEWARE_V3.14_DESIGN.md)** - Layer 0 ä¸­é—´ä»¶è¯¦è§£
- **[å¯è§‚æµ‹æ€§æ¶æ„](./observability-architecture.md)** - Layer 1 EventBus è¯¦è§£
- **[æµ‹è¯•æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ](./TEST_EXECUTION_LIFECYCLE.md)** - ä»åˆå§‹åŒ–åˆ°æµ‹è¯•ç»“æŸ

---

**ç‰ˆæœ¬å†å²**:
- 2026-01-16: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäº v4.0.0 æ¶æ„
