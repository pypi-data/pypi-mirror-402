# DF Test Framework v3.17.0 äº‹ä»¶ç³»ç»Ÿé‡æ„è®¾è®¡

> **çŠ¶æ€**: âœ… å·²å®ç°
> **ä½œè€…**: Claude Code
> **æ—¥æœŸ**: 2025-12-05
> **ç›®æ ‡ç‰ˆæœ¬**: v3.17.0
> **å®ç°æ—¥æœŸ**: 2025-12-05

---

## 1. é—®é¢˜åˆ†æ

### 1.1 å½“å‰æ¶æ„é—®é¢˜

| é—®é¢˜ | ç°çŠ¶ | å½±å“ |
|------|------|------|
| **äº‹ä»¶æ— å”¯ä¸€æ ‡è¯†** | Event æ²¡æœ‰ event_id | æ— æ³•è¿½è¸ªã€å»é‡ã€å…³è” |
| **äº‹ä»¶å…³è”è„†å¼±** | ä½¿ç”¨ `method:url` ä½œä¸º correlation_id | å¹¶å‘è¯·æ±‚å†²çªï¼Œå…³è”å¤±è´¥ |
| **åŒæ­¥/å¼‚æ­¥æ··ä¹±** | ä¸¤å¥—å‘å¸ƒæ–¹æ³•ï¼Œè¡Œä¸ºä¸ä¸€è‡´ | äº‹ä»¶å¯èƒ½ä¸¢å¤±æˆ–é˜»å¡ |
| **EventBus å…¨å±€å•ä¾‹** | æ‰€æœ‰æµ‹è¯•å…±äº«ä¸€ä¸ª EventBus | æµ‹è¯•éš”ç¦»é—®é¢˜ï¼Œè®¢é˜…æ³„æ¼ |
| **äº‹ä»¶å¤„ç†æ— é¡ºåºä¿è¯** | asyncio.gather å¹¶å‘æ‰§è¡Œ | ä¾èµ–é¡ºåºçš„å¤„ç†å™¨å¯èƒ½å¤±è´¥ |
| **äº‹ä»¶è¦†ç›–ä¸å®Œæ•´** | åªæœ‰ HTTP å®Œæ•´å®ç° | Database/Redis/MQ æœªé€šè¿‡äº‹ä»¶é›†æˆ |
| **Telemetry æœªå…³è”** | EventBus ä¸ Telemetry ç‹¬ç«‹ | æ— æ³•è‡ªåŠ¨ç”Ÿæˆ Trace/Metrics |

### 1.2 èƒ½åŠ›å±‚äº‹ä»¶è¦†ç›–ç°çŠ¶

| æ¨¡å— | äº‹ä»¶ç±»å‹ | å‘å¸ƒå®ç° | Allure é›†æˆ | Telemetry é›†æˆ |
|------|----------|----------|-------------|----------------|
| **HTTP** | âœ… Start/End/Error | âœ… HttpClient | âš ï¸ éƒ¨åˆ† | âŒ æ—  |
| **Database** | âœ… Start/End/Error | âŒ æœªå®ç° | âš ï¸ ç›´æ¥è°ƒç”¨ | âŒ æ—  |
| **Redis** | âŒ æ— å®šä¹‰ | âŒ æœªå®ç° | âš ï¸ ç›´æ¥è°ƒç”¨ | âŒ æ—  |
| **MQ** | âœ… Publish/Consume | âŒ æœªå®ç° | âŒ æ—  | âŒ æ—  |
| **Storage** | âŒ æ— å®šä¹‰ | âŒ æœªå®ç° | âŒ æ—  | âŒ æ—  |

### 1.3 EventBus ä¸ Telemetry çš„å…³ç³»

æ ¹æ® V3.14 æ¶æ„è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Tracing   â”‚  â”‚   Metrics   â”‚  â”‚   Logging   â”‚              â”‚
â”‚  â”‚  (é“¾è·¯è¿½è¸ª)  â”‚  â”‚  (æŒ‡æ ‡ç›‘æ§)  â”‚  â”‚  (æ—¥å¿—è®°å½•)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                â”‚                â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                          â”‚                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                  â”‚   Telemetry   â”‚  â† ç»Ÿä¸€é—¨é¢                   â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   EventBus    â”‚  â† äº‹ä»¶é©±åŠ¨
                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HttpClient  â”‚    â”‚   Database    â”‚   â”‚    Redis      â”‚
â”‚ (å‘å¸ƒäº‹ä»¶)   â”‚    â”‚  (å‘å¸ƒäº‹ä»¶)   â”‚   â”‚  (å‘å¸ƒäº‹ä»¶)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†å¿µ**ï¼š
- **EventBus** æ˜¯ç»„ä»¶é—´è§£è€¦é€šä¿¡çš„æœºåˆ¶
- **Telemetry** è®¢é˜…äº‹ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ Trace Span å’Œ Metrics
- **AllureObserver** è®¢é˜…äº‹ä»¶ï¼Œè‡ªåŠ¨è®°å½•åˆ°æµ‹è¯•æŠ¥å‘Š
- **èƒ½åŠ›å±‚** åªè´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼Œä¸å…³å¿ƒè°åœ¨ç›‘å¬

### 1.4 æ¶æ„å±‚çº§

```
Layer 0 (core/events/)           â†’ äº‹ä»¶ç±»å‹å®šä¹‰ï¼ˆçº¯ Pythonï¼‰
Layer 1 (infrastructure/events/) â†’ EventBus å®ç°
Layer 1 (infrastructure/telemetry/) â†’ Telemetry å®ç°ï¼ˆè®¢é˜…äº‹ä»¶ï¼‰
Layer 2 (capabilities/)          â†’ èƒ½åŠ›å±‚ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰
Layer 3 (testing/reporting/)     â†’ AllureObserverï¼ˆè®¢é˜…äº‹ä»¶ï¼‰
```

---

## 2. è®¾è®¡ç›®æ ‡

### 2.1 æ ¸å¿ƒç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| **å”¯ä¸€æ ‡è¯†** | æ¯ä¸ªäº‹ä»¶æœ‰å…¨å±€å”¯ä¸€ ID |
| **å¯é å…³è”** | Start/End äº‹ä»¶é€šè¿‡ correlation_id ç²¾ç¡®å…³è” |
| **åŒæ­¥å‘å¸ƒ** | é»˜è®¤åŒæ­¥å‘å¸ƒï¼Œç¡®ä¿å¤„ç†å™¨æ‰§è¡Œå®Œæˆ |
| **æµ‹è¯•éš”ç¦»** | æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„äº‹ä»¶è®¢é˜…ä¸Šä¸‹æ–‡ |
| **ç±»å‹å®‰å…¨** | ä½¿ç”¨æ³›å‹å’Œ Protocol æä¾›ç±»å‹æ£€æŸ¥ |

### 2.2 è®¾è®¡åŸåˆ™

1. **äº‹ä»¶ä¸å¯å˜**: ä½¿ç”¨ `frozen=True` dataclass
2. **ID ç”Ÿæˆé›†ä¸­**: ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶
3. **åŒæ­¥ä¼˜å…ˆ**: æµ‹è¯•åœºæ™¯ä¸‹åŒæ­¥æ›´å¯é 
4. **ä¸Šä¸‹æ–‡ä¼ æ’­**: äº‹ä»¶æºå¸¦ ExecutionContext

---

## 3. æ–°äº‹ä»¶ç³»ç»Ÿè®¾è®¡

### 3.1 äº‹ä»¶åŸºç±»é‡æ„

```python
# core/events/types.py

import uuid
from dataclasses import dataclass, field
from datetime import datetime
from typing import Any

from df_test_framework.core.context.execution import ExecutionContext


def generate_event_id() -> str:
    """ç”Ÿæˆäº‹ä»¶å”¯ä¸€ ID"""
    return f"evt-{uuid.uuid4().hex[:12]}"


def generate_correlation_id() -> str:
    """ç”Ÿæˆå…³è” IDï¼ˆç”¨äºå…³è” Start/End äº‹ä»¶å¯¹ï¼‰"""
    return f"cor-{uuid.uuid4().hex[:12]}"


@dataclass(frozen=True)
class Event:
    """äº‹ä»¶åŸºç±»

    æ‰€æœ‰äº‹ä»¶éƒ½åº”ç»§æ‰¿æ­¤ç±»ã€‚

    å±æ€§:
        event_id: äº‹ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
        timestamp: äº‹ä»¶å‘ç”Ÿæ—¶é—´ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
        context: æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼Œç”¨äºè¿½è¸ªå…³è”ï¼‰
    """
    event_id: str = field(default_factory=generate_event_id)
    timestamp: datetime = field(default_factory=datetime.now)
    context: ExecutionContext | None = None


@dataclass(frozen=True)
class CorrelatedEvent(Event):
    """å¯å…³è”äº‹ä»¶åŸºç±»

    ç”¨äº Start/End äº‹ä»¶å¯¹çš„å…³è”ã€‚

    å±æ€§:
        correlation_id: å…³è” IDï¼ˆåŒä¸€å¯¹ Start/End å…±äº«ï¼‰
    """
    correlation_id: str = ""
```

### 3.2 HTTP äº‹ä»¶é‡æ„

```python
# core/events/http.py

from dataclasses import dataclass, field
from typing import Any

from df_test_framework.core.events.types import CorrelatedEvent, generate_correlation_id


@dataclass(frozen=True)
class HttpRequestStartEvent(CorrelatedEvent):
    """HTTP è¯·æ±‚å¼€å§‹äº‹ä»¶

    åœ¨å‘é€ HTTP è¯·æ±‚å‰è§¦å‘ã€‚
    correlation_id ç”±å‘å¸ƒè€…ç”Ÿæˆï¼ŒEnd äº‹ä»¶å¤ç”¨åŒä¸€ IDã€‚
    """
    method: str = ""
    url: str = ""
    headers: dict[str, str] = field(default_factory=dict)
    body: str | None = None

    @classmethod
    def create(
        cls,
        method: str,
        url: str,
        headers: dict[str, str] | None = None,
        body: str | None = None,
        context: "ExecutionContext | None" = None,
    ) -> tuple["HttpRequestStartEvent", str]:
        """å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºäº‹ä»¶å¹¶è¿”å› correlation_id

        Returns:
            (event, correlation_id) å…ƒç»„
        """
        correlation_id = generate_correlation_id()
        event = cls(
            method=method,
            url=url,
            headers=headers or {},
            body=body,
            correlation_id=correlation_id,
            context=context,
        )
        return event, correlation_id


@dataclass(frozen=True)
class HttpRequestEndEvent(CorrelatedEvent):
    """HTTP è¯·æ±‚ç»“æŸäº‹ä»¶

    åœ¨æ”¶åˆ° HTTP å“åº”åè§¦å‘ã€‚
    correlation_id å¿…é¡»ä¸å¯¹åº”çš„ StartEvent ç›¸åŒã€‚
    """
    method: str = ""
    url: str = ""
    status_code: int = 0
    duration: float = 0.0  # ç§’
    headers: dict[str, str] = field(default_factory=dict)
    body: str | None = None

    @classmethod
    def create(
        cls,
        correlation_id: str,
        method: str,
        url: str,
        status_code: int,
        duration: float,
        headers: dict[str, str] | None = None,
        body: str | None = None,
        context: "ExecutionContext | None" = None,
    ) -> "HttpRequestEndEvent":
        """å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºäº‹ä»¶ï¼ˆå¤ç”¨ correlation_idï¼‰"""
        return cls(
            method=method,
            url=url,
            status_code=status_code,
            duration=duration,
            headers=headers or {},
            body=body,
            correlation_id=correlation_id,
            context=context,
        )


@dataclass(frozen=True)
class HttpRequestErrorEvent(CorrelatedEvent):
    """HTTP è¯·æ±‚é”™è¯¯äº‹ä»¶"""
    method: str = ""
    url: str = ""
    error_type: str = ""
    error_message: str = ""
    duration: float = 0.0

    @classmethod
    def create(
        cls,
        correlation_id: str,
        method: str,
        url: str,
        error: Exception,
        duration: float,
        context: "ExecutionContext | None" = None,
    ) -> "HttpRequestErrorEvent":
        """å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºé”™è¯¯äº‹ä»¶"""
        return cls(
            method=method,
            url=url,
            error_type=type(error).__name__,
            error_message=str(error),
            duration=duration,
            correlation_id=correlation_id,
            context=context,
        )
```

### 3.3 EventBus é‡æ„

```python
# infrastructure/events/bus.py

import asyncio
import logging
from collections.abc import Awaitable, Callable
from contextvars import ContextVar
from typing import TypeVar

from df_test_framework.core.events.types import Event
from df_test_framework.core.protocols.event import IEventBus

T = TypeVar("T", bound=Event)
EventHandler = Callable[[Event], Awaitable[None]]


class EventBus(IEventBus):
    """äº‹ä»¶æ€»çº¿

    v3.17.0 é‡æ„:
    - æ”¯æŒåŒæ­¥å‘å¸ƒæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
    - æ”¯æŒæµ‹è¯•éš”ç¦»ï¼ˆæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è®¢é˜…ä¸Šä¸‹æ–‡ï¼‰
    - ä¿è¯å¤„ç†å™¨æ‰§è¡Œé¡ºåºï¼ˆæŒ‰æ³¨å†Œé¡ºåºï¼‰
    """

    def __init__(
        self,
        logger: logging.Logger | None = None,
        sync_mode: bool = True,
    ):
        """åˆå§‹åŒ–äº‹ä»¶æ€»çº¿

        Args:
            logger: æ—¥å¿—å¯¹è±¡
            sync_mode: æ˜¯å¦é»˜è®¤åŒæ­¥å‘å¸ƒï¼ˆç­‰å¾…æ‰€æœ‰å¤„ç†å™¨å®Œæˆï¼‰
        """
        self._handlers: dict[type[Event], list[EventHandler]] = {}
        self._global_handlers: list[EventHandler] = []
        self._logger = logger or logging.getLogger(__name__)
        self._sync_mode = sync_mode

    def subscribe(
        self,
        event_type: type[T],
        handler: Callable[[T], Awaitable[None]],
    ) -> None:
        """è®¢é˜…ç‰¹å®šç±»å‹äº‹ä»¶"""
        if event_type not in self._handlers:
            self._handlers[event_type] = []
        self._handlers[event_type].append(handler)
        self._logger.debug(f"Subscribed {handler.__name__} to {event_type.__name__}")

    def unsubscribe(
        self,
        event_type: type[T],
        handler: Callable[[T], Awaitable[None]],
    ) -> None:
        """å–æ¶ˆè®¢é˜…"""
        if event_type in self._handlers:
            try:
                self._handlers[event_type].remove(handler)
            except ValueError:
                pass

    async def publish(self, event: Event) -> None:
        """å¼‚æ­¥å‘å¸ƒäº‹ä»¶

        æŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œå¤„ç†å™¨ï¼ˆéå¹¶å‘ï¼‰ã€‚
        """
        handlers = self._handlers.get(type(event), []) + self._global_handlers

        if not handlers:
            return

        # æŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œï¼ˆä¿è¯é¡ºåºï¼‰
        for handler in handlers:
            await self._safe_call(handler, event)

    def publish_sync(self, event: Event) -> None:
        """åŒæ­¥å‘å¸ƒäº‹ä»¶ï¼ˆé˜»å¡ç­‰å¾…æ‰€æœ‰å¤„ç†å™¨å®Œæˆï¼‰

        é€‚ç”¨äºæµ‹è¯•åœºæ™¯ï¼Œç¡®ä¿äº‹ä»¶å¤„ç†å®Œæˆåå†ç»§ç»­ã€‚
        """
        try:
            loop = asyncio.get_running_loop()
            # å¦‚æœå·²åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œåˆ›å»ºä»»åŠ¡å¹¶ç­‰å¾…
            future = asyncio.ensure_future(self.publish(event))
            loop.run_until_complete(future)
        except RuntimeError:
            # æ²¡æœ‰è¿è¡Œä¸­çš„äº‹ä»¶å¾ªç¯ï¼Œåˆ›å»ºæ–°çš„
            asyncio.run(self.publish(event))

    async def _safe_call(self, handler: EventHandler, event: Event) -> None:
        """å®‰å…¨è°ƒç”¨å¤„ç†å™¨"""
        try:
            await handler(event)
        except Exception as e:
            self._logger.warning(
                f"Event handler error: {handler.__name__} failed with {e}",
                exc_info=True,
            )

    def handler_count(self) -> int:
        """è·å–å¤„ç†å™¨æ€»æ•°"""
        count = sum(len(handlers) for handlers in self._handlers.values())
        return count + len(self._global_handlers)

    def clear(self) -> None:
        """æ¸…ç©ºæ‰€æœ‰è®¢é˜…ï¼ˆç”¨äºæµ‹è¯•æ¸…ç†ï¼‰"""
        self._handlers.clear()
        self._global_handlers.clear()


# æµ‹è¯•éš”ç¦»ï¼šæ¯ä¸ªæµ‹è¯•å¯ä»¥æœ‰ç‹¬ç«‹çš„ EventBus
_test_event_bus: ContextVar[EventBus | None] = ContextVar("test_event_bus", default=None)
_global_event_bus: EventBus | None = None


def get_event_bus() -> EventBus:
    """è·å–äº‹ä»¶æ€»çº¿

    ä¼˜å…ˆè¿”å›æµ‹è¯•ä¸Šä¸‹æ–‡çš„ EventBusï¼Œå¦åˆ™è¿”å›å…¨å±€å®ä¾‹ã€‚
    """
    # ä¼˜å…ˆä½¿ç”¨æµ‹è¯•ä¸Šä¸‹æ–‡çš„ EventBus
    test_bus = _test_event_bus.get()
    if test_bus is not None:
        return test_bus

    # å…¨å±€å•ä¾‹
    global _global_event_bus
    if _global_event_bus is None:
        _global_event_bus = EventBus()
    return _global_event_bus


def set_test_event_bus(bus: EventBus | None) -> None:
    """è®¾ç½®æµ‹è¯•ä¸Šä¸‹æ–‡çš„ EventBus

    ç”¨äºæµ‹è¯•éš”ç¦»ï¼šæ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ EventBusã€‚
    """
    _test_event_bus.set(bus)
```

### 3.4 HttpClient é›†æˆ

```python
# capabilities/clients/http/rest/httpx/client.py (éƒ¨åˆ†)

class HttpClient:
    def request_with_middleware(
        self,
        method: str,
        url: str,
        **kwargs,
    ) -> Response:
        """ä½¿ç”¨ä¸­é—´ä»¶ç³»ç»Ÿå‘é€è¯·æ±‚"""

        # å‡†å¤‡è¯·æ±‚
        request_obj = self._prepare_request_object(method, url, **kwargs)

        # åˆ›å»ºäº‹ä»¶å¾ªç¯
        try:
            loop = asyncio.get_running_loop()
        except RuntimeError:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)

        # v3.17.0: ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶ï¼Œè·å– correlation_id
        start_event, correlation_id = HttpRequestStartEvent.create(
            method=method,
            url=url,
            headers=dict(request_obj.headers) if request_obj.headers else {},
        )

        # åŒæ­¥å‘å¸ƒå¼€å§‹äº‹ä»¶
        start_time = time.time()
        self._event_bus.publish_sync(start_event)

        try:
            # æ‰§è¡Œä¸­é—´ä»¶é“¾
            chain = self._build_middleware_chain()
            response = loop.run_until_complete(chain.execute(request_obj))

            # åˆ›å»ºç»“æŸäº‹ä»¶ï¼ˆå¤ç”¨ correlation_idï¼‰
            duration = time.time() - start_time
            end_event = HttpRequestEndEvent.create(
                correlation_id=correlation_id,
                method=method,
                url=url,
                status_code=response.status_code,
                duration=duration,
                headers=dict(response.headers) if response.headers else {},
            )

            self._event_bus.publish_sync(end_event)
            return response

        except Exception as e:
            # åˆ›å»ºé”™è¯¯äº‹ä»¶
            duration = time.time() - start_time
            error_event = HttpRequestErrorEvent.create(
                correlation_id=correlation_id,
                method=method,
                url=url,
                error=e,
                duration=duration,
            )

            self._event_bus.publish_sync(error_event)
            raise
```

### 3.5 AllureObserver é›†æˆ

```python
# testing/reporting/allure/observer.py (éƒ¨åˆ†)

class AllureObserver:
    def __init__(self, test_name: str, ...):
        # ...
        # v3.17.0: ä½¿ç”¨ correlation_id ä½œä¸º keyï¼ˆå¯é å…³è”ï¼‰
        self._http_contexts: dict[str, StepContext] = {}  # correlation_id â†’ context

    async def handle_http_request_start_event(self, event: HttpRequestStartEvent) -> None:
        """å¤„ç† HTTP è¯·æ±‚å¼€å§‹äº‹ä»¶"""
        if not is_allure_enabled():
            return

        # v3.17.0: ä½¿ç”¨äº‹ä»¶è‡ªå¸¦çš„ correlation_id
        correlation_id = event.correlation_id

        # åˆ›å»º Allure step
        ctx = StepContext()
        step_title = f"ğŸŒ {event.method} {event.url}"
        ctx.step_context = allure.step(step_title)
        ctx.exit_stack.enter_context(ctx.step_context)

        # å­˜å‚¨ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨ correlation_id ä½œä¸º keyï¼‰
        self._http_contexts[correlation_id] = ctx

        # é™„åŠ è¯·æ±‚è¯¦æƒ…
        request_details = {
            "event_id": event.event_id,
            "correlation_id": correlation_id,
            "method": event.method,
            "url": event.url,
            "headers": dict(event.headers) if event.headers else {},
        }

        allure.attach(
            json.dumps(request_details, indent=2, ensure_ascii=False),
            name="ğŸ“¤ Request Details",
            attachment_type=allure.attachment_type.JSON,
        )

    async def handle_http_request_end_event(self, event: HttpRequestEndEvent) -> None:
        """å¤„ç† HTTP è¯·æ±‚ç»“æŸäº‹ä»¶"""
        if not is_allure_enabled():
            return

        # v3.17.0: ä½¿ç”¨ correlation_id æŸ¥æ‰¾å¯¹åº”çš„ä¸Šä¸‹æ–‡
        correlation_id = event.correlation_id
        ctx = self._http_contexts.get(correlation_id)

        if not ctx:
            # æ²¡æœ‰å¯¹åº”çš„ Start äº‹ä»¶ï¼Œå¯èƒ½æ˜¯è®¢é˜…æ—¶æœºé—®é¢˜
            self._logger.warning(f"No context found for correlation_id: {correlation_id}")
            return

        try:
            duration_ms = event.duration * 1000

            response_details = {
                "event_id": event.event_id,
                "correlation_id": correlation_id,
                "status_code": event.status_code,
                "duration_ms": round(duration_ms, 2),
                "headers": dict(event.headers) if event.headers else {},
            }

            status_emoji = "âœ…" if 200 <= event.status_code < 300 else "âŒ"
            attachment_name = f"{status_emoji} Response ({event.status_code}) - {round(duration_ms, 2)}ms"

            allure.attach(
                json.dumps(response_details, indent=2, ensure_ascii=False),
                name=attachment_name,
                attachment_type=allure.attachment_type.JSON,
            )
        finally:
            # å…³é—­ step ä¸Šä¸‹æ–‡
            ctx.exit_stack.close()
            self._http_contexts.pop(correlation_id, None)
```

### 3.6 æµ‹è¯• Fixture é›†æˆ

```python
# testing/fixtures/allure.py

@pytest.fixture(scope="function", autouse=True)
def _auto_allure_observer(request) -> Generator[AllureObserver | None, None, None]:
    """è‡ªåŠ¨å¯ç”¨ Allure è§‚å¯Ÿè€…"""
    if not ALLURE_AVAILABLE:
        yield None
        return

    # åˆ›å»º Observer
    test_name = request.node.name
    observer = AllureObserver(test_name=test_name)
    set_current_observer(observer)

    # v3.17.0: ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹çš„ EventBusï¼ˆæµ‹è¯•éš”ç¦»ï¼‰
    test_bus = EventBus(sync_mode=True)
    set_test_event_bus(test_bus)

    # è®¢é˜…äº‹ä»¶
    test_bus.subscribe(HttpRequestStartEvent, observer.handle_http_request_start_event)
    test_bus.subscribe(HttpRequestEndEvent, observer.handle_http_request_end_event)
    test_bus.subscribe(HttpRequestErrorEvent, observer.handle_http_request_error_event)

    try:
        yield observer
    finally:
        # æ¸…ç†
        observer.cleanup()
        set_current_observer(None)

        # æ¸…ç†æµ‹è¯• EventBus
        test_bus.clear()
        set_test_event_bus(None)
```

---

## 4. æ•°æ®æµå›¾

### 4.1 HTTP è¯·æ±‚å®Œæ•´æµç¨‹

```
æµ‹è¯•ä»£ç : http_client.post("/api/users", json={...})
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HttpClient.request()                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. åˆ›å»º HttpRequestStartEvent                                       â”‚
â”‚     â”œâ”€â”€ event_id: "evt-a1b2c3d4e5f6"  (è‡ªåŠ¨ç”Ÿæˆ)                     â”‚
â”‚     â”œâ”€â”€ correlation_id: "cor-x7y8z9"  (å·¥å‚æ–¹æ³•ç”Ÿæˆ)                  â”‚
â”‚     â”œâ”€â”€ method: "POST"                                               â”‚
â”‚     â””â”€â”€ url: "/api/users"                                            â”‚
â”‚                                                                      â”‚
â”‚  2. EventBus.publish_sync(start_event)                               â”‚
â”‚     â””â”€â”€ AllureObserver.handle_http_request_start_event()             â”‚
â”‚         â”œâ”€â”€ åˆ›å»º Allure step: "ğŸŒ POST /api/users"                   â”‚
â”‚         â”œâ”€â”€ å­˜å‚¨ ctx åˆ° _http_contexts["cor-x7y8z9"]                 â”‚
â”‚         â””â”€â”€ é™„åŠ è¯·æ±‚è¯¦æƒ… JSON                                         â”‚
â”‚                                                                      â”‚
â”‚  3. æ‰§è¡Œä¸­é—´ä»¶é“¾ â†’ å‘é€ HTTP è¯·æ±‚                                      â”‚
â”‚                                                                      â”‚
â”‚  4. åˆ›å»º HttpRequestEndEvent                                          â”‚
â”‚     â”œâ”€â”€ event_id: "evt-f6e5d4c3b2a1"  (æ–° ID)                        â”‚
â”‚     â”œâ”€â”€ correlation_id: "cor-x7y8z9"  (å¤ç”¨!)                         â”‚
â”‚     â”œâ”€â”€ status_code: 201                                             â”‚
â”‚     â””â”€â”€ duration: 0.145                                              â”‚
â”‚                                                                      â”‚
â”‚  5. EventBus.publish_sync(end_event)                                 â”‚
â”‚     â””â”€â”€ AllureObserver.handle_http_request_end_event()               â”‚
â”‚         â”œâ”€â”€ æŸ¥æ‰¾ _http_contexts["cor-x7y8z9"] â†’ ctx                  â”‚
â”‚         â”œâ”€â”€ é™„åŠ å“åº”è¯¦æƒ… JSON                                         â”‚
â”‚         â””â”€â”€ å…³é—­ step ä¸Šä¸‹æ–‡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
è¿”å› Response å¯¹è±¡
```

### 4.2 å¹¶å‘è¯·æ±‚åœºæ™¯

```
æµ‹è¯•ä»£ç :
    response1 = http_client.get("/api/users/1")  # correlation_id: "cor-aaa"
    response2 = http_client.get("/api/users/2")  # correlation_id: "cor-bbb"

æ—¶é—´çº¿:
    â”œâ”€â”€ StartEvent(cor-aaa) â†’ Allure step 1 å¼€å§‹
    â”œâ”€â”€ StartEvent(cor-bbb) â†’ Allure step 2 å¼€å§‹
    â”œâ”€â”€ EndEvent(cor-bbb)   â†’ Allure step 2 ç»“æŸ (å…ˆè¿”å›)
    â””â”€â”€ EndEvent(cor-aaa)   â†’ Allure step 1 ç»“æŸ (åè¿”å›)

_http_contexts çŠ¶æ€å˜åŒ–:
    {}
    â†’ {"cor-aaa": ctx1}
    â†’ {"cor-aaa": ctx1, "cor-bbb": ctx2}
    â†’ {"cor-aaa": ctx1}  # cor-bbb ç»“æŸï¼Œç§»é™¤
    â†’ {}                 # cor-aaa ç»“æŸï¼Œç§»é™¤
```

---

## 5. è¿ç§»è®¡åˆ’

### Phase 1: äº‹ä»¶ç±»å‹é‡æ„ (v3.17.0)

1. ä¸º Event åŸºç±»æ·»åŠ  `event_id` å­—æ®µ
2. æ–°å¢ `CorrelatedEvent` åŸºç±»ï¼ŒåŒ…å« `correlation_id`
3. ä¸º HTTP äº‹ä»¶æ·»åŠ å·¥å‚æ–¹æ³•
4. ä¿æŒå‘åå…¼å®¹ï¼šæ—§ä»£ç ç»§ç»­å·¥ä½œ

### Phase 2: EventBus é‡æ„ (v3.17.0)

1. æ·»åŠ  `publish_sync()` æ–¹æ³•
2. æ·»åŠ æµ‹è¯•éš”ç¦»æ”¯æŒ (`set_test_event_bus`)
3. æŒ‰æ³¨å†Œé¡ºåºæ‰§è¡Œå¤„ç†å™¨ï¼ˆéå¹¶å‘ï¼‰

### Phase 3: é›†æˆé‡æ„ (v3.17.0)

1. HttpClient ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶
2. AllureObserver ä½¿ç”¨ `correlation_id` å…³è”
3. Fixture åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯• EventBus

### Phase 4: æ‰©å±•åˆ°å…¶ä»–æ¨¡å— (v3.18.0)

1. Database äº‹ä»¶ä½¿ç”¨ç›¸åŒæ¨¡å¼
2. MQ äº‹ä»¶ä½¿ç”¨ç›¸åŒæ¨¡å¼
3. Redis äº‹ä»¶ä½¿ç”¨ç›¸åŒæ¨¡å¼

---

## 6. å‘åå…¼å®¹æ€§

### 6.1 Event åŸºç±»

```python
# æ—§ä»£ç ç»§ç»­å·¥ä½œ
event = HttpRequestStartEvent(method="GET", url="/api")
# event.event_id è‡ªåŠ¨ç”Ÿæˆ
# event.correlation_id ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤å€¼ï¼‰

# æ–°ä»£ç ä½¿ç”¨å·¥å‚æ–¹æ³•
event, correlation_id = HttpRequestStartEvent.create(method="GET", url="/api")
# event.correlation_id == correlation_id
```

### 6.2 EventBus

```python
# æ—§ä»£ç ç»§ç»­å·¥ä½œ
await event_bus.publish(event)

# æ–°ä»£ç å¯é€‰æ‹©åŒæ­¥æ¨¡å¼
event_bus.publish_sync(event)
```

---

## 7. æµ‹è¯•è¦ç‚¹

### 7.1 äº‹ä»¶ ID å”¯ä¸€æ€§
```python
def test_event_id_uniqueness():
    events = [HttpRequestStartEvent.create(...)[0] for _ in range(1000)]
    event_ids = [e.event_id for e in events]
    assert len(set(event_ids)) == 1000  # å…¨éƒ¨å”¯ä¸€
```

### 7.2 äº‹ä»¶å…³è”å¯é æ€§
```python
def test_correlation_id_propagation():
    start_event, correlation_id = HttpRequestStartEvent.create(...)
    end_event = HttpRequestEndEvent.create(correlation_id=correlation_id, ...)

    assert start_event.correlation_id == end_event.correlation_id
```

### 7.3 å¹¶å‘è¯·æ±‚éš”ç¦»
```python
async def test_concurrent_requests_isolation():
    # å‘é€ 100 ä¸ªå¹¶å‘è¯·æ±‚
    tasks = [http_client.get(f"/api/users/{i}") for i in range(100)]
    responses = await asyncio.gather(*tasks)

    # æ£€æŸ¥ Allure æŠ¥å‘Šä¸­æ¯ä¸ªè¯·æ±‚éƒ½æ­£ç¡®å…³è”
    assert len(observer._http_contexts) == 0  # å…¨éƒ¨æ¸…ç†
```

---

## 8. æ€»ç»“

### 8.1 æ ¸å¿ƒæ”¹è¿›

| æ”¹è¿›é¡¹ | ä¹‹å‰ | ä¹‹å |
|--------|------|------|
| äº‹ä»¶æ ‡è¯† | æ—  | `event_id` + `correlation_id` |
| äº‹ä»¶å…³è” | `method:url` å­—ç¬¦ä¸² | å”¯ä¸€ `correlation_id` |
| å‘å¸ƒæ¨¡å¼ | å¼‚æ­¥ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰ | åŒæ­¥ï¼ˆå¯é ï¼‰ |
| æµ‹è¯•éš”ç¦» | å…¨å±€å…±äº« | æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ |

### 8.2 æ¶æ„å¯¹é½

```
Layer 0 (core/events/)
    â”œâ”€â”€ Event åŸºç±»ï¼ˆå« event_idï¼‰
    â”œâ”€â”€ CorrelatedEventï¼ˆå« correlation_idï¼‰
    â””â”€â”€ å·¥å‚æ–¹æ³•ï¼ˆcreateï¼‰

Layer 1 (infrastructure/events/)
    â”œâ”€â”€ EventBusï¼ˆpublish + publish_syncï¼‰
    â””â”€â”€ æµ‹è¯•éš”ç¦»ï¼ˆset_test_event_busï¼‰

Layer 2 (capabilities/)
    â””â”€â”€ å‘å¸ƒè€…ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶

Layer 3 (testing/)
    â””â”€â”€ è®¢é˜…è€…ä½¿ç”¨ correlation_id å…³è”
```

è¿™ä¸ªè®¾è®¡å®Œå…¨ç¬¦åˆ V3.16 çš„äº”å±‚æ¶æ„è§„èŒƒï¼Œé€šè¿‡äº‹ä»¶ç³»ç»Ÿå®ç°è·¨å±‚è§£è€¦ã€‚
