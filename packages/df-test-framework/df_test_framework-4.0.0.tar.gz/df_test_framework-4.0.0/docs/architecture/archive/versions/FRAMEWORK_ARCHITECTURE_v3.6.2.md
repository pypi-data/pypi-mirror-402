# df-test-framework v3.6.2 æ¶æ„è¯´æ˜

## ğŸ“ æµ‹è¯•æ•°æ®æ¸…ç†æ§åˆ¶æœºåˆ¶æ¶æ„

### è®¾è®¡åŸåˆ™

**æ ¸å¿ƒåŠŸèƒ½åœ¨æ¡†æ¶å±‚ï¼Œä¸šåŠ¡é€»è¾‘åœ¨é¡¹ç›®å±‚**

| å±‚çº§ | èŒè´£ | ç¤ºä¾‹ |
|------|------|------|
| **æ¡†æ¶å±‚** | æä¾›æ ¸å¿ƒæµ‹è¯•èƒ½åŠ›å’Œé€šç”¨æœºåˆ¶ | db_transaction fixtureï¼Œæ•°æ®æ¸…ç†æ§åˆ¶ |
| **é¡¹ç›®å±‚** | å®ç°ä¸šåŠ¡ç›¸å…³çš„æµ‹è¯•é€»è¾‘ | ä¸šåŠ¡ç‰¹å®šçš„ fixturesã€æµ‹è¯•ç”¨ä¾‹ |

### æ¶æ„å†³ç­–

#### ä¸ºä»€ä¹ˆåœ¨æ¡†æ¶å±‚å®ç°ï¼Ÿ

1. **ç»Ÿä¸€è¡Œä¸º** âœ…
   - æ‰€æœ‰ä½¿ç”¨æ¡†æ¶çš„æµ‹è¯•é¡¹ç›®è‡ªåŠ¨è·å¾—ä¸€è‡´çš„æ•°æ®æ¸…ç†æœºåˆ¶
   - é¿å…æ¯ä¸ªé¡¹ç›®é‡å¤å®ç°ç›¸åŒçš„é€»è¾‘

2. **ç®€åŒ–ç»´æŠ¤** âœ…
   - åŠŸèƒ½å‡çº§åªéœ€æ›´æ–°æ¡†æ¶ç‰ˆæœ¬
   - ä¸éœ€è¦ä¿®æ”¹æ¯ä¸ªæµ‹è¯•é¡¹ç›®çš„ä»£ç 

3. **æœ€ä½³å®è·µ** âœ…
   - æ¡†æ¶æä¾›ç»è¿‡éªŒè¯çš„æœ€ä½³å®è·µ
   - å‡å°‘é¡¹ç›®å±‚é¢çš„å®ç°é”™è¯¯

4. **å¯æ‰©å±•æ€§** âœ…
   - é¡¹ç›®å¯ä»¥é€šè¿‡è¦†ç›– fixture å®ç°è‡ªå®šä¹‰è¡Œä¸º
   - ä¿æŒçµæ´»æ€§çš„åŒæ—¶æä¾›è‰¯å¥½çš„é»˜è®¤è¡Œä¸º

#### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµ‹è¯•é¡¹ç›®å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tests/conftest.py                                â”‚  â”‚
â”‚  â”‚  - å¯¼å…¥æ¡†æ¶ pytest æ’ä»¶                           â”‚  â”‚
â”‚  â”‚  - æ³¨å†Œä¸šåŠ¡ç›¸å…³æ ‡è®°ï¼ˆsmoke, master, h5 ç­‰ï¼‰      â”‚  â”‚
â”‚  â”‚  - å®šä¹‰ä¸šåŠ¡ç‰¹å®š fixturesï¼ˆapi, repositoryï¼‰      â”‚  â”‚
â”‚  â”‚  - å¯é€‰ï¼šè¦†ç›–æ¡†æ¶ fixtures                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†“ ä½¿ç”¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æµ‹è¯•æ¡†æ¶æ ¸å¿ƒå±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  df_test_framework/testing/fixtures/core.py       â”‚  â”‚
â”‚  â”‚  âœ… db_transaction fixture                        â”‚  â”‚
â”‚  â”‚  âœ… --keep-test-data å‘½ä»¤è¡Œé€‰é¡¹                   â”‚  â”‚
â”‚  â”‚  âœ… keep_data æ ‡è®°æ³¨å†Œ                            â”‚  â”‚
â”‚  â”‚  âœ… æ•°æ®æ¸…ç†æ§åˆ¶é€»è¾‘                              â”‚  â”‚
â”‚  â”‚  âœ… runtime, http_client, database fixtures       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†“ ä¾èµ–                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æµ‹è¯•æ¡†æ¶åŸºç¡€å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  df_test_framework/infrastructure/                â”‚  â”‚
â”‚  â”‚  - Bootstrapï¼ˆåº”ç”¨å¯åŠ¨ï¼‰                          â”‚  â”‚
â”‚  â”‚  - RuntimeContextï¼ˆè¿è¡Œæ—¶ä¸Šä¸‹æ–‡ï¼‰                 â”‚  â”‚
â”‚  â”‚  - Databaseï¼ˆæ•°æ®åº“è¿æ¥ï¼‰                         â”‚  â”‚
â”‚  â”‚  - HttpClientï¼ˆHTTPå®¢æˆ·ç«¯ï¼‰                       â”‚  â”‚
â”‚  â”‚  - ObservabilityLoggerï¼ˆå¯è§‚æµ‹æ€§ï¼‰                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç»„ä»¶

#### 1. pytest_addoption

**ä½ç½®**: `df_test_framework/testing/fixtures/core.py:70-101`

**èŒè´£**: æ³¨å†Œæ¡†æ¶çº§åˆ«çš„å‘½ä»¤è¡Œé€‰é¡¹

```python
def pytest_addoption(parser: pytest.Parser) -> None:
    # æ¡†æ¶é…ç½®ç›¸å…³
    parser.addoption("--df-settings-class", ...)
    parser.addoption("--df-plugin", ...)

    # v3.6.2: æ•°æ®æ¸…ç†æ§åˆ¶
    parser.addoption(
        "--keep-test-data",
        action="store_true",
        default=False,
        help="ä¿ç•™æµ‹è¯•æ•°æ®åˆ°æ•°æ®åº“ï¼ˆä¸è‡ªåŠ¨å›æ»šï¼‰"
    )
```

#### 2. pytest_configure

**ä½ç½®**: `df_test_framework/testing/fixtures/core.py:104-123`

**èŒè´£**:
- åˆå§‹åŒ–æ¡†æ¶è¿è¡Œæ—¶ç¯å¢ƒ
- æ³¨å†Œæ¡†æ¶çº§åˆ«çš„ pytest æ ‡è®°

```python
def pytest_configure(config: pytest.Config) -> None:
    # åˆå§‹åŒ–æ¡†æ¶
    bootstrap = Bootstrap().with_settings(settings_cls)
    _runtime_context = bootstrap.build().run()

    # v3.6.2: æ³¨å†Œ keep_data æ ‡è®°
    config.addinivalue_line(
        "markers",
        "keep_data: ä¿ç•™æµ‹è¯•æ•°æ®åˆ°æ•°æ®åº“ï¼ˆä¸è‡ªåŠ¨å›æ»šï¼‰"
    )
```

#### 3. db_transaction fixture

**ä½ç½®**: `df_test_framework/testing/fixtures/core.py:251-361`

**èŒè´£**: æä¾›äº‹åŠ¡éš”ç¦»çš„æ•°æ®åº“è¿æ¥ï¼Œæ”¯æŒçµæ´»çš„æ•°æ®æ¸…ç†æ§åˆ¶

```python
@pytest.fixture
def db_transaction(database, request):
    """v3.6.2 å¢å¼ºï¼šæ”¯æŒå¯é…ç½®çš„æ•°æ®æ¸…ç†æ§åˆ¶"""
    session = database.session_factory()

    # ä¼˜å…ˆçº§ï¼šæ ‡è®° > å‚æ•° > ç¯å¢ƒå˜é‡ > é»˜è®¤
    keep_data = (
        request.node.get_closest_marker("keep_data")
        or request.config.option.keep_test_data
        or os.getenv("KEEP_TEST_DATA") in ["1", "true", "yes"]
    )

    try:
        yield session
        session.commit() if keep_data else session.rollback()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()
```

### æµ‹è¯•é¡¹ç›®å¦‚ä½•ä½¿ç”¨

#### 1. æœ€ç®€é…ç½®

```python
# tests/conftest.py

# å¯¼å…¥æ¡†æ¶ pytest æ’ä»¶
pytest_plugins = ["df_test_framework.testing.fixtures.core"]

# ä½¿ç”¨æ¡†æ¶æä¾›çš„ fixtures
def test_example(db_transaction):
    # è‡ªåŠ¨å›æ»š
    pass
```

#### 2. æ·»åŠ ä¸šåŠ¡æ ‡è®°

```python
# tests/conftest.py

pytest_plugins = ["df_test_framework.testing.fixtures.core"]

def pytest_configure(config):
    """æ³¨å†Œä¸šåŠ¡ç›¸å…³æ ‡è®°"""
    config.addinivalue_line("markers", "smoke: å†’çƒŸæµ‹è¯•")
    config.addinivalue_line("markers", "master: Masterç³»ç»Ÿæµ‹è¯•")
```

#### 3. å®šä¹‰ä¸šåŠ¡ fixtures

```python
# tests/conftest.py

pytest_plugins = ["df_test_framework.testing.fixtures.core"]

@pytest.fixture
def master_card_api(http_client):
    """ä¸šåŠ¡ç‰¹å®šçš„ API fixture"""
    from gift_card_test.apis import MasterCardAPI
    return MasterCardAPI(http_client)
```

#### 4. è¦†ç›–æ¡†æ¶ fixturesï¼ˆå¯é€‰ï¼‰

```python
# tests/conftest.py

pytest_plugins = ["df_test_framework.testing.fixtures.core"]

@pytest.fixture
def db_transaction(database, request):
    """è‡ªå®šä¹‰å®ç°ï¼Œè¦†ç›–æ¡†æ¶æä¾›çš„ fixture"""
    # å®Œå…¨è‡ªå®šä¹‰çš„å®ç°
    pass
```

### é…ç½®ä¼˜å…ˆçº§

```
é¡¹ç›®çº§ fixture è¦†ç›–
    â†“
æ¡†æ¶çº§ fixtureï¼ˆcore.pyï¼‰
    â†“
pytest é»˜è®¤ fixture
```

### æ‰©å±•æ€§è®¾è®¡

#### 1. Fixture ç»§æ‰¿å’Œè¦†ç›–

æµ‹è¯•é¡¹ç›®å¯ä»¥ï¼š
- âœ… ä½¿ç”¨æ¡†æ¶æä¾›çš„ fixtures
- âœ… è¦†ç›–æ¡†æ¶ fixtures å®ç°è‡ªå®šä¹‰è¡Œä¸º
- âœ… æ‰©å±•æ¡†æ¶ fixtures æ·»åŠ æ–°åŠŸèƒ½

#### 2. æ’ä»¶æœºåˆ¶

æ¡†æ¶æ”¯æŒé€šè¿‡æ’ä»¶æ‰©å±•åŠŸèƒ½ï¼š
```bash
pytest --df-plugin=my_plugin tests/
```

#### 3. é…ç½®åŒ–

æ¡†æ¶è¡Œä¸ºå¯é€šè¿‡å¤šç§æ–¹å¼é…ç½®ï¼š
- å‘½ä»¤è¡Œå‚æ•°
- ç¯å¢ƒå˜é‡
- pytest.ini
- Settings ç±»

### æœ€ä½³å®è·µ

#### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨æ¡†æ¶æä¾›çš„æ ¸å¿ƒ fixtures**
   ```python
   def test_example(db_transaction, http_client):
       # ç›´æ¥ä½¿ç”¨ï¼Œé›¶é…ç½®
       pass
   ```

2. **åœ¨é¡¹ç›®å±‚æ·»åŠ ä¸šåŠ¡ fixtures**
   ```python
   @pytest.fixture
   def order_service(http_client, database):
       return OrderService(http_client, database)
   ```

3. **ä¿æŒé¡¹ç›® conftest.py ç®€æ´**
   - åªæ·»åŠ ä¸šåŠ¡ç›¸å…³çš„ fixtures
   - åªæ³¨å†Œä¸šåŠ¡ç›¸å…³çš„æ ‡è®°
   - ä¸é‡å¤å®ç°æ¡†æ¶å·²æä¾›çš„åŠŸèƒ½

#### âŒ é¿å…çš„åšæ³•

1. **ä¸è¦åœ¨é¡¹ç›®å±‚é‡å¤å®ç°æ¡†æ¶åŠŸèƒ½**
   ```python
   # âŒ é”™è¯¯ï¼šé‡å¤å®ç° db_transaction
   @pytest.fixture
   def db_transaction(runtime, request):
       # 100è¡Œçš„å®ç°...
   ```

2. **ä¸è¦ç¡¬ç¼–ç é…ç½®**
   ```python
   # âŒ é”™è¯¯ï¼šç¡¬ç¼–ç 
   ALWAYS_KEEP_DATA = True

   # âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®
   keep_data = request.config.option.keep_test_data
   ```

3. **ä¸è¦ç»•è¿‡æ¡†æ¶æœºåˆ¶**
   ```python
   # âŒ é”™è¯¯ï¼šç›´æ¥æ“ä½œ session.commit()
   db_transaction.commit()  # ç»•è¿‡äº†è‡ªåŠ¨å›æ»šæœºåˆ¶

   # âœ… æ­£ç¡®ï¼šä½¿ç”¨æ ‡è®°
   @pytest.mark.keep_data
   def test_example(db_transaction):
       pass
   ```

### ç‰ˆæœ¬å…¼å®¹æ€§

| ç‰ˆæœ¬ | db_transaction è¡Œä¸º | æ§åˆ¶é€‰é¡¹ |
|------|-------------------|---------|
| v3.5.0 | æµ‹è¯•æˆåŠŸæ—¶æäº¤ | æ—  |
| v3.6.1 | éœ€è¦é¡¹ç›®æ‰‹åŠ¨å®ç° | é¡¹ç›®å±‚å®ç° |
| v3.6.2 | é»˜è®¤å›æ»šï¼Œå¯é…ç½® | æ¡†æ¶å±‚å®ç° |

### å‡çº§æŒ‡å—

#### ä» v3.5.0 å‡çº§åˆ° v3.6.2

1. **æ›´æ–°æ¡†æ¶ç‰ˆæœ¬**
   ```bash
   uv pip install df-test-framework==3.6.2
   ```

2. **ç§»é™¤é¡¹ç›®ä¸­çš„é‡å¤å®ç°**
   ```python
   # tests/conftest.py

   # âŒ åˆ é™¤è¿™äº›ï¼ˆæ¡†æ¶å·²æä¾›ï¼‰
   # def pytest_addoption(parser):
   #     parser.addoption("--keep-test-data", ...)
   #
   # @pytest.fixture
   # def db_transaction(runtime, request):
   #     ...
   ```

3. **ç¡®ä¿å¯¼å…¥æ¡†æ¶æ’ä»¶**
   ```python
   # tests/conftest.py
   pytest_plugins = ["df_test_framework.testing.fixtures.core"]
   ```

4. **éªŒè¯åŠŸèƒ½**
   ```bash
   pytest tests/ -v
   # åº”çœ‹åˆ°: âœ… æµ‹è¯•æ•°æ®å·²å›æ»šï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
   ```

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„é¡¹ç›®è¿˜éœ€è¦ conftest.pyï¼Ÿ**

A: é¡¹ç›®å±‚çš„ conftest.py ç”¨äºï¼š
- å¯¼å…¥æ¡†æ¶ pytest æ’ä»¶
- æ³¨å†Œä¸šåŠ¡ç›¸å…³çš„æ ‡è®°
- å®šä¹‰ä¸šåŠ¡ç‰¹å®šçš„ fixtures
- ä¸åº”è¯¥é‡å¤å®ç°æ¡†æ¶å·²æœ‰çš„åŠŸèƒ½

**Q: å¦‚ä½•åœ¨é¡¹ç›®ä¸­è‡ªå®šä¹‰ db_transaction è¡Œä¸ºï¼Ÿ**

A: ç›´æ¥åœ¨é¡¹ç›®çš„ conftest.py ä¸­å®šä¹‰åŒå fixtureï¼š
```python
@pytest.fixture
def db_transaction(database, request):
    # è‡ªå®šä¹‰å®ç°ä¼šè¦†ç›–æ¡†æ¶çš„å®ç°
    pass
```

**Q: æ¡†æ¶æ›´æ–°åï¼Œç°æœ‰æµ‹è¯•éœ€è¦ä¿®æ”¹å—ï¼Ÿ**

A: å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ã€‚æ¡†æ¶ä¿æŒå‘åå…¼å®¹ï¼Œåªæœ‰é»˜è®¤è¡Œä¸ºå˜æ›´ï¼š
- v3.5.0: æµ‹è¯•æˆåŠŸæ—¶æäº¤ï¼ˆä¸å®‰å…¨ï¼‰
- v3.6.2: é»˜è®¤å›æ»šï¼ˆæ›´å®‰å…¨ï¼‰

å¦‚éœ€ä¿ç•™æ•°æ®ï¼Œä½¿ç”¨ `@pytest.mark.keep_data` æ ‡è®°ã€‚

---

**ç‰ˆæœ¬**: v3.6.2
**æ›´æ–°æ—¶é—´**: 2025-11-24
**ç»´æŠ¤è€…**: DF QA Team
