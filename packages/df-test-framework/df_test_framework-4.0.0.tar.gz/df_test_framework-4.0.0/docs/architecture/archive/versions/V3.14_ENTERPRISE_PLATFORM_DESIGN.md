# DF Test Framework v3.14.0 ä¼ä¸šçº§å¹³å°æ¶æ„è®¾è®¡


> **çŠ¶æ€**: ğŸ“ è®¾è®¡æ–¹æ¡ˆ
> **ä½œè€…**: Claude Code
> **æ—¥æœŸ**: 2025-12-03
> **ç›®æ ‡ç‰ˆæœ¬**: v3.14.0

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡èƒŒæ™¯](#1-è®¾è®¡èƒŒæ™¯)
2. [è®¾è®¡ç›®æ ‡](#2-è®¾è®¡ç›®æ ‡)
3. [æ•´ä½“æ¶æ„](#3-æ•´ä½“æ¶æ„)
4. [ç›®å½•ç»“æ„é‡ç»„](#4-ç›®å½•ç»“æ„é‡ç»„)
5. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#5-æ ¸å¿ƒæ¨¡å—è®¾è®¡)
6. [èƒ½åŠ›å±‚é€‚é…](#6-èƒ½åŠ›å±‚é€‚é…)
7. [æµ‹è¯•æ”¯æŒå±‚å¢å¼º](#7-æµ‹è¯•æ”¯æŒå±‚å¢å¼º)
8. [æ‰©å±•ç³»ç»Ÿå¢å¼º](#8-æ‰©å±•ç³»ç»Ÿå¢å¼º)
9. [å®æ–½è®¡åˆ’](#9-å®æ–½è®¡åˆ’)
10. [é™„å½•](#10-é™„å½•)

---

## 1. è®¾è®¡èƒŒæ™¯

### 1.1 ç°çŠ¶åˆ†æ

DF Test Framework v3.x å·²ç»å»ºç«‹äº†è‰¯å¥½çš„äº”å±‚æ¶æ„åŸºç¡€ï¼Œä½†åœ¨å‘ä¼ä¸šçº§å¹³å°æ¼”è¿›è¿‡ç¨‹ä¸­ï¼Œæš´éœ²å‡ºä»¥ä¸‹æ¶æ„ç“¶é¢ˆï¼š

#### æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | ç°çŠ¶ | å½±å“ |
|------|------|------|
| **æ‹¦æˆªå™¨çŠ¶æ€éš”ç¦»** | `before_request`/`after_response` åˆ†ç¦»ï¼Œéœ€é€šè¿‡ context ä¼ é€’çŠ¶æ€ | ä»£ç ç¹çï¼Œæ˜“å‡ºé”™ |
| **åè®®ç¢ç‰‡åŒ–** | HTTP/gRPC/DB å„æœ‰ç‹¬ç«‹æ‹¦æˆªå™¨åè®® | æ— æ³•å¤ç”¨ï¼Œç»´æŠ¤æˆæœ¬é«˜ |
| **åŒæ­¥å¼‚æ­¥å‰²è£‚** | `HttpClient` å’Œ `AsyncHttpClient` ç‹¬ç«‹å®ç° | ä»£ç é‡å¤ï¼Œè¡Œä¸ºä¸ä¸€è‡´ |
| **å¯è§‚æµ‹æ€§åˆ†æ•£** | Tracing/Metrics/Logging ç‹¬ç«‹æ¨¡å— | åŸ‹ç‚¹é‡å¤ï¼Œæ— æ³•å…³è” |
| **ä¸Šä¸‹æ–‡ä¼ æ’­ç¼ºå¤±** | æ— ç»Ÿä¸€çš„è¯·æ±‚ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶ | è·¨èƒ½åŠ›å±‚è¿½è¸ªå›°éš¾ |
| **ç›®å½•ç»“æ„æ‰å¹³** | 12+ é¡¶çº§æ¨¡å—å¹³é“º | è®¤çŸ¥è´Ÿæ‹…å¤§ï¼Œè¾¹ç•Œæ¨¡ç³Š |

#### v3.x æ‹¦æˆªå™¨é—®é¢˜ç¤ºä¾‹

```python
# v3.x: çŠ¶æ€å…±äº«éœ€è¦é€šè¿‡ context ä¼ é€’ï¼ˆç¹çï¼‰
class TimingInterceptor(BaseInterceptor):
    def before_request(self, request):
        # å¿…é¡»é€šè¿‡ context ä¼ é€’ start_time
        return request.with_context("_timing_start", time.monotonic())

    def after_response(self, response):
        # ä» context å–å›ï¼Œå®¹æ˜“é—æ¼
        start = response.context.get("_timing_start")
        if start:
            duration = time.monotonic() - start
            logger.info(f"Request took {duration:.3f}s")
        return response
```

### 1.2 è®¾è®¡é©±åŠ¨åŠ›

```
ä» "å¥½ç”¨çš„å·¥å…·é›†" â†’ "ä¼ä¸šçº§æµ‹è¯•å¹³å°"

æ ¸å¿ƒè½¬å˜ï¼š
â”œâ”€â”€ ç»Ÿä¸€æŠ½è±¡ï¼šä¸€å¥—ä¸­é—´ä»¶åè®®é€‚é…æ‰€æœ‰èƒ½åŠ›å±‚
â”œâ”€â”€ å¼‚æ­¥åŸç”Ÿï¼šasync-first è®¾è®¡ï¼ŒåŒæ­¥ä½œä¸ºå…¼å®¹å±‚
â”œâ”€â”€ å¯è§‚æµ‹èåˆï¼šTracing + Metrics + Logging = Telemetry
â”œâ”€â”€ ä¸Šä¸‹æ–‡è´¯ç©¿ï¼šè‡ªåŠ¨ä¼ æ’­è¯·æ±‚ä¸Šä¸‹æ–‡åˆ°å…¨é“¾è·¯
â””â”€â”€ äº‹ä»¶é©±åŠ¨ï¼šè§£è€¦ç»„ä»¶é€šä¿¡ï¼Œå¢å¼ºæ‰©å±•èƒ½åŠ›
```

---

## 2. è®¾è®¡ç›®æ ‡

### 2.1 æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|---------|
| **ç»Ÿä¸€ä¸­é—´ä»¶** | ä¸€å¥—åè®®é€‚é… HTTP/gRPC/DB/MQ | æ³›å‹ `Middleware[TReq, TResp]` |
| **æ´‹è‘±æ¨¡å‹** | before/after åœ¨åŒä¸€ä½œç”¨åŸŸ | `call_next` æ¨¡å¼ |
| **å¼‚æ­¥ä¼˜å…ˆ** | æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ async-first | åŒæ­¥ API ä½œä¸ºåŒ…è£…å±‚ |
| **å¯è§‚æµ‹èåˆ** | ç»Ÿä¸€ Telemetry æŠ½è±¡ | Tracer + Meter + Logger |
| **ä¸Šä¸‹æ–‡ä¼ æ’­** | è‡ªåŠ¨ä¼ æ’­è¯·æ±‚ä¸Šä¸‹æ–‡ | ContextVar + Carriers |
| **äº‹ä»¶è§£è€¦** | ç»„ä»¶é—´é€šè¿‡äº‹ä»¶é€šä¿¡ | EventBus å‘å¸ƒ/è®¢é˜… |

### 2.2 éç›®æ ‡

- âŒ å®Œå…¨å…¼å®¹ v3.x Interceptor APIï¼ˆæä¾›è¿ç§»æŒ‡å—ï¼Œä¸æä¾›å…¼å®¹å±‚ï¼‰
- âŒ æ”¯æŒ Python < 3.12ï¼ˆå……åˆ†åˆ©ç”¨æ–°è¯­æ³•ç‰¹æ€§ï¼‰
- âŒ åŒæ­¥ API ä½œä¸ºä¸»æ¥å£ï¼ˆä»…ä½œä¸ºä¾¿æ·åŒ…è£…ï¼‰

### 2.3 ä½¿ç”¨åœºæ™¯

```python
# åœºæ™¯1: å£°æ˜å¼é…ç½®ï¼ˆ80% ç”¨æˆ·ï¼‰
client = HttpClient(
    base_url="https://api.example.com",
    middlewares=[
        RetryMiddleware(max_attempts=3),
        SignatureMiddleware(secret="xxx"),
        BearerTokenMiddleware(login_url="/auth/login"),
    ]
)

# åœºæ™¯2: é“¾å¼è°ƒç”¨
client = (
    HttpClient("https://api.example.com")
    .use(RetryMiddleware())
    .use(SignatureMiddleware(secret="xxx"))
)

# åœºæ™¯3: å‡½æ•°å¼ä¸­é—´ä»¶
@middleware(priority=50)
async def timing(request: HttpRequest, call_next) -> HttpResponse:
    start = time.monotonic()
    response = await call_next(request)
    print(f"Duration: {time.monotonic() - start:.3f}s")
    return response
```

---

## 3. æ•´ä½“æ¶æ„

### 3.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Layer 3: Interface                                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           testing/              â”‚  â”‚             cli/                â”‚  â”‚
â”‚  â”‚  fixturesã€pluginsã€dataã€mock  â”‚  â”‚   å‘½ä»¤è¡Œå…¥å£ã€è„šæ‰‹æ¶ã€ä»£ç ç”Ÿæˆ   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              (ç”¨æˆ·é€šè¿‡æµ‹è¯•ä»£ç äº¤äº’)              (ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œäº¤äº’)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Layer 2: Capabilities                                â”‚
â”‚                           capabilities/                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚ clients â”‚ â”‚databases â”‚ â”‚messengersâ”‚ â”‚ storages â”‚ â”‚ drivers â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                     ï¼ˆä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„èƒ½åŠ›ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Layer 1: Infrastructure                               â”‚
â”‚                          infrastructure/                                    â”‚
â”‚         ï¼ˆconfigã€providersã€runtimeã€bootstrapã€telemetryã€pluginsï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Layer 0: Core Abstractions                             â”‚
â”‚                               core/                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚middlewareâ”‚ â”‚ context â”‚ â”‚ events  â”‚ â”‚  types â”‚ â”‚protocolsâ”‚ â”‚exceptions â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   ï¼ˆçº¯æŠ½è±¡ã€åè®®å®šä¹‰ã€æ— ç¬¬ä¸‰æ–¹ä¾èµ–ï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘      æ¨ªåˆ‡å…³æ³¨ç‚¹ (Cross-Cutting)        â•‘
                    â•‘              plugins/                 â•‘
                    â•‘       ï¼ˆç”¨æˆ·/å†…ç½®æ’ä»¶å®ç°ï¼‰             â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 3.2 å±‚çº§ä¸ç›®å½•å¯¹åº”å…³ç³»

| å±‚çº§ | ç›®å½• | èŒè´£ | å…³é”®æ¨¡å— |
|------|------|------|----------|
| **Layer 0** | `core/` | **çº¯æŠ½è±¡**ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ– | Protocolsï¼ˆæ¥å£ï¼‰ã€Middleware åè®®ã€Contextã€Events ç±»å‹ã€å¼‚å¸¸/ç±»å‹ |
| **Layer 1** | `infrastructure/` | æ¡†æ¶è¿è¡ŒåŸºç¡€è®¾æ–½ | é…ç½®ã€Providersã€Runtimeã€Bootstrapã€**Plugins ç®¡ç†ã€Telemetry å®ç°ã€EventBus å®ç°** |
| **Layer 2** | `capabilities/` | ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„èƒ½åŠ› | HTTP/gRPCã€Database/Redisã€Kafka/RabbitMQã€S3/OSSã€Playwright |
| **Layer 3** | `testing/` + `cli/` | æ¥å£å±‚ï¼ˆå¹¶è¡Œï¼‰ | testing: fixtures/plugins/data/mockï¼›cli: å‘½ä»¤è¡Œ/è„šæ‰‹æ¶ |
| **æ¨ªåˆ‡** | `plugins/` | æ’ä»¶å®ç°ï¼ˆä¸åœ¨å±‚çº§ä¸­ï¼‰ | ç”¨æˆ·æ’ä»¶ã€å†…ç½®æ’ä»¶ï¼ˆç›‘æ§ã€æŠ¥å‘Šç­‰ï¼‰ |

**Core å±‚çº¯å‡€åŸåˆ™**ï¼š
- `core/` ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼ˆpluggyã€opentelemetry ç­‰ï¼‰
- æ‰€æœ‰æ¥å£é€šè¿‡ `typing.Protocol` å®šä¹‰
- å…·ä½“å®ç°ï¼ˆPluginManagerã€Telemetryã€EventBusï¼‰æ”¾åœ¨ `infrastructure/`

**å…³äº plugins/**ï¼š
- `core/protocols/plugin.py`: `IPluginManager` æ¥å£å®šä¹‰ï¼ˆçº¯ Python Protocolï¼‰
- `infrastructure/plugins/hooks.py`: HookSpecs å•ä¸€æ•°æ®æºï¼ˆä¾èµ– pluggy @hookspecï¼‰
- `infrastructure/plugins/manager.py`: PluggyPluginManager å…·ä½“å®ç°
- `plugins/`: æ’ä»¶å®ç°ï¼ˆå†…ç½®æ’ä»¶ã€æ‰©å±•æ’ä»¶ï¼‰ï¼Œä½œä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¯ä¾èµ–ä»»æ„å±‚çº§

### 3.3 ä¾èµ–è§„åˆ™

```
Layer 3 (testing/ + cli/)  â”€â”€â–º å¯ä¾èµ– Layer 0-2 å…¨éƒ¨ï¼ˆå¹¶è¡Œæ¥å£å±‚ï¼‰
    â”‚
Layer 2 (capabilities)     â”€â”€â–º å¯ä¾èµ– Layer 0-1
    â”‚
Layer 1 (infrastructure)   â”€â”€â–º åªèƒ½ä¾èµ– Layer 0
    â”‚
Layer 0 (core)             â”€â”€â–º æ— ä¾èµ–ï¼ˆæœ€åº•å±‚ï¼‰

plugins/ (æ¨ªåˆ‡å…³æ³¨ç‚¹)        â”€â”€â–º å¯ä¾èµ–ä»»æ„å±‚çº§
```

**ä¾èµ–çŸ©é˜µ**ï¼š

| å±‚çº§ | å¯ä¾èµ– | ç¦æ­¢ä¾èµ– |
|------|--------|----------|
| `core/` | æ— ï¼ˆæœ€åº•å±‚ï¼‰ | - |
| `infrastructure/` | `core/` | `capabilities/` åŠä»¥ä¸Š |
| `capabilities/` | `core/`, `infrastructure/` | `testing/`, `cli/` |
| `testing/` | `core/`, `infrastructure/`, `capabilities/` | `cli/` |
| `cli/` | `core/`, `infrastructure/`, `capabilities/` | `testing/` |
| `plugins/` | ä»»æ„å±‚çº§ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰ | - |

**å…³äº testing/ å’Œ cli/**ï¼š
- ä¸¤è€…éƒ½æ˜¯ Layer 3ï¼ˆæ¥å£å±‚ï¼‰ï¼Œç”¨æˆ·é€šè¿‡å®ƒä»¬ä¸æ¡†æ¶äº¤äº’
- `testing/`: ç”¨æˆ·é€šè¿‡æµ‹è¯•ä»£ç ä½¿ç”¨æ¡†æ¶
- `cli/`: ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨æ¡†æ¶
- ä¸¤è€…ç›¸äº’ç‹¬ç«‹ï¼Œä¸åº”ç›¸äº’ä¾èµ–

### 3.4 æ ¸å¿ƒæ•°æ®æµ

```
æµ‹è¯•ä»£ç 
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HttpClient.post()                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    MiddlewareChain                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  TelemetryMiddleware (priority=1)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ åˆ›å»º Span                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ æ³¨å…¥ TraceContext                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚  RetryMiddleware (priority=5)             â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚  SignatureMiddleware (priority=10)â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚  AuthMiddleware (pri=20)  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”‚  LogMiddleware    â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”‚    â”‚ HTTP Send â”‚  â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â”‚  â† log response   â”‚  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â”‚  â† verify signature       â”‚  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â”‚  â† handle retry                   â”‚  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â”‚  â† collect metrics                        â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”œâ”€ è®°å½• Duration Histogram                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€ ç»“æŸ Span                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
EventBus.publish(HttpResponseEvent)
    â”‚
    â”œâ”€â–º AllurePlugin: è®°å½•åˆ°æŠ¥å‘Š
    â”œâ”€â–º MetricsPlugin: æ›´æ–°ä»ªè¡¨ç›˜
    â””â”€â–º AlertPlugin: æ£€æŸ¥å¼‚å¸¸
```

### 3.5 ä¸Šä¸‹æ–‡ä¼ æ’­

```
HTTP Request                Database Query              MQ Publish
     â”‚                           â”‚                          â”‚
     â–¼                           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HttpClient  â”‚            â”‚ UnitOfWork  â”‚           â”‚ MqProducer  â”‚
â”‚             â”‚            â”‚             â”‚           â”‚             â”‚
â”‚ inject ctx  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ inherit ctx â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ inject ctx  â”‚
â”‚ to headers  â”‚            â”‚ from parent â”‚           â”‚ to headers  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                          â”‚
     â–¼                           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ExecutionContext (ContextVar)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ trace_id: "abc123"                                        â”‚  â”‚
â”‚  â”‚ span_id: "span_001" â†’ "span_002" â†’ "span_003"            â”‚  â”‚
â”‚  â”‚ request_id: "req_xyz"                                     â”‚  â”‚
â”‚  â”‚ user_id: "user_001"                                       â”‚  â”‚
â”‚  â”‚ tenant_id: "tenant_a"                                     â”‚  â”‚
â”‚  â”‚ baggage: {"env": "test", "version": "1.0"}               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŒä¸€ trace_id è´¯ç©¿ HTTP â†’ DB â†’ MQï¼Œå®ç°å…¨é“¾è·¯è¿½è¸ª
```

---

## 4. ç›®å½•ç»“æ„é‡ç»„

### 4.1 v3.x ç°çŠ¶

```
src/df_test_framework/          # 12+ é¡¶çº§æ¨¡å—ï¼Œè¾ƒä¸ºæ‰å¹³
â”œâ”€â”€ clients/                    # HTTP/GraphQL/gRPC
â”œâ”€â”€ databases/                  # SQL/Redis/Repository/UoW
â”œâ”€â”€ drivers/                    # Playwright/Selenium
â”œâ”€â”€ messengers/                 # Kafka/RabbitMQ/RocketMQ
â”œâ”€â”€ storages/                   # S3/OSS/LocalFile
â”œâ”€â”€ engines/                    # Spark/Flinkï¼ˆé¢„ç•™ï¼‰
â”œâ”€â”€ infrastructure/             # config/logging/tracing/metrics/...
â”œâ”€â”€ testing/                    # fixtures/plugins/data/...
â”œâ”€â”€ extensions/                 # Pluggy æ‰©å±•
â”œâ”€â”€ common/                     # exceptions/types/protocols
â”œâ”€â”€ cli/                        # è„šæ‰‹æ¶
â”œâ”€â”€ utils/                      # å·¥å…·å‡½æ•°
â””â”€â”€ models/                     # æ•°æ®æ¨¡å‹
```

**é—®é¢˜**ï¼š
- `infrastructure/` èŒè´£è¿‡é‡ï¼ˆconfig + logging + tracing + metrics + providers + runtime + bootstrapï¼‰
- `common/` è¾¹ç•Œæ¨¡ç³Šï¼ˆæ—¢æœ‰åŸºç¡€ç±»å‹ï¼Œåˆæœ‰åè®®å®šä¹‰ï¼‰
- èƒ½åŠ›å±‚å‘½åä¸ç»Ÿä¸€ï¼ˆdatabases å¤æ•°ï¼Œstorage å•æ•°ï¼‰

### 4.2 v3.14.0 æ–°ç»“æ„

```
src/df_test_framework/
â”‚
â”œâ”€â”€ core/                           # Layer 0: çº¯æŠ½è±¡ï¼ˆæ— ç¬¬ä¸‰æ–¹ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ __init__.py                 # å¯¼å‡ºæ ¸å¿ƒç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ protocols/                  # åè®®å®šä¹‰ï¼ˆä¾èµ–åè½¬ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ client.py               # IHttpClient, IDatabaseClient ç­‰
â”‚   â”‚   â”œâ”€â”€ repository.py           # IRepository, IUnitOfWork
â”‚   â”‚   â”œâ”€â”€ telemetry.py            # ITelemetry, ITracer, IMeter, ILogger
â”‚   â”‚   â”œâ”€â”€ event.py                # IEventBus, IEventHandler
â”‚   â”‚   â””â”€â”€ plugin.py               # IPluginManager
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/                 # ç»Ÿä¸€ä¸­é—´ä»¶ç³»ç»Ÿï¼ˆçº¯ Pythonï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ protocol.py             # Middleware[T,R] åè®®
â”‚   â”‚   â”œâ”€â”€ chain.py                # MiddlewareChain
â”‚   â”‚   â”œâ”€â”€ base.py                 # BaseMiddleware, SyncMiddleware
â”‚   â”‚   â””â”€â”€ decorator.py            # @middleware è£…é¥°å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ context/                    # ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ˆçº¯ Pythonï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ execution.py            # ExecutionContextï¼ˆdataclassï¼‰
â”‚   â”‚   â”œâ”€â”€ propagation.py          # ContextVar ç®¡ç†
â”‚   â”‚   â””â”€â”€ carriers.py             # Carrier åè®®å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ events/                     # äº‹ä»¶ç±»å‹å®šä¹‰ï¼ˆçº¯ Pythonï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ types.py                # Event åŸºç±»å’Œäº‹ä»¶ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ exceptions.py               # å¼‚å¸¸ä½“ç³»ï¼ˆä» common è¿ç§»ï¼‰
â”‚   â””â”€â”€ types.py                    # æšä¸¾å’Œç±»å‹ï¼ˆä» common è¿ç§»ï¼‰
â”‚
â”œâ”€â”€ infrastructure/                 # Layer 1: åŸºç¡€è®¾æ–½ï¼ˆå…·ä½“å®ç°ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                     # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ schema.py               # Pydantic é…ç½®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ sources.py              # é…ç½®æº
â”‚   â”‚   â”œâ”€â”€ pipeline.py             # é…ç½®ç®¡é“
â”‚   â”‚   â””â”€â”€ manager.py              # é…ç½®ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ plugins/                    # æ’ä»¶ç®¡ç†ï¼ˆä¾èµ– pluggyï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ hooks.py                # HookSpecs å•ä¸€æ•°æ®æºï¼ˆ@hookspec è£…é¥°å™¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ manager.py              # PluggyPluginManagerï¼ˆå®ç° IPluginManagerï¼‰
â”‚   â”‚   â”œâ”€â”€ discovery.py            # æ’ä»¶è‡ªåŠ¨å‘ç°
â”‚   â”‚   â””â”€â”€ loader.py               # æ’ä»¶åŠ è½½é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ telemetry/                  # å¯è§‚æµ‹æ€§å®ç°ï¼ˆä¾èµ– opentelemetryï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ facade.py               # Telemetry é—¨é¢ï¼ˆå®ç° ITelemetryï¼‰
â”‚   â”‚   â”œâ”€â”€ tracer.py               # Tracer å°è£…
â”‚   â”‚   â”œâ”€â”€ meter.py                # Meter å°è£…
â”‚   â”‚   â”œâ”€â”€ logger.py               # Logger å°è£…
â”‚   â”‚   â””â”€â”€ exporters/              # å¯¼å‡ºå™¨
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ console.py
â”‚   â”‚       â”œâ”€â”€ otlp.py
â”‚   â”‚       â”œâ”€â”€ jaeger.py
â”‚   â”‚       â””â”€â”€ prometheus.py
â”‚   â”‚
â”‚   â”œâ”€â”€ events/                     # äº‹ä»¶æ€»çº¿å®ç°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ bus.py                  # EventBusï¼ˆå®ç° IEventBusï¼‰
â”‚   â”‚   â””â”€â”€ handlers/               # å†…ç½®å¤„ç†å™¨
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ logging.py
â”‚   â”‚       â””â”€â”€ metrics.py
â”‚   â”‚
â”‚   â”œâ”€â”€ context/                    # ä¸Šä¸‹æ–‡è½½ä½“å®ç°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ carriers/               # å…·ä½“è½½ä½“
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ http.py             # HTTP Header æ³¨å…¥/æå–
â”‚   â”‚       â”œâ”€â”€ grpc.py             # gRPC Metadata
â”‚   â”‚       â””â”€â”€ mq.py               # MQ Message Headers
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/                  # ä¾èµ–æä¾›è€…
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ registry.py             # ProviderRegistry
â”‚   â”‚   â”œâ”€â”€ singleton.py            # SingletonProvider
â”‚   â”‚   â””â”€â”€ factory.py              # ProviderFactory
â”‚   â”‚
â”‚   â”œâ”€â”€ runtime/                    # è¿è¡Œæ—¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ context.py              # RuntimeContext
â”‚   â”‚
â”‚   â””â”€â”€ bootstrap/                  # å¼•å¯¼ç¨‹åº
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ bootstrap.py            # Bootstrap + BootstrapApp
â”‚
â”œâ”€â”€ capabilities/                   # Layer 2: èƒ½åŠ›å±‚ï¼ˆç»Ÿä¸€ç›®å½•ï¼Œä¿æŒåŸæœ‰ç»“æ„ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ clients/                    # å®¢æˆ·ç«¯ï¼ˆä¿æŒåŸåï¼‰
â”‚   â”‚   â”œâ”€â”€ http/                   # HTTP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒå¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ rest/               # REST å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ middleware/         # HTTP ä¸­é—´ä»¶ï¼ˆåŸ interceptorsï¼‰
â”‚   â”‚   â”œâ”€â”€ grpc/                   # gRPC å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ graphql/                # GraphQL å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ databases/                  # æ•°æ®åº“ï¼ˆä¿æŒåŸåï¼‰
â”‚   â”‚   â”œâ”€â”€ database.py             # Database
â”‚   â”‚   â”œâ”€â”€ uow.py                  # UnitOfWork
â”‚   â”‚   â”œâ”€â”€ repositories/           # Repository æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ redis/                  # Redis å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ middleware/             # DB ä¸­é—´ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ messengers/                 # æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¿æŒåŸåï¼‰
â”‚   â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”‚   â”œâ”€â”€ kafka/
â”‚   â”‚   â”‚   â”œâ”€â”€ rabbitmq/
â”‚   â”‚   â”‚   â””â”€â”€ rocketmq/
â”‚   â”‚   â””â”€â”€ middleware/             # MQ ä¸­é—´ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storages/                   # å­˜å‚¨ï¼ˆä¿æŒåŸåï¼‰
â”‚   â”‚   â”œâ”€â”€ object/
â”‚   â”‚   â”‚   â”œâ”€â”€ s3/
â”‚   â”‚   â”‚   â””â”€â”€ oss/
â”‚   â”‚   â”œâ”€â”€ file/
â”‚   â”‚   â”‚   â””â”€â”€ local/
â”‚   â”‚   â””â”€â”€ middleware/             # Storage ä¸­é—´ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ drivers/                    # UI é©±åŠ¨ï¼ˆä¿æŒåŸåï¼‰
â”‚   â”‚   â””â”€â”€ web/
â”‚   â”‚       â”œâ”€â”€ playwright/
â”‚   â”‚       â””â”€â”€ selenium/
â”‚   â”‚
â”‚   â””â”€â”€ engines/                    # è®¡ç®—å¼•æ“ï¼ˆä¿æŒåŸåï¼Œé¢„ç•™ï¼‰
â”‚       â”œâ”€â”€ batch/
â”‚       â””â”€â”€ stream/
â”‚
â”œâ”€â”€ testing/                        # Layer 3: æµ‹è¯•æ”¯æŒï¼ˆæ¥å£å±‚ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ fixtures/                   # pytest fixtures
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ core.py                 # runtime, http_client, database
â”‚   â”‚   â”œâ”€â”€ cleanup.py              # æ•°æ®æ¸…ç†
â”‚   â”‚   â”œâ”€â”€ ui.py                   # UI fixtures
â”‚   â”‚   â”œâ”€â”€ allure.py               # Allure é›†æˆ
â”‚   â”‚   â””â”€â”€ mq.py                   # MQ fixtures
â”‚   â”‚
â”‚   â”œâ”€â”€ plugins/                    # pytest æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ markers.py              # ç¯å¢ƒæ ‡è®°
â”‚   â”‚   â””â”€â”€ hooks.py                # pytest hooks
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                       # æµ‹è¯•æ•°æ®
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ builders/               # Builder æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ loaders/                # æ•°æ®åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ generators.py           # DataGenerator
â”‚   â”‚   â””â”€â”€ factories/              # å·¥å‚æ¨¡å¼
â”‚   â”‚
â”‚   â”œâ”€â”€ mocking/                    # Mock å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ http.py                 # HttpMocker
â”‚   â”‚   â”œâ”€â”€ database.py             # DatabaseMocker
â”‚   â”‚   â”œâ”€â”€ redis.py                # RedisMocker
â”‚   â”‚   â””â”€â”€ time.py                 # TimeMocker
â”‚   â”‚
â”‚   â”œâ”€â”€ assertions/                 # æ–­è¨€å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ response.py             # ResponseAssertion
â”‚   â”‚
â”‚   â”œâ”€â”€ debugging/                  # è°ƒè¯•å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ http.py                 # HTTPDebugger
â”‚   â”‚   â””â”€â”€ database.py             # DBDebugger
â”‚   â”‚
â”‚   â””â”€â”€ reporting/                  # æŠ¥å‘Šé›†æˆ
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ allure/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ observer.py         # AllureObserver
â”‚           â””â”€â”€ helper.py           # AllureHelper
â”‚
â”œâ”€â”€ cli/                            # Layer 3: CLIï¼ˆæ¥å£å±‚ï¼Œä¸ testing å¹¶è¡Œï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                     # CLI å…¥å£
â”‚   â”œâ”€â”€ commands/                   # å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ init.py
â”‚   â”‚   â””â”€â”€ generate.py
â”‚   â””â”€â”€ templates/                  # æ¨¡æ¿
â”‚       â”œâ”€â”€ project/
â”‚       â””â”€â”€ generators/
â”‚
â”œâ”€â”€ plugins/                        # æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼šæ’ä»¶å®ç°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ builtin/                    # å†…ç½®æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ monitoring/             # ç›‘æ§æ’ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ plugin.py
â”‚   â”‚   â”‚   â””â”€â”€ tracker.py
â”‚   â”‚   â””â”€â”€ reporting/              # æŠ¥å‘Šæ’ä»¶
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ allure_plugin.py
â”‚   â”‚
â”‚   â””â”€â”€ contrib/                    # ç¤¾åŒºè´¡çŒ®æ’ä»¶ï¼ˆå¯é€‰ï¼‰
â”‚       â””â”€â”€ __init__.py
â”‚
â””â”€â”€ __init__.py                     # é¡¶å±‚å¯¼å‡º
```

### 4.3 å˜æ›´è¯´æ˜

| å˜æ›´ | v3.x | v3.14.0 | åŸå›  |
|------|------|------|------|
| æ–°å¢ core/ | æ—  | `core/` **çº¯æŠ½è±¡**ï¼ˆprotocols/middleware/context/eventsï¼‰ | æ— ç¬¬ä¸‰æ–¹ä¾èµ– |
| æ–°å¢ core/protocols/ | æ—  | æ‰€æœ‰æ¥å£å®šä¹‰ï¼ˆIPluginManagerã€ITelemetryã€IEventBus ç­‰ï¼‰ | ä¾èµ–åè½¬åŸºç¡€ |
| infra/plugins/hooks.py | æ—  | HookSpecs å•ä¸€æ•°æ®æºï¼ˆä¾èµ– pluggyï¼‰ | ç»Ÿä¸€ Hook å®šä¹‰ |
| infra/plugins/manager.py | æ—  | PluginManager å…·ä½“å®ç°ï¼ˆä¾èµ– pluggyï¼‰ | å®ç°ä¸‹æ”¾åˆ° infra |
| infra/telemetry/ | æ—  | Telemetry å…·ä½“å®ç°ï¼ˆä¾èµ– opentelemetryï¼‰ | å®ç°ä¸‹æ”¾åˆ° infra |
| infra/events/ | æ—  | EventBus å…·ä½“å®ç° | å®ç°ä¸‹æ”¾åˆ° infra |
| æ–°å¢ capabilities/ | æ—  | ç»Ÿä¸€åŒ…å«æ‰€æœ‰èƒ½åŠ›å±‚ | åˆ†ç»„æ¸…æ™° |
| clients/ è¿ç§» | `clients/` | `capabilities/clients/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| databases/ è¿ç§» | `databases/` | `capabilities/databases/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| messengers/ è¿ç§» | `messengers/` | `capabilities/messengers/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| storages/ è¿ç§» | `storages/` | `capabilities/storages/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| drivers/ è¿ç§» | `drivers/` | `capabilities/drivers/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| engines/ è¿ç§» | `engines/` | `capabilities/engines/` | ç§»åŠ¨åˆ°ç»Ÿä¸€ç›®å½• |
| ç§»é™¤ common/ | `common/` | åˆå¹¶åˆ° `core/` | è¾¹ç•Œæ¸…æ™° |
| extensions/ â†’ plugins/ | `extensions/` | `plugins/`ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰ | æ’ä»¶å®ç°ç‹¬ç«‹ |
| infrastructure/ | ä¿æŒ | Layer 1ï¼ˆæ‰©å±•èŒè´£ï¼‰ | åŒ…å« plugins/telemetry/events å®ç° |
| testing/ + cli/ | åˆ†æ•£ | Layer 3ï¼ˆå¹¶è¡Œæ¥å£å±‚ï¼‰ | ä¸¤ä¸ªç”¨æˆ·å…¥å£å¹¶è¡Œ |
| interceptors â†’ middleware | `interceptors/` | `middleware/` | ç»Ÿä¸€å‘½å |

### 4.4 å¯¼å…¥è·¯å¾„å¯¹æ¯”

```python
# v3.x å¯¼å…¥
from df_test_framework.clients.http.rest.httpx.client import HttpClient
from df_test_framework.clients.http.interceptors.auth.bearer_token import BearerTokenInterceptor
from df_test_framework.databases.uow import UnitOfWork
from df_test_framework.infrastructure.tracing.manager import TracingManager
from df_test_framework.common.exceptions import FrameworkError

# v3.14.0 å¯¼å…¥
from df_test_framework.capabilities.clients.http import HttpClient
from df_test_framework.capabilities.clients.http.middleware import BearerTokenMiddleware
from df_test_framework.capabilities.databases import UnitOfWork
from df_test_framework.infrastructure.telemetry import Telemetry
from df_test_framework.core import FrameworkError

# é¡¶å±‚ä¾¿æ·å¯¼å…¥ï¼ˆæ¨èï¼‰
from df_test_framework import (
    HttpClient,
    UnitOfWork,
    Telemetry,
    FrameworkError,
)
```

---

## 5. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 5.1 ç»Ÿä¸€ä¸­é—´ä»¶ç³»ç»Ÿ

#### 5.1.1 åè®®å®šä¹‰

```python
# core/middleware/protocol.py
from abc import ABC, abstractmethod
from typing import Callable, Awaitable, TypeVar

TRequest = TypeVar("TRequest")
TResponse = TypeVar("TResponse")

# Python 3.12 ç±»å‹åˆ«å
type Next[T, R] = Callable[[T], Awaitable[R]]
type MiddlewareFunc[T, R] = Callable[[T, Next[T, R]], Awaitable[R]]


class Middleware[TRequest, TResponse](ABC):
    """ç»Ÿä¸€ä¸­é—´ä»¶åè®®

    æ´‹è‘±æ¨¡å‹ï¼šbefore å’Œ after åœ¨åŒä¸€ä½œç”¨åŸŸ

    æ³›å‹å®ä¾‹åŒ–ç¤ºä¾‹:
    - Middleware[HttpRequest, HttpResponse]      # HTTP
    - Middleware[GrpcRequest, GrpcResponse]      # gRPC
    - Middleware[Query, QueryResult]             # Database
    - Middleware[Message, PublishResult]         # MQ
    """

    name: str = ""
    priority: int = 100  # æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ

    @abstractmethod
    async def __call__(
        self,
        request: TRequest,
        call_next: Next[TRequest, TResponse]
    ) -> TResponse:
        """æ´‹è‘±æ¨¡å‹æ ¸å¿ƒæ–¹æ³•

        ç¤ºä¾‹:
            async def __call__(self, request, call_next):
                # before é€»è¾‘
                start = time.monotonic()

                # è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–æœ€ç»ˆå¤„ç†å™¨
                response = await call_next(request)

                # after é€»è¾‘ï¼ˆåŒä¸€ä½œç”¨åŸŸï¼Œå¯ç›´æ¥è®¿é—® startï¼‰
                duration = time.monotonic() - start

                return response
        """
        ...


class MiddlewareAbort(Exception):
    """ä¸­é—´ä»¶ä¸»åŠ¨ç»ˆæ­¢è¯·æ±‚

    ä½¿ç”¨åœºæ™¯ï¼šè®¤è¯å¤±è´¥ã€é™æµè§¦å‘ç­‰
    """

    def __init__(
        self,
        message: str = "",
        response: TResponse | None = None
    ):
        super().__init__(message)
        self.response = response
```

#### 5.1.2 ä¸­é—´ä»¶é“¾

```python
# core/middleware/chain.py
from typing import Self


class MiddlewareChain[TRequest, TResponse]:
    """ä¸­é—´ä»¶æ‰§è¡Œé“¾

    æ‰§è¡Œé¡ºåºï¼š
    - before: priority å‡åºï¼ˆå°çš„å…ˆæ‰§è¡Œï¼‰
    - after: priority é™åºï¼ˆå¤§çš„å…ˆæ‰§è¡Œï¼Œå³é€†åºï¼‰

    ç¤ºä¾‹:
        chain = MiddlewareChain(send_request)
        chain.use(AuthMiddleware(priority=20))
        chain.use(SignMiddleware(priority=10))  # å…ˆæ‰§è¡Œ
        chain.use(LogMiddleware(priority=100))  # æœ€åæ‰§è¡Œ

        response = await chain.execute(request)
    """

    def __init__(self, handler: Next[TRequest, TResponse]):
        self._handler = handler
        self._middlewares: list[Middleware[TRequest, TResponse]] = []

    def use(self, middleware: Middleware[TRequest, TResponse]) -> Self:
        """æ·»åŠ ä¸­é—´ä»¶ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰"""
        self._middlewares.append(middleware)
        self._middlewares.sort(key=lambda m: m.priority)
        return self

    def use_many(self, middlewares: list[Middleware]) -> Self:
        """æ‰¹é‡æ·»åŠ ä¸­é—´ä»¶"""
        for m in middlewares:
            self.use(m)
        return self

    async def execute(self, request: TRequest) -> TResponse:
        """æ‰§è¡Œä¸­é—´ä»¶é“¾"""
        # æ„å»ºæ´‹è‘±ï¼šä»å†…åˆ°å¤–åŒ…è£…
        chain = self._handler
        for middleware in reversed(self._middlewares):
            chain = self._wrap(middleware, chain)

        try:
            return await chain(request)
        except MiddlewareAbort as e:
            if e.response is not None:
                return e.response
            raise

    def _wrap(
        self,
        middleware: Middleware[TRequest, TResponse],
        next_handler: Next[TRequest, TResponse]
    ) -> Next[TRequest, TResponse]:
        """åŒ…è£…ä¸­é—´ä»¶"""
        async def wrapped(request: TRequest) -> TResponse:
            return await middleware(request, next_handler)
        return wrapped

    @property
    def middlewares(self) -> list[Middleware]:
        """å·²æ³¨å†Œçš„ä¸­é—´ä»¶åˆ—è¡¨ï¼ˆåªè¯»ï¼‰"""
        return self._middlewares.copy()
```

#### 5.1.3 ä¾¿æ·åŸºç±»

```python
# core/middleware/base.py

class BaseMiddleware[TRequest, TResponse](Middleware[TRequest, TResponse]):
    """ä¸­é—´ä»¶ä¾¿æ·åŸºç±»

    æä¾›é»˜è®¤å®ç°ï¼Œå­ç±»åªéœ€è¦†ç›– __call__
    """

    def __init__(
        self,
        name: str | None = None,
        priority: int = 100
    ):
        self.name = name or self.__class__.__name__
        self.priority = priority

    async def __call__(
        self,
        request: TRequest,
        call_next: Next[TRequest, TResponse]
    ) -> TResponse:
        """é»˜è®¤å®ç°ï¼šç›´æ¥ä¼ é€’"""
        return await call_next(request)


class SyncMiddleware[TRequest, TResponse](BaseMiddleware[TRequest, TResponse]):
    """åŒæ­¥ä¸­é—´ä»¶åŸºç±»

    é€‚ç”¨äºä¸éœ€è¦å¼‚æ­¥æ“ä½œçš„ç®€å•åœºæ™¯

    ç¤ºä¾‹:
        class AddHeaderMiddleware(SyncMiddleware[HttpRequest, HttpResponse]):
            def before(self, request):
                return request.with_header("X-Custom", "value")
    """

    def before(self, request: TRequest) -> TRequest:
        """å‰ç½®å¤„ç†ï¼ˆåŒæ­¥ï¼‰"""
        return request

    def after(self, response: TResponse) -> TResponse:
        """åç½®å¤„ç†ï¼ˆåŒæ­¥ï¼‰"""
        return response

    async def __call__(
        self,
        request: TRequest,
        call_next: Next[TRequest, TResponse]
    ) -> TResponse:
        request = self.before(request)
        response = await call_next(request)
        response = self.after(response)
        return response
```

#### 5.1.4 è£…é¥°å™¨

```python
# core/middleware/decorator.py

def middleware[T, R](
    priority: int = 100,
    name: str | None = None
) -> Callable[[MiddlewareFunc[T, R]], Middleware[T, R]]:
    """è£…é¥°å™¨ï¼šå°†å‡½æ•°è½¬æ¢ä¸ºä¸­é—´ä»¶

    ç¤ºä¾‹:
        @middleware(priority=50)
        async def timing_middleware(request: HttpRequest, call_next) -> HttpResponse:
            start = time.monotonic()
            response = await call_next(request)
            print(f"Duration: {time.monotonic() - start:.3f}s")
            return response

        client.use(timing_middleware)
    """

    def decorator(func: MiddlewareFunc[T, R]) -> Middleware[T, R]:
        class FuncMiddleware(Middleware[T, R]):
            def __init__(self):
                self.name = name or func.__name__
                self.priority = priority

            async def __call__(self, request: T, call_next: Next[T, R]) -> R:
                return await func(request, call_next)

        return FuncMiddleware()

    return decorator
```

### 5.2 ç»Ÿä¸€å¯è§‚æµ‹æ€§ï¼ˆTelemetryï¼‰

#### 5.2.1 Telemetry é—¨é¢

```python
# infrastructure/telemetry/facade.py
from dataclasses import dataclass
from contextlib import asynccontextmanager
from typing import Any


@dataclass(frozen=True, slots=True)
class SpanContext:
    """Span ä¸Šä¸‹æ–‡"""
    trace_id: str
    span_id: str
    trace_flags: int = 0


class Telemetry:
    """ç»Ÿä¸€å¯è§‚æµ‹æ€§é—¨é¢

    èåˆ Tracer + Meter + Loggerï¼Œä¸€æ¬¡åŸ‹ç‚¹ä¸‰ä»½æ•°æ®

    ç¤ºä¾‹:
        telemetry = Telemetry(tracer, meter, logger)

        async with telemetry.span("http.request", {"method": "POST"}) as span:
            response = await send_request()
            span.set_attribute("status_code", response.status_code)
        # è‡ªåŠ¨è®°å½•ï¼š
        # - Trace Spanï¼ˆåŒ…å« durationã€attributesï¼‰
        # - Histogramï¼ˆhttp.request.durationï¼‰
        # - Counterï¼ˆhttp.request.success / http.request.errorï¼‰
        # - Logï¼ˆDEBUG: Starting http.request / ERROR: Error in http.requestï¼‰
    """

    def __init__(
        self,
        tracer: "Tracer",
        meter: "Meter",
        logger: "Logger",
    ):
        self._tracer = tracer
        self._meter = meter
        self._logger = logger

    @asynccontextmanager
    async def span(
        self,
        name: str,
        attributes: dict[str, Any] | None = None,
        *,
        record_exception: bool = True,
        log_level: str = "DEBUG",
    ):
        """åˆ›å»ºè¿½è¸ª Spanï¼ŒåŒæ—¶è®°å½•æŒ‡æ ‡å’Œæ—¥å¿—"""

        start = time.monotonic()
        span = self._tracer.start_span(name, attributes=attributes)

        try:
            self._logger.log(log_level, f"Starting {name}", extra=attributes)
            yield span

            # æˆåŠŸï¼šè®°å½•æŒ‡æ ‡
            duration = time.monotonic() - start
            self._meter.record_histogram(f"{name}.duration", duration, attributes)
            self._meter.increment_counter(f"{name}.success", attributes)

        except Exception as e:
            # å¤±è´¥ï¼šè®°å½•å¼‚å¸¸
            duration = time.monotonic() - start
            self._meter.record_histogram(f"{name}.duration", duration, attributes)
            self._meter.increment_counter(f"{name}.error", attributes)

            if record_exception:
                span.record_exception(e)

            self._logger.error(
                f"Error in {name}: {e}",
                extra=attributes,
                exc_info=True
            )
            raise
        finally:
            span.set_attribute("duration_ms", (time.monotonic() - start) * 1000)
            span.end()

    def inject_context(self, carrier: dict[str, str]) -> None:
        """æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡åˆ°è½½ä½“ï¼ˆHTTP Headers ç­‰ï¼‰"""
        self._tracer.inject(carrier)

    def extract_context(self, carrier: dict[str, str]) -> SpanContext | None:
        """ä»è½½ä½“æå–è¿½è¸ªä¸Šä¸‹æ–‡"""
        return self._tracer.extract(carrier)
```

#### 5.2.2 Telemetry ä¸­é—´ä»¶

```python
# infrastructure/telemetry/middleware.py

class TelemetryMiddleware[TRequest, TResponse](BaseMiddleware[TRequest, TResponse]):
    """å¯è§‚æµ‹æ€§ä¸­é—´ä»¶

    è‡ªåŠ¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»º Spanã€è®°å½•æŒ‡æ ‡ã€è¾“å‡ºæ—¥å¿—
    """

    def __init__(
        self,
        telemetry: Telemetry,
        operation_name: str = "request",
        *,
        extract_attributes: Callable[[TRequest], dict] | None = None,
        inject_context: Callable[[TRequest, dict], TRequest] | None = None,
        priority: int = 1,  # æœ€å…ˆæ‰§è¡Œ
    ):
        super().__init__(name="TelemetryMiddleware", priority=priority)
        self._telemetry = telemetry
        self._operation_name = operation_name
        self._extract_attributes = extract_attributes or (lambda r: {})
        self._inject_context = inject_context

    async def __call__(self, request: TRequest, call_next) -> TResponse:
        attributes = self._extract_attributes(request)

        async with self._telemetry.span(self._operation_name, attributes) as span:
            # æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡åˆ°è¯·æ±‚
            if self._inject_context:
                carrier: dict[str, str] = {}
                self._telemetry.inject_context(carrier)
                request = self._inject_context(request, carrier)

            response = await call_next(request)

            # è®°å½•å“åº”å±æ€§
            if hasattr(response, "status_code"):
                span.set_attribute("response.status_code", response.status_code)

            return response
```

### 5.3 ä¸Šä¸‹æ–‡ä¼ æ’­ç³»ç»Ÿ

#### 5.3.1 æ‰§è¡Œä¸Šä¸‹æ–‡

```python
# core/context/execution.py
from dataclasses import dataclass, field
from typing import Any
import uuid


def _generate_id() -> str:
    return uuid.uuid4().hex[:16]


@dataclass(frozen=True, slots=True)
class ExecutionContext:
    """æ‰§è¡Œä¸Šä¸‹æ–‡

    è´¯ç©¿æ•´ä¸ªè¯·æ±‚é“¾è·¯ï¼Œè‡ªåŠ¨ä¼ æ’­åˆ°å­æ“ä½œ

    åŒ…å«ï¼š
    - è¿½è¸ªä¿¡æ¯ï¼ˆtrace_id, span_idï¼‰
    - è¯·æ±‚ä¿¡æ¯ï¼ˆrequest_id, correlation_idï¼‰
    - ä¸šåŠ¡ä¿¡æ¯ï¼ˆuser_id, tenant_idï¼‰
    - æ‰©å±•ä¿¡æ¯ï¼ˆbaggageï¼‰
    """

    # è¿½è¸ªä¿¡æ¯
    trace_id: str
    span_id: str
    parent_span_id: str | None = None

    # è¯·æ±‚ä¿¡æ¯
    request_id: str = field(default_factory=_generate_id)
    correlation_id: str | None = None

    # ä¸šåŠ¡ä¿¡æ¯
    user_id: str | None = None
    tenant_id: str | None = None

    # æ‰©å±•ä¿¡æ¯ï¼ˆè·¨æœåŠ¡ä¼ æ’­çš„é”®å€¼å¯¹ï¼‰
    baggage: dict[str, str] = field(default_factory=dict)

    @classmethod
    def create_root(cls) -> "ExecutionContext":
        """åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡"""
        trace_id = _generate_id()
        return cls(
            trace_id=trace_id,
            span_id=_generate_id(),
            request_id=_generate_id(),
        )

    def child_context(self, span_name: str | None = None) -> "ExecutionContext":
        """åˆ›å»ºå­ä¸Šä¸‹æ–‡ï¼ˆæ–° Spanï¼‰"""
        return ExecutionContext(
            trace_id=self.trace_id,
            span_id=_generate_id(),
            parent_span_id=self.span_id,
            request_id=self.request_id,
            correlation_id=self.correlation_id,
            user_id=self.user_id,
            tenant_id=self.tenant_id,
            baggage=self.baggage.copy(),
        )

    def with_baggage(self, key: str, value: str) -> "ExecutionContext":
        """æ·»åŠ  baggage é¡¹"""
        return ExecutionContext(
            trace_id=self.trace_id,
            span_id=self.span_id,
            parent_span_id=self.parent_span_id,
            request_id=self.request_id,
            correlation_id=self.correlation_id,
            user_id=self.user_id,
            tenant_id=self.tenant_id,
            baggage={**self.baggage, key: value},
        )

    def with_user(self, user_id: str) -> "ExecutionContext":
        """è®¾ç½®ç”¨æˆ· ID"""
        return ExecutionContext(
            trace_id=self.trace_id,
            span_id=self.span_id,
            parent_span_id=self.parent_span_id,
            request_id=self.request_id,
            correlation_id=self.correlation_id,
            user_id=user_id,
            tenant_id=self.tenant_id,
            baggage=self.baggage,
        )
```

#### 5.3.2 ä¸Šä¸‹æ–‡ä¼ æ’­

```python
# core/context/propagation.py
from contextvars import ContextVar
from contextlib import contextmanager, asynccontextmanager


# å…¨å±€ä¸Šä¸‹æ–‡å˜é‡
_current_context: ContextVar[ExecutionContext | None] = ContextVar(
    "execution_context",
    default=None
)


def get_current_context() -> ExecutionContext | None:
    """è·å–å½“å‰ä¸Šä¸‹æ–‡"""
    return _current_context.get()


def get_or_create_context() -> ExecutionContext:
    """è·å–å½“å‰ä¸Šä¸‹æ–‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ ¹ä¸Šä¸‹æ–‡"""
    ctx = _current_context.get()
    if ctx is None:
        ctx = ExecutionContext.create_root()
        _current_context.set(ctx)
    return ctx


@contextmanager
def with_context(ctx: ExecutionContext):
    """åŒæ­¥ä¸Šä¸‹æ–‡ä½œç”¨åŸŸ"""
    token = _current_context.set(ctx)
    try:
        yield ctx
    finally:
        _current_context.reset(token)


@asynccontextmanager
async def with_context_async(ctx: ExecutionContext):
    """å¼‚æ­¥ä¸Šä¸‹æ–‡ä½œç”¨åŸŸ"""
    token = _current_context.set(ctx)
    try:
        yield ctx
    finally:
        _current_context.reset(token)


def run_with_context[T](ctx: ExecutionContext, func: Callable[[], T]) -> T:
    """åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­è¿è¡Œå‡½æ•°"""
    with with_context(ctx):
        return func()
```

#### 5.3.3 HTTP è½½ä½“

```python
# core/context/carriers/http.py

# æ ‡å‡† Header åç§°
TRACE_ID_HEADER = "X-Trace-Id"
SPAN_ID_HEADER = "X-Span-Id"
PARENT_SPAN_ID_HEADER = "X-Parent-Span-Id"
REQUEST_ID_HEADER = "X-Request-Id"
BAGGAGE_HEADER_PREFIX = "X-Baggage-"


class HttpContextCarrier:
    """HTTP ä¸Šä¸‹æ–‡è½½ä½“

    è´Ÿè´£åœ¨ HTTP Headers ä¸­æ³¨å…¥å’Œæå– ExecutionContext
    """

    @staticmethod
    def inject(ctx: ExecutionContext, headers: dict[str, str]) -> dict[str, str]:
        """æ³¨å…¥ä¸Šä¸‹æ–‡åˆ° HTTP Headers"""
        result = headers.copy()

        result[TRACE_ID_HEADER] = ctx.trace_id
        result[SPAN_ID_HEADER] = ctx.span_id
        result[REQUEST_ID_HEADER] = ctx.request_id

        if ctx.parent_span_id:
            result[PARENT_SPAN_ID_HEADER] = ctx.parent_span_id

        # æ³¨å…¥ baggage
        for key, value in ctx.baggage.items():
            result[f"{BAGGAGE_HEADER_PREFIX}{key}"] = value

        return result

    @staticmethod
    def extract(headers: dict[str, str]) -> ExecutionContext | None:
        """ä» HTTP Headers æå–ä¸Šä¸‹æ–‡"""
        trace_id = headers.get(TRACE_ID_HEADER)
        if not trace_id:
            return None

        # æå– baggage
        baggage = {}
        for key, value in headers.items():
            if key.startswith(BAGGAGE_HEADER_PREFIX):
                baggage_key = key[len(BAGGAGE_HEADER_PREFIX):]
                baggage[baggage_key] = value

        return ExecutionContext(
            trace_id=trace_id,
            span_id=headers.get(SPAN_ID_HEADER, _generate_id()),
            parent_span_id=headers.get(PARENT_SPAN_ID_HEADER),
            request_id=headers.get(REQUEST_ID_HEADER, _generate_id()),
            baggage=baggage,
        )
```

### 5.4 äº‹ä»¶æ€»çº¿

#### 5.4.1 äº‹ä»¶ç±»å‹

```python
# core/events/types.py
from dataclasses import dataclass, field
from datetime import datetime
from typing import Any


@dataclass(frozen=True)
class Event:
    """äº‹ä»¶åŸºç±»"""
    timestamp: datetime = field(default_factory=datetime.now)
    context: ExecutionContext | None = None


# HTTP äº‹ä»¶
@dataclass(frozen=True)
class HttpRequestStartEvent(Event):
    """HTTP è¯·æ±‚å¼€å§‹"""
    method: str
    url: str
    headers: dict[str, str] = field(default_factory=dict)


@dataclass(frozen=True)
class HttpRequestEndEvent(Event):
    """HTTP è¯·æ±‚ç»“æŸ"""
    method: str
    url: str
    status_code: int
    duration: float
    headers: dict[str, str] = field(default_factory=dict)
    body: str | None = None


@dataclass(frozen=True)
class HttpRequestErrorEvent(Event):
    """HTTP è¯·æ±‚é”™è¯¯"""
    method: str
    url: str
    error: Exception
    duration: float


# Database äº‹ä»¶
@dataclass(frozen=True)
class DatabaseQueryStartEvent(Event):
    """æ•°æ®åº“æŸ¥è¯¢å¼€å§‹"""
    sql: str
    params: dict[str, Any] = field(default_factory=dict)


@dataclass(frozen=True)
class DatabaseQueryEndEvent(Event):
    """æ•°æ®åº“æŸ¥è¯¢ç»“æŸ"""
    sql: str
    params: dict[str, Any]
    duration: float
    row_count: int


@dataclass(frozen=True)
class DatabaseQueryErrorEvent(Event):
    """æ•°æ®åº“æŸ¥è¯¢é”™è¯¯"""
    sql: str
    params: dict[str, Any]
    error: Exception
    duration: float


# MQ äº‹ä»¶
@dataclass(frozen=True)
class MessagePublishEvent(Event):
    """æ¶ˆæ¯å‘å¸ƒ"""
    topic: str
    message_id: str
    body_size: int


@dataclass(frozen=True)
class MessageConsumeEvent(Event):
    """æ¶ˆæ¯æ¶ˆè´¹"""
    topic: str
    message_id: str
    consumer_group: str
    processing_time: float


# æµ‹è¯•äº‹ä»¶
@dataclass(frozen=True)
class TestStartEvent(Event):
    """æµ‹è¯•å¼€å§‹"""
    test_name: str
    test_file: str
    markers: list[str] = field(default_factory=list)


@dataclass(frozen=True)
class TestEndEvent(Event):
    """æµ‹è¯•ç»“æŸ"""
    test_name: str
    test_file: str
    status: str  # passed, failed, skipped, error
    duration: float
    failure_message: str | None = None
```

#### 5.4.2 äº‹ä»¶æ€»çº¿

```python
# core/events/bus.py
from typing import Callable, Awaitable, TypeVar
import asyncio
import logging

T = TypeVar("T", bound=Event)

EventHandler = Callable[[Event], Awaitable[None]]


class EventBus:
    """äº‹ä»¶æ€»çº¿

    å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œè§£è€¦ç»„ä»¶é€šä¿¡

    ç‰¹æ€§ï¼š
    - å¼‚æ­¥å¤„ç†
    - äº‹ä»¶å¤„ç†å¼‚å¸¸ä¸å½±å“ä¸»æµç¨‹
    - æ”¯æŒé€šé…ç¬¦è®¢é˜…

    ç¤ºä¾‹:
        bus = EventBus()

        @bus.on(HttpRequestEndEvent)
        async def log_request(event: HttpRequestEndEvent):
            print(f"{event.method} {event.url} -> {event.status_code}")

        # å‘å¸ƒäº‹ä»¶
        await bus.publish(HttpRequestEndEvent(method="GET", url="/api", ...))
    """

    def __init__(self, logger: logging.Logger | None = None):
        self._handlers: dict[type[Event], list[EventHandler]] = {}
        self._global_handlers: list[EventHandler] = []
        self._logger = logger or logging.getLogger(__name__)

    def subscribe(
        self,
        event_type: type[T],
        handler: Callable[[T], Awaitable[None]]
    ) -> None:
        """è®¢é˜…ç‰¹å®šç±»å‹äº‹ä»¶"""
        if event_type not in self._handlers:
            self._handlers[event_type] = []
        self._handlers[event_type].append(handler)

    def subscribe_all(self, handler: EventHandler) -> None:
        """è®¢é˜…æ‰€æœ‰äº‹ä»¶"""
        self._global_handlers.append(handler)

    def unsubscribe(
        self,
        event_type: type[T],
        handler: Callable[[T], Awaitable[None]]
    ) -> None:
        """å–æ¶ˆè®¢é˜…"""
        if event_type in self._handlers:
            self._handlers[event_type].remove(handler)

    async def publish(self, event: Event) -> None:
        """å‘å¸ƒäº‹ä»¶"""
        handlers = self._handlers.get(type(event), []) + self._global_handlers

        if not handlers:
            return

        # å¹¶å‘æ‰§è¡Œæ‰€æœ‰å¤„ç†å™¨
        tasks = [self._safe_call(handler, event) for handler in handlers]
        await asyncio.gather(*tasks)

    async def _safe_call(self, handler: EventHandler, event: Event) -> None:
        """å®‰å…¨è°ƒç”¨å¤„ç†å™¨ï¼ˆå¼‚å¸¸ä¸ä¼ æ’­ï¼‰"""
        try:
            await handler(event)
        except Exception as e:
            self._logger.warning(
                f"Event handler error: {handler.__name__} failed with {e}",
                exc_info=True
            )

    def on(self, event_type: type[T]):
        """è£…é¥°å™¨ï¼šè®¢é˜…äº‹ä»¶

        ç¤ºä¾‹:
            @bus.on(HttpRequestEndEvent)
            async def handle(event):
                ...
        """
        def decorator(handler: Callable[[T], Awaitable[None]]):
            self.subscribe(event_type, handler)
            return handler
        return decorator


# å…¨å±€äº‹ä»¶æ€»çº¿
_global_event_bus: EventBus | None = None


def get_event_bus() -> EventBus:
    """è·å–å…¨å±€äº‹ä»¶æ€»çº¿"""
    global _global_event_bus
    if _global_event_bus is None:
        _global_event_bus = EventBus()
    return _global_event_bus


def set_event_bus(bus: EventBus) -> None:
    """è®¾ç½®å…¨å±€äº‹ä»¶æ€»çº¿"""
    global _global_event_bus
    _global_event_bus = bus
```

---

## 6. èƒ½åŠ›å±‚é€‚é…

### 6.1 HTTP å®¢æˆ·ç«¯

```python
# http/client.py
from dataclasses import dataclass, field, replace
from typing import Any, Self
import httpx

from df_test_framework.core.middleware import MiddlewareChain, Middleware
from df_test_framework.infrastructure.telemetry import Telemetry
from df_test_framework.core.context import get_or_create_context, HttpContextCarrier
from df_test_framework.core.events import EventBus, HttpRequestStartEvent, HttpRequestEndEvent


@dataclass(frozen=True, slots=True)
class HttpRequest:
    """HTTP è¯·æ±‚å¯¹è±¡ï¼ˆä¸å¯å˜ï¼‰"""
    method: str
    path: str
    headers: dict[str, str] = field(default_factory=dict)
    params: dict[str, Any] = field(default_factory=dict)
    json: dict[str, Any] | None = None
    data: bytes | None = None
    files: dict[str, Any] | None = None

    def with_header(self, key: str, value: str) -> "HttpRequest":
        return replace(self, headers={**self.headers, key: value})

    def with_headers(self, headers: dict[str, str]) -> "HttpRequest":
        return replace(self, headers={**self.headers, **headers})

    def with_param(self, key: str, value: Any) -> "HttpRequest":
        return replace(self, params={**self.params, key: value})


@dataclass(frozen=True, slots=True)
class HttpResponse:
    """HTTP å“åº”å¯¹è±¡ï¼ˆä¸å¯å˜ï¼‰"""
    status_code: int
    headers: dict[str, str] = field(default_factory=dict)
    body: bytes = b""
    json_data: dict[str, Any] | None = None
    elapsed: float = 0.0

    @property
    def text(self) -> str:
        return self.body.decode("utf-8")

    @property
    def is_success(self) -> bool:
        return 200 <= self.status_code < 300

    @property
    def json(self) -> dict[str, Any]:
        if self.json_data is None:
            raise ValueError("Response is not JSON")
        return self.json_data


# ç±»å‹åˆ«å
type HttpMiddleware = Middleware[HttpRequest, HttpResponse]
type HttpNext = Callable[[HttpRequest], Awaitable[HttpResponse]]


class HttpClient:
    """HTTP å®¢æˆ·ç«¯

    å¼‚æ­¥ä¼˜å…ˆï¼Œç»Ÿä¸€ä¸­é—´ä»¶æ¶æ„

    ç¤ºä¾‹:
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = HttpClient(
            base_url="https://api.example.com",
            middlewares=[
                SignatureMiddleware(secret="xxx"),
                BearerTokenMiddleware(token="yyy"),
            ]
        )

        # å¼‚æ­¥è¯·æ±‚
        async with client:
            response = await client.post("/orders", json={"amount": 100})

        # é“¾å¼æ·»åŠ ä¸­é—´ä»¶
        client.use(LoggingMiddleware())
    """

    def __init__(
        self,
        base_url: str = "",
        timeout: float = 30.0,
        headers: dict[str, str] | None = None,
        middlewares: list[HttpMiddleware] | None = None,
        telemetry: Telemetry | None = None,
        event_bus: EventBus | None = None,
    ):
        self.base_url = base_url
        self._timeout = timeout
        self._default_headers = headers or {}
        self._telemetry = telemetry
        self._event_bus = event_bus

        self._client = httpx.AsyncClient(
            base_url=base_url,
            timeout=timeout,
            http2=True,  # é»˜è®¤å¯ç”¨ HTTP/2
        )

        self._chain = MiddlewareChain(self._send)

        # è‡ªåŠ¨æ·»åŠ å¯è§‚æµ‹æ€§ä¸­é—´ä»¶
        if telemetry:
            from df_test_framework.http.middleware import HttpTelemetryMiddleware
            self._chain.use(HttpTelemetryMiddleware(telemetry))

        if middlewares:
            self._chain.use_many(middlewares)

    def use(self, middleware: HttpMiddleware) -> Self:
        """æ·»åŠ ä¸­é—´ä»¶ï¼ˆé“¾å¼è°ƒç”¨ï¼‰"""
        self._chain.use(middleware)
        return self

    async def _send(self, request: HttpRequest) -> HttpResponse:
        """æ ¸å¿ƒå‘é€æ–¹æ³•"""
        # ä¸Šä¸‹æ–‡ä¼ æ’­
        ctx = get_or_create_context()
        headers = HttpContextCarrier.inject(ctx, request.headers)

        # å‘å¸ƒè¯·æ±‚å¼€å§‹äº‹ä»¶
        if self._event_bus:
            await self._event_bus.publish(HttpRequestStartEvent(
                method=request.method,
                url=f"{self.base_url}{request.path}",
                headers=headers,
                context=ctx,
            ))

        start = time.monotonic()

        httpx_response = await self._client.request(
            method=request.method,
            url=request.path,
            headers={**self._default_headers, **headers},
            params=request.params or None,
            json=request.json,
            content=request.data,
            files=request.files,
        )

        elapsed = time.monotonic() - start

        # è§£æ JSON
        json_data = None
        content_type = httpx_response.headers.get("content-type", "")
        if "application/json" in content_type:
            try:
                json_data = httpx_response.json()
            except Exception:
                pass

        response = HttpResponse(
            status_code=httpx_response.status_code,
            headers=dict(httpx_response.headers),
            body=httpx_response.content,
            json_data=json_data,
            elapsed=elapsed,
        )

        # å‘å¸ƒè¯·æ±‚ç»“æŸäº‹ä»¶
        if self._event_bus:
            await self._event_bus.publish(HttpRequestEndEvent(
                method=request.method,
                url=f"{self.base_url}{request.path}",
                status_code=response.status_code,
                duration=elapsed,
                context=ctx,
            ))

        return response

    async def request(
        self,
        method: str,
        path: str,
        **kwargs: Any
    ) -> HttpResponse:
        """å‘é€è¯·æ±‚"""
        request = HttpRequest(
            method=method,
            path=path,
            headers=kwargs.get("headers", {}),
            params=kwargs.get("params", {}),
            json=kwargs.get("json"),
            data=kwargs.get("data"),
            files=kwargs.get("files"),
        )
        return await self._chain.execute(request)

    # ä¾¿æ·æ–¹æ³•
    async def get(self, path: str, **kwargs) -> HttpResponse:
        return await self.request("GET", path, **kwargs)

    async def post(self, path: str, **kwargs) -> HttpResponse:
        return await self.request("POST", path, **kwargs)

    async def put(self, path: str, **kwargs) -> HttpResponse:
        return await self.request("PUT", path, **kwargs)

    async def patch(self, path: str, **kwargs) -> HttpResponse:
        return await self.request("PATCH", path, **kwargs)

    async def delete(self, path: str, **kwargs) -> HttpResponse:
        return await self.request("DELETE", path, **kwargs)

    # åŒæ­¥ APIï¼ˆä¾¿æ·åŒ…è£…ï¼‰
    # æ³¨æ„ï¼šPython 3.12+ ä¸å†æ”¯æŒ asyncio.get_event_loop().run_until_complete()
    def get_sync(self, path: str, **kwargs) -> HttpResponse:
        return asyncio.run(self.get(path, **kwargs))

    def post_sync(self, path: str, **kwargs) -> HttpResponse:
        return asyncio.run(self.post(path, **kwargs))

    def put_sync(self, path: str, **kwargs) -> HttpResponse:
        return asyncio.run(self.put(path, **kwargs))

    def patch_sync(self, path: str, **kwargs) -> HttpResponse:
        return asyncio.run(self.patch(path, **kwargs))

    def delete_sync(self, path: str, **kwargs) -> HttpResponse:
        return asyncio.run(self.delete(path, **kwargs))

    # ä¸Šä¸‹æ–‡ç®¡ç†
    async def __aenter__(self) -> Self:
        return self

    async def __aexit__(self, *args) -> None:
        await self._client.aclose()

    def __enter__(self) -> Self:
        return self

    def __exit__(self, *args) -> None:
        asyncio.run(self._client.aclose())
```

### 6.2 HTTP ä¸­é—´ä»¶ç¤ºä¾‹

```python
# http/middleware/signature/middleware.py

class SignatureMiddleware(BaseMiddleware[HttpRequest, HttpResponse]):
    """ç­¾åä¸­é—´ä»¶

    è‡ªåŠ¨ä¸ºè¯·æ±‚æ·»åŠ ç­¾å Header
    """

    def __init__(
        self,
        secret: str,
        algorithm: Literal["md5", "sha256", "hmac-sha256"] = "md5",
        header_name: str = "X-Sign",
        include_params: bool = True,
        include_body: bool = True,
        priority: int = 10,
    ):
        super().__init__(name="SignatureMiddleware", priority=priority)
        self.secret = secret
        self.algorithm = algorithm
        self.header_name = header_name
        self.include_params = include_params
        self.include_body = include_body

    async def __call__(
        self,
        request: HttpRequest,
        call_next: HttpNext
    ) -> HttpResponse:
        # æ”¶é›†ç­¾åæ•°æ®
        data = {}
        if self.include_params:
            data.update(request.params)
        if self.include_body and request.json:
            data.update(request.json)

        # ç”Ÿæˆç­¾å
        signature = self._sign(data)

        # æ·»åŠ ç­¾åå¤´
        request = request.with_header(self.header_name, signature)

        return await call_next(request)

    def _sign(self, data: dict) -> str:
        sorted_items = sorted(data.items(), key=lambda x: x[0])
        values = "&".join(str(v) for k, v in sorted_items if v)
        sign_string = f"{values}{self.secret}"

        match self.algorithm:
            case "md5":
                return hashlib.md5(sign_string.encode()).hexdigest()
            case "sha256":
                return hashlib.sha256(sign_string.encode()).hexdigest()
            case "hmac-sha256":
                return hmac.new(
                    self.secret.encode(),
                    values.encode(),
                    "sha256"
                ).hexdigest()


# http/middleware/retry.py

class RetryMiddleware(BaseMiddleware[HttpRequest, HttpResponse]):
    """é‡è¯•ä¸­é—´ä»¶

    è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
    """

    def __init__(
        self,
        max_attempts: int = 3,
        backoff: float = 1.0,
        backoff_factor: float = 2.0,
        retry_on_status: list[int] | None = None,
        retry_on_exception: tuple[type[Exception], ...] = (httpx.TimeoutException,),
        priority: int = 5,
    ):
        super().__init__(name="RetryMiddleware", priority=priority)
        self.max_attempts = max_attempts
        self.backoff = backoff
        self.backoff_factor = backoff_factor
        self.retry_on_status = retry_on_status or [500, 502, 503, 504]
        self.retry_on_exception = retry_on_exception

    async def __call__(
        self,
        request: HttpRequest,
        call_next: HttpNext
    ) -> HttpResponse:
        last_exception: Exception | None = None
        last_response: HttpResponse | None = None

        for attempt in range(self.max_attempts):
            try:
                response = await call_next(request)

                if response.status_code not in self.retry_on_status:
                    return response

                last_response = response

            except self.retry_on_exception as e:
                last_exception = e

            # ç­‰å¾…åé‡è¯•
            if attempt < self.max_attempts - 1:
                wait_time = self.backoff * (self.backoff_factor ** attempt)
                await asyncio.sleep(wait_time)

        if last_response:
            return last_response

        if last_exception:
            raise last_exception

        raise RuntimeError("Unexpected retry state")
```

### 6.3 UnitOfWork å¢å¼º

```python
# database/uow.py
from typing import Callable, Any
from sqlalchemy.orm import Session

from df_test_framework.core.context import get_or_create_context, with_context_async
from df_test_framework.infrastructure.telemetry import Telemetry
from df_test_framework.core.events import EventBus


class UnitOfWork:
    """Unit of Work æ¨¡å¼

    v3.14.0 å¢å¼ºï¼šèåˆä¸Šä¸‹æ–‡ä¼ æ’­å’Œäº‹ä»¶å‘å¸ƒ

    ç‰¹æ€§ï¼š
    - è‡ªåŠ¨å‘ç° Repository
    - ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¼ æ’­
    - å¯è§‚æµ‹æ€§é›†æˆ
    - é…ç½®é©±åŠ¨

    ç¤ºä¾‹:
        async with UnitOfWork(session_factory, repository_package="app.repos") as uow:
            user = uow.users.find_by_id(1)
            uow.orders.create({"user_id": user.id, "amount": 100})
            await uow.commit()
    """

    def __init__(
        self,
        session_factory: Callable[[], Session],
        repository_package: str | None = None,
        telemetry: Telemetry | None = None,
        event_bus: EventBus | None = None,
    ):
        self._session_factory = session_factory
        self._repository_package = repository_package
        self._telemetry = telemetry
        self._event_bus = event_bus

        self._session: Session | None = None
        self._repositories: dict[str, "BaseRepository"] = {}
        self._context: "ExecutionContext | None" = None

    async def __aenter__(self) -> "UnitOfWork":
        # ç»§æ‰¿å½“å‰ä¸Šä¸‹æ–‡æˆ–åˆ›å»ºæ–°çš„
        parent_ctx = get_or_create_context()
        self._context = parent_ctx.child_context()

        self._session = self._session_factory()

        if self._repository_package:
            self._auto_discover_repositories()

        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            await self.rollback()

        if self._session:
            self._session.close()

    def __getattr__(self, name: str) -> "BaseRepository":
        """åŠ¨æ€è·å– Repository"""
        if name.startswith("_"):
            raise AttributeError(f"'{type(self).__name__}' has no attribute '{name}'")

        if name not in self._repositories:
            raise AttributeError(f"Repository '{name}' not found")

        return self._repositories[name]

    @property
    def session(self) -> Session:
        if self._session is None:
            raise RuntimeError("UnitOfWork not entered")
        return self._session

    def register_repository(
        self,
        name: str,
        repo_class: type["BaseRepository"]
    ) -> None:
        """æ³¨å†Œ Repository"""
        self._repositories[name] = repo_class(
            session=self.session,
            telemetry=self._telemetry,
            event_bus=self._event_bus,
        )

    async def commit(self) -> None:
        """æäº¤äº‹åŠ¡"""
        if self._telemetry:
            async with self._telemetry.span("uow.commit"):
                self._session.commit()
        else:
            self._session.commit()

    async def rollback(self) -> None:
        """å›æ»šäº‹åŠ¡"""
        if self._telemetry:
            async with self._telemetry.span("uow.rollback"):
                self._session.rollback()
        else:
            self._session.rollback()

    def _auto_discover_repositories(self) -> None:
        """è‡ªåŠ¨å‘ç° Repository"""
        import importlib
        import inspect

        try:
            module = importlib.import_module(self._repository_package)
        except ImportError:
            return

        for name, obj in inspect.getmembers(module):
            if (
                inspect.isclass(obj)
                and issubclass(obj, BaseRepository)
                and obj is not BaseRepository
            ):
                # ç±»åè½¬å±æ€§åï¼šUserRepository -> users
                attr_name = self._class_to_attr_name(name)
                self.register_repository(attr_name, obj)

    @staticmethod
    def _class_to_attr_name(class_name: str) -> str:
        """UserRepository -> users"""
        import re
        name = re.sub(r"Repository$", "", class_name)
        # CamelCase to snake_case
        name = re.sub(r"(?<!^)(?=[A-Z])", "_", name).lower()
        # å¤æ•°åŒ–
        if not name.endswith("s"):
            name += "s"
        return name
```

---

## 7. æµ‹è¯•æ”¯æŒå±‚å¢å¼º

### 7.1 æ ¸å¿ƒ Fixtures

```python
# testing/fixtures/core.py
import pytest
from typing import AsyncGenerator

from df_test_framework.infra.runtime import RuntimeContext
from df_test_framework.infra.bootstrap import Bootstrap
from df_test_framework.http import HttpClient
from df_test_framework.database import Database, UnitOfWork
from df_test_framework.infrastructure.telemetry import Telemetry
from df_test_framework.core.events import EventBus


@pytest.fixture(scope="session")
def event_loop():
    """Session çº§åˆ«äº‹ä»¶å¾ªç¯"""
    import asyncio
    loop = asyncio.new_event_loop()
    yield loop
    loop.close()


@pytest.fixture(scope="session")
def runtime() -> RuntimeContext:
    """è¿è¡Œæ—¶ä¸Šä¸‹æ–‡"""
    app = Bootstrap().build()
    runtime = app.build_runtime()
    yield runtime
    runtime.close()


@pytest.fixture(scope="session")
def telemetry(runtime: RuntimeContext) -> Telemetry:
    """å¯è§‚æµ‹æ€§å®ä¾‹"""
    return runtime.get("telemetry")


@pytest.fixture(scope="session")
def event_bus(runtime: RuntimeContext) -> EventBus:
    """äº‹ä»¶æ€»çº¿"""
    return runtime.get("event_bus")


@pytest.fixture
async def http_client(
    runtime: RuntimeContext,
    telemetry: Telemetry,
    event_bus: EventBus,
) -> AsyncGenerator[HttpClient, None]:
    """HTTP å®¢æˆ·ç«¯"""
    settings = runtime.settings

    client = HttpClient(
        base_url=settings.http.base_url,
        timeout=settings.http.timeout,
        telemetry=telemetry,
        event_bus=event_bus,
    )

    # ä»é…ç½®åŠ è½½ä¸­é—´ä»¶
    from df_test_framework.http.middleware import MiddlewareFactory
    for config in settings.http.middlewares:
        middleware = MiddlewareFactory.create(config)
        if middleware:
            client.use(middleware)

    async with client:
        yield client


@pytest.fixture
async def uow(
    runtime: RuntimeContext,
    telemetry: Telemetry,
    event_bus: EventBus,
    request,
) -> AsyncGenerator[UnitOfWork, None]:
    """Unit of Work"""
    settings = runtime.settings
    database: Database = runtime.get("database")

    async with UnitOfWork(
        session_factory=database.session_factory,
        repository_package=settings.test.repository_package,
        telemetry=telemetry,
        event_bus=event_bus,
    ) as uow:
        yield uow

        # æ ¹æ®é…ç½®å†³å®šæ˜¯å¦å›æ»š
        if not should_keep_test_data(request):
            await uow.rollback()
```

### 7.2 Allure é›†æˆ

```python
# testing/reporting/allure/observer.py
from df_test_framework.core.events import (
    EventBus,
    HttpRequestStartEvent,
    HttpRequestEndEvent,
    DatabaseQueryEndEvent,
)


class AllureEventHandler:
    """Allure äº‹ä»¶å¤„ç†å™¨

    è®¢é˜…äº‹ä»¶æ€»çº¿ï¼Œè‡ªåŠ¨è®°å½•åˆ° Allure æŠ¥å‘Š
    """

    def __init__(self, event_bus: EventBus):
        self._event_bus = event_bus
        self._register_handlers()

    def _register_handlers(self):
        self._event_bus.subscribe(HttpRequestEndEvent, self._on_http_request)
        self._event_bus.subscribe(DatabaseQueryEndEvent, self._on_db_query)

    async def _on_http_request(self, event: HttpRequestEndEvent):
        """è®°å½• HTTP è¯·æ±‚åˆ° Allure"""
        import allure

        with allure.step(f"{event.method} {event.url}"):
            allure.attach(
                f"Status: {event.status_code}\nDuration: {event.duration:.3f}s",
                name="Response Info",
                attachment_type=allure.attachment_type.TEXT
            )

    async def _on_db_query(self, event: DatabaseQueryEndEvent):
        """è®°å½•æ•°æ®åº“æŸ¥è¯¢åˆ° Allure"""
        import allure

        with allure.step(f"SQL Query ({event.duration:.3f}s)"):
            allure.attach(
                event.sql,
                name="SQL",
                attachment_type=allure.attachment_type.TEXT
            )
```

---

## 8. æ’ä»¶ç³»ç»Ÿ

### 8.1 æ’ä»¶æ¶æ„

v3.14.0 æ’ä»¶ç³»ç»Ÿéµå¾ª **Core çº¯å‡€ + å•ä¸€æ•°æ®æº** åŸåˆ™ï¼š

1. **core/protocols/plugin.py**: `IPluginManager` æ¥å£ï¼ˆçº¯ Python Protocolï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–ï¼‰
2. **infrastructure/plugins/hooks.py**: HookSpecs å•ä¸€æ•°æ®æºï¼ˆä¾èµ– pluggy @hookspecï¼‰
3. **infrastructure/plugins/manager.py**: PluggyPluginManager å…·ä½“å®ç°
4. **plugins/**: æ’ä»¶å®ç°ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¯ä¾èµ–ä»»æ„å±‚çº§ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          core/ (Layer 0 - çº¯æŠ½è±¡)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ protocols/plugin.py                                                 â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚ â”‚ class IPluginManager(Protocol):                                 â”‚ â”‚    â”‚
â”‚  â”‚ â”‚   def register(plugin, name) -> str | None                      â”‚ â”‚    â”‚
â”‚  â”‚ â”‚   def unregister(plugin) -> None                                â”‚ â”‚    â”‚
â”‚  â”‚ â”‚   def hook() -> Any                                             â”‚ â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              å®ç°æ¥å£ (ä¾èµ–åè½¬)
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     infrastructure/plugins/ (Layer 1 - å…·ä½“å®ç°)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     hooks.py            â”‚  â”‚     manager.py                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ class HookSpecs:    â”‚ â”‚  â”‚ â”‚ class PluggyPluginManager           â”‚ â”‚   â”‚
â”‚  â”‚ â”‚  @hookspec          â”‚ â”‚  â”‚ â”‚   (å®ç° IPluginManager)             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚  df_config_sources  â”‚ â”‚  â”‚ â”‚   ä½¿ç”¨ HookSpecs                    â”‚ â”‚   â”‚
â”‚  â”‚ â”‚  df_providers       â”‚ â”‚  â”‚ â”‚   ä¾èµ–: pluggy                      â”‚ â”‚   â”‚
â”‚  â”‚ â”‚  df_http_middlewaresâ”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚ â”‚  ...                â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              å®ç° HookSpecs
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        plugins/ (æ¨ªåˆ‡å…³æ³¨ç‚¹ - æ’ä»¶å®ç°)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  builtin/monitoring/    â”‚  â”‚  builtin/reporting/                     â”‚   â”‚
â”‚  â”‚  ç›‘æ§æ’ä»¶               â”‚  â”‚  Allure æŠ¥å‘Šæ’ä»¶                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ¥å£å®šä¹‰ï¼ˆCore å±‚ï¼‰

```python
# core/protocols/plugin.py
from typing import Protocol, Any


class IPluginManager(Protocol):
    """æ’ä»¶ç®¡ç†å™¨æ¥å£

    Core å±‚ä¸å…³å¿ƒå…·ä½“ç”¨ pluggy è¿˜æ˜¯å…¶ä»–åº“å®ç°
    """

    def register(self, plugin: Any, name: str | None = None) -> str | None:
        """æ³¨å†Œæ’ä»¶"""
        ...

    def unregister(self, plugin: Any) -> None:
        """æ³¨é”€æ’ä»¶"""
        ...

    @property
    def hook(self) -> Any:
        """è·å– Hook è°ƒç”¨ä»£ç†"""
        ...
```

### 8.3 Hook è§„èŒƒï¼ˆå•ä¸€æ•°æ®æºè®¾è®¡ï¼‰

**è®¾è®¡åŸåˆ™**ï¼šHookSpecs åªåœ¨ `infrastructure/plugins/hooks.py` ä¸­å®šä¹‰ä¸€æ¬¡ï¼Œä½œä¸ºå”¯ä¸€æ•°æ®æºã€‚

```python
# infrastructure/plugins/hooks.py
"""
æ¡†æ¶ Hook è§„èŒƒ - å•ä¸€æ•°æ®æº

æ‰€æœ‰ Hook å®šä¹‰åªåœ¨æ­¤æ–‡ä»¶ä¸­å®šä¹‰ï¼Œé¿å…é‡å¤ç»´æŠ¤ã€‚
ä½¿ç”¨ pluggy çš„ @hookspec è£…é¥°å™¨ã€‚
"""
import pluggy
from typing import Any

hookspec = pluggy.HookspecMarker("df_test_framework")
hookimpl = pluggy.HookimplMarker("df_test_framework")


class HookSpecs:
    """æ¡†æ¶ Hook è§„èŒƒï¼ˆå•ä¸€æ•°æ®æºï¼‰

    æ‰€æœ‰ Hook éƒ½åœ¨æ­¤ç±»ä¸­å®šä¹‰ï¼Œinfrastructure/plugins/manager.py ç›´æ¥ä½¿ç”¨æ­¤ç±»ã€‚
    """

    @hookspec
    def df_config_sources(self, settings_cls: type) -> list[Any]:
        """è¿”å›é¢å¤–çš„é…ç½®æº"""

    @hookspec
    def df_providers(self, settings: Any, logger: Any) -> dict[str, Any]:
        """è¿”å›è‡ªå®šä¹‰ Provider æ˜ å°„"""

    @hookspec
    def df_post_bootstrap(self, runtime: Any) -> None:
        """Bootstrap å®Œæˆåé’©å­"""

    @hookspec
    def df_http_middlewares(self, settings: Any) -> list[Any]:
        """è¿”å› HTTP ä¸­é—´ä»¶åˆ—è¡¨"""

    @hookspec
    def df_db_middlewares(self, settings: Any) -> list[Any]:
        """è¿”å›æ•°æ®åº“ä¸­é—´ä»¶åˆ—è¡¨"""

    @hookspec
    def df_event_handlers(self, event_bus: Any) -> list[Any]:
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""

    @hookspec
    def df_telemetry_exporters(self, settings: Any) -> list[Any]:
        """è¿”å›é¥æµ‹å¯¼å‡ºå™¨åˆ—è¡¨"""

    @hookspec
    def df_test_setup(self, request: Any, runtime: Any) -> None:
        """æµ‹è¯•å¼€å§‹å‰é’©å­"""

    @hookspec
    def df_test_teardown(self, request: Any, runtime: Any, outcome: Any) -> None:
        """æµ‹è¯•ç»“æŸåé’©å­"""
```

### 8.4 æ’ä»¶ç®¡ç†å™¨å®ç°

```python
# infrastructure/plugins/manager.py
import pluggy
from df_test_framework.core.protocols.plugin import IPluginManager
from df_test_framework.infrastructure.plugins.hooks import HookSpecs, hookimpl  # å¯¼å‡ºä¾›æ’ä»¶ä½¿ç”¨


class PluggyPluginManager(IPluginManager):
    """åŸºäº Pluggy çš„æ’ä»¶ç®¡ç†å™¨å®ç°"""

    def __init__(self, project_name: str = "df_test_framework"):
        self._pm = pluggy.PluginManager(project_name)
        self._pm.add_hookspecs(HookSpecs)  # ç›´æ¥ä½¿ç”¨å•ä¸€æ•°æ®æº

    def register(self, plugin: object, name: str | None = None) -> str | None:
        """æ³¨å†Œæ’ä»¶"""
        return self._pm.register(plugin, name=name)

    def unregister(self, plugin: object) -> None:
        """æ³¨é”€æ’ä»¶"""
        self._pm.unregister(plugin)

    def discover_plugins(self, package: str = "df_test_framework.plugins") -> None:
        """è‡ªåŠ¨å‘ç°å¹¶åŠ è½½æ’ä»¶"""
        # æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰æ’ä»¶æ¨¡å—
        ...

    @property
    def hook(self):
        """è·å– Hook è°ƒç”¨ä»£ç†"""
        return self._pm.hook
```

**å…³äº Core å±‚çº¯å‡€æ€§çš„è¯´æ˜**ï¼š

è™½ç„¶ HookSpecs ä½äº `infrastructure/`ï¼ˆä¾èµ– pluggyï¼‰ï¼Œä½† `core/protocols/plugin.py`
ä»ç„¶å®šä¹‰äº† `IPluginManager` æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°ã€‚è¿™æ ·ï¼š

1. **core/** ä¿æŒæ— ç¬¬ä¸‰æ–¹ä¾èµ–
2. **infrastructure/plugins/hooks.py** ä½œä¸º HookSpecs çš„å”¯ä¸€å®šä¹‰ç‚¹
3. é¿å…äº†ä¸¤å¤„å®šä¹‰éœ€è¦åŒæ­¥ç»´æŠ¤çš„é—®é¢˜

### 8.5 æ’ä»¶ç¤ºä¾‹

```python
# è‡ªå®šä¹‰æ’ä»¶ç¤ºä¾‹ï¼šè‡ªåŠ¨å‘Šè­¦æ’ä»¶

# my_plugins/alert_plugin.py
from df_test_framework.core.events import HttpRequestEndEvent, EventBus


class AlertPlugin:
    """å‘Šè­¦æ’ä»¶

    HTTP è¯·æ±‚è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
    """

    def __init__(self, threshold: float = 5.0):
        self.threshold = threshold

    def df_event_handlers(self, event_bus: EventBus):
        """æ³¨å†Œäº‹ä»¶å¤„ç†å™¨"""

        @event_bus.on(HttpRequestEndEvent)
        async def check_slow_request(event: HttpRequestEndEvent):
            if event.duration > self.threshold:
                await self._send_alert(
                    f"Slow request: {event.method} {event.url} "
                    f"took {event.duration:.2f}s"
                )

        return [check_slow_request]

    async def _send_alert(self, message: str):
        # å‘é€é’‰é’‰/é£ä¹¦/Slack å‘Šè­¦
        ...


# ä½¿ç”¨
Bootstrap()
    .with_plugin(AlertPlugin(threshold=3.0))
    .build()
```

### 8.6 å†…ç½®æ’ä»¶

| æ’ä»¶ | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| **MonitoringPlugin** | `plugins/builtin/monitoring/` | æ€§èƒ½ç›‘æ§ã€æŒ‡æ ‡é‡‡é›† |
| **AllurePlugin** | `plugins/builtin/reporting/` | Allure æŠ¥å‘Šé›†æˆ |

### 8.7 ä¾èµ–æ³¨å…¥ä½¿ç”¨

è°ƒç”¨ç«¯é€šè¿‡ä¾èµ–æ³¨å…¥è·å– `IPluginManager`ï¼Œä¸åœ¨ core å†…ç›´æ¥å®ä¾‹åŒ–å…·ä½“å®ç°ï¼š

```python
# infrastructure/bootstrap/bootstrap.py
from df_test_framework.core.protocols.plugin import IPluginManager
from df_test_framework.infrastructure.plugins.manager import PluggyPluginManager


class Bootstrap:
    def __init__(self):
        # é€šè¿‡å·¥å‚åˆ›å»ºå…·ä½“å®ç°
        self._plugin_manager: IPluginManager = PluggyPluginManager()

    def with_plugin(self, plugin: object) -> "Bootstrap":
        """æ³¨å†Œæ’ä»¶"""
        self._plugin_manager.register(plugin)
        return self

    def build(self) -> "BootstrapApp":
        # è‡ªåŠ¨å‘ç°å¹¶åŠ è½½å†…ç½®æ’ä»¶
        self._plugin_manager.discover_plugins()
        ...
```

---

## 9. å®æ–½è®¡åˆ’

### 9.1 Phase 1: Layer 0 æ ¸å¿ƒæŠ½è±¡

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | äº§å‡º |
|------|--------|------|
| `core/protocols/` | P0 | åè®®å®šä¹‰ï¼ˆä¾èµ–åè½¬åŸºç¡€ï¼‰ |
| `core/middleware/` | P0 | ç»Ÿä¸€ä¸­é—´ä»¶åè®®å’Œé“¾ |
| `core/context/` | P0 | ä¸Šä¸‹æ–‡ä¼ æ’­ç³»ç»Ÿ |
| `core/events/` | P1 | äº‹ä»¶æ€»çº¿ |
| `infrastructure/telemetry/` | P1 | å¯è§‚æµ‹æ€§å®ç°ï¼ˆä¾èµ– OpenTelemetryï¼‰ |
| `infrastructure/plugins/` | P1 | æ’ä»¶ç³»ç»Ÿï¼ˆHookSpecs + Managerï¼‰ |
| `core/exceptions.py` | P0 | å¼‚å¸¸ä½“ç³»è¿ç§» |
| `core/types.py` | P0 | ç±»å‹å®šä¹‰è¿ç§» |

### 9.2 Phase 2: Layer 1 åŸºç¡€è®¾æ–½è°ƒæ•´

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | äº§å‡º |
|------|--------|------|
| `infrastructure/` é‡æ„ | P0 | ä½¿ç”¨ core/protocols/ æ¥å£ |
| providers ä¾èµ–åè½¬ | P0 | é€šè¿‡åè®®åˆ›å»ºå¯¹è±¡ |
| bootstrap æ›´æ–° | P0 | é›†æˆæ–°æ’ä»¶ç³»ç»Ÿ |

### 9.3 Phase 3: Layer 2 èƒ½åŠ›å±‚é‡ç»„

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | äº§å‡º |
|------|--------|------|
| `capabilities/` ç›®å½•åˆ›å»º | P0 | æ–°ç›®å½•ç»“æ„ |
| `capabilities/clients/http/` | P0 | HTTP å®¢æˆ·ç«¯ + ä¸­é—´ä»¶ |
| `capabilities/databases/` | P0 | å¢å¼º UnitOfWork |
| `capabilities/messengers/` | P1 | MQ ä¸­é—´ä»¶é€‚é… |
| `capabilities/drivers/` | P2 | UI é©±åŠ¨è¿ç§» |
| `capabilities/storages/` | P2 | å­˜å‚¨è¿ç§» |

### 9.4 Phase 4: Layer 3 æ¥å£å±‚æ›´æ–°

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | äº§å‡º |
|------|--------|------|
| `testing/fixtures/` | P0 | å¼‚æ­¥ fixtures æ›´æ–° |
| `testing/plugins/` | P0 | pytest æ’ä»¶æ›´æ–° |
| `cli/` | P1 | CLI é€‚é…æ–°ç»“æ„ |

### 9.5 Phase 5: æ’ä»¶ä¸æµ‹è¯•

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | äº§å‡º |
|------|--------|------|
| `plugins/builtin/` | P1 | å†…ç½®æ’ä»¶è¿ç§» |
| å•å…ƒæµ‹è¯• | P0 | è¦†ç›–ç‡ â‰¥80% |
| é›†æˆæµ‹è¯• | P0 | ç«¯åˆ°ç«¯éªŒè¯ |
| è¿ç§»æŒ‡å— | P0 | v3.13 â†’ v3.14 è¿ç§»æ–‡æ¡£ |
| API æ–‡æ¡£ | P1 | æ›´æ–°æ–‡æ¡£ç«™ |

---

## 10. é™„å½•

### 10.1 è®¾è®¡å†³ç­–è®°å½•

| å†³ç­– | é€‰é¡¹ | é€‰æ‹© | åŸå›  |
|------|------|------|------|
| å‘½å | Interceptor vs Middleware | Middleware | ä¸šç•Œé€šç”¨ï¼ˆStarlette/FastAPI/Koaï¼‰ |
| åŒæ­¥ API | ç‹¬ç«‹å®ç° vs åŒ…è£…å±‚ | åŒ…è£…å±‚ | å‡å°‘ä»£ç é‡å¤ |
| ç›®å½•å‘½å | platform vs core | core | ç®€æ´ï¼Œè¯­ä¹‰æ¸…æ™° |
| **Core çº¯å‡€** | å«å®ç° vs çº¯æŠ½è±¡ | **çº¯æŠ½è±¡** | Core ä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ |
| **Telemetry ä½ç½®** | core vs infra | **infrastructure/** | ä¾èµ– opentelemetryï¼Œå®ç°ä¸‹æ”¾ |
| **EventBus ä½ç½®** | core vs infra | **infrastructure/** | å…·ä½“å®ç°ä¸‹æ”¾ï¼Œcore åªä¿ç•™äº‹ä»¶ç±»å‹ |
| **PluginManager ä½ç½®** | core vs infra | **infrastructure/** | ä¾èµ– pluggyï¼Œcore åªä¿ç•™æ¥å£ |
| **HookSpecs** | core çº¯ç±»å‹ vs infra å•ä¸€æ•°æ®æº | **infrastructure/ å•ä¸€æ•°æ®æº** | é¿å…é‡å¤å®šä¹‰ï¼Œpluggy è£…é¥°å™¨åªå®šä¹‰ä¸€æ¬¡ |
| èƒ½åŠ›å±‚ç»„ç»‡ | å¹³é“º vs ç»Ÿä¸€ç›®å½• | `capabilities/` ç»Ÿä¸€ç›®å½• | åˆ†ç»„æ¸…æ™°ï¼Œé™ä½è®¤çŸ¥è´Ÿæ‹… |
| èƒ½åŠ›å±‚å‘½å | é‡å‘½å vs ä¿æŒåŸå | ä¿æŒåŸå | å‡å°‘è¿ç§»æˆæœ¬ |
| å±‚çº§é¡ºåº | capabilities < infrastructure | infrastructure < capabilities | èƒ½åŠ›å±‚éœ€è¦ä¾èµ–åŸºç¡€è®¾æ–½é…ç½® |
| æ’ä»¶ç³»ç»Ÿ | å•ä¸€ç›®å½• vs ä¸‰å±‚åˆ†ç¦» | ä¸‰å±‚åˆ†ç¦» | æ¥å£(core) + å®ç°(infra) + æ’ä»¶(plugins) |
| æ¥å£å±‚ | åˆ†å±‚ vs å¹¶è¡Œ | testing/ + cli/ å¹¶è¡Œ | ä¸¤ä¸ªç”¨æˆ·å…¥å£ï¼Œç›¸äº’ç‹¬ç«‹ |
| å¾ªç¯ä¾èµ– | å»¶è¿Ÿå¯¼å…¥ vs ä¾èµ–åè½¬ | core/protocols/ ä¾èµ–åè½¬ | æ›´æ¸…æ™°çš„æ¶æ„è¾¹ç•Œ |
| å…¼å®¹æ€§ | å®Œå…¨å…¼å®¹ vs è¿ç§» | è¿ç§»ï¼ˆæä¾›æŒ‡å—ï¼‰ | é¿å…æŠ€æœ¯å€ºåŠ¡ |

### 10.2 å‚è€ƒèµ„æ–™

- [Starlette Middleware](https://www.starlette.io/middleware/)
- [Koa.js Middleware](https://koajs.com/)
- [OpenTelemetry Python](https://opentelemetry.io/docs/languages/python/)
- [Python 3.12 Type Parameter Syntax](https://docs.python.org/3.12/whatsnew/3.12.html#pep-695-type-parameter-syntax)
- [contextvars](https://docs.python.org/3/library/contextvars.html)

### 10.3 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| **Middleware** | æ´‹è‘±æ¨¡å‹ä¸­é—´ä»¶ï¼Œæ§åˆ¶è¯·æ±‚-å“åº”å…¨æµç¨‹ |
| **Telemetry** | å¯è§‚æµ‹æ€§ä¸‰ä»¶å¥—ï¼ˆTracing + Metrics + Loggingï¼‰ |
| **ExecutionContext** | æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿è¯·æ±‚é“¾è·¯ |
| **EventBus** | äº‹ä»¶æ€»çº¿ï¼Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼ |
| **UnitOfWork** | å·¥ä½œå•å…ƒæ¨¡å¼ï¼Œç®¡ç†äº‹åŠ¡è¾¹ç•Œ |
| **Carrier** | ä¸Šä¸‹æ–‡ä¼ æ’­è½½ä½“ï¼ˆHTTP Headersã€gRPC Metadata ç­‰ï¼‰ |

---

> **ä¸‹ä¸€æ­¥**: ç¡®è®¤è®¾è®¡æ–¹æ¡ˆåï¼Œå¼€å§‹ Phase 1 å®æ–½ã€‚
