# DF Test Framework - GitHub Actions CI/CD 模板
# 版本: v3.35.0+
#
# 使用方法:
# 1. 将此文件复制到项目的 .github/workflows/ 目录
# 2. 根据项目需求修改配置
# 3. 配置必要的 Secrets（如 API 密钥、数据库密码等）
#
# 此模板包含:
# - 多 Python 版本测试
# - 多环境测试（dev/staging）
# - 代码质量检查（ruff）
# - 测试覆盖率报告
# - Allure 报告生成

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  # 支持手动触发
  workflow_dispatch:
    inputs:
      environment:
        description: '运行环境'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - prod

# 并发控制：同一分支只保留最新的运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # 默认 Python 版本
  PYTHON_VERSION: "3.12"
  # 默认测试环境
  DEFAULT_ENV: "test"

jobs:
  # ============ 代码质量检查 ============
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 安装依赖
        run: uv sync --dev

      - name: Ruff 代码检查
        run: uv run ruff check src/ tests/

      - name: Ruff 格式检查
        run: uv run ruff format --check src/ tests/

  # ============ 单元测试 ============
  test:
    name: 测试 (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: 安装依赖
        run: uv sync --dev

      - name: 运行测试
        env:
          ENV: ${{ github.event.inputs.environment || env.DEFAULT_ENV }}
        run: |
          uv run pytest tests/ \
            --env=${{ env.ENV }} \
            --ignore=tests/test_messengers/ \
            -v \
            --tb=short \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=test-results.xml

      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.12'
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

      - name: 上传测试结果
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results.xml
            coverage.xml

  # ============ 多环境测试 ============
  env-test:
    name: 环境测试 (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      fail-fast: false
      matrix:
        env: [dev, staging]

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 安装依赖
        run: uv sync --dev

      - name: 运行 ${{ matrix.env }} 环境测试
        env:
          ENV: ${{ matrix.env }}
          # 从 Secrets 注入敏感配置
          HTTP__BASE_URL: ${{ secrets[format('{0}_API_URL', matrix.env)] }}
          DB__PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          uv run pytest tests/ \
            --env=${{ matrix.env }} \
            --ignore=tests/test_messengers/ \
            -v \
            -m "not slow"

  # ============ Allure 报告 ============
  allure-report:
    name: Allure 报告
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 安装依赖
        run: uv sync --dev

      - name: 运行测试（生成 Allure 数据）
        run: |
          uv run pytest tests/ \
            --ignore=tests/test_messengers/ \
            --alluredir=allure-results \
            -v \
            --tb=short

      - name: 下载历史报告
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: allure-history
        continue-on-error: true

      - name: 生成 Allure 报告
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: 上传 Allure 历史
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-history

      - name: 发布 Allure 报告到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  # ============ 冒烟测试（生产环境）============
  smoke-test:
    name: 生产环境冒烟测试
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 安装依赖
        run: uv sync --dev

      - name: 运行生产环境冒烟测试
        env:
          ENV: prod
          HTTP__BASE_URL: ${{ secrets.PROD_API_URL }}
        run: |
          uv run pytest tests/ \
            --env=prod \
            -m smoke \
            -v \
            --tb=short

  # ============ 依赖安全检查 ============
  security:
    name: 安全检查
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 安装依赖
        run: uv sync --dev

      - name: 安全审计
        run: uv pip audit
        continue-on-error: true

  # ============ 构建验证 ============
  build:
    name: 构建验证
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: 设置 Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: 构建包
        run: uv build

      - name: 验证包
        run: |
          pip install dist/*.whl
          python -c "import df_test_framework; print(df_test_framework.__version__)"
