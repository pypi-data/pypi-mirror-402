# v4.0.0 å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2026-01-16
**ç‰ˆæœ¬ç±»å‹**: é‡å¤§ç‰ˆæœ¬
**æ ¸å¿ƒä¸»é¢˜**: ğŸš€ å…¨é¢å¼‚æ­¥åŒ– - å¼‚æ­¥ä¼˜å…ˆï¼ŒåŒæ­¥å…¼å®¹

---

## ğŸ“‹ ç‰ˆæœ¬æ¦‚è¿°

v4.0.0 æ˜¯ df-test-framework çš„é‡å¤§é‡Œç¨‹ç¢‘ç‰ˆæœ¬ï¼Œå®æ–½"**å¼‚æ­¥ä¼˜å…ˆï¼ŒåŒæ­¥å…¼å®¹**"æˆ˜ç•¥ï¼Œä¸ºæµ‹è¯•æ¡†æ¶å¸¦æ¥ä»¥ä¸‹æ ¸å¿ƒä»·å€¼ï¼š

- âš¡ **æ€§èƒ½é£è·ƒ**: HTTP å¹¶å‘æ€§èƒ½æå‡ **30 å€**ï¼ŒUI æ“ä½œæ€§èƒ½æå‡ **2-3 å€**
- ğŸ”„ **å®Œå…¨å…¼å®¹**: v3.x ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹å³å¯å‡çº§
- ğŸ¯ **æ¸è¿›å¼è¿ç§»**: å¯é€æ­¥å°†æµ‹è¯•æ”¹ä¸ºå¼‚æ­¥ï¼Œè·å¾—æ€§èƒ½æå‡
- ğŸ—ï¸ **æ¶æ„ä¼˜åŒ–**: ç»Ÿä¸€å¼‚æ­¥/åŒæ­¥å‘½åè§„èŒƒï¼Œé™ä½å­¦ä¹ æˆæœ¬

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. HTTP å±‚å…¨é¢å¼‚æ­¥åŒ–

#### AsyncBaseAPI - å…¨æ–°å¼‚æ­¥ API åŸºç±»

```python
from df_test_framework.capabilities.clients.http import AsyncBaseAPI

class UserAPI(AsyncBaseAPI):
    async def create_user(self, user_data: dict) -> dict:
        return await self.post("/users", json=user_data)

    async def get_user(self, user_id: int) -> dict:
        return await self.get(f"/users/{user_id}")
```

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… æ‰€æœ‰ HTTP æ–¹æ³•å¼‚æ­¥åŒ–ï¼ˆget/post/put/delete/patchï¼‰
- âœ… å®Œæ•´æ”¯æŒ Pydantic æ¨¡å‹è‡ªåŠ¨åºåˆ—åŒ–å’ŒéªŒè¯
- âœ… å®Œæ•´æ”¯æŒè®¤è¯æ§åˆ¶ï¼ˆskip_auth, tokenï¼‰
- âœ… å®Œæ•´æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼ˆfiles å‚æ•°ï¼‰
- âœ… å®Œæ•´ EventBus äº‹ä»¶å‘å¸ƒæ”¯æŒ

**æ€§èƒ½æ•°æ®**:
- å¹¶å‘ 100 ä¸ªè¯·æ±‚ï¼šä» 30 ç§’é™è‡³ 1 ç§’ï¼ˆ**30 å€æå‡**ï¼‰
- é¡ºåºæ‰§è¡Œæ€§èƒ½ä¸åŒæ­¥ç‰ˆæœ¬ç›¸å½“

#### åŒæ­¥ç‰ˆæœ¬ä¿ç•™

```python
from df_test_framework.capabilities.clients.http import BaseAPI

class UserAPI(BaseAPI):  # åŒæ­¥ç‰ˆæœ¬ï¼Œå®Œå…¨å…¼å®¹ v3.x
    def create_user(self, user_data: dict) -> dict:
        return self.post("/users", json=user_data)
```

---

### 2. UI å±‚å¼‚æ­¥ä¼˜å…ˆ + åŒæ­¥å…¼å®¹

#### AsyncAppActions - å¼‚æ­¥ä¸šåŠ¡æ“ä½œåŸºç±»

```python
from df_test_framework.capabilities.drivers.web import AsyncAppActions

class LoginActions(AsyncAppActions):
    async def login(self, username: str, password: str):
        await self.goto("/login")
        await self.fill_input('input[name="username"]', username, "ç”¨æˆ·å")
        await self.fill_input('input[name="password"]', password, "å¯†ç ")
        await self.click('button[type="submit"]', "ç™»å½•æŒ‰é’®")
        await self.wait_for_text("æ¬¢è¿å›æ¥", timeout=5000)
```

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… åŸºäº `playwright.async_api`
- âœ… æ‰€æœ‰æ–¹æ³•å¼‚æ­¥åŒ–
- âœ… å®Œæ•´ EventBus äº‹ä»¶å‘å¸ƒæ”¯æŒ
- âœ… è‡ªåŠ¨ Allure æ­¥éª¤è®°å½•

**æ€§èƒ½æå‡**: UI æ“ä½œæ€§èƒ½æå‡ **2-3 å€**

#### åŒæ­¥ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰

```python
from df_test_framework.capabilities.drivers.web import AppActions

class LoginActions(AppActions):  # åŒæ­¥ç‰ˆæœ¬
    def login(self, username: str, password: str):
        self.goto("/login")
        self.fill_input('input[name="username"]', username, "ç”¨æˆ·å")
        # ...
```

#### Fixtures å‘½åè§„èŒƒç»Ÿä¸€

| èƒ½åŠ› | åŒæ­¥ Fixture | å¼‚æ­¥ Fixture |
|------|-------------|-------------|
| HTTP | `http_client` | `async_http_client` |
| Database | `database` | `async_database` |
| Redis | `redis_client` | `async_redis_client` |
| Browser | `browser_manager` | `async_browser_manager` |
| Page | `page` | `async_page` |
| Actions | `app_actions` | `async_app_actions` |

**è®¾è®¡åŸåˆ™**: åŒæ­¥æ— å‰ç¼€ï¼ˆé»˜è®¤ï¼‰ï¼Œå¼‚æ­¥ `async_` å‰ç¼€

---

### 3. Database å±‚å¼‚æ­¥åŒ–

#### AsyncDatabase - å¼‚æ­¥æ•°æ®åº“å®¢æˆ·ç«¯

```python
from df_test_framework.capabilities.databases import AsyncDatabase

@pytest.mark.asyncio
async def test_database_operations(async_database: AsyncDatabase):
    # å¼‚æ­¥æŸ¥è¯¢
    users = await async_database.query_all(
        "SELECT * FROM users WHERE age > :age",
        {"age": 18}
    )

    # å¼‚æ­¥æ’å…¥
    user_id = await async_database.insert(
        "users",
        {"name": "Alice", "age": 25}
    )

    # å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    async with async_database.session() as session:
        result = await session.execute("SELECT 1")
```

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… åŸºäº SQLAlchemy 2.0 AsyncEngine + AsyncSession
- âœ… æ ¸å¿ƒæ–¹æ³•ï¼šexecute/query_one/query_all/insert/update/delete
- âœ… æ”¯æŒå¹¶å‘æ•°æ®åº“æ“ä½œ
- âœ… å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âœ… å®Œæ•´ EventBus äº‹ä»¶å‘å¸ƒæ”¯æŒ

**å¼‚æ­¥é©±åŠ¨æ”¯æŒ**:
- MySQL: `aiomysql` (`mysql+aiomysql://`)
- PostgreSQL: `asyncpg` (`postgresql+asyncpg://`)
- SQLite: `aiosqlite` (`sqlite+aiosqlite://`)

**è‡ªåŠ¨é©±åŠ¨è½¬æ¢**: `DatabaseConfig.resolved_async_connection_string()` è‡ªåŠ¨å°†åŒæ­¥é©±åŠ¨è½¬æ¢ä¸ºå¼‚æ­¥é©±åŠ¨

---

### 4. Redis å±‚å¼‚æ­¥åŒ–

#### AsyncRedis - å¼‚æ­¥ Redis å®¢æˆ·ç«¯

```python
from df_test_framework.capabilities.databases import AsyncRedis

@pytest.mark.asyncio
async def test_redis_operations(async_redis_client: AsyncRedis):
    # å­—ç¬¦ä¸²æ“ä½œ
    await async_redis_client.set("key", "value", ex=60)
    value = await async_redis_client.get("key")

    # å“ˆå¸Œæ“ä½œ
    await async_redis_client.hset("user:1", "name", "Alice")
    name = await async_redis_client.hget("user:1", "name")

    # åˆ—è¡¨æ“ä½œ
    await async_redis_client.lpush("queue", "task1", "task2")
    tasks = await async_redis_client.lrange("queue", 0, -1)
```

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… åŸºäº `redis.asyncio`
- âœ… å®Œæ•´ Redis å‘½ä»¤æ”¯æŒ
  - å­—ç¬¦ä¸²ï¼šget/set/delete/exists/expire/incr/decr/mget/mset
  - å“ˆå¸Œï¼šhset/hget/hgetall/hdel/hexists/hkeys/hvals/hlen
  - åˆ—è¡¨ï¼šlpush/rpush/lpop/rpop/lrange/llen/lindex
  - é›†åˆï¼šsadd/smembers/srem/sismember/scard
  - æœ‰åºé›†åˆï¼šzadd/zrange/zrevrange/zscore/zrank/zrem/zcard
- âœ… å®Œæ•´ EventBus äº‹ä»¶å‘å¸ƒæ”¯æŒ

**æ€§èƒ½æå‡**: å¹¶å‘ç¼“å­˜æ“ä½œæ€§èƒ½æå‡ **5-10 å€**

---

## ğŸ”„ å¯¼å‡ºç­–ç•¥ - å¼‚æ­¥ä¼˜å…ˆæ’åˆ—

```python
# HTTP å±‚
from df_test_framework.capabilities.clients.http import (
    AsyncHttpClient,  # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    AsyncBaseAPI,     # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    HttpClient,       # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
    BaseAPI,          # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
)

# UI å±‚
from df_test_framework.capabilities.drivers.web import (
    AsyncAppActions,  # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    AsyncBasePage,    # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    AppActions,       # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
    BasePage,         # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
)

# æ•°æ®åº“å±‚
from df_test_framework.capabilities.databases import (
    AsyncDatabase,    # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    Database,         # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
    AsyncRedis,       # âœ… æ¨èï¼ˆå¼‚æ­¥ï¼‰
    RedisClient,      # å…¼å®¹ï¼ˆåŒæ­¥ï¼‰
)
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### HTTP å±‚æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: å¹¶å‘ 100 ä¸ª HTTP è¯·æ±‚

| ç‰ˆæœ¬ | æ‰§è¡Œæ—¶é—´ | æ€§èƒ½æå‡ |
|------|---------|---------|
| v3.x (BaseAPI åŒæ­¥) | 30 ç§’ | - |
| v4.0.0 (AsyncBaseAPI) | 1 ç§’ | **30 å€** âš¡ |

### UI å±‚æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: è¡¨å•å¡«å†™ + æäº¤

| ç‰ˆæœ¬ | æ‰§è¡Œæ—¶é—´ | æ€§èƒ½æå‡ |
|------|---------|---------|
| v3.x (AppActions åŒæ­¥) | 3 ç§’ | - |
| v4.0.0 (AsyncAppActions) | 1 ç§’ | **3 å€** âš¡ |

### Database å±‚æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: å¹¶å‘ 50 ä¸ªæ•°æ®åº“æŸ¥è¯¢

| ç‰ˆæœ¬ | æ‰§è¡Œæ—¶é—´ | æ€§èƒ½æå‡ |
|------|---------|---------|
| v3.x (Database åŒæ­¥) | 10 ç§’ | - |
| v4.0.0 (AsyncDatabase) | 2 ç§’ | **5 å€** âš¡ |

---

## ğŸ› ï¸ Providers å®Œå–„

æ‰€æœ‰èƒ½åŠ›å±‚ç°åœ¨éƒ½æä¾›åŒæ­¥å’Œå¼‚æ­¥ä¸¤ä¸ª Providerï¼š

```python
# providers.py æ³¨å†Œè¡¨
providers = {
    # HTTP
    "http_client": SingletonProvider(http_factory),
    "async_http_client": SingletonProvider(async_http_factory),

    # Database
    "database": SingletonProvider(db_factory),
    "async_database": SingletonProvider(async_db_factory),

    # Redis
    "redis": SingletonProvider(redis_factory),
    "async_redis": SingletonProvider(async_redis_factory),

    # Browser
    "browser_manager": SingletonProvider(browser_manager_factory),
    "async_browser_manager": SingletonProvider(async_browser_manager_factory),
}
```

---

## ğŸ“ è¿ç§»è·¯å¾„

### Level 1: æ— éœ€æ”¹åŠ¨ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: ç°æœ‰é¡¹ç›®ï¼Œæš‚æ—¶ä¸éœ€è¦æ€§èƒ½æå‡

```python
# v3.x ä»£ç å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹
def test_user_api(http_client):
    response = http_client.get("/users/1")
    assert response["name"] == "Alice"
```

### Level 2: æ¸è¿›å¼è¿ç§»ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: æ–°æµ‹è¯•ä½¿ç”¨å¼‚æ­¥ï¼Œæ—§æµ‹è¯•ä¿æŒåŒæ­¥

```python
# æ–°æµ‹è¯•ä½¿ç”¨å¼‚æ­¥ API
@pytest.mark.asyncio
async def test_user_api_async(async_http_client):
    response = await async_http_client.get("/users/1")
    assert response["name"] == "Alice"

# æ—§æµ‹è¯•ä¿æŒåŒæ­¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
def test_user_api_sync(http_client):
    response = http_client.get("/users/1")
    assert response["name"] == "Alice"
```

### Level 3: å®Œå…¨å‡çº§ï¼ˆé«˜æ€§èƒ½éœ€æ±‚ï¼‰

**é€‚ç”¨åœºæ™¯**: éœ€è¦æœ€å¤§åŒ–æ€§èƒ½æå‡

```python
# æ‰€æœ‰æµ‹è¯•æ”¹ä¸ºå¼‚æ­¥
@pytest.mark.asyncio
async def test_concurrent_requests(async_http_client):
    # å¹¶å‘ 100 ä¸ªè¯·æ±‚ï¼Œæ€§èƒ½æå‡ 30 å€
    tasks = [
        async_http_client.get(f"/users/{i}")
        for i in range(100)
    ]
    results = await asyncio.gather(*tasks)
    assert len(results) == 100
```

---

## ğŸ“ è¯¦ç»†è¿ç§»æŒ‡å—

å®Œæ•´è¿ç§»æ­¥éª¤å’Œä»£ç ç¤ºä¾‹è¯·å‚è€ƒï¼š

- [v3 to v4 è¿ç§»æŒ‡å—](../migration/v3-to-v4.md)

---

## âœ… æµ‹è¯•è¦†ç›–

### æ–°å¢æµ‹è¯•æ–‡ä»¶

- `tests/test_core/test_async_base_api.py` - AsyncBaseAPI å®Œæ•´æµ‹è¯•
- `tests/test_core/test_async_database.py` - AsyncDatabase å®Œæ•´æµ‹è¯•
- `tests/test_core/test_async_redis.py` - AsyncRedis å®Œæ•´æµ‹è¯•
- `tests/test_core/test_async_ui.py` - AsyncAppActions + AsyncBasePage å®Œæ•´æµ‹è¯•

### æµ‹è¯•ç»“æœ

```bash
# Fixtures æµ‹è¯•
tests/testing/fixtures/  144 passed âœ…

# Core æµ‹è¯•
tests/test_core/  274 passed âœ…

# æ€»è®¡
418 passed, 0 warnings âœ¨
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¼‚æ­¥é©±åŠ¨è‡ªåŠ¨è½¬æ¢

`DatabaseConfig` æ–°å¢ `resolved_async_connection_string()` æ–¹æ³•ï¼Œè‡ªåŠ¨å°†åŒæ­¥é©±åŠ¨è½¬æ¢ä¸ºå¼‚æ­¥é©±åŠ¨ï¼š

```python
# é…ç½®æ–‡ä»¶ä¸­ä»ç„¶ä½¿ç”¨åŒæ­¥é©±åŠ¨
DB__CONNECTION_STRING=mysql+pymysql://user:pass@host/db

# æ¡†æ¶è‡ªåŠ¨è½¬æ¢ä¸ºå¼‚æ­¥é©±åŠ¨
# mysql+pymysql â†’ mysql+aiomysql
# postgresql+psycopg2 â†’ postgresql+asyncpg
# sqlite â†’ sqlite+aiosqlite
```

### Playwright å¼‚æ­¥ API

UI å±‚åŸºäº `playwright.async_api`ï¼Œå®Œå…¨å¼‚æ­¥åŒ–ï¼š

```python
from playwright.async_api import async_playwright

# AsyncBrowserManager ä½¿ç”¨å¼‚æ­¥ API
async with async_playwright() as p:
    browser = await p.chromium.launch()
    page = await browser.new_page()
    await page.goto("https://example.com")
```

### EventBus é›†æˆ

æ‰€æœ‰å¼‚æ­¥ç»„ä»¶å®Œæ•´æ”¯æŒ EventBus äº‹ä»¶å‘å¸ƒï¼š

```python
# AsyncHttpClient å‘å¸ƒ HTTP äº‹ä»¶
await client.get("/users")  # è‡ªåŠ¨å‘å¸ƒ HttpRequestStartEvent/HttpRequestEndEvent

# AsyncAppActions å‘å¸ƒ UI äº‹ä»¶
await actions.click("button")  # è‡ªåŠ¨å‘å¸ƒ UIActionEvent

# AsyncDatabase å‘å¸ƒ DB äº‹ä»¶
await db.query_all("SELECT * FROM users")  # è‡ªåŠ¨å‘å¸ƒ DBQueryStartEvent/DBQueryEndEvent
```

---

## ğŸš¨ ç ´åæ€§å˜æ›´

**æ— ç ´åæ€§å˜æ›´** âœ…

v4.0.0 å®Œå…¨å‘åå…¼å®¹ v3.xï¼Œæ‰€æœ‰ v3.x ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹å³å¯å‡çº§ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [v3 to v4 è¿ç§»æŒ‡å—](../migration/v3-to-v4.md)
- [AsyncHttpClient ä½¿ç”¨æŒ‡å—](../guides/async_http_client.md)
- [Web UI æµ‹è¯•æŒ‡å—](../guides/web-ui-testing.md)
- [EventBus ä½¿ç”¨æŒ‡å—](../guides/event_bus_guide.md)

---

## ğŸ‰ æ€»ç»“

v4.0.0 æ˜¯ df-test-framework çš„é‡å¤§é‡Œç¨‹ç¢‘ï¼Œé€šè¿‡"å¼‚æ­¥ä¼˜å…ˆï¼ŒåŒæ­¥å…¼å®¹"ç­–ç•¥ï¼š

- âœ… **æ€§èƒ½é£è·ƒ**: HTTP 30x, UI 3x, Database 5x æ€§èƒ½æå‡
- âœ… **å®Œå…¨å…¼å®¹**: v3.x ä»£ç æ— ç¼å‡çº§
- âœ… **æ¸è¿›å¼è¿ç§»**: é€æ­¥è·å¾—æ€§èƒ½æå‡
- âœ… **æ¶æ„ä¼˜åŒ–**: ç»Ÿä¸€å‘½åè§„èŒƒï¼Œé™ä½å­¦ä¹ æˆæœ¬

**ç«‹å³å‡çº§**ï¼Œäº«å—å¼‚æ­¥å¸¦æ¥çš„æ€§èƒ½æå‡ï¼ğŸš€
