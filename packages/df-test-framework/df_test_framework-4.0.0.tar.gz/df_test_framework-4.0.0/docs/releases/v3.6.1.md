# DF Test Framework v3.6.1 Release Notes

å‘å¸ƒæ—¥æœŸ: 2025-11-12

---

## ğŸ‰ ç‰ˆæœ¬æ¦‚è¿°

### ğŸ› æ—¥å¿—ç³»ç»Ÿä¿®å¤ç‰ˆæœ¬ - å®Œå–„å¯è§‚æµ‹æ€§ä½“éªŒ

v3.6.1 æ˜¯ä¸€ä¸ªé‡è¦çš„**æ—¥å¿—ç³»ç»Ÿä¿®å¤ç‰ˆæœ¬**ï¼Œè§£å†³äº† v3.5 é‡æ„æ—¶é—ç•™çš„æ—¥å¿—è¾“å‡ºé—®é¢˜ï¼Œå¹¶æä¾›äº†ç°ä»£åŒ–çš„ Loguru + Pytest é›†æˆæ–¹æ¡ˆã€‚

#### æ ¸å¿ƒæ”¹è¿›

- âœ… **æ¶ˆé™¤é‡å¤æ—¥å¿—**: ä¿®å¤ `Database.execute()` ä½¿ç”¨é—ç•™ DBDebugger å¯¼è‡´çš„é‡å¤è¾“å‡º
- âœ… **ç°ä»£åŒ–é›†æˆ**: Loguru ä¸ Pytest çš„å®˜æ–¹æ¨èé›†æˆæ–¹æ¡ˆ
- âœ… **pytest 8.x å…¼å®¹**: ä¿®å¤é…ç½®è­¦å‘Šï¼Œæå‡å…¼å®¹æ€§
- âœ… **ç»Ÿä¸€æ—¥å¿—æ¶æ„**: æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ ObservabilityLogger

---

## ğŸ› ä¿®å¤è¯¦æƒ…

### 1. ä¿®å¤ Database.execute() ä½¿ç”¨é—ç•™ DBDebugger å¯¼è‡´çš„é‡å¤æ—¥å¿—è¾“å‡º

**é—®é¢˜æè¿°**:

`Database.execute()` ä»åœ¨ä½¿ç”¨ v3.0 çš„ DBDebuggerï¼Œå¯¼è‡´ `[DB DEBUG]` print è¾“å‡ºä¸ v3.5 ObservabilityLogger æ··åˆï¼Œé€ æˆæ—¥å¿—æ±¡æŸ“ã€‚

**é—®é¢˜è¡¨ç°**:

```bash
# v3.6.0 çš„æ—¥å¿—è¾“å‡ºï¼ˆæ··ä¹±ï¼‰
[DB DEBUG] Executing SQL: INSERT INTO users...  # DBDebugger print è¾“å‡º
2025-11-12 10:30:00 | INFO | Database | Executing SQL...  # ObservabilityLogger è¾“å‡º
```

**æ ¹æœ¬åŸå› **:

v3.5 é‡æ„æ—¶ï¼Œ`query_one()` å’Œ `query_all()` å·²è¿ç§»åˆ° ObservabilityLoggerï¼Œä½† `execute()` æ–¹æ³•è¢«é—æ¼ã€‚

**ä¿®å¤å†…å®¹**:

- å°† `Database.execute()` å®Œå…¨è¿ç§»åˆ° ObservabilityLogger + AllureObserver
- ç§»é™¤ DBDebugger è‡ªåŠ¨è°ƒç”¨
- DBDebugger ä»ä¿ç•™ä¸ºå¯é€‰è°ƒè¯•å·¥å…·ï¼ˆé€šè¿‡ `db_debug` fixture æ˜¾å¼å¯ç”¨ï¼‰

**å½±å“æ–‡ä»¶**:
- `src/df_test_framework/databases/database.py:264-353`

**ä¿®å¤æ•ˆæœ**:

```bash
# v3.6.1 çš„æ—¥å¿—è¾“å‡ºï¼ˆæ¸…æ™°ï¼‰
2025-11-12 10:30:00 | INFO | Database | Executing SQL: INSERT INTO users...
2025-11-12 10:30:01 | INFO | Database | Rows affected: 1
```

**ç”¨æˆ·å½±å“**:
- âœ… ä¸å†å‡ºç° `[DB DEBUG]` print è¾“å‡ºæ±¡æŸ“æ—¥å¿—
- âœ… æ‰€æœ‰æ•°æ®åº“æ“ä½œç»Ÿä¸€ä½¿ç”¨ ObservabilityLogger ç»“æ„åŒ–æ—¥å¿—
- âœ… æ—¥å¿—æ ¼å¼ä¸€è‡´æ€§æå‡
- âœ… Allure æŠ¥å‘Šä¸­æ•°æ®åº“æ“ä½œæ­¥éª¤æ›´æ¸…æ™°

---

### 2. Loguru ä¸ Pytest çš„ç°ä»£åŒ–é›†æˆæ–¹æ¡ˆ

**é—®é¢˜æè¿°**:

ä½¿ç”¨ `-s` å‚æ•°æ—¶ï¼Œpytest æµ‹è¯•åç§°å’Œ loguru æ—¥å¿—æ··åœ¨åŒä¸€è¡Œï¼š

```bash
# ä½¿ç”¨ -s å‚æ•°çš„è¾“å‡ºï¼ˆæ··ä¹±ï¼‰
tests/test_example.py::test_foo 2025-11-12 15:02:22 | INFO | ... | æ—¥å¿—å†…å®¹
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                æµ‹è¯•åç§°å’Œæ—¥å¿—æŒ¤åœ¨åŒä¸€è¡Œ
```

**æ ¹æœ¬åŸå› **:
- `-s` å‚æ•°ç¦ç”¨äº† pytest çš„è¾“å‡ºæ•è·
- loguru ç›´æ¥è¾“å‡ºåˆ° stdoutï¼Œpytest æ— æ³•æ§åˆ¶æ ¼å¼
- è¿™ä¸æ˜¯ bugï¼Œè€Œæ˜¯è®¾è®¡ä½¿ç„¶

**ç°ä»£åŒ–è§£å†³æ–¹æ¡ˆ**:

é‡‡ç”¨ pytest å®˜æ–¹æ¨èçš„æ–¹å¼ï¼š**ä½¿ç”¨ Live Logging + caplog é›†æˆ**

#### ä¿®æ”¹å†…å®¹

**1. pytest.ini é…ç½®** - å¯ç”¨ live loggingï¼ˆæ›¿ä»£ `-s`ï¼‰:

```ini
# Live Logging é…ç½®
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s | %(levelname)-8s | %(name)s:%(funcName)s | %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S
```

**2. conftest.py** - æ·»åŠ  loguru caplog é›†æˆ:

```python
@pytest.fixture
def caplog(caplog: LogCaptureFixture):
    """è¦†ç›– pytest çš„ caplog fixtureï¼Œé›†æˆ loguru"""
    handler_id = logger.add(
        caplog.handler,
        format="{message}",
        level=0,
        filter=lambda record: record["level"].no >= caplog.handler.level,
        enqueue=False,
    )
    yield caplog
    logger.remove(handler_id)
```

#### ä¿®å¤æ•ˆæœ

**ä¿®å¤å‰ï¼ˆä½¿ç”¨ -s å‚æ•°ï¼‰**:

```bash
tests/test_example.py::test_foo 2025-11-12 15:02:22 | INFO | httpx:_send_single_request | HTTP Request...
FAILED [100%]
```

**ä¿®å¤åï¼ˆæ ‡å‡† pytest è¿è¡Œï¼‰**:

```bash
tests/test_example.py::test_foo
-------------------------------- live log call --------------------------------
2025-11-12 17:43:39 | INFO     | httpx:_send_single_request | HTTP Request...
2025-11-12 17:43:39 | INFO     | df_test_framework:execute | Executing SQL...
FAILED [100%]
================================== FAILURES ===================================
---------------------------- Captured stdout setup ----------------------------
[loguru æ—¥å¿—æ•´é½æ˜¾ç¤º]
---------------------------- Captured stdout call -----------------------------
[loguru æ—¥å¿—æ•´é½æ˜¾ç¤º]
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1025 HTTP Request...
INFO     df_test_framework:database.py:280 Executing SQL...
```

#### ç”¨æˆ·å½±å“

- âœ… **å®Œå…¨åˆ†ç¦»**: æµ‹è¯•åç§°ã€live logã€captured log å„å¸å…¶èŒ
- âœ… **æ ‡å‡†åŒ–**: éµå¾ª pytest æœ€ä½³å®è·µï¼Œä¸å†éœ€è¦ `-s` å‚æ•°
- âœ… **ç»“æ„åŒ–**: æ—¥å¿—æŒ‰é˜¶æ®µï¼ˆsetup/call/teardownï¼‰æ¸…æ™°åˆ†ç±»
- âœ… **å…¼å®¹æ€§**: loguru å®Œå…¨é›†æˆåˆ° pytest logging ç³»ç»Ÿ
- âœ… **å¯æµ‹è¯•**: æ”¯æŒé€šè¿‡ `caplog.text` åœ¨æµ‹è¯•ä¸­æ–­è¨€æ—¥å¿—å†…å®¹

#### è¿ç§»æŒ‡å—

```bash
# âŒ æ—§æ–¹å¼ï¼ˆä¸æ¨èï¼‰
pytest -v -s

# âœ… æ–°æ–¹å¼ï¼ˆæ¨èï¼‰
pytest -v  # é…ç½®æ–‡ä»¶å·²å¯ç”¨ log_cli=true

# æˆ–æ˜¾å¼æŒ‡å®šæ—¥å¿—çº§åˆ«
pytest -v --log-cli-level=DEBUG
```

#### å‚è€ƒæ–‡æ¡£

- [Loguru - Making things work with pytest and caplog](https://loguru.readthedocs.io/en/stable/resources/migration.html#making-things-work-with-pytest-and-caplog)
- [Pytest - Live Logs](https://docs.pytest.org/en/stable/how-to/logging.html#live-logs)

---

### 3. ä¿®å¤ pytest 8.x addini() å…¼å®¹æ€§è­¦å‘Š

**é—®é¢˜æè¿°**:

pytest è¿è¡Œæ—¶å‡ºç°è­¦å‘Šï¼š

```
PytestConfigWarning: Unknown config option: df_settings_class
PytestConfigWarning: Unknown config option: df_plugins
```

**æ ¹æœ¬åŸå› **:

pytest 8.x è¦æ±‚ `parser.addini()` å¿…é¡»æ˜¾å¼æŒ‡å®š `type` å‚æ•°ã€‚

**ä¿®å¤å†…å®¹**:

ä¸º `df_settings_class` å’Œ `df_plugins` æ·»åŠ  `type="string"` å‚æ•°ã€‚

**å½±å“æ–‡ä»¶**:
- `src/df_test_framework/testing/fixtures/core.py:77-94`

**ä¿®å¤å¯¹æ¯”**:

```python
# ä¿®å¤å‰
parser.addini(
    "df_settings_class",
    "Dotted path to the FrameworkSettings subclass used for bootstrap",
    default="",
)

# ä¿®å¤å
parser.addini(
    "df_settings_class",
    "Dotted path to the FrameworkSettings subclass used for bootstrap",
    type="string",  # âœ… æ·»åŠ ç±»å‹å£°æ˜
    default="",
)
```

**ç”¨æˆ·å½±å“**:
- âœ… æ¶ˆé™¤ pytest é…ç½®è­¦å‘Š
- âœ… æå‡ pytest 8.x å…¼å®¹æ€§
- âœ… é…ç½®æ›´åŠ è§„èŒƒ

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

### æ¨¡å—æ–‡æ¡£å¢å¼º

- æ›´æ–° `database.py` æ¨¡å—æ–‡æ¡£ï¼Œè¯´æ˜ v3.5/v3.6.1 æ—¥å¿—ç³»ç»Ÿæ¼”è¿›
- æ·»åŠ æ—¥å¿—ç³»ç»Ÿæ¶æ„è¯´æ˜
- è¡¥å…… DBDebugger ä½¿ç”¨åœºæ™¯è¯´æ˜

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è¦†ç›–

- âœ… æ‰€æœ‰æ•°æ®åº“æµ‹è¯•é€šè¿‡ï¼ˆ32/32ï¼‰
- âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶é€šè¿‡ï¼ˆ606 passed, 3 skippedï¼‰
- âœ… æ—¥å¿—è¾“å‡ºéªŒè¯é€šè¿‡
- âœ… pytest 8.x å…¼å®¹æ€§éªŒè¯é€šè¿‡

---

## ğŸ“¦ å®Œæ•´ç‰¹æ€§æ¸…å•

### v3.6.1 ä¿®å¤

1. **æ—¥å¿—ç³»ç»Ÿä¿®å¤**
   - Database.execute() è¿ç§»åˆ° ObservabilityLogger
   - ç§»é™¤ DBDebugger è‡ªåŠ¨è°ƒç”¨
   - ç»Ÿä¸€æ—¥å¿—æ¶æ„

2. **Loguru + Pytest é›†æˆ**
   - Live Logging é…ç½®
   - caplog fixture è¦†ç›–
   - æ—¥å¿—åˆ†å±‚è¾“å‡º

3. **pytest 8.x å…¼å®¹**
   - addini() ç±»å‹å£°æ˜
   - é…ç½®è­¦å‘Šæ¶ˆé™¤

### v3.6.0 ç‰¹æ€§ï¼ˆå·²åŒ…å«ï¼‰

1. **Decimal é›¶é…ç½®åºåˆ—åŒ–**
   - HttpClient Pydantic æ”¯æŒ
   - ç±»å‹å·¥å…·æ¨¡å—
   - å®Œæ•´ä½¿ç”¨æŒ‡å—

---

## ğŸ”§ ä¾èµ–æ›´æ–°

æ— æ–°å¢ä¾èµ–ã€‚

### ç°æœ‰ä¾èµ–

- `loguru>=0.7.0` - æ—¥å¿—åº“
- `pytest>=8.0.0` - æµ‹è¯•æ¡†æ¶
- `httpx>=0.27.0` - HTTP å®¢æˆ·ç«¯
- `pydantic>=2.0.0` - æ•°æ®éªŒè¯

---

## ğŸ“ˆ å‡çº§æŒ‡å—

### ä» v3.6.0 å‡çº§

v3.6.1 å®Œå…¨å‘åå…¼å®¹ v3.6.0ï¼Œå¯ä»¥ç›´æ¥å‡çº§ï¼š

```bash
uv pip install --upgrade df-test-framework
```

### å‡çº§åæ£€æŸ¥

1. **éªŒè¯æ—¥å¿—è¾“å‡º**:
   ```bash
   pytest tests/ -v
   # ç¡®è®¤ä¸å†å‡ºç° [DB DEBUG] å‰ç¼€
   ```

2. **éªŒè¯ pytest è­¦å‘Š**:
   ```bash
   pytest --version
   # ç¡®è®¤æ²¡æœ‰é…ç½®è­¦å‘Š
   ```

3. **éªŒè¯ loguru é›†æˆ**:
   ```python
   def test_example(caplog):
       logger.info("Test log")
       assert "Test log" in caplog.text
   ```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ ‡å‡† pytest å‘½ä»¤

```bash
# âœ… æ¨èï¼šä½¿ç”¨æ ‡å‡†å‘½ä»¤
pytest -v

# âŒ ä¸æ¨èï¼šä½¿ç”¨ -s å‚æ•°ï¼ˆå·²é…ç½® log_cliï¼‰
pytest -v -s
```

### 2. è°ƒæ•´æ—¥å¿—çº§åˆ«

```bash
# æŸ¥çœ‹ DEBUG æ—¥å¿—
pytest -v --log-cli-level=DEBUG

# åªæ˜¾ç¤º WARNING åŠä»¥ä¸Š
pytest -v --log-cli-level=WARNING
```

### 3. åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ caplog

```python
def test_database_logging(db_transaction, caplog):
    """éªŒè¯æ•°æ®åº“æ“ä½œæ—¥å¿—"""
    from sqlalchemy import text

    db_transaction.execute(
        text("INSERT INTO users (name) VALUES (:name)"),
        {"name": "test"}
    )

    # æ–­è¨€æ—¥å¿—å†…å®¹
    assert "Executing SQL" in caplog.text
    assert "INSERT INTO users" in caplog.text
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### DBDebugger ä½¿ç”¨

å¦‚æœéœ€è¦å¯ç”¨ DBDebugger è¿›è¡Œè¯¦ç»†è°ƒè¯•ï¼š

```python
@pytest.fixture
def db_debug(database):
    """æ˜¾å¼å¯ç”¨ DBDebugger"""
    from df_test_framework.databases.debuggers import DBDebugger

    debugger = DBDebugger(database)
    debugger.install()
    yield debugger
    debugger.uninstall()

def test_with_debug(db_transaction, db_debug):
    """ä½¿ç”¨ DBDebugger è¿›è¡Œè¯¦ç»†è°ƒè¯•"""
    # DBDebugger ä¼šè¾“å‡ºè¯¦ç»†çš„ SQL æ‰§è¡Œä¿¡æ¯
    pass
```

---

## ğŸ› å·²çŸ¥é—®é¢˜

æ— ã€‚

---

## ğŸ“ æ”¯æŒ

- **æ–‡æ¡£**: [docs/](../README.md)
- **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/yourorg/df-test-framework/issues)

---

**å®Œæ•´æ›´æ–°æ—¥å¿—**: [v3.6.0...v3.6.1](https://github.com/yourorg/df-test-framework/compare/v3.6.0...v3.6.1)

---

## ğŸŠ æ€»ç»“

v3.6.1 æ˜¯ä¸€ä¸ª**è´¨é‡æå‡ç‰ˆæœ¬**ï¼Œæ ¸å¿ƒäº®ç‚¹ï¼š

âœ¨ **æ—¥å¿—ç»Ÿä¸€**: æ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ ObservabilityLogger
âœ¨ **ç°ä»£åŒ–é›†æˆ**: Loguru + Pytest å®˜æ–¹æ¨èæ–¹æ¡ˆ
âœ¨ **å…¼å®¹æ€§æå‡**: pytest 8.x å®Œå…¨å…¼å®¹
âœ¨ **å¼€å‘ä½“éªŒ**: æ—¥å¿—è¾“å‡ºæ›´æ¸…æ™°ã€æ›´ç»“æ„åŒ–

ç«‹å³å‡çº§ï¼Œäº«å—æ›´æ¸…æ™°çš„æ—¥å¿—ä½“éªŒï¼
