# v3.35.7 å‘å¸ƒè¯´æ˜ - UI è‡ªåŠ¨åŒ–å¯è§‚æµ‹æ€§é›†æˆ

**å‘å¸ƒæ—¥æœŸ**: 2025-12-20

## æ¦‚è¿°

v3.35.7 ä¸º UI è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼ˆBasePageï¼‰æ·»åŠ äº†å®Œæ•´çš„å¯è§‚æµ‹æ€§æ”¯æŒã€‚è¿™ä½¿å¾— UI æµ‹è¯•ä¸ HTTPã€GraphQLã€gRPCã€Databaseã€Redis ç­‰å…¶ä»–ç»„ä»¶åœ¨å¯è§‚æµ‹æ€§æ–¹é¢è¾¾åˆ°åŒç­‰æ°´å¹³ï¼Œå®ç°äº†ç»Ÿä¸€çš„äº‹ä»¶è¿½è¸ªã€å®æ—¶æ—¥å¿—å’Œ Allure æŠ¥å‘Šé›†æˆã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. UI äº‹ä»¶ç±»å‹ï¼ˆ7 ä¸ªæ–°äº‹ä»¶ï¼‰

æ–°å¢çš„ UI äº‹ä»¶ç±»å‹éµå¾ªæ¡†æ¶çš„ CorrelatedEvent è®¾è®¡æ¨¡å¼ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | ç‰¹ç‚¹ |
|----------|------|------|
| `UINavigationStartEvent` | é¡µé¢å¯¼èˆªå¼€å§‹ | å…³è”äº‹ä»¶å¯¹ï¼Œè¿”å› correlation_id |
| `UINavigationEndEvent` | é¡µé¢å¯¼èˆªç»“æŸ | è®°å½•å¯¼èˆªè€—æ—¶ã€é¡µé¢æ ‡é¢˜ |
| `UIClickEvent` | ç‚¹å‡»æ“ä½œ | è®°å½•é€‰æ‹©å™¨ã€å…ƒç´ æ–‡æœ¬ |
| `UIInputEvent` | è¾“å…¥æ“ä½œ | è‡ªåŠ¨è„±æ•æ•æ„Ÿå­—æ®µ |
| `UIScreenshotEvent` | æˆªå›¾æ“ä½œ | è®°å½•æˆªå›¾è·¯å¾„å’Œå¤§å° |
| `UIWaitEvent` | ç­‰å¾…æ“ä½œ | è®°å½•ç­‰å¾…ç±»å‹ã€æ¡ä»¶ã€ç»“æœ |
| `UIErrorEvent` | UI é”™è¯¯ | è®°å½•æ“ä½œç±»å‹ã€é”™è¯¯ä¿¡æ¯ã€æˆªå›¾è·¯å¾„ |

```python
from df_test_framework.core.events import (
    UINavigationStartEvent,
    UINavigationEndEvent,
    UIClickEvent,
    UIInputEvent,
    UIScreenshotEvent,
    UIWaitEvent,
    UIErrorEvent,
)

# åˆ›å»ºå¯¼èˆªå¼€å§‹äº‹ä»¶
event, correlation_id = UINavigationStartEvent.create(
    page_name="LoginPage",
    url="https://example.com/login",
    base_url="https://example.com",
)

# åˆ›å»ºå¯¼èˆªç»“æŸäº‹ä»¶ï¼ˆä½¿ç”¨ç›¸åŒçš„ correlation_idï¼‰
end_event = UINavigationEndEvent.create(
    correlation_id=correlation_id,
    page_name="LoginPage",
    url="https://example.com/login",
    title="ç™»å½• - Example",
    duration=1.5,
    success=True,
)
```

### 2. BasePage EventBus é›†æˆ

BasePage ç°åœ¨æ”¯æŒ EventBus æ³¨å…¥ï¼Œè‡ªåŠ¨å‘å¸ƒ UI æ“ä½œäº‹ä»¶ï¼š

```python
from df_test_framework.capabilities.drivers.web.playwright import BasePage
from df_test_framework.infrastructure.events import EventBus

class LoginPage(BasePage):
    def __init__(self, page, event_bus: EventBus | None = None):
        super().__init__(
            page,
            url="/login",
            base_url="https://example.com",
            event_bus=event_bus,  # å¯é€‰ï¼šæ³¨å…¥äº‹ä»¶æ€»çº¿
        )
        self.username_input = "#username"
        self.password_input = "#password"
        self.login_button = "button[type='submit']"

    def wait_for_page_load(self):
        self.wait_for_selector(self.login_button)

    def login(self, username: str, password: str):
        # è¿™äº›æ“ä½œä¼šè‡ªåŠ¨å‘å¸ƒäº‹ä»¶åˆ° EventBus
        self.fill(self.username_input, username)  # å‘å¸ƒ UIInputEvent
        self.fill(self.password_input, password)  # å‘å¸ƒ UIInputEventï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
        self.click(self.login_button)  # å‘å¸ƒ UIClickEvent
```

**è‡ªåŠ¨å‘å¸ƒäº‹ä»¶çš„æ–¹æ³•**ï¼š
- `goto()` - å‘å¸ƒ UINavigationStartEvent/UINavigationEndEvent
- `click()` - å‘å¸ƒ UIClickEvent
- `fill()` - å‘å¸ƒ UIInputEventï¼ˆå¯†ç å­—æ®µè‡ªåŠ¨è„±æ•ï¼‰
- `screenshot()` - å‘å¸ƒ UIScreenshotEvent
- `wait_for_selector()` - å‘å¸ƒ UIWaitEvent

**æ•æ„Ÿå­—æ®µè‡ªåŠ¨è„±æ•**ï¼š

å½“é€‰æ‹©å™¨åŒ…å«ä»¥ä¸‹å…³é”®è¯æ—¶ï¼Œè¾“å…¥å€¼ä¼šè‡ªåŠ¨è„±æ•ä¸º `***`ï¼š
- password, passwd
- secret, token, key
- pin, otp

### 3. ui_logger() å®æ—¶æ—¥å¿—

æ–°å¢ `ui_logger()` ä¾¿æ·å‡½æ•°ï¼Œæä¾› UI æ“ä½œçš„å®æ—¶ç»ˆç«¯æ—¥å¿—ï¼š

```python
from df_test_framework.infrastructure.logging.observability import ui_logger

logger = ui_logger()

# UI ä¸“ç”¨æ—¥å¿—æ–¹æ³•
logger.navigation_start("LoginPage", "https://example.com/login")
logger.navigation_end("LoginPage", "https://example.com/login", duration=1.5, success=True)
logger.ui_click("#login-button", duration=0.2)
logger.ui_fill("#username", "test_user", duration=0.1)
logger.ui_screenshot("/tmp/screenshot.png", size_bytes=102400)
logger.ui_wait_complete("selector", "#modal", duration=0.5, success=True)
logger.ui_error("click", "#missing-element", TimeoutError("Element not found"))
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š

```
[12:34:56] [UI] ğŸŒ LoginPage â†’ https://example.com/login
[12:34:57] [UI] ğŸŒ LoginPage â† âœ… (1500.0ms)
[12:34:57] [UI] âŒ¨ï¸ fill: #username = 'test_user' (100.0ms)
[12:34:57] [UI] âŒ¨ï¸ fill: #password = '***' (100.0ms)
[12:34:58] [UI] ğŸ–±ï¸ click: #login-button (200.0ms)
```

### 4. AllureObserver UI äº‹ä»¶å¤„ç†

AllureObserver æ–°å¢ 7 ä¸ª UI äº‹ä»¶å¤„ç†å™¨ï¼Œè‡ªåŠ¨å°† UI æ“ä½œè®°å½•åˆ° Allure æŠ¥å‘Šï¼š

```python
# è‡ªåŠ¨å¤„ç†çš„äº‹ä»¶
async def handle_ui_navigation_start_event(self, event)
async def handle_ui_navigation_end_event(self, event)
async def handle_ui_click_event(self, event)
async def handle_ui_input_event(self, event)
async def handle_ui_screenshot_event(self, event)
async def handle_ui_wait_event(self, event)
async def handle_ui_error_event(self, event)
```

**Allure æŠ¥å‘Šæ•ˆæœ**ï¼š

UI æ“ä½œä¼šä»¥ JSON é™„ä»¶å½¢å¼å‡ºç°åœ¨æŠ¥å‘Šä¸­ï¼š
- ğŸŒ Navigate: LoginPage â†’ https://example.com/login
- âœ… Navigate: ç™»å½•é¡µé¢ (1500.0ms)
- ğŸ–±ï¸ Click: Login (200.0ms)
- âŒ¨ï¸ Input: #username = 'test_user'
- ğŸ“¸ Screenshot: LoginPage (viewport)
- â° Wait: selector - #modal (visible) (500.0ms)
- âŒ UI Error: click - TimeoutError

**æˆªå›¾è‡ªåŠ¨é™„åŠ **ï¼š

å½“ `UIScreenshotEvent` æˆ– `UIErrorEvent` åŒ…å«æˆªå›¾è·¯å¾„æ—¶ï¼Œæˆªå›¾ä¼šè‡ªåŠ¨ä½œä¸º PNG é™„ä»¶æ·»åŠ åˆ° Allure æŠ¥å‘Šã€‚

### 5. è§†é¢‘å½•åˆ¶æ”¯æŒ

BrowserManager å’Œ UI Fixtures æ–°å¢è§†é¢‘å½•åˆ¶é…ç½®ï¼š

```python
from df_test_framework.capabilities.drivers.web import BrowserManager, BrowserType

# æ–¹å¼1: ç›´æ¥é…ç½® BrowserManager
manager = BrowserManager(
    browser_type=BrowserType.CHROMIUM,
    headless=True,
    record_video=True,          # å¯ç”¨è§†é¢‘å½•åˆ¶
    video_dir="reports/videos", # è§†é¢‘ä¿å­˜ç›®å½•
    video_size={"width": 1280, "height": 720},  # å¯é€‰ï¼šæŒ‡å®šè§†é¢‘åˆ†è¾¨ç‡
)

# æ–¹å¼2: é€šè¿‡ Fixture é…ç½®ï¼ˆåœ¨ conftest.py ä¸­ï¼‰
@pytest.fixture(scope="session")
def browser_record_video(pytestconfig, settings):
    """æ”¯æŒ --record-video å‘½ä»¤è¡Œè¦†ç›–"""
    if pytestconfig.getoption("--record-video"):
        return True
    return getattr(settings, "record_video", False)
```

**å‘½ä»¤è¡Œä½¿ç”¨**ï¼š

```bash
# å¯ç”¨è§†é¢‘å½•åˆ¶
pytest tests/ui/ --record-video

# ç»„åˆå…¶ä»–é€‰é¡¹
pytest tests/ui/ --headed --record-video --browser=firefox
```

**å¤±è´¥æ—¶è‡ªåŠ¨é™„åŠ è§†é¢‘åˆ° Allure æŠ¥å‘Š**ï¼š

æµ‹è¯•å¤±è´¥æ—¶ï¼Œ`pytest_runtest_makereport` é’©å­ä¼šè‡ªåŠ¨å°†è§†é¢‘é™„åŠ åˆ° Allure æŠ¥å‘Šã€‚

### 6. è„šæ‰‹æ¶æ¨¡æ¿å¢å¼º

UI é¡¹ç›®è„šæ‰‹æ¶æ¨¡æ¿å·²æ›´æ–°ï¼Œæ”¯æŒ EventBus å’Œè§†é¢‘å½•åˆ¶ï¼š

**ui_conftest.py æ¨¡æ¿æ›´æ–°**ï¼š
- æ–°å¢ `browser_record_video` fixtureï¼ˆæ”¯æŒ `--record-video` å‘½ä»¤è¡Œè¦†ç›–ï¼‰
- æ–°å¢ `browser_video_dir` fixtureï¼ˆè§†é¢‘ä¿å­˜ç›®å½•é…ç½®ï¼‰
- æ–°å¢ `event_bus` fixtureï¼ˆEventBus å®ä¾‹ï¼‰
- æ–°å¢ `--record-video` å‘½ä»¤è¡Œé€‰é¡¹
- å¤±è´¥æˆªå›¾å’Œè§†é¢‘è‡ªåŠ¨é™„åŠ åˆ° Allure æŠ¥å‘Š

**ui_page_object.py æ¨¡æ¿æ›´æ–°**ï¼š
- BasePage æ”¯æŒ `event_bus` å‚æ•°æ³¨å…¥
- ä½¿ç”¨ç¤ºä¾‹æ–‡æ¡£æ›´æ–°

## æ–‡ä»¶å˜æ›´

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| `src/df_test_framework/core/events/types.py` | æ–°å¢ 7 ä¸ª UI äº‹ä»¶ç±»å‹ |
| `src/df_test_framework/core/events/__init__.py` | å¯¼å‡º UI äº‹ä»¶ |
| `src/df_test_framework/capabilities/drivers/web/playwright/page.py` | BasePage é›†æˆ EventBus |
| `src/df_test_framework/capabilities/drivers/web/playwright/browser.py` | BrowserManager è§†é¢‘å½•åˆ¶é…ç½® |
| `src/df_test_framework/infrastructure/logging/observability.py` | æ–°å¢ ui_logger() å’Œ UI æ—¥å¿—æ–¹æ³• |
| `src/df_test_framework/testing/fixtures/ui.py` | æ–°å¢è§†é¢‘å½•åˆ¶ Fixtures |
| `src/df_test_framework/testing/reporting/allure/observer.py` | æ–°å¢ UI äº‹ä»¶å¤„ç†å™¨ |
| `src/df_test_framework/cli/templates/project/ui_conftest.py` | EventBus + è§†é¢‘å½•åˆ¶æ”¯æŒ |
| `src/df_test_framework/cli/templates/project/ui_page_object.py` | EventBus é›†æˆæ”¯æŒ |

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `docs/architecture/ui-observability-design.md` | UI å¯è§‚æµ‹æ€§è®¾è®¡æ–‡æ¡£ |
| `docs/releases/v3.35.7.md` | æœ¬å‘å¸ƒè¯´æ˜ |

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´é›†æˆç¤ºä¾‹

```python
import pytest
from df_test_framework.capabilities.drivers.web.playwright import BasePage

class LoginPage(BasePage):
    def __init__(self, page, event_bus=None):
        super().__init__(page, url="/login", event_bus=event_bus)
        self.username_input = "#username"
        self.password_input = "#password"
        self.submit_button = "button[type='submit']"

    def wait_for_page_load(self):
        self.wait_for_selector(self.submit_button)

    def login(self, username: str, password: str):
        self.fill(self.username_input, username)
        self.fill(self.password_input, password)
        self.click(self.submit_button)


@pytest.fixture
def login_page(page, event_bus):
    """å¸¦ EventBus çš„ LoginPage fixture"""
    return LoginPage(page, event_bus=event_bus)


def test_login_success(login_page, allure_observer):
    """ç™»å½•æµ‹è¯• - è‡ªåŠ¨è®°å½•åˆ° Allure"""
    # å¯¼èˆªåˆ°ç™»å½•é¡µ
    login_page.goto()  # å‘å¸ƒ UINavigationStartEvent/EndEvent

    # æ‰§è¡Œç™»å½•
    login_page.login("test_user", "password123")  # å‘å¸ƒ UIInputEvent, UIClickEvent

    # éªŒè¯ç»“æœ
    assert login_page.current_url == "/dashboard"

    # Allure æŠ¥å‘Šè‡ªåŠ¨åŒ…å«ï¼š
    # - ğŸŒ Navigate: LoginPage â†’ /login
    # - âœ… Navigate: LoginPage (1500.0ms)
    # - âŒ¨ï¸ Input: #username = 'test_user'
    # - âŒ¨ï¸ Input: #password = '***'  (è‡ªåŠ¨è„±æ•)
    # - ğŸ–±ï¸ Click: button[type='submit']
```

### ä¸ ObservabilityLogger ç»“åˆ

```python
from df_test_framework.infrastructure.logging.observability import ui_logger

def test_with_ui_logging(login_page):
    """ä½¿ç”¨å®æ—¶æ—¥å¿—çš„ UI æµ‹è¯•"""
    logger = ui_logger()

    # æ‰‹åŠ¨è®°å½•é¢å¤–ä¿¡æ¯
    logger.info("å¼€å§‹ç™»å½•æµ‹è¯•")

    login_page.goto()
    login_page.login("test_user", "password123")

    # ç»ˆç«¯å®æ—¶è¾“å‡ºï¼š
    # [12:34:56] [UI] å¼€å§‹ç™»å½•æµ‹è¯•
    # [12:34:56] [UI] ğŸŒ LoginPage â†’ /login
    # [12:34:57] [UI] ğŸŒ LoginPage â† âœ… (1500.0ms)
    # [12:34:57] [UI] âŒ¨ï¸ fill: #username = 'test_user' (100.0ms)
    # [12:34:57] [UI] âŒ¨ï¸ fill: #password = '***' (100.0ms)
    # [12:34:58] [UI] ğŸ–±ï¸ click: button[type='submit'] (200.0ms)
```

## æµ‹è¯•

- 1570 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- 40 ä¸ªæµ‹è¯•è·³è¿‡ï¼ˆéœ€è¦å¤–éƒ¨æœåŠ¡ï¼‰

## å‡çº§æŒ‡å—

æ­¤ç‰ˆæœ¬ä¸ºå‘åå…¼å®¹çš„åŠŸèƒ½å¢å¼ºï¼Œæ— éœ€ç‰¹æ®Šå‡çº§æ­¥éª¤ã€‚

### å¯ç”¨ UI å¯è§‚æµ‹æ€§

1. **æœ€ç®€æ–¹å¼**ï¼šæ— éœ€ä¿®æ”¹ä»£ç ï¼ŒBasePage é»˜è®¤å¯ç”¨äº‹ä»¶å‘å¸ƒï¼ˆå¦‚æœ EventBus å¯ç”¨ï¼‰

2. **æ˜¾å¼æ³¨å…¥ EventBus**ï¼š
   ```python
   from df_test_framework.infrastructure.events import EventBus

   event_bus = EventBus()
   page = LoginPage(playwright_page, event_bus=event_bus)
   ```

3. **é€šè¿‡ Fixture è‡ªåŠ¨æ³¨å…¥**ï¼š
   ```python
   @pytest.fixture
   def login_page(page, event_bus):
       return LoginPage(page, event_bus=event_bus)
   ```

## å‚è€ƒæ–‡æ¡£

- [UI å¯è§‚æµ‹æ€§è®¾è®¡æ–‡æ¡£](../architecture/ui-observability-design.md) - è¯¦ç»†çš„æ¶æ„è®¾è®¡å’Œå®ç°ç»†èŠ‚
- [Allure æŠ¥å‘ŠæŒ‡å—](../guides/allure-reporting.md) - Allure æŠ¥å‘Šä½¿ç”¨è¯´æ˜
