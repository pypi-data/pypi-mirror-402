# v3.38.2 发布说明

> **发布日期**: 2025-12-25
> **版本类型**: 重大重构

---

## 概述

v3.38.2 对日志系统进行了完全重写，从 **loguru** 迁移到 **structlog**，实现了：

- 统一的日志接口（所有模块使用 `get_logger(__name__)`）
- pytest 原生支持（无需桥接）
- 时间格式统一（使用 strftime 格式）
- OpenTelemetry 自动集成

---

## 核心变更

### 从 loguru 迁移到 structlog

| 特性 | v3.38.1 (loguru) | v3.38.2 (structlog) |
|------|-----------------|---------------------|
| 日志库 | loguru | structlog |
| pytest 集成 | 需要桥接 | 原生支持（stdlib logging） |
| 时间格式 | `{time:YYYY-MM-DD HH:mm:ss}` | `%Y-%m-%d %H:%M:%S.%f` |
| 配置方式 | `setup_logger()` | `configure_logging()` |
| 导入方式 | `from loguru import logger` | `get_logger(__name__)` |

### 新增模块

- `infrastructure/logging/interface.py` - Logger Protocol 接口定义
- `infrastructure/logging/config.py` - structlog 配置模块

### 移除模块

- `infrastructure/logging/strategies.py` - 日志策略（不再需要）
- `infrastructure/logging/pytest_integration.py` - pytest 桥接（不再需要）

---

## 新增功能

### Logger Protocol

类型安全的日志接口，支持依赖注入和测试 Mock：

```python
from df_test_framework.infrastructure.logging import Logger

class OrderService:
    def __init__(self, logger: Logger):
        self._logger = logger
```

### configure_logging() API

新的日志配置函数：

```python
from df_test_framework.infrastructure.logging import configure_logging

configure_logging(
    env="dev",           # 环境名称
    level="INFO",        # 日志级别
    json_output=None,    # JSON 输出模式
    enable_sanitize=True # 敏感信息脱敏
)
```

### 上下文传播

全局上下文绑定，自动添加到所有日志：

```python
from df_test_framework.infrastructure.logging import (
    bind_contextvars,
    clear_contextvars,
)

bind_contextvars(request_id="req_123", user_id=456)
# 所有日志自动包含这些字段
clear_contextvars()
```

### OpenTelemetry 集成

自动注入 trace_id 和 span_id（当安装 opentelemetry 时）：

```json
{
  "event": "处理订单",
  "order_id": 789,
  "trace_id": "0af7651916cd43dd8448eb211c80319c",
  "span_id": "b7ad6b7169203331"
}
```

---

## 迁移指南

### 修改导入

```python
# 旧代码
from loguru import logger

# 新代码
from df_test_framework.infrastructure.logging import get_logger

logger = get_logger(__name__)
```

### API 兼容性

以下 API 保持兼容，无需修改：

- `logger.info("message", key=value)`
- `logger.debug("message", key=value)`
- `logger.warning("message", key=value)`
- `logger.error("message", key=value)`
- `logger.exception("error")`
- `logger.bind(key=value)`

### 配置迁移

```python
# 旧代码
from df_test_framework.infrastructure.logging import setup_logger
setup_logger(log_level="INFO", log_file="app.log")

# 新代码
from df_test_framework.infrastructure.logging import configure_logging
configure_logging(env="dev", level="INFO")
```

---

## 依赖变更

### 新增依赖

```toml
structlog = ">=24.1.0"
```

### 移除依赖

```toml
loguru = ">=0.7.0"  # 已移除
```

---

## 文件变更统计

- **新增**: 2 个文件
- **修改**: 38 个文件
- **删除**: 2 个文件

### 修改的文件

所有直接使用 `from loguru import logger` 的模块已改为使用统一的日志接口：

- `capabilities/clients/http/*.py`
- `capabilities/databases/*.py`
- `capabilities/drivers/*.py`
- `infrastructure/*.py`
- `testing/*.py`
- 等共 36 个文件

---

## 测试

- 所有现有测试通过
- 新增日志配置测试

---

## 参考文档

- [现代化日志系统使用指南](../guides/modern_logging_best_practices.md)
- [日志配置指南](../guides/logging_configuration.md)
- [structlog 官方文档](https://www.structlog.org/)

---

## 致谢

感谢 structlog 社区提供的优秀结构化日志库。
