# v3.29.0 发布说明

**发布日期**: 2025-12-16

## 概述

v3.29.0 版本对 `utils/` 模块进行了全面重构，将各功能迁移到正确的五层架构位置，并新增了 Factory 模式用于创建完整的业务测试对象。

### 核心改进

1. **架构规范化** - utils/ 模块功能迁移到正确的架构层级
2. **Factory 模式** - 新增测试数据工厂，与 DataGenerator 互补
3. **向后兼容** - 保留旧导入路径，发出废弃警告

## 迁移指南

### 模块迁移对照表

| 功能 | 旧导入路径 | 新导入路径 |
|------|-----------|-----------|
| DataGenerator | `df_test_framework.utils.data_generator` | `df_test_framework.testing.data` |
| AssertHelper | `df_test_framework.utils.assertion` | `df_test_framework.testing.assertions` |
| CircuitBreaker | `df_test_framework.utils.resilience` | `df_test_framework.infrastructure.resilience` |
| 装饰器 | `df_test_framework.utils.decorator` | `df_test_framework.core.decorators` |
| Decimal类型 | `df_test_framework.utils.types` | `df_test_framework.core.types` |
| 性能工具 | `df_test_framework.utils.performance` | `df_test_framework.infrastructure.metrics` |
| 通用工具 | `df_test_framework.utils.common` | 使用 `DataGenerator` 替代 |

### 代码迁移示例

**旧代码（仍可工作，但会发出废弃警告）**:
```python
from df_test_framework.utils import DataGenerator, AssertHelper
from df_test_framework.utils.resilience import CircuitBreaker
from df_test_framework.utils.decorator import retry_on_failure
```

**新代码（推荐）**:
```python
from df_test_framework.testing.data import DataGenerator
from df_test_framework.testing.assertions import AssertHelper
from df_test_framework.infrastructure.resilience import CircuitBreaker
from df_test_framework.core import retry_on_failure
```

## 新功能

### 1. Factory 模式

Factory 模式用于创建完整的业务对象，与 DataGenerator 互补：
- **DataGenerator**: 生成原子字段值（字符串、数字、日期等）
- **Factory**: 组合字段值创建完整业务对象

#### 基本用法

```python
from df_test_framework.testing.data import Factory, DataGenerator

class UserFactory(Factory):
    """用户工厂"""

    @classmethod
    def _default_fields(cls) -> dict:
        gen = cls._get_generator()
        return {
            "id": gen.user_id(),
            "name": gen.name(),
            "email": gen.email(),
            "phone": gen.chinese_phone(),
            "status": "active",
        }

# 创建单个用户
user = UserFactory.create()

# 创建指定字段的用户
vip_user = UserFactory.create(status="vip", level=10)

# 批量创建
users = UserFactory.create_batch(5)
```

#### 与 Pydantic 模型配合

```python
from pydantic import BaseModel
from df_test_framework.testing.data import ModelFactory

class User(BaseModel):
    id: str
    name: str
    email: str

class UserFactory(ModelFactory[User]):
    class Meta:
        model = User

    @classmethod
    def _default_fields(cls) -> dict:
        gen = cls._get_generator()
        return {
            "id": gen.user_id(),
            "name": gen.name(),
            "email": gen.email(),
        }

# 返回类型是 User 模型
user: User = UserFactory.create()
```

#### 预定义工厂

框架提供了常用业务对象的预定义工厂，可直接使用：

```python
from df_test_framework.testing.data import (
    UserFactory,
    OrderFactory,
    ProductFactory,
    AddressFactory,
)

# 创建用户
user = UserFactory.create()
vip_user = UserFactory.create_vip(level=5)
inactive_user = UserFactory.create_inactive()

# 创建商品
product = ProductFactory.create()
out_of_stock = ProductFactory.create_out_of_stock()

# 创建订单
order = OrderFactory.create()
paid_order = OrderFactory.create_paid()
shipped_order = OrderFactory.create_shipped()

# 创建地址
address = AddressFactory.create()
default_address = AddressFactory.create_default()

# 批量创建
users = UserFactory.create_batch(5)
orders = OrderFactory.create_batch(10, user_id="USR_001")
```

### 2. 弹性工具迁移

CircuitBreaker 熔断器已迁移到 `infrastructure.resilience`:

```python
from df_test_framework.infrastructure.resilience import (
    CircuitBreaker,
    CircuitOpenError,
    circuit_breaker,
)

# 基础使用
breaker = CircuitBreaker(failure_threshold=3, timeout=60)
try:
    result = breaker.call(risky_function)
except CircuitOpenError:
    result = fallback_data()

# 装饰器使用
@circuit_breaker(failure_threshold=5, timeout=30)
def call_external_api():
    return requests.get("https://api.example.com")
```

### 3. 通用装饰器迁移

装饰器已迁移到 `core.decorators`:

```python
from df_test_framework.core import (
    retry_on_failure,
    log_execution,
    deprecated,
    cache_result,
)

@retry_on_failure(max_retries=3, delay=1.0, backoff=2.0)
def unstable_operation():
    pass

@cache_result(ttl=60, maxsize=100)
def expensive_calculation(n):
    return sum(range(n))
```

### 4. Pydantic 序列化类型

Decimal 序列化类型已迁移到 `core.types`:

```python
from pydantic import BaseModel
from df_test_framework.core import DecimalAsFloat, DecimalAsCurrency
from decimal import Decimal

class PriceRequest(BaseModel):
    price: DecimalAsFloat  # 序列化为浮点数

class DisplayAmount(BaseModel):
    amount: DecimalAsCurrency  # 序列化为 "$123.45"
```

### 5. 性能工具迁移

轻量级性能工具已迁移到 `infrastructure.metrics`:

```python
from df_test_framework.infrastructure.metrics import (
    track_performance,
    PerformanceTimer,
    PerformanceCollector,
)

# 装饰器方式
@track_performance(threshold_ms=500)
def test_api_response():
    response = api.get("/users")
    assert response.status_code == 200

# 上下文管理器方式
with PerformanceTimer("数据库查询", threshold_ms=100) as timer:
    result = db.query_all("SELECT * FROM users")
print(f"查询耗时: {timer.duration_ms}ms")

# 收集多次测量
collector = PerformanceCollector("API请求")
for i in range(100):
    with collector.measure():
        api.get("/users")
print(collector.summary())  # {'count': 100, 'avg_ms': 12.5, ...}
```

## 架构改进

### 重构前 vs 重构后

**重构前**: utils/ 游离于五层架构之外

```
utils/
├── assertion.py      # 断言助手
├── common.py         # 通用工具函数
├── data_generator.py # 数据生成器
├── decorator.py      # 装饰器
├── performance.py    # 性能工具
├── resilience.py     # 熔断器
└── types.py          # 类型定义
```

**重构后**: 功能归属正确的架构层级

```
core/                           # Layer 0
├── decorators.py               # 通用装饰器
└── types.py                    # 类型定义（含 Decimal 类型）

infrastructure/                 # Layer 1
├── resilience/
│   └── circuit_breaker.py      # 熔断器
└── metrics/
    └── performance.py          # 轻量级性能工具

testing/                        # Layer 3
├── assertions/
│   └── helper.py               # AssertHelper
└── data/
    ├── generators/
    │   └── data_generator.py   # DataGenerator
    └── factories/
        ├── base.py             # Factory 基类
        └── examples.py         # 预定义工厂
```

## 废弃警告

从 `df_test_framework.utils` 导入会触发 `DeprecationWarning`:

```
DeprecationWarning: 从 'df_test_framework.utils.data_generator' 导入 DataGenerator 已废弃，
请使用 'df_test_framework.testing.data.generators' 或 'df_test_framework.testing.data'。
此模块将在 v4.0.0 中移除。
```

**重要**: v4.0.0 将移除 utils/ 模块中的废弃导出，请尽早迁移到新路径。

## 兼容性

- **Python**: 3.12+
- **向后兼容**: 旧导入路径仍可工作（发出警告）
- **破坏性变更**: 无

## 升级建议

1. **立即可做**: 更新导入路径到新位置
2. **推荐做法**: 使用 `ruff` 或 IDE 批量重构导入
3. **测试验证**: 运行 `pytest -W default` 查看废弃警告

## 文件变更

### 新增文件
- `src/df_test_framework/core/decorators.py` - 通用装饰器
- `src/df_test_framework/infrastructure/resilience/__init__.py` - resilience 模块导出
- `src/df_test_framework/infrastructure/resilience/circuit_breaker.py` - 熔断器实现
- `src/df_test_framework/infrastructure/metrics/performance.py` - 轻量级性能工具
- `src/df_test_framework/testing/data/generators/__init__.py` - generators 模块导出
- `src/df_test_framework/testing/data/generators/data_generator.py` - DataGenerator 实现
- `src/df_test_framework/testing/data/factories/__init__.py` - factories 模块导出
- `src/df_test_framework/testing/data/factories/base.py` - Factory 基类
- `src/df_test_framework/testing/data/factories/examples.py` - 预定义工厂
- `src/df_test_framework/testing/assertions/helper.py` - AssertHelper 实现
- `tests/testing/data/__init__.py` - 测试模块
- `tests/testing/data/test_factories.py` - Factory 单元测试（33个测试）

### 修改文件
- `src/df_test_framework/core/__init__.py` - 导出装饰器和 Decimal 类型
- `src/df_test_framework/core/types.py` - 添加 Decimal 序列化类型
- `src/df_test_framework/infrastructure/__init__.py` - 导出 resilience 模块
- `src/df_test_framework/infrastructure/metrics/__init__.py` - 导出性能工具
- `src/df_test_framework/testing/data/__init__.py` - 导出 Factory 和预定义工厂
- `src/df_test_framework/testing/assertions/__init__.py` - 导出 AssertHelper
- `src/df_test_framework/utils/*.py` - 添加废弃警告

## 相关文档

- [五层架构设计](../architecture/OVERVIEW_V3.17.md)
- [测试数据工具指南](../guides/testing-data-tools.md)
