# v3.31.0 发布说明

**发布日期**: 2025-12-17

## 概述

v3.31.0 版本重构了 Factory 系统，融合 factory_boy 和 polyfactory 的最佳实践，提供现代化的声明式 API。

### 核心改进

1. **Factory 重构** - 现代化声明式 API，支持泛型类型提示
2. **Trait 支持** - 预设配置组，通过布尔标志激活（如 `admin=True`）
3. **SubFactory/PostGenerated** - 嵌套工厂和后处理字段
4. **8 个预置工厂** - 覆盖常见业务场景（User、Product、Order 等）

## 新功能

### 1. 声明式 Factory API

新的 Factory 系统采用声明式字段定义，类似 factory_boy 风格。

#### 基本用法

```python
from df_test_framework.testing.data.factories import (
    Factory,
    Sequence,
    LazyAttribute,
    FakerAttribute,
)

class UserFactory(Factory[dict]):
    """用户工厂"""
    id = Sequence(lambda n: n)
    username = Sequence(lambda n: f"user_{n}")
    email = LazyAttribute(lambda obj: f"{obj['username']}@example.com")
    name = FakerAttribute("name")

# 构建单个对象
user = UserFactory.build()
# {'id': 1, 'username': 'user_1', 'email': 'user_1@example.com', 'name': '张三'}

# 构建批量对象
users = UserFactory.build_batch(3)

# 覆盖字段
admin = UserFactory.build(role="admin", is_active=True)
```

### 2. Trait 支持

Trait 是预设的配置组，通过布尔标志激活。

```python
from df_test_framework.testing.data.factories import Factory, Trait

class UserFactory(Factory[dict]):
    id = Sequence(lambda n: n)
    username = Sequence(lambda n: f"user_{n}")
    role = "user"
    is_active = True

    # 定义 Trait
    admin = Trait(role="admin", permissions=["read", "write", "delete"])
    vip = Trait(level="vip", discount=0.8)
    inactive = Trait(is_active=False)

# 使用 Trait
admin_user = UserFactory.build(admin=True)
# {'id': 1, 'username': 'user_1', 'role': 'admin', 'is_active': True, 'permissions': ['read', 'write', 'delete']}

vip_user = UserFactory.build(vip=True)
# {'id': 2, 'username': 'user_2', 'role': 'user', 'is_active': True, 'level': 'vip', 'discount': 0.8}

# 组合多个 Trait
admin_vip = UserFactory.build(admin=True, vip=True)
```

### 3. SubFactory - 嵌套工厂

SubFactory 用于创建嵌套对象。

```python
from df_test_framework.testing.data.factories import Factory, SubFactory

class AddressFactory(Factory[dict]):
    city = "北京"
    street = Sequence(lambda n: f"街道{n}号")

class UserFactory(Factory[dict]):
    name = FakerAttribute("name")
    address = SubFactory(AddressFactory)

user = UserFactory.build()
# {'name': '张三', 'address': {'city': '北京', 'street': '街道1号'}}

# 覆盖嵌套字段
user = UserFactory.build(address__city="上海")
# {'name': '李四', 'address': {'city': '上海', 'street': '街道2号'}}
```

### 4. PostGenerated - 后处理字段

PostGenerated 在所有字段生成后计算，可访问完整对象。

```python
from df_test_framework.testing.data.factories import Factory, PostGenerated

class OrderFactory(Factory[dict]):
    items = [{"price": 100}, {"price": 200}]
    # 在所有字段生成后计算总价
    total = PostGenerated(lambda obj: sum(item["price"] for item in obj["items"]))

order = OrderFactory.build()
# {'items': [{'price': 100}, {'price': 200}], 'total': 300}
```

### 5. 其他字段类型

#### Sequence - 自增序列

```python
from df_test_framework.testing.data.factories import Sequence

class ProductFactory(Factory[dict]):
    id = Sequence(lambda n: n)  # 1, 2, 3, ...
    sku = Sequence(lambda n: f"SKU-{n:06d}")  # SKU-000001, SKU-000002, ...
```

#### LazyAttribute - 延迟计算

```python
from df_test_framework.testing.data.factories import LazyAttribute

class UserFactory(Factory[dict]):
    first_name = FakerAttribute("first_name")
    last_name = FakerAttribute("last_name")
    # 访问已生成的字段
    full_name = LazyAttribute(lambda obj: f"{obj['first_name']} {obj['last_name']}")
```

#### FakerAttribute - Faker 数据

```python
from df_test_framework.testing.data.factories import FakerAttribute

class UserFactory(Factory[dict]):
    name = FakerAttribute("name")
    email = FakerAttribute("email")
    phone = FakerAttribute("phone_number")
    address = FakerAttribute("address")
```

#### Use - 直接调用函数

```python
from df_test_framework.testing.data.factories import Use
import uuid

class OrderFactory(Factory[dict]):
    id = Use(lambda: str(uuid.uuid4()))
    created_at = Use(lambda: datetime.now().isoformat())
```

### 6. 预置工厂

框架提供 8 个开箱即用的预置工厂：

```python
from df_test_framework.testing.data.factories import (
    UserFactory,
    ProductFactory,
    AddressFactory,
    OrderFactory,
    PaymentFactory,
    CardFactory,
    ApiResponseFactory,
    PaginationFactory,
)

# 用户工厂 - 支持 admin/vip/inactive Trait
user = UserFactory.build()
admin = UserFactory.build(admin=True)

# 商品工厂 - 支持 on_sale/out_of_stock Trait
product = ProductFactory.build()
sale_product = ProductFactory.build(on_sale=True)

# 订单工厂 - 支持 pending/paid/shipped/completed Trait
order = OrderFactory.build()
paid_order = OrderFactory.build(paid=True)

# API 响应工厂 - 支持 error/paginated Trait
response = ApiResponseFactory.build()
error_response = ApiResponseFactory.build(error=True)
paginated = ApiResponseFactory.build(paginated=True)
```

## 迁移指南

### 从旧 API 迁移

旧的 `testing/factories` 模块已废弃，请迁移到 `testing/data/factories`。

```python
# ❌ 旧导入方式 (已废弃，将在 v4.0.0 移除)
from df_test_framework.testing.factories import UserFactory

# ✅ 新导入方式 (推荐)
from df_test_framework.testing.data.factories import UserFactory
```

### API 变更

| 旧 API | 新 API | 说明 |
|--------|--------|------|
| `Factory.create()` | `Factory.build()` | 方法重命名 |
| `Factory.create_batch()` | `Factory.build_batch()` | 方法重命名 |
| `_default_fields()` | 声明式字段 | 不再需要方法定义 |
| 无 | `Trait` | 新增预设配置组 |
| 无 | `SubFactory` | 新增嵌套工厂 |
| 无 | `PostGenerated` | 新增后处理字段 |

### 自定义工厂迁移示例

```python
# ❌ 旧方式
class OldUserFactory(Factory):
    @classmethod
    def _default_fields(cls) -> dict:
        return {
            "id": cls._next_id(),
            "username": f"user_{cls._next_id()}",
        }

# ✅ 新方式
class NewUserFactory(Factory[dict]):
    id = Sequence(lambda n: n)
    username = Sequence(lambda n: f"user_{n}")
```

## 文件变更

### 重写文件

- `src/df_test_framework/testing/data/factories/base.py` - Factory 核心类重写
- `src/df_test_framework/testing/data/factories/examples.py` - 预置工厂重写
- `tests/testing/data/test_factories.py` - 测试重写

### 修改文件

- `src/df_test_framework/testing/data/factories/__init__.py` - 新增 FactoryMeta 导出
- `src/df_test_framework/testing/factories/__init__.py` - 添加废弃警告
- `pyproject.toml` - 版本号更新
- `src/df_test_framework/__init__.py` - 版本号更新
- `CHANGELOG.md` - 添加版本记录
- `docs/architecture/ROADMAP_V3.29_ENHANCEMENTS.md` - 移除时间估算，更新版本规划

### 新增文件

- `docs/releases/v3.31.0.md` - 本发布说明

## 兼容性

- **Python**: 3.12+
- **向后兼容**: 旧模块保留，发出废弃警告
- **迁移周期**: 旧 API 将在 v4.0.0 移除

## 测试结果

- Factory 相关测试: 96 passed
- 总测试: 1476 passed, 40 skipped
- 覆盖率: ≥80%

## 相关文档

- [五层架构设计](../architecture/OVERVIEW_V3.17.md)
- [v3.30.0 发布说明](./v3.30.0.md) - 断言增强
- [v3.29.0 发布说明](./v3.29.0.md) - utils 重构与初版 Factory
