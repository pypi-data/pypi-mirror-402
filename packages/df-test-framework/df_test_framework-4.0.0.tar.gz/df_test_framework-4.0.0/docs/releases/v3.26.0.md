# v3.26.0 发布说明 - pytest 日志集成重构

> **发布日期**: 2025-12-14
> **Python 要求**: >= 3.12

---

## 概述

v3.26.0 重构了 loguru 与 pytest 的日志集成方案，采用 loguru → logging 桥接模式，解决了日志与测试名称混在同一行的显示问题。

---

## 问题背景

### 之前的问题

在 v3.23.0 中，我们通过覆盖 `caplog` fixture 实现了 loguru 与 pytest 的集成。但这种方案有一个显示问题：

```
tests/api/test_auth.py::test_login 2025-12-14 16:15:47 | INFO | 数据库连接已建立
```

日志和测试名称混在同一行，原因是 loguru 直接输出到 stderr，而 pytest 在输出测试名称时没有换行。

### v3.26.0 解决方案

采用 loguru 官方推荐的桥接模式，将 loguru 日志转发到标准 `logging` 模块，让 pytest 原生控制日志的显示时序：

```
tests/api/test_auth.py::test_login PASSED

------------------------------ Captured log call -------------------------------
INFO     mymodule:test_auth.py:25 2025-12-14 16:15:47 | INFO | 数据库连接已建立
```

---

## 新增功能

### 1. `logging_plugin` - pytest 日志插件

自动配置 loguru → logging 桥接，只需在 `conftest.py` 中声明：

```python
pytest_plugins = ["df_test_framework.testing.plugins.logging_plugin"]
```

### 2. `setup_pytest_logging()` - 手动配置 API

如果需要手动控制，可以直接调用：

```python
from df_test_framework.infrastructure.logging import setup_pytest_logging

@pytest.fixture(scope="session", autouse=True)
def _configure_logging():
    setup_pytest_logging()
```

### 3. 完整的 caplog 支持

loguru 日志现在可以被 pytest 的 `caplog` fixture 正确捕获：

```python
def test_logging(caplog):
    from loguru import logger

    with caplog.at_level(logging.DEBUG):
        logger.info("Test message")

    # ✅ 现在可以正确断言
    assert "Test message" in caplog.text
```

---

## 使用示例

### 场景 1：框架项目使用

在测试项目的 `conftest.py` 中启用：

```python
# conftest.py
pytest_plugins = [
    "df_test_framework.testing.plugins.logging_plugin",  # loguru 集成
    "df_test_framework.testing.fixtures.core",
    "df_test_framework.testing.fixtures.allure",
]
```

### 场景 2：断言日志内容

```python
def test_api_logs_request(caplog, http_client):
    """测试 API 调用会记录日志"""
    import logging

    with caplog.at_level(logging.DEBUG):
        http_client.get("/api/users")

    # 验证日志包含 HTTP 请求信息
    assert "GET" in caplog.text
    assert "/api/users" in caplog.text
```

### 场景 3：验证特定日志级别

```python
def test_error_logging(caplog):
    """测试错误日志"""
    from loguru import logger

    with caplog.at_level(logging.ERROR):
        logger.error("Something went wrong")

    # 只捕获 ERROR 及以上级别
    assert any(record.levelname == "ERROR" for record in caplog.records)
```

---

## API 参考

### logging_plugin

```python
# 作为 pytest 插件加载
pytest_plugins = ["df_test_framework.testing.plugins.logging_plugin"]
```

自动在 `pytest_configure` 阶段配置 loguru 桥接。

### setup_pytest_logging()

```python
def setup_pytest_logging(
    level: str = "DEBUG",
    format_string: str = "{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
) -> int:
    """配置 loguru 与 pytest 集成

    Args:
        level: 日志级别，默认 DEBUG
        format_string: loguru 格式字符串

    Returns:
        handler_id: 可用于后续移除的 handler ID
    """
```

### teardown_pytest_logging()

```python
def teardown_pytest_logging() -> None:
    """清理 pytest 日志集成，恢复 loguru 默认行为"""
```

---

## 迁移指南

### 从 v3.23.0 升级

1. **移除旧的 caplog fixture**（如果有自定义）

   旧代码（v3.23.0）：
   ```python
   # ❌ 不再需要
   @pytest.fixture
   def caplog(caplog):
       from loguru import logger
       handler_id = logger.add(caplog.handler, ...)
       yield caplog
       logger.remove(handler_id)
   ```

2. **添加 logging_plugin**

   ```python
   # conftest.py
   pytest_plugins = [
       "df_test_framework.testing.plugins.logging_plugin",  # 新增
       # ... 其他插件
   ]
   ```

3. **测试代码无需修改**

   现有的 `caplog` 断言代码继续有效。

---

## 技术原理

### loguru → logging 桥接

```
┌─────────────────────────────────────────────────────────────────┐
│  loguru.info("message")                                         │
│          │                                                      │
│          ▼                                                      │
│  _loguru_sink(message)                                          │
│          │                                                      │
│          ▼                                                      │
│  logging.getLogger(name).log(level, message)                    │
│          │                                                      │
│          ▼                                                      │
│  pytest caplog handler 捕获                                     │
│          │                                                      │
│          ▼                                                      │
│  测试结束后统一显示在 "Captured log" 区域                       │
└─────────────────────────────────────────────────────────────────┘
```

### 关键实现

```python
def _loguru_sink(message: str) -> None:
    """将 loguru 日志转发到标准 logging"""
    record = message.record
    level = record["level"].no
    name = record["name"]

    std_logger = logging.getLogger(name)
    std_logger.setLevel(logging.DEBUG)
    std_logger.propagate = True

    std_logger.log(level, message.rstrip("\n"))
```

---

## 向后兼容性

- ✅ 现有测试代码无需修改
- ✅ caplog 断言继续有效
- ⚠️ 移除了旧的 caplog fixture（框架内部）
- ⚠️ 日志显示位置从实时输出变为测试结束后统一显示

---

## 变更列表

### 新增

- `infrastructure/logging/pytest_integration.py` - loguru → logging 桥接模块
- `testing/plugins/logging_plugin.py` - pytest 日志插件
- `setup_pytest_logging()` / `teardown_pytest_logging()` - 配置 API
- `set_pytest_mode()` / `is_pytest_mode()` - pytest 模式标志控制

### 变更

- `infrastructure/logging/logger.py` - 新增 pytest 模式支持，当 `_PYTEST_MODE=True` 时使用桥接 handler

### 移除

- `testing/fixtures/core.py` 中的 `caplog` fixture 覆盖

### 文档

- `docs/releases/v3.26.0.md` - 本发布说明

### 测试

- 新增 7 个测试用例，全部通过

---

## 相关文档

- [pytest 日志集成指南](../guides/logging_pytest_integration.md) - 完整的设计决策和使用指南
- [pytest 日志捕获](https://docs.pytest.org/en/stable/how-to/logging.html)
- [loguru 迁移指南](https://loguru.readthedocs.io/en/stable/resources/migration.html)
