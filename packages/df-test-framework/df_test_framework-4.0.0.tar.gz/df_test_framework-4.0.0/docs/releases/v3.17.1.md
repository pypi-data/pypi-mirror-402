# v3.17.1 ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-12-08
**ç±»å‹**: Bug ä¿®å¤å’Œä¼˜åŒ–ç‰ˆæœ¬

---

## ğŸ“‹ æ¦‚è¿°

v3.17.1 æ˜¯ä¸€ä¸ªé‡è¦çš„Bugä¿®å¤å’Œæ¶æ„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
1. è§£å†³ v3.17.0 å‘å¸ƒåå‘ç°çš„åŒæ­¥/å¼‚æ­¥äº‹ä»¶å¤„ç†å™¨å…¼å®¹æ€§é—®é¢˜
2. å®Œæˆèƒ½åŠ›å±‚ Allure é›†æˆçš„å½»åº•è§£è€¦
3. å®ç° UnitOfWork äº‹åŠ¡äº‹ä»¶è‡ªåŠ¨è®°å½•åˆ° Allure æŠ¥å‘Š
4. è§„åˆ’æœªæ¥ Allure çº¯æ’ä»¶æ¨¡å¼ï¼ˆfuture_allure_plugin_plans.mdï¼‰

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. UoW äº‹åŠ¡äº‹ä»¶é›†æˆåˆ° Allure æŠ¥å‘Š

**æ ¸å¿ƒä»·å€¼**ï¼š
- æä¾›å®Œæ•´çš„æµ‹è¯•æ•°æ®ç”Ÿå‘½å‘¨æœŸè¿½è¸ª
- è‡ªåŠ¨è®°å½•äº‹åŠ¡æäº¤/å›æ»šæ“ä½œ
- åŒºåˆ†ä¸åŒå›æ»šåŸå› ï¼ˆauto/exception/manualï¼‰
- ç»Ÿè®¡äº‹åŠ¡æ¶‰åŠçš„ Repository æ•°é‡

**å®ç°å†…å®¹**ï¼š
- æ–°å¢ `TransactionCommitEvent` å’Œ `TransactionRollbackEvent` äº‹ä»¶ç±»å‹
- UoW çš„ `commit()` å’Œ `rollback()` æ–¹æ³•è‡ªåŠ¨å‘å¸ƒäº‹ä»¶
- AllureObserver è‡ªåŠ¨è®¢é˜…å¹¶è®°å½•åˆ° Allure æŠ¥å‘Š
- ä¿®å¤ `uow` fixture æœªä¼ é€’ `event_bus` å‚æ•°çš„å…³é”® Bug

è¯¦è§æœ¬æ–‡æ¡£ç¬¬ 6 èŠ‚ã€‚

### 2. èƒ½åŠ›å±‚ Allure é›†æˆæ¶æ„ä¼˜åŒ–

**èƒŒæ™¯é—®é¢˜**ï¼š
- v3.17.0 è™½ç„¶å¼•å…¥äº† EventBusï¼Œä½†èƒ½åŠ›å±‚ä»ç„¶ç›´æ¥è°ƒç”¨ AllureObserver
- å¯¼è‡´ç´§è€¦åˆã€æµ‹è¯•å›°éš¾ã€æ¶æ„ä¸æ¸…æ™°
- AllurePlugin ä¸ allure fixture åŠŸèƒ½é‡å¤

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»Ÿä¸€ä¸ºçº¯ EventBus é©±åŠ¨æ¨¡å¼
- èƒ½åŠ›å±‚åªå‘å¸ƒäº‹ä»¶ï¼Œä¸å…³å¿ƒ Allure
- AllureObserver é€šè¿‡ EventBus è®¢é˜…äº‹ä»¶
- AllurePlugin æ ‡è®°ä¸º DEPRECATED

### 2. EventBus åŒæ­¥/å¼‚æ­¥å¤„ç†å™¨å…¼å®¹æ€§ä¿®å¤

**èƒŒæ™¯é—®é¢˜**ï¼š
- v3.17.0 AllureObserver çš„æ•°æ®åº“äº‹ä»¶å¤„ç†å™¨æ”¹ä¸ºåŒæ­¥æ–¹æ³•
- ä½† EventBus._safe_call() æ— æ¡ä»¶ await æ‰€æœ‰å¤„ç†å™¨
- å¯¼è‡´ `TypeError: object NoneType can't be used in 'await' expression`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- EventBus è‡ªåŠ¨æ£€æµ‹å¤„ç†å™¨è¿”å›å€¼æ˜¯å¦ä¸ºåç¨‹
- åŒæ­¥å¤„ç†å™¨ç›´æ¥è°ƒç”¨ï¼Œå¼‚æ­¥å¤„ç†å™¨æ‰ await
- å®Œå…¨å‘åå…¼å®¹

### 3. BearerTokenMiddleware è‡ªåŠ¨æ³¨å…¥ä¿®å¤

**èƒŒæ™¯é—®é¢˜**ï¼š
- LOGIN æ¨¡å¼ä¸­é—´ä»¶éœ€è¦ http_client è·å– token
- ä½†ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ `set_http_client()`
- å®¹æ˜“å¿˜è®°ï¼Œå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- HttpClient.use() æ–¹æ³•è‡ªåŠ¨æ£€æµ‹å¹¶æ³¨å…¥ http_client
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. Database äº‹ä»¶å‡çº§

**æ–‡ä»¶**: `src/df_test_framework/core/events/types.py`

Database äº‹ä»¶å‡çº§ä¸º CorrelatedEventï¼Œæ–°å¢å­—æ®µï¼š

```python
@dataclass(frozen=True)
class DatabaseQueryStartEvent(CorrelatedEvent):
    """æ•°æ®åº“æŸ¥è¯¢å¼€å§‹äº‹ä»¶

    v3.17.1: æ–°å¢ operation/table å­—æ®µï¼Œå‡çº§ä¸º CorrelatedEvent
    """

    operation: str = ""  # ğŸ†• æ“ä½œç±»å‹: SELECT/INSERT/UPDATE/DELETE
    table: str = ""      # ğŸ†• è¡¨å
    sql: str = ""
    params: dict[str, Any] = field(default_factory=dict)

    @classmethod
    def create(
        cls,
        correlation_id: str,
        operation: str = "",
        table: str = "",
        sql: str = "",
        params: dict[str, Any] | None = None,
        context: ExecutionContext | None = None,
    ) -> "DatabaseQueryStartEvent":
        """å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºäº‹ä»¶"""
        trace_id, span_id = _get_current_trace_context()
        return cls(
            correlation_id=correlation_id,
            operation=operation,
            table=table,
            sql=sql,
            params=params or {},
            context=context,
            trace_id=trace_id,
            span_id=span_id,
        )
```

**æ–°å¢å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç”¨é€” |
|-----|------|------|------|
| `operation` | str | æ“ä½œç±»å‹ | SELECT/INSERT/UPDATE/DELETEï¼Œç”¨äº Allure æŠ¥å‘Šåˆ†ç±» |
| `table` | str | è¡¨å | æå–è‡ª SQLï¼Œç”¨äºè¿½è¸ªè¡¨çº§æ“ä½œ |

### 2. EventBus åŒæ­¥/å¼‚æ­¥å¤„ç†å™¨æ”¯æŒ

**æ–‡ä»¶**: `src/df_test_framework/infrastructure/events/bus.py`

```python
async def _safe_call(self, handler: Callable, event: Any) -> None:
    """å®‰å…¨è°ƒç”¨äº‹ä»¶å¤„ç†å™¨ï¼ˆæ•è·å¼‚å¸¸ï¼‰

    v3.17.1: æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤„ç†å™¨
    """
    try:
        result = handler(event)

        # v3.17.1: æ£€æµ‹æ˜¯å¦ä¸ºåç¨‹ï¼Œä»…å¯¹å¼‚æ­¥å¤„ç†å™¨ await
        if inspect.iscoroutine(result):
            await result
        # åŒæ­¥å¤„ç†å™¨ç›´æ¥è¿”å›ï¼ˆresult ä¸º None æˆ–è¿”å›å€¼ï¼‰

    except Exception as e:
        logger.error(f"äº‹ä»¶å¤„ç†å™¨ {handler.__name__} æ‰§è¡Œå¤±è´¥: {e}")
```

**å…¼å®¹æ€§**ï¼š

| å¤„ç†å™¨ç±»å‹ | å®šä¹‰ | EventBus è¡Œä¸º |
|-----------|------|--------------|
| å¼‚æ­¥ | `async def handler(event)` | è‡ªåŠ¨æ£€æµ‹åç¨‹å¹¶ await |
| åŒæ­¥ | `def handler(event)` | ç›´æ¥è°ƒç”¨ï¼Œæ—  await |

---

## ğŸ› Bug ä¿®å¤

### 1. ä¿®å¤ EventBus åŒæ­¥å¤„ç†å™¨æŠ¥é”™

**é—®é¢˜æè¿°**ï¼š
```python
# AllureObserver æ•°æ®åº“äº‹ä»¶å¤„ç†å™¨ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰
def handle_database_query_start_event(self, event) -> None:
    # åŒæ­¥æ–¹æ³•ï¼Œè¿”å› None
    allure.attach(...)

# EventBus._safe_call() æ— æ¡ä»¶ await
result = handler(event)  # result = None
await result  # âŒ TypeError: object NoneType can't be used in 'await' expression
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# v3.17.1 ä¿®å¤å
result = handler(event)
if inspect.iscoroutine(result):  # â† æ£€æŸ¥æ˜¯å¦ä¸ºåç¨‹
    await result  # âœ… åª await å¼‚æ­¥å¤„ç†å™¨
```

**å½±å“**ï¼š
- ç°åœ¨å¯ä»¥æ··åˆæ³¨å†ŒåŒæ­¥å’Œå¼‚æ­¥å¤„ç†å™¨
- AllureObserver çš„åŒæ­¥æ–¹æ³•æ­£å¸¸å·¥ä½œ
- å®Œå…¨å‘åå…¼å®¹

### 2. ä¿®å¤ BearerTokenMiddleware è‡ªåŠ¨æ³¨å…¥ï¼ˆå« PathFilteredMiddleware æ”¯æŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```python
# é—®é¢˜ 1: ç”¨æˆ·ä»£ç å¿˜è®°æ‰‹åŠ¨æ³¨å…¥
client = HttpClient(
    base_url="https://api.example.com",
    middlewares=[
        BearerTokenMiddleware(
            source=TokenSource.LOGIN,
            login_endpoint="/auth/login",
            # âŒ å¿˜è®°è°ƒç”¨ set_http_client()
        )
    ]
)

# é—®é¢˜ 2: PathFilteredMiddleware åŒ…è£…åæ— æ³•æ³¨å…¥
http_config = HTTPConfig(
    middlewares=[
        BearerTokenMiddlewareConfig(
            source=TokenSource.LOGIN,
            login_url="/admin/login",
            credentials={...},
            include_paths=["/admin/**"],  # â† ä¼šè¢«åŒ…è£…ä¸º PathFilteredMiddleware
        )
    ]
)
# âŒ PathFilteredMiddleware å¤–å±‚æ²¡æœ‰ set_http_clientï¼Œå¯¼è‡´å†…éƒ¨ä¸­é—´ä»¶æ— æ³•è·å– http_client
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```python
# æ–¹æ¡ˆ 1: HttpClient.use() - ç»Ÿä¸€æ¥å£ï¼ˆclient.py:222-248ï¼‰
def use(self, middleware: Middleware) -> "HttpClient":
    """æ³¨å†Œä¸­é—´ä»¶

    v3.17.1: ç»Ÿä¸€çš„ä¸­é—´ä»¶åˆå§‹åŒ–æ¥å£ (set_http_client)
    """
    # v3.17.1: ç»Ÿä¸€çš„ä¸­é—´ä»¶åˆå§‹åŒ–æ¥å£
    # ä»»ä½•éœ€è¦ http_client çš„ä¸­é—´ä»¶éƒ½åº”å®ç° set_http_client æ–¹æ³•
    if hasattr(middleware, "set_http_client"):
        middleware.set_http_client(self)
        logger.debug(f"å·²ä¸ºä¸­é—´ä»¶ {middleware.name} æ³¨å…¥ http_client")

    self._middlewares.append(middleware)
    return self

# æ–¹æ¡ˆ 2: PathFilteredMiddleware - Decorator æ¨¡å¼ä¼ é€’ï¼ˆfactory.py:237-247ï¼‰
class PathFilteredMiddleware:
    def set_http_client(self, http_client):
        """è®¾ç½® HTTP å®¢æˆ·ç«¯ï¼ˆä¼ é€’ç»™å†…éƒ¨ä¸­é—´ä»¶ï¼‰

        v3.17.1 æ–°å¢: Decorator æ¨¡å¼ - ä¼ é€’æ–¹æ³•è°ƒç”¨ç»™è¢«åŒ…è£…çš„å¯¹è±¡
        """
        if hasattr(self._middleware, "set_http_client"):
            self._middleware.set_http_client(http_client)
            logger.debug(f"[PathFilteredMiddleware] å·²ä¼ é€’ http_client ç»™å†…éƒ¨ä¸­é—´ä»¶")

    async def __call__(self, request, call_next):
        # è·¯å¾„è¿‡æ»¤ + æ‰§è¡Œå†…éƒ¨ä¸­é—´ä»¶
        if should_execute:
            return await self._middleware(request, call_next)
        return await call_next(request)
```

**è®¾è®¡åŸåˆ™**ï¼š
1. **ç»Ÿä¸€æ¥å£**: ä½¿ç”¨ `hasattr()` é¸­å­ç±»å‹æ£€æŸ¥ï¼Œè€Œé `isinstance()` ç¡¬ç¼–ç 
2. **Decorator æ¨¡å¼**: `PathFilteredMiddleware` é€æ˜ä¼ é€’æ–¹æ³•è°ƒç”¨ç»™å†…éƒ¨ä¸­é—´ä»¶
3. **èŒè´£å•ä¸€**: `HttpClient` è´Ÿè´£è°ƒç”¨æ¥å£ï¼Œ`PathFilteredMiddleware` è´Ÿè´£ä¼ é€’ï¼Œ`BearerTokenMiddleware` è´Ÿè´£ä½¿ç”¨
4. **å¼€æ”¾å°é—­**: ä»»ä½•æ–°çš„åŒ…è£…å™¨ä¸­é—´ä»¶åªéœ€å®ç° `set_http_client` æ–¹æ³•å³å¯

**å½±å“**ï¼š
- âœ… ç”¨æˆ·æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨
- âœ… æ”¯æŒ PathFilteredMiddleware åŒ…è£…çš„ä¸­é—´ä»¶
- âœ… æ”¯æŒæœªæ¥ä»»æ„åŒ…è£…å™¨ä¸­é—´ä»¶ï¼ˆåªéœ€å®ç°æ¥å£ï¼‰
- âœ… å®Œå…¨å‘åå…¼å®¹ï¼ˆæ‰‹åŠ¨è°ƒç”¨ set_http_client() ä»ç„¶æœ‰æ•ˆï¼‰

### 3. ä¿®å¤èƒ½åŠ›å±‚ AllureObserver ç´§è€¦åˆ

**é—®é¢˜æè¿°**ï¼š
```python
# v3.17.0 Database å®¢æˆ·ç«¯ï¼ˆç´§è€¦åˆï¼‰
from df_test_framework.testing.reporting.allure import get_current_observer

def execute(self, sql, params=None):
    observer = get_current_observer()  # âŒ ç›´æ¥ä¾èµ– AllureObserver
    if observer:
        observer.on_query_start(sql, params)

    # æ‰§è¡Œ SQL...

    if observer:
        observer.on_query_end(result, duration)
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# v3.17.1 Database å®¢æˆ·ç«¯ï¼ˆè§£è€¦ï¼‰
from df_test_framework.infrastructure.events import get_event_bus

def execute(self, sql, params=None):
    correlation_id = self._generate_correlation_id()

    # å‘å¸ƒäº‹ä»¶ï¼ˆä¸å…³å¿ƒè°ç›‘å¬ï¼‰
    self._publish_sync(DatabaseQueryStartEvent.create(
        correlation_id=correlation_id,
        operation="SELECT",
        table="users",
        sql=sql,
        params=params,
    ))

    # æ‰§è¡Œ SQL...

    self._publish_sync(DatabaseQueryEndEvent.create(
        correlation_id=correlation_id,
        rows=len(result),
        duration_ms=duration,
    ))
```

**æ¶æ„å¯¹æ¯”**ï¼š

| ç»´åº¦ | v3.17.0ï¼ˆæ—§ï¼‰ | v3.17.1ï¼ˆæ–°ï¼‰ |
|-----|-------------|-------------|
| ä¾èµ–æ–¹å‘ | Database â†’ AllureObserver | Database â†’ EventBus |
| è€¦åˆåº¦ | ç´§è€¦åˆ | æ¾è€¦åˆ |
| æµ‹è¯•æ€§ | å›°éš¾ï¼ˆéœ€ mock AllureObserverï¼‰ | ç®€å•ï¼ˆè®¢é˜…äº‹ä»¶å³å¯ï¼‰ |
| æ‰©å±•æ€§ | ä½ï¼ˆåªæ”¯æŒ Allureï¼‰ | é«˜ï¼ˆä»»ä½•è®¢é˜…è€…éƒ½å¯ç›‘å¬ï¼‰ |

---

## ğŸ”„ é‡æ„

### 1. Database å®¢æˆ·ç«¯äº‹ä»¶å‘å¸ƒç»Ÿä¸€åŒ–

**å˜æ›´å†…å®¹**ï¼š
- æ‰€æœ‰æ•°æ®åº“æ“ä½œç»Ÿä¸€ä½¿ç”¨ `publish_sync()` å‘å¸ƒäº‹ä»¶
- ç§»é™¤ç›´æ¥ AllureObserver è°ƒç”¨
- æ·»åŠ  operation/table å­—æ®µ

**å½±å“æ–¹æ³•**ï¼š
- `execute()` - åŸç”Ÿ SQL æ‰§è¡Œ
- `query_one()` - æŸ¥è¯¢å•è¡Œ
- `query_all()` - æŸ¥è¯¢å¤šè¡Œ
- `insert()` - æ’å…¥æ•°æ®

### 2. Redis å®¢æˆ·ç«¯äº‹ä»¶å‘å¸ƒç»Ÿä¸€åŒ–

**å˜æ›´å†…å®¹**ï¼š
- ç§»é™¤ `_execute_operation()` ä¸­çš„ç›´æ¥ AllureObserver è°ƒç”¨
- ç»Ÿä¸€é€šè¿‡ EventBus å‘å¸ƒ Cache äº‹ä»¶

### 3. AllureObserver åºŸå¼ƒæ–¹æ³•æ¸…ç†

**åˆ é™¤çš„æ–¹æ³•**ï¼š
- `on_query_start()`
- `on_query_end()`
- `on_query_error()`
- `on_cache_operation()`

**ä¿ç•™çš„æ–¹æ³•**ï¼š
- æ‰€æœ‰ `handle_*_event()` EventBus äº‹ä»¶å¤„ç†å™¨

---

## ğŸ“Š æ¶æ„å˜æ›´

### v3.17.0 æ¶æ„ï¼ˆæ—§ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       ç›´æ¥è°ƒç”¨        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚AllureObserverâ”‚
â”‚   Client    â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
       â”‚                                    â”‚
       â”‚ å‘å¸ƒäº‹ä»¶                            â”‚ è®¢é˜…äº‹ä»¶
       â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBus   â”‚                      â”‚Allure Fixtureâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šåŒé‡è·¯å¾„ï¼Œç´§è€¦åˆ
```

### v3.17.1 æ¶æ„ï¼ˆæ–°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database   â”‚
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ åªå‘å¸ƒäº‹ä»¶
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBus   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ è®¢é˜…äº‹ä»¶
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      è‡ªåŠ¨è§¦å‘       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚AllureObserverâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚Allure Fixtureâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼šå•ä¸€è·¯å¾„ï¼Œæ¾è€¦åˆ
```

---

## ğŸ“ˆ æ€§èƒ½ä¸æµ‹è¯•

### æµ‹è¯•ç»“æœ

```bash
$ uv run pytest tests/ -v --ignore=tests/test_messengers/
============================== test session starts ==============================
collected 1307 items

... (æ‰€æœ‰æµ‹è¯•) ...

============================== 1307 passed in 43.67s ===============================
```

### æ€§èƒ½å½±å“

- EventBus åŒæ­¥/å¼‚æ­¥æ£€æµ‹ï¼š`inspect.iscoroutine()` å¼€é”€æå°ï¼ˆçº³ç§’çº§ï¼‰
- äº‹ä»¶å‘å¸ƒè·¯å¾„ç»Ÿä¸€åŒ–ï¼šæ€§èƒ½æ— å½±å“
- ç§»é™¤ç›´æ¥è°ƒç”¨ï¼šå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

### æ–°å¢æ¶æ„æ–‡æ¡£

1. **ALLURE_INTEGRATION_OPTIMIZATION_SUMMARY.md**
   - Allure é›†æˆä¼˜åŒ–å®æ–½æ€»ç»“
   - æ–¹æ¡ˆ A å®æ–½è¯¦æƒ…ï¼ˆAllurePlugin DEPRECATEDï¼‰
   - EventBus ä¿®å¤è®°å½•

2. **ALLURE_INTEGRATION_ANALYSIS.md**
   - Allure é›†æˆæ¶æ„åˆ†æ
   - ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”ï¼ˆPlugin vs Fixture vs Hybridï¼‰
   - æ¨èæ–¹æ¡ˆå’Œå®æ–½è·¯å¾„

3. **CAPABILITIES_OPTIMIZATION_PLAN.md**
   - èƒ½åŠ›å±‚ä¼˜åŒ–è®¡åˆ’
   - åŒæ­¥/å¼‚æ­¥æ¨¡å¼åˆ†æ
   - å½“å‰å®ç°å¯¹æ¯”

---

## ğŸ”„ å‡çº§æŒ‡å—

### ä» v3.17.0 å‡çº§åˆ° v3.17.1

**æ— éœ€ä¿®æ”¹ä»£ç **ï¼Œbug ä¿®å¤è‡ªåŠ¨ç”Ÿæ•ˆï¼š

1. æ›´æ–°æ¡†æ¶ç‰ˆæœ¬ï¼š
```bash
uv pip install df-test-framework==3.17.1
```

2. å·²æœ‰æµ‹è¯•ä»£ç æ— éœ€ä¿®æ”¹ï¼š
```python
# v3.17.0 ä»£ç ï¼ˆç»§ç»­å·¥ä½œï¼‰
def test_example(http_client):
    response = http_client.post("/api/users", json={"name": "Alice"})
    assert response.status_code == 201

# v3.17.1 è‡ªåŠ¨ä¿®å¤ï¼š
# âœ… EventBus åŒæ­¥/å¼‚æ­¥å¤„ç†å™¨å…¼å®¹æ€§é—®é¢˜
# âœ… BearerTokenMiddleware è‡ªåŠ¨æ³¨å…¥ http_client
# âœ… æ‰€æœ‰ Allure æŠ¥å‘Šæ­£å¸¸ç”Ÿæˆ
```

### è¿ç§»å»ºè®®

å¦‚æœä½ åœ¨ v3.17.0 ä¸­ä½¿ç”¨äº† AllurePluginï¼š

```python
# æ—§æ–¹å¼ï¼ˆä»ç„¶æœ‰æ•ˆï¼Œä½†å·² DEPRECATEDï¼‰
from df_test_framework.plugins import AllurePlugin

bootstrap = Bootstrap().with_plugin("df_test_framework.plugins.AllurePlugin")

# æ–°æ–¹å¼ï¼ˆæ¨èï¼‰
# 1. ç§»é™¤ AllurePlugin æ³¨å†Œ
# 2. allure fixture ä¼šè‡ªåŠ¨å¯ç”¨ï¼ˆautouse=Trueï¼‰
# 3. æ— éœ€ä»»ä½•é…ç½®
```

---

## âš ï¸ åºŸå¼ƒè­¦å‘Š

### AllurePlugin å·²åºŸå¼ƒ

**åŸå› **ï¼š
- åŠŸèƒ½ä¸ allure fixture å®Œå…¨é‡å¤
- å¢åŠ ä¸å¿…è¦çš„å¤æ‚åº¦
- EventBus é©±åŠ¨æ¨¡å¼å·²ç»è¶³å¤Ÿ

**è¿ç§»è·¯å¾„**ï¼š
1. ç§»é™¤ `Bootstrap().with_plugin("...AllurePlugin")`
2. ä¾èµ– allure fixture çš„è‡ªåŠ¨å¯ç”¨ï¼ˆautouse=Trueï¼‰
3. åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€ä¿®æ”¹æµ‹è¯•ä»£ç 

**æ—¶é—´è¡¨**ï¼š
- v3.17.1: æ ‡è®°ä¸º DEPRECATED
- v3.18.x: ä¿æŒå…¼å®¹
- v3.19.0: å¯èƒ½ç§»é™¤

---

## ğŸ¯ 6. UoW äº‹åŠ¡äº‹ä»¶è¯¦ç»†è¯´æ˜

### 6.1 åŠŸèƒ½æ¦‚è¿°

UnitOfWork çš„äº‹åŠ¡æ“ä½œï¼ˆcommit/rollbackï¼‰ç°åœ¨ä¼šè‡ªåŠ¨å‘å¸ƒäº‹ä»¶å¹¶è®°å½•åˆ° Allure æŠ¥å‘Šä¸­ï¼Œæä¾›å®Œæ•´çš„æµ‹è¯•æ•°æ®ç”Ÿå‘½å‘¨æœŸè¿½è¸ªã€‚

### 6.2 äº‹ä»¶ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/df_test_framework/core/events/types.py`

```python
@dataclass(frozen=True)
class TransactionCommitEvent(Event):
    """äº‹åŠ¡æäº¤äº‹ä»¶"""
    repository_count: int = 0  # æ¶‰åŠçš„ Repository æ•°é‡
    session_id: str | None = None  # Session æ ‡è¯†

@dataclass(frozen=True)
class TransactionRollbackEvent(Event):
    """äº‹åŠ¡å›æ»šäº‹ä»¶"""
    repository_count: int = 0
    reason: str = "auto"  # auto/exception/manual
    session_id: str | None = None
```

### 6.3 Allure æŠ¥å‘Šæ•ˆæœ

**æäº¤äº‹ä»¶**ï¼š
```json
ğŸ’¾ Transaction COMMIT (0 repositories)
{
  "event_id": "evt-ddb87a07758d",
  "repository_count": 0,
  "session_id": "2494606397456"
}
```

**å›æ»šäº‹ä»¶**ï¼š
```json
â†©ï¸ Transaction ROLLBACK (manual, 0 repositories)
{
  "event_id": "evt-9d52f52710f3",
  "repository_count": 0,
  "reason": "manual",
  "session_id": "1844100846672"
}
```

### 6.4 ä¸ Database äº‹ä»¶çš„å…³ç³»

| ç»´åº¦ | Database äº‹ä»¶ | UoW äº‹åŠ¡äº‹ä»¶ |
|-----|--------------|-------------|
| **ç²’åº¦** | ç»†ç²’åº¦ | ç²—ç²’åº¦ |
| **å…³æ³¨ç‚¹** | SQL æ“ä½œ | äº‹åŠ¡è¾¹ç•Œ |
| **äº‹ä»¶ç±»å‹** | QueryStart/End/Error | Commit/Rollback |
| **è®°å½•å†…å®¹** | SQL è¯­å¥ã€å‚æ•°ã€æ‰§è¡Œæ—¶é—´ | Repository æ•°é‡ã€å›æ»šåŸå›  |

å®ƒä»¬æ˜¯**äº’è¡¥çš„**ï¼Œä¸æ˜¯é‡å¤çš„ï¼š
- **Database äº‹ä»¶**ï¼šæ˜¾ç¤ºæ‰§è¡Œäº†å“ªäº› SQLï¼ˆSELECTã€INSERTï¼‰
- **UoW äº‹ä»¶**ï¼šæ˜¾ç¤ºè¿™äº›æ›´æ”¹è¢«æŒä¹…åŒ–äº†ï¼ˆCOMMITï¼‰è¿˜æ˜¯å›æ»šäº†ï¼ˆROLLBACKï¼‰

### 6.5 ä½¿ç”¨ç¤ºä¾‹

```python
@allure.title("éªŒè¯äº‹åŠ¡æäº¤äº‹ä»¶")
def test_transaction_commit(self, uow):
    with step("1. åˆ›å»ºæµ‹è¯•æ•°æ®"):
        uow.execute("INSERT INTO cards ...", {...})

    with step("2. æäº¤äº‹åŠ¡"):
        uow.commit()
        # âœ… Allure æŠ¥å‘Šï¼šğŸ’¾ Transaction COMMIT (0 repositories)

@allure.title("éªŒè¯äº‹åŠ¡å›æ»šäº‹ä»¶")
def test_transaction_rollback(self, uow):
    with step("1. åˆ›å»ºæµ‹è¯•æ•°æ®"):
        uow.execute("INSERT INTO cards ...", {...})

    with step("2. æ‰‹åŠ¨å›æ»š"):
        uow.rollback(reason="manual")
        # âœ… Allure æŠ¥å‘Šï¼šâ†©ï¸ Transaction ROLLBACK (manual, 0 repositories)
```

### 6.6 å…³é”® Bug ä¿®å¤

**é—®é¢˜**ï¼š`uow` fixture åˆ›å»º UnitOfWork æ—¶æ²¡æœ‰ä¼ é€’ `event_bus` å‚æ•°ï¼Œå¯¼è‡´äº‹ä»¶æ°¸è¿œä¸ä¼šè¢«å‘å¸ƒã€‚

**ä¿®å¤**ï¼š`src/df_test_framework/testing/fixtures/core.py`
```python
# v3.17.1: è·å–æµ‹è¯•ä¸“ç”¨çš„ EventBus
from df_test_framework.infrastructure.events import get_event_bus

test_event_bus = get_event_bus()

# åˆ›å»º UnitOfWorkï¼ˆä¼ å…¥ EventBusï¼‰
unit_of_work = UnitOfWork(
    database.session_factory,
    repository_package=repository_package,
    event_bus=test_event_bus,  # â† ä¿®å¤ï¼šä¼ å…¥ EventBus
)
```

---

## ğŸ¯ 7. æœªæ¥ Allure æ’ä»¶è§„åˆ’

### 7.1 future_allure_plugin_plans.md

v3.17.1 æ–°å¢ `docs/architecture/future_allure_plugin_plans.md` æ–‡æ¡£ï¼Œè§„åˆ’æœªæ¥çš„çº¯æ’ä»¶æ¨¡å¼ï¼š

**å½“å‰çŠ¶æ€** (v3.17.1):
- AllurePlugin å·²æ ‡è®°ä¸º DEPRECATED
- æ¨èä½¿ç”¨ `allure` fixtureï¼ˆautouse=Trueï¼‰
- é€šè¿‡ EventBus é©±åŠ¨ Allure æŠ¥å‘Š

**æœªæ¥è§„åˆ’** (v3.19+):
- è®¾è®¡çº¯æ’ä»¶æ¨¡å¼çš„ Allure é›†æˆ
- å®Œå…¨ç§»é™¤ AllurePluginï¼ˆå¯èƒ½åœ¨ v3.19.0ï¼‰
- ä¿æŒ EventBus é©±åŠ¨æ¶æ„ä¸å˜

è¯¦è§ï¼š`docs/architecture/future_allure_plugin_plans.md`

---

## ğŸ¯ åç»­è®¡åˆ’

v3.17.1 å®Œæˆäº†ï¼š
1. èƒ½åŠ›å±‚ Allure é›†æˆæ¶æ„ä¼˜åŒ–
2. EventBus åŒæ­¥/å¼‚æ­¥å…¼å®¹æ€§ä¿®å¤
3. UoW äº‹åŠ¡äº‹ä»¶é›†æˆåˆ° Allure
4. AllurePlugin åºŸå¼ƒå’Œæœªæ¥è§„åˆ’

ä¸‹ä¸€ä¸ªç‰ˆæœ¬è®¡åˆ’ï¼š
1. **v3.18.0**: Storage æ“ä½œäº‹ä»¶ä¼˜åŒ–
2. **v3.19.0**: æ¶ˆæ¯é˜Ÿåˆ—äº‹ä»¶é›†æˆ / AllurePlugin ç§»é™¤
3. **v3.20.0**: åˆ†å¸ƒå¼è¿½è¸ªå®Œæ•´æ”¯æŒ

---

## ğŸ“ åé¦ˆä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- æäº¤ Issue
- æŸ¥çœ‹æ–‡æ¡£
- è”ç³»å¼€å‘å›¢é˜Ÿ

---

**å‘å¸ƒå›¢é˜Ÿ**: DF Test Framework å¼€å‘ç»„
**å‘å¸ƒæ—¥æœŸ**: 2025-12-08
