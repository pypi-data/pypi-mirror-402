# df-test-framework v3.3.0 å‘å¸ƒè¯´æ˜

> **å‘å¸ƒæ—¥æœŸ**: 2025-11-06
> **ç‰ˆæœ¬**: v3.2.0 â†’ v3.3.0
> **ç±»å‹**: é‡å¤§æ¶æ„é‡æ„ï¼ˆBreaking Changesï¼‰
> **çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯

---

## ğŸ“Š ç‰ˆæœ¬æ¦‚è¿°

v3.3.0 å®Œæˆäº†æ‹¦æˆªå™¨æ¶æ„çš„å®Œæ•´é‡æ„ï¼Œæ˜¯ä¸€ä¸ª**ä¸å‘åå…¼å®¹**çš„é‡å¤§ç‰ˆæœ¬ã€‚

**æ ¸å¿ƒå˜æ›´**:
- âœ… **BaseAPIèŒè´£ç®€åŒ–** - ç§»é™¤æ‹¦æˆªå™¨ç®¡ç†ï¼Œä¸“æ³¨APIå°è£…
- âœ… **é€šç”¨æ‹¦æˆªå™¨åè®®** - æ”¯æŒHTTP/DB/Redisç­‰å¤šç§åœºæ™¯
- âœ… **æ ‡å‡†å‘½åè§„èŒƒ** - å»é™¤ä¸šåŠ¡è€¦åˆï¼ˆAdminAuth â†’ BearerTokenï¼‰
- âœ… **é…ç½®åŒ–æ‹¦æˆªå™¨** - é›¶ä»£ç é…ç½®
- âœ… **è·¯å¾„æ¨¡å¼åŒ¹é…** - é€šé…ç¬¦å’Œæ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ

**é‡è¦æç¤º**: âš ï¸ æ­¤ç‰ˆæœ¬ä¸å‘åå…¼å®¹ v3.2 åŠæ›´æ—©ç‰ˆæœ¬ï¼Œè¯·å‚è€ƒ[è¿ç§»æŒ‡å—](#-è¿ç§»æŒ‡å—-v32--v330)ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. BaseAPI èŒè´£ç®€åŒ– â­ æœ€é‡è¦å˜æ›´

**v3.3.0 ä¹‹å‰ (èŒè´£æ··ä¹±)**:
```python
# âŒ æ—§æ–¹å¼: BaseAPI å’Œ HttpClient éƒ½ç®¡ç†æ‹¦æˆªå™¨
class BaseAPI:
    def __init__(self, http_client, request_interceptors=None):
        self.http_client = http_client
        self.request_interceptors = request_interceptors or []  # BaseAPIä¹Ÿç®¡ç†

    def get(self, endpoint, **kwargs):
        kwargs = self._apply_interceptors(kwargs)  # BaseAPIåº”ç”¨æ‹¦æˆªå™¨
        return self.http_client.get(endpoint, **kwargs)
```

**v3.3.0 (å•ä¸€èŒè´£)**:
```python
# âœ… æ–°æ–¹å¼: HttpClient ç»Ÿä¸€ç®¡ç†æ‹¦æˆªå™¨ï¼ŒBaseAPI ä¸“æ³¨ API å°è£…
class BaseAPI:
    def __init__(self, http_client):
        self.http_client = http_client  # åªä¿ç•™ http_client

    def get(self, endpoint, **kwargs):
        # ç›´æ¥è°ƒç”¨ï¼Œæ‹¦æˆªå™¨åœ¨ HttpClient å±‚è‡ªåŠ¨åº”ç”¨
        return self.http_client.get(endpoint, **kwargs)
```

**èŒè´£åˆ’åˆ†**:
- âœ… `HttpClient` - è´Ÿè´£HTTPé€šä¿¡å’Œæ‹¦æˆªå™¨ç®¡ç†
- âœ… `BaseAPI` - è´Ÿè´£APIå°è£…å’Œå“åº”è§£æ
- âŒ ä¸å†æœ‰ä¸¤ä¸ªåœ°æ–¹ç®¡ç†æ‹¦æˆªå™¨

**æ•ˆæœ**:
- ä»£ç é‡å‡å°‘ **40%** (BaseAPI: 524è¡Œ â†’ 312è¡Œ)
- æ¶æ„æ›´æ¸…æ™°ï¼ŒèŒè´£å•ä¸€

---

### 2. é€šç”¨æ‹¦æˆªå™¨åè®®

é‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒå¤šç§åœºæ™¯ï¼š

**Layer 0: é€šç”¨åè®®** (`common/protocols/`):
```python
from typing import TypeVar, Generic

T = TypeVar('T')

class Interceptor(ABC, Generic[T]):
    """é€šç”¨æ‹¦æˆªå™¨åè®®

    å¯ç”¨äº:
    - Interceptor[Request] - HTTPæ‹¦æˆªå™¨
    - Interceptor[DBQuery] - æ•°æ®åº“æ‹¦æˆªå™¨
    - Interceptor[RedisCommand] - Redisæ‹¦æˆªå™¨
    """
    name: str
    priority: int

    def before(self, context: T) -> Optional[T]: ...
    def after(self, context: T) -> Optional[T]: ...
    def on_error(self, error: Exception, context: T) -> None: ...
```

**Layer 1: HTTPæ ¸å¿ƒ** (`clients/http/core/`):
- `Request` - ä¸å¯å˜è¯·æ±‚å¯¹è±¡ (`@dataclass(frozen=True)`)
- `Response` - ä¸å¯å˜å“åº”å¯¹è±¡
- `BaseInterceptor` - HTTPä¸“å±åŸºç±»
- `InterceptorChain` - æ‹¦æˆªå™¨æ‰§è¡Œé“¾

**Layer 2: HTTPæ‹¦æˆªå™¨** (`clients/http/interceptors/`):
- `SignatureInterceptor` - ç­¾åæ‹¦æˆªå™¨ (MD5/SHA256/HMAC)
- `BearerTokenInterceptor` - Bearer Tokenè®¤è¯
- `LoggingInterceptor` - æ—¥å¿—æ‹¦æˆªå™¨
- `InterceptorFactory` - æ‹¦æˆªå™¨å·¥å‚

---

### 3. æ ‡å‡†å‘½åè§„èŒƒ (å»é™¤ä¸šåŠ¡è€¦åˆ)

| v3.2 åŠä¹‹å‰ | v3.3.0 | è¯´æ˜ |
|-----------|--------|------|
| `AdminAuthInterceptor` | `BearerTokenInterceptor` | å»é™¤ä¸šåŠ¡è€¦åˆ |
| `AdminAuthInterceptorConfig` | `BearerTokenInterceptorConfig` | æ ‡å‡†é…ç½®ç±» |
| `"admin_auth"` | `"bearer_token"` | æ¡†æ¶æ ‡å‡†ç±»å‹ |
| `username`/`password` å­—æ®µ | `login_credentials` å­—å…¸ | æ›´é€šç”¨çš„å­—æ®µ |

**ç¤ºä¾‹**:
```python
# Before (v3.2)
AdminAuthInterceptorConfig(
    type="admin_auth",
    username="admin",
    password="admin123",
    login_url="/admin/login"
)

# After (v3.3.0)
BearerTokenInterceptorConfig(
    type="bearer_token",
    token_source="login",
    login_credentials={"username": "admin", "password": "admin123"},
    login_url="/admin/login"
)
```

---

### 4. é…ç½®åŒ–æ‹¦æˆªå™¨ (é›¶ä»£ç é…ç½®)

é€šè¿‡é…ç½®æ–‡ä»¶å®Œæˆæ‰€æœ‰æ‹¦æˆªå™¨è®¾ç½®ï¼Œæ— éœ€ç¼–å†™ä»£ç ï¼š

```python
# settings.py
from df_test_framework import FrameworkSettings, HTTPConfig
from df_test_framework.infrastructure.config.schema import (
    SignatureInterceptorConfig,
    BearerTokenInterceptorConfig,
)

settings = FrameworkSettings(
    http=HTTPConfig(
        base_url="http://api.example.com",
        interceptors=[
            # ç­¾åæ‹¦æˆªå™¨
            SignatureInterceptorConfig(
                type="signature",
                algorithm="md5",
                secret="my_secret",
                include_paths=["/api/**"],
                exclude_paths=["/api/health"]
            ),
            # Bearer Token æ‹¦æˆªå™¨
            BearerTokenInterceptorConfig(
                type="bearer_token",
                token_source="login",
                login_url="/admin/login",
                login_credentials={"username": "admin", "password": "admin123"},
                include_paths=["/admin/**"]
            )
        ]
    )
)

# ä½¿ç”¨æ—¶è‡ªåŠ¨åŠ è½½
http_client = HttpClient(base_url=settings.http.base_url, config=settings.http)
api = MyAPI(http_client)  # BaseAPI ä¸å†éœ€è¦æ‹¦æˆªå™¨å‚æ•°
```

---

### 5. è·¯å¾„åŒ¹é…åŠŸèƒ½

æ”¯æŒç²¾ç»†çš„è·¯å¾„æ§åˆ¶ï¼š

```python
SignatureInterceptorConfig(
    include_paths=[
        "/api/**",        # å¤šçº§è·¯å¾„é€šé…ç¬¦
        "/v*/health",     # å•çº§è·¯å¾„é€šé…ç¬¦
        "/exact/path",    # ç²¾ç¡®åŒ¹é…
    ],
    exclude_paths=[
        "/health",        # æ’é™¤å¥åº·æ£€æŸ¥
        "/actuator/**",   # æ’é™¤ç›‘æ§ç«¯ç‚¹
    ],
)
```

**åŒ¹é…è§„åˆ™**:
- `**` - åŒ¹é…å¤šçº§è·¯å¾„ (`/api/**` åŒ¹é… `/api/users/123`)
- `*` - åŒ¹é…å•çº§è·¯å¾„ (`/v*/users` åŒ¹é… `/v1/users`)
- ç²¾ç¡®åŒ¹é… - `/api/login`
- æ­£åˆ™è¡¨è¾¾å¼ - `^/api/v[0-9]+/.*$` (éœ€è®¾ç½® `use_regex=True`)

---

## ğŸ“¦ ç›®å½•ç»“æ„é‡æ„

```
clients/http/
â”œâ”€â”€ core/              # Layer 1: HTTPæ ¸å¿ƒæŠ½è±¡
â”‚   â”œâ”€â”€ request.py         # ä¸å¯å˜Requestå¯¹è±¡
â”‚   â”œâ”€â”€ response.py        # ä¸å¯å˜Responseå¯¹è±¡
â”‚   â”œâ”€â”€ interceptor.py     # BaseInterceptoråŸºç±»
â”‚   â””â”€â”€ chain.py           # InterceptorChainæ‰§è¡Œé“¾
â”œâ”€â”€ interceptors/      # Layer 2: HTTPæ‹¦æˆªå™¨å®ç°
â”‚   â”œâ”€â”€ factory.py         # æ‹¦æˆªå™¨å·¥å‚
â”‚   â”œâ”€â”€ signature/         # ç­¾åæ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ‹¦æˆªå™¨ (bearer_token)
â”‚   â””â”€â”€ logging.py         # æ—¥å¿—æ‹¦æˆªå™¨
â””â”€â”€ rest/              # RESTé£æ ¼HTTPå®¢æˆ·ç«¯
    â”œâ”€â”€ httpx/
    â”‚   â”œâ”€â”€ client.py      # HttpClient (æ‹¦æˆªå™¨åœ¨æ­¤ç®¡ç†)
    â”‚   â””â”€â”€ base_api.py    # BaseAPI (v3.3.0ç®€åŒ–)

common/protocols/      # Layer 0: é€šç”¨åè®®
â”œâ”€â”€ interceptor.py         # æ³›å‹Interceptor[T]åè®®
â””â”€â”€ chain.py              # æ³›å‹InterceptorChain[T]
```

---

## ğŸ—‘ï¸ Breaking Changes (å·²åˆ é™¤çš„åŠŸèƒ½)

### BaseAPI æ‹¦æˆªå™¨åŠŸèƒ½
- âŒ `BaseAPI(http_client, request_interceptors, response_interceptors)` - ä¸å†æ”¯æŒæ‹¦æˆªå™¨å‚æ•°
- âŒ `BaseAPI.request_interceptors` å±æ€§
- âŒ `BaseAPI.response_interceptors` å±æ€§
- âŒ `BaseAPI._apply_request_interceptors()` æ–¹æ³•
- âŒ `BaseAPI._apply_response_interceptors()` æ–¹æ³•
- âŒ `BaseAPI.add_request_interceptor()` æ–¹æ³•
- âŒ `BaseAPI.add_response_interceptor()` æ–¹æ³•
- âŒ `RequestInterceptor` Protocol
- âŒ `ResponseInterceptor` Protocol
- âŒ BaseAPI ä¸­çš„ `AuthTokenInterceptor` ç±» (ä½¿ç”¨ `BearerTokenInterceptor` æ›¿ä»£)
- âŒ BaseAPI ä¸­çš„ `LoggingInterceptor` ç±» (ä½¿ç”¨æ–°çš„ `LoggingInterceptor` æ›¿ä»£)

### æ—§é…ç½®ç±»
- âŒ `AdminAuthInterceptorConfig` - ä½¿ç”¨ `BearerTokenInterceptorConfig` æ›¿ä»£
- âŒ `type="admin_auth"` - ä½¿ç”¨ `type="bearer_token"` æ›¿ä»£
- âŒ `username`/`password` å­—æ®µ - ä½¿ç”¨ `login_credentials` æ›¿ä»£

---

## ğŸ”„ è¿ç§»æŒ‡å— (v3.2 â†’ v3.3.0)

### 1. BaseAPI æ‹¦æˆªå™¨é…ç½®

**Before (v3.2)**:
```python
# âŒ æ—§æ–¹å¼ - åœ¨ BaseAPI å±‚é…ç½®æ‹¦æˆªå™¨
from df_test_framework.clients.http.auth.signature import SignatureInterceptor

client = HttpClient(base_url="...")
signature_interceptor = SignatureInterceptor(algorithm="md5", secret="xxx")
api = MyAPI(client, request_interceptors=[signature_interceptor])
```

**After (v3.3.0)**:
```python
# âœ… æ–¹å¼1: é…ç½®æ–‡ä»¶ (æ¨è)
settings = FrameworkSettings(
    http=HTTPConfig(
        interceptors=[
            SignatureInterceptorConfig(
                type="signature",
                algorithm="md5",
                secret="xxx"
            )
        ]
    )
)
client = HttpClient(base_url="...", config=settings.http)
api = MyAPI(client)  # ä¸å†éœ€è¦æ‹¦æˆªå™¨å‚æ•°

# âœ… æ–¹å¼2: ç¼–ç¨‹å¼æ·»åŠ 
from df_test_framework.clients.http.interceptors import SignatureInterceptor

client = HttpClient(base_url="...")
client.use(SignatureInterceptor(algorithm="md5", secret="xxx"))
api = MyAPI(client)
```

### 2. é…ç½®ç±»é‡å‘½å

**Before (v3.2)**:
```python
from df_test_framework.infrastructure.config.schema import AdminAuthInterceptorConfig

interceptors=[
    AdminAuthInterceptorConfig(
        type="admin_auth",
        username="admin",
        password="admin123",
        login_url="/admin/login"
    )
]
```

**After (v3.3.0)**:
```python
from df_test_framework.infrastructure.config.schema import BearerTokenInterceptorConfig

interceptors=[
    BearerTokenInterceptorConfig(
        type="bearer_token",
        token_source="login",
        login_credentials={"username": "admin", "password": "admin123"},
        login_url="/admin/login"
    )
]
```

### 3. å¯¼å…¥è·¯å¾„å˜æ›´

**Before (v3.2)**:
```python
# âŒ æ—§è·¯å¾„
from df_test_framework.clients.http.auth.signature import SignatureInterceptor
from df_test_framework.clients.http.auth.token import AdminAuthInterceptor
```

**After (v3.3.0)**:
```python
# âœ… æ–°è·¯å¾„
from df_test_framework.clients.http.interceptors import (
    SignatureInterceptor,
    BearerTokenInterceptor,  # æ³¨æ„é‡å‘½å
    LoggingInterceptor,
    InterceptorFactory,
)
```

---

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

### è´¨é‡ä¿è¯
- âœ… **358/358 æµ‹è¯•å…¨éƒ¨é€šè¿‡** (100%)
- âœ… **ä»£ç é‡å‡å°‘ 40%** (BaseAPI: 524è¡Œ â†’ 312è¡Œ)
- âœ… **èŒè´£æ›´æ¸…æ™°** - BaseAPI ä¸“æ³¨ API å°è£…ï¼ŒHttpClient ç®¡ç†æ‹¦æˆªå™¨
- âœ… **æ¶æ„æ›´ç»Ÿä¸€** - æ‰€æœ‰æ‹¦æˆªå™¨åœ¨ HttpClient å±‚ç»Ÿä¸€æ‰§è¡Œ
- âœ… **ä»£ç ä¸æ–‡æ¡£ 100% ä¸€è‡´** - å®Œæ•´æ¶æ„å®¡è®¡

### æ¶æ„å¯¹æ¯”

| ç‰¹æ€§ | v3.2 | v3.3.0 |
|------|------|--------|
| ç›®å½•ç»“æ„ | `auth/` | `interceptors/` âœ… |
| é€šç”¨åè®® | âŒ æ—  | `common/protocols/` âœ… |
| ä¸å¯å˜å¯¹è±¡ | âŒ æ—  | Request/Response âœ… |
| æ‹¦æˆªå™¨é“¾ | HTTP ä¸“å± | é€šç”¨æ³›å‹ âœ… |
| è·¯å¾„åŒ¹é… | âŒ æ—  | é€šé…ç¬¦/æ­£åˆ™ âœ… |
| å‘½åæ ‡å‡† | ä¸šåŠ¡è€¦åˆ | æ¡†æ¶æ ‡å‡† âœ… |
| BaseAPI èŒè´£ | ç®¡ç†æ‹¦æˆªå™¨ | åªè´Ÿè´£ API å°è£… âœ… |
| æ‹¦æˆªå™¨ç®¡ç† | BaseAPI + HttpClient | ç»Ÿä¸€ HttpClient âœ… |
| BaseAPI ä»£ç é‡ | 524 è¡Œ | 312 è¡Œ (-40%) âœ… |

---

## ğŸ“ è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£** - HttpClient ç®¡ç†æ‹¦æˆªå™¨ï¼ŒBaseAPI ä¸“æ³¨ API å°è£…
2. **é€šç”¨å¯å¤ç”¨** - æ³›å‹åè®®æ”¯æŒ HTTP/DB/Redis ç­‰å¤šç§åœºæ™¯
3. **ä¸å¯å˜å¯¹è±¡** - Request/Response ä½¿ç”¨ `frozen=True` å¼ºåˆ¶ä¸å¯å˜
4. **æ´‹è‘±æ¨¡å‹** - before æ­£åºæ‰§è¡Œï¼Œafter é€†åºæ‰§è¡Œ
5. **æ ‡å‡†å‘½å** - å»é™¤ä¸šåŠ¡è€¦åˆï¼Œä½¿ç”¨æ¡†æ¶æ ‡å‡†æœ¯è¯­
6. **é›¶å…¼å®¹ä»£ç ** - ä¸ä¿ç•™å‘åå…¼å®¹ï¼Œä¿æŒä»£ç åº“æ•´æ´

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æ–°å¢æ–‡æ¡£
- `docs/INTERCEPTOR_ARCHITECTURE.md` - æ‹¦æˆªå™¨æ¶æ„è®¾è®¡ä¸å®æ–½ (v3.3.0)
- `docs/INTERCEPTOR_ARCHITECTURE_VERIFICATION.md` - æ¶æ„éªŒè¯æŠ¥å‘Š
- `docs/INTERCEPTOR_IDEAL_VS_ACTUAL.md` - ç†æƒ³è®¾è®¡ vs å®é™…å®ç°å¯¹æ¯”
- `docs/REFACTORING_COMPLETION_CHECK.md` - é‡æ„å®Œæˆåº¦æ ¸å¯¹

### æ›´æ–°æ–‡æ¡£
- `CHANGELOG.md` - v3.3.0 å®Œæ•´å˜æ›´æ—¥å¿—
- `README.md` - v3.3.0 æ¶æ„è¯´æ˜
- ç”¨æˆ·æŒ‡å—å’Œ API å‚è€ƒ - æ›´æ–°ç¤ºä¾‹ä»£ç å’Œå¯¼å…¥è·¯å¾„

---

## ğŸ¯ æ ¸å¿ƒäº®ç‚¹æ€»ç»“

1. **BaseAPI èŒè´£ç®€åŒ–** - ç§»é™¤æ‹¦æˆªå™¨ç®¡ç†ï¼Œä»£ç é‡å‡å°‘ 40%
2. **é€šç”¨æ‹¦æˆªå™¨åè®®** - æ³›å‹è®¾è®¡æ”¯æŒå¤šç§åœºæ™¯æ‰©å±•
3. **æ ‡å‡†å‘½åè§„èŒƒ** - AdminAuth â†’ BearerTokenï¼Œå»é™¤ä¸šåŠ¡è€¦åˆ
4. **é…ç½®åŒ–æ‹¦æˆªå™¨** - é›¶ä»£ç é…ç½®ï¼Œæå‡å¼€å‘ä½“éªŒ
5. **è·¯å¾„æ¨¡å¼åŒ¹é…** - é€šé…ç¬¦å’Œæ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ
6. **ä¸å¯å˜å¯¹è±¡** - Request/Response å¼ºåˆ¶ä¸å¯å˜ï¼Œæ›´å®‰å…¨
7. **æ´‹è‘±æ¨¡å‹** - æ ‡å‡†çš„æ‹¦æˆªå™¨æ‰§è¡Œæ¨¡å‹

---

**å®Œæ•´å˜æ›´æ—¥å¿—**: [CHANGELOG.md](../../CHANGELOG.md#330---2025-11-06)
