# v3.36.1 发布说明 - 统一管理器重构插件系统

**发布日期**: 2025-12-21

## 概述

v3.36.1 引入了统一的管理器架构来重构 pytest 插件系统。新增 4 个管理器类来处理插件加载顺序、配置缓存、运行时上下文和 EventBus 测试隔离。

> **注意**: 此版本的管理器架构已在 v3.37.0 中被移除，改用更简洁的 `config` 对象属性方式。如果您正在升级，建议直接升级到 v3.37.0。

## 核心特性

### 1. 统一管理器架构

新增 `managers.py` 模块，包含 4 个管理器类：

```python
from df_test_framework.testing.plugins.managers import (
    PluginLoadOrder,        # 插件加载顺序验证
    CacheManager,           # 配置缓存一致性管理
    RuntimeContextManager,  # RuntimeContext 生命周期管理
    TestEventBusManager,    # EventBus 测试隔离
)
```

### 2. PluginLoadOrder - 插件加载顺序验证

确保插件按正确顺序加载：

```python
class PluginLoadOrder:
    _load_order: list[str] = []

    @classmethod
    def check_order(cls, plugin_name: str) -> None:
        """记录插件加载顺序"""
        cls._load_order.append(plugin_name)
```

### 3. CacheManager - 配置缓存一致性

统一管理配置缓存的清除：

```python
class CacheManager:
    _cleared: bool = False

    @classmethod
    def maybe_clear(cls) -> bool:
        """确保每个 session 只清除一次缓存"""
        if not cls._cleared:
            clear_settings_cache()
            cls._cleared = True
            return True
        return False
```

### 4. RuntimeContextManager - 运行时上下文管理

管理 RuntimeContext 的生命周期：

```python
class RuntimeContextManager:
    _instance: RuntimeContext | None = None

    @classmethod
    def set(cls, runtime: RuntimeContext) -> None:
        cls._instance = runtime

    @classmethod
    def get(cls) -> RuntimeContext:
        if cls._instance is None:
            raise RuntimeError("RuntimeContext 未初始化")
        return cls._instance
```

### 5. TestEventBusManager - EventBus 测试隔离

为每个测试提供独立的 EventBus：

```python
class TestEventBusManager:
    _buses: dict[str, EventBus] = {}

    @classmethod
    def get_or_create(cls, test_id: str) -> EventBus:
        if test_id not in cls._buses:
            cls._buses[test_id] = EventBus()
        return cls._buses[test_id]
```

## 重构内容

### env_plugin 重构

- 使用 `CacheManager.maybe_clear()` 统一缓存清除
- 添加 `PluginLoadOrder.check_order()` 记录加载顺序
- 新增 `pytest_unconfigure` 重置缓存状态

### core.py 重构

- 使用 `RuntimeContextManager` 替代全局变量
- 添加插件加载顺序验证
- `uow`/`prepare_data`/`data_preparer` 使用隔离 EventBus

## 文件变更

### 新增
- `src/df_test_framework/testing/plugins/managers.py` - 统一管理器模块

### 修改
- `env_plugin.py` - 使用 CacheManager
- `core.py` - 使用 RuntimeContextManager 和 TestEventBusManager

## 后续版本说明

v3.37.0 移除了 managers.py，改用 pytest 官方推荐的 `config` 对象属性方式管理状态。如果您正在升级，建议直接升级到 v3.37.0 以获得更简洁的架构。
