# v3.34.1 发布说明

**发布日期**: 2025-12-17

## 概述

v3.34.1 版本修复了 v3.14.0 以来 MQ（消息队列）事件系统的架构缺陷，将 MQ 事件重构为 Start/End/Error 三态模式，与 HTTP/gRPC/GraphQL 客户端的事件架构保持一致。

### 核心改进

1. **事件架构统一** - MQ 事件与 HTTP/gRPC/GraphQL 使用相同的 Start/End/Error 三态模式
2. **完整追踪能力** - 所有 MQ 事件继承 `CorrelatedEvent`，支持 `correlation_id` 关联
3. **OpenTelemetry 集成** - 工厂方法自动注入 `trace_id` 和 `span_id`
4. **messenger_type 字段** - 区分 kafka/rabbitmq/rocketmq 三种消息队列类型
5. **耗时记录** - 发布和消费操作都记录精确的耗时信息

## 问题背景

### 发现的问题

分析 v3.14.0 的 MQ 事件实现时发现严重架构问题：

1. **字段未填充**: 事件定义了 `message_id`、`body_size` 等字段，但 MQ 客户端从未正确填充
2. **参数不匹配**: MQ 客户端传递的参数（`queue_type`、`message`）与事件定义不一致
3. **缺少三态模式**: HTTP/gRPC/GraphQL 使用 Start/End/Error 三态，MQ 只有单一事件
4. **无关联追踪**: MQ 事件继承 `Event` 而非 `CorrelatedEvent`，无法关联同一操作

## 重大变更

### ⚠️ 破坏性变更

删除了旧的 MQ 事件类型，替换为新的 Start/End/Error 事件：

```python
# 旧的事件类型 (< v3.34.1) - 已删除
from df_test_framework.core.events import (
    MessagePublishEvent,  # ❌ 已删除
    MessageConsumeEvent,  # ❌ 已删除
)

# 新的事件类型 (v3.34.1+)
from df_test_framework.core.events import (
    # 发布事件
    MessagePublishStartEvent,
    MessagePublishEndEvent,
    MessagePublishErrorEvent,
    # 消费事件
    MessageConsumeStartEvent,
    MessageConsumeEndEvent,
    MessageConsumeErrorEvent,
)
```

### 迁移指南

如果你的代码订阅了旧的 MQ 事件，需要更新为新的事件类型：

```python
# 旧代码
@bus.on(MessagePublishEvent)
async def on_publish(event):
    print(f"Published to {event.topic}")

# 新代码
@bus.on(MessagePublishEndEvent)
async def on_publish_success(event):
    print(f"[{event.messenger_type}] Published to {event.topic}")
    print(f"Duration: {event.duration:.3f}s")

@bus.on(MessagePublishErrorEvent)
async def on_publish_error(event):
    print(f"Failed: {event.error_type}: {event.error_message}")
```

## 新增功能

### 1. MQ 发布事件

```python
from df_test_framework.core.events import (
    MessagePublishStartEvent,
    MessagePublishEndEvent,
    MessagePublishErrorEvent,
)

# 订阅发布成功事件
@bus.on(MessagePublishEndEvent)
async def on_publish_success(event):
    print(f"Type: {event.messenger_type}")  # kafka/rabbitmq/rocketmq
    print(f"Topic: {event.topic}")
    print(f"Message ID: {event.message_id}")
    print(f"Partition: {event.partition}")
    print(f"Offset: {event.offset}")
    print(f"Duration: {event.duration:.3f}s")
    print(f"Correlation ID: {event.correlation_id}")
    print(f"Trace ID: {event.trace_id}")

# 订阅发布错误事件
@bus.on(MessagePublishErrorEvent)
async def on_publish_error(event):
    print(f"Failed to publish to {event.topic}")
    print(f"Error: {event.error_type}: {event.error_message}")
    print(f"Duration: {event.duration:.3f}s")
```

### 2. MQ 消费事件

```python
from df_test_framework.core.events import (
    MessageConsumeStartEvent,
    MessageConsumeEndEvent,
    MessageConsumeErrorEvent,
)

# 订阅消费成功事件
@bus.on(MessageConsumeEndEvent)
async def on_consume_success(event):
    print(f"Type: {event.messenger_type}")
    print(f"Topic: {event.topic}")
    print(f"Consumer Group: {event.consumer_group}")
    print(f"Message ID: {event.message_id}")
    print(f"Partition: {event.partition}")
    print(f"Offset: {event.offset}")
    print(f"Processing Time: {event.processing_time:.3f}s")

# 订阅消费错误事件
@bus.on(MessageConsumeErrorEvent)
async def on_consume_error(event):
    print(f"Failed to consume from {event.topic}")
    print(f"Error: {event.error_type}: {event.error_message}")
```

### 3. 事件字段详解

**MessagePublishStartEvent / MessagePublishEndEvent**:

| 字段 | 类型 | 描述 |
|------|------|------|
| `messenger_type` | str | 消息队列类型：kafka/rabbitmq/rocketmq |
| `topic` | str | 主题/队列名 |
| `message_id` | str | 消息 ID |
| `key` | str | 消息键（Kafka） |
| `partition` | int | 分区号 |
| `offset` | int | 消息偏移量（EndEvent） |
| `body_size` | int | 消息体大小（StartEvent） |
| `headers` | dict | 消息头（StartEvent） |
| `duration` | float | 发布耗时（秒，EndEvent） |
| `correlation_id` | str | 关联 ID |
| `trace_id` | str | OpenTelemetry Trace ID |
| `span_id` | str | OpenTelemetry Span ID |

**MessageConsumeStartEvent / MessageConsumeEndEvent**:

| 字段 | 类型 | 描述 |
|------|------|------|
| `messenger_type` | str | 消息队列类型 |
| `topic` | str | 主题/队列名 |
| `consumer_group` | str | 消费者组 |
| `message_id` | str | 消息 ID |
| `partition` | int | 分区号 |
| `offset` | int | 消息偏移量 |
| `body_size` | int | 消息体大小（StartEvent） |
| `processing_time` | float | 处理耗时（秒，EndEvent） |
| `correlation_id` | str | 关联 ID |
| `trace_id` | str | OpenTelemetry Trace ID |

## 影响的文件

### 核心文件

- `core/events/types.py` - 事件类型定义
- `core/events/__init__.py` - 事件导出

### MQ 客户端

- `capabilities/messengers/queue/kafka/client.py`
- `capabilities/messengers/queue/rabbitmq/client.py`
- `capabilities/messengers/queue/rocketmq/client.py`

### 观察者

- `testing/reporting/allure/observer.py`
- `plugins/builtin/reporting/allure_plugin.py`
- `testing/debugging/console.py`

### Fixture

- `testing/fixtures/allure.py`

## 控制台调试输出示例

更新后的 ConsoleDebugObserver 输出：

```
────────────────────────────────────────────────────────────────
📤 KAFKA Publish: order-events
  id=msg-123456789012..., partition=0, offset=42
  ✅ published (15.23ms)
────────────────────────────────────────────────────────────────

────────────────────────────────────────────────────────────────
📥 RABBITMQ Consume: payment-queue
  group=payment-service, id=msg-987654321012...
  ✅ consumed (8.45ms)
────────────────────────────────────────────────────────────────
```

## 测试

所有测试通过：

```
=============== 1478 passed, 40 skipped, 34 warnings in 21.17s ================
```

## 升级建议

1. **检查代码**：搜索 `MessagePublishEvent` 和 `MessageConsumeEvent` 的使用
2. **更新导入**：改为新的 Start/End/Error 事件类型
3. **更新处理器**：根据需要订阅成功事件和/或错误事件
4. **利用新字段**：使用 `messenger_type`、`duration` 等新字段

## 相关文档

- [EventBus 使用指南](../guides/event_bus_guide.md) - 已更新 MQ 事件示例
- [可观测性架构](../architecture/observability-architecture.md) - 已更新事件类型表
- [ROADMAP](../architecture/ROADMAP_V3.29_ENHANCEMENTS.md) - v3.34.1 实施记录
