# v3.35.5 发布说明 - 恢复深度合并和 _extends 继承

**发布日期**: 2025-12-19

## 概述

v3.35.5 恢复了 v3.35.3 的深度合并功能和 `_extends` 继承语法，解决了 v3.35.4 中 YAML 对象级别替换导致的配置丢失问题。

## 问题回顾

v3.35.4 使用 pydantic-settings 内置的 `YamlConfigSettingsSource`，YAML 文件之间是**对象级别替换**：

```yaml
# base.yaml
db:
  port: 3306
  pool_size: 10

# environments/test.yaml - v3.35.4 问题
db:
  host: "test-db.example.com"
  # ❌ port 和 pool_size 丢失！
```

## v3.35.5 解决方案

恢复 `LayeredYamlSettingsSource`，实现 YAML 文件之间的**深度合并**：

```yaml
# environments/test.yaml - v3.35.5 深度合并
db:
  host: "test-db.example.com"
  # ✅ port=3306, pool_size=10 从 base.yaml 继承
```

## 核心特性

### 1. 深度合并

环境配置只需写覆盖字段，其他字段自动从 base.yaml 继承：

```yaml
# base.yaml
http:
  timeout: 30
  max_retries: 3
db:
  port: 3306
  pool_size: 10
  charset: utf8mb4

# environments/staging.yaml - 只写差异
http:
  base_url: "https://staging-api.example.com"
db:
  host: "staging-db.example.com"
  name: "staging_db"
  user: "staging_user"
# ✅ http.timeout=30, db.port=3306 等自动继承
```

### 2. _extends 继承语法

支持环境之间的继承，避免重复配置：

```yaml
# environments/dev.yaml
env: dev
http:
  base_url: "http://dev-api.example.com"
db:
  host: "dev-db.example.com"
  name: "dev_db"

# environments/staging.yaml - 继承 dev
_extends: environments/dev.yaml
env: staging
http:
  base_url: "https://staging-api.example.com"
# ✅ db 配置完全继承自 dev.yaml

# environments/local.yaml - 继承 dev，启用调试
_extends: environments/dev.yaml
env: local
debug: true
observability:
  debug_output: true
```

### 3. 多级继承链

支持任意深度的继承链：

```
base.yaml → dev.yaml → staging.yaml → prod.yaml
```

每级只需写与上一级的差异配置。

### 4. 循环继承检测

自动检测并警告循环继承：

```yaml
# a.yaml
_extends: b.yaml

# b.yaml
_extends: a.yaml  # ⚠️ 检测到循环继承，跳过
```

## 配置优先级

```
1. 环境变量（最高）
2. config/secrets/.env.local
3. config/environments/{env}.yaml（支持 _extends 继承链）
4. config/base.yaml
5. 代码默认值（最低）
```

## API

### load_config()

```python
from df_test_framework.infrastructure.config import load_config

# 加载 staging 环境
settings = load_config("staging", "config")

# 使用自定义配置类
settings = load_config("staging", "config", settings_class=MySettings)
```

### ConfigLoader

```python
from df_test_framework.infrastructure.config import ConfigLoader

loader = ConfigLoader(config_dir="config")
settings = loader.load("staging")
```

### LayeredYamlSettingsSource

```python
from df_test_framework.infrastructure.config import LayeredYamlSettingsSource

# 直接使用配置源（高级用法）
source = LayeredYamlSettingsSource(
    settings_cls=MySettings,
    config_dir=Path("config"),
    env="staging"
)
config_dict = source()
```

## 代码统计

| 指标 | v3.35.4 | v3.35.5 |
|-----|---------|---------|
| loader.py 行数 | ~97 行 | ~280 行 |
| 深度合并 | ❌ 对象替换 | ✅ 深度合并 |
| _extends 支持 | ❌ | ✅ |
| 多级继承 | ❌ | ✅ |
| 循环检测 | ❌ | ✅ |

## 修改文件

| 文件 | 说明 |
|-----|------|
| `infrastructure/config/loader.py` | 恢复 LayeredYamlSettingsSource |
| `infrastructure/config/__init__.py` | 导出 ConfigLoader, LayeredYamlSettingsSource |
| `pyproject.toml` | 版本 3.35.5 |

## 升级指南

### 从 v3.35.4 升级

1. 简化环境配置文件，移除重复字段
2. 可选：使用 `_extends` 实现环境间继承

```yaml
# 旧方式（v3.35.4）- 需要写所有字段
db:
  host: "test-db.example.com"
  port: 3306
  name: "test_db"
  user: "test_user"
  pool_size: 10
  charset: utf8mb4

# 新方式（v3.35.5）- 只写差异字段
db:
  host: "test-db.example.com"
  name: "test_db"
  user: "test_user"
```

### 从 v3.35.3 升级

无需修改，v3.35.5 与 v3.35.3 完全兼容。

## 测试结果

```
14 passed (test_loader.py)
62 passed (全部配置测试)
```
