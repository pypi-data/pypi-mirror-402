# DF Test Framework v3.11.1 Release Notes

å‘å¸ƒæ—¥æœŸ: 2025-11-28

---

## ğŸ‰ ç‰ˆæœ¬æ¦‚è¿°

### ğŸ§¹ æµ‹è¯•æ•°æ®æ¸…ç†æ¨¡å—é‡æ„ - ç»Ÿä¸€çš„æ¸…ç†æœºåˆ¶

v3.11.1 æ˜¯ä¸€ä¸ªé‡è¦çš„**æµ‹è¯•æ”¯æŒå¢å¼ºç‰ˆæœ¬**ï¼Œæä¾›ç»Ÿä¸€çš„æµ‹è¯•æ•°æ®æ¸…ç†æœºåˆ¶ï¼Œæ”¯æŒå¤šç§é…ç½®æ§åˆ¶æ–¹å¼ã€‚

#### æ ¸å¿ƒæ”¹è¿›

- âœ… **ç»Ÿä¸€é…ç½®æ£€æŸ¥**: `should_keep_test_data()` å‡½æ•°ï¼Œæ”¯æŒä¼˜å…ˆçº§ï¼šæ ‡è®° > CLIå‚æ•° > ç¯å¢ƒå˜é‡
- âœ… **æ¸…ç†ç®¡ç†å™¨**: `CleanupManager` æŠ½è±¡åŸºç±»ï¼Œè‡ªåŠ¨æ£€æŸ¥é…ç½®
- âœ… **å›è°ƒæ¨¡å¼**: `SimpleCleanupManager` æ”¯æŒæ³¨å†Œå›è°ƒå‡½æ•°
- âœ… **åˆ—è¡¨æ¨¡å¼**: `ListCleanup` ç»§æ‰¿ listï¼Œç®€å•åœºæ™¯ä½¿ç”¨
- âœ… **æ— éœ€å®ä¾‹åŒ–**: `DataGenerator.test_id()` ç±»æ–¹æ³•ï¼Œç›´æ¥ç”Ÿæˆæµ‹è¯•æ ‡è¯†ç¬¦

---

## âœ¨ åŠŸèƒ½è¯¦è§£

### 1. should_keep_test_data() - ç»Ÿä¸€é…ç½®æ£€æŸ¥

æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¿ç•™æµ‹è¯•æ•°æ®ï¼Œæ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼š

```python
from df_test_framework import should_keep_test_data

@pytest.fixture
def cleanup_orders(request, database):
    order_nos = []
    yield order_nos

    # æ ¹æ®é…ç½®å†³å®šæ˜¯å¦æ¸…ç†
    if not should_keep_test_data(request):
        for order_no in order_nos:
            database.execute(f"DELETE FROM orders WHERE order_no = '{order_no}'")
```

**é…ç½®ä¼˜å…ˆçº§**ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

| ä¼˜å…ˆçº§ | æ–¹å¼ | ç¤ºä¾‹ |
|-------|------|------|
| 1 | `@pytest.mark.keep_data` | æµ‹è¯•æ ‡è®° |
| 2 | `--keep-test-data` | CLI å‚æ•° |
| 3 | `KEEP_TEST_DATA=1` | ç¯å¢ƒå˜é‡ |

### 2. CleanupManager - æ¸…ç†ç®¡ç†å™¨åŸºç±»

é€‚åˆå¤æ‚çš„å¤šè¡¨æ¸…ç†åœºæ™¯ï¼ŒæŒ‰ç±»å‹åˆ†ç»„ç®¡ç†ï¼š

```python
from df_test_framework import CleanupManager

class OrderCleanupManager(CleanupManager):
    """è®¢å•æ¸…ç†ç®¡ç†å™¨"""

    def _do_cleanup(self):
        # æŒ‰ä¾èµ–å…³ç³»å€’åºæ¸…ç†ï¼ˆå…ˆå­è¡¨åä¸»è¡¨ï¼‰
        for order_no in self.get_items("orders"):
            # 1. å…ˆåˆ é™¤è®¢å•æ˜ç»†
            self.db.execute(
                "DELETE FROM order_items WHERE order_no = :no",
                {"no": order_no}
            )
            # 2. å†åˆ é™¤è®¢å•ä¸»è¡¨
            self.db.execute(
                "DELETE FROM orders WHERE order_no = :no",
                {"no": order_no}
            )

@pytest.fixture
def cleanup_orders(request, database):
    manager = OrderCleanupManager(request, database)
    yield manager
    manager.cleanup()  # è‡ªåŠ¨æ£€æŸ¥ --keep-test-data
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```python
def test_create_order(http_client, cleanup_orders):
    order_no = DataGenerator.test_id("TEST_ORD")
    response = http_client.post("/orders", json={"order_no": order_no})

    # æ³¨å†Œæ¸…ç†
    cleanup_orders.add("orders", order_no)

    assert response.status_code == 200
    # âœ… æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†ï¼ˆé™¤é --keep-test-dataï¼‰
```

### 3. SimpleCleanupManager - å›è°ƒå‡½æ•°æ¨¡å¼

é€‚åˆç®€å•åœºæ™¯ï¼Œé€šè¿‡å›è°ƒå‡½æ•°æ‰§è¡Œæ¸…ç†ï¼š

```python
from df_test_framework import SimpleCleanupManager

@pytest.fixture
def cleanup_files(request):
    manager = SimpleCleanupManager(request)

    # æ³¨å†Œæ¸…ç†å›è°ƒ
    def cleanup_uploaded_files(file_ids):
        for file_id in file_ids:
            os.remove(f"/uploads/{file_id}")

    manager.register_cleanup("files", cleanup_uploaded_files)
    yield manager
    manager.cleanup()
```

### 4. ListCleanup - åˆ—è¡¨å¼æ¸…ç†å™¨

é€‚åˆå•ä¸€ç±»å‹çš„ç®€å•æ¸…ç†åœºæ™¯ï¼š

```python
from df_test_framework import ListCleanup

@pytest.fixture
def cleanup_user_ids(request, database):
    user_ids = ListCleanup(request)
    yield user_ids

    if user_ids.should_do_cleanup():
        for user_id in user_ids:
            database.execute(f"DELETE FROM users WHERE id = {user_id}")
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```python
def test_create_user(http_client, cleanup_user_ids):
    response = http_client.post("/users", json={"name": "test"})
    user_id = response.json()["id"]

    cleanup_user_ids.append(user_id)  # åƒæ™®é€š list ä¸€æ ·ä½¿ç”¨

    assert response.status_code == 201
```

### 5. DataGenerator.test_id() - ç±»æ–¹æ³•

æ— éœ€å®ä¾‹åŒ–ï¼Œç›´æ¥ç”Ÿæˆæµ‹è¯•æ•°æ®æ ‡è¯†ç¬¦ï¼š

```python
from df_test_framework import DataGenerator

# ç”Ÿæˆæ ¼å¼: {prefix}{timestamp14}{random6}
order_no = DataGenerator.test_id("TEST_ORD")
# ç¤ºä¾‹: TEST_ORD20251128143052789012

user_code = DataGenerator.test_id("USR")
# ç¤ºä¾‹: USR20251128143052123456

# å”¯ä¸€æ€§ä¿è¯
id1 = DataGenerator.test_id("TEST")
id2 = DataGenerator.test_id("TEST")
assert id1 != id2  # æ¯æ¬¡è°ƒç”¨éƒ½ç”Ÿæˆå”¯ä¸€å€¼
```

---

## ğŸ”§ é…ç½®æ§åˆ¶

### å‘½ä»¤è¡Œå‚æ•°

```bash
# æ­£å¸¸è¿è¡Œï¼Œè‡ªåŠ¨æ¸…ç†æ•°æ®
pytest tests/

# ä¿ç•™æµ‹è¯•æ•°æ®ç”¨äºè°ƒè¯•
pytest tests/ --keep-test-data
```

### ç¯å¢ƒå˜é‡

```bash
# ä¿ç•™æµ‹è¯•æ•°æ®
KEEP_TEST_DATA=1 pytest tests/
```

### æµ‹è¯•æ ‡è®°

```python
@pytest.mark.keep_data
def test_debug_something():
    """è¿™ä¸ªæµ‹è¯•çš„æ•°æ®ä¼šè¢«ä¿ç•™"""
    pass
```

---

## ğŸ“Š API å‚è€ƒ

### should_keep_test_data(request) -> bool

æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¿ç•™æµ‹è¯•æ•°æ®ã€‚

**å‚æ•°**ï¼š
- `request`: pytest çš„ request fixture

**è¿”å›å€¼**ï¼š
- `True`: åº”è¯¥ä¿ç•™æ•°æ®ï¼ˆä¸æ¸…ç†ï¼‰
- `False`: åº”è¯¥æ¸…ç†æ•°æ®

### CleanupManager

æŠ½è±¡åŸºç±»ï¼Œå­ç±»éœ€å®ç° `_do_cleanup()` æ–¹æ³•ã€‚

**æ–¹æ³•**ï¼š
- `add(type_name, item)`: æ·»åŠ éœ€è¦æ¸…ç†çš„é¡¹ç›®
- `get_items(type_name)`: è·å–æŒ‡å®šç±»å‹çš„æ‰€æœ‰é¡¹ç›®
- `cleanup()`: æ‰§è¡Œæ¸…ç†ï¼ˆè‡ªåŠ¨æ£€æŸ¥é…ç½®ï¼‰

### SimpleCleanupManager

å›è°ƒå‡½æ•°æ¨¡å¼çš„æ¸…ç†ç®¡ç†å™¨ã€‚

**æ–¹æ³•**ï¼š
- `register_cleanup(type_name, callback)`: æ³¨å†Œæ¸…ç†å›è°ƒ
- `add(type_name, item)`: æ·»åŠ éœ€è¦æ¸…ç†çš„é¡¹ç›®
- `cleanup()`: æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„å›è°ƒ

### ListCleanup

ç»§æ‰¿è‡ª `list`ï¼Œé€‚åˆå•ä¸€ç±»å‹æ¸…ç†ã€‚

**æ–¹æ³•**ï¼š
- `should_keep()`: æ˜¯å¦ä¿ç•™æ•°æ®
- `should_do_cleanup()`: æ˜¯å¦æ‰§è¡Œæ¸…ç†ï¼ˆä¸ should_keep ç›¸åï¼‰
- æ‰€æœ‰ list æ–¹æ³•ï¼š`append()`, `extend()`, `__iter__()` ç­‰

### DataGenerator.test_id(prefix)

ç±»æ–¹æ³•ï¼Œç”Ÿæˆæµ‹è¯•æ•°æ®æ ‡è¯†ç¬¦ã€‚

**å‚æ•°**ï¼š
- `prefix`: æ ‡è¯†ç¬¦å‰ç¼€

**è¿”å›å€¼**ï¼š
- æ ¼å¼ï¼š`{prefix}{timestamp14}{random6}`
- ç¤ºä¾‹ï¼š`TEST_ORD20251128143052789012`

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§çš„ test_data_cleaner è¿ç§»

**æ—§ä»£ç **ï¼š
```python
def test_example(test_data_cleaner):
    test_data_cleaner.register("users", user_id=123)
```

**æ–°ä»£ç **ï¼ˆä½¿ç”¨ CleanupManagerï¼‰ï¼š
```python
def test_example(cleanup_users):
    cleanup_users.add("users", 123)
```

### ä» UniqueId è¿ç§»åˆ° DataGenerator.test_id()

**æ—§ä»£ç **ï¼š
```python
from df_test_framework import UniqueId
unique_id = UniqueId("TEST")
order_no = unique_id.generate()
```

**æ–°ä»£ç **ï¼š
```python
from df_test_framework import DataGenerator
order_no = DataGenerator.test_id("TEST")
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `testing/fixtures/cleanup.py` | æ¸…ç†æ¨¡å—æ ¸å¿ƒå®ç° |
| `docs/guides/test_data_cleanup.md` | å®Œæ•´ä½¿ç”¨æŒ‡å— |
| `tests/testing/fixtures/test_cleanup.py` | æ¸…ç†æ¨¡å—æµ‹è¯• |

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

| æ¨¡å— | æµ‹è¯•æ•°é‡ | è¦†ç›–å†…å®¹ |
|------|---------|---------|
| `should_keep_test_data()` | 8 | é…ç½®ä¼˜å…ˆçº§ã€è¾¹ç•Œæ¡ä»¶ |
| `CleanupManager` | 12 | å¤šç±»å‹ç®¡ç†ã€æ¸…ç†æ‰§è¡Œ |
| `SimpleCleanupManager` | 8 | å›è°ƒæ³¨å†Œã€æ‰§è¡Œé¡ºåº |
| `ListCleanup` | 10 | åˆ—è¡¨æ“ä½œã€é…ç½®æ£€æŸ¥ |
| `DataGenerator.test_id()` | 3 | æ ¼å¼éªŒè¯ã€å”¯ä¸€æ€§ |
| **æ€»è®¡** | **41** | å…¨éƒ¨é€šè¿‡ |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **ä½¿ç”¨æŒ‡å—**: [test_data_cleanup.md](../guides/test_data_cleanup.md)
- **è„šæ‰‹æ¶æ¨¡æ¿**: å·²æ›´æ–° conftest.pyã€fixtures_init.pyã€data_cleaners.py

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ç¤¾åŒºåé¦ˆçš„æµ‹è¯•æ•°æ®æ¸…ç†éœ€æ±‚ï¼Œæœ¬ç‰ˆæœ¬æä¾›äº†ç»Ÿä¸€ã€çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚
