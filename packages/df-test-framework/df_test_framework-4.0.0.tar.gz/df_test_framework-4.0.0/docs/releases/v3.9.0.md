# DF Test Framework v3.9.0 Release Notes

å‘å¸ƒæ—¥æœŸ: TBD (å¾…å‘å¸ƒ)

---

## ğŸ‰ é‡å¤§æ›´æ–°

### ğŸ“¡ æ¶ˆæ¯é˜Ÿåˆ—å®¢æˆ·ç«¯ - Kafka + RabbitMQ + RocketMQï¼ˆæ ¸å¿ƒç‰¹æ€§ï¼‰

**ä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—æµ‹è¯•æ”¯æŒï¼šä¸‰å¤§ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—ç»Ÿä¸€å°è£…ï¼**

å…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å—ï¼Œæä¾› Kafkaã€RabbitMQã€RocketMQ ä¸‰å¤§ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—çš„ç»Ÿä¸€å°è£…ï¼Œæ”¯æŒä¼ä¸šçº§æµ‹è¯•åœºæ™¯ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- âœ… **Kafkaå®¢æˆ·ç«¯**: åŸºäº confluent-kafka 1.9.2ï¼Œæ€§èƒ½æå‡3å€
- âœ… **RabbitMQå®¢æˆ·ç«¯**: åŸºäº pika (AMQP 0-9-1)ï¼Œæ”¯æŒ4ç§Exchangeæ¨¡å¼
- âœ… **RocketMQå®¢æˆ·ç«¯**: åŸºäº rocketmq-python-clientï¼Œæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯
- âœ… **å®Œæ•´SSL/TLSæ”¯æŒ**: Kafkaè¯ä¹¦è®¤è¯ã€SASLè®¤è¯
- âœ… **Pytest Fixtures**: å¼€ç®±å³ç”¨çš„æµ‹è¯•fixtures
- âœ… **å¯é€‰ä¾èµ–**: æŒ‰éœ€å®‰è£…ï¼Œä¸å½±å“æ ¸å¿ƒæ¡†æ¶

---

## ğŸš€ Kafkaå®¢æˆ·ç«¯

### æ€§èƒ½ä¼˜åŠ¿

åŸºäº **confluent-kafka 1.9.2** (librdkafka Cåº“)ï¼Œæ€§èƒ½æ˜¾è‘—æå‡ï¼š

| æŒ‡æ ‡ | kafka-python3 | confluent-kafka | æå‡å¹…åº¦ |
|------|--------------|-----------------|---------|
| **ç”Ÿäº§æ€§èƒ½** | åŸºå‡† | **3å€æå‡** | 200%â†‘ |
| **æ¶ˆè´¹æ€§èƒ½** | åŸºå‡† | **50%æå‡** | 50%â†‘ |
| **åº•å±‚å®ç°** | çº¯Python | Cåº“ (librdkafka) | - |

### æ ¸å¿ƒåŠŸèƒ½

```python
from df_test_framework.messengers.queue.kafka import KafkaClient, KafkaConfig

# åˆ›å»ºå®¢æˆ·ç«¯
config = KafkaConfig(bootstrap_servers=["localhost:9092"])
client = KafkaClient(config)

# å‘é€æ¶ˆæ¯
client.send("user-events", {"user_id": 123, "action": "login"})

# åŒæ­¥å‘é€(ç­‰å¾…ç¡®è®¤)
result = client.send_sync("user-events", {"user_id": 123})
# {"topic": "user-events", "partition": 0, "offset": 12345}

# æ‰¹é‡å‘é€
messages = [{"user_id": i} for i in range(100)]
count = client.send_batch("user-events", messages)

# æ¶ˆè´¹æ¶ˆæ¯
client.consume(
    topics=["user-events"],
    group_id="test-group",
    handler=lambda msg: print(msg),
    max_messages=10
)

# AdminClient - ä¸»é¢˜ç®¡ç†
client.create_topic("new-topic", num_partitions=3, replication_factor=2)
client.delete_topic("old-topic")
```

### SSL/TLS é…ç½®

æ”¯æŒä¸‰ç§SSLé…ç½®æ–¹å¼ï¼š

#### 1. è¯ä¹¦è®¤è¯ (ç”Ÿäº§ç¯å¢ƒæ¨è)

```python
from df_test_framework.messengers.queue.kafka import KafkaConfig, KafkaSSLConfig

config = KafkaConfig(
    bootstrap_servers=["kafka.example.com:9093"],
    ssl=KafkaSSLConfig(
        security_protocol="SSL",
        ssl_ca_location="/path/to/ca-cert.pem",
        ssl_certificate_location="/path/to/client-cert.pem",
        ssl_key_location="/path/to/client-key.pem",
        ssl_key_password="your-password"  # å¯é€‰
    )
)
```

#### 2. SASL è®¤è¯

```python
config = KafkaConfig(
    bootstrap_servers=["kafka.example.com:9093"],
    ssl=KafkaSSLConfig(
        security_protocol="SASL_SSL",
        sasl_mechanism="PLAIN",  # æˆ– SCRAM-SHA-256, SCRAM-SHA-512
        sasl_username="your-username",
        sasl_password="your-password",
        ssl_ca_location="/path/to/ca-cert.pem"
    )
)
```

#### 3. ç¦ç”¨SSLéªŒè¯ (ä»…æµ‹è¯•ç¯å¢ƒ!)

```python
config = KafkaConfig(
    bootstrap_servers=["kafka-test.example.com:9092"],
    ssl=KafkaSSLConfig(
        security_protocol="PLAINTEXT",
        enable_ssl_certificate_verification="false",  # æ³¨æ„: å­—ç¬¦ä¸²!
        ssl_endpoint_identification_algorithm="none"
    )
)
```

âš ï¸ **ç‰ˆæœ¬è¯´æ˜**: ä½¿ç”¨ 1.9.2 ç‰ˆæœ¬ä»¥é¿å… 2.0+ ç‰ˆæœ¬çš„ **SSL_HANDSHAKE å…¬ç½‘è¿æ¥é—®é¢˜**ã€‚

### æ–‡æ¡£

- [ä½¿ç”¨æŒ‡å— - Kafkaéƒ¨åˆ†](../guides/message_queue.md#kafkaå®¢æˆ·ç«¯)
- [ç¤ºä¾‹ä»£ç  - kafka_basic.py](../../examples/07-message-queue/kafka_basic.py)
- [SSLé…ç½®ç¤ºä¾‹ - kafka_ssl.py](../../examples/07-message-queue/kafka_ssl.py)

---

## ğŸ° RabbitMQå®¢æˆ·ç«¯

### æŠ€æœ¯é€‰å‹: AMQP 0-9-1

åŸºäº **pika** (AMQP 0-9-1 åè®®)ï¼Œç”Ÿäº§å°±ç»ªçš„ç¨³å®šå®ç°ã€‚

**ä¸ºä»€ä¹ˆé€‰æ‹© AMQP 0-9-1 è€Œé AMQP 1.0?**

| å¯¹æ¯”ç»´åº¦ | AMQP 0-9-1 (pika) | AMQP 1.0 (rabbitmq-amqp-python-client) |
|---------|-------------------|----------------------------------------|
| **åè®®å…³ç³»** | RabbitMQåŸç”Ÿåè®® | å®Œå…¨ä¸åŒçš„åè®®æ ‡å‡† |
| **æˆç†Ÿåº¦** | âœ… Stable (v1.3.2) | âš ï¸ **Alpha** (v0.3.0) |
| **æ–‡æ¡£å®Œæ•´æ€§** | âœ… å®Œæ•´ | âš ï¸ ä¸å®Œæ•´ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å®éªŒå’Œæœªæ¥å‡†å¤‡ |

**å†³ç­–**: AMQP 0-9-1 æ˜¯ RabbitMQ çš„æ ¸å¿ƒè®¾è®¡åè®®ï¼Œ**æ°¸ä¹…æ”¯æŒ**ï¼Œé€‚åˆç”Ÿäº§ä½¿ç”¨ã€‚

### Exchange ç±»å‹æ”¯æŒ

æ”¯æŒ RabbitMQ çš„ 4 ç§ Exchange ç±»å‹ï¼š

#### 1. Direct Exchange - ç²¾ç¡®åŒ¹é…

```python
from df_test_framework.messengers.queue.rabbitmq import RabbitMQClient, RabbitMQConfig

client = RabbitMQClient(RabbitMQConfig())

# å£°æ˜å’Œç»‘å®š
client.declare_exchange("logs", exchange_type="direct")
client.declare_queue("error-logs")
client.bind_queue("error-logs", "logs", routing_key="error")

# å‘å¸ƒæ¶ˆæ¯ (åªæœ‰routing_key="error"çš„ä¼šè·¯ç”±åˆ°error-logs)
client.publish("logs", "error", {"level": "error", "msg": "DB connection failed"})
```

#### 2. Topic Exchange - æ¨¡å¼åŒ¹é…

```python
client.declare_exchange("events", exchange_type="topic")
client.declare_queue("user-events")
client.bind_queue("user-events", "events", routing_key="user.*")

# åŒ¹é… user.* çš„æ¶ˆæ¯éƒ½ä¼šè·¯ç”±è¿‡æ¥
client.publish("events", "user.login", {"user_id": 123})
client.publish("events", "user.logout", {"user_id": 123})
```

#### 3. Fanout Exchange - å¹¿æ’­

```python
client.declare_exchange("notifications", exchange_type="fanout")
client.declare_queue("email-queue")
client.declare_queue("sms-queue")
client.bind_queue("email-queue", "notifications", "")
client.bind_queue("sms-queue", "notifications", "")

# æ¶ˆæ¯ä¼šåŒæ—¶å‘é€åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—
client.publish("notifications", "", {"message": "System maintenance at 2AM"})
```

#### 4. Headers Exchange - å¤´éƒ¨åŒ¹é…

```python
client.declare_exchange("tasks", exchange_type="headers")
```

### é˜Ÿåˆ—ç®¡ç†

```python
# æŒä¹…åŒ–é˜Ÿåˆ—
client.declare_queue("orders", durable=True)

# TTLé˜Ÿåˆ— (æ¶ˆæ¯30ç§’åè¿‡æœŸ)
client.declare_queue("temp-messages", arguments={"x-message-ttl": 30000})

# æ­»ä¿¡é˜Ÿåˆ—
client.declare_queue("main-queue", arguments={
    "x-dead-letter-exchange": "dlx",
    "x-dead-letter-routing-key": "dead"
})

# è·å–å•æ¡æ¶ˆæ¯
message = client.get_message("orders")

# æ¸…ç©ºé˜Ÿåˆ—
count = client.purge_queue("temp-messages")

# åˆ é™¤é˜Ÿåˆ—
client.delete_queue("temp-messages")
```

### æ–‡æ¡£

- [ä½¿ç”¨æŒ‡å— - RabbitMQéƒ¨åˆ†](../guides/message_queue.md#rabbitmqå®¢æˆ·ç«¯)
- [åè®®é€‰æ‹©è¯´æ˜](../guides/message_queue.md#åè®®é€‰æ‹©è¯´æ˜)
- [ç¤ºä¾‹ä»£ç  - rabbitmq_basic.py](../../examples/07-message-queue/rabbitmq_basic.py)

---

## ğŸš€ RocketMQå®¢æˆ·ç«¯

### æ ¸å¿ƒç‰¹æ€§

åŸºäº **rocketmq-python-client** (Apacheå®˜æ–¹å®¢æˆ·ç«¯)ï¼š

- âœ… **åŒæ­¥/å¼‚æ­¥/å•å‘å‘é€** - ä¸‰ç§å‘é€æ¨¡å¼
- âœ… **å»¶è¿Ÿæ¶ˆæ¯** - 18ä¸ªå»¶è¿Ÿçº§åˆ« (1s, 5s, 10s, 30s, 1m...2h)
- âœ… **æ¶ˆæ¯è¿‡æ»¤** - Tags å’Œ SQL è¿‡æ»¤
- âœ… **é›†ç¾¤/å¹¿æ’­æ¨¡å¼** - ä¸¤ç§æ¶ˆè´¹æ¨¡å¼
- âœ… **ACLè®¤è¯** - æ”¯æŒ AccessKey/SecretKey

### æ ¸å¿ƒåŠŸèƒ½

```python
from df_test_framework.messengers.queue.rocketmq import (
    RocketMQClient, RocketMQConfig, RocketMQProducerConfig
)

# åˆ›å»ºå®¢æˆ·ç«¯
config = RocketMQConfig(
    namesrv_addr="localhost:9876",
    producer=RocketMQProducerConfig(group_name="test-producer")
)
client = RocketMQClient(config)

# åŒæ­¥å‘é€
msg_id = client.send("user-events", {"user_id": 123}, tags="login")

# æ‰¹é‡å‘é€
messages = [{"order_id": f"ORD-{i}"} for i in range(10)]
count = client.send_batch("orders", messages, tags="batch")

# å•å‘å‘é€ (ä¸ç­‰å¾…å“åº”ï¼Œæ€§èƒ½æœ€é«˜)
client.send_oneway("metrics", {"cpu": 80}, tags="monitor")
```

### å»¶è¿Ÿæ¶ˆæ¯

RocketMQ æ”¯æŒ 18 ä¸ªå»¶è¿Ÿçº§åˆ«ï¼š

```python
# å»¶è¿Ÿçº§åˆ«: 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
client.send(
    topic="delayed-tasks",
    message={"task": "send_email"},
    delay_level=3  # å»¶è¿Ÿ10ç§’
)
```

### æ¶ˆæ¯è¿‡æ»¤

```python
# ä½¿ç”¨ Tags è¿‡æ»¤
client.send("orders", {"order_id": "001"}, tags="PAID")
client.send("orders", {"order_id": "002"}, tags="PENDING")

# æ¶ˆè´¹è€…åªæ¶ˆè´¹ PAID æ ‡ç­¾
client.subscribe(
    topic="orders",
    handler=lambda msg: print(msg) or True,
    tags="PAID"  # åªæ¶ˆè´¹å·²æ”¯ä»˜è®¢å•
)

# å¤šæ ‡ç­¾è®¢é˜…
client.subscribe(
    topic="orders",
    handler=handler,
    tags="PAID || SHIPPED"  # PAID æˆ– SHIPPED
)
```

### æ–‡æ¡£

- [ä½¿ç”¨æŒ‡å— - RocketMQéƒ¨åˆ†](../guides/message_queue.md#rocketmqå®¢æˆ·ç«¯)
- [ç¤ºä¾‹ä»£ç  - rocketmq_basic.py](../../examples/07-message-queue/rocketmq_basic.py)

---

## ğŸ§ª Pytest Fixtures

æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—å®¢æˆ·ç«¯éƒ½æä¾›å¼€ç®±å³ç”¨çš„ pytest fixturesï¼š

```python
from df_test_framework.testing.fixtures.message_queue import (
    kafka_client,
    kafka_config,
    rabbitmq_client,
    rabbitmq_config,
    rocketmq_client,
    rocketmq_config,
)

def test_kafka(kafka_client):
    """æµ‹è¯•Kafkaå‘é€å’Œæ¶ˆè´¹"""
    kafka_client.send("test-topic", {"data": "test"})

    messages = []
    kafka_client.consume(
        topics=["test-topic"],
        group_id="test-group",
        handler=lambda msg: messages.append(msg),
        max_messages=1
    )

    assert len(messages) == 1

def test_rabbitmq(rabbitmq_client):
    """æµ‹è¯•RabbitMQ Fanout Exchange"""
    rabbitmq_client.declare_exchange("broadcast", "fanout")
    rabbitmq_client.declare_queue("queue1")
    rabbitmq_client.bind_queue("queue1", "broadcast", "")

    rabbitmq_client.publish("broadcast", "", {"text": "Hello!"})

    msg = rabbitmq_client.get_message("queue1")
    assert msg["text"] == "Hello!"

def test_rocketmq(rocketmq_client):
    """æµ‹è¯•RocketMQå»¶è¿Ÿæ¶ˆæ¯"""
    msg_id = rocketmq_client.send(
        "test-topic",
        {"task": "cleanup"},
        delay_level=2  # å»¶è¿Ÿ5ç§’
    )

    assert msg_id is not None
```

---

## ğŸ“Š æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”

é€‰æ‹©åˆé€‚çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š

| ç‰¹æ€§ | Kafka | RabbitMQ | RocketMQ |
|------|-------|----------|----------|
| **æ€§èƒ½** | æé«˜(ç™¾ä¸‡çº§QPS) | ä¸­ç­‰(ä¸‡çº§QPS) | é«˜(åä¸‡çº§QPS) |
| **å»¶è¿Ÿ** | æ¯«ç§’çº§ | å¾®ç§’çº§ | æ¯«ç§’çº§ |
| **æ¶ˆæ¯é¡ºåº** | åˆ†åŒºå†…æœ‰åº | é˜Ÿåˆ—å†…æœ‰åº | åˆ†åŒºå†…æœ‰åº |
| **æ¶ˆæ¯æŒä¹…åŒ–** | âœ… å¼º | âœ… å¯é€‰ | âœ… å¼º |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | âŒ | âŒ | âœ… |
| **å»¶è¿Ÿæ¶ˆæ¯** | âŒ | âœ… (æ’ä»¶) | âœ… (18çº§åˆ«) |
| **æ¶ˆæ¯è¿‡æ»¤** | âŒ | âœ… (Headers) | âœ… (Tags/SQL) |
| **é€‚ç”¨åœºæ™¯** | æ—¥å¿—æ”¶é›†ã€æµå¤„ç† | ä»»åŠ¡é˜Ÿåˆ—ã€RPC | ç”µå•†ã€é‡‘è |

**é€‰æ‹©å»ºè®®**:
- **Kafka**: å¤§æ•°æ®é‡ã€æ—¥å¿—é‡‡é›†ã€å®æ—¶æµå¤„ç†
- **RabbitMQ**: å¤æ‚è·¯ç”±ã€ä»»åŠ¡é˜Ÿåˆ—ã€å¾®æœåŠ¡é€šä¿¡
- **RocketMQ**: ç”µå•†è®¢å•ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€é‡‘èç³»ç»Ÿ

---

## ğŸ“¦ å®‰è£…

### æŒ‰éœ€å®‰è£…

```bash
# å®‰è£…å•ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒ
pip install 'df-test-framework[kafka]'
pip install 'df-test-framework[rabbitmq]'
pip install 'df-test-framework[rocketmq]'

# å®‰è£…å…¨éƒ¨æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒ
pip install 'df-test-framework[mq]'
```

### ä¾èµ–è¯´æ˜

| ä¾èµ– | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| `confluent-kafka` | >=1.9.2,<2.0.0 | Kafkaå®¢æˆ·ç«¯ (é”å®š1.9.xé¿å…SSLé—®é¢˜) |
| `pika` | >=1.3.0 | RabbitMQå®¢æˆ·ç«¯ (AMQP 0-9-1) |
| `rocketmq-python-client` | >=5.0.0 | RocketMQå®¢æˆ·ç«¯ (Apacheå®˜æ–¹) |

---

## ğŸ“š å®Œæ•´æ–‡æ¡£

### ä½¿ç”¨æŒ‡å—

- [æ¶ˆæ¯é˜Ÿåˆ—å®Œæ•´ä½¿ç”¨æŒ‡å—](../guides/message_queue.md) (~870è¡Œ)
  - Kafka: åŸºæœ¬ç”¨æ³•ã€SSL/TLSé…ç½®ã€AdminClientã€æ€§èƒ½ä¼˜åŒ–
  - RabbitMQ: åè®®é€‰æ‹©ã€4ç§Exchangeç±»å‹ã€é˜Ÿåˆ—ç®¡ç†
  - RocketMQ: å»¶è¿Ÿæ¶ˆæ¯ã€æ¶ˆæ¯è¿‡æ»¤ã€é›†ç¾¤/å¹¿æ’­æ¨¡å¼
  - æµ‹è¯•åœºæ™¯ç¤ºä¾‹: è®¢å•äº‹ä»¶ã€ä»»åŠ¡é˜Ÿåˆ—ã€æ—¥å¿—èšåˆ
  - æ€§èƒ½å»ºè®®å’Œæ•…éšœæ’æŸ¥

### ç¤ºä¾‹ä»£ç 

ä½äº `examples/07-message-queue/`:

- `kafka_basic.py` - KafkaåŸºæœ¬å‘é€å’Œæ¶ˆè´¹
- `kafka_ssl.py` - Kafka SSLé…ç½® (4ç§åœºæ™¯)
- `rabbitmq_basic.py` - RabbitMQåŸºæœ¬ç”¨æ³•
- `rabbitmq_exchange_types.py` - 4ç§Exchangeç±»å‹ç¤ºä¾‹
- `rocketmq_basic.py` - RocketMQåŸºæœ¬ç”¨æ³•
- `rocketmq_delay.py` - RocketMQå»¶è¿Ÿæ¶ˆæ¯
- `docker-compose-kafka.yml` - Kafkaæœ¬åœ°ç¯å¢ƒ
- `docker-compose-rabbitmq.yml` - RabbitMQæœ¬åœ°ç¯å¢ƒ
- `docker-compose-rocketmq.yml` - RocketMQæœ¬åœ°ç¯å¢ƒ

### æŠ€æœ¯æ–‡æ¡£

- [AMQPåè®®é€‰æ‹©è¯´æ˜](../guides/message_queue.md#åè®®é€‰æ‹©è¯´æ˜) - ä¸ºä»€ä¹ˆé€‰æ‹©AMQP 0-9-1
- [Kafka SSLé—®é¢˜è¯´æ˜](../guides/message_queue.md#ssltls-é…ç½®) - confluent-kafkaç‰ˆæœ¬é€‰æ‹©
- [æ¶æ„è¯´æ˜](../../src/df_test_framework/messengers/__init__.py) - æ¶ˆæ¯ä¼ é€’èƒ½åŠ›å±‚è®¾è®¡

---

## ğŸ“ˆ ç»Ÿè®¡æ•°æ®

### ä»£ç ç»Ÿè®¡

- **æ ¸å¿ƒä»£ç **: +1,340 è¡Œ
  - Kafkaå®¢æˆ·ç«¯: ~430 è¡Œ (client.py + config.py)
  - RabbitMQå®¢æˆ·ç«¯: ~520 è¡Œ (client.py + config.py)
  - RocketMQå®¢æˆ·ç«¯: ~390 è¡Œ (client.py + config.py)

- **æµ‹è¯•ä»£ç **: +522 è¡Œ
  - å•å…ƒæµ‹è¯•: ~440 è¡Œ
  - Pytest Fixtures: ~82 è¡Œ

- **æ–‡æ¡£**: +1,100 è¡Œ
  - ä½¿ç”¨æŒ‡å—: ~870 è¡Œ
  - ç¤ºä¾‹ä»£ç : ~180 è¡Œ
  - æ¶æ„è¯´æ˜: ~50 è¡Œ

- **æ€»è®¡**: +2,962 è¡Œ

### æµ‹è¯•è¦†ç›–

- âœ… **671 passed, 44 skipped**
- âœ… Kafka: é…ç½®æµ‹è¯•ã€å®¢æˆ·ç«¯Mockæµ‹è¯•ã€é›†æˆæµ‹è¯•éª¨æ¶
- âœ… RabbitMQ: é…ç½®æµ‹è¯•ã€Exchangeç±»å‹æµ‹è¯•ã€æ¶ˆæ¯å‘å¸ƒ/æ¶ˆè´¹æµ‹è¯•
- âœ… RocketMQ: é…ç½®æµ‹è¯•ã€å‘é€/è®¢é˜…æµ‹è¯•ã€å»¶è¿Ÿæ¶ˆæ¯æµ‹è¯•
- âœ… Fixtures: æ‰€æœ‰fixturesçš„é…ç½®å’Œè·³è¿‡é€»è¾‘æµ‹è¯•

---

## ğŸ”§ æŠ€æœ¯å†³ç­–

### Kafka: confluent-kafka 1.9.2

**é€‰æ‹©ç†ç”±**:
- âœ… æ€§èƒ½æå‡: ç”Ÿäº§3å€ã€æ¶ˆè´¹50% (ç›¸æ¯”kafka-python3)
- âœ… æ´»è·ƒç»´æŠ¤: Confluentå®˜æ–¹æ”¯æŒ
- âœ… ä¼ä¸šçº§ç‰¹æ€§: äº‹åŠ¡ã€å¹‚ç­‰æ€§ã€Avroåºåˆ—åŒ–

**ç‰ˆæœ¬é”å®š**:
- âš ï¸ **ä¸ä½¿ç”¨ 2.0+**: å­˜åœ¨ SSL_HANDSHAKE å…¬ç½‘è¿æ¥é—®é¢˜
- âœ… **ä½¿ç”¨ 1.9.2**: ç¨³å®šç‰ˆæœ¬ï¼Œé¿å…SSLé—®é¢˜
- ğŸ“Œ **ç‰ˆæœ¬èŒƒå›´**: `>=1.9.2,<2.0.0`

### RabbitMQ: pika (AMQP 0-9-1)

**é€‰æ‹©ç†ç”±**:
- âœ… ç”Ÿäº§å°±ç»ª: StableçŠ¶æ€ (v1.3.2)
- âœ… RabbitMQåŸç”Ÿ: AMQP 0-9-1 æ˜¯ RabbitMQ æ ¸å¿ƒåè®®
- âœ… åŠŸèƒ½å®Œæ•´: æ”¯æŒæ‰€æœ‰Exchangeã€Queueã€Bindingç‰¹æ€§
- âœ… ç¤¾åŒºæˆç†Ÿ: ä¸°å¯Œçš„æ–‡æ¡£å’Œæ¡ˆä¾‹

**ä¸ä½¿ç”¨ AMQP 1.0**:
- âš ï¸ `rabbitmq-amqp-python-client` ä»å¤„äº **Alpha** é˜¶æ®µ (v0.3.0)
- âš ï¸ æ–‡æ¡£ä¸å®Œæ•´ï¼ŒAPIå¯èƒ½å˜åŒ–
- âœ… AMQP 0-9-1 **æ°¸ä¹…æ”¯æŒ**ï¼Œä¸ä¼šè¢«åºŸå¼ƒ

### RocketMQ: rocketmq-python-client

**é€‰æ‹©ç†ç”±**:
- âœ… Apacheå®˜æ–¹: å®˜æ–¹Pythonå®¢æˆ·ç«¯
- âœ… å®Œæ•´ç‰¹æ€§: æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ã€Tagsè¿‡æ»¤ã€ACLè®¤è¯
- âœ… ç‰ˆæœ¬ç°ä»£: v5.0.0 (2023å¹´å‘å¸ƒ)

---

## ğŸš€ å‡çº§æŒ‡å—

### ä»æ— æ¶ˆæ¯é˜Ÿåˆ— â†’ v3.9.0

1. **å®‰è£…ä¾èµ–**:
   ```bash
   pip install 'df-test-framework[mq]'  # æˆ–å•ç‹¬å®‰è£…
   ```

2. **å¯¼å…¥å®¢æˆ·ç«¯**:
   ```python
   from df_test_framework.messengers.queue.kafka import KafkaClient, KafkaConfig
   from df_test_framework.messengers.queue.rabbitmq import RabbitMQClient, RabbitMQConfig
   from df_test_framework.messengers.queue.rocketmq import RocketMQClient, RocketMQConfig
   ```

3. **ä½¿ç”¨Fixtures**:
   ```python
   from df_test_framework.testing.fixtures.message_queue import (
       kafka_client, rabbitmq_client, rocketmq_client
   )

   def test_example(kafka_client):
       kafka_client.send("topic", {"data": "test"})
   ```

### ä¾èµ–å†²çª

å¦‚æœå·²æœ‰å…¶ä»–Kafka/RabbitMQ/RocketMQå®¢æˆ·ç«¯ï¼Œå¯èƒ½å­˜åœ¨å†²çªï¼š

```bash
# æ£€æŸ¥ç°æœ‰ä¾èµ–
pip list | grep -E "kafka|pika|rocketmq"

# å¦‚æœ‰å†²çªï¼ŒæŒ‰éœ€å®‰è£…å•ä¸ªå®¢æˆ·ç«¯
pip install 'df-test-framework[kafka]'  # åªå®‰è£…Kafka
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### Kafka SSLé—®é¢˜

- **é—®é¢˜**: confluent-kafka 2.0+ åœ¨å…¬ç½‘ç¯å¢ƒå¯èƒ½é‡åˆ° SSL_HANDSHAKE é”™è¯¯
- **è§£å†³**: å·²é”å®šåˆ° 1.9.2 ç‰ˆæœ¬ (`confluent-kafka>=1.9.2,<2.0.0`)
- **å‚è€ƒ**: [Kafka SSLé…ç½®](../guides/message_queue.md#ssltls-é…ç½®)

### RabbitMQè¿æ¥è¶…æ—¶

- **é—®é¢˜**: é»˜è®¤å¿ƒè·³600ç§’å¯èƒ½åœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹è¶…æ—¶
- **è§£å†³**: è°ƒæ•´ `heartbeat` é…ç½®
  ```python
  config = RabbitMQConfig(
      connection=RabbitMQConnectionConfig(heartbeat=300)
  )
  ```

### RocketMQ NameServerè¿æ¥

- **é—®é¢˜**: é»˜è®¤ `localhost:9876` å¯èƒ½æ— æ³•è¿æ¥
- **è§£å†³**: ç¡®è®¤NameServeråœ°å€æˆ–ä½¿ç”¨Dockerå¯åŠ¨
  ```bash
  docker-compose -f examples/07-message-queue/docker-compose-rocketmq.yml up -d
  ```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç¯å¢ƒéš”ç¦»

ä½¿ç”¨ä¸åŒçš„topic/queue/groupåŒºåˆ†æµ‹è¯•ç¯å¢ƒï¼š

```python
# å¼€å‘ç¯å¢ƒ
client.send("dev-user-events", message)

# æµ‹è¯•ç¯å¢ƒ
client.send("test-user-events", message)

# ç”Ÿäº§ç¯å¢ƒ
client.send("prod-user-events", message)
```

### 2. æ¶ˆæ¯æ¸…ç†

æµ‹è¯•åæ¸…ç†æµ‹è¯•æ•°æ®ï¼š

```python
@pytest.fixture
def kafka_client():
    client = KafkaClient(config)
    yield client
    # æ¸…ç†: åˆ é™¤æµ‹è¯•topic
    client.delete_topic("test-topic")
    client.close()
```

### 3. å¹‚ç­‰æ€§æµ‹è¯•

ç¡®ä¿æ¶ˆæ¯å¤„ç†å¹‚ç­‰ï¼š

```python
def test_idempotent_consumer():
    # å‘é€ç›¸åŒæ¶ˆæ¯ä¸¤æ¬¡
    kafka_client.send("orders", {"order_id": "001"})
    kafka_client.send("orders", {"order_id": "001"})

    # æ¶ˆè´¹è€…åº”è¯¥å»é‡
    # ... éªŒè¯é€»è¾‘
```

### 4. é”™è¯¯å¤„ç†

æ­£ç¡®å¤„ç†æ¶ˆè´¹å¼‚å¸¸ï¼š

```python
def safe_handler(message):
    try:
        process_message(message)
        return True  # æ¶ˆè´¹æˆåŠŸ
    except Exception as e:
        logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}")
        return False  # é‡æ–°æ¶ˆè´¹
```

---

## ğŸ”’ å®‰å…¨ä¸è´¨é‡å¢å¼º

### v3.9.0 ä»£ç å®¡æŸ¥ä¿®å¤

åŸºäºä»£ç å®¡æŸ¥åé¦ˆï¼Œæœ¬ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹é‡è¦ä¿®å¤ï¼š

#### å®‰å…¨ä¿®å¤

| é—®é¢˜ | æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|------|------|----------|
| **SQLæ³¨å…¥é£é™©** | `BaseRepository` | æ·»åŠ è¡¨å/åˆ—åéªŒè¯ï¼Œä½¿ç”¨æ­£åˆ™ `^[A-Za-z_][A-Za-z0-9_]*$` |
| **æ•æ„Ÿä¿¡æ¯æ³„éœ²** | `KafkaSSLConfig` | `sasl_password` æ”¹ç”¨ `SecretStr` ç±»å‹ |

#### Bugä¿®å¤

| é—®é¢˜ | æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|------|------|----------|
| **Kafkaé…ç½®é”®åé”™è¯¯** | `KafkaProducerConfig` | ä¿®æ­£ä¸ºlibrdkafkaåŸç”Ÿé”®å |
| **Consumer offsetæœªæäº¤** | `KafkaClient.consume()` | `enable_auto_commit=False` æ—¶æ‰‹åŠ¨æäº¤offset |
| **HTTPConfigè¢«å¿½ç•¥** | `AsyncHttpClient` | å®ç°é…ç½®ä¼˜å…ˆçº§ï¼šæ˜¾å¼å‚æ•° > HTTPConfig > é»˜è®¤å€¼ |
| **UoWå±æ€§æ³„éœ²** | `UnitOfWork` | æ”¹ç”¨å®ä¾‹çº§ `__getattr__` é¿å…ç±»å±æ€§æ±¡æŸ“ |

#### Kafkaé…ç½®é”®åæ˜ å°„

> âš ï¸ **é‡è¦**: librdkafka ä½¿ç”¨çš„é…ç½®é”®åä¸ Java å®¢æˆ·ç«¯ä¸åŒ

| å­—æ®µå (Python) | librdkafka é”®å | è¯´æ˜ |
|-----------------|-----------------|------|
| `batch_num_messages` | `batch.num.messages` | æ‰¹é‡æ¶ˆæ¯æ•° |
| `queue_buffering_max_ms` | `queue.buffering.max.ms` | æ‰¹é‡ç­‰å¾…æ—¶é—´ |
| `queue_buffering_max_kbytes` | `queue.buffering.max.kbytes` | ç¼“å†²åŒºå¤§å°(KB) |
| `max_in_flight` | `max.in.flight` | æœªç¡®è®¤è¯·æ±‚æ•° |
| `retries` | `message.send.max.retries` | é‡è¯•æ¬¡æ•° |

#### AsyncHttpClient é…ç½®ä¼˜å…ˆçº§

```python
# é…ç½®ä¼˜å…ˆçº§: æ˜¾å¼å‚æ•° > HTTPConfig > é»˜è®¤å€¼

# æ–¹å¼1: çº¯HTTPConfig (æ¨è)
config = HTTPConfig(base_url="https://api.example.com", timeout=60)
client = AsyncHttpClient(config=config)

# æ–¹å¼2: æ˜¾å¼å‚æ•°è¦†ç›–config
config = HTTPConfig(timeout=30, verify_ssl=True)
client = AsyncHttpClient(
    base_url="https://api.example.com",  # ä½¿ç”¨æ˜¾å¼å‚æ•°
    timeout=60,                           # è¦†ç›–config.timeout
    config=config                         # verify_sslä»configè¯»å–
)
```

#### BaseRepository æ ‡è¯†ç¬¦é™åˆ¶

```python
# âœ… æ”¯æŒçš„è¡¨å/åˆ—åæ ¼å¼
repo = BaseRepository(session, "card_inventory")  # OK
repo = BaseRepository(session, "user_orders")      # OK

# âŒ ä¸æ”¯æŒçš„æ ¼å¼
repo = BaseRepository(session, "public.users")     # ValueError: ä¸æ”¯æŒschemaå‰ç¼€
repo = BaseRepository(session, "table-name")       # ValueError: ä¸æ”¯æŒè¿å­—ç¬¦

# å¦‚éœ€ä½¿ç”¨schemaå‰ç¼€ï¼Œè¯·ä½¿ç”¨åŸç”ŸSQL
uow.execute("SELECT * FROM public.users WHERE id = :id", {"id": 1})
```

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

### è·å–å¸®åŠ©

- ğŸ“– [å®Œæ•´æ–‡æ¡£](../guides/message_queue.md)
- ğŸ’¬ [GitHub Issues](https://github.com/yourorg/df-test-framework/issues)
- ğŸ“§ è”ç³»: qa@example.com

### åé¦ˆæ¸ é“

å¦‚é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼åé¦ˆï¼š

1. æäº¤ GitHub Issue (æ¨è)
2. å‘é€é‚®ä»¶åˆ° QA å›¢é˜Ÿ
3. é¡¹ç›®å†…éƒ¨æ²Ÿé€šæ¸ é“

---

**æœ€åæ›´æ–°**: 2025-11-25
**ç»´æŠ¤è€…**: DF Test Framework å›¢é˜Ÿ
