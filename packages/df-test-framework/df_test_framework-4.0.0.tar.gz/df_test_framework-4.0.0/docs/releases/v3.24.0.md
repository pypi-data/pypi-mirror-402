# v3.24.0 发布说明

> **发布日期**: 2025-12-14
> **Python 要求**: >= 3.12

---

## 概述

v3.24.0 里程碑版本：**Metrics 事件驱动重构** - 三大可观测性支柱全部统一到 EventBus 架构。

核心改进：
- 新增 **MetricsObserver** - 订阅 EventBus 自动收集 Prometheus 指标
- 自动收集 HTTP/Database/Cache 指标，无需手动配置
- **路径规范化** - 避免高基数指标问题
- 删除旧的 `MetricsInterceptor`，架构更简洁

---

## 架构演进

### 之前的问题（v3.10.0 - v3.23.x）

```
HttpClient ──▶ MetricsInterceptor ──▶ Prometheus
                    ↑
              (紧耦合，需手动添加拦截器)
```

**问题**：
1. 使用旧的 `BaseInterceptor` 模式，与新的中间件架构不一致
2. 没有集成 EventBus，无法与其他观察者解耦
3. 需要手动添加拦截器，容易遗漏

### 解决方案（v3.24.0）

```
HttpClient ──▶ EventBus ──▶ MetricsObserver ──▶ Prometheus
                              ↑
                    (松耦合，自动订阅)
```

**三大支柱现已全部统一**：

```
Logging ─────▶ ConsoleDebugObserver ─────▶ EventBus  ✅
Tracing ─────▶ HttpTelemetryMiddleware ──▶ EventBus  ✅
Metrics ─────▶ MetricsObserver ──────────▶ EventBus  ✅ (v3.24.0)
```

---

## 新增功能

### 1. MetricsObserver

事件驱动的指标收集器，自动订阅 EventBus 收集 Prometheus 指标。

**位置**: `infrastructure/metrics/observer.py`

```python
from df_test_framework.infrastructure.events import EventBus
from df_test_framework.infrastructure.metrics import MetricsObserver, MetricsManager

# 创建观察者
event_bus = EventBus()
metrics = MetricsManager(service_name="my-service").init()
observer = MetricsObserver(event_bus, metrics)

# HTTP 请求会自动收集指标
http_client.get("/api/users")
```

**订阅的事件**：

| 事件类型 | 收集的指标 |
|----------|-----------|
| `HttpRequestStartEvent` | `http_requests_in_flight` |
| `HttpRequestEndEvent` | `http_requests_total`, `http_request_duration_seconds` |
| `HttpRequestErrorEvent` | `http_errors_total` |
| `DatabaseQueryEndEvent` | `db_queries_total`, `db_query_duration_seconds`, `db_rows_affected` |
| `CacheOperationEndEvent` | `cache_operations_total`, `cache_hits_total`, `cache_misses_total` |

### 2. 自动收集的指标

#### HTTP 指标

```python
http_requests_total          # Counter: 请求总数（method, path, status）
http_request_duration_seconds # Histogram: 请求耗时
http_requests_in_flight      # Gauge: 进行中请求数
http_errors_total            # Counter: 错误总数
```

#### Database 指标

```python
db_queries_total             # Counter: 查询总数（operation, table, status）
db_query_duration_seconds    # Histogram: 查询耗时
db_rows_affected             # Histogram: 影响行数
```

#### Cache 指标

```python
cache_operations_total       # Counter: 操作总数（operation, status）
cache_operation_duration_seconds # Histogram: 操作耗时
cache_hits_total             # Counter: 缓存命中
cache_misses_total           # Counter: 缓存未命中
```

### 3. 路径规范化

自动规范化 URL 路径，避免高基数指标问题：

```python
# 输入 → 输出
"/api/users/12345"           → "/api/users/{id}"
"/api/users/a1b2c3d4-e5f6-..." → "/api/users/{uuid}"
"/api/users?page=1&size=10"  → "/api/users"
"/api/users/123/orders/456"  → "/api/users/{id}/orders/{id}"
```

### 4. Pytest Fixtures

```python
# Session 级别（推荐）
def test_api(http_client, metrics_observer):
    response = http_client.get("/users")
    # 指标自动收集

# 访问指标管理器
def test_custom_metrics(metrics_manager):
    counter = metrics_manager.counter("custom_total", "desc", ["label"])
    counter.labels(label="test").inc()

# 测试级别（隔离指标）
def test_isolated(http_client, test_metrics_observer):
    # 每个测试独立的指标收集
    pass
```

---

## 删除的内容

### `infrastructure/metrics/integrations/` 目录

整个目录已删除，包括：

| 文件 | 说明 |
|------|------|
| `http.py` | `MetricsInterceptor`, `HttpMetrics` |
| `database.py` | `MetricsTracedDatabase`, `DatabaseMetrics` |
| `__init__.py` | 导出文件 |

**迁移方式**：

```python
# 之前（v3.23.x）
from df_test_framework.infrastructure.metrics.integrations import MetricsInterceptor

client = HttpClient(
    base_url="...",
    interceptors=[MetricsInterceptor()],  # 手动添加
)

# 现在（v3.24.0）
def test_api(http_client, metrics_observer):
    # metrics_observer fixture 自动收集指标
    response = http_client.get("/users")
```

---

## 使用示例

### 基本使用

```python
import pytest

def test_api_with_metrics(http_client, metrics_observer):
    """指标自动收集"""
    response = http_client.get("/api/users")
    assert response.status_code == 200
    # Prometheus 指标自动收集：
    # - http_requests_total{method="GET", path="/api/users", status="200"}
    # - http_request_duration_seconds{method="GET", path="/api/users"}
```

### 数据库指标

```python
def test_db_with_metrics(database, metrics_observer):
    """数据库查询指标"""
    result = database.execute("SELECT * FROM users WHERE id = :id", {"id": 1})
    # 自动收集：
    # - db_queries_total{operation="SELECT", table="users", status="success"}
    # - db_query_duration_seconds{operation="SELECT", table="users"}
```

### 缓存指标

```python
def test_cache_with_metrics(redis_client, metrics_observer):
    """缓存操作指标"""
    redis_client.set("key", "value")
    value = redis_client.get("key")
    # 自动收集：
    # - cache_operations_total{operation="SET", status="success"}
    # - cache_hits_total (如果命中)
```

### 启动指标服务器

```python
def test_with_metrics_server(metrics_manager):
    """启动 Prometheus 抓取端点"""
    metrics_manager.start_server(port=9090)
    # 访问 http://localhost:9090/metrics 查看指标
```

---

## 配置

### 启用/禁用指标收集

通过 `ObservabilityConfig` 控制：

```python
# settings.yaml
observability:
  enabled: true  # 总开关（默认启用）
```

```bash
# 环境变量
OBSERVABILITY__ENABLED=true   # 启用（默认）
OBSERVABILITY__ENABLED=false  # 禁用所有可观测性
```

---

## 技术细节

### MetricsObserver 类

```python
class MetricsObserver:
    """指标观察者 - 订阅 EventBus 事件，收集 Prometheus 指标"""

    def __init__(
        self,
        event_bus: EventBus,
        metrics_manager: MetricsManager | None = None,
        prefix: str = "",                    # 指标名称前缀
        path_cardinality_limit: int = 100,   # 路径基数限制
    ):
        ...

    def unsubscribe(self) -> None:
        """取消订阅所有事件"""
        ...
```

### 设计原则

1. **事件驱动**：订阅 EventBus 而非使用拦截器
2. **松耦合**：能力层只发布事件，MetricsObserver 负责收集
3. **零侵入**：不修改能力层代码，只需注册观察者
4. **基数控制**：路径规范化 + 基数限制，防止指标爆炸

---

## 测试

新增 16 个测试用例：

```
tests/infrastructure/metrics/test_observer.py
├── TestMetricsObserverInit (4 tests)
├── TestMetricsObserverHttpEvents (4 tests)
├── TestMetricsObserverDatabaseEvents (1 test)
├── TestMetricsObserverCacheEvents (2 tests)
├── TestMetricsObserverUnsubscribe (1 test)
└── TestMetricsObserverPathNormalization (4 tests)

结果：9 passed, 7 skipped (prometheus_client 未安装时跳过)
```

---

## 相关文档

- [可观测性架构设计](../architecture/observability-architecture.md)
- [EventBus 集成架构分析](../architecture/eventbus-integration-analysis.md)
- [Prometheus 指标监控指南](../guides/prometheus_metrics.md)
