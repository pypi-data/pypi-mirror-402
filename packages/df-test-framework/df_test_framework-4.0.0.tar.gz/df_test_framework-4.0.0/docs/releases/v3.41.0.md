# v3.41.0 - OpenAPI 代码生成智能增强

**发布日期**: 2024-12-31

## 概述

大幅增强 OpenAPI 代码生成器的智能化程度，生成的测试代码更接近"开箱即用"状态，减少手动填充工作量。

## 核心特性

### 1. 智能请求示例生成 (P0)

**之前**：生成空占位符，需要手动填充

```python
# v3.40.0 及之前
request = {}  # TODO: 替换为 FindSupplierListRequest 模型
```

**现在**：自动识别分页、排序等常见字段，生成有意义的默认值

```python
# v3.41.0
request = FindSupplierListRequest(
    pagination={"pageSize": 10, "current": 1},
    sort_name="id",
    sort_type="desc",
)
```

### 2. 前置查询自动生成 (P0)

**问题**：详情/更新/删除接口需要有效 ID，之前生成 `id = 1` 硬编码

**解决**：自动检测操作类型，为需要 ID 的接口生成前置查询逻辑

```python
# v3.41.0 生成的 test_find_supplier_by_id
def test_find_supplier_by_id(self, supplier_controller_api):
    # Arrange - 准备测试数据
    with step("准备测试数据"):
        # 前置查询：获取有效的 id
        list_request = FindSupplierListRequest(pagination={"pageSize": 1, "current": 1})
        list_response = supplier_controller_api.find_supplier_list(list_request)
        assert_that(list_response.status).is_in("ok", "success")
        if not list_response.data or not list_response.data.get("list"):
            pytest.skip("没有可用的测试数据")
        id = list_response.data["list"][0].get("id")

        # 构造详情查询请求
        request = FindSupplierByIdRequest(id=id)

    # Act - 执行操作
    with step("调用接口"):
        response = supplier_controller_api.find_supplier_by_id(request)

    # Assert - 验证结果
    with step("验证响应"):
        assert_that(response.status).is_in("ok", "success")
        assert_that(response.data).is_not_none()
```

### 3. 中文测试标题 (P1)

**之前**：使用英文 operationId 作为标题

```python
@allure.title("Find Supplier Account List")
```

**现在**：智能生成中文标题

```python
@allure.title("查询Supplier Account List")
```

支持的操作类型映射：

| 英文前缀 | 中文 |
|----------|------|
| find/get/query | 查询 |
| add/create/insert | 新增/创建/插入 |
| update/modify/edit | 更新/修改/编辑 |
| delete/del/remove | 删除/移除 |
| export/import | 导出/导入 |
| refresh/sync | 刷新/同步 |

### 4. 智能 pytest.mark 区分 (P1)

**之前**：所有测试都标记为 `@pytest.mark.smoke`

**现在**：根据操作类型智能区分

| 操作类型 | pytest.mark | 说明 |
|----------|-------------|------|
| 列表查询 (findList) | smoke | 核心功能 |
| 详情查询 (findById) | smoke | 核心功能 |
| 创建操作 (add/create) | smoke | 核心功能 |
| 更新操作 (update/modify) | regression | 次要功能 |
| 删除操作 (delete) | regression | 次要功能 |
| 导出操作 (export) | regression | 辅助功能 |

使用示例：

```bash
pytest tests/api/test_supplier_api.py -v -k "smoke"       # 仅运行核心测试
pytest tests/api/test_supplier_api.py -v -k "regression"  # 仅运行回归测试
```

### 5. 增强列表查询断言 (P1)

**之前**：简单的非空断言

```python
assert_that(response.data).is_not_none()
# TODO: 根据实际响应结构补充更详细的断言
```

**现在**：自动验证列表结构和分页信息

```python
# 验证响应状态
assert_that(response.status).is_in("ok", "success")
# 验证列表数据结构
assert_that(response.data).is_not_none()
if "list" in response.data:
    assert_that(response.data["list"]).is_instance_of(list)
# 验证分页信息
if "pagination" in response.data:
    assert_that(response.data["pagination"]).contains_key("total")
    assert_that(response.data["pagination"]["total"]).is_greater_than_or_equal_to(0)
```

### 6. E2E 流程测试自动生成 (P2)

自动识别 CRUD 操作，生成完整流程测试：

```python
@allure.feature("supplier-controller")
@allure.story("E2E 流程测试")
class TestSupplierControllerE2E:
    """supplier-controller E2E 流程测试

    v3.41.0 自动生成：完整的 CRUD 流程测试
    """

    @allure.title("完整 CRUD 流程测试")
    @allure.severity(allure.severity_level.CRITICAL)
    @pytest.mark.e2e
    def test_crud_flow(self, supplier_controller_api, cleanup):
        """完整的创建-查询-更新-删除流程测试

        测试步骤:
        1. 创建数据
        2. 查询列表验证
        3. 查询详情验证
        4. 更新数据
        5. 删除数据
        """
        # 1. 创建数据
        with step("创建测试数据"):
            test_id = DataGenerator.test_id("E2E")
            create_request = AddSupplierRequest(...)
            create_response = supplier_controller_api.add_supplier(create_request)
            assert_that(create_response.status).is_in("ok", "success")

        # 2. 查询列表验证
        with step("查询列表验证创建成功"):
            ...

        # 3-5. 更多步骤...
```

使用示例：

```bash
pytest tests/api/test_supplier_api.py -v -k "e2e"  # 仅运行 E2E 测试
```

### 7. 负向测试自动生成 (P2)

自动生成边界条件和错误场景测试：

```python
@allure.feature("supplier-controller")
@allure.story("负向测试")
class TestSupplierControllerNegative:
    """supplier-controller 负向测试

    v3.41.0 自动生成：边界条件和错误场景测试
    """

    @allure.title("查询不存在的数据")
    @allure.severity(allure.severity_level.NORMAL)
    @pytest.mark.regression
    def test_find_non_existent(self, supplier_controller_api):
        """查询不存在的数据应返回空或错误"""
        with step("查询不存在的ID"):
            request = FindSupplierByIdRequest(id=999999999)
            response = supplier_controller_api.find_supplier_by_id(request)

        with step("验证响应"):
            assert_that(response).is_not_none()

    @allure.title("删除不存在的数据")
    @allure.severity(allure.severity_level.NORMAL)
    @pytest.mark.regression
    def test_delete_non_existent(self, supplier_controller_api):
        """删除不存在的数据应返回错误"""
        ...
```

### 8. --tags 参数增强

**之前**：只支持空格分隔

```bash
df-test gen openapi swagger.json --tags tag1 tag2 tag3
```

**现在**：同时支持逗号分隔

```bash
# 以下两种方式均可
df-test gen openapi swagger.json --tags tag1,tag2,tag3
df-test gen openapi swagger.json --tags tag1 tag2 tag3
```

### 9. 文件更新模式优化

**之前**：`--force` 完全覆盖，`--merge` 保留用户扩展

```bash
# v3.40.0 及之前
df-test gen openapi swagger.json --merge  # 保留用户扩展
df-test gen openapi swagger.json --force  # 完全覆盖
```

**现在**：更清晰的参数语义

```bash
# v3.41.0：默认只生成新文件
df-test gen openapi swagger.json

# 更新已存在文件（保留用户扩展）
df-test gen openapi swagger.json --force

# 完全覆盖（不保留用户修改）
df-test gen openapi swagger.json --force --no-merge
```

**行为对比**:

| 参数 | 行为 |
|------|------|
| (默认) | 只生成新文件，跳过已存在的文件 |
| `--force` | 更新已存在文件，保留 USER EXTENSIONS |
| `--force --no-merge` | 完全覆盖，不保留任何用户修改 |

## 使用方式

```bash
# 首次生成测试代码
uv run df-test gen from-swagger docs/api/swagger.json \
  --tags supplier-controller,order-controller \
  --output ./src

# API 变更后更新（保留用户扩展代码）
uv run df-test gen from-swagger docs/api/swagger.json \
  --tags supplier-controller \
  --force

# 完全重新生成（放弃用户修改）
uv run df-test gen from-swagger docs/api/swagger.json \
  --tags supplier-controller \
  --force --no-merge
```

## 生成的测试文件结构

```
tests/api/test_supplier_controller_api.py
├── TestSupplierControllerAPI     # 单接口测试
│   ├── test_find_supplier_list   # smoke
│   ├── test_find_supplier_by_id  # smoke（含前置查询）
│   ├── test_add_supplier         # smoke（含 cleanup）
│   ├── test_update_supplier      # regression（含前置查询）
│   └── test_delete_supplier      # regression（含前置查询）
├── TestSupplierControllerE2E     # E2E 流程测试
│   └── test_crud_flow            # e2e
└── TestSupplierControllerNegative # 负向测试
    ├── test_find_non_existent    # regression
    └── test_delete_non_existent  # regression
```

## 新增辅助函数

| 函数 | 用途 |
|------|------|
| `_is_detail_operation()` | 判断是否是详情查询操作 |
| `_is_update_operation()` | 判断是否是更新操作 |
| `_is_delete_operation()` | 判断是否是删除操作 |
| `_is_list_query_operation()` | 判断是否是列表查询操作 |
| `_needs_precondition_query()` | 判断是否需要前置查询 |
| `_find_list_endpoint()` | 查找对应的列表查询接口 |
| `_generate_request_example()` | 根据 schema 生成智能请求示例 |
| `_generate_chinese_title()` | 生成中文测试标题 |
| `_get_pytest_mark()` | 根据操作类型获取 pytest mark |
| `_build_e2e_test_class()` | 生成 E2E 测试类 |
| `_build_negative_test_class()` | 生成负向测试类 |

## 文件变更

| 操作 | 文件 |
|------|------|
| 修改 | `cli/generators/openapi_generator.py` |
| 修改 | `cli/main.py` |

## 向后兼容

- 完全向后兼容，不影响现有代码
- **重要变更**：参数语义调整
  - `--force`：现在表示"更新已存在文件并保留用户扩展"
  - `--merge` 参数已移除，改用 `--force` 实现相同效果
  - `--force --no-merge`：完全覆盖，相当于之前的 `--force`
- 生成的代码结构与之前版本一致，只是内容更完善

## 升级建议

1. 升级框架版本到 v3.41.0
2. 使用 `--merge` 模式重新生成测试代码
3. 检查生成的前置查询和断言是否符合业务需求
4. 根据需要调整 E2E 和负向测试中的 TODO 部分
