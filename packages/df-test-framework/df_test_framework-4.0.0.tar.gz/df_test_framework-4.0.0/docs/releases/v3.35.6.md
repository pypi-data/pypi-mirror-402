# v3.35.6 发布说明 - 脚手架模板增强：GraphQL 和 Redis 支持

**发布日期**: 2025-12-20

## 概述

v3.35.6 完善了脚手架模板系统，新增 GraphQL 客户端和 Redis 使用示例模板，并将所有模板同步至框架最新版本。用户现在可以通过 CLI 命令快速生成 GraphQL 和 Redis 相关的测试代码。

## 核心特性

### 1. GraphQL 客户端模板

新增完整的 GraphQL 客户端生成器模板，支持：

- Query/Mutation 示例方法
- 中间件系统（日志、重试）
- Bearer Token 认证
- 上下文管理器支持

```bash
# 生成 GraphQL 客户端
df-test gen graphql-client
```

生成的客户端示例：

```python
from df_test_framework.capabilities.clients.graphql import GraphQLClient

class MyProjectGraphQLClient:
    def __init__(self, url: str, token: str | None = None):
        self._client = GraphQLClient(
            url=url,
            middlewares=[
                GraphQLLoggingMiddleware(),
                GraphQLRetryMiddleware(max_retries=3),
            ]
        )

    def get_user(self, user_id: str) -> dict[str, Any] | None:
        query = """
            query GetUser($id: ID!) {
                user(id: $id) { id name email }
            }
        """
        response = self._client.execute(query, {"id": user_id})
        return response.data.get("user") if response.is_success else None
```

### 2. GraphQL 测试示例模板

新增完整的 GraphQL 测试示例，包含：

- Query 查询测试
- Mutation 变更测试
- 错误处理测试
- 参数化测试
- 批量操作测试

```bash
# 生成 GraphQL 测试示例
df-test gen graphql-test
```

### 3. Redis Fixture 和测试示例

新增 Redis 使用示例模板，包含：

- 会话级别 Redis 客户端 fixture
- 隔离的测试客户端（自动添加前缀，测试后自动清理）
- 字符串、哈希、列表、集合、有序集合操作示例
- 缓存场景测试示例

```bash
# 生成 Redis Fixture 和测试示例
df-test gen redis-fixture
```

生成的测试隔离示例：

```python
def test_redis_set(redis_test_client):
    # 键会自动添加测试前缀
    redis_test_client.set("user:1", "value")
    # 测试结束后自动清理
```

### 4. YAML 配置自动生成

脚手架现在自动生成 YAML 分层配置文件：

```
config/
├── base.yaml                    # 基础配置
├── environments/
│   ├── dev.yaml                 # 开发环境
│   ├── test.yaml                # 测试环境
│   ├── staging.yaml             # 预发布环境
│   ├── prod.yaml                # 生产环境
│   └── local.yaml.example       # 本地配置示例
└── secrets/
    ├── .gitkeep
    └── .env.local.example       # 敏感信息示例
```

## 模板修复

### BusinessError 使用方式

修复 `base_api.py` 模板中 BusinessError 的使用方式，改用关键字参数：

```python
# 修复前
raise BusinessError(message, code, response_data)

# 修复后
raise BusinessError(message=message, code=code, data=response_data)
```

### 类型注解更新

更新 `api_client.py` 模板中的类型注解为 Python 3.12+ 风格：

```python
# 修复前
from typing import Any, Dict, List
def get_user(self, user_id: int) -> Dict[str, Any]:

# 修复后
from typing import Any
def get_user(self, user_id: int) -> dict[str, Any]:
```

### .gitignore 更新

新增 YAML 配置排除规则：

```gitignore
# YAML 配置（v3.35.0+）
config/environments/local.yaml
config/secrets/
!config/secrets/.gitkeep
```

### UI conftest 修复

移除不必要的 fixture 导入（已由 pytest_plugins 自动提供）。

## 新增 CLI 命令

| 命令 | 说明 |
|------|------|
| `df-test gen graphql-client` | 生成 GraphQL 客户端类 |
| `df-test gen graphql-test` | 生成 GraphQL 测试示例 |
| `df-test gen redis-fixture` | 生成 Redis Fixture 和测试示例 |

## 文件变更

### 新增文件

- `src/df_test_framework/cli/templates/generators/graphql_client.py`
- `src/df_test_framework/cli/templates/generators/test_graphql.py`
- `src/df_test_framework/cli/templates/generators/redis_example.py`

### 修改文件

- `src/df_test_framework/cli/commands/generate_cmd.py` - 新增生成命令
- `src/df_test_framework/cli/commands/init_cmd.py` - 新增 YAML 配置生成
- `src/df_test_framework/cli/templates/__init__.py` - 导出新模板
- `src/df_test_framework/cli/templates/generators/__init__.py` - 导出新模板
- `src/df_test_framework/cli/templates/generators/api_client.py` - 类型注解修复
- `src/df_test_framework/cli/templates/project/base_api.py` - BusinessError 修复
- `src/df_test_framework/cli/templates/project/enhanced_gitignore.py` - YAML 配置排除
- `src/df_test_framework/cli/templates/project/ui_conftest.py` - 移除不必要导入
- 多个模板文件版本号更新

## 测试

- 60 个 CLI 测试全部通过
- 3 个测试跳过（需要外部服务）

## 升级指南

此版本为向后兼容的功能增强，无需特殊升级步骤。

### 使用新功能

1. 在现有项目中生成 GraphQL 客户端：
   ```bash
   df-test gen graphql-client
   ```

2. 生成 Redis 测试示例：
   ```bash
   df-test gen redis-fixture
   ```

3. 新项目自动获得 YAML 配置支持：
   ```bash
   df-test init my-project
   ```
