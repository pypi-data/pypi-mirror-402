# v3.22.0 å‘å¸ƒè¯´æ˜

> **å‘å¸ƒæ—¥æœŸ**: 2025-12-13
> **Python è¦æ±‚**: >= 3.12

---

## æ¦‚è¿°

v3.22.0 é‡å¤§æ›´æ–°ï¼š**HTTP å¯è§‚æµ‹æ€§å¢å¼º** + **ç°ä»£åŒ–è°ƒè¯•å·¥å…·**ã€‚

æ ¸å¿ƒæ”¹è¿›ï¼š
- Allure æŠ¥å‘Šç°åœ¨è®°å½•**å®Œæ•´çš„è¯·æ±‚å¤´**ï¼ˆåŒ…æ‹¬ä¸­é—´ä»¶æ·»åŠ çš„ Authorizationã€ç­¾åç­‰ï¼‰
- æ–°å¢ **GET è¯·æ±‚å‚æ•° (params)** è®°å½•
- å…¨æ–°çš„ **ConsoleDebugObserver** - å½©è‰²ã€ç»“æ„åŒ–çš„æ§åˆ¶å°è°ƒè¯•è¾“å‡º
- æ–°çš„è°ƒè¯• fixturesï¼š`console_debugger`ã€`http_debugger`ã€`debug_mode`

---

## é—®é¢˜èƒŒæ™¯

### ä¹‹å‰çš„é—®é¢˜

1. **Allure è¯·æ±‚å¤´ä¸ºç©º**
   - äº‹ä»¶åœ¨ä¸­é—´ä»¶æ‰§è¡Œ**ä¹‹å‰**å‘å¸ƒ
   - ä¸­é—´ä»¶æ·»åŠ çš„ headersï¼ˆAuthorizationã€ç­¾åç­‰ï¼‰æ²¡æœ‰è¢«è®°å½•

2. **GET å‚æ•°ç¼ºå¤±**
   - `HttpRequestStartEvent` æ²¡æœ‰ `params` å­—æ®µ

3. **è°ƒè¯•å·¥å…·ä¸æ˜“ç”¨**
   - ç°æœ‰çš„ `HTTPDebugger` éœ€è¦æ‰‹åŠ¨é›†æˆ
   - æ²¡æœ‰ fixture æ”¯æŒ

### è§£å†³æ–¹æ¡ˆ

åˆ›å»º `HttpEventPublisherMiddleware`ï¼ˆpriority=999ï¼‰ï¼Œåœ¨ä¸­é—´ä»¶é“¾çš„æœ€å†…å±‚å‘å¸ƒäº‹ä»¶ï¼Œç¡®ä¿èƒ½è®°å½•åˆ°æ‰€æœ‰ä¸­é—´ä»¶ä¿®æ”¹åçš„å®Œæ•´ä¿¡æ¯ã€‚

---

## æ–°å¢åŠŸèƒ½

### 1. `HttpEventPublisherMiddleware`

æ–°çš„äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°æ¯ä¸ª HttpClientã€‚

```python
# è‡ªåŠ¨å¯ç”¨ï¼ˆé»˜è®¤ï¼‰
client = HttpClient(base_url="https://api.example.com")

# ç¦ç”¨äº‹ä»¶å‘å¸ƒï¼ˆå¦‚éœ€è¦ï¼‰
client = HttpClient(
    base_url="https://api.example.com",
    enable_event_publisher=False,
)
```

**å·¥ä½œåŸç†**ï¼š

```
è¯·æ±‚æµç¨‹ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰ï¼š

BearerToken.before â†’ Signature.before â†’ EventPublisher.before
                                              â†“
                                        å‘å¸ƒ StartEventï¼ˆæ­¤æ—¶ headers å®Œæ•´ï¼‰
                                              â†“
                                         send_request
                                              â†“
                                        å‘å¸ƒ EndEvent
                                              â†“
BearerToken.after  â† Signature.after  â† EventPublisher.after
```

### 2. `HttpRequestStartEvent.params`

äº‹ä»¶æ¨¡å‹æ–°å¢ `params` å­—æ®µï¼Œè®°å½• GET è¯·æ±‚å‚æ•°ã€‚

```python
# ç°åœ¨ Allure æŠ¥å‘ŠåŒ…å«ï¼š
{
    "event_id": "evt-abc123",
    "method": "GET",
    "url": "/users",
    "headers": {
        "Authorization": "Bearer xxx...",  # âœ… ä¸­é—´ä»¶æ·»åŠ çš„
        "Content-Type": "application/json"
    },
    "params": {                            # âœ… æ–°å¢
        "page": 1,
        "limit": 10
    },
    "body": null
}
```

### 3. `ConsoleDebugObserver`

ç°ä»£åŒ–çš„æ§åˆ¶å°è°ƒè¯•å™¨ï¼ŒåŸºäº EventBus äº‹ä»¶é©±åŠ¨ã€‚

**ç‰¹æ€§**ï¼š
- å½©è‰²è¾“å‡ºï¼ˆè‡ªåŠ¨æ£€æµ‹ç»ˆç«¯æ”¯æŒï¼‰
- ç»“æ„åŒ–çš„è¯·æ±‚/å“åº”æ˜¾ç¤º
- è‡ªåŠ¨è„±æ•æ•æ„Ÿä¿¡æ¯ï¼ˆTokenã€å¯†ç ç­‰ï¼‰
- å¯é…ç½®æ˜¾ç¤ºé€‰é¡¹

```python
# æ–¹å¼1ï¼šé€šè¿‡ fixtureï¼ˆæ¨èï¼‰
def test_api(http_client, console_debugger):
    response = http_client.get("/users")
    # æ§åˆ¶å°è‡ªåŠ¨è¾“å‡ºå½©è‰²è°ƒè¯•ä¿¡æ¯

# æ–¹å¼2ï¼šæ‰‹åŠ¨åˆ›å»º
from df_test_framework.testing.debugging import ConsoleDebugObserver
from df_test_framework.infrastructure.events import get_event_bus

observer = ConsoleDebugObserver(
    show_headers=True,
    show_body=True,
    max_body_length=500,
)
observer.subscribe(get_event_bus())

# ... æ‰§è¡Œè¯·æ±‚ ...

observer.unsubscribe()
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŒ GET /users
  Headers:
    Authorization: Bearer abc1****xyz9
    Content-Type: application/json
  Params:
    page: 1
    limit: 10
  âœ… 200 (145.32ms)
  Response:
    {
      "users": [...],
      "total": 100
    }
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### 4. è°ƒè¯• Fixtures

æ–°å¢ä¸‰ä¸ª pytest fixturesï¼š

```python
# console_debugger - å½©è‰²æ§åˆ¶å°è°ƒè¯•
def test_api(http_client, console_debugger):
    response = http_client.get("/users")

# http_debugger - ä¼ ç»Ÿè°ƒè¯•å™¨ï¼ˆæ‰“å°æ‘˜è¦ï¼‰
def test_api(http_client, http_debugger):
    response = http_client.get("/users")
    http_debugger.print_summary()

# debug_mode - ä¾¿æ·è°ƒè¯•æ¨¡å¼
@pytest.mark.usefixtures("debug_mode")
def test_api(http_client):
    response = http_client.get("/users")
```

---

## API å˜æ›´

### HttpClient

æ–°å¢å‚æ•°ï¼š

```python
def __init__(
    self,
    base_url: str,
    ...,
    enable_event_publisher: bool = True,  # ğŸ†• v3.22.0
):
    """
    Args:
        enable_event_publisher: æ˜¯å¦å¯ç”¨äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶ï¼ˆé»˜è®¤ Trueï¼‰
    """
```

### HttpRequestStartEvent

æ–°å¢å­—æ®µï¼š

```python
@dataclass(frozen=True)
class HttpRequestStartEvent(CorrelatedEvent):
    method: str = ""
    url: str = ""
    headers: dict[str, str] = field(default_factory=dict)
    params: dict[str, Any] = field(default_factory=dict)  # ğŸ†• v3.22.0
    body: str | None = None
```

---

## è¿ç§»æŒ‡å—

### ä» v3.21.0 å‡çº§

**æ— éœ€ä»£ç ä¿®æ”¹**ï¼Œæ–°åŠŸèƒ½è‡ªåŠ¨å¯ç”¨ã€‚

å¦‚æœä½ ä¹‹å‰æœ‰è‡ªå®šä¹‰çš„äº‹ä»¶å‘å¸ƒé€»è¾‘ï¼Œå¯èƒ½éœ€è¦ï¼š

```python
# å¦‚æœä¸éœ€è¦äº‹ä»¶å‘å¸ƒï¼ˆé¿å…é‡å¤ï¼‰
client = HttpClient(
    base_url="...",
    enable_event_publisher=False,
)
```

### ä½¿ç”¨æ–°çš„è°ƒè¯•åŠŸèƒ½

```python
# ä¹‹å‰ï¼ˆv3.21.0ï¼‰
# éœ€è¦æ‰‹åŠ¨åˆ›å»ºå’Œé›†æˆè°ƒè¯•å™¨

# ç°åœ¨ï¼ˆv3.22.0ï¼‰
def test_api(http_client, console_debugger):
    response = http_client.get("/users")
    # è‡ªåŠ¨è¾“å‡ºè°ƒè¯•ä¿¡æ¯
```

---

## å˜æ›´åˆ—è¡¨

### æ–°å¢

- `HttpEventPublisherMiddleware` - ä¸­é—´ä»¶é“¾å†…éƒ¨çš„äº‹ä»¶å‘å¸ƒå™¨
- `HttpRequestStartEvent.params` - GET è¯·æ±‚å‚æ•°å­—æ®µ
- `ConsoleDebugObserver` - ç°ä»£åŒ–æ§åˆ¶å°è°ƒè¯•å™¨
- `console_debugger` fixture - æ§åˆ¶å°è°ƒè¯•
- `http_debugger` fixture - HTTP è°ƒè¯•
- `debug_mode` fixture - è°ƒè¯•æ¨¡å¼
- `HttpClient.enable_event_publisher` - äº‹ä»¶å‘å¸ƒå¼€å…³

### ä¿®å¤

- **Allure è¯·æ±‚å¤´ä¸ºç©º** - ç°åœ¨è®°å½•å®Œæ•´çš„ headers
- **ä¸­é—´ä»¶æ·»åŠ çš„ headers ä¸å¯è§** - äº‹ä»¶å‘å¸ƒç§»è‡³ä¸­é—´ä»¶é“¾å†…éƒ¨

### æ–‡æ¡£

- `docs/releases/v3.22.0.md` - æœ¬å‘å¸ƒè¯´æ˜

---

## ç›¸å…³æ–‡æ¡£

- [ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—](../guides/middleware_guide.md)
- [Allure æŠ¥å‘ŠæŒ‡å—](../guides/allure_guide.md)
- [è®¤è¯ä¸ Session ç®¡ç†æŒ‡å—](../guides/auth_session_guide.md)
