# v3.27.0 发布说明 - 调试系统统一与 pytest 集成

> **发布日期**: 2025-12-14
> **Python 要求**: >= 3.12

---

## 概述

v3.27.0 统一了调试系统架构，让 ConsoleDebugObserver 与 pytest 日志系统无缝集成，并将旧版 HTTPDebugger 标记为废弃。

---

## 背景

在 v3.26.0 完成 loguru → logging 桥接后，审查发现 `ConsoleDebugObserver` 直接输出到 `sys.stderr`，绕过了日志桥接系统，可能导致调试输出与测试名称混行。

本版本通过自动检测 pytest 模式，让调试输出也走 loguru → logging 桥接路径。

---

## 新增功能

### 1. ConsoleDebugObserver pytest 模式

自动检测 pytest 环境，切换输出路径：

```python
from df_test_framework.testing.debugging import ConsoleDebugObserver

# 自动检测 pytest 模式
observer = ConsoleDebugObserver()

# pytest 模式下：输出通过 loguru → logging 桥接 → pytest caplog
# 正常模式下：直接输出到 sys.stderr（保持彩色）
```

### 2. `use_pytest_bridge` 参数

手动控制输出路径：

```python
# 强制使用桥接（即使不在 pytest 环境）
observer = ConsoleDebugObserver(use_pytest_bridge=True)

# 强制直接输出（即使在 pytest 环境）
observer = ConsoleDebugObserver(use_pytest_bridge=False)

# 自动检测（默认）
observer = ConsoleDebugObserver(use_pytest_bridge=None)
```

---

## 废弃公告

### HTTPDebugger 已废弃

`HTTPDebugger` 类已标记为废弃，将在未来版本移除。

**迁移指南**：

```python
# ❌ 旧方式（已废弃）
from df_test_framework.testing.debugging import HTTPDebugger

debugger = HTTPDebugger()
debugger.start()
debugger.log_request("GET", "/api/users")
debugger.log_response(200, {"id": 1})
debugger.print_summary()

# ✅ 新方式（推荐）
from df_test_framework.testing.debugging import ConsoleDebugObserver
from df_test_framework.infrastructure.events import get_event_bus

observer = ConsoleDebugObserver()
observer.subscribe(get_event_bus())

# 执行 HTTP 请求，调试信息自动输出
http_client.get("/api/users")

observer.unsubscribe()
```

**或通过 fixture 使用**：

```python
def test_api(http_client, console_debugger):
    response = http_client.get("/api/users")
    # 调试信息自动输出
```

---

## 技术实现

### pytest 模式检测

```python
def __init__(self, ..., use_pytest_bridge: bool | None = None):
    if use_pytest_bridge is None:
        from df_test_framework.infrastructure.logging.logger import is_pytest_mode
        use_pytest_bridge = is_pytest_mode()
    self.use_pytest_bridge = use_pytest_bridge
```

### 输出路径切换

```python
def _output(self, text: str) -> None:
    if self.use_pytest_bridge:
        # pytest 模式：通过 loguru 桥接
        logger.opt(raw=True, depth=1).info(text + "\n")
    else:
        # 正常模式：直接输出
        print(text, file=sys.stderr)
```

---

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        v3.27.0 调试输出路径                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ConsoleDebugObserver                                                       │
│          │                                                                  │
│          ├─── pytest 模式 ───► loguru ───► _loguru_sink ───► logging       │
│          │                                                    │            │
│          │                                                    ▼            │
│          │                                              pytest caplog      │
│          │                                                                  │
│          └─── 正常模式 ────► sys.stderr (彩色输出)                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 变更列表

### 新增

- `ConsoleDebugObserver.use_pytest_bridge` 参数
- `create_console_debugger(use_pytest_bridge=...)` 参数

### 变更

- `ConsoleDebugObserver._output()` - 支持 pytest 模式桥接输出

### 废弃

- `HTTPDebugger` 类 - 推荐使用 `ConsoleDebugObserver`

### 文档

- `docs/architecture/observability-debugging-unification.md` - 设计文档
- `docs/releases/v3.27.0.md` - 本发布说明

---

## 向后兼容性

- ✅ ConsoleDebugObserver API 完全兼容
- ✅ HTTPDebugger 仍可使用（仅显示警告）
- ✅ fixture 行为不变

---

## 相关文档

- [可观测性与调试系统统一设计](../architecture/observability-debugging-unification.md)
- [可观测性架构设计](../architecture/observability-architecture.md)
- [pytest 日志集成指南](../guides/logging_pytest_integration.md)
