# v3.38.10 - 两步登录支持 + Discriminated Union

**发布日期**: 2025-12-30

## 概述

v3.38.10 新增两步登录 Token 提供器支持，并引入 Pydantic v2 Discriminated Union 类型实现中间件配置的类型安全。

## 主要变更

### 1. TwoStepLoginTokenProvider

新增 `TwoStepLoginTokenProvider` 类，支持 check → login 两步登录流程：

```python
from df_test_framework.capabilities.clients.http.middleware.auth import TwoStepLoginTokenProvider

provider = TwoStepLoginTokenProvider(
    login_url="/admin/login/token",
    credentials={"username": "admin", "password": "pass", "smsCode": "123456"},
    check_url="/admin/login/check",  # 可选，先调用 check 再调用 login
    status_ok_values=("ok", "success"),  # 支持多种成功状态值
)

token = await provider.get_token(http_client)
```

**特性**：
- 两步登录：先调用 `check_url`（可选），再调用 `login_url`
- JSON 字符串 data：自动解析 `data` 字段为 JSON 字符串的情况
- 可配置状态值：支持 `"ok"`、`"success"` 等不同的成功状态值

**响应格式支持**：

```json
{
    "status": "ok",
    "msg": "操作成功",
    "data": "{\"access_token\":\"xxx\",\"token_type\":\"bearer\"}"
}
```

### 2. TokenSource.TWO_STEP_LOGIN

新增 `TokenSource.TWO_STEP_LOGIN` 枚举值：

```python
from df_test_framework.infrastructure.config import TokenSource

# 配置两步登录
middleware_config = BearerTokenMiddlewareConfig(
    source=TokenSource.TWO_STEP_LOGIN,
    login_url="/admin/login/token",
    check_url="/admin/login/check",
    username="admin",
    password="password",
    extra_credentials={"smsCode": "123456"},
)
```

### 3. BearerTokenMiddlewareConfig 扩展

`BearerTokenMiddlewareConfig` 新增两步登录专用配置字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `check_url` | `str \| None` | 检查接口 URL（可选） |
| `check_credentials` | `dict \| None` | check 请求凭据 |
| `extra_credentials` | `dict \| None` | 额外凭据（如 smsCode） |
| `status_ok_values` | `tuple[str, ...]` | 成功状态值列表 |
| `token_key` | `str` | Token 字段名（默认 `access_token`） |
| `status_field` | `str` | 状态字段名（默认 `status`） |
| `data_field` | `str` | 数据字段名（默认 `data`） |

### 4. MiddlewareConfigUnion

新增 Pydantic v2 Discriminated Union 类型，实现类型安全的中间件配置：

```python
from df_test_framework.infrastructure.config import MiddlewareConfigUnion

# 类型安全的中间件配置列表
middlewares: list[MiddlewareConfigUnion] = [
    SignatureMiddlewareConfig(algorithm=SignatureAlgorithm.MD5, secret="xxx"),
    BearerTokenMiddlewareConfig(source=TokenSource.STATIC, token="yyy"),
    RetryMiddlewareConfig(max_retries=3),
]
```

使用 `type` 字段作为 discriminator：

```python
# 每个配置类都有 type 字段
class SignatureMiddlewareConfig(BaseMiddlewareConfig):
    type: Literal["signature"] = "signature"

class BearerTokenMiddlewareConfig(BaseMiddlewareConfig):
    type: Literal["bearer_token"] = "bearer_token"
```

## 影响的文件

- `src/df_test_framework/capabilities/clients/http/middleware/__init__.py`
- `src/df_test_framework/capabilities/clients/http/middleware/auth.py`
- `src/df_test_framework/capabilities/clients/http/middleware/factory.py`
- `src/df_test_framework/capabilities/clients/http/rest/httpx/client.py`
- `src/df_test_framework/infrastructure/config/__init__.py`
- `src/df_test_framework/infrastructure/config/middleware_schema.py`
- `src/df_test_framework/infrastructure/config/schema.py`

## 测试

- `tests/infrastructure/config/test_middleware_schema.py` - 新增中间件配置测试
- `tests/integration/test_middleware_chain.py` - 新增集成测试

## 升级指南

无破坏性变更，新功能为可选。如需使用两步登录：

1. 将 `source` 设置为 `TokenSource.TWO_STEP_LOGIN`
2. 配置 `check_url` 和 `extra_credentials`（如需要）