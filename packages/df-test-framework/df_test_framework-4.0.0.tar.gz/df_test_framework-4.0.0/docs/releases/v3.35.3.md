# v3.35.3 发布说明 - 方案A最佳实现：LayeredYamlSettingsSource

**发布日期**: 2025-12-19

## 概述

v3.35.3 实现方案A的最佳实现：创建 `LayeredYamlSettingsSource` 继承 `PydanticBaseSettingsSource`，完全融入 pydantic-settings 原生配置源体系。

## 核心变更

### 新增 LayeredYamlSettingsSource

创建自定义配置源类，继承 `PydanticBaseSettingsSource`：

```python
from pydantic_settings import PydanticBaseSettingsSource

class LayeredYamlSettingsSource(PydanticBaseSettingsSource):
    """分层 YAML 配置源

    继承 PydanticBaseSettingsSource，实现分层 YAML 配置加载：
    - base.yaml（基础配置）
    - environments/{env}.yaml（环境配置）
    - 支持 _extends 继承语法
    """

    def __init__(
        self,
        settings_cls: type[BaseSettings],
        config_dir: Path,
        env: str,
    ) -> None:
        super().__init__(settings_cls)
        self.config_dir = config_dir
        self.env = env

    def get_field_value(self, field: FieldInfo, field_name: str) -> tuple[Any, str, bool]:
        return None, field_name, False

    def __call__(self) -> dict[str, Any]:
        # 加载 base.yaml + environments/{env}.yaml
        config = self._load_yaml(self.config_dir / "base.yaml")
        env_config = self._load_env_yaml()
        config = self._deep_merge(config, env_config)
        config["env"] = self.env
        return config
```

### 配置源集成

在 `settings_customise_sources` 中将 `LayeredYamlSettingsSource` 与其他配置源组合：

```python
@classmethod
def settings_customise_sources(
    cls,
    settings_cls: type[BaseSettings],
    init_settings: PydanticBaseSettingsSource,
    env_settings: PydanticBaseSettingsSource,
    dotenv_settings: PydanticBaseSettingsSource,
    file_secret_settings: PydanticBaseSettingsSource,
) -> tuple[PydanticBaseSettingsSource, ...]:
    yaml_source = LayeredYamlSettingsSource(
        settings_cls=settings_cls,
        config_dir=config_dir,
        env=env,
    )
    # 优先级：环境变量 > .env.local > YAML
    return (
        env_settings,
        dotenv_settings,
        yaml_source,
    )
```

## 架构优势

### 完全融入 pydantic-settings 体系

| 对比项 | v3.35.2 | v3.35.3 |
|-------|---------|---------|
| YAML 加载 | 手动加载，通过 init_settings 传入 | 自定义配置源，原生集成 |
| 配置源组合 | 混合方式 | 纯 pydantic-settings 方式 |
| 可扩展性 | 有限 | 可继承 LayeredYamlSettingsSource |
| 代码风格 | 过程式 | 面向对象 |

### 配置优先级（不变）

```
1. 环境变量（最高优先级）
2. config/secrets/.env.local
3. config/environments/{env}.yaml
4. config/base.yaml
5. 代码默认值（最低优先级）
```

## 代码变更

### ConfigLoader 简化

```python
class ConfigLoader:
    def load(self, env: str | None = None) -> FrameworkSettings:
        env = env or os.getenv("ENV", "test")
        base_class = self.settings_class or FrameworkSettings

        # 创建动态配置类并实例化（无需手动加载 YAML）
        settings_class = _create_settings_class(
            base_class=base_class,
            config_dir=self.config_dir,
            secrets_dir=self.secrets_dir,
            env=env,
        )
        return settings_class()
```

### 移除的代码

- ConfigLoader 不再有 `_cache` 属性（缓存移到 LayeredYamlSettingsSource）
- ConfigLoader 不再有 `_load_yaml_config`、`_load_env_yaml` 方法
- ConfigLoader 不再有 `clear_cache` 方法

## 修改文件清单

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `infrastructure/config/loader.py` | 重构 | 新增 LayeredYamlSettingsSource |
| `tests/infrastructure/config/test_loader.py` | 更新 | 移除缓存测试，更新 TestDeepMerge |
| `pyproject.toml` | 版本 | 3.35.2 → 3.35.3 |
| `__init__.py` | 版本 | 3.35.2 → 3.35.3 |

## 升级指南

### 从 v3.35.2 升级

**完全向后兼容**，无需修改任何代码。

### 注意事项

- `ConfigLoader._cache` 和 `ConfigLoader.clear_cache()` 已移除
- 如需访问配置源，使用 `LayeredYamlSettingsSource`

## 测试结果

```bash
uv run pytest tests/infrastructure/config/ -v
# 结果: 67 passed
```

## 导出新类

```python
from df_test_framework.infrastructure.config.loader import (
    ConfigLoader,
    LayeredYamlSettingsSource,  # 新增
    load_config,
)
```
