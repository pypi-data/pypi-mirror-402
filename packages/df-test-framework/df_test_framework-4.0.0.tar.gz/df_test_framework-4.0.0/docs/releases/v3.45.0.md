# v3.45.0 发布说明

> **发布日期**: 2026-01-13
> **主题**: @actions_class 装饰器 - Web UI 测试架构统一

---

## 核心特性

v3.45.0 引入 `@actions_class` 装饰器，实现 Web UI 测试与 HTTP 测试架构的完全统一。

### HTTP 与 UI 架构一致性

| 维度 | HTTP 测试 | UI 测试 |
|------|-----------|---------|
| **装饰器** | `@api_class()` | `@actions_class()` |
| **基类** | `BaseAPI` | `AppActions` |
| **自动加载** | `load_api_fixtures()` | `load_actions_fixtures()` |
| **配置字段** | `test.apis_package` | `test.actions_package` |
| **目录** | `apis/` | `actions/` |
| **默认 scope** | `session` | `function` |

---

## 新增功能

### 1. @actions_class 装饰器

自动将 UI Actions 类注册为 pytest fixture：

```python
from df_test_framework.capabilities.drivers.web import AppActions
from df_test_framework.testing.decorators import actions_class


@actions_class()  # 自动命名为 login_actions
class LoginActions(AppActions):
    """登录相关业务操作"""

    def login_as_admin(self):
        self.goto("/login")
        self.page.get_by_label("Username").fill("admin")
        self.page.get_by_label("Password").fill("admin123")
        self.page.get_by_role("button", name="Sign in").click()
        self.page.get_by_test_id("user-menu").wait_for()

    def logout(self):
        self.page.get_by_test_id("user-menu").click()
        self.page.get_by_role("menuitem", name="Logout").click()
```

### 2. load_actions_fixtures() 函数

自动发现并加载所有 `@actions_class` 装饰的类：

```python
# tests/conftest.py
from df_test_framework.testing.decorators import load_actions_fixtures

def _get_actions_package() -> str:
    default_package = "my_project.actions"
    try:
        from df_test_framework.infrastructure.config import get_config
        config = get_config()
        return config.get("test", ).get("actions_package") or default_package
    except Exception:
        return default_package

load_actions_fixtures(globals(), actions_package=_get_actions_package())
```

### 3. 配置系统扩展

新增 `actions_package` 配置字段：

```yaml
# config/base.yaml
test:
  apis_package: my_project.apis        # HTTP API 自动发现
  actions_package: my_project.actions  # UI Actions 自动发现
```

### 4. 脚手架更新

UI 和 Full 项目类型现在生成完整的三层架构：

```bash
df-test init my-project --type ui
```

生成结构：
```
src/my_project/
├── actions/                # @actions_class 自动注册
│   ├── login_actions.py
│   └── user_actions.py
├── pages/                  # 页面对象（可选）
│   ├── home_page.py
│   └── login_page.py
├── components/             # 可复用组件（可选）
│   └── header.py
└── config/
    └── settings.py         # 包含 WebConfig
```

### 5. Full 项目类型增强

Full 项目现在使用合并的 conftest.py，同时支持 API 和 UI 测试：

```python
# tests/conftest.py (Full 项目)
from df_test_framework.testing.decorators import load_api_fixtures, load_actions_fixtures

# 自动加载 HTTP API
load_api_fixtures(globals(), apis_package=_get_apis_package())

# 自动加载 UI Actions
load_actions_fixtures(globals(), actions_package=_get_actions_package())
```

---

## 测试中使用

```python
import pytest

@pytest.mark.ui
def test_login(login_actions):
    """login_actions 由 @actions_class 自动注册"""
    login_actions.login_as_admin()
    assert login_actions.page.get_by_test_id("user-menu").is_visible()


@pytest.mark.ui
def test_user_management(login_actions, user_actions):
    """组合使用多个 Actions"""
    login_actions.login_as_admin()
    user_id = user_actions.create_user("john", "john@example.com")
    assert user_id
```

---

## 三层架构模式

v3.45.0 推荐的 UI 测试架构：

```
App Actions (业务操作)  ← 封装完整业务流程，使用 @actions_class 装饰器
    ↓
Components (可复用组件) ← 封装 UI 组件（表单、导航栏等）
    ↓
Playwright API (直接使用) ← 不过度封装，直接使用语义化定位
```

### 定位器优先级

| 优先级 | 方法 | 示例 |
|--------|------|------|
| **1** | `get_by_test_id()` | `get_by_test_id("submit-btn")` ✅ 最稳定 |
| **2** | `get_by_role()` | `get_by_role("button", name="Submit")` |
| **3** | `get_by_label()` | `get_by_label("Username")` |
| **4** | `get_by_text()` | `get_by_text("Welcome")` |
| **5** | `locator()` | `locator("#username")` ⚠️ CSS/XPath |

---

## 新增文件

### 框架代码

| 文件 | 说明 |
|------|------|
| `testing/decorators/actions_class.py` | @actions_class 装饰器实现 |
| `cli/templates/project/full_conftest.py` | Full 项目合并 conftest 模板 |
| `cli/templates/project/full_settings.py` | Full 项目合并 settings 模板 |

### 测试

| 文件 | 说明 |
|------|------|
| `tests/testing/decorators/test_actions_class.py` | 25 个测试用例 |

---

## 配置变更

### WebConfig 配置

```bash
# .env 或环境变量
WEB__BASE_URL=https://example.com
WEB__BROWSER_TYPE=chromium
WEB__HEADLESS=true
WEB__TIMEOUT=30000
WEB__VIEWPORT__width=1280
WEB__VIEWPORT__height=720
```

### YAML 配置

```yaml
# config/base.yaml
web:
  base_url: https://example.com
  browser_type: chromium
  headless: true
  timeout: 30000
  viewport:
    width: 1280
    height: 720

test:
  actions_package: my_project.actions
```

---

## 迁移指南

### 从旧版 POM 迁移

**旧方式**（v3.44.0 之前）：
```python
# 手动创建页面对象
class LoginPage(BasePage):
    def login(self, username, password):
        self.fill("#username", username)
        self.fill("#password", password)
        self.click("#submit")

# 手动定义 fixture
@pytest.fixture
def login_page(page, base_url):
    return LoginPage(page, base_url=base_url)
```

**新方式**（v3.45.0）：
```python
# 使用 @actions_class 自动注册
@actions_class()
class LoginActions(AppActions):
    def login_as_admin(self):
        self.goto("/login")
        self.page.get_by_label("Username").fill("admin")
        self.page.get_by_label("Password").fill("admin123")
        self.page.get_by_role("button", name="Sign in").click()

# 测试中直接使用
def test_login(login_actions):  # 自动注入
    login_actions.login_as_admin()
```

---

## 相关文档

- [Web UI 测试使用手册](../guides/web-ui-testing.md)
- [脚手架 CLI 工具指南](../guides/scaffold_cli_guide.md)
- [v3.44.0 发布说明](v3.44.0.md) - 事件驱动架构
- [v3.43.0 发布说明](v3.43.0.md) - 现代 UI 测试最佳实践
- [v3.42.0 发布说明](v3.42.0.md) - 配置驱动模式
