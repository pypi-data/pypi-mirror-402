# v3.30.0 发布说明

**发布日期**: 2025-12-16

## 概述

v3.30.0 版本增强了断言能力，新增独立的 JSON Schema 验证器和丰富的自定义匹配器。

### 核心改进

1. **SchemaValidator** - 独立的 JSON Schema 验证器，支持文件加载和预定义 Schema
2. **自定义匹配器** - 15+ 匹配器类，支持组合、取反、操作符重载
3. **预定义 Schema** - 常用业务 Schema 模板（id、email、phone_cn、pagination 等）

## 新功能

### 1. JSON Schema 验证器

独立的 Schema 验证工具，比 `ResponseAssertions.assert_json_schema()` 更灵活。

#### 基本用法

```python
from df_test_framework.testing.assertions import (
    SchemaValidator,
    assert_schema,
    SchemaValidationError,
)

# 定义 Schema
schema = {
    "type": "object",
    "required": ["id", "name"],
    "properties": {
        "id": {"type": "integer", "minimum": 1},
        "name": {"type": "string", "minLength": 1},
        "email": {"type": "string", "format": "email"},
    },
}

# 方式1: 使用 SchemaValidator 类
validator = SchemaValidator(schema)
validator.validate({"id": 1, "name": "Alice"})  # 通过
validator.is_valid({"id": -1})  # False，不抛异常

# 方式2: 使用快捷函数
assert_schema({"id": 1, "name": "Alice"}, schema)

# 方式3: 验证 HTTP 响应
from df_test_framework.testing.assertions import validate_response_schema
validate_response_schema(response, schema)
```

#### 从文件加载 Schema

```python
# 从 JSON 文件加载
validator = SchemaValidator.from_file("schemas/user.json")

# 从 YAML 文件加载
validator = SchemaValidator.from_file("schemas/user.yaml")

# 从字符串加载
validator = SchemaValidator.from_string('{"type": "string"}', format="json")
```

#### 获取详细错误信息

```python
validator = SchemaValidator({"type": "object", "required": ["a", "b", "c"]})

# 获取错误列表（不抛异常）
errors = validator.get_errors({})
for error in errors:
    print(f"路径: {error['path']}, 消息: {error['message']}")

# 捕获详细错误
try:
    validator.validate({})
except SchemaValidationError as e:
    print(f"错误数量: {len(e.errors)}")
    print(f"原始数据: {e.data}")
    print(f"Schema: {e.schema}")
```

#### Schema 构建器

```python
from df_test_framework.testing.assertions import (
    create_object_schema,
    create_array_schema,
    COMMON_SCHEMAS,
)

# 创建对象 Schema
user_schema = create_object_schema(
    properties={
        "id": COMMON_SCHEMAS["id"],
        "name": {"type": "string"},
        "email": COMMON_SCHEMAS["email"],
        "phone": COMMON_SCHEMAS["phone_cn"],
    },
    required=["id", "name"],
)

# 创建数组 Schema
users_schema = create_array_schema(
    items=user_schema,
    min_items=1,
    unique_items=True,
)
```

#### 预定义 Schema

```python
from df_test_framework.testing.assertions import COMMON_SCHEMAS

# 可用的预定义 Schema
COMMON_SCHEMAS["id"]              # 正整数 ID
COMMON_SCHEMAS["uuid"]            # UUID 格式
COMMON_SCHEMAS["email"]           # 邮箱格式
COMMON_SCHEMAS["datetime"]        # ISO 日期时间
COMMON_SCHEMAS["date"]            # ISO 日期
COMMON_SCHEMAS["url"]             # URL 格式
COMMON_SCHEMAS["phone_cn"]        # 中国手机号
COMMON_SCHEMAS["non_empty_string"]  # 非空字符串
COMMON_SCHEMAS["positive_number"]   # 正数
COMMON_SCHEMAS["non_negative_number"]  # 非负数
COMMON_SCHEMAS["pagination"]      # 分页响应
COMMON_SCHEMAS["api_response"]    # API 标准响应
```

### 2. 自定义匹配器

灵活的值匹配工具，支持组合和链式调用。

#### 基础匹配器

```python
from df_test_framework.testing.assertions import (
    matches_regex,
    contains,
    in_range,
    equals,
    is_type,
    has_length,
    starts_with,
    ends_with,
    greater_than,
    less_than,
)

# 正则匹配
assert matches_regex(r"^TEST_\d+$").matches("TEST_123")

# 包含匹配
assert contains("@").matches("test@example.com")
assert contains(2).matches([1, 2, 3])
assert contains("key").matches({"key": "value"})

# 范围匹配
assert in_range(1, 100).matches(50)
assert in_range(1, 100, inclusive=False).matches(50)  # 不包含边界

# 类型匹配
assert is_type(str).matches("hello")
assert is_type(int, float).matches(3.14)  # 多类型

# 长度匹配
assert has_length(exact=5).matches("hello")
assert has_length(min_len=1, max_len=10).matches("test")

# 比较匹配
assert greater_than(0).matches(1)
assert less_than(100, or_equal=True).matches(100)

# 前后缀匹配
assert starts_with("http").matches("https://example.com")
assert ends_with(".json").matches("config.json")
```

#### 组合匹配器

```python
from df_test_framework.testing.assertions import (
    all_of,
    any_of,
    not_matcher,
    is_string,
    is_none,
)

# 全部满足（AND）
matcher = all_of(
    is_type(str),
    has_length(min_len=3),
    matches_regex(r"^[A-Z]"),
)
assert matcher.matches("Hello")

# 任一满足（OR）
matcher = any_of(
    equals(None),
    is_type(str),
)
assert matcher.matches(None)
assert matcher.matches("hello")

# 取反（NOT）
not_empty = not_matcher(has_length(exact=0))
assert not_empty.matches("hello")
```

#### 操作符重载

```python
from df_test_framework.testing.assertions import is_string, is_none, has_length

# & 操作符（AND）
matcher = is_string & has_length(min_len=3)
assert matcher.matches("hello")

# | 操作符（OR）
matcher = is_none | is_string
assert matcher.matches(None)
assert matcher.matches("hello")

# ~ 操作符（NOT）
not_none = ~is_none
assert not_none.matches("value")

# 复杂组合
matcher = (is_string & has_length(min_len=3)) | is_none
assert matcher.matches("hello")
assert matcher.matches(None)
assert not matcher.matches("hi")
```

#### 预定义匹配器实例

```python
from df_test_framework.testing.assertions import (
    # 值匹配
    is_none, is_not_none,
    is_true, is_false,
    is_empty, is_not_empty,
    # 类型匹配
    is_string, is_int, is_float, is_number,
    is_bool, is_list, is_dict, is_date,
)

# 直接使用
assert is_none.matches(None)
assert is_not_empty.matches([1, 2, 3])
assert is_string.matches("hello")
assert is_number.matches(3.14)
assert is_date.matches(datetime.now())
```

#### 断言方法

```python
from df_test_framework.testing.assertions import is_string

# 使用 assert_matches 方法
is_string.assert_matches("hello")  # 通过

# 自定义错误消息
is_string.assert_matches(123, message="用户名必须是字符串")  # AssertionError
```

#### 自定义谓词

```python
from df_test_framework.testing.assertions import predicate

# 自定义验证逻辑
is_even = predicate(lambda x: x % 2 == 0, "是偶数")
assert is_even.matches(4)
assert not is_even.matches(3)

# 复杂业务逻辑
is_valid_order = predicate(
    lambda o: o.get("status") in ["pending", "paid"] and o.get("amount") > 0,
    "是有效订单",
)
```

## 依赖变更

### 新增依赖

```toml
# pyproject.toml
dependencies = [
    "jsonpath-ng>=1.7.0",  # 新增 - JSONPath 查询支持
]
```

## 文件变更

### 新增文件

- `src/df_test_framework/testing/assertions/json_schema.py` - Schema 验证器
- `src/df_test_framework/testing/assertions/matchers.py` - 自定义匹配器
- `tests/testing/assertions/__init__.py` - 测试模块
- `tests/testing/assertions/test_json_schema.py` - Schema 验证器测试（27 个测试）
- `tests/testing/assertions/test_matchers.py` - 匹配器测试（58 个测试）
- `docs/releases/v3.30.0.md` - 本发布说明

### 修改文件

- `pyproject.toml` - 版本号更新，新增 jsonpath-ng 依赖
- `src/df_test_framework/__init__.py` - 版本号更新
- `src/df_test_framework/testing/assertions/__init__.py` - 导出新模块
- `CHANGELOG.md` - 添加版本记录

## 兼容性

- **Python**: 3.12+
- **向后兼容**: 完全兼容，无破坏性变更
- **ResponseAssertions**: 原有功能保持不变

## 测试结果

- 新增测试: 85 个
- 总测试: 1472 passed, 40 skipped
- 覆盖率: ≥80%

## 相关文档

- [五层架构设计](../architecture/OVERVIEW_V3.17.md)
- [v3.29.0 发布说明](./v3.29.0.md) - Factory 模式和 utils 重构
