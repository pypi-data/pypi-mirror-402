# DF Test Framework v3.12.1 Release Notes

发布日期: 2025-12-02

---

## 版本概述

### 统一测试数据保留配置

v3.12.1 改进了测试数据保留的配置机制，让 `should_keep_test_data()` 支持从 Settings 读取配置，UoW 和 CleanupManager 共享统一的配置检查逻辑。

#### 核心改进

- ✅ **Settings 配置支持**: `TestExecutionConfig` 新增 `keep_test_data` 字段
- ✅ **统一配置检查**: `should_keep_test_data()` 改用 `get_settings()` 读取配置
- ✅ **UoW 统一**: `uow` fixture 改用 `should_keep_test_data()` 统一检查
- ✅ **代码简化**: 移除直接的 `os.getenv("KEEP_TEST_DATA")` 调用

---

## 变更详解

### 1. 配置优先级

测试数据保留配置支持三种方式，优先级从高到低：

| 优先级 | 方式 | 用法 | 说明 |
|-------|-----|------|------|
| 1 | 测试标记 | `@pytest.mark.keep_data` | 单个测试保留数据 |
| 2 | 命令行参数 | `pytest --keep-test-data` | 整个测试会话保留数据 |
| 3 | Settings 配置 | `.env` 中配置 | 本地开发默认保留数据 |

### 2. Settings 配置方式

**方式 1: `.env` 文件配置（推荐用于本地开发）**

```env
# .env 文件
TEST__KEEP_TEST_DATA=1
```

> 注意：使用双下划线 `__` 表示嵌套配置（`test.keep_test_data`）

**方式 2: 环境变量**

```bash
# 系统环境变量需要 APP_ 前缀
export APP_TEST__KEEP_TEST_DATA=1
```

### 3. 代码变更

#### TestExecutionConfig 新增字段

```python
# infrastructure/config/schema.py
class TestExecutionConfig(BaseModel):
    keep_test_data: bool = Field(
        default=False,
        description="保留测试数据（不清理）",
    )
```

#### should_keep_test_data() 统一检查

```python
# testing/fixtures/cleanup.py
def should_keep_test_data(request: pytest.FixtureRequest) -> bool:
    # 1. 检查测试标记（最高优先级）
    if request.node.get_closest_marker("keep_data"):
        return True

    # 2. 检查命令行参数
    if hasattr(request.config.option, "keep_test_data") and request.config.option.keep_test_data:
        return True

    # 3. 从 Settings 读取配置
    try:
        settings = get_settings()
        if settings and settings.test and settings.test.keep_test_data:
            return True
    except Exception:
        pass

    return False
```

#### UoW fixture 使用统一检查

```python
# testing/fixtures/core.py
from .cleanup import should_keep_test_data

# v3.12.1: 使用统一的 should_keep_test_data() 检查配置
auto_commit = should_keep_test_data(request)
if auto_commit:
    logger.info("检测到保留数据配置，测试数据将被提交")
```

---

## 使用场景

### 场景 1: 本地开发调试

在项目根目录创建 `.env` 文件：

```env
# .env
TEST__KEEP_TEST_DATA=1
```

这样本地开发时测试数据默认保留，方便调试。

### 场景 2: CI 环境清理数据

CI 环境不设置 `KEEP_TEST_DATA`，测试数据自动清理。

### 场景 3: 单个测试保留数据

```python
@pytest.mark.keep_data
def test_debug_specific_case():
    """这个测试的数据会被保留"""
    ...
```

---

## 迁移指南

### 从 v3.12.0 升级

无需代码变更，新增配置方式向后兼容。

### 从 v3.11.x 升级

如果之前使用 `os.getenv("KEEP_TEST_DATA")` 直接检查环境变量，建议改用：

```python
# 旧方式（仍可工作，但不推荐）
if os.getenv("KEEP_TEST_DATA"):
    ...

# 新方式（推荐）
from df_test_framework import should_keep_test_data

if should_keep_test_data(request):
    ...
```

---

## 测试结果

- 全部 **1198 个测试通过**
- 新增 5 个配置优先级测试

---

## 相关文档

- [测试数据清理指南](../guides/test_data_cleanup.md)
- [CHANGELOG](../../CHANGELOG.md)
