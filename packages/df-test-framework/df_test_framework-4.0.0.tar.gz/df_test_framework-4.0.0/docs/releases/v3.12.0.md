# DF Test Framework v3.12.0 Release Notes

å‘å¸ƒæ—¥æœŸ: 2025-12-02

---

## ğŸ‰ ç‰ˆæœ¬æ¦‚è¿°

### ğŸ—ï¸ Testing æ¨¡å—æ¶æ„é‡æ„ - åŸºäº V3 æ¶æ„è®¾è®¡ä¼˜åŒ–

v3.12.0 æ˜¯ä¸€ä¸ªé‡è¦çš„**æ¶æ„ä¼˜åŒ–ç‰ˆæœ¬**ï¼ŒåŸºäº V3 æ¶æ„è®¾è®¡åŸåˆ™å¯¹ `testing` æ¨¡å—è¿›è¡Œäº†å…¨é¢é‡ç»„ã€‚

#### æ ¸å¿ƒæ”¹è¿›

- âœ… **Allure å­ç³»ç»Ÿ**: åˆ›å»º `testing/reporting/allure/` éæ‰å¹³ç›®å½•ç»“æ„
- âœ… **è°ƒè¯•å·¥å…·ç»Ÿä¸€**: é‡ç»„ `testing/debugging/` æ¨¡å—
- âœ… **åˆ†å±‚å½’ä½**: è¿ç§» `TracingInterceptor` åˆ° `infrastructure/tracing/interceptors/`
- âœ… **ä»£ç æ¸…ç†**: åˆ é™¤åˆ†æ•£çš„ `testing/observers/` ç›®å½•
- âœ… **AllureObserver å¢å¼º**: ä¿®å¤å¹¶å‘è¯·æ±‚æ”¯æŒã€å¼‚å¸¸å®‰å…¨ã€æ–°å¢ GraphQL/gRPC åè®®æ”¯æŒ
- âœ… **gRPC è¿½è¸ªæ‹¦æˆªå™¨**: æ–°å¢ `GrpcTracingInterceptor` åˆ†å¸ƒå¼è¿½è¸ªæ”¯æŒ

---

## âœ¨ å˜æ›´è¯¦è§£

### 1. Allure æŠ¥å‘Šå­ç³»ç»Ÿé‡ç»„

å°†åˆ†æ•£åœ¨ä¸‰ä¸ªç›®å½•çš„ Allure ä»£ç æ•´åˆä¸ºå®Œæ•´å­ç³»ç»Ÿï¼š

**ä¹‹å‰ï¼ˆåˆ†æ•£ï¼‰**:
```
testing/
â”œâ”€â”€ observers/allure_observer.py   # AllureObserver
â”œâ”€â”€ plugins/allure.py              # AllureHelperï¼ˆåç§°è¯¯å¯¼ï¼‰
â””â”€â”€ fixtures/allure.py             # pytest fixtures
```

**ä¹‹åï¼ˆèŒè´£åˆ†ç¦»ï¼‰**:
```
testing/
â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ allure.py           # pytest fixtureï¼ˆè–„åŒ…è£…å±‚ï¼‰
â””â”€â”€ reporting/allure/
    â”œâ”€â”€ observer.py         # AllureObserverï¼ˆä¸ä¾èµ– pytestï¼‰
    â”œâ”€â”€ helper.py           # AllureHelperï¼ˆä¸ä¾èµ– pytestï¼‰
    â””â”€â”€ __init__.py         # ç»Ÿä¸€å¯¼å‡º
```

**æ–°å¯¼å…¥è·¯å¾„**:
```python
# æ ¸å¿ƒå®ç°ï¼ˆä¸ä¾èµ– pytestï¼Œå¯ç‹¬ç«‹æµ‹è¯•ï¼‰
from df_test_framework.testing.reporting.allure import (
    AllureObserver,
    AllureHelper,
    attach_json,
    attach_log,
    step,
)

# pytest fixtureï¼ˆé€šè¿‡ pytest_plugins åŠ è½½ï¼‰
pytest_plugins = ["df_test_framework.testing.fixtures.allure"]
```

### 2. è°ƒè¯•å·¥å…·æ¨¡å—ç»Ÿä¸€

å°† Debug ç›¸å…³ä»£ç æ•´åˆåˆ° `testing/debugging/`ï¼š

**ä¹‹å‰ï¼ˆåˆ†æ•£ï¼‰**:
```
testing/
â”œâ”€â”€ debug/
â”‚   â”œâ”€â”€ http_debugger.py
â”‚   â””â”€â”€ db_debugger.py
â””â”€â”€ plugins/
    â””â”€â”€ debug.py           # DebugPluginï¼ˆçœŸæ­£çš„ pytest æ’ä»¶ï¼‰
```

**ä¹‹åï¼ˆèŒè´£åˆ†ç¦»ï¼‰**:
```
testing/
â”œâ”€â”€ plugins/
â”‚   â””â”€â”€ debug.py         # DebugPluginï¼ˆpytest æ’ä»¶ï¼‰
â””â”€â”€ debugging/
    â”œâ”€â”€ http.py          # HTTPDebuggerï¼ˆä¸ä¾èµ– pytestï¼‰
    â”œâ”€â”€ database.py      # DBDebuggerï¼ˆä¸ä¾èµ– pytestï¼‰
    â””â”€â”€ __init__.py      # ç»Ÿä¸€å¯¼å‡º
```

**æ–°å¯¼å…¥è·¯å¾„**:
```python
# è°ƒè¯•å™¨ï¼ˆä¸ä¾èµ– pytestï¼Œå¯ç‹¬ç«‹æµ‹è¯•ï¼‰
from df_test_framework.testing.debugging import (
    HTTPDebugger,
    DBDebugger,
    enable_http_debug,
    disable_http_debug,
    enable_db_debug,
    disable_db_debug,
)

# pytest æ’ä»¶
from df_test_framework.testing.plugins import DebugPlugin
```

### 3. TracingInterceptor å½’ä½

å°† HTTP è¿½è¸ªæ‹¦æˆªå™¨ç§»è‡³æ­£ç¡®çš„åŸºç¡€è®¾æ–½å±‚ï¼š

**ä¹‹å‰**:
```
clients/http/interceptors/tracing.py   # âŒ Layer 1ï¼ˆèƒ½åŠ›å±‚ï¼‰
```

**ä¹‹å**:
```
infrastructure/tracing/interceptors/http.py   # âœ… Layer 2ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
```

**æ–°å¯¼å…¥è·¯å¾„**:
```python
from df_test_framework.infrastructure.tracing.interceptors import TracingInterceptor
```

### 4. AllureObserver å¢å¼º

ä¿®å¤å¤šä¸ªå…³é”®é—®é¢˜å¹¶æ–°å¢åè®®æ”¯æŒï¼š

| ä¼˜å…ˆçº§ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-------|------|---------|
| P0 | å¹¶å‘è¯·æ±‚ä¸Šä¸‹æ–‡è¢«è¦†ç›– | ä½¿ç”¨ `dict[str, StepContext]` å­˜å‚¨å¤šä¸ªä¸Šä¸‹æ–‡ |
| P0 | æ‰‹åŠ¨ `__enter__/__exit__` ä¸å®‰å…¨ | ä½¿ç”¨ `ExitStack` ç¡®ä¿ä¸Šä¸‹æ–‡æ­£ç¡®å…³é—­ |
| P1 | ä¸æ”¯æŒ GraphQL/gRPC | æ–°å¢ `on_graphql_*` å’Œ `on_grpc_*` æ–¹æ³• |
| P2 | æˆªæ–­é•¿åº¦ç¡¬ç¼–ç  | æ–°å¢å¯é…ç½®å‚æ•° `max_body_length` ç­‰ |

**æ–°å¢æ–¹æ³•**:
```python
# GraphQL æ”¯æŒ
observer.on_graphql_request_start(operation_name, operation_type, query, variables)
observer.on_graphql_request_end(graphql_id, data, errors, duration_ms)

# gRPC æ”¯æŒ
observer.on_grpc_call_start(service, method, request_type, metadata)
observer.on_grpc_call_end(grpc_id, status_code, status_message, duration_ms)

# å¯é…ç½®æˆªæ–­
observer = AllureObserver(
    test_name="test",
    max_body_length=2000,   # é»˜è®¤ 1000
    max_value_length=1000,  # é»˜è®¤ 500
    max_sql_length=5000,    # é»˜è®¤ 2000
)
```

### 5. gRPC è¿½è¸ªæ‹¦æˆªå™¨ï¼ˆæ–°å¢ï¼‰

æ–°å¢ `GrpcTracingInterceptor` ä¸º gRPC è¯·æ±‚æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªæ”¯æŒï¼š

```python
from df_test_framework.infrastructure.tracing.interceptors import GrpcTracingInterceptor

# åŸºç¡€ç”¨æ³•
interceptor = GrpcTracingInterceptor()
client.add_interceptor(interceptor)

# è‡ªå®šä¹‰é…ç½®
interceptor = GrpcTracingInterceptor(
    record_metadata=True,      # è®°å½•å…ƒæ•°æ®
    propagate_context=True,    # ä¼ æ’­è¿½è¸ªä¸Šä¸‹æ–‡
    sensitive_keys=["authorization"],  # æ•æ„Ÿé”®è„±æ•
)
```

**è¿½è¸ªå±æ€§**:
- `rpc.system`: "grpc"
- `rpc.service`: æœåŠ¡åç§°
- `rpc.method`: æ–¹æ³•åç§°
- `rpc.grpc.status_code`: gRPC çŠ¶æ€ç 
- `rpc.request.duration_ms`: è¯·æ±‚è€—æ—¶

---

## ğŸ—‘ï¸ ç§»é™¤å†…å®¹

| æ—§è·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|-------|-------|------|
| `testing/observers/` | `testing/reporting/allure/` | ç›®å½•åˆ é™¤ |
| `testing/plugins/allure.py` | `testing/reporting/allure/helper.py` | ç§»åŠ¨ |
| `testing/fixtures/debug.py` | åˆ é™¤ | æ­»ä»£ç  |
| `testing/fixtures/ui_fixtures.py` | `testing/fixtures/ui.py` | é‡å‘½å |
| `clients/http/interceptors/tracing.py` | `infrastructure/tracing/interceptors/http.py` | ç§»åŠ¨ |

---

## ğŸ“Š æµ‹è¯•éªŒè¯

- **æµ‹è¯•æ€»æ•°**: 1134 ä¸ª
- **é€šè¿‡**: 1134 ä¸ª
- **è·³è¿‡**: 5 ä¸ªï¼ˆå¤–éƒ¨æœåŠ¡ä¾èµ–ï¼‰
- **å¤±è´¥**: 0 ä¸ª

---

## ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„

```
testing/
â”œâ”€â”€ fixtures/                     # ğŸ—ï¸ Pytest fixturesï¼ˆä¾èµ– pytestï¼‰
â”‚   â”œâ”€â”€ core.py                   # æ ¸å¿ƒ fixtures
â”‚   â”œâ”€â”€ allure.py                 # Allure fixtureï¼ˆè–„åŒ…è£…å±‚ï¼‰
â”‚   â”œâ”€â”€ cleanup.py                # æ•°æ®æ¸…ç†
â”‚   â””â”€â”€ ui.py                     # UI æµ‹è¯• fixtures
â”œâ”€â”€ plugins/                      # ğŸ”Œ Pytest æ’ä»¶ï¼ˆä¾èµ– pytestï¼‰
â”‚   â”œâ”€â”€ markers.py                # ç¯å¢ƒæ ‡è®°
â”‚   â”œâ”€â”€ debug.py                  # è°ƒè¯•æ’ä»¶
â”‚   â””â”€â”€ api_autodiscovery.py      # API è‡ªåŠ¨å‘ç°
â”œâ”€â”€ reporting/                    # ğŸ“Š æµ‹è¯•æŠ¥å‘Šï¼ˆä¸ä¾èµ– pytestï¼‰
â”‚   â””â”€â”€ allure/                   # Allure å­ç³»ç»Ÿ
â”‚       â”œâ”€â”€ observer.py
â”‚       â””â”€â”€ helper.py
â”œâ”€â”€ debugging/                    # ğŸ› è°ƒè¯•å·¥å…·ï¼ˆä¸ä¾èµ– pytestï¼‰
â”‚   â”œâ”€â”€ http.py
â”‚   â””â”€â”€ database.py
â”œâ”€â”€ mocking/                      # ğŸ­ Mock å·¥å…·
â”œâ”€â”€ data/                         # ğŸ“¦ æµ‹è¯•æ•°æ®
â””â”€â”€ ...

infrastructure/tracing/
â”œâ”€â”€ interceptors/                 # âœ… è¿½è¸ªæ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ http.py                  # HTTP è¿½è¸ª
â”‚   â””â”€â”€ grpc.py                  # gRPC è¿½è¸ªï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ integrations/
â””â”€â”€ ...
```

### èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | ä¾èµ– pytest |
|-----|------|-----------|
| `fixtures/` | pytest fixture å®šä¹‰ | âœ… æ˜¯ |
| `plugins/` | pytest hooks/markers | âœ… æ˜¯ |
| `reporting/allure/` | Allure è§‚å¯Ÿè€…ã€å·¥å…·ç±» | âŒ å¦ |
| `debugging/` | è°ƒè¯•å™¨å®ç° | âŒ å¦ |

---

## ğŸ”„ å‡çº§æŒ‡å—

### æ›´æ–°å¯¼å…¥è·¯å¾„

å¦‚æœæ‚¨çš„ä»£ç ä½¿ç”¨äº†ä»¥ä¸‹æ—§è·¯å¾„ï¼Œè¯·æ›´æ–°ï¼š

```python
# âŒ æ—§è·¯å¾„
from df_test_framework.testing.observers.allure_observer import AllureObserver
from df_test_framework.testing.plugins.allure import AllureHelper
from df_test_framework.testing.debug import enable_http_debug
from df_test_framework.clients.http.interceptors.tracing import TracingInterceptor

# âœ… æ–°è·¯å¾„
from df_test_framework.testing.reporting.allure import AllureObserver, AllureHelper
from df_test_framework.testing.debugging import enable_http_debug
from df_test_framework.testing.plugins import DebugPlugin
from df_test_framework.infrastructure.tracing.interceptors import TracingInterceptor
```

### æ›´æ–° pytest_plugins

```python
# âŒ æ—§è·¯å¾„
pytest_plugins = ["df_test_framework.testing.reporting.allure.fixtures"]
pytest_plugins = ["df_test_framework.testing.fixtures.ui_fixtures"]

# âœ… æ–°è·¯å¾„
pytest_plugins = ["df_test_framework.testing.fixtures.allure"]
pytest_plugins = ["df_test_framework.testing.fixtures.ui"]
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ](../architecture/TESTING_MODULE_OPTIMIZATION.md) - è¯¦ç»†è®¾è®¡æ–‡æ¡£
- [åˆ†å¸ƒå¼è¿½è¸ªæŒ‡å—](../guides/distributed_tracing.md) - TracingInterceptor ä½¿ç”¨æŒ‡å—
