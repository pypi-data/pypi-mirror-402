# v3.35.0 发布说明 - 环境管理

**发布日期**: 2025-12-18

## 概述

v3.35.0 引入完整的环境管理系统，支持 YAML 分层配置、配置继承、统一配置访问。向后兼容 .env 文件模式。

## 核心特性

### 1. 多环境配置加载

基于 pydantic-settings 原生支持，实现多环境配置文件加载。

```python
from df_test_framework.infrastructure.config import FrameworkSettings

# 加载 staging 环境配置
# 加载顺序：.env → .env.staging → 环境变量
settings = FrameworkSettings.for_environment("staging")

print(settings.env)  # "staging"
print(settings.http.base_url)  # 来自 .env.staging
```

### 2. YAML 分层配置

支持 `config/base.yaml` + `config/environments/{env}.yaml` 分层配置结构。

```yaml
# config/base.yaml - 基础配置（所有环境共享）
http:
  timeout: 30
  max_retries: 3
  verify_ssl: true

logging:
  level: INFO

observability:
  enabled: true
  allure_recording: true
```

```yaml
# config/environments/staging.yaml - 环境配置
_extends: base.yaml

env: staging
debug: false

http:
  base_url: "https://staging-api.example.com"
  timeout: 60  # 覆盖 base.yaml 中的配置

logging:
  level: DEBUG
```

**配置目录结构**:
```
config/
├── base.yaml              # 基础配置（所有环境共享）
├── environments/
│   ├── local.yaml         # 本地开发环境
│   ├── dev.yaml           # 开发环境
│   ├── test.yaml          # 测试环境
│   ├── staging.yaml       # 预发布环境
│   └── prod.yaml          # 生产环境
└── secrets/               # 敏感配置（.gitignore）
    └── .env.local         # 本地敏感配置
```

### 3. 配置继承（_extends）

环境配置可以继承基础配置，使用 `_extends` 字段指定父配置。

```yaml
# config/environments/staging.yaml
_extends: base.yaml  # 继承 base.yaml

env: staging
http:
  base_url: "https://staging-api.example.com"
```

### 4. ConfigRegistry 单例

提供统一的配置访问入口，支持点号路径访问。

```python
from df_test_framework.infrastructure.config import ConfigRegistry

# 方式1: 初始化全局单例
ConfigRegistry.initialize("staging", "config")
registry = ConfigRegistry.get_instance()

# 方式2: 为指定环境创建（不影响全局单例）
registry = ConfigRegistry.for_environment("staging", "config")

# 点号路径访问
timeout = registry.get("http.timeout")  # 60
base_url = registry.get("http.base_url")  # "https://staging-api.example.com"
nonexistent = registry.get("foo.bar", "default")  # "default"

# 快捷属性访问
registry.http.timeout
registry.logging.level
registry.observability.enabled

# 环境判断
registry.current_env  # "staging"
registry.is_debug     # False
registry.is_local     # False
registry.is_prod      # False
```

### 5. ConfigLoader

底层配置加载器，支持 YAML 分层配置、继承、深度合并。

```python
from df_test_framework.infrastructure.config import ConfigLoader, load_config

# 使用 ConfigLoader
loader = ConfigLoader(config_dir="config")
settings = loader.load("staging")

# 使用便捷函数
settings = load_config("staging", "config")
```

**配置优先级（从高到低）**:
1. 环境变量
2. `config/secrets/.env.local`
3. `config/environments/{env}.yaml`
4. `config/base.yaml`
5. `.env` + `.env.{env}`（回退模式）
6. 代码默认值

### 6. EnvLiteral 扩展

```python
# v3.35.0: 新增 "local" 环境类型
EnvLiteral = Literal["local", "dev", "test", "staging", "prod"]

# 新增 is_local 属性
if settings.is_local:
    print("本地开发环境")
```

### 7. CLI 命令

```bash
# 初始化配置目录结构
df-test env init

# 显示当前配置
df-test env show
df-test env show --env=staging

# 验证配置完整性
df-test env validate --env=staging

# 使用自定义配置目录
df-test env show --config-dir=my_config
```

### 8. Pytest 参数

```bash
# 指定环境运行测试
pytest tests/ --env=staging

# 指定配置目录
pytest tests/ --env=staging --config-dir=my_config
```

**新增 Fixtures**:

```python
def test_example(config_registry, settings, current_env):
    # config_registry: ConfigRegistry 实例
    timeout = config_registry.get("http.timeout")

    # settings: FrameworkSettings 实例
    assert settings.env == "staging"

    # current_env: 环境名称字符串
    if current_env == "prod":
        pytest.skip("跳过生产环境")
```

**配置 pytest 插件**:
```python
# conftest.py
pytest_plugins = [
    "df_test_framework.testing.plugins.env_plugin",
]
```

## 新增 API

### ConfigRegistry

| 方法/属性 | 描述 |
|----------|------|
| `initialize(env, config_dir)` | 类方法，初始化全局单例 |
| `get_instance()` | 类方法，获取全局单例 |
| `for_environment(env, config_dir)` | 类方法，为指定环境创建实例 |
| `reset()` | 类方法，重置全局单例（用于测试） |
| `is_initialized()` | 类方法，检查是否已初始化 |
| `settings` | 属性，获取 FrameworkSettings 对象 |
| `current_env` | 属性，获取当前环境名称 |
| `get(path, default)` | 方法，按点号路径获取配置值 |
| `http`, `db`, `redis`, `storage`, `test`, `logging`, `observability` | 快捷属性 |
| `is_debug`, `is_local`, `is_prod` | 环境判断属性 |

### ConfigLoader

| 方法 | 描述 |
|------|------|
| `__init__(config_dir, secrets_dir)` | 初始化加载器 |
| `load(env)` | 加载指定环境配置 |
| `clear_cache()` | 清除配置缓存 |

### FrameworkSettings

| 方法/属性 | 描述 |
|----------|------|
| `for_environment(env)` | 类方法，为指定环境创建配置对象 |
| `is_local` | 属性，判断是否为本地环境 |

### 便捷函数

| 函数 | 描述 |
|------|------|
| `load_config(env, config_dir)` | 加载配置的便捷函数 |

### CLI 命令

| 命令 | 描述 |
|------|------|
| `df-test env init` | 初始化配置目录结构 |
| `df-test env show [--env=ENV]` | 显示环境配置 |
| `df-test env validate [--env=ENV]` | 验证配置完整性 |

### Pytest Fixtures

| Fixture | 作用域 | 描述 |
|---------|--------|------|
| `config_registry` | session | ConfigRegistry 实例 |
| `settings` | session | FrameworkSettings 实例 |
| `current_env` | session | 当前环境名称 |

## 向后兼容

v3.35.0 完全向后兼容。

- 如果 `config/` 目录不存在或没有 `base.yaml`，自动回退到 `.env` 文件模式
- 现有使用 `FrameworkSettings.for_environment()` 的代码无需修改
- `--env` pytest 参数继续工作

## 迁移指南

### 从 v3.34.x 升级

v3.35.0 完全向后兼容，无需修改现有代码。

**可选迁移**（推荐）:

1. 运行 `df-test env init` 创建配置目录结构
2. 将 `.env` 配置迁移到 `config/base.yaml`
3. 将 `.env.{env}` 配置迁移到 `config/environments/{env}.yaml`
4. 在代码中使用 `ConfigRegistry` 统一访问配置

**迁移示例**:

```python
# v3.34.x 方式（继续工作）
from df_test_framework.infrastructure.config import FrameworkSettings
settings = FrameworkSettings.for_environment("staging")

# v3.35.0 推荐方式
from df_test_framework.infrastructure.config import ConfigRegistry
ConfigRegistry.initialize("staging")
registry = ConfigRegistry.get_instance()
timeout = registry.get("http.timeout")
```

## 测试覆盖

- 新增 44 个单元测试
- 覆盖 ConfigLoader 和 ConfigRegistry 的所有功能
- 全部测试通过（1534 passed）

## 依赖变更

无新增依赖。

## 相关文档

- [ROADMAP](../architecture/ROADMAP_V3.29_ENHANCEMENTS.md) - v3.35.0 设计文档
