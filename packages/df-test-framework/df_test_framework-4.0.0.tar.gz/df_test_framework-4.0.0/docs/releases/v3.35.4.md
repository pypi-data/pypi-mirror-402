# v3.35.4 发布说明 - 配置加载最佳实践重构

**发布日期**: 2025-12-19

## 概述

v3.35.4 按照 pydantic-settings 最佳实践完全重构配置加载，使用内置 `YamlConfigSettingsSource`，移除 `_extends` 继承语法。

## 核心变更

### 使用内置 YamlConfigSettingsSource

```python
def load_config(env: str | None = None, config_dir: str | Path = "config") -> FrameworkSettings:
    yaml_files = [config_dir / "base.yaml"]
    env_file = config_dir / "environments" / f"{env}.yaml"
    if env_file.exists():
        yaml_files.append(env_file)

    class _Settings(FrameworkSettings):
        model_config = SettingsConfigDict(
            yaml_file=yaml_files,
            env_nested_delimiter="__",
            nested_model_default_partial_update=True,
        )

        @classmethod
        def settings_customise_sources(cls, settings_cls, init_settings,
                                        env_settings, dotenv_settings, ...):
            return (
                env_settings,
                dotenv_settings,
                YamlConfigSettingsSource(settings_cls),
                init_settings,
            )

    return _Settings(env=env)
```

### 移除 _extends 继承语法

**原因**：`load_config` 已内置 base.yaml + env.yaml 双层合并，`_extends` 是多余的。

**迁移**：
```yaml
# 旧方式（v3.35.x）
_extends: base.yaml
env: test
http:
  base_url: "https://api.example.com"

# 新方式（v3.35.4）- 移除 _extends，load_config 自动合并 base.yaml
env: test
http:
  base_url: "https://api.example.com"
```

## 配置优先级

```
1. 环境变量（最高）
2. config/secrets/.env.local
3. config/environments/{env}.yaml
4. config/base.yaml
5. 代码默认值（最低）
```

### YAML 文件合并行为

**重要**：pydantic-settings 的 YAML 文件合并是**对象级别替换**，而非深度合并。

```yaml
# base.yaml
db:
  host: localhost
  port: 3306

# environments/staging.yaml
db:
  host: staging-db.example.com
  # 必须显式指定 port，否则会使用 schema 默认值
  port: 3306
```

环境变量与 YAML 配置**支持深度合并**（通过 `nested_model_default_partial_update=True`）：

```bash
# 环境变量只覆盖指定字段，其他字段保留 YAML 配置值
export DB__PASSWORD=secret
# db.host, db.port 仍从 YAML 读取
```

## 代码统计

| 指标 | v3.35.x | v3.35.4 |
|-----|---------|---------|
| loader.py 行数 | ~300 行 | ~100 行 |
| 自定义配置源 | LayeredYamlSettingsSource | 无（使用内置） |
| _extends 支持 | 是 | 否（移除） |

## 修改文件

| 文件 | 说明 |
|-----|------|
| `infrastructure/config/loader.py` | 简化为 ~100 行 |
| `tests/infrastructure/config/test_loader.py` | 移除 _extends 相关测试 |
| `gift-card-test/config/environments/*.yaml` | 移除 _extends |

## 升级指南

### 配置文件迁移

1. 移除所有 `_extends: xxx` 行
2. **重要**：环境配置中的嵌套对象需要包含所有必需字段（YAML 合并是对象级别替换）

```yaml
# ❌ 错误：只写覆盖字段会丢失 base.yaml 中的其他字段
db:
  host: "prod-db.example.com"
  # port, pool_size, charset 丢失！

# ✅ 正确：包含所有必需字段
db:
  host: "prod-db.example.com"
  port: 3306
  name: "prod_db"
  user: "app_user"
  pool_size: 10
  charset: utf8mb4
  # password 从环境变量 DB__PASSWORD 读取（环境变量支持深度合并）
```

### API 变更

- `ConfigLoader` 类已移除（无向后兼容）
- 使用 `load_config()` 函数替代

```python
# 旧方式（v3.35.x）
from df_test_framework.infrastructure.config import ConfigLoader
loader = ConfigLoader("config")
settings = loader.load("staging")

# 新方式（v3.35.4）
from df_test_framework.infrastructure.config import load_config
settings = load_config("staging", "config")
```

## 测试结果

```
62 passed
```
