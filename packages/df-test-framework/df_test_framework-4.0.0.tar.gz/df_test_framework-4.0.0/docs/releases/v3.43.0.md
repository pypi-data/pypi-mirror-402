# v3.43.0 - 现代UI测试最佳实践

**发布日期**: 2026-01-08

## 概述

本次版本对 UI 测试模块进行了**重大重构**，采用现代UI测试最佳实践，与 Playwright 官方推荐完全一致。

**核心理念**：Component + Page + App Actions 三层架构 + 语义化定位

**破坏性变更**：BasePage 移除了所有过度封装的方法（click, fill, get_text 等），鼓励直接使用 Playwright API。

---

## 核心特性

### 1. 新增 BaseComponent 组件基类 (P0)

用于封装可复用的 UI 组件（如表单、导航栏、对话框）。

**实现**：

```python
from df_test_framework.capabilities.drivers.web import BaseComponent

class LoginForm(BaseComponent):
    """登录表单组件"""

    def __init__(self, page):
        # ✅ 使用 test-id 定位组件
        super().__init__(page, test_id="login-form")

    def submit(self, username: str, password: str):
        """填写并提交表单"""
        # ✅ 语义化定位
        self.get_by_label("Username").fill(username)
        self.get_by_label("Password").fill(password)
        self.get_by_role("button", name="Sign in").click()
```

**优势**：
- ✅ 组件可复用（在多个页面中使用）
- ✅ 组件内部元素相对定位
- ✅ 支持嵌套组件
- ✅ 语义化定位优先

### 2. 重构 BasePage - 移除过度封装 (P0)

**破坏性变更**：移除了所有过度封装的元素操作方法，鼓励直接使用 Playwright API。

**移除的方法**：
- ❌ `click(selector)` - 使用 `page.locator(selector).click()`
- ❌ `fill(selector, value)` - 使用 `page.get_by_label("...").fill(value)`
- ❌ `get_text(selector)` - 使用 `page.locator(selector).text_content()`
- ❌ `is_visible(selector)` - 使用 `page.locator(selector).is_visible()`
- ❌ 所有 `wait_for_*`, `get_by_*`, `locator` 等方法

**保留的核心功能**：
- ✅ `goto()` - 页面导航
- ✅ `wait_for_page_load()` - 抽象方法，子类实现
- ✅ `title` - 页面标题属性
- ✅ `screenshot()` - 截图方法
- ✅ `self.page` - 直接暴露 Playwright Page 对象

**新的使用方式**：

```python
# ========== 定义页面 ==========
class LoginPage(BasePage):
    """登录页面"""

    def __init__(self, page, base_url=""):
        super().__init__(page, url="/login", base_url=base_url)
        self.login_form = LoginForm(page)  # 组合组件

    def wait_for_page_load(self):
        # 等待页面特有元素
        self.page.get_by_test_id("login-form").wait_for()

    def login(self, username: str, password: str):
        """业务操作"""
        self.login_form.submit(username, password)


# ========== 测试中使用 ==========
def test_login(page, base_url):
    login_page = LoginPage(page, base_url)
    login_page.goto()
    login_page.login("admin", "password")

    # ✅ 直接使用 Playwright API 验证
    assert page.get_by_test_id("user-menu").is_visible()
    assert page.get_by_text("Welcome, admin").is_visible()
```

### 3. 新增 AppActions 业务操作基类 (P0)

用于封装高级业务操作和跨页面的用户流程。

**实现**：

```python
from df_test_framework.capabilities.drivers.web import AppActions

class MyAppActions(AppActions):
    """应用业务操作"""

    def login_as_admin(self):
        """管理员登录（常用操作）"""
        self.goto("/login")
        self.page.get_by_label("Username").fill("admin")
        self.page.get_by_label("Password").fill("admin123")
        self.page.get_by_role("button", name="Sign in").click()
        self.page.get_by_test_id("user-menu").wait_for()

    def create_user(self, username: str, email: str) -> str:
        """创建用户（完整流程）"""
        # 1. 导航
        self.page.get_by_role("link", name="Users").click()
        # 2. 打开对话框
        self.page.get_by_role("button", name="Add User").click()
        # 3. 填写表单
        self.page.get_by_label("Username").fill(username)
        self.page.get_by_label("Email").fill(email)
        # 4. 提交
        self.page.get_by_role("button", name="Create").click()
        # 5. 返回结果
        return self.page.get_by_test_id("user-id").text_content()


# ========== 测试使用 ==========
def test_user_management(page, base_url):
    app_actions = MyAppActions(page, base_url)

    app_actions.login_as_admin()
    user_id = app_actions.create_user("john", "john@example.com")

    assert user_id is not None
```

---

## 语义化定位优先级（Playwright 官方推荐）

| 优先级 | 定位方式 | 示例 | 原因 |
|-------|---------|------|------|
| 1️⃣ | Test ID | `get_by_test_id("submit-btn")` | 最稳定，专为测试设计 |
| 2️⃣ | Role + Name | `get_by_role("button", name="Submit")` | 语义化，有利于可访问性 |
| 3️⃣ | Label | `get_by_label("Username")` | 表单字段首选 |
| 4️⃣ | Placeholder | `get_by_placeholder("Enter email")` | 表单字段备选 |
| 5️⃣ | Text | `get_by_text("Welcome")` | 文本内容定位 |
| 6️⃣ | CSS/XPath | `locator("#username")` | ⚠️ 最后选择，易碎 |

**前端协作 - Test ID 规范**：

```html
<!-- ✅ 推荐：添加 data-testid -->
<form data-testid="login-form">
  <input data-testid="username-input" aria-label="Username" />
  <button data-testid="submit-btn" type="submit">Sign in</button>
</form>
```

---

## 三层架构

```
App Actions (业务操作层)
  ├── 封装完整的用户流程
  ├── 跨页面操作
  └── 示例：login_as_admin(), create_order()
      ↓
Component (可复用组件层)
  ├── 封装独立的 UI 单元
  ├── 组件内相对定位
  └── 示例：LoginForm, Header, Modal
      ↓
Playwright API (基础操作层)
  ├── 直接使用 Playwright 原生 API
  ├── 不过度封装
  └── 示例：page.get_by_role("button").click()
```

---

## 文件变更

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/df_test_framework/capabilities/drivers/web/playwright/component.py` | 新增 | BaseComponent 组件基类 |
| `src/df_test_framework/capabilities/drivers/web/app_actions.py` | 新增 | AppActions 业务操作基类 |
| `src/df_test_framework/capabilities/drivers/web/playwright/page.py` | 重构 | 移除过度封装，简化实现 |
| `src/df_test_framework/capabilities/drivers/web/__init__.py` | 修改 | 导出 BaseComponent 和 AppActions |
| `src/df_test_framework/cli/templates/project/ui_page_object.py` | 修改 | 更新模板为现代模式 |
| `src/df_test_framework/cli/templates/project/ui_app_actions.py` | 新增 | App Actions 模板 |
| `src/df_test_framework/cli/templates/project/ui_test_example.py` | 修改 | 更新示例为现代模式 |
| `tests/capabilities/drivers/web/test_modern_ui.py` | 新增 | 13 个测试用例 |

---

## 测试验证

### 测试覆盖
- ✅ 所有 29 个测试通过（16 个原有 + 13 个新增）
- ✅ BaseComponent 定位方法测试
- ✅ BasePage 简化功能测试
- ✅ AppActions 业务操作测试
- ✅ 导出验证测试

---

## 破坏性变更

### BasePage 移除的方法

**如果你的代码中使用了以下方法**，需要迁移到 Playwright API：

| 移除的方法 | 替代方案 |
|-----------|---------|
| `self.click(selector)` | `self.page.locator(selector).click()` 或<br/>`self.page.get_by_role("button", name="...").click()` |
| `self.fill(selector, value)` | `self.page.get_by_label("...").fill(value)` |
| `self.get_text(selector)` | `self.page.locator(selector).text_content()` |
| `self.is_visible(selector)` | `self.page.locator(selector).is_visible()` |
| `self.wait_for_selector(selector)` | `self.page.get_by_test_id("...").wait_for()` |
| `self.locator(selector)` | `self.page.locator(selector)` |
| `self.get_by_role(...)` | `self.page.get_by_role(...)` |

---

## 迁移指南

### 场景1: 简单页面测试（直接使用 Playwright API）

**之前** (v3.42.0):
```python
class LoginPage(BasePage):
    def __init__(self, page, base_url=""):
        super().__init__(page, url="/login", base_url=base_url, event_bus=None)
        self.username_input = "#username"
        self.password_input = "#password"

    def login(self, user, pwd):
        self.fill(self.username_input, user)  # ❌ 过度封装
        self.fill(self.password_input, pwd)
        self.click("button")
```

**现在** (v3.43.0):
```python
# 方式1: 直接使用 Playwright API（推荐简单场景）
def test_login(page, base_url):
    page.goto(f"{base_url}/login")
    page.get_by_label("Username").fill("admin")  # ✅ 语义化
    page.get_by_label("Password").fill("password")
    page.get_by_role("button", name="Sign in").click()
    assert page.get_by_test_id("user-menu").is_visible()
```

### 场景2: 使用 Component 模式（推荐）

```python
# 方式2: 使用 Component + Page（推荐复杂场景）
class LoginForm(BaseComponent):
    def __init__(self, page):
        super().__init__(page, test_id="login-form")

    def submit(self, user, pwd):
        self.get_by_label("Username").fill(user)
        self.get_by_label("Password").fill(pwd)
        self.get_by_role("button", name="Sign in").click()

class LoginPage(BasePage):
    def __init__(self, page, base_url=""):
        super().__init__(page, url="/login", base_url=base_url)
        self.login_form = LoginForm(page)

    def wait_for_page_load(self):
        self.page.get_by_test_id("login-form").wait_for()
```

### 场景3: 使用 App Actions（推荐业务流程）

```python
# 方式3: 使用 App Actions（推荐业务流程测试）
class MyAppActions(AppActions):
    def login_as_admin(self):
        self.goto("/login")
        self.page.get_by_label("Username").fill("admin")
        self.page.get_by_label("Password").fill("admin123")
        self.page.get_by_role("button", name="Sign in").click()

def test_dashboard(page, base_url):
    app_actions = MyAppActions(page, base_url)
    app_actions.login_as_admin()
    # 测试逻辑...
```

---

## 最佳实践

### DO ✅

1. **使用语义化定位**：优先 test-id > role > label
2. **组件化封装**：复用的 UI 单元用 Component
3. **业务操作抽象**：用 App Actions 封装完整流程
4. **直接使用 Playwright API**：简单操作不封装
5. **代码可读性**：代码应该像文档一样易读

### DON'T ❌

1. **过度封装**：不要为每个元素创建方法
2. **脆弱定位**：避免依赖 CSS 类名、XPath
3. **不必要的等待**：Playwright 有 auto-waiting
4. **硬编码等待时间**：避免 `sleep(3)`

---

## 前端协作建议

### Test ID 命名规范

```html
<!-- ✅ 推荐 -->
<div data-testid="user-profile">
  <form data-testid="profile-form">
    <input data-testid="email-input" />
    <button data-testid="save-btn">Save</button>
  </form>
</div>

<!-- 命名规则 -->
{功能}-{类型}
user-profile      # 用户资料区域
profile-form      # 资料表单
email-input       # 邮箱输入框
save-btn          # 保存按钮
```

---

## 已知问题

无。

---

## 依赖变更

无依赖变更。

---

## 贡献者

- Claude Sonnet 4.5 <noreply@anthropic.com>

---

**完整变更日志**: 查看 [CHANGELOG.md](../../CHANGELOG.md#3430---2026-01-08)
