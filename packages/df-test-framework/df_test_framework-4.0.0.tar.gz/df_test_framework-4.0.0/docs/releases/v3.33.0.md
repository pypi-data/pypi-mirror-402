# v3.33.0 å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-12-17

## æ¦‚è¿°

v3.33.0 ç‰ˆæœ¬ä¸º GraphQL å®¢æˆ·ç«¯å¼•å…¥ä¸­é—´ä»¶ç³»ç»Ÿï¼Œä¸ HTTP/gRPC å®¢æˆ·ç«¯æ¶æ„ç»Ÿä¸€ã€‚åŒæ—¶é›†æˆäº‹ä»¶ç³»ç»Ÿï¼Œæ”¯æŒ Allure æŠ¥å‘Šå’Œæ§åˆ¶å°è°ƒè¯•ï¼Œè®© GraphQL æœåŠ¡æµ‹è¯•æ›´åŠ é€æ˜å’Œæ˜“äºè°ƒè¯•ã€‚

### æ ¸å¿ƒæ”¹è¿›

1. **ä¸­é—´ä»¶ç³»ç»Ÿ** - GraphQL å®¢æˆ·ç«¯æ”¯æŒä¸­é—´ä»¶é“¾ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰ï¼Œä¸ HTTP/gRPC ä¸€è‡´
2. **GraphQLEventPublisherMiddleware** - äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶ï¼Œè‡ªåŠ¨è®°å½•è¯·æ±‚/å“åº”/é”™è¯¯
3. **Allure æŠ¥å‘Šé›†æˆ** - GraphQL è°ƒç”¨è‡ªåŠ¨è®°å½•åˆ° Allure æ­¥éª¤
4. **æ§åˆ¶å°è°ƒè¯•æ”¯æŒ** - å®æ—¶æ˜¾ç¤º GraphQL è¯·æ±‚/å“åº”ä¿¡æ¯
5. **é»˜è®¤å¯ç”¨äº‹ä»¶** - GraphQLClient é»˜è®¤å¯ç”¨äº‹ä»¶å‘å¸ƒï¼Œå¼€ç®±å³ç”¨

## æ–°åŠŸèƒ½

### 1. GraphQL ä¸­é—´ä»¶ç³»ç»Ÿ

æ–°å¢å®Œæ•´çš„ä¸­é—´ä»¶ç³»ç»Ÿï¼Œä½äº `capabilities/clients/graphql/middleware/`ï¼š

```python
from df_test_framework.capabilities.clients.graphql import GraphQLClient
from df_test_framework.capabilities.clients.graphql.middleware import (
    GraphQLMiddleware,           # åŸºç±»
    GraphQLLoggingMiddleware,    # æ—¥å¿—ä¸­é—´ä»¶
    GraphQLRetryMiddleware,      # é‡è¯•ä¸­é—´ä»¶
    GraphQLEventPublisherMiddleware,  # äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶
)

# ç»„åˆå¤šä¸ªä¸­é—´ä»¶
client = GraphQLClient(
    url="https://api.example.com/graphql",
    middlewares=[
        GraphQLLoggingMiddleware(log_query=True, log_variables=True),
        GraphQLRetryMiddleware(max_retries=3),
    ],
)

# é“¾å¼æ·»åŠ ä¸­é—´ä»¶
client = (
    GraphQLClient("https://api.example.com/graphql")
    .use(GraphQLLoggingMiddleware())
    .use(GraphQLRetryMiddleware(max_retries=3))
)
```

### 2. GraphQL äº‹ä»¶ç±»å‹

æ–°å¢ä¸‰ä¸ª GraphQL äº‹ä»¶ç±»å‹ï¼Œä¸ HTTP/gRPC äº‹ä»¶ä¿æŒä¸€è‡´çš„è®¾è®¡æ¨¡å¼ï¼š

```python
from df_test_framework.core.events import (
    GraphQLRequestStartEvent,
    GraphQLRequestEndEvent,
    GraphQLRequestErrorEvent,
)

# äº‹ä»¶å±æ€§
# GraphQLRequestStartEvent: url, operation_type, operation_name, query, variables, correlation_id
# GraphQLRequestEndEvent: url, operation_type, operation_name, duration, has_errors, error_count, data, correlation_id
# GraphQLRequestErrorEvent: url, operation_type, operation_name, error_type, error_message, duration, correlation_id
```

### 3. GraphQLEventPublisherMiddleware

äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶ï¼Œè‡ªåŠ¨å°† GraphQL è¯·æ±‚/å“åº”/é”™è¯¯å‘å¸ƒåˆ° EventBusï¼š

```python
from df_test_framework.capabilities.clients.graphql import GraphQLClient
from df_test_framework.capabilities.clients.graphql.middleware import (
    GraphQLEventPublisherMiddleware,
)

# æ–¹å¼1: è‡ªåŠ¨å¯ç”¨ï¼ˆé»˜è®¤ï¼‰
client = GraphQLClient(
    "https://api.example.com/graphql",
    # enable_events=True  # é»˜è®¤å¯ç”¨
)

# æ–¹å¼2: ç¦ç”¨äº‹ä»¶
client = GraphQLClient(
    "https://api.example.com/graphql",
    enable_events=False,
)

# æ–¹å¼3: æ‰‹åŠ¨æ·»åŠ ä¸­é—´ä»¶ï¼ˆæ›´å¤šæ§åˆ¶ï¼‰
from df_test_framework.infrastructure.events import EventBus

event_bus = EventBus()
middleware = GraphQLEventPublisherMiddleware(
    event_bus=event_bus,
    log_query=True,
    log_variables=True,
    log_response=True,
    max_data_length=1000,
)
client = GraphQLClient(
    "https://api.example.com/graphql",
    middlewares=[middleware],
    enable_events=False,  # ç¦ç”¨è‡ªåŠ¨æ·»åŠ 
)
```

### 4. GraphQLRetryMiddleware

é‡è¯•ä¸­é—´ä»¶ï¼Œæ”¯æŒç½‘ç»œé”™è¯¯å’Œ GraphQL ä¸šåŠ¡é”™è¯¯é‡è¯•ï¼š

```python
from df_test_framework.capabilities.clients.graphql.middleware import (
    GraphQLRetryMiddleware,
)

# åˆ›å»ºé‡è¯•ä¸­é—´ä»¶
middleware = GraphQLRetryMiddleware(
    max_retries=3,                    # æœ€å¤§é‡è¯•æ¬¡æ•°
    retry_on_network_error=True,      # ç½‘ç»œé”™è¯¯é‡è¯•ï¼ˆé»˜è®¤ Trueï¼‰
    retry_on_graphql_error=False,     # GraphQL é”™è¯¯é‡è¯•ï¼ˆé»˜è®¤ Falseï¼‰
)

client = GraphQLClient("https://api.example.com/graphql").use(middleware)
```

### 5. GraphQLLoggingMiddleware

æ—¥å¿—ä¸­é—´ä»¶ï¼Œè®°å½•è¯·æ±‚/å“åº”è¯¦æƒ…ï¼š

```python
from df_test_framework.capabilities.clients.graphql.middleware import (
    GraphQLLoggingMiddleware,
)

# åˆ›å»ºæ—¥å¿—ä¸­é—´ä»¶
middleware = GraphQLLoggingMiddleware(
    log_query=True,       # è®°å½• GraphQL æŸ¥è¯¢
    log_variables=False,  # è®°å½•å˜é‡ï¼ˆé»˜è®¤ Falseï¼Œå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
)

client = GraphQLClient("https://api.example.com/graphql").use(middleware)
```

### 6. Allure æŠ¥å‘Šé›†æˆ

GraphQL è°ƒç”¨è‡ªåŠ¨è®°å½•åˆ° Allure æŠ¥å‘Šä¸­ï¼Œæ˜¾ç¤ºï¼š
- æ“ä½œç±»å‹å’Œæ“ä½œåç§°
- æŸ¥è¯¢è¯­å¥
- å˜é‡
- å“åº”æ•°æ®
- è°ƒç”¨è€—æ—¶
- é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰

```python
import pytest
from df_test_framework.testing.fixtures import allure_observer

def test_graphql_with_allure(graphql_client, allure_observer):
    """GraphQL è°ƒç”¨è‡ªåŠ¨è®°å½•åˆ° Allure"""
    query = """
        query GetUser($id: ID!) {
            user(id: $id) {
                name
                email
            }
        }
    """
    response = graphql_client.execute(query, variables={"id": "123"})

    # Allure æŠ¥å‘Šä¸­ä¼šæ˜¾ç¤ºï¼š
    # ğŸ“Š GraphQL query: GetUser âœ… (50ms)
    #   - æŸ¥è¯¢è¯­å¥
    #   - å˜é‡
    #   - å“åº”æ•°æ®
```

### 7. æ§åˆ¶å°è°ƒè¯•æ”¯æŒ

ä½¿ç”¨ ConsoleDebugObserver å®æ—¶æŸ¥çœ‹ GraphQL è°ƒç”¨ä¿¡æ¯ï¼š

```python
from df_test_framework.testing.debugging import (
    ConsoleDebugObserver,
    create_console_debugger,
)

# æ–¹å¼1: ä½¿ç”¨å·¥å‚å‡½æ•°
debugger = create_console_debugger(
    show_graphql=True,           # æ˜¾ç¤º GraphQL è°ƒç”¨
    show_graphql_query=True,     # æ˜¾ç¤ºæŸ¥è¯¢è¯­å¥
    show_graphql_variables=True, # æ˜¾ç¤ºå˜é‡
    max_graphql_data_length=500, # æ•°æ®æˆªæ–­é•¿åº¦
)
debugger.subscribe()

# æ‰§è¡Œ GraphQL è°ƒç”¨æ—¶ä¼šå®æ—¶æ‰“å°ï¼š
# [GraphQL] query: GetUser
# â”œâ”€ URL: https://api.example.com/graphql
# â””â”€ Variables: {"id": "123"}
#
# [GraphQL] query: GetUser âœ… (50ms)
# â””â”€ Response: {"user": {"name": "Alice", "email": "alice@example.com"}}
```

### 8. è‡ªå®šä¹‰ä¸­é—´ä»¶

åˆ›å»ºè‡ªå®šä¹‰ GraphQL ä¸­é—´ä»¶ï¼š

```python
from df_test_framework.capabilities.clients.graphql.middleware import (
    GraphQLMiddleware,
)
from df_test_framework.capabilities.clients.graphql.models import (
    GraphQLRequest,
    GraphQLResponse,
)
from df_test_framework.core.middleware import Next

class AuthMiddleware(GraphQLMiddleware):
    """è®¤è¯ä¸­é—´ä»¶"""

    def __init__(self, token: str):
        super().__init__(name="AuthMiddleware", priority=50)
        self.token = token

    async def __call__(
        self,
        request: GraphQLRequest,
        call_next: Next[GraphQLRequest, GraphQLResponse],
    ) -> GraphQLResponse:
        # å‰ç½®å¤„ç†ï¼šæ·»åŠ è®¤è¯å¤´
        request = request.with_header("Authorization", f"Bearer {self.token}")

        # è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
        response = await call_next(request)

        # åç½®å¤„ç†ï¼ˆå¦‚éœ€è¦ï¼‰
        return response

# ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶
client = GraphQLClient("https://api.example.com/graphql").use(
    AuthMiddleware(token="your_token")
)
```

## ä¸­é—´ä»¶åˆ—è¡¨

| ä¸­é—´ä»¶ | è¯´æ˜ | é»˜è®¤ priority |
|--------|------|---------------|
| GraphQLMiddleware | åŸºç±» | 100 |
| GraphQLLoggingMiddleware | æ—¥å¿—è®°å½• | 0ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰ |
| GraphQLRetryMiddleware | é‡è¯•ï¼ˆç½‘ç»œ/GraphQL é”™è¯¯ï¼‰ | 10 |
| GraphQLEventPublisherMiddleware | äº‹ä»¶å‘å¸ƒ | 999ï¼ˆæœ€å†…å±‚ï¼‰ |

## ä¸ HTTP/gRPC å®¢æˆ·ç«¯çš„å¯¹æ¯”

| ç‰¹æ€§ | HTTP | gRPC | GraphQL |
|------|------|------|---------|
| ä¸­é—´ä»¶åŸºç±» | `HttpMiddleware` | `GrpcMiddleware` | `GraphQLMiddleware` |
| ä¸­é—´ä»¶é“¾ | `MiddlewareChain` | `MiddlewareChain` | `MiddlewareChain` |
| äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶ | HttpEventPublisherMiddleware | GrpcEventPublisherMiddleware | GraphQLEventPublisherMiddleware |
| å¼€å§‹äº‹ä»¶ | HttpRequestStartEvent | GrpcRequestStartEvent | GraphQLRequestStartEvent |
| ç»“æŸäº‹ä»¶ | HttpRequestEndEvent | GrpcRequestEndEvent | GraphQLRequestEndEvent |
| é”™è¯¯äº‹ä»¶ | HttpRequestErrorEvent | GrpcRequestErrorEvent | GraphQLRequestErrorEvent |
| å…³è” ID | correlation_id | correlation_id | correlation_id |
| Allure é›†æˆ | âœ… | âœ… | âœ… |
| æ§åˆ¶å°è°ƒè¯• | âœ… | âœ… | âœ… |

## å‡çº§æŒ‡å—

### ä» v3.32.0 å‡çº§

v3.33.0 å¯¹ç°æœ‰ GraphQL å®¢æˆ·ç«¯ç”¨æˆ·æ˜¯å‘åå…¼å®¹çš„ï¼š

```python
# æ—§ä»£ç ç»§ç»­å·¥ä½œ
client = GraphQLClient("https://api.example.com/graphql")
response = client.execute(query)

# æ–°åŠŸèƒ½ï¼šä½¿ç”¨ä¸­é—´ä»¶
client = (
    GraphQLClient("https://api.example.com/graphql")
    .use(GraphQLLoggingMiddleware())
    .use(GraphQLRetryMiddleware(max_retries=3))
)
```

**æ³¨æ„**ï¼šv3.33.0 é»˜è®¤å¯ç”¨äº‹ä»¶å‘å¸ƒï¼ˆ`enable_events=True`ï¼‰ï¼Œè¿™æ„å‘³ç€å¦‚æœæœ‰ EventBus è®¢é˜…è€…ï¼Œä¼šè‡ªåŠ¨æ¥æ”¶ GraphQL äº‹ä»¶ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ˜¾å¼ç¦ç”¨ï¼š

```python
client = GraphQLClient("https://api.example.com/graphql", enable_events=False)
```

## æµ‹è¯•è¦†ç›–

æ–°å¢ GraphQL ä¸­é—´ä»¶æµ‹è¯•ï¼š
- `TestGraphQLMiddleware` - åŸºç±»æµ‹è¯•
- `TestGraphQLLoggingMiddleware` - æ—¥å¿—ä¸­é—´ä»¶æµ‹è¯•
- `TestGraphQLRetryMiddleware` - é‡è¯•ä¸­é—´ä»¶æµ‹è¯•
- `TestGraphQLEventPublisherMiddleware` - äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶æµ‹è¯•
- `TestGraphQLClientMiddleware` - å®¢æˆ·ç«¯ä¸­é—´ä»¶é›†æˆæµ‹è¯•

æµ‹è¯•ç»“æœï¼š56 passed

## æ–‡ä»¶å˜æ›´

### æ–°å¢
- `src/df_test_framework/capabilities/clients/graphql/middleware/__init__.py` - ä¸­é—´ä»¶æ¨¡å—å¯¼å‡º
- `src/df_test_framework/capabilities/clients/graphql/middleware/base.py` - ä¸­é—´ä»¶åŸºç±»
- `src/df_test_framework/capabilities/clients/graphql/middleware/logging.py` - æ—¥å¿—ä¸­é—´ä»¶
- `src/df_test_framework/capabilities/clients/graphql/middleware/retry.py` - é‡è¯•ä¸­é—´ä»¶
- `src/df_test_framework/capabilities/clients/graphql/middleware/event_publisher.py` - äº‹ä»¶å‘å¸ƒä¸­é—´ä»¶

### ä¿®æ”¹
- `src/df_test_framework/core/events/types.py` - æ–°å¢ GraphQL äº‹ä»¶ç±»å‹
- `src/df_test_framework/core/events/__init__.py` - å¯¼å‡º GraphQL äº‹ä»¶
- `src/df_test_framework/capabilities/clients/graphql/models.py` - æ‰©å±•è¯·æ±‚/å“åº”æ¨¡å‹
- `src/df_test_framework/capabilities/clients/graphql/__init__.py` - å¯¼å‡ºä¸­é—´ä»¶ç±»
- `src/df_test_framework/capabilities/clients/graphql/client.py` - é›†æˆä¸­é—´ä»¶é“¾
- `src/df_test_framework/testing/reporting/allure/observer.py` - GraphQL äº‹ä»¶å¤„ç†
- `src/df_test_framework/testing/debugging/console.py` - GraphQL è°ƒè¯•æ”¯æŒ

## è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆä¸å¤ç”¨ HttpClientï¼Ÿ

**èƒŒæ™¯**ï¼šGraphQL åŸºäº HTTP ä¼ è¾“ï¼Œæ˜¯å¦å¯ä»¥ç›´æ¥å¤ç”¨ HttpClient çš„ä¸­é—´ä»¶ï¼Ÿ

**å†³ç­–**ï¼šä¸º GraphQL åˆ›å»ºç‹¬ç«‹çš„ä¸­é—´ä»¶ç³»ç»Ÿã€‚

**ç†ç”±**ï¼š

1. **è¯­ä¹‰å·®å¼‚** - GraphQL å…³æ³¨ operation_typeï¼ˆquery/mutationï¼‰ã€operation_nameï¼Œè€Œ HTTP å…³æ³¨ methodã€url
2. **é”™è¯¯å¤„ç†å·®å¼‚** - GraphQL é”™è¯¯åœ¨ response.errors ä¸­ï¼ŒHTTP 200 å¯èƒ½åŒ…å« GraphQL é”™è¯¯
3. **ä¸ gRPC ä¸€è‡´** - gRPC ä¹Ÿæœ‰ç‹¬ç«‹çš„ä¸­é—´ä»¶ç³»ç»Ÿï¼Œä¿æŒä¸‰ä¸ªå®¢æˆ·ç«¯æ¶æ„ç»Ÿä¸€
4. **çµæ´»æ€§** - GraphQL ä¸­é—´ä»¶å¯ä»¥è®¿é—® queryã€variables ç­‰ GraphQL ç‰¹æœ‰å­—æ®µ

### ä¸ºä»€ä¹ˆ GraphQL é”™è¯¯äº‹ä»¶åªç”¨äºä¼ è¾“å±‚é”™è¯¯ï¼Ÿ

**èƒŒæ™¯**ï¼šGraphQL æœ‰ä¸¤ç±»é”™è¯¯ï¼šä¼ è¾“å±‚é”™è¯¯ï¼ˆç½‘ç»œè¶…æ—¶ç­‰ï¼‰å’Œä¸šåŠ¡å±‚é”™è¯¯ï¼ˆresponse.errorsï¼‰ã€‚

**å†³ç­–**ï¼š`GraphQLRequestErrorEvent` åªç”¨äºä¼ è¾“å±‚é”™è¯¯ï¼Œä¸šåŠ¡å±‚é”™è¯¯é€šè¿‡ `GraphQLRequestEndEvent.has_errors` æ ‡è¯†ã€‚

**ç†ç”±**ï¼š

1. **ä¸è§„èŒƒä¸€è‡´** - GraphQL è§„èŒƒè§„å®šä¸šåŠ¡é”™è¯¯è¿”å› HTTP 200 + errors å­—æ®µ
2. **é¿å…æ··æ·†** - Error äº‹ä»¶è¯­ä¹‰ä¸Šåº”è¯¥æ˜¯"è¯·æ±‚å¤±è´¥"ï¼Œè€Œä¸æ˜¯"è¯·æ±‚æˆåŠŸä½†æœ‰ä¸šåŠ¡é”™è¯¯"
3. **æ–¹ä¾¿èšåˆ** - ç»Ÿè®¡æˆåŠŸç‡æ—¶ï¼Œä¸šåŠ¡é”™è¯¯å’Œä¼ è¾“é”™è¯¯éœ€è¦åˆ†å¼€è®¡ç®—

## ä¸‹ä¸€ç‰ˆæœ¬é¢„å‘Š

v3.34.0 è®¡åˆ’å¢å¼ºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¸º ConsoleDebugObserver æ·»åŠ  MQ äº‹ä»¶æ”¯æŒã€‚
