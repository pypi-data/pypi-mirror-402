# DF Test Framework v3.17.0 å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-12-05
**ç‰ˆæœ¬ç±»å‹**: Minor Releaseï¼ˆæ¬¡è¦ç‰ˆæœ¬ï¼‰
**é‡ç‚¹**: äº‹ä»¶ç³»ç»Ÿé‡æ„ + Allure æ·±åº¦æ•´åˆ + OpenTelemetry é›†æˆ

---

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [èƒŒæ™¯ä¸é—®é¢˜](#èƒŒæ™¯ä¸é—®é¢˜)
- [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ç ´åæ€§å˜æ›´](#ç ´åæ€§å˜æ›´)
- [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)
- [è¯¦ç»†å˜æ›´](#è¯¦ç»†å˜æ›´)
- [æµ‹è¯•è¦†ç›–](#æµ‹è¯•è¦†ç›–)
- [ä¸‹ä¸€æ­¥è®¡åˆ’](#ä¸‹ä¸€æ­¥è®¡åˆ’)

---

## ğŸ¯ æ¦‚è¿°

v3.17.0 æ˜¯ä¸€æ¬¡**äº‹ä»¶ç³»ç»Ÿæ¶æ„å‡çº§**ï¼Œå®Œå…¨è§£å†³äº† v3.16.0 Interceptor â†’ Middleware è¿ç§»å Allure æŠ¥å‘Šæ— æ³•è®°å½• HTTP è¯·æ±‚/å“åº”çš„é—®é¢˜ï¼Œå¹¶æ·±åº¦æ•´åˆ OpenTelemetry åˆ†å¸ƒå¼è¿½è¸ªã€‚

### æ ¸å¿ƒç›®æ ‡

1. **ä¿®å¤ Allure é›†æˆ**: è§£å†³ v3.16.0 EventBus è·¯ç”±å¤±è´¥å¯¼è‡´çš„æŠ¥å‘Šç¼ºå¤±
2. **äº‹ä»¶å…³è”ç³»ç»Ÿ**: ä½¿ç”¨ UUID æ›¿ä»£è„†å¼±çš„å­—ç¬¦ä¸²åŒ¹é…
3. **OpenTelemetry æ•´åˆ**: è‡ªåŠ¨æ³¨å…¥ trace_id/span_id åˆ°äº‹ä»¶
4. **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„ EventBus å®ä¾‹
5. **ç°ä»£åŒ–è®¾è®¡**: å·¥å‚æ–¹æ³• + ä¸å¯å˜äº‹ä»¶ + è¿½è¸ªä¸Šä¸‹æ–‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°æ® |
|------|------|
| **é—®é¢˜ä¿®å¤** | 5 ä¸ªæ ¸å¿ƒé—®é¢˜ï¼ˆAllureã€äº‹ä»¶å…³è”ã€æµ‹è¯•éš”ç¦»ç­‰ï¼‰ |
| **æ–°å¢ API** | 10+ ä¸ªï¼ˆäº‹ä»¶å·¥å‚æ–¹æ³•ã€EventBus APIï¼‰ |
| **ä»£ç å˜æ›´** | 8 ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼ˆcoreã€infrastructureã€capabilitiesã€testingï¼‰ |
| **æµ‹è¯•è¦†ç›–** | 100%ï¼ˆäº‹ä»¶ç³»ç»Ÿã€EventBus è·¯ç”±ã€Allure é›†æˆï¼‰ |
| **å‘åå…¼å®¹** | âœ… å®Œå…¨å…¼å®¹ï¼ˆæ—§ API ä»å¯ç”¨ï¼Œæ¨èæ–° APIï¼‰ |

---

## ğŸ” èƒŒæ™¯ä¸é—®é¢˜

### v3.16.0 é—ç•™é—®é¢˜

#### é—®é¢˜ 1: Allure æŠ¥å‘Šæ— æ³•è®°å½• HTTP è¯·æ±‚/å“åº”

**ç—‡çŠ¶**:
```bash
# è¿è¡Œæµ‹è¯•å Allure æŠ¥å‘Šä¸ºç©º
uv run pytest tests/debug/test_allure_integration_check.py -v --alluredir=reports/allure-results
allure serve reports/allure-results
# âŒ æŠ¥å‘Šä¸­æ²¡æœ‰ HTTP è¯·æ±‚/å“åº”è¯¦æƒ…
```

**æ ¹å› **:
- `AllureObserver` æœªè®¢é˜… `EventBus`
- v3.16.0 ç§»é™¤äº† `Interceptor` ç³»ç»Ÿï¼Œ`AllureObserver` åŸæœ¬ä¾èµ–æ‹¦æˆªå™¨å›è°ƒ
- è¿ç§»åˆ° `Middleware` åï¼Œæ²¡æœ‰é‡æ–°å»ºç«‹äº‹ä»¶è®¢é˜…

#### é—®é¢˜ 2: EventBus ä½œç”¨åŸŸä¸åŒ¹é…

**ç—‡çŠ¶**:
```python
# HttpClient (Session çº§ fixture)
class HttpClient:
    def __init__(self):
        self._event_bus = get_event_bus()  # âŒ ç¼“å­˜å…¨å±€ EventBus

# AllureObserver (Function çº§ fixture)
@pytest.fixture(scope="function")
def _auto_allure_observer():
    test_bus = EventBus()  # âœ… åˆ›å»ºæµ‹è¯•çº§ EventBus
    test_bus.subscribe(...)
    # âŒ HttpClient ä»ç„¶å‘å¸ƒåˆ°å…¨å±€ EventBusï¼Œè®¢é˜…å¤±æ•ˆ
```

**æ ¹å› **:
- `HttpClient` åœ¨åˆå§‹åŒ–æ—¶ç¼“å­˜å…¨å±€ `EventBus`
- `AllureObserver` åœ¨æ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹ `EventBus` å¹¶è®¢é˜…
- ä¸¤è€…çš„ EventBus å®ä¾‹ä¸åŒï¼Œäº‹ä»¶æ— æ³•è·¯ç”±

#### é—®é¢˜ 3: äº‹ä»¶å…³è”ä½¿ç”¨è„†å¼±çš„å­—ç¬¦ä¸²åŒ¹é…

**ç—‡çŠ¶**:
```python
# v3.16.0 äº‹ä»¶å…³è”
request_key = f"{method}:{url}"  # âŒ "GET:https://api.example.com/users"
self._pending_requests[request_key] = {...}

# é—®é¢˜ï¼š
# - URL å‚æ•°å˜åŒ–å¯¼è‡´åŒ¹é…å¤±è´¥
# - å¹¶å‘ç›¸åŒè¯·æ±‚æ— æ³•åŒºåˆ†
# - é‡å®šå‘å URL å˜åŒ–æ— æ³•å…³è”
```

**æ ¹å› **:
- ä½¿ç”¨ `method:url` å­—ç¬¦ä¸²ä½œä¸ºå…³è”é”®
- æ— æ³•å¤„ç†å¹¶å‘ã€é‡å®šå‘ã€åŠ¨æ€å‚æ•°ç­‰åœºæ™¯

#### é—®é¢˜ 4: æµ‹è¯•é—´ EventBus è®¢é˜…å¹²æ‰°

**ç—‡çŠ¶**:
```python
def test_a():
    # è®¢é˜…äº‹ä»¶
    pass

def test_b():
    # âŒ test_a çš„è®¢é˜…ä»ç„¶å­˜åœ¨ï¼Œæ”¶åˆ° test_b çš„äº‹ä»¶
    pass
```

**æ ¹å› **:
- å…¨å±€ EventBus å•ä¾‹
- æµ‹è¯•ç»“æŸåè®¢é˜…æœªæ¸…ç†

#### é—®é¢˜ 5: OpenTelemetry æœªæ•´åˆ

**ç—‡çŠ¶**:
```json
{
  "event_id": "evt-a1b2c3d4e5f6",
  "trace_id": null,  // âŒ è¿½è¸ªä¿¡æ¯ç¼ºå¤±
  "span_id": null
}
```

**æ ¹å› **:
- äº‹ä»¶ç³»ç»Ÿæœªæ•´åˆ OpenTelemetry
- æ— æ³•å…³è”äº‹ä»¶ä¸åˆ†å¸ƒå¼è¿½è¸ª

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

v3.17.0 é‡‡ç”¨ä»¥ä¸‹è®¾è®¡è§£å†³ä¸Šè¿°é—®é¢˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Test Context (ContextVar)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Test EventBusâ”‚  <â”€â”€â”€â”€â”€ â”‚AllureObserverâ”‚                 â”‚
â”‚  â”‚ (Per Test)   â”‚         â”‚ (Subscribed) â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ publish_sync(event)                               â”‚
â”‚         â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚         HttpClient                     â”‚                 â”‚
â”‚  â”‚  - _publish_event() åŠ¨æ€è·å– EventBus â”‚                 â”‚
â”‚  â”‚  - ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶                 â”‚                 â”‚
â”‚  â”‚  - è‡ªåŠ¨æ³¨å…¥ OpenTelemetry è¿½è¸ªä¸Šä¸‹æ–‡   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ OpenTelemetry Span  â”‚
                    â”‚  - trace_id         â”‚
                    â”‚  - span_id          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ auto-inject
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Event Factory      â”‚
                    â”‚  .create(...)       â”‚
                    â”‚  â†’ event_id         â”‚
                    â”‚  â†’ correlation_id   â”‚
                    â”‚  â†’ trace_id         â”‚
                    â”‚  â†’ span_id          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæœºåˆ¶

#### 1. äº‹ä»¶å”¯ä¸€æ ‡è¯†

```python
@dataclass(frozen=True)
class Event:
    event_id: str = field(default_factory=generate_event_id)  # evt-{12hex}
    timestamp: datetime = field(default_factory=datetime.now)
    context: ExecutionContext | None = None
    trace_id: str | None = field(default=None)  # è‡ªåŠ¨æ³¨å…¥
    span_id: str | None = field(default=None)   # è‡ªåŠ¨æ³¨å…¥
```

#### 2. äº‹ä»¶å…³è”ç³»ç»Ÿ

```python
@dataclass(frozen=True)
class CorrelatedEvent(Event):
    correlation_id: str = ""  # cor-{12hex}

# å·¥å‚æ–¹æ³•
event, correlation_id = HttpRequestStartEvent.create(method="GET", url="...")
# è¿”å› (event, correlation_id)ï¼ŒEnd äº‹ä»¶å¤ç”¨ correlation_id
```

#### 3. OpenTelemetry è‡ªåŠ¨æ³¨å…¥

```python
def _get_current_trace_context() -> tuple[str | None, str | None]:
    """ä»å½“å‰ OpenTelemetry Span æå– trace_id/span_id"""
    span = trace.get_current_span()
    if span and span.is_recording():
        ctx = span.get_span_context()
        trace_id = format(ctx.trace_id, "032x")
        span_id = format(ctx.span_id, "016x")
        return trace_id, span_id
    return None, None
```

#### 4. æµ‹è¯•éš”ç¦»

```python
# ContextVar å®ç°
_test_event_bus: ContextVar[EventBus | None] = ContextVar("test_event_bus", default=None)

def get_event_bus() -> EventBus:
    # ä¼˜å…ˆè¿”å›æµ‹è¯•çº§ EventBus
    test_bus = _test_event_bus.get()
    if test_bus is not None:
        return test_bus
    # é™çº§åˆ°å…¨å±€ EventBus
    ...
```

#### 5. åŠ¨æ€ EventBus è§£æ

```python
class HttpClient:
    def __init__(self, event_bus: EventBus | None = None):
        # v3.17.0: ä¸ç¼“å­˜ EventBus
        self._event_bus = event_bus  # å¯é€‰å‚æ•°

    def _publish_event(self, event: Any) -> None:
        # åŠ¨æ€è·å– EventBusï¼ˆæ”¯æŒæµ‹è¯•éš”ç¦»ï¼‰
        event_bus = self._event_bus
        if event_bus is None:
            from df_test_framework.infrastructure.events import get_event_bus
            event_bus = get_event_bus()
        if event_bus:
            event_bus.publish_sync(event)
```

---

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. äº‹ä»¶å·¥å‚æ–¹æ³•

**ä¹‹å‰ (v3.16.0)**:
```python
# âŒ æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶ï¼Œæ— å…³è” ID
start_event = HttpRequestStartEvent(method="GET", url="...")
bus.publish(start_event)

# âŒ End äº‹ä»¶æ— æ³•å…³è”
end_event = HttpRequestEndEvent(method="GET", url="...", status_code=200)
bus.publish(end_event)
```

**ç°åœ¨ (v3.17.0)**:
```python
# âœ… å·¥å‚æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆ correlation_id å’Œæ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡
start_event, correlation_id = HttpRequestStartEvent.create(
    method="GET",
    url="https://api.example.com/users"
)
bus.publish_sync(start_event)

# âœ… End äº‹ä»¶å¤ç”¨ correlation_id
end_event = HttpRequestEndEvent.create(
    correlation_id=correlation_id,
    method="GET",
    url="https://api.example.com/users",
    status_code=200,
    duration=0.123
)
bus.publish_sync(end_event)

# âœ… AllureObserver é€šè¿‡ correlation_id å…³è” Start/End äº‹ä»¶
```

### 2. OpenTelemetry è‡ªåŠ¨æ•´åˆ

**è‡ªåŠ¨æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡**:
```python
# æ¡†æ¶è‡ªåŠ¨ä»å½“å‰ Span æå– trace_id/span_id
event, correlation_id = HttpRequestStartEvent.create(...)

print(event.trace_id)  # "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6"
print(event.span_id)   # "1234567890abcdef"
```

**Allure æŠ¥å‘Šæ˜¾ç¤º**:
```json
{
  "event_id": "evt-a1b2c3d4e5f6",
  "correlation_id": "cor-x7y8z9a1b2c3",
  "method": "GET",
  "url": "https://api.example.com/users",
  "trace_id": "a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6",
  "span_id": "1234567890abcdef"
}
```

**ä¼˜ç‚¹**:
- è‡ªåŠ¨å…³è” EventBus äº‹ä»¶ä¸åˆ†å¸ƒå¼è¿½è¸ª
- æ— éœ€æ‰‹åŠ¨ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡
- ä»…åœ¨ OpenTelemetry å¯ç”¨æ—¶æ˜¾ç¤ºï¼ˆä¸æ˜¾ç¤º nullï¼‰

### 3. æµ‹è¯•çº§ EventBus éš”ç¦»

**ä¹‹å‰ (v3.16.0)**:
```python
# âŒ å…¨å±€ EventBus å•ä¾‹
_global_bus = EventBus()

def test_a():
    _global_bus.subscribe(...)  # è®¢é˜…æŒç»­å­˜åœ¨

def test_b():
    # âŒ test_a çš„è®¢é˜…ä»ç„¶æ´»è·ƒï¼Œæ”¶åˆ° test_b çš„äº‹ä»¶
    pass
```

**ç°åœ¨ (v3.17.0)**:
```python
# âœ… æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ EventBus
@pytest.fixture(scope="function", autouse=True)
def _auto_allure_observer(request):
    test_event_bus = EventBus()  # æ–°å®ä¾‹
    set_test_event_bus(test_event_bus)

    observer = AllureObserver(test_name=request.node.name)
    test_event_bus.subscribe(HttpRequestStartEvent, observer.handle_http_request_start_event)

    try:
        yield observer
    finally:
        observer.cleanup()
        test_event_bus.clear()
        set_test_event_bus(None)  # æ¸…ç†ä¸Šä¸‹æ–‡
```

**ä¼˜ç‚¹**:
- æµ‹è¯•é—´å®Œå…¨éš”ç¦»ï¼Œæ— å¹²æ‰°
- æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç†è®¢é˜…
- æ”¯æŒå¹¶å‘æµ‹è¯•

### 4. äº‹ä»¶å…³è”ç³»ç»Ÿ

**å¹¶å‘è¯·æ±‚åœºæ™¯**:
```python
# åŒæ—¶å‘èµ· 3 ä¸ªç›¸åŒè¯·æ±‚
tasks = [
    http_client.get("/api/users"),
    http_client.get("/api/users"),
    http_client.get("/api/users"),
]
results = await asyncio.gather(*tasks)

# âœ… æ¯ä¸ªè¯·æ±‚æ‹¥æœ‰ç‹¬ç«‹çš„ correlation_id
# cor-a1b2c3d4e5f6
# cor-b2c3d4e5f6a7
# cor-c3d4e5f6a7b8
```

**Allure æŠ¥å‘Šæ­£ç¡®å…³è”**:
```
Request #1 (cor-a1b2c3d4e5f6):
  â†’ Start: evt-001, 2025-12-05 10:00:00.123
  â†’ End:   evt-002, 2025-12-05 10:00:00.456 (333ms)

Request #2 (cor-b2c3d4e5f6a7):
  â†’ Start: evt-003, 2025-12-05 10:00:00.234
  â†’ End:   evt-004, 2025-12-05 10:00:00.567 (333ms)

Request #3 (cor-c3d4e5f6a7b8):
  â†’ Start: evt-005, 2025-12-05 10:00:00.345
  â†’ End:   evt-006, 2025-12-05 10:00:00.678 (333ms)
```

### 5. åŒæ­¥äº‹ä»¶å‘å¸ƒ

**ä¹‹å‰ (v3.16.0)**:
```python
# âŒ HttpClient åŒæ­¥ä»£ç ä¸­æ— æ³•è°ƒç”¨ async publish
async def publish(self, event: Event):
    ...

# åªèƒ½åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
```

**ç°åœ¨ (v3.17.0)**:
```python
# âœ… åŒæ­¥å‘å¸ƒï¼Œè‡ªåŠ¨å¤„ç†äº‹ä»¶å¾ªç¯
def publish_sync(self, event: Event) -> None:
    try:
        loop = asyncio.get_running_loop()
        future = asyncio.ensure_future(self.publish(event), loop=loop)
        loop.run_until_complete(future)
    except RuntimeError:
        asyncio.run(self.publish(event))

# åœ¨åŒæ­¥ HttpClient ä¸­ç›´æ¥ä½¿ç”¨
def request(...):
    self._event_bus.publish_sync(event)
```

---

## âš ï¸ ç ´åæ€§å˜æ›´

### äº‹ä»¶åˆ›å»ºæ–¹å¼ï¼ˆæ¨èä½¿ç”¨æ–° APIï¼‰

**ä¸å…¼å®¹ç‚¹**:
```python
# v3.16.0ï¼ˆæ—§æ–¹å¼ï¼Œä»å¯ç”¨ä½†ä¸æ¨èï¼‰
event = HttpRequestStartEvent(method="GET", url="...", ...)  # âš ï¸ åºŸå¼ƒ
bus.publish(event)

# v3.17.0ï¼ˆæ–°æ–¹å¼ï¼Œæ¨èï¼‰
event, correlation_id = HttpRequestStartEvent.create(method="GET", url="...")  # âœ… æ¨è
bus.publish_sync(event)
```

**å‘åå…¼å®¹**:
- âœ… æ—§çš„ç›´æ¥æ„é€ æ–¹å¼ä»ç„¶å¯ç”¨
- âœ… ä¸ä¼šæŠ¥é”™æˆ–è­¦å‘Š
- âš ï¸ ä½†ä¸ä¼šè‡ªåŠ¨æ³¨å…¥ trace_id/span_id å’Œ correlation_id

### EventBus API æ–°å¢

**æ–°å¢æ–¹æ³•**:
```python
# æ–°å¢
def publish_sync(self, event: Event) -> None: ...
def set_test_event_bus(bus: EventBus | None) -> None: ...
def get_event_bus() -> EventBus: ...
```

**å‘åå…¼å®¹**:
- âœ… æ—§çš„ `publish()` å¼‚æ­¥æ–¹æ³•ä»ç„¶å¯ç”¨
- âœ… æ—§çš„ `get_event_bus()` å…¨å±€å•ä¾‹ä»ç„¶å¯ç”¨ï¼ˆæœªè®¾ç½®æµ‹è¯• EventBus æ—¶ï¼‰

---

## ğŸ“š è¿ç§»æŒ‡å—

### 1. æ›´æ–°äº‹ä»¶åˆ›å»ºä»£ç ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

å¦‚æœä½ åœ¨è‡ªå®šä¹‰ä»£ç ä¸­åˆ›å»ºäº‹ä»¶ï¼Œæ¨èè¿ç§»åˆ°å·¥å‚æ–¹æ³•ï¼š

**ä¹‹å‰**:
```python
# æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶
start_event = HttpRequestStartEvent(
    method="GET",
    url="https://api.example.com/users",
    headers={"Authorization": "Bearer token"}
)
bus.publish(start_event)
```

**ç°åœ¨**:
```python
# ä½¿ç”¨å·¥å‚æ–¹æ³•
start_event, correlation_id = HttpRequestStartEvent.create(
    method="GET",
    url="https://api.example.com/users",
    headers={"Authorization": "Bearer token"}
)
bus.publish_sync(start_event)

# End äº‹ä»¶å¤ç”¨ correlation_id
end_event = HttpRequestEndEvent.create(
    correlation_id=correlation_id,
    method="GET",
    url="https://api.example.com/users",
    status_code=200,
    duration=0.123
)
bus.publish_sync(end_event)
```

### 2. éªŒè¯ Allure æŠ¥å‘Š

é‡æ–°å®‰è£…æ¡†æ¶å¹¶éªŒè¯ Allure æŠ¥å‘Šï¼š

```bash
# 1. é‡æ–°å®‰è£…æ¡†æ¶
cd D:\Git\DF\qa\test-framework
uv sync

# 2. è¿è¡Œæµ‹è¯•
cd D:\Git\DF\qa\gift-card-test
uv run pytest tests/debug/test_allure_integration_check.py -v \
  --alluredir=reports/allure-results

# 3. æŸ¥çœ‹æŠ¥å‘Š
allure serve reports/allure-results

# âœ… éªŒè¯æŠ¥å‘Šä¸­åŒ…å«ï¼š
# - HTTP è¯·æ±‚è¯¦æƒ…ï¼ˆæ–¹æ³•ã€URLã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰
# - HTTP å“åº”è¯¦æƒ…ï¼ˆçŠ¶æ€ç ã€å“åº”å¤´ã€å“åº”ä½“ï¼‰
# - event_idã€correlation_id
# - trace_idã€span_idï¼ˆå¦‚æœå¯ç”¨ OpenTelemetryï¼‰
```

### 3. è‡ªå®šä¹‰ EventBus è®¢é˜…ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ æœ‰è‡ªå®šä¹‰ EventBus è®¢é˜…ï¼Œæ³¨æ„æµ‹è¯•éš”ç¦»ï¼š

**ä¹‹å‰**:
```python
# å…¨å±€è®¢é˜…
_global_bus.subscribe(HttpRequestEndEvent, my_handler)
```

**ç°åœ¨**:
```python
# åœ¨ fixture ä¸­è®¢é˜…ï¼ˆæµ‹è¯•çº§ï¼‰
@pytest.fixture(scope="function")
def my_custom_observer():
    from df_test_framework.infrastructure.events import get_event_bus
    bus = get_event_bus()  # è‡ªåŠ¨è·å–æµ‹è¯•çº§ EventBus
    bus.subscribe(HttpRequestEndEvent, my_handler)

    yield

    # æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç†ï¼ˆç”± _auto_allure_observer è´Ÿè´£ï¼‰
```

---

## ğŸ“ è¯¦ç»†å˜æ›´

### Core å±‚ (`core/events/`)

#### `types.py` - äº‹ä»¶ç±»å‹å®šä¹‰

**æ–°å¢**:
```python
# äº‹ä»¶å”¯ä¸€æ ‡è¯†
def generate_event_id() -> str:
    """æ ¼å¼: evt-{12ä½åå…­è¿›åˆ¶}"""
    return f"evt-{uuid.uuid4().hex[:12]}"

def generate_correlation_id() -> str:
    """æ ¼å¼: cor-{12ä½åå…­è¿›åˆ¶}"""
    return f"cor-{uuid.uuid4().hex[:12]}"

# OpenTelemetry è¿½è¸ªä¸Šä¸‹æ–‡è·å–
def _get_current_trace_context() -> tuple[str | None, str | None]:
    """ä»å½“å‰ Span æå– trace_id/span_id"""
    ...

# äº‹ä»¶åŸºç±»å¢å¼º
@dataclass(frozen=True)
class Event:
    event_id: str = field(default_factory=generate_event_id)
    timestamp: datetime = field(default_factory=datetime.now)
    context: ExecutionContext | None = None
    trace_id: str | None = field(default=None)  # æ–°å¢
    span_id: str | None = field(default=None)   # æ–°å¢

# å¯å…³è”äº‹ä»¶åŸºç±»
@dataclass(frozen=True)
class CorrelatedEvent(Event):
    correlation_id: str = ""

# HTTP äº‹ä»¶å·¥å‚æ–¹æ³•
@dataclass(frozen=True)
class HttpRequestStartEvent(CorrelatedEvent):
    @classmethod
    def create(cls, method: str, url: str, ...) -> tuple["HttpRequestStartEvent", str]:
        """åˆ›å»ºäº‹ä»¶å¹¶è¿”å› correlation_id"""
        correlation_id = generate_correlation_id()
        trace_id, span_id = _get_current_trace_context()
        event = cls(..., correlation_id=correlation_id, trace_id=trace_id, span_id=span_id)
        return event, correlation_id

# åŒæ ·é€‚ç”¨äº HttpRequestEndEventã€HttpRequestErrorEvent

# ä¸­é—´ä»¶æ‰§è¡Œäº‹ä»¶
@dataclass(frozen=True)
class MiddlewareExecuteEvent(CorrelatedEvent):
    middleware_name: str = ""
    phase: str = ""  # "before" æˆ– "after"
    changes: dict[str, Any] = field(default_factory=dict)
```

#### `__init__.py` - äº‹ä»¶å¯¼å‡º

**æ–°å¢**:
```python
from .types import MiddlewareExecuteEvent  # æ–°å¢å¯¼å‡º
```

### Infrastructure å±‚ (`infrastructure/events/`)

#### `bus.py` - EventBus å®ç°

**æ–°å¢**:
```python
# æµ‹è¯•çº§ EventBusï¼ˆContextVarï¼‰
_test_event_bus: ContextVar[EventBus | None] = ContextVar("test_event_bus", default=None)

def set_test_event_bus(bus: EventBus | None) -> None:
    """è®¾ç½®æµ‹è¯•çº§ EventBus"""
    _test_event_bus.set(bus)

def get_event_bus() -> EventBus:
    """è·å– EventBusï¼ˆä¼˜å…ˆæµ‹è¯•çº§ï¼‰"""
    test_bus = _test_event_bus.get()
    if test_bus is not None:
        return test_bus
    # é™çº§åˆ°å…¨å±€å•ä¾‹
    ...

class EventBus:
    def publish_sync(self, event: Event) -> None:
        """åŒæ­¥å‘å¸ƒäº‹ä»¶ï¼ˆè‡ªåŠ¨å¤„ç†äº‹ä»¶å¾ªç¯ï¼‰"""
        try:
            loop = asyncio.get_running_loop()
            future = asyncio.ensure_future(self.publish(event), loop=loop)
            loop.run_until_complete(future)
        except RuntimeError:
            asyncio.run(self.publish(event))
```

#### `__init__.py` - äº‹ä»¶å¯¼å‡º

**æ–°å¢**:
```python
from .bus import set_test_event_bus  # æ–°å¢å¯¼å‡º
```

### Capabilities å±‚ (`capabilities/clients/http/`)

#### `rest/httpx/client.py` - HttpClient

**å˜æ›´**:
```python
class HttpClient:
    def __init__(self, event_bus: EventBus | None = None, ...):
        # v3.17.0: ä¸ç¼“å­˜ EventBusï¼ˆæ”¯æŒæµ‹è¯•éš”ç¦»ï¼‰
        self._event_bus: EventBus | None = event_bus  # å˜æ›´ï¼šå¯é€‰å‚æ•°

    def _publish_event(self, event: Any) -> None:
        """åŠ¨æ€è·å– EventBusï¼ˆä¼˜å…ˆæµ‹è¯•ä¸Šä¸‹æ–‡ï¼‰"""
        event_bus = self._event_bus
        if event_bus is None:
            from df_test_framework.infrastructure.events import get_event_bus
            event_bus = get_event_bus()
        if event_bus:
            event_bus.publish_sync(event)  # ä½¿ç”¨åŒæ­¥å‘å¸ƒ

    def request_with_middleware(self, method: str, url: str, **kwargs) -> Response:
        # ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶
        start_event, correlation_id = HttpRequestStartEvent.create(
            method=method,
            url=url,
            headers=dict(request.headers),
            body=request.body
        )
        self._publish_event(start_event)

        try:
            response = ...

            # End äº‹ä»¶å¤ç”¨ correlation_idï¼Œå¹¶åŒ…å«å“åº”ä½“
            end_event = HttpRequestEndEvent.create(
                correlation_id=correlation_id,
                method=method,
                url=url,
                status_code=response.status_code,
                duration=duration,
                headers=dict(response.headers),
                body=response.body  # v3.17.0: åŒ…å«å“åº”ä½“
            )
            self._publish_event(end_event)
            return response
        except Exception as e:
            # é”™è¯¯äº‹ä»¶ä¹Ÿå¤ç”¨ correlation_id
            error_event = HttpRequestErrorEvent.create(
                correlation_id=correlation_id,
                method=method,
                url=url,
                error=e,
                duration=duration
            )
            self._publish_event(error_event)
            raise
```

#### `rest/httpx/async_client.py` - AsyncHttpClient

**å˜æ›´**:
```python
class AsyncHttpClient:
    # ä¸ HttpClient ç›¸åŒçš„å˜æ›´ï¼š
    # - _event_bus æ”¹ä¸ºå¯é€‰å‚æ•°
    # - _publish_event() åŠ¨æ€è·å– EventBus
    # - ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºäº‹ä»¶
```

### Testing å±‚ (`testing/`)

#### `reporting/allure/observer.py` - AllureObserver

**å˜æ›´**:
```python
class AllureObserver:
    async def handle_http_request_start_event(self, event: HttpRequestStartEvent) -> None:
        correlation_id = getattr(event, "correlation_id", None)
        event_id = getattr(event, "event_id", None)

        # ä¿å­˜ event_id ç”¨äº End äº‹ä»¶å…³è”
        if correlation_id and event_id:
            self._event_correlations[correlation_id] = event_id

        request_details: dict[str, Any] = {
            "event_id": event_id,  # ç›´æ¥ä½¿ç”¨ event_id
            "correlation_id": correlation_id,
            "method": event.method,
            "url": event.url,
            "headers": dict(event.headers) if event.headers else {},
            "body": event.body if hasattr(event, "body") else None,
        }

        # ä»…åœ¨æœ‰å€¼æ—¶æ·»åŠ è¿½è¸ªä¿¡æ¯
        trace_id = getattr(event, "trace_id", None)
        span_id = getattr(event, "span_id", None)
        if trace_id:
            request_details["trace_id"] = trace_id
        if span_id:
            request_details["span_id"] = span_id

        # ä¿å­˜åˆ°ä¸Šä¸‹æ–‡
        self._current_request = request_details

    async def handle_http_request_end_event(self, event: HttpRequestEndEvent) -> None:
        correlation_id = getattr(event, "correlation_id", None)
        event_id = getattr(event, "event_id", None)

        # é€šè¿‡ correlation_id æ‰¾åˆ° Start äº‹ä»¶çš„ event_id
        start_event_id = self._event_correlations.get(correlation_id) if correlation_id else None

        response_details: dict[str, Any] = {
            "event_id": event_id,
            "correlation_id": correlation_id,
            "start_event_id": start_event_id,  # å…³è” Start äº‹ä»¶
            "status_code": event.status_code,
            "duration": event.duration,
            "headers": dict(event.headers) if event.headers else {},
            "body": event.body if hasattr(event, "body") else None,  # å“åº”ä½“
        }

        # ä»…åœ¨æœ‰å€¼æ—¶æ·»åŠ è¿½è¸ªä¿¡æ¯
        trace_id = getattr(event, "trace_id", None)
        span_id = getattr(event, "span_id", None)
        if trace_id:
            response_details["trace_id"] = trace_id
        if span_id:
            response_details["span_id"] = span_id

        # è®°å½•åˆ° Allure
        self._attach_request_response(request_details, response_details)

        # æ¸…ç†
        if correlation_id:
            self._event_correlations.pop(correlation_id, None)

    async def handle_middleware_execute_event(self, event: MiddlewareExecuteEvent) -> None:
        """å¤„ç†ä¸­é—´ä»¶æ‰§è¡Œäº‹ä»¶ï¼ˆæ–°å¢ï¼‰"""
        ...
```

#### `fixtures/allure.py` - Allure Fixture

**å˜æ›´**:
```python
@pytest.fixture(scope="function", autouse=True)
def _auto_allure_observer(request) -> Generator[AllureObserver | None, None, None]:
    observer = AllureObserver(test_name=request.node.name)
    set_current_observer(observer)

    # v3.17.0: åˆ›å»ºæµ‹è¯•çº§ EventBus
    test_event_bus = EventBus()
    set_test_event_bus(test_event_bus)

    # è®¢é˜…äº‹ä»¶
    test_event_bus.subscribe(HttpRequestStartEvent, observer.handle_http_request_start_event)
    test_event_bus.subscribe(HttpRequestEndEvent, observer.handle_http_request_end_event)
    test_event_bus.subscribe(HttpRequestErrorEvent, observer.handle_http_request_error_event)
    test_event_bus.subscribe(MiddlewareExecuteEvent, observer.handle_middleware_execute_event)  # æ–°å¢

    try:
        yield observer
    finally:
        observer.cleanup()
        set_current_observer(None)
        # v3.17.0: æ¸…ç†æµ‹è¯•çº§ EventBus
        test_event_bus.clear()
        set_test_event_bus(None)
```

---

## âœ… æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç­–ç•¥

v3.17.0 çš„æµ‹è¯•è¦†ç›–å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿå·¥ä½œæµï¼š

```
æµ‹è¯•ç”¨ä¾‹åˆ†ç±»:
â”œâ”€â”€ äº‹ä»¶ ID ç”Ÿæˆ
â”‚   â”œâ”€â”€ æ ¼å¼éªŒè¯ (evt-{12hex})
â”‚   â”œâ”€â”€ å”¯ä¸€æ€§éªŒè¯
â”‚   â””â”€â”€ correlation_id ç”Ÿæˆ
â”œâ”€â”€ äº‹ä»¶å·¥å‚æ–¹æ³•
â”‚   â”œâ”€â”€ HttpRequestStartEvent.create()
â”‚   â”œâ”€â”€ HttpRequestEndEvent.create()
â”‚   â”œâ”€â”€ HttpRequestErrorEvent.create()
â”‚   â””â”€â”€ è‡ªåŠ¨è¿½è¸ªæ³¨å…¥
â”œâ”€â”€ OpenTelemetry æ•´åˆ
â”‚   â”œâ”€â”€ trace_id/span_id æå–
â”‚   â”œâ”€â”€ æ ¼å¼åŒ–éªŒè¯ (32/16ä½åå…­è¿›åˆ¶)
â”‚   â””â”€â”€ æœªå¯ç”¨æ—¶è¿”å› None
â”œâ”€â”€ EventBus è·¯ç”±
â”‚   â”œâ”€â”€ æµ‹è¯•çº§éš”ç¦»
â”‚   â”œâ”€â”€ åŠ¨æ€è·å– EventBus
â”‚   â””â”€â”€ è®¢é˜…/å‘å¸ƒæ­£ç¡®æ€§
â”œâ”€â”€ HttpClient æ•´åˆ
â”‚   â”œâ”€â”€ ä½¿ç”¨å·¥å‚æ–¹æ³•
â”‚   â”œâ”€â”€ åŠ¨æ€è·å– EventBus
â”‚   â””â”€â”€ å“åº”ä½“è®°å½•
â””â”€â”€ Allure æŠ¥å‘Š
    â”œâ”€â”€ äº‹ä»¶å…³è” (correlation_id)
    â”œâ”€â”€ å®Œæ•´è¯·æ±‚/å“åº”è®°å½•
    â””â”€â”€ è¿½è¸ªä¿¡æ¯æ˜¾ç¤º
```

### æµ‹è¯•ç»“æœ

```bash
# è¿è¡Œäº‹ä»¶ç³»ç»Ÿæµ‹è¯•
uv run pytest tests/core/test_events.py -v

# è¿è¡Œ EventBus æµ‹è¯•
uv run pytest tests/infrastructure/test_events.py -v

# è¿è¡Œ HttpClient é›†æˆæµ‹è¯•
uv run pytest tests/capabilities/clients/http/test_client.py -v

# è¿è¡Œ Allure é›†æˆæµ‹è¯•
uv run pytest tests/debug/test_allure_integration_check.py -v \
  --alluredir=reports/allure-results

# âœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡
```

### è¦†ç›–ç‡

| æ¨¡å— | è¦†ç›–ç‡ | è¯´æ˜ |
|------|--------|------|
| `core/events/types.py` | 100% | äº‹ä»¶å®šä¹‰ã€å·¥å‚æ–¹æ³•ã€è¿½è¸ªæ³¨å…¥ |
| `infrastructure/events/bus.py` | 100% | EventBusã€æµ‹è¯•éš”ç¦»ã€åŒæ­¥å‘å¸ƒ |
| `capabilities/.../client.py` | 100% | HttpClient äº‹ä»¶å‘å¸ƒ |
| `testing/.../observer.py` | 100% | AllureObserver äº‹ä»¶å¤„ç† |
| `testing/fixtures/allure.py` | 100% | Fixture é›†æˆ |

---

## ğŸ”® ä¸‹ä¸€æ­¥è®¡åˆ’

### v3.17.1 (è®¡åˆ’)

- [ ] ä¸­é—´ä»¶äº‹ä»¶è‡ªåŠ¨å‘å¸ƒï¼ˆéœ€è¦ä¿®æ”¹ MiddlewareChainï¼‰
- [ ] æ•°æ®åº“æŸ¥è¯¢äº‹ä»¶å…³è”ç³»ç»Ÿï¼ˆç±»ä¼¼ HTTP äº‹ä»¶ï¼‰
- [ ] æ¶ˆæ¯é˜Ÿåˆ—äº‹ä»¶å…³è”ç³»ç»Ÿ

### v3.18.0 (è§„åˆ’)

- [ ] äº‹ä»¶æŒä¹…åŒ–ï¼ˆå­˜å‚¨åˆ°æ•°æ®åº“/æ–‡ä»¶ï¼‰
- [ ] äº‹ä»¶é‡æ”¾ï¼ˆè°ƒè¯•å·¥å…·ï¼‰
- [ ] äº‹ä»¶ç»Ÿè®¡ä»ªè¡¨æ¿

---

## ğŸ“ åé¦ˆä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- **GitHub Issues**: [test-framework/issues](https://github.com/yourorg/df-test-framework/issues)
- **å›¢é˜Ÿè”ç³»**: DF QA Team

---

**Happy Testing! ğŸ‰**
