# v3.38.5 - structlog 25.5.0 最佳实践升级

**发布日期**: 2025-12-25

## 概述

本版本升级 structlog 到 25.4.0+，按照官方最新最佳实践优化日志系统。主要改进包括：更好的第三方库日志支持、新增 logfmt 输出格式、Python 3.11+ QUAL_NAME 支持等。

## 核心改进

### 1. 升级 structlog 版本要求

**变更**: `structlog >= 24.1.0` → `structlog >= 25.4.0`

**原因**:
- v25.4 修复了 Python 3.14 的 `filter_by_level()` 兼容性问题
- v25.1 新增 `PositionalArgumentsFormatter`
- v25.5 新增 `CallsiteParameter.QUAL_NAME`

### 2. PositionalArgumentsFormatter - 第三方库 % 格式化支持

**问题**: 第三方库（如 httpx、sqlalchemy）使用 `%s` 格式化日志，之前不会被正确处理。

**解决方案**: 添加 `PositionalArgumentsFormatter` 处理器：

```python
# 第三方库日志现在可以正确显示
logging.info("User %s logged in from %s", "alice", "192.168.1.1")
# 输出: User alice logged in from 192.168.1.1
```

### 3. ExtraAdder - 第三方库 extra 参数支持

**问题**: 第三方库通过 `extra` 参数传递的字段被忽略。

**解决方案**: 在 `foreign_pre_chain` 中添加 `ExtraAdder` 处理器：

```python
# 第三方库的 extra 参数现在会被正确处理
logging.info("Request completed", extra={"request_id": "abc123"})
# 输出包含: request_id=abc123
```

### 4. LogfmtRenderer - 新增 logfmt 输出格式

**用途**: Logfmt 是 Loki、Prometheus 等日志系统的原生格式，比 JSON 更轻量。

**配置**:

```yaml
# config/prod.yaml
logging:
  format: logfmt  # 新增选项
```

**输出示例**:

```
timestamp=2025-12-25T10:00:00Z level=info logger=my_app event="用户登录" user_id=123
```

### 5. QUAL_NAME - Python 3.11+ 完整限定名

**改进**: 在 `add_callsite=True` 时，Python 3.11+ 使用 `QUAL_NAME` 替代 `FUNC_NAME`，显示完整的限定名（包含类名）。

**效果对比**:

```python
class AuthService:
    def login(self):
        logger.info("登录")

# Python 3.10: func_name="login"
# Python 3.11+: qual_name="AuthService.login"
```

### 6. pytest 日志集成修复

**问题**: 在 pytest 环境下，日志输出存在以下问题：
- 日志重复（structlog 和 pytest 各输出一次）
- pytest live log 显示原始 dict 格式而非渲染后的文本

**解决方案**: 重写 `logging_plugin.py`：

1. 禁用 structlog 的控制台输出（`enable_console=False`）
2. 替换 pytest handlers 的 formatter 为 `ProcessorFormatter`
3. 由 pytest 统一控制日志显示

**效果对比**:

```
# 修复前（v3.38.4）
2025-12-25 18:18:37.851820 [info] 消息内容
2025-12-25 18:18:37 | INFO | logger:func | {'event': '消息内容', ...}

# 修复后（v3.38.5）
2025-12-25 10:18:37.851820 [info] 消息内容 [logger_name]
```

**新增 API**:

```python
from df_test_framework.infrastructure.logging import create_processor_formatter

# 创建 ProcessorFormatter，可用于自定义 handler
formatter = create_processor_formatter(logging_config)
custom_handler.setFormatter(formatter)
```

## Processor 链顺序（v3.38.5）

按照 structlog 25.5.0 官方推荐顺序：

```
1. merge_contextvars              # 合并上下文变量
2. add_logger_name                # 添加 logger 名称
3. add_log_level                  # 添加日志级别
4. PositionalArgumentsFormatter   # 处理 % 格式化（v3.38.5 新增）
5. ExtraAdder                     # 处理 extra 参数（v3.38.5 新增，仅 foreign_pre_chain）
6. _sanitize_sensitive_data       # 脱敏处理
7. TimeStamper                    # 时间戳
8. CallsiteParameterAdder         # 调用位置信息（可选）
9. _add_trace_info                # OpenTelemetry trace
10. StackInfoRenderer             # 堆栈信息
11. format_exc_info               # 异常格式化
12. UnicodeDecoder                # Unicode 解码
13. Renderer                      # 渲染器（ConsoleRenderer/JSONRenderer/LogfmtRenderer）
```

## 配置变更

### LoggingConfig 新增选项

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `format` | Literal | "text" | 新增 "logfmt" 选项 |

### format 选项说明

| 值 | 输出格式 | 适用场景 |
|----|----------|----------|
| `text` | 彩色控制台 | 开发调试 |
| `json` | JSON | 生产环境、ELK/Graylog |
| `logfmt` | Logfmt | Loki/Prometheus |

## 测试

- 新增 16 个测试用例
- 全部 36 个日志测试通过

### 新增测试类

- `TestThirdPartyLogIntegration` - 第三方库日志集成测试
- `TestOrjsonSupport` - orjson 高性能序列化测试
- `TestCallsiteInfo` - 调用位置信息测试
- `TestLogfmtFormat` - Logfmt 格式测试

## 依赖变更

```toml
# pyproject.toml
dependencies = [
    # 升级
    "structlog>=25.4.0",  # 之前: >=24.1.0
]
```

## 迁移指南

### 从 v3.38.4 升级

无破坏性变更，直接升级即可。

**可选配置优化**:

```yaml
# 如果使用 Loki/Prometheus，可以使用 logfmt 格式
logging:
  format: logfmt

# 如果使用 Python 3.11+，add_callsite 会自动使用 QUAL_NAME
logging:
  add_callsite: true
```

## 参考资料

- [structlog 25.5.0 文档](https://www.structlog.org/en/stable/)
- [Standard Library Logging](https://www.structlog.org/en/stable/standard-library.html)
- [Processors](https://www.structlog.org/en/stable/processors.html)