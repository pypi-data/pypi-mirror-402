# v3.35.2 发布说明 - ConfigLoader 重构（pydantic-settings 原生支持）

**发布日期**: 2025-12-19

## 概述

v3.35.2 重构 ConfigLoader，使用 pydantic-settings 内置的 `nested_model_default_partial_update` 功能实现环境变量深度合并，移除所有手动解析代码。

## 重构内容

### 移除的代码

| 移除项 | 原因 |
|-------|------|
| `_NESTED_CONFIG_KEYS` 硬编码列表 | pydantic-settings 自动处理嵌套模型 |
| `_parse_env_vars()` | pydantic-settings 内置环境变量解析 |
| `_env_vars_to_nested_dict()` | pydantic-settings 内置嵌套字典转换 |
| `_parse_env_value()` | pydantic-settings 内置值类型解析 |
| `_SettingsNoEnv` 临时子类 | 不再需要禁用环境变量解析的 hack |

### 新增的配置

```python
class _DynamicSettings(base_class):
    model_config = SettingsConfigDict(
        env_prefix="",
        case_sensitive=False,
        env_nested_delimiter="__",
        env_ignore_empty=True,
        extra="allow",
        env_file=env_file_path,
        env_file_encoding="utf-8",
        # 关键：启用嵌套模型的部分更新（深度合并）
        nested_model_default_partial_update=True,
    )
```

## 技术细节

### nested_model_default_partial_update 功能

pydantic-settings v2.3.0+ 提供的 `nested_model_default_partial_update=True` 设置：

- **作用**: 环境变量只更新嵌套模型的特定字段，而非完全替换整个嵌套对象
- **解决问题**: `SIGNATURE__SECRET=xxx` 只更新 `signature.secret`，保留 `signature.algorithm` 等其他字段
- **自动处理**: `__` 分隔符自动转换为嵌套结构

### 配置优先级（不变）

```
1. 环境变量（最高优先级）
2. config/secrets/.env.local
3. config/environments/{env}.yaml
4. config/base.yaml
5. 代码默认值（最低优先级）
```

### settings_customise_sources 配置

```python
@classmethod
def settings_customise_sources(
    cls,
    settings_cls: type[BaseSettings],
    init_settings: PydanticBaseSettingsSource,
    env_settings: PydanticBaseSettingsSource,
    dotenv_settings: PydanticBaseSettingsSource,
    file_secret_settings: PydanticBaseSettingsSource,
) -> tuple[PydanticBaseSettingsSource, ...]:
    # 优先级（从高到低）: 环境变量 > .env 文件 > YAML 配置（init_settings）
    return (
        env_settings,
        dotenv_settings,
        init_settings,
    )
```

## 代码变更统计

| 指标 | v3.35.1 | v3.35.2 | 变化 |
|------|---------|---------|------|
| loader.py 行数 | ~400 行 | ~287 行 | -28% |
| 手动解析方法 | 4 个 | 0 个 | -100% |
| 硬编码配置键 | 10+ 个 | 0 个 | -100% |

## 修改文件清单

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `infrastructure/config/loader.py` | 重构 | 使用 pydantic-settings 原生深度合并 |
| `tests/infrastructure/config/test_loader.py` | 删除 | 移除已删除方法的测试类 |
| `pyproject.toml` | 版本 | 3.35.1 → 3.35.2 |
| `__init__.py` | 版本 | 3.35.1 → 3.35.2 |

## 升级指南

### 从 v3.35.1 升级

**完全向后兼容**，无需修改任何代码。

### 验证升级

```bash
# 运行配置相关测试
uv run pytest tests/infrastructure/config/ -v
# 预期: 69 passed

# 验证环境变量深度合并
export SIGNATURE__SECRET="new_secret"
uv run pytest tests/ -v --env=test
# 验证 signature.algorithm 仍然保留 YAML 配置值
```

## 测试结果

```bash
uv run pytest tests/infrastructure/config/ -v
# 结果: 69 passed
```

## 为什么选择此方案

详细的技术分析请参考 [配置管理方案分析](../architecture/config-management-analysis.md)。

### 优势

1. **代码简化**: 移除 ~100 行手动解析代码
2. **类型安全**: 完全保留 Pydantic 类型验证
3. **无维护负担**: 不需要维护 `_NESTED_CONFIG_KEYS` 列表
4. **原生支持**: 使用 pydantic-settings 官方推荐方式
5. **向后兼容**: API 完全不变

### 对比其他方案

| 方案 | 优点 | 缺点 |
|-----|------|------|
| **方案 A（采用）** | 类型安全、代码简洁、无维护负担 | 需要 pydantic-settings 2.3.0+ |
| 方案 B (Dynaconf) | 功能丰富、热重载 | 失去类型安全、需要迁移成本 |
| v3.35.1 实现 | 功能完整 | 手动代码多、需要维护配置键列表 |
