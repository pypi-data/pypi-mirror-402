# v3.23.0 发布说明

> **发布日期**: 2025-12-13
> **Python 要求**: >= 3.12

---

## 概述

v3.23.0 重大更新：**ObservabilityConfig 统一配置** + **caplog fixture 集成**。

核心改进：
- 新增 `ObservabilityConfig` - 统一控制所有可观测性功能
- `caplog` fixture - 桥接 loguru 到 pytest 日志捕获
- `enable_event_publisher` 参数废弃，事件始终发布

---

## 设计理念

### 之前的问题

1. **配置分散**：AllureObserver、ConsoleDebugObserver 各自控制
2. **loguru 日志不可见**：pytest 的 `caplog` 无法捕获 loguru 日志
3. **事件发布可选**：`enable_event_publisher=False` 会导致可观测性失效

### 解决方案

```
ObservabilityConfig（统一配置）
    ├── enabled: 总开关
    ├── allure_recording: Allure 记录开关
    └── debug_output: 调试输出开关

能力层（HTTP/DB/Redis）
    └── 事件始终发布 → EventBus → 观察者按配置订阅
```

---

## 新增功能

### 1. ObservabilityConfig

统一的可观测性配置类。

**位置**: `infrastructure/config/schema.py`

```python
class ObservabilityConfig(BaseModel):
    """可观测性配置"""

    # 总开关（控制所有观察者）
    enabled: bool = True

    # Allure 记录开关
    allure_recording: bool = True

    # 调试输出开关
    debug_output: bool = False
```

**配置方式**：

```yaml
# settings.yaml
observability:
  enabled: true
  allure_recording: true
  debug_output: false
```

```bash
# 环境变量
OBSERVABILITY__ENABLED=true
OBSERVABILITY__ALLURE_RECORDING=true
OBSERVABILITY__DEBUG_OUTPUT=false
```

### 2. caplog fixture

桥接 loguru 到 pytest 日志捕获系统。

```python
def test_with_logging(http_client, caplog):
    """检查日志内容"""
    response = http_client.get("/api/users")

    # 检查日志文本
    assert "HTTP客户端已初始化" in caplog.text

    # 检查特定日志级别
    assert any(
        record.levelname == "DEBUG"
        for record in caplog.records
    )
```

**功能**：
- loguru 日志被 pytest live logging 捕获并显示
- 测试失败时日志显示在 "Captured log" 区域
- 支持通过 `caplog.text` 访问日志内容
- 支持通过 `caplog.records` 访问日志记录

### 3. 事件始终发布

`enable_event_publisher` 参数已废弃，事件始终发布。

```python
# v3.22.0（可选）
client = HttpClient(
    base_url="...",
    enable_event_publisher=True,  # 可以禁用
)

# v3.23.0（始终发布）
client = HttpClient(base_url="...")
# 事件始终发布，由观察者决定是否消费
```

**设计原则**：
- 事件发布开销极小（无订阅者时几乎为零）
- 观察者按需订阅，配置集中管理
- 控制 Allure 记录和调试输出请使用 `ObservabilityConfig`

---

## 配置场景

### 正常测试（默认）

```bash
OBSERVABILITY__ENABLED=true
OBSERVABILITY__ALLURE_RECORDING=true
OBSERVABILITY__DEBUG_OUTPUT=false
```

- Allure 报告记录完整
- 无控制台调试输出

### 调试模式

```bash
OBSERVABILITY__ENABLED=true
OBSERVABILITY__DEBUG_OUTPUT=true
```

- 控制台输出彩色调试信息
- Allure 报告同时记录

### CI 快速运行

```bash
OBSERVABILITY__ENABLED=false
```

- 禁用所有可观测性
- 最快执行速度

---

## 废弃内容

### `enable_event_publisher` 参数

```python
# ⚠️ 已废弃，参数被忽略
client = HttpClient(
    base_url="...",
    enable_event_publisher=False,  # 无效，事件仍然发布
)
```

**迁移方式**：

删除该参数，使用 `ObservabilityConfig` 控制观察者行为。

---

## 使用示例

### 配置驱动

```yaml
# settings.yaml
observability:
  enabled: true
  allure_recording: true
  debug_output: true  # 开发时启用
```

### 环境变量切换

```bash
# 开发环境
export OBSERVABILITY__DEBUG_OUTPUT=true
pytest -v -s

# CI 环境
export OBSERVABILITY__DEBUG_OUTPUT=false
pytest -v
```

### 检查日志

```python
def test_api_logging(http_client, caplog):
    """验证日志记录"""
    response = http_client.post("/users", json={"name": "Alice"})

    # 验证请求日志
    assert "POST" in caplog.text
    assert "/users" in caplog.text
```

---

## 相关文档

- [可观测性架构设计](../architecture/observability-architecture.md)
- [v3.22.0 发布说明](v3.22.0.md) - HttpEventPublisherMiddleware
- [v3.22.1 发布说明](v3.22.1.md) - 数据库调试支持
