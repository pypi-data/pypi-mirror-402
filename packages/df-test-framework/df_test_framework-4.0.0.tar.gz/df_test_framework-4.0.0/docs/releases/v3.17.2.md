# v3.17.2 ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-12-09
**ç±»å‹**: ä»£ç è´¨é‡ä¼˜åŒ–å’Œ Bug ä¿®å¤ç‰ˆæœ¬

---

## ğŸ“‹ æ¦‚è¿°

v3.17.2 æ˜¯ä¸€ä¸ªä¸­é—´ä»¶æ¶æ„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
1. ä½¿ç”¨ Python 3.12 type è¯­å¥é‡æ„ç±»å‹å®šä¹‰
2. ä¿®å¤ HttpClient åŒæ­¥/å¼‚æ­¥äº‹ä»¶å¾ªç¯å…¼å®¹æ€§é—®é¢˜
3. å¢å¼º LoginTokenProvider å¯¹åŒæ­¥/å¼‚æ­¥å®¢æˆ·ç«¯çš„æ”¯æŒ
4. ç§»é™¤æœªå®ç°çš„ä¸­é—´ä»¶æšä¸¾ç±»å‹ï¼Œä¿æŒä»£ç ä¸€è‡´æ€§
5. æ›´æ–°æ–‡æ¡£ç¤ºä¾‹ä¸ºæ¨èç”¨æ³•

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. Python 3.12 type è¯­å¥

**èƒŒæ™¯é—®é¢˜**ï¼š
- `protocol.py` æ³¨é‡Šå£°ç§°ä½¿ç”¨ Python 3.12+ çš„ type è¯­å¥
- ä½†å®é™…ä½¿ç”¨çš„æ˜¯æ—§å¼ `TypeVar` + `Callable` è¯­æ³•

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# v3.17.1ï¼ˆæ—§ï¼‰
TRequest = TypeVar("TRequest")
TResponse = TypeVar("TResponse")
Next = Callable[[TRequest], Awaitable[TResponse]]

# v3.17.2ï¼ˆæ–°ï¼‰- çœŸæ­£çš„ Python 3.12 type è¯­å¥
type Next[T, R] = Callable[[T], Awaitable[R]]
type MiddlewareFunc[T, R] = Callable[[T, Next[T, R]], Awaitable[R]]
```

**ä¼˜åŠ¿**ï¼š
- ä»£ç æ›´ç®€æ´
- ç±»å‹æ¨æ–­æ›´å‡†ç¡®
- ä¸æ–‡æ¡£æ³¨é‡Šä¸€è‡´

### 2. HttpClient åŒæ­¥/å¼‚æ­¥å…¼å®¹æ€§ä¿®å¤

**èƒŒæ™¯é—®é¢˜**ï¼š
- `request_with_middleware()` ä½¿ç”¨å·²å¼ƒç”¨çš„ `asyncio.get_event_loop()`
- åœ¨ pytest-asyncio ç¯å¢ƒä¸‹å¯èƒ½å¯¼è‡´åµŒå¥—äº‹ä»¶å¾ªç¯é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# v3.17.2 ä¿®å¤å
try:
    loop = asyncio.get_running_loop()
    # å¦‚æœå·²åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œä½¿ç”¨ nest_asyncio
    import nest_asyncio
    nest_asyncio.apply()
except RuntimeError:
    loop = None

# ä½¿ç”¨ asyncio.run() æ›¿ä»£ loop.run_until_complete()
if loop is not None:
    response = loop.run_until_complete(chain.execute(request_obj))
else:
    response = asyncio.run(chain.execute(request_obj))
```

### 3. LoginTokenProvider å®¢æˆ·ç«¯ç±»å‹æ£€æŸ¥

**èƒŒæ™¯é—®é¢˜**ï¼š
- `_do_login()` å‡è®¾åº•å±‚å®¢æˆ·ç«¯æ˜¯å¼‚æ­¥çš„
- å½“ä½¿ç”¨åŒæ­¥ `httpx.Client` æ—¶ä¼šå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# v3.17.2 å¢å¼ºçš„ç±»å‹æ£€æŸ¥
if isinstance(raw_client, httpx.AsyncClient):
    # å¼‚æ­¥å®¢æˆ·ç«¯ï¼Œç›´æ¥ await
    response = await raw_client.post(full_url, json=self.credentials)
elif isinstance(raw_client, httpx.Client):
    # åŒæ­¥å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ asyncio.to_thread åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
    response = await asyncio.to_thread(raw_client.post, full_url, json=self.credentials)
else:
    raise TypeError(f"ä¸æ”¯æŒçš„ HTTP å®¢æˆ·ç«¯ç±»å‹: {type(raw_client)}")
```

### 4. ç§»é™¤æœªå®ç°çš„ä¸­é—´ä»¶ç±»å‹

**èƒŒæ™¯é—®é¢˜**ï¼š
- `MiddlewareType` æšä¸¾å®šä¹‰äº† 7 ç§ç±»å‹
- ä½† `MiddlewareFactory` åªå®ç°äº† 4 ç§
- ä½¿ç”¨æœªå®ç°ç±»å‹ä¼šå¯¼è‡´ `ValueError`

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# v3.17.2 åªä¿ç•™å·²å®ç°çš„ç±»å‹
class MiddlewareType(str, Enum):
    SIGNATURE = "signature"
    BEARER_TOKEN = "bearer_token"
    RETRY = "retry"
    LOGGING = "logging"
    # ä»¥ä¸‹ç±»å‹é¢„ç•™ï¼Œå¾…åç»­ç‰ˆæœ¬å®ç°
    # TIMEOUT = "timeout"
    # RATE_LIMIT = "rate_limit"
    # CIRCUIT_BREAKER = "circuit_breaker"
```

---

## ğŸ› Bug ä¿®å¤

### 1. ä¿®å¤ç±»å‹å®šä¹‰ä¸ä¸€è‡´

**æ–‡ä»¶**: `src/df_test_framework/core/middleware/protocol.py`

```python
# ä¿®å¤å‰ï¼ˆæ³¨é‡Šä¸å®ç°ä¸ç¬¦ï¼‰
TRequest = TypeVar("TRequest")
TResponse = TypeVar("TResponse")
# ç±»å‹åˆ«å - ä½¿ç”¨ Python 3.12+ çš„ type è¯­å¥ï¼ˆå®é™…æ²¡ç”¨ï¼‰
Next = Callable[[TRequest], Awaitable[TResponse]]

# ä¿®å¤å
type Next[T, R] = Callable[[T], Awaitable[R]]
type MiddlewareFunc[T, R] = Callable[[T, Next[T, R]], Awaitable[R]]
```

### 2. ä¿®å¤äº‹ä»¶å¾ªç¯é—®é¢˜

**æ–‡ä»¶**: `src/df_test_framework/capabilities/clients/http/rest/httpx/client.py`

ä½¿ç”¨ `asyncio.run()` æ›¿ä»£å·²å¼ƒç”¨çš„ `get_event_loop()` + `run_until_complete()` æ¨¡å¼ã€‚

### 3. ä¿®å¤åŒæ­¥å®¢æˆ·ç«¯ç™»å½•

**æ–‡ä»¶**: `src/df_test_framework/capabilities/clients/http/middleware/auth.py`

å¢åŠ å¯¹ `httpx.Client`ï¼ˆåŒæ­¥ï¼‰å’Œ `httpx.AsyncClient`ï¼ˆå¼‚æ­¥ï¼‰çš„æ˜¾å¼ç±»å‹æ£€æŸ¥ã€‚

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

### 1. middleware_guide.md

æ›´æ–°æ‰€æœ‰ç¤ºä¾‹ä»£ç ï¼Œä½¿ç”¨æ¨èçš„ API è°ƒç”¨æ–¹å¼ï¼š

```python
# v3.17.2 æ¨èç”¨æ³•
response = client.get("/users")
response = client.post("/api/orders", json={...})

# ä¸æ¨èï¼ˆç›´æ¥è°ƒç”¨å†…éƒ¨æ–¹æ³•ï¼‰
# response = client.request_with_middleware("GET", "/users")
```

### 2. ESSENTIAL_DOCS.md

- æ›´æ–°ç‰ˆæœ¬å·ä¸º v3.17.2
- æ›´æ–°ä¸­é—´ä»¶ç¤ºä¾‹ä»£ç ä¸ºæ´‹è‘±æ¨¡å‹æ­£ç¡®ç”¨æ³•

### 3. MIDDLEWARE_V3.14_DESIGN.md

å°†çŠ¶æ€ä»"è®¾è®¡è‰æ¡ˆï¼ˆå¾…è®¨è®ºï¼‰"æ›´æ–°ä¸º"å·²å®ç°ï¼ˆv3.14.0 å‘å¸ƒï¼Œv3.17.2 æŒç»­ä¼˜åŒ–ï¼‰"ã€‚

---

## ğŸ”„ å‡çº§æŒ‡å—

### ä» v3.17.1 å‡çº§åˆ° v3.17.2

**æ— éœ€ä¿®æ”¹ä»£ç **ï¼Œæ‰€æœ‰ä¿®å¤å‘åå…¼å®¹ï¼š

```bash
uv pip install df-test-framework==3.17.2
```

### æ–°å¢ä¾èµ–

v3.17.2 æ–°å¢ `nest_asyncio` ä¾èµ–ï¼Œç”¨äºå¤„ç†åµŒå¥—äº‹ä»¶å¾ªç¯ï¼š

```bash
uv pip install nest-asyncio
```

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

```bash
$ uv run pytest tests/ -v --ignore=tests/test_messengers/
============================== test session starts ==============================
collected 1307 items

... (æ‰€æœ‰æµ‹è¯•) ...

============================== 1307 passed ===============================
```

---

## ğŸ“ å˜æ›´æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `core/middleware/protocol.py` | é‡æ„ | ä½¿ç”¨ Python 3.12 type è¯­å¥ |
| `capabilities/clients/http/rest/httpx/client.py` | ä¿®å¤ | äº‹ä»¶å¾ªç¯å…¼å®¹æ€§ |
| `capabilities/clients/http/middleware/auth.py` | å¢å¼º | å®¢æˆ·ç«¯ç±»å‹æ£€æŸ¥ |
| `infrastructure/config/middleware_schema.py` | å˜æ›´ | ç§»é™¤æœªå®ç°çš„æšä¸¾ |
| `docs/guides/middleware_guide.md` | æ–‡æ¡£ | ç¤ºä¾‹ä»£ç æ›´æ–° |
| `docs/ESSENTIAL_DOCS.md` | æ–‡æ¡£ | ç‰ˆæœ¬å’Œç¤ºä¾‹æ›´æ–° |
| `docs/architecture/MIDDLEWARE_V3.14_DESIGN.md` | æ–‡æ¡£ | çŠ¶æ€æ›´æ–° |

---

## ğŸ¯ åç»­è®¡åˆ’

v3.17.2 å®Œæˆäº†ä¸­é—´ä»¶æ¶æ„çš„ä»£ç è´¨é‡ä¼˜åŒ–ã€‚

ä¸‹ä¸€ä¸ªç‰ˆæœ¬è®¡åˆ’ï¼š
1. **v3.18.0**: å®ç° TimeoutMiddlewareã€RateLimitMiddleware
2. **v3.19.0**: å®ç° CircuitBreakerMiddleware / AllurePlugin ç§»é™¤

---

**å‘å¸ƒå›¢é˜Ÿ**: DF Test Framework å¼€å‘ç»„
**å‘å¸ƒæ—¥æœŸ**: 2025-12-09
