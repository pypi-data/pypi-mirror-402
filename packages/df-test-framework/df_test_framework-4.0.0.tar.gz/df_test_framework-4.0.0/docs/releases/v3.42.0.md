# v3.42.0 - UI 测试配置驱动模式

**发布日期**: 2026-01-08

## 概述

本次版本为 UI 测试引入了配置驱动模式，与 HTTP 客户端保持一致的使用体验。通过新增 `WebConfig` 配置类和增强 `BrowserManager`，用户可以通过环境变量或配置文件统一管理浏览器配置，简化测试代码，提高配置可维护性。

**破坏性变更**：移除了配置型 fixtures（`browser_type`、`browser_headless` 等），统一使用 `WebConfig` 配置。

## 核心特性

### 1. 新增 WebConfig 配置类 (P0)

统一管理所有浏览器配置，支持环境变量和代码配置。

**实现**：

```python
from df_test_framework.infrastructure.config import WebConfig

# 代码中创建配置
config = WebConfig(
    browser_type="chromium",
    headless=True,
    timeout=30000,
    viewport={"width": 1920, "height": 1080},
    record_video=False,
    video_dir="reports/videos",
)

# 或通过环境变量配置
# .env 文件
WEB__BASE_URL=https://example.com
WEB__BROWSER_TYPE=firefox
WEB__HEADLESS=false
WEB__TIMEOUT=60000
WEB__VIEWPORT__width=1920
WEB__VIEWPORT__height=1080
WEB__RECORD_VIDEO=true
WEB__VIDEO_DIR=custom/videos
```

**优势**：
- ✅ 配置集中管理，与 HTTPConfig 保持一致
- ✅ 支持环境变量配置，方便 CI/CD 环境切换
- ✅ 类型安全，Pydantic 自动验证
- ✅ 支持嵌套配置（如 viewport）

### 2. BrowserManager 配置驱动模式 (P0)

BrowserManager 新增 `config` 参数，支持从 WebConfig 创建。

**实现**：

```python
from df_test_framework import WebConfig
from df_test_framework.capabilities.drivers.web import BrowserManager

# 方式1: 从配置对象创建（推荐）
config = WebConfig(
    base_url="https://example.com",
    browser_type="firefox",
    headless=False
)
manager = BrowserManager(config=config)

# 方式2: 直接传参（参数优先）
manager = BrowserManager(
    base_url="https://another.com",  # 直接参数优先
    browser_type="chromium",  # 直接参数
    config=config,  # config 中是 firefox，但被直接参数覆盖
)

# 方式3: 使用默认配置
manager = BrowserManager()
```

**参数优先级**：直接参数 > config > 默认值

### 3. RuntimeContext 集成 (P0)

RuntimeContext 新增 `browser_manager()` 方法，提供单例支持。

**实现**：

```python
from df_test_framework.bootstrap import Bootstrap

# 初始化
app = Bootstrap().build()
runtime = app.run()

# 获取 BrowserManager 单例
manager = runtime.browser_manager()
manager.start()

# 使用浏览器
page = manager.page
page.goto("https://example.com")

# 清理
manager.stop()
```

**优势**：
- ✅ BrowserManager 作为单例管理
- ✅ 自动从 FrameworkSettings.web 读取配置
- ✅ 与 HttpClient、Database 保持一致

### 4. UI Fixtures 简化 (P0)

browser_manager fixture 直接从 RuntimeContext 获取单例，移除所有配置型 fixtures。

**实现**：

```python
# 测试文件 - 无需任何配置
def test_ui_example(page):
    """page fixture 自动从 RuntimeContext 获取配置"""
    page.goto("https://example.com")
    assert "Example" in page.title()
```

### 5. 使用示例

#### 环境变量配置（推荐）

```bash
# .env 文件
WEB__BROWSER_TYPE=chromium
WEB__HEADLESS=true
WEB__TIMEOUT=30000
WEB__RECORD_VIDEO=false
```

```python
# 测试文件 - 无需任何配置
def test_example(page):
    """自动使用环境变量配置"""
    page.goto("https://example.com")
    assert "Example" in page.title()
```

#### Python 代码配置

```python
# conftest.py 或 settings.py
from df_test_framework.infrastructure.config import FrameworkSettings, WebConfig

class MySettings(FrameworkSettings):
    web: WebConfig = WebConfig(
        browser_type="firefox",
        headless=False,
        viewport={"width": 1920, "height": 1080},
    )
```

#### 特定测试临时覆盖

```python
# 特定测试文件
def test_specific_config(runtime):
    """临时覆盖配置"""
    from df_test_framework.capabilities.drivers.web import BrowserManager

    # 临时使用 Firefox
    manager = BrowserManager(browser_type="firefox", headless=False)
    manager.start()

    page = manager.page
    page.goto("https://example.com")

    manager.stop()
```

## 文件变更

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/df_test_framework/infrastructure/config/schema.py` | 修改 | 新增 WebConfig 类 + FrameworkSettings.web 字段 |
| `src/df_test_framework/capabilities/drivers/web/playwright/browser.py` | 修改 | 支持 config 参数，参数默认值改为 None |
| `src/df_test_framework/bootstrap/runtime.py` | 修改 | RuntimeContext 新增 browser_manager() 方法 |
| `src/df_test_framework/bootstrap/providers.py` | 修改 | default_providers 新增 browser_manager 提供者 |
| `src/df_test_framework/testing/fixtures/ui.py` | 修改 | 简化实现，移除配置型 fixtures |
| `src/df_test_framework/infrastructure/config/__init__.py` | 修改 | 导出 WebConfig |
| `tests/testing/fixtures/test_ui_fixtures.py` | 修改 | 简化测试，16 个测试用例 |

## 测试验证

### 测试覆盖
- ✅ 所有 16 个测试通过
- ✅ WebConfig 默认值和自定义值
- ✅ WebConfig 验证（timeout 最小值 1000ms）
- ✅ BrowserManager 使用 WebConfig 创建
- ✅ 参数优先级测试
- ✅ WebConfig 导出验证

### 功能验证

```python
# 测试1: WebConfig 基本功能
from df_test_framework.infrastructure.config import WebConfig

config = WebConfig(browser_type="firefox", headless=False)
assert config.browser_type == "firefox"
assert config.headless is False

# 测试2: BrowserManager 使用 WebConfig
from df_test_framework.capabilities.drivers.web import BrowserManager

manager = BrowserManager(config=config)
assert manager.browser_type == BrowserType.FIREFOX
assert manager.headless is False

# 测试3: 参数优先级
manager = BrowserManager(
    browser_type=BrowserType.CHROMIUM,  # 显式参数优先
    config=config,  # config 中是 firefox
)
assert manager.browser_type == BrowserType.CHROMIUM  # ✅ 使用显式参数

# 测试4: RuntimeContext 集成
from df_test_framework.bootstrap import Bootstrap

app = Bootstrap().build()
runtime = app.run()
manager = runtime.browser_manager()
assert manager is not None
```

## 破坏性变更

### 移除配置型 Fixtures

**移除的 fixtures**：
- `browser_type`
- `browser_headless`
- `browser_timeout`
- `browser_viewport`
- `browser_record_video`
- `browser_video_dir`

**影响**：如果你的代码中重写了这些 fixtures，需要迁移到 WebConfig。

### browser_manager Fixture 签名变更

**之前** (v3.41.1):
```python
@pytest.fixture(scope="session")
def browser_manager(
    browser_type,
    browser_headless,
    browser_timeout,
    browser_viewport,
    browser_record_video,
    browser_video_dir,
):
    ...
```

**现在** (v3.42.0):
```python
@pytest.fixture(scope="session")
def browser_manager(runtime: RuntimeContext):
    return runtime.browser_manager()
```

### context Fixture 签名变更

**之前** (v3.41.1):
```python
@pytest.fixture(scope="function")
def context(
    browser,
    browser_viewport,
    browser_record_video,
    browser_video_dir,
):
    ...
```

**现在** (v3.42.0):
```python
@pytest.fixture(scope="function")
def context(browser: Browser):
    return browser.new_context()
```

## 迁移指南

### 场景1: 使用默认配置（无需迁移）

如果你没有重写任何配置型 fixtures，**无需任何修改**：

```python
# v3.41.1 和 v3.42.0 都兼容
def test_example(page):
    page.goto("https://example.com")
```

### 场景2: 重写了配置型 Fixtures（需要迁移）

**之前** (v3.41.1):
```python
# conftest.py
@pytest.fixture(scope="session")
def browser_type():
    return BrowserType.FIREFOX

@pytest.fixture(scope="session")
def browser_headless():
    return False

@pytest.fixture(scope="session")
def browser_timeout():
    return 60000
```

**迁移后** (v3.42.0):

```python
# 方式1: 环境变量配置（推荐）
# .env 文件
WEB__BROWSER_TYPE=firefox
WEB__HEADLESS=false
WEB__TIMEOUT=60000

# conftest.py - 删除所有配置型 fixtures
```

**或者**:

```python
# 方式2: Python 代码配置
# conftest.py
from df_test_framework.infrastructure.config import FrameworkSettings, WebConfig

class MySettings(FrameworkSettings):
    web: WebConfig = WebConfig(
        browser_type="firefox",
        headless=False,
        timeout=60000,
    )

# pytest.ini 或 conftest.py
import pytest

def pytest_configure(config):
    # 使用自定义 Settings
    pass
```

### 场景3: 需要动态配置（环境感知）

**之前** (v3.41.1):
```python
# conftest.py
@pytest.fixture(scope="session")
def browser_headless():
    import os
    return os.getenv("CI") == "true"
```

**迁移后** (v3.42.0):

```python
# 方式1: 环境变量（推荐）
# .env
WEB__HEADLESS=${CI:false}  # 如果 CI=true 则无头模式

# 方式2: 自定义 Settings
# settings.py
import os
from df_test_framework.infrastructure.config import FrameworkSettings, WebConfig

class MySettings(FrameworkSettings):
    web: WebConfig = WebConfig(
        headless=os.getenv("CI") == "true",
    )
```

## 已知问题

无。

## 依赖变更

无依赖变更。

## 贡献者

- Claude Sonnet 4.5 <noreply@anthropic.com>

---

**完整变更日志**: 查看 [CHANGELOG.md](../../CHANGELOG.md#3420---2026-01-08)
