# v3.14.0 发布说明

> **发布日期**: 2025-12-03（代码集成完成：2025-12-04）
> **版本类型**: 重大架构升级

---

## 概述

v3.14.0 是一次重大架构升级，将框架从"好用的工具集"提升为"企业级测试平台"。

核心变更：
1. **四层架构** + 横切关注点设计
2. **统一中间件系统**：洋葱模型替代 Interceptor
3. **可观测性融合**：Telemetry = Tracing + Metrics + Logging
4. **上下文传播系统**：ExecutionContext 贯穿全链路
5. **事件驱动架构**：EventBus 解耦组件通信

---

## 架构设计

### 四层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Layer 3: Interface                            │
│            testing/ (pytest) + cli/ (命令行)                      │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                    Layer 2: Capabilities                         │
│         capabilities/ (clients/databases/messengers/...)         │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                   Layer 1: Infrastructure                        │
│       infrastructure/ (config/providers/telemetry/plugins)       │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                 Layer 0: Core Abstractions                       │
│         core/ (protocols/middleware/context/events)              │
└─────────────────────────────────────────────────────────────────┘

                ╔═══════════════════════════════╗
                ║    横切关注点: plugins/        ║
                ╚═══════════════════════════════╝
```

### 依赖规则

- Layer N 只能依赖更低层
- `core/` 无第三方依赖（纯 Python）
- `plugins/` 作为横切关注点，可依赖任意层级

---

## 新功能详解

### 1. 统一中间件系统

**洋葱模型**：before 和 after 在同一作用域，自然共享状态。

```python
# v3.14.0 中间件
from df_test_framework.core.middleware import BaseMiddleware

class TimingMiddleware(BaseMiddleware):
    async def __call__(self, request, call_next):
        start = time.monotonic()  # before

        response = await call_next(request)

        duration = time.monotonic() - start  # after（直接访问 start）
        print(f"Duration: {duration:.3f}s")
        return response
```

**优先级规则**：数字越小越先执行（外层）。

```python
client = HttpClient(
    base_url="https://api.example.com",
    middlewares=[
        RetryMiddleware(priority=5),      # 最外层，先执行
        SignatureMiddleware(priority=10),
        LoggingMiddleware(priority=100),  # 最内层，最后执行
    ]
)
```

### 2. 可观测性融合 (Telemetry)

一次埋点，自动记录 Trace Span + Metrics + Log。

```python
from df_test_framework import Telemetry

telemetry = Telemetry(logger=logger)

async with telemetry.span("http.request", {"method": "POST"}) as span:
    response = await send_request()
    span.set_attribute("status_code", response.status_code)

# 自动记录：
# - Trace Span（包含 duration、attributes）
# - Histogram（http.request.duration）
# - Counter（http.request.success / http.request.error）
# - Log（Starting http.request / Completed http.request）
```

### 3. 上下文传播系统

ExecutionContext 自动贯穿 HTTP → DB → MQ。

```python
from df_test_framework import ExecutionContext, get_or_create_context

# 创建根上下文
ctx = ExecutionContext.create_root(user_id="user_001")

# 自动传播到所有操作
async with http_client:
    response = await http_client.get("/api")
    # 请求头自动包含 X-Trace-Id, X-Span-Id 等
```

### 4. 事件驱动架构

EventBus 解耦组件通信。

```python
from df_test_framework import EventBus, HttpRequestEndEvent

bus = EventBus()

@bus.on(HttpRequestEndEvent)
async def log_slow_request(event):
    if event.duration > 5.0:
        print(f"Slow request: {event.url} took {event.duration:.2f}s")

# 发布事件
await bus.publish(HttpRequestEndEvent(
    method="GET",
    url="/api/users",
    status_code=200,
    duration=6.5
))
```

### 5. HTTP 中间件

内置中间件：

| 中间件 | 功能 | 优先级 |
|--------|------|--------|
| `HttpTelemetryMiddleware` | 可观测性 | 1 |
| `RetryMiddleware` | 自动重试 | 5 |
| `SignatureMiddleware` | 请求签名 | 10 |
| `BearerTokenMiddleware` | Token 认证 | 20 |
| `LoggingMiddleware` | 日志记录 | 100 |

---

## 迁移指南

### 导入路径变更

```python
# v3.x
from df_test_framework.clients.http.interceptors.signature import SignatureInterceptor

# v3.14.0
from df_test_framework.capabilities.clients.http.middleware import SignatureMiddleware
# 或顶层导入
from df_test_framework import SignatureMiddleware
```

### Interceptor → Middleware

```python
# v3.x
class AddHeaderInterceptor(BaseInterceptor):
    def before_request(self, request):
        return request.with_header("X-Custom", "value")

# v3.14.0
class AddHeaderMiddleware(BaseMiddleware):
    async def __call__(self, request, call_next):
        request = request.with_header("X-Custom", "value")
        return await call_next(request)
```

### 优先级调整

| v3.x | v3.14.0 | 说明 |
|------|---------|------|
| priority=100 先执行 | priority=100 后执行 | 规则反转 |
| priority=10 后执行 | priority=10 先执行 | 与洋葱模型一致 |

---

## 完整变更列表

### 新增

- `core/` - Layer 0 纯抽象层
- `core/protocols/` - 协议定义
- `core/middleware/` - 统一中间件系统
- `core/context/` - 上下文传播
- `core/events/` - 事件类型
- `infrastructure/plugins/` - 插件系统重构
- `infrastructure/telemetry/` - 可观测性实现
- `infrastructure/events/` - 事件总线
- `infrastructure/context/carriers/` - 上下文载体
- `capabilities/` - 能力层统一目录
- `capabilities/clients/http/middleware/` - HTTP 中间件
- `plugins/` - 插件实现（横切关注点）

### 变更

- `extensions/` → 拆分到 `infrastructure/plugins/` + `plugins/`
- `common/` → 合并到 `core/`
- `interceptors` → 重命名为 `middleware`

---

## 技术决策

| 决策 | 选择 | 原因 |
|------|------|------|
| 中间件命名 | Middleware | 业界通用（Starlette/FastAPI/Koa） |
| 同步 API | 包装层 | 减少代码重复 |
| Core 层设计 | 纯抽象 | 无第三方依赖，便于测试 |
| HookSpecs 位置 | infrastructure/ | 依赖 pluggy，单一数据源 |
| 能力层组织 | capabilities/ 统一目录 | 分组清晰 |

---

## 代码集成（2025-12-04）

在架构设计完成后，我们将新系统完全集成到现有代码中。

### HttpClient 集成 MiddlewareChain

```python
from df_test_framework import HttpClient
from df_test_framework.capabilities.clients.http.middleware import LoggingMiddleware, RetryMiddleware

# 方式 1: 构造时传入
client = HttpClient(
    base_url="https://api.example.com",
    middlewares=[LoggingMiddleware(), RetryMiddleware()]
)

# 方式 2: 链式添加
client = HttpClient(base_url="https://api.example.com")
client.use(LoggingMiddleware()).use(RetryMiddleware())

# 使用新中间件系统发送请求
response = client.request_with_middleware("GET", "/users")
```

### Database 集成 EventBus

```python
from df_test_framework import Database
from df_test_framework.infrastructure.events import EventBus
from df_test_framework.core.events import DatabaseQueryEndEvent

bus = EventBus()

@bus.on(DatabaseQueryEndEvent)
async def log_slow_query(event):
    if event.duration > 1.0:
        print(f"慢查询: {event.sql} 耗时 {event.duration:.2f}s")

db = Database(config, event_bus=bus)
db.execute("SELECT * FROM users")  # 自动发布事件
```

### Messengers 集成 EventBus

```python
from df_test_framework.capabilities.messengers.queue.kafka import KafkaClient
from df_test_framework.infrastructure.events import EventBus
from df_test_framework.core.events import MessagePublishEvent

bus = EventBus()

@bus.on(MessagePublishEvent)
async def on_message_sent(event):
    print(f"消息已发送到 {event.topic}")

kafka = KafkaClient(config, event_bus=bus)
kafka.send("my-topic", {"data": "value"})  # 自动发布事件
```

### 向后兼容性

- ✅ 旧的 `interceptors` 参数仍可使用，会触发 DeprecationWarning
- ✅ 旧的导入路径仍可使用，会触发 DeprecationWarning
- ⚠️ 计划在 v3.16.0 移除废弃的 API

---

## 参考资料

- [架构设计文档](../architecture/V3.14_ENTERPRISE_PLATFORM_DESIGN.md)
- [迁移指南](../migration/v3.13-to-v3.14.md)
- [迁移状态追踪](../migration/v3.14-migration-status.md)
- [Starlette Middleware](https://www.starlette.io/middleware/)
- [OpenTelemetry Python](https://opentelemetry.io/docs/languages/python/)
