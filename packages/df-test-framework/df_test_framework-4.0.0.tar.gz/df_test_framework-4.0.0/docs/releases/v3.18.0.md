# v3.18.0 ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2025-12-10
**ç±»å‹**: åŠŸèƒ½å¢å¼ºç‰ˆæœ¬ - é…ç½®é©±åŠ¨æ¸…ç†ä¸æ•°æ®å‡†å¤‡

---

## ğŸ“‹ æ¦‚è¿°

v3.18.0 æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å¢å¼ºç‰ˆæœ¬ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. **é…ç½®å‰ç¼€ç»Ÿä¸€** - ç§»é™¤ `APP_` å‰ç¼€ï¼Œç¯å¢ƒå˜é‡ä¸ .env æ–‡ä»¶é…ç½®ä¿æŒä¸€è‡´
2. **é…ç½®é©±åŠ¨æ¸…ç†** - é€šè¿‡ `CLEANUP__MAPPINGS__*` é›¶ä»£ç é…ç½®æ•°æ®åº“æ¸…ç†æ˜ å°„
3. **æ•°æ®å‡†å¤‡ fixtures** - æ–°å¢ `prepare_data` å’Œ `data_preparer` è§£å†³ UoW æµ‹è¯•æ•°æ®æäº¤é—®é¢˜
4. **ConfigDrivenCleanupManager** - é…ç½®é©±åŠ¨çš„æ¸…ç†ç®¡ç†å™¨

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. é…ç½®å‰ç¼€ç»Ÿä¸€

**èƒŒæ™¯é—®é¢˜**ï¼š
- `EnvVarSource` ä½¿ç”¨ `APP_` å‰ç¼€
- `DotenvSource` æ²¡æœ‰å‰ç¼€
- å¯¼è‡´ `.env` æ–‡ä»¶é…ç½®æœ‰æ•ˆï¼Œä½†ç¯å¢ƒå˜é‡é…ç½®å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# v3.17.xï¼ˆæ—§ï¼‰
class EnvVarSource:
    prefix: str = "APP_"  # éœ€è¦ APP_TEST__REPOSITORY_PACKAGE

# v3.18.0ï¼ˆæ–°ï¼‰
class EnvVarSource:
    prefix: str = ""  # ç›´æ¥ä½¿ç”¨ TEST__REPOSITORY_PACKAGE
```

**é…ç½®ç¤ºä¾‹**ï¼š

```bash
# .env æ–‡ä»¶ï¼ˆv3.18.0 æ ¼å¼ï¼‰
TEST__REPOSITORY_PACKAGE=gift_card_test.repositories
CLEANUP__ENABLED=true
CLEANUP__MAPPINGS__orders__table=card_order
CLEANUP__MAPPINGS__orders__field=customer_order_no
```

### 2. é…ç½®é©±åŠ¨æ¸…ç†ç³»ç»Ÿ

**èƒŒæ™¯é—®é¢˜**ï¼š
- æ¯ä¸ªé¡¹ç›®éœ€è¦æ‰‹åŠ¨ç¼–å†™ `CleanupManager` ä»£ç 
- æ¸…ç†é€»è¾‘åˆ†æ•£åœ¨ conftest.py å’Œå„æµ‹è¯•æ–‡ä»¶ä¸­
- æ–°è¡¨æ·»åŠ éœ€è¦ä¿®æ”¹ä»£ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# é…ç½®ç±»ï¼ˆschema.pyï¼‰
class CleanupMapping(BaseModel):
    """æ¸…ç†æ˜ å°„é…ç½®"""
    table: str = Field(description="æ•°æ®åº“è¡¨å")
    field: str = Field(default="id", description="ç”¨äºæ¸…ç†çš„å­—æ®µå")

class CleanupConfig(BaseModel):
    """æ¸…ç†é…ç½®"""
    enabled: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨é…ç½®é©±åŠ¨æ¸…ç†")
    mappings: dict[str, CleanupMapping] = Field(default_factory=dict)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# .env é…ç½®
CLEANUP__ENABLED=true
CLEANUP__MAPPINGS__orders__table=card_order
CLEANUP__MAPPINGS__orders__field=customer_order_no
CLEANUP__MAPPINGS__cards__table=card_inventory
CLEANUP__MAPPINGS__cards__field=card_no
```

```python
# æµ‹è¯•ä»£ç 
def test_create_order(http_client, cleanup):
    """åˆ›å»ºè®¢å•æµ‹è¯•"""
    order_no = f"TEST_{uuid4().hex[:8]}"

    response = http_client.post("/orders", json={"order_no": order_no})
    assert response.status_code == 201

    # æ³¨å†Œæ¸…ç† - æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†
    cleanup.add("orders", order_no)
```

### 3. æ•°æ®å‡†å¤‡ Fixtures

**èƒŒæ™¯é—®é¢˜**ï¼š
- UoW é»˜è®¤ rollbackï¼Œæµ‹è¯•æ•°æ®æ— æ³•æäº¤
- éœ€è¦æ‰‹åŠ¨ç®¡ç† session å’Œ commit
- æ¸…ç†é€»è¾‘ä¸å‡†å¤‡é€»è¾‘åˆ†ç¦»

**è§£å†³æ–¹æ¡ˆ - prepare_data fixture**ï¼š

```python
def test_api_with_prepare_data(http_client, prepare_data, cleanup):
    """å›è°ƒå¼æ•°æ®å‡†å¤‡"""

    def setup(uow):
        # åœ¨ UoW å†…å‡†å¤‡æ•°æ®
        order = uow.orders.create(customer_id="C001", amount=100)
        return order

    # è‡ªåŠ¨ commit + æ³¨å†Œæ¸…ç†
    order = prepare_data(
        setup,
        cleanup_items=[("orders", order.order_no)]
    )

    # API æµ‹è¯•
    response = http_client.get(f"/orders/{order.order_no}")
    assert response.status_code == 200
```

**è§£å†³æ–¹æ¡ˆ - data_preparer fixture**ï¼š

```python
def test_api_with_data_preparer(http_client, data_preparer):
    """ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¼æ•°æ®å‡†å¤‡"""

    with data_preparer as dp:
        # ä½¿ç”¨ UoW å‡†å¤‡æ•°æ®
        order = dp.uow.orders.create(customer_id="C001", amount=100)

        # é“¾å¼æ³¨å†Œæ¸…ç†
        dp.cleanup("orders", order.order_no)

    # ç¦»å¼€ with å—åè‡ªåŠ¨ commit

    # API æµ‹è¯•
    response = http_client.get(f"/orders/{order.order_no}")
    assert response.status_code == 200
```

---

## ğŸ“¦ æ–°å¢ç±»å’Œ Fixtures

### é…ç½®ç±»

| ç±»å | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| `CleanupMapping` | `infrastructure/config/schema.py` | æ¸…ç†æ˜ å°„é…ç½®ï¼ˆtable/fieldï¼‰ |
| `CleanupConfig` | `infrastructure/config/schema.py` | æ¸…ç†é…ç½®ï¼ˆenabled/mappingsï¼‰ |

### æ¸…ç†ç®¡ç†å™¨

| ç±»å | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| `ConfigDrivenCleanupManager` | `testing/fixtures/cleanup.py` | é…ç½®é©±åŠ¨çš„æ¸…ç†ç®¡ç†å™¨ |

### Fixtures

| Fixture | æ–‡ä»¶ | è¯´æ˜ |
|---------|------|------|
| `cleanup` | `testing/fixtures/core.py` | é…ç½®é©±åŠ¨çš„æ¸…ç† fixture |
| `prepare_data` | `testing/fixtures/core.py` | å›è°ƒå¼æ•°æ®å‡†å¤‡ |
| `data_preparer` | `testing/fixtures/core.py` | ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¼æ•°æ®å‡†å¤‡ |

---

## ğŸ”„ å˜æ›´

### é…ç½®å‰ç¼€å˜æ›´

| ç»„ä»¶ | v3.17.x | v3.18.0 |
|------|---------|---------|
| `EnvVarSource.prefix` | `"APP_"` | `""` |
| `ArgSource.prefix` | `"APP_"` | `""` |
| `FrameworkSettings.env_prefix` | `"APP_"` | `""` |

### é…ç½®æ ¼å¼å˜æ›´

```bash
# v3.17.xï¼ˆæ—§ï¼‰
APP_TEST__REPOSITORY_PACKAGE=...
APP_DB__HOST=...

# v3.18.0ï¼ˆæ–°ï¼‰
TEST__REPOSITORY_PACKAGE=...
DB__HOST=...
```

### å‘åå…¼å®¹è¯´æ˜

å¦‚æœé¡¹ç›®ä½¿ç”¨äº† `APP_` å‰ç¼€çš„ç¯å¢ƒå˜é‡ï¼Œéœ€è¦æ›´æ–°ä¸ºæ— å‰ç¼€æ ¼å¼ã€‚

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### 1. é…ç½®æ¸…ç†æ˜ å°„

```bash
# .env æ–‡ä»¶
CLEANUP__ENABLED=true

# è®¢å•è¡¨æ¸…ç†æ˜ å°„
CLEANUP__MAPPINGS__orders__table=card_order
CLEANUP__MAPPINGS__orders__field=customer_order_no

# å¡ç‰‡è¡¨æ¸…ç†æ˜ å°„
CLEANUP__MAPPINGS__cards__table=card_inventory
CLEANUP__MAPPINGS__cards__field=card_no

# æ¨¡æ¿è¡¨æ¸…ç†æ˜ å°„
CLEANUP__MAPPINGS__templates__table=card_template
CLEANUP__MAPPINGS__templates__field=template_id
```

### 2. ä½¿ç”¨ cleanup fixture

```python
def test_create_order(http_client, cleanup):
    """æµ‹è¯•åˆ›å»ºè®¢å•"""
    order_no = DataGenerator.test_id("ORD")

    response = http_client.post("/orders", json={"order_no": order_no})
    assert response.status_code == 201

    # æ³¨å†Œæ¸…ç†
    cleanup.add("orders", order_no)
    # æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ‰§è¡Œæ¸…ç†
```

### 3. ä½¿ç”¨ prepare_data fixture

```python
def test_api_with_prepared_data(http_client, prepare_data):
    """æµ‹è¯•éœ€è¦é¢„ç½®æ•°æ®çš„ API"""

    def setup(uow):
        user = uow.users.create(name="Test User")
        return user

    user = prepare_data(setup, cleanup_items=[("users", user.user_id)])

    response = http_client.get(f"/users/{user.user_id}")
    assert response.status_code == 200
```

### 4. ä½¿ç”¨ data_preparer fixture

```python
def test_complex_setup(http_client, data_preparer):
    """å¤æ‚æ•°æ®å‡†å¤‡åœºæ™¯"""

    with data_preparer as dp:
        # åˆ›å»ºç”¨æˆ·
        user = dp.uow.users.create(name="Test User")
        dp.cleanup("users", user.user_id)

        # åˆ›å»ºè®¢å•
        order = dp.uow.orders.create(user_id=user.user_id)
        dp.cleanup("orders", order.order_no)

    # æ•°æ®å·²æäº¤ï¼Œå¯ä»¥è¿›è¡Œ API æµ‹è¯•
    response = http_client.get(f"/users/{user.user_id}/orders")
    assert response.status_code == 200
```

---

## ğŸ”„ å‡çº§æŒ‡å—

### ä» v3.17.x å‡çº§åˆ° v3.18.0

#### 1. æ›´æ–°é…ç½®å‰ç¼€

```bash
# æ—§é…ç½®ï¼ˆéœ€è¦æ›´æ–°ï¼‰
APP_TEST__REPOSITORY_PACKAGE=...

# æ–°é…ç½®
TEST__REPOSITORY_PACKAGE=...
```

#### 2. æ·»åŠ æ¸…ç†é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# .env æ·»åŠ æ¸…ç†é…ç½®
CLEANUP__ENABLED=true
CLEANUP__MAPPINGS__orders__table=your_order_table
CLEANUP__MAPPINGS__orders__field=order_no
```

#### 3. ä½¿ç”¨æ–° fixturesï¼ˆå¯é€‰ï¼‰

```python
# æ—§æ–¹å¼
def test_xxx(database, http_client):
    with database.session() as session:
        session.execute(...)
        session.commit()

# æ–°æ–¹å¼
def test_xxx(prepare_data, http_client):
    result = prepare_data(lambda uow: uow.repo.create(...))
```

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

```bash
$ uv run pytest tests/ -v --ignore=tests/test_messengers/
============================== test session starts ==============================
collected 1229 items

... (æ‰€æœ‰æµ‹è¯•) ...

============================== 1229 passed ===============================
```

---

## ğŸ“ å˜æ›´æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `infrastructure/config/sources.py` | å˜æ›´ | ç§»é™¤ APP_ å‰ç¼€ |
| `infrastructure/config/schema.py` | æ–°å¢ | CleanupMapping/CleanupConfig |
| `testing/fixtures/cleanup.py` | æ–°å¢ | ConfigDrivenCleanupManager |
| `testing/fixtures/core.py` | æ–°å¢ | cleanup/prepare_data/data_preparer |
| `testing/fixtures/__init__.py` | æ›´æ–° | å¯¼å‡ºæ–°ç±»å’Œ fixtures |

---

## ğŸ¯ åç»­è®¡åˆ’

v3.18.0 å®Œæˆäº†é…ç½®é©±åŠ¨æ¸…ç†å’Œæ•°æ®å‡†å¤‡ fixturesã€‚

ä¸‹ä¸€ä¸ªç‰ˆæœ¬è®¡åˆ’ï¼š
1. **v3.18.1**: æ·»åŠ  prepare_data/data_preparer å•å…ƒæµ‹è¯•
2. **v3.19.0**: TimeoutMiddleware / RateLimitMiddleware å®ç°

---

**å‘å¸ƒå›¢é˜Ÿ**: DF Test Framework å¼€å‘ç»„
**å‘å¸ƒæ—¥æœŸ**: 2025-12-10
