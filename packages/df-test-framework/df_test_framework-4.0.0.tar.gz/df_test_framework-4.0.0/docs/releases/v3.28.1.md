# v3.28.1 发布说明

> **发布日期**: 2025-12-14
> **版本类型**: 补丁版本（Bug 修复）

---

## 概述

v3.28.1 修复了 ConsoleDebugObserver 的事件订阅问题，并添加了 `-s` 标志提示功能。

---

## Bug 修复

### ConsoleDebugObserver 事件订阅修复

**问题**：ConsoleDebugObserver 使用字符串（如 `"http.request.started"`）订阅事件，但 EventBus 只接受事件类型类，导致 `AttributeError: 'str' object has no attribute '__name__'`。

**修复**：改用事件类型类进行订阅，保持类型安全。

```python
# ❌ 旧方式（错误）
event_bus.subscribe("http.request.started", handler)

# ✅ 新方式（正确）
event_bus.subscribe(HttpRequestStartEvent, handler)
```

---

## 改进

### 添加 `-s` 标志提示

当调试输出启用但 stderr 被 pytest 捕获时，自动显示提示：

```
WARNING | 调试输出已启用，使用 -s 标志查看彩色输出: pytest -v -s
```

**说明**：
- 调试输出（`console_debugger`、`@pytest.mark.debug`、`OBSERVABILITY__DEBUG_OUTPUT=true`）直接写入 stderr
- pytest 默认捕获 stderr，只有测试失败时才显示
- 使用 `-s` 标志可禁用捕获，实时查看彩色调试输出

---

## 文档更新

- 更新 `docs/architecture/observability-debugging-unification.md`，说明 `-s` 标志要求
- 更新 `testing/fixtures/debugging.py` 模块文档

---

## 使用方式

```bash
# 使用 -s 标志查看调试输出
pytest -v -s tests/

# 全局启用调试 + -s 标志
OBSERVABILITY__DEBUG_OUTPUT=true pytest -v -s tests/
```

```python
# 方式1：@pytest.mark.debug marker
@pytest.mark.debug
def test_api(http_client):
    response = http_client.get("/users")

# 方式2：显式使用 fixture
def test_api(http_client, console_debugger):
    response = http_client.get("/users")
```

---

## 升级指南

直接升级即可，无需修改代码。如果之前遇到 `AttributeError` 错误，升级后将自动修复。

---

## 相关文档

- [可观测性与调试系统统一设计](../architecture/observability-debugging-unification.md)
- [v3.28.0 发布说明](./v3.28.0.md)
