# v3.21.0 发布说明

> **发布日期**: 2025-12-13
> **Python 要求**: >= 3.12

---

## 概述

v3.21.0 新增 `clear_cookies()` 方法，解决认证流程测试中的 **Session Token 复用问题**。

---

## 新增功能

### `HttpClient.clear_cookies()`

清除 httpx 客户端的 Cookies，强制服务器创建新 Session。

```python
# 清除 cookies，服务器将创建新 Session 并生成新 Token
http_client.clear_cookies()
```

---

## 问题背景

### Session Token 复用问题

在测试认证流程时，发现以下问题：

1. 用户登出后，Token 被加入服务器黑名单
2. 清除框架 Token 缓存（`clear_auth_cache()`）
3. 重新登录时，服务器返回**相同的 Token**（已被黑名单）
4. 后续请求失败，返回 401

**根本原因**：服务器基于 Session（通过 httpx cookies 识别）复用 Token。

### 解决方案

登出后同时清除两层缓存：

```python
# ✅ 推荐做法
admin_auth_api.logout()
admin_auth_api.http_client.clear_auth_cache()  # 清除框架 Token 缓存
admin_auth_api.http_client.clear_cookies()     # 清除 httpx cookies（强制新 Session）
```

---

## 使用示例

### 测试登出功能

```python
def test_admin_logout(admin_auth_api, settings):
    """测试登出功能"""
    # 登录
    admin_auth_api.login(settings.business.admin_username, settings.business.admin_password)

    # 登出
    admin_auth_api.logout()

    # ✅ 清理缓存（确保不影响其他测试）
    admin_auth_api.http_client.clear_auth_cache()
    admin_auth_api.http_client.clear_cookies()
```

### 测试完整认证流程

```python
def test_full_auth_flow(admin_auth_api, settings):
    """测试完整的登录-登出流程"""
    from df_test_framework import BusinessError
    from httpx import HTTPStatusError

    # 1. 登录
    login_response = admin_auth_api.login(username, password)
    token = login_response.data.token

    # 2. 获取用户信息
    user_response = admin_auth_api.get_current_user(token=token)
    assert user_response.success

    # 3. 登出
    admin_auth_api.logout(token=token)

    # 4. 验证 Token 失效
    with pytest.raises((BusinessError, HTTPStatusError)):
        admin_auth_api.get_current_user(token=token)

    # 5. 清理
    admin_auth_api.http_client.clear_auth_cache()
    admin_auth_api.http_client.clear_cookies()
```

---

## API 参考

### `HttpClient.clear_cookies()`

```python
def clear_cookies(self) -> None:
    """清除 httpx 客户端的 Cookies（v3.21.0）

    用于在登出后清除 Session，让服务器创建新 Session。

    配合 clear_auth_cache() 使用，确保完全清除认证状态。

    Example:
        >>> # 登出后清理
        >>> http_client.clear_auth_cache()   # 清除框架 Token 缓存
        >>> http_client.clear_cookies()      # 清除 httpx cookies
    """
```

---

## 相关文档

- [认证与 Session 管理指南](../guides/auth_session_guide.md) - 详细使用指南
- [中间件使用指南](../guides/middleware_guide.md) - BearerTokenMiddleware 用法

---

## 升级建议

如果你的测试中有登出功能测试，建议在登出后同时调用两个方法：

```python
# 升级前
admin_auth_api.logout()
admin_auth_api.http_client.clear_auth_cache()  # 可能不够

# 升级后（推荐）
admin_auth_api.logout()
admin_auth_api.http_client.clear_auth_cache()
admin_auth_api.http_client.clear_cookies()     # 确保清除 Session
```

---

## 变更列表

### 新增
- `HttpClient.clear_cookies()` - 清除 httpx 客户端的 Cookies

### 文档
- `docs/releases/v3.21.0.md` - 本发布说明
- `docs/guides/auth_session_guide.md` - 认证与 Session 管理指南
