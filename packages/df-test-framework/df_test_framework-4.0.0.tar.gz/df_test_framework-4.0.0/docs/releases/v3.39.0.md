# v3.39.0 - 脚手架增量合并 + 示例文件重命名

**发布日期**: 2025-12-30

## 概述

本版本新增脚手架增量合并功能，解决 OpenAPI 代码生成覆盖用户自定义代码的问题。同时将示例文件从 `user` 重命名为 `example`，避免与 OpenAPI 规范中常见的 `user` tag 冲突。

## 核心特性

### 1. 增量合并功能

#### 问题背景

在使用 `df-test gen from-swagger` 生成代码后，用户可能会添加自定义方法、辅助函数等扩展代码。之前重新生成时会覆盖这些自定义内容。

#### 解决方案

引入 **分区标记系统**：

```python
# ========== AUTO-GENERATED START ==========
# 此区域由脚手架自动生成，重新生成时会被更新

class ExampleAPI(BaseAPI):
    def get_example(self, example_id: int) -> dict:
        return self.get(f"/examples/{example_id}")

# ========== AUTO-GENERATED END ==========


# ========== USER EXTENSIONS ==========
# 在此区域添加自定义代码，重新生成时会保留

def custom_helper():
    """用户自定义的辅助函数"""
    pass
```

#### 使用方式

```bash
# 首次生成（完整生成）
df-test gen from-swagger --spec api.json

# 增量合并（保留用户扩展）
df-test gen from-swagger --spec api.json --merge
```

### 2. 示例文件重命名

将脚手架生成的示例文件从 `user` 重命名为 `example`，避免与 OpenAPI 规范中的 `user` tag 冲突：

| 原名称 | 新名称 |
|--------|--------|
| `models/requests/user.py` | `models/requests/example.py` |
| `models/responses/user.py` | `models/responses/example.py` |
| `apis/user_api.py` | `apis/example_api.py` |
| `UserAPI` | `ExampleAPI` |
| `user_api` (fixture) | `example_api` |

### 3. 动态 `__init__.py` 生成增强

`generate_init_from_directory()` 函数现在会：
1. 使用 AST 解析提取模块的 `__all__` 定义
2. 生成显式的 `from .module import Class1, Class2` 导入
3. 生成包级别的 `__all__` 列表

**之前**：
```python
from . import user
```

**现在**：
```python
from .example import CreateExampleRequest, UpdateExampleRequest

__all__ = ["CreateExampleRequest", "UpdateExampleRequest"]
```

## 新增 API

### `merge_with_markers(existing_content, new_content) -> str`

基于标记合并两段代码：
- 保留 `existing_content` 中 `USER EXTENSIONS` 区域的内容
- 使用 `new_content` 中 `AUTO-GENERATED` 区域的内容

```python
from df_test_framework.cli.utils import merge_with_markers

merged = merge_with_markers(existing_code, new_generated_code)
```

### `create_file_with_merge(path, content, force, merge) -> bool`

支持合并模式的文件创建：

```python
from df_test_framework.cli.utils import create_file_with_merge

# 合并模式：保留用户扩展
create_file_with_merge(path, content, force=False, merge=True)
```

## 分区标记规范

所有支持增量合并的文件必须包含以下标记：

```python
# ========== AUTO-GENERATED START ==========
# 此区域由脚手架自动生成，重新生成时会被更新

# ... 自动生成的代码 ...

# ========== AUTO-GENERATED END ==========


# ========== USER EXTENSIONS ==========
# 在此区域添加自定义代码，重新生成时会保留

# ... 用户自定义代码 ...
```

## 受影响的文件

### 模板文件
- `templates/project/models_requests_example.py`
- `templates/project/models_responses_example.py`
- `templates/project/user_api_example.py` → 导出 `EXAMPLE_API_TEMPLATE`
- `templates/project/test_example.py`

### 生成器
- `generators/openapi_generator.py` - 所有生成文件添加分区标记

### 工具函数
- `cli/utils.py` - 新增 `merge_with_markers()`、`create_file_with_merge()`、`_extract_all_from_file()`

## 迁移指南

### 已有项目升级

如果你的项目使用了旧版本生成的 `user` 示例文件：

1. **可选择保留**：旧文件仍然可用，只是示例命名不同
2. **如需更新**：手动重命名文件并更新导入

```bash
# 可选：重命名旧文件
mv src/your_project/models/requests/user.py src/your_project/models/requests/example.py
mv src/your_project/models/responses/user.py src/your_project/models/responses/example.py
mv src/your_project/apis/user_api.py src/your_project/apis/example_api.py
```

### 使用增量合并

1. 确保生成的文件包含分区标记
2. 将自定义代码移至 `USER EXTENSIONS` 区域
3. 使用 `--merge` 选项重新生成

## 测试覆盖

- 新增 `test_merge_with_markers` - 3 个测试用例
- 新增 `test_create_file_with_merge` - 5 个测试用例
- 新增 `test_generate_with_explicit_all` - 1 个测试用例
- 全部 1967 个测试通过

## 兼容性

- ✅ 向后兼容：不影响现有项目
- ✅ 渐进式采用：可选择性使用 `--merge` 选项
- ✅ 旧文件保留：已生成的 `user` 文件继续可用
