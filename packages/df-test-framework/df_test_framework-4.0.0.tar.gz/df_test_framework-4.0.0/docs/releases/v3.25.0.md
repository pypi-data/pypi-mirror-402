# v3.25.0 发布说明 - 认证管理能力增强

> **发布日期**: 2025-12-14
> **Python 要求**: >= 3.12

---

## 概述

v3.25.0 增强了 HttpClient 的认证管理能力，简化了登出后的状态清理流程，新增认证状态查询和 Cookie 精细控制功能。

---

## 新增功能

### 1. `reset_auth_state()` - 组合方法

一次调用完全清除认证状态，替代手动调用两个方法。

```python
# 之前（v3.21.0）
http_client.clear_auth_cache()
http_client.clear_cookies()

# 现在（v3.25.0）- 推荐
http_client.reset_auth_state()  # 一次调用，完全清除
```

### 2. `get_auth_info()` - 认证状态查询

查询当前认证状态，方便调试。

```python
info = http_client.get_auth_info()
print(info)
# {
#     'has_token_cache': True,
#     'token_preview': 'eyJhbGciOiJIUzI1NiIs...',
#     'middleware_count': 1,
#     'cookies_count': 2,
#     'cookies': ['JSESSIONID', 'XSRF-TOKEN']
# }
```

### 3. `clear_cookie(name)` - 精细控制

只删除指定的 Cookie，而非清除所有。

```python
# 只删除 Session Cookie
deleted = http_client.clear_cookie("JSESSIONID")
if deleted:
    print("Session Cookie 已删除")
```

### 4. `get_cookies()` - 获取所有 Cookies

获取当前 httpx 客户端存储的所有 Cookies。

```python
cookies = http_client.get_cookies()
# {'JSESSIONID': 'abc123', 'XSRF-TOKEN': 'xyz789'}
```

### 5. `ApiKeyMiddleware` 增强

支持通过 Request.metadata 控制 API Key 行为。

```python
# 跳过 API Key
response = http_client.get("/public", skip_api_key=True)

# 使用自定义 API Key
response = http_client.get("/api", custom_api_key="my_key")
```

---

## 使用示例

### 场景 1：登出后重置认证状态（推荐）

```python
def test_admin_logout(admin_auth_api, settings):
    """测试登出功能"""
    # 登录
    admin_auth_api.login(username, password)

    # 登出
    admin_auth_api.logout()

    # ✅ v3.25.0 推荐：一次调用完全清除
    admin_auth_api.http_client.reset_auth_state()
```

### 场景 2：调试认证状态

```python
def test_debug_auth(admin_auth_api):
    """调试认证状态"""
    # 登录
    admin_auth_api.login(username, password)

    # 查看认证状态
    info = admin_auth_api.http_client.get_auth_info()
    print(f"Token 已缓存: {info['has_token_cache']}")
    print(f"Cookies: {info['cookies']}")

    # 继续测试...
```

### 场景 3：精细控制 Cookie

```python
def test_session_management(http_client):
    """测试 Session 管理"""
    # 执行请求（服务器会设置 Cookies）
    http_client.post("/login", json={"user": "admin"})

    # 查看 Cookies
    cookies = http_client.get_cookies()
    assert "JSESSIONID" in cookies

    # 只删除 Session Cookie
    http_client.clear_cookie("JSESSIONID")

    # 其他 Cookies 保留
    remaining = http_client.get_cookies()
    assert "JSESSIONID" not in remaining
```

### 场景 4：测试不带 API Key 的请求

```python
def test_public_endpoint(api_client):
    """测试公开接口（不需要 API Key）"""
    # 跳过 API Key
    response = api_client.get("/public/status", skip_api_key=True)
    assert response.status_code == 200
```

---

## API 参考

### HttpClient 新增方法

```python
def reset_auth_state(self) -> None:
    """重置认证状态（v3.25.0）

    组合调用 clear_auth_cache() 和 clear_cookies()，
    用于登出后完全清除认证状态。
    """

def get_auth_info(self) -> dict[str, Any]:
    """获取当前认证信息（v3.25.0）

    Returns:
        认证信息字典，包含：
        - has_token_cache: 是否有 Token 缓存
        - token_preview: Token 预览（前20字符）
        - middleware_count: BearerTokenMiddleware 数量
        - cookies_count: Cookies 数量
        - cookies: Cookie 名称列表
    """

def clear_cookie(self, name: str) -> bool:
    """清除指定的 Cookie（v3.25.0）

    Args:
        name: Cookie 名称

    Returns:
        True 如果成功删除，False 如果不存在
    """

def get_cookies(self) -> dict[str, str]:
    """获取当前所有 Cookies（v3.25.0）

    Returns:
        Cookie 字典 {name: value}
    """
```

### ApiKeyMiddleware 新增 metadata 支持

```python
# 通过 Request.metadata 控制
request.with_metadata("skip_api_key", True)      # 跳过 API Key
request.with_metadata("custom_api_key", "xxx")   # 自定义 API Key

# 通过请求参数传递（推荐）
http_client.get("/api", skip_api_key=True)
http_client.get("/api", custom_api_key="my_key")
```

---

## 升级建议

### 简化登出清理

```python
# 升级前
admin_auth_api.logout()
admin_auth_api.http_client.clear_auth_cache()
admin_auth_api.http_client.clear_cookies()

# 升级后（推荐）
admin_auth_api.logout()
admin_auth_api.http_client.reset_auth_state()
```

### 添加调试输出

```python
# 调试认证问题时
info = http_client.get_auth_info()
print(f"认证状态: {info}")
```

---

## 向后兼容性

- ✅ 所有改动向后兼容
- ✅ 现有代码无需修改
- ✅ 新方法均为可选增强

---

## 变更列表

### 新增
- `HttpClient.reset_auth_state()` - 组合方法
- `HttpClient.get_auth_info()` - 认证状态查询
- `HttpClient.clear_cookie(name)` - 精细 Cookie 控制
- `HttpClient.get_cookies()` - 获取所有 Cookies
- `ApiKeyMiddleware` 支持 `skip_api_key` 和 `custom_api_key`

### 文档
- `docs/releases/v3.25.0.md` - 本发布说明

### 测试
- 新增 12 个测试用例，全部通过

---

## 相关文档

- [认证与 Session 管理指南](../guides/auth_session_guide.md)
- [中间件使用指南](../guides/middleware_guide.md)
