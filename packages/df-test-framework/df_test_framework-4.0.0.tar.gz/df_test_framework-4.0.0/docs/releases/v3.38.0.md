# v3.38.0 发布说明 - OpenAPI 代码生成器增强

**发布日期**: 2025-12-24

## 概述

v3.38.0 重大改进 OpenAPI 代码生成器，新增 Swagger 2.0 完整支持、Java/Python 命名自动转换、Model 分类生成和强类型 API 方法。同时优化了脚手架模板，新增 VSCode、EditorConfig、GitAttributes 等开发配置文件。

## 核心特性

### 1. Swagger 2.0 完整支持

OpenAPI 解析器现在完全兼容 Swagger 2.0 和 OpenAPI 3.0 两种格式：

```python
from df_test_framework.cli.generators import generate_from_openapi

# 支持 Swagger 2.0 格式
generate_from_openapi("swagger.json")

# 支持 OpenAPI 3.0 格式
generate_from_openapi("openapi.yaml")

# 支持从 URL 加载
generate_from_openapi("https://api.example.com/swagger.json")
```

**Swagger 2.0 兼容改进**：
- 从 `parameters` 提取请求体（`in: body`）
- 支持 `responses.schema` 直接格式
- 自动解析 `$ref` 引用获取完整 schema
- 宽松解析模式，兼容不规范的 Swagger 文档

### 2. Java/Python 命名自动转换

字段名自动从 Java 惯例转换为 Python 惯例：

```python
# 后端 Java API 返回
{
    "userId": 1,
    "userName": "Alice",
    "createdAt": "2025-12-24"
}

# 生成的 Python 模型
class UserResponse(BaseModel):
    """用户响应模型"""

    model_config = ConfigDict(populate_by_name=True)

    user_id: int = Field(..., alias="userId")
    user_name: str = Field(..., alias="userName")
    created_at: str = Field(..., alias="createdAt")
```

**特性**：
- `camelCase` → `snake_case` 自动转换
- 保留原始名称作为 `alias`（序列化时使用）
- `populate_by_name=True` 支持双向兼容
- 符合 PEP8 规范和 Python 最佳实践

### 3. Model 分类生成

模型按类型和 API 标签组织：

```
src/{project_name}/models/
├── __init__.py          # 导出通用模型
├── base.py              # Result[T]、PageInfo[T] 等通用包装
├── requests/
│   ├── __init__.py
│   ├── user.py          # 用户相关请求模型
│   └── order.py         # 订单相关请求模型
└── responses/
    ├── __init__.py
    ├── user.py          # 用户相关响应模型
    └── order.py         # 订单相关响应模型
```

**通用响应包装类**：

```python
from df_test_framework.models.base import Result, PageInfo

# Result[T] - 通用响应包装
class Result(BaseModel, Generic[T]):
    code: int
    message: str
    data: T | None

# PageInfo[T] - 分页响应
class PageInfo(BaseModel, Generic[T]):
    total: int
    current: int
    size: int
    records: list[T]
```

### 4. 强类型 API 方法

生成的 API 客户端使用强类型方法签名：

```python
from df_test_framework import BaseAPI, HttpClient
from df_test_framework.testing.decorators import api_class
from ..models.requests.user import CreateUserRequest
from ..models.responses.user import CreateUserResponse

@api_class("user_api", scope="function")
class UserAPI(BaseAPI):
    """用户 API 客户端"""

    def __init__(self, http_client: HttpClient):
        super().__init__(http_client)
        self.base_path = "/api/v1/users"

    def create_user(self, request: CreateUserRequest) -> CreateUserResponse:
        """创建用户

        Args:
            request: CreateUserRequest 请求模型

        Returns:
            CreateUserResponse: 响应数据
        """
        return self.post(self.base_path, json=request, model=CreateUserResponse)
```

**优势**：
- IDE 智能提示和类型检查
- BaseAPI 自动序列化请求模型
- BaseAPI 自动解析响应模型
- `@api_class` 装饰器自动注册 fixture

### 5. 脚手架模板增强

新增开发配置文件模板：

| 文件 | 用途 |
|------|------|
| `.vscode/settings.json` | VSCode 工作区配置（Python、pytest、Ruff） |
| `.editorconfig` | 跨编辑器代码风格统一 |
| `.gitattributes` | Git 文件处理规则 |
| `models/requests/user.py` | 请求模型示例 |
| `models/responses/user.py` | 响应模型示例 |
| `apis/user_api.py` | API 客户端示例 |

**VSCode 配置亮点**：
- Python 解释器和类型检查配置
- pytest 测试框架配置
- Ruff 格式化和代码检查
- 文件排除规则（`.venv`、`__pycache__` 等）

### 6. Swagger 文档获取脚本

新增 `scripts/fetch_swagger.py` 脚本，自动从 Swagger UI 获取 OpenAPI 文档：

```bash
# 从 Swagger UI 获取文档
python scripts/fetch_swagger.py http://localhost:8080/swagger-ui/index.html

# 指定输出文件名
python scripts/fetch_swagger.py http://localhost:8080 my_api.json
```

**特性**：
- 自动探测常见 API 文档端点（`/v3/api-docs`、`/swagger.json` 等）
- 支持 `swagger-resources` 资源发现
- 自动提取基础 URL
- 生成后提示下一步操作命令

### 7. 中文 Tag 自动转换

OpenAPI 生成器支持中文 tag 自动转换为合法的 ASCII 标识符：

```python
# 原始 tag: "用户管理"
# 生成的文件名和类名:

# 有 pypinyin 库时
models/requests/yong_hu_guan_li.py
class YongHuGuanLiAPI(BaseAPI): ...

# 无 pypinyin 库时
models/requests/tag_a1b2c3.py
class TagA1b2c3API(BaseAPI): ...
```

**特性**：
- 优先使用 pypinyin 转换拼音（安装方式见下方）
- 无依赖时自动生成 `tag_xxxxxx` 格式标识符
- 注释和文档保留原始中文名称便于识别

**安装 pypinyin**：
```bash
# 方式1：安装 codegen 可选依赖组
pip install df-test-framework[codegen]

# 方式2：单独安装
pip install pypinyin
```

## 使用示例

### 从 Swagger 文档生成代码

```bash
# CLI 方式
uv run df-test generate openapi swagger.json

# 指定输出目录
uv run df-test generate openapi swagger.json --output ./my_project

# 只生成模型
uv run df-test generate openapi swagger.json --models-only

# 过滤指定标签
uv run df-test generate openapi swagger.json --tags user,order
```

### 代码方式调用

```python
from df_test_framework.cli.generators import generate_from_openapi

generate_from_openapi(
    "https://api.example.com/swagger.json",
    generate_tests=True,
    generate_clients=True,
    generate_models=True,
    tags=["user", "order"],
)
```

### 使用生成的代码

```python
# conftest.py
from df_test_framework.testing.decorators import load_api_fixtures
from my_project.apis.user_api import UserAPI  # noqa: F401

load_api_fixtures(globals())

# tests/api/test_user_api.py
from my_project.models.requests.user import CreateUserRequest

def test_create_user(user_api):
    """测试创建用户"""
    request = CreateUserRequest(
        user_name="Alice",
        email="alice@example.com"
    )
    response = user_api.create_user(request)

    assert response.code == 200
    assert response.data.user_name == "Alice"
```

## 其他改进

### 修复

- 修复模板文件 import 路径错误（`attach_json`, `step`）
- 修复 `$ref` 引用未解析导致模型字段为空的问题
- 添加 `Any` 类型导入支持复杂类型定义
- 为 `sync_playwright` 添加 ImportError 占位符
- 修复 OpenAPI 解析器未识别 `*/*` content-type 导致响应模型未生成的问题（SpringDoc 兼容）

### 增强

- `Environment` 枚举新增 `LOCAL` 值
- 新增 debugging/metrics/monitoring Entry Points
- 优化脚手架 README 模板

## 测试验证

- ✅ 生成 16 个请求模型，15 字段完整展开
- ✅ 生成 18 个响应模型，字段正确解析
- ✅ 18 个强类型 API 方法
- ✅ Python snake_case ↔ JSON camelCase 自动转换
- ✅ BaseAPI 集成测试通过
- ✅ 所有代码编译通过
- ✅ 1891 个测试全部通过

## 升级指南

### 从 v3.37.0 升级

v3.38.0 完全向后兼容，无需修改现有代码。

如果你之前使用 OpenAPI 生成器，建议重新生成以获得新特性：

```bash
# 备份现有代码（可选）
mv src/my_project/apis src/my_project/apis_backup
mv src/my_project/models src/my_project/models_backup

# 重新生成
uv run df-test generate openapi swagger.json --force
```

## 相关文档

- [OpenAPI 代码生成器使用指南](../guides/openapi_guide.md)
- [脚手架 CLI 工具指南](../guides/scaffold_cli_guide.md)
- [测试执行生命周期](../architecture/TEST_EXECUTION_LIFECYCLE.md)
