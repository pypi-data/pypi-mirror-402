# v3.41.1 - 架构优化与请求模型增强

**发布日期**: 2026-01-04

## 概述

本次版本主要进行了两项重要改进：将基础模型从 `models/` 迁移到 `core/models/` 以符合五层架构设计，以及增强 `BaseRequest` 类使其默认排除 None 值，解决自动生成的请求模型发送大量 null 值导致的后端问题。

## 核心特性

### 1. 架构优化：模型迁移到 core 层 (P0)

**问题**：基础模型位于 `models/` 目录，不符合五层架构设计。

**解决**：将基础模型迁移到 `core/models/`，属于 Layer 0 核心层，与 `types.py` 中的类型定义同级。

**影响**：
- ✅ 导入路径自动兼容（顶层导出未变化）
- ✅ 符合五层架构设计原则
- ✅ 代码组织更加清晰

**之前**：
```python
# 内部实现位置
df_test_framework/models/base.py

# 导入方式（未变化）
from df_test_framework import BaseRequest, BaseResponse, PageResponse
```

**现在**：
```python
# 内部实现位置
df_test_framework/core/models/base.py

# 导入方式（保持兼容）
from df_test_framework import BaseRequest, BaseResponse, PageResponse
```

### 2. BaseRequest 增强：默认排除 None 值 (P0)

**问题**：OpenAPI 代码生成器生成的请求模型包含大量可选字段（`field: str | None = None`），序列化时默认发送 `null` 值，导致：
- 后端接收到 `{"name": "test", "age": null, "email": null, ...}` 冗余数据
- 某些后端框架将 `null` 解析为数据库 NULL，导致 SQL 错误或数据异常

**解决**：BaseRequest 重写 `model_dump()` 和 `model_dump_json()` 方法，默认设置 `exclude_none=True` 和 `by_alias=True`。

**之前**：
```python
class BaseRequest(BaseModel):
    model_config = {
        "extra": "forbid",
        "str_strip_whitespace": True,
    }
```

**现在**：
```python
class BaseRequest(BaseModel):
    model_config = ConfigDict(
        extra="forbid",
        str_strip_whitespace=True,
        populate_by_name=True,  # 支持 snake_case 和 camelCase
    )

    def model_dump(self, **kwargs: Any) -> dict[str, Any]:
        """序列化模型，默认排除 None 值和使用别名"""
        kwargs.setdefault("exclude_none", True)
        kwargs.setdefault("by_alias", True)
        return super().model_dump(**kwargs)

    def model_dump_json(self, **kwargs: Any) -> str:
        """序列化为 JSON 字符串，默认排除 None 值和使用别名"""
        kwargs.setdefault("exclude_none", True)
        kwargs.setdefault("by_alias", True)
        return super().model_dump_json(**kwargs)
```

**效果对比**：

```python
# v3.41.0 及之前
request = MyRequest(name="test")  # age、email 等字段默认为 None
request.model_dump()
# {"name": "test", "age": null, "email": null, ...}  ❌ 冗余

# v3.41.1
request = MyRequest(name="test")
request.model_dump()
# {"name": "test"}  ✅ 简洁

# 如果需要包含 None 值，可以手动指定
request.model_dump(exclude_none=False)
# {"name": "test", "age": null, "email": null, ...}
```

### 3. OpenAPI 代码生成器同步更新 (P1)

**改进**：生成的请求模型现在使用 `BaseRequest` 基类，自动继承排除 None 值的特性。

**之前**：
```python
# v3.41.0 生成的请求模型
from pydantic import BaseModel, ConfigDict, Field

class FindSupplierListRequest(BaseModel):
    model_config = ConfigDict(populate_by_name=True)

    pagination: dict[str, Any] | None = Field(default=None, alias="pagination")
    sort_name: str | None = Field(default=None, alias="sortName")
```

**现在**：
```python
# v3.41.1 生成的请求模型
from pydantic import Field
from df_test_framework import BaseRequest

class FindSupplierListRequest(BaseRequest):
    """请求模型 - 自动排除 None 值和使用别名"""
    pagination: dict[str, Any] | None = Field(default=None, alias="pagination")
    sort_name: str | None = Field(default=None, alias="sortName")
```

**优势**：
- ✅ 无需重复定义 `model_config`
- ✅ 自动排除 None 值
- ✅ 自动使用字段别名（camelCase）
- ✅ 代码更简洁，减少 3-5 行样板代码

## 文件变更

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/df_test_framework/core/models/__init__.py` | 新增 | 基础模型导出 |
| `src/df_test_framework/core/models/base.py` | 新增 | BaseRequest 增强实现 |
| `src/df_test_framework/models/__init__.py` | 删除 | 迁移到 core.models |
| `src/df_test_framework/models/base.py` | 删除 | 迁移到 core.models |
| `src/df_test_framework/__init__.py` | 修改 | 更新导入路径 |
| `src/df_test_framework/core/__init__.py` | 修改 | 新增模型导出 |
| `src/df_test_framework/cli/generators/openapi_generator.py` | 修改 | 请求模型使用 BaseRequest 基类 |
| `src/df_test_framework/capabilities/clients/http/rest/httpx/base_api.py` | 修改 | 代码格式化（Ruff） |

## 测试验证

### 测试覆盖
- ✅ 所有 2016 个测试通过
- ✅ 基础模型迁移后的导入兼容性验证通过
- ✅ BaseRequest 排除 None 值功能验证通过

### 功能验证

```python
# 验证导入
from df_test_framework import BaseRequest, BaseResponse, PageResponse
assert BaseRequest.__module__ == "df_test_framework.core.models.base"

# 验证排除 None 值
class TestRequest(BaseRequest):
    name: str
    age: int | None = None

request = TestRequest(name="test")
assert request.model_dump() == {"name": "test"}  # ✅ 不包含 age: null
```

## 破坏性变更

**无破坏性变更**。所有导入路径保持兼容，顶层导出 `from df_test_framework import BaseRequest` 继续工作。

## 迁移指南

**无需迁移**。现有代码无需任何修改即可升级到 v3.41.1。

如果需要明确包含 None 值（极少数场景），可以手动指定：
```python
request.model_dump(exclude_none=False)
```

## 已知问题

无。

## 依赖变更

无依赖变更。

## 贡献者

- Claude Opus 4.5 <noreply@anthropic.com>

---

**完整变更日志**: 查看 [CHANGELOG.md](../../CHANGELOG.md#3411---2026-01-04)