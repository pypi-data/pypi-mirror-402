# v3.38.7 - 简化日志系统架构

**发布日期**: 2025-12-26

## 概述

本版本简化框架日志系统架构，遵循 structlog 最佳实践：

1. **日志级别由消息性质决定** - debug/info/warning/error 调用对应方法
2. **全局配置控制过滤** - YAML `logging.level` 控制显示级别
3. **直接使用 structlog** - 无需包装器，`get_logger()` 返回原生 BoundLogger
4. **中间件使用固定级别** - 请求/响应 → DEBUG，错误 → ERROR

## 架构设计

```
┌─────────────────────────────────────────────────────────┐
│  业务层 (capabilities/中间件/客户端等)                    │
│  ↓ 依赖 Logger Protocol（类型注解）                      │
├─────────────────────────────────────────────────────────┤
│  infrastructure/logging/interface.py                    │
│  - Logger Protocol（定义 debug/info/warning 等方法）     │
│  - 无 log() 方法 - 日志级别由消息性质决定                 │
├─────────────────────────────────────────────────────────┤
│  infrastructure/logging/logger.py                       │
│  - get_logger() → structlog.get_logger()               │
│  - 直接返回 structlog.BoundLogger                       │
├─────────────────────────────────────────────────────────┤
│  structlog.BoundLogger (原生实现)                        │
└─────────────────────────────────────────────────────────┘
```

## 核心变更

### 1. LoggingMiddleware 简化（⚠️ 不兼容变更）

**之前**: 支持可配置的 `level` 参数

```python
# 旧实现
middleware = LoggingMiddleware(level="INFO")  # 可配置级别
```

**现在**: 使用固定日志级别，通过全局配置过滤

```python
# 新实现
middleware = LoggingMiddleware()  # 无 level 参数

# 日志级别固定：
#   - 请求/响应详情 → DEBUG
#   - 错误 → ERROR

# 显示控制：通过 config/base.yaml
# logging:
#   level: DEBUG  → 显示所有
#   level: INFO   → 隐藏请求/响应详情
#   level: ERROR  → 只显示错误
```

**设计理由**:

1. **遵循 structlog 最佳实践** - 日志级别由消息性质决定，而非调用者配置
2. **简化 API** - 移除不必要的配置参数
3. **统一控制** - 通过全局配置统一管理日志过滤

### 2. Logger Protocol 精简

**移除**: `log(level, event)` 方法

**保留**: 只定义 structlog.BoundLogger 原生方法

```python
# infrastructure/logging/interface.py
@runtime_checkable
class Logger(Protocol):
    """日志接口 - 用于类型注解

    Note:
        日志级别由消息性质决定（debug/info/warning/error），
        全局 logging.level 配置控制显示过滤。
    """
    def debug(self, event: str, **kwargs: Any) -> None: ...
    def info(self, event: str, **kwargs: Any) -> None: ...
    def warning(self, event: str, **kwargs: Any) -> None: ...
    def error(self, event: str, **kwargs: Any) -> None: ...
    def critical(self, event: str, **kwargs: Any) -> None: ...
    def exception(self, event: str, **kwargs: Any) -> None: ...
    def bind(self, **kwargs: Any) -> "Logger": ...
    def unbind(self, *keys: str) -> "Logger": ...
    def try_unbind(self, *keys: str) -> "Logger": ...
```

### 3. get_logger() 直接返回 structlog

**移除**: `StructLogger` 包装器

**现在**: 直接返回 structlog.get_logger()

```python
# infrastructure/logging/logger.py
def get_logger(name: str | None = None) -> "Logger":
    """获取 logger 实例

    直接返回 structlog.BoundLogger，它已实现 Logger Protocol 的所有方法。
    """
    return structlog.get_logger(name)
```

## 日志级别配置说明

### 配置层级

| 配置 | 来源 | 作用范围 | 优先级 |
|------|------|----------|--------|
| `logging.level` | YAML | 框架内部模块 | 高 |
| `log_level` | pyproject.toml | pytest 默认日志捕获 | 中 |
| `log_cli_level` | pyproject.toml/命令行 | pytest 实时日志显示 | 低 |

### 配置示例

```yaml
# config/base.yaml
logging:
  level: INFO   # 框架内部模块日志级别
  format: text
```

```toml
# pyproject.toml
[tool.pytest]
log_level = "DEBUG"       # pytest 捕获所有级别（便于调试）
log_cli_level = "WARNING" # 实时显示只输出警告及以上
```

### 效果说明

- `logging.level: INFO` → LoggingMiddleware 的请求/响应详情不显示
- `logging.level: DEBUG` → 显示所有日志
- `logging.level: ERROR` → 只显示错误

## 测试

- 全部 1908 个测试通过
- 移除 3 个过时的 level 参数测试
- 40 个测试被跳过（外部依赖）

## 迁移指南

### 从 v3.38.5/v3.38.6 升级

**⚠️ 不兼容变更**: `LoggingMiddleware` 移除 `level` 参数

**之前**:

```python
# 不再支持
middleware = LoggingMiddleware(level="INFO")
```

**现在**:

```python
# 移除 level 参数
middleware = LoggingMiddleware()

# 通过 YAML 配置控制日志显示级别
# config/base.yaml:
# logging:
#   level: INFO
```

### 验证升级

```bash
# 安装新版本
pip install df-test-framework==3.38.7

# 验证日志级别配置生效
# config/base.yaml 设置 logging.level: INFO
# 运行测试，确认 Allure 报告中无框架内部 DEBUG 日志
uv run pytest -v --alluredir=reports/allure-results
```

## 文件变更列表

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `infrastructure/logging/interface.py` | 修改 | 移除 `log()` 方法 |
| `infrastructure/logging/logger.py` | 修改 | 移除 StructLogger，直接返回 structlog |
| `infrastructure/logging/__init__.py` | 修改 | 移除 StructLogger 导出 |
| `capabilities/clients/http/middleware/logging.py` | 修改 | 移除 level 参数，使用固定级别 |
| `tests/capabilities/clients/http/middleware/test_logging.py` | 修改 | 移除 level 参数测试 |
