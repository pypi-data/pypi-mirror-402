# v3.18.1 Bug 修复说明

## 问题描述

在 v3.18.1 初始版本中,顶层中间件配置的环境变量解析存在问题,导致 JSON 数组格式的路径配置无法正确解析。

### 症状

- 配置了 `SIGNATURE__INCLUDE_PATHS=["/master/**","/h5/**"]`
- 但请求 `/master/card/create` 时返回 401 Unauthorized
- 错误信息: "缺少签名参数"

### 根本原因

`MiddlewareConfig.normalize_paths` validator 没有处理 JSON 数组字符串,导致:

```python
# 错误的解析结果
include_paths = ['["/master/**","/h5/**"]']  # 单个字符串元素

# 路径匹配失败
PathPattern(pattern='["/master/**","/h5/**"]').matches("/master/card/create")  # False ❌
```

## 修复方案

更新 `middleware_schema.py` 中的 `normalize_paths` validator:

```python
@field_validator("include_paths", "exclude_paths", mode="before")
@classmethod
def normalize_paths(cls, value: Any) -> list[str]:
    """规范化路径列表

    支持:
    - None → []
    - "path" → ["path"]
    - ["path1", "path2"] → ["path1", "path2"]
    - '["/path1","/path2"]' (JSON字符串) → ["/path1", "/path2"]
    """
    import json

    if value is None:
        return []
    if isinstance(value, str):
        # 尝试解析 JSON 数组格式的字符串
        if value.strip().startswith("[") and value.strip().endswith("]"):
            try:
                parsed = json.loads(value)
                if isinstance(parsed, list):
                    return parsed
            except json.JSONDecodeError:
                pass
        # 普通字符串,作为单个路径
        return [value]
    return list(value)
```

## 验证

修复后的解析结果:

```python
# 正确的解析结果
include_paths = ['/master/**', '/h5/**']  # 两个独立的路径

# 路径匹配成功
PathPattern(pattern='/master/**').matches("/master/card/create")  # True ✅
```

## 影响范围

此问题仅影响使用 v3.18.1 顶层中间件配置且通过环境变量配置路径的用户。

**受影响的配置**:
- `SIGNATURE__INCLUDE_PATHS`
- `SIGNATURE__EXCLUDE_PATHS`
- `BEARER_TOKEN__INCLUDE_PATHS`
- `BEARER_TOKEN__EXCLUDE_PATHS`

**不受影响的配置**:
- 代码中硬编码的中间件配置
- 通过 `http.middlewares` 直接配置的中间件

## 迁移建议

如果你已经部署了 v3.18.1 并遇到认证失败问题:

1. 更新到修复后的版本
2. 保持 `.env` 文件配置不变（JSON 数组格式已支持）
3. 重新运行测试验证

无需修改代码或配置文件。
