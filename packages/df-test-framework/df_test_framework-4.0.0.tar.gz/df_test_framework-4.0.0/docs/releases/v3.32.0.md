# v3.32.0 发布说明

**发布日期**: 2025-12-17

## 概述

v3.32.0 版本将 gRPC 客户端从拦截器模式重构为中间件模式，与 HTTP 客户端架构统一。同时集成事件系统，支持 Allure 报告和控制台调试，让 gRPC 服务测试更加透明和易于调试。

### 核心改进

1. **中间件模式重构** - 从 Interceptor 重构为 Middleware，与 HTTP 客户端架构一致
2. **GrpcEventPublisherMiddleware** - gRPC 事件发布中间件，自动记录请求/响应/错误
3. **Allure 报告集成** - gRPC 调用自动记录到 Allure 步骤
4. **控制台调试支持** - 实时显示 gRPC 请求/响应信息
5. **默认启用事件** - GrpcClient 默认启用事件发布，开箱即用

## 重大变更：中间件模式重构

### 从拦截器到中间件

v3.32.0 将 gRPC 客户端从拦截器（Interceptor）模式重构为中间件（Middleware）模式，与 HTTP 客户端的架构保持一致。

**主要变更**:
- `interceptors` 参数更名为 `middlewares`
- `add_interceptor()` 方法更名为 `use()`
- 中间件基类为 `GrpcMiddleware`，继承自 `BaseMiddleware[GrpcRequest, GrpcResponse]`
- 使用 `MiddlewareChain` 执行中间件（洋葱模型）

```python
# 旧的拦截器模式 (< v3.32.0)
from df_test_framework.capabilities.clients.grpc import GrpcClient
from df_test_framework.capabilities.clients.grpc.interceptors import LoggingInterceptor

client = GrpcClient("localhost:50051", interceptors=[LoggingInterceptor()])

# 新的中间件模式 (v3.32.0+)
from df_test_framework.capabilities.clients.grpc import GrpcClient, GrpcLoggingMiddleware

client = GrpcClient("localhost:50051", middlewares=[GrpcLoggingMiddleware()])

# 链式添加中间件
client.use(GrpcMetadataMiddleware({"Authorization": "Bearer token"}))
```

## 新功能

### 1. gRPC 中间件系统

新增完整的中间件系统，位于 `capabilities/clients/grpc/middleware/`：

```python
from df_test_framework.capabilities.clients.grpc import (
    GrpcClient,
    GrpcMiddleware,           # 基类
    GrpcLoggingMiddleware,    # 日志中间件
    GrpcMetadataMiddleware,   # 元数据中间件
    GrpcRetryMiddleware,      # 重试中间件
    GrpcTimingMiddleware,     # 耗时统计中间件
    GrpcEventPublisherMiddleware,  # 事件发布中间件
)

# 组合多个中间件
client = GrpcClient(
    "localhost:50051",
    stub_class=GreeterStub,
    middlewares=[
        GrpcLoggingMiddleware(log_request=True, log_response=True),
        GrpcMetadataMiddleware({"x-request-id": "abc"}),
        GrpcRetryMiddleware(max_retries=3),
        GrpcTimingMiddleware(),
    ],
)
```

### 2. GrpcRequest 数据类

新增 `GrpcRequest` 数据类，用于在中间件链中传递请求信息：

```python
from df_test_framework.capabilities.clients.grpc.models import GrpcRequest

request = GrpcRequest(
    method="SayHello",
    message={"name": "World"},
    metadata=[("x-request-id", "123")],
    timeout=30.0,
)

# 链式添加元数据
request = request.with_metadata("x-trace-id", "abc")

# 获取元数据
value = request.get_metadata("x-request-id")  # "123"

# 转为字典
metadata_dict = request.metadata_dict  # {"x-request-id": "123", "x-trace-id": "abc"}
```

### 3. gRPC 事件类型

新增三个 gRPC 事件类型，与 HTTP 事件保持一致的设计模式：

```python
from df_test_framework.core.events import (
    GrpcRequestStartEvent,
    GrpcRequestEndEvent,
    GrpcRequestErrorEvent,
)

# 事件属性
# GrpcRequestStartEvent: service, method, metadata, request_data, correlation_id
# GrpcRequestEndEvent: service, method, status_code, status_message, duration, response_data, correlation_id
# GrpcRequestErrorEvent: service, method, error_code, error_type, error_message, duration, correlation_id
```

### 4. GrpcEventPublisherMiddleware

事件发布中间件，自动将 gRPC 请求/响应/错误发布到 EventBus：

```python
from df_test_framework.capabilities.clients.grpc import (
    GrpcClient,
    GrpcEventPublisherMiddleware,
)

# 方式1: 自动启用（默认）
client = GrpcClient(
    "localhost:50051",
    stub_class=GreeterStub,
    # enable_events=True  # 默认启用
    service_name="greeter",  # 可选，自定义服务名
)

# 方式2: 禁用事件
client = GrpcClient(
    "localhost:50051",
    stub_class=GreeterStub,
    enable_events=False,
)

# 方式3: 手动添加中间件（更多控制）
from df_test_framework.infrastructure.events import EventBus

event_bus = EventBus()
middleware = GrpcEventPublisherMiddleware(
    event_bus=event_bus,
    service_name="greeter",
    log_request_data=True,
    log_response_data=True,
    max_data_length=1000,
)
client = GrpcClient(
    "localhost:50051",
    stub_class=GreeterStub,
    middlewares=[middleware],
    enable_events=False,  # 禁用自动添加
)
```

### 5. GrpcEventPublisherMiddleware 配置选项

```python
middleware = GrpcEventPublisherMiddleware(
    event_bus=None,           # EventBus 实例（None 时使用全局实例）
    service_name="",          # 服务名称（用于事件记录）
    enabled=True,             # 是否启用事件发布
    log_request_data=True,    # 是否记录请求数据
    log_response_data=True,   # 是否记录响应数据
    max_data_length=1000,     # 数据最大长度（超出截断）
)
```

### 6. Allure 报告集成

gRPC 调用自动记录到 Allure 报告中，显示：
- 服务名和方法名
- 状态码和状态信息
- 请求/响应数据
- 调用耗时
- 错误信息（如有）

```python
import pytest
from df_test_framework.testing.fixtures import allure_observer

def test_grpc_with_allure(grpc_client, allure_observer):
    """gRPC 调用自动记录到 Allure"""
    response = grpc_client.unary_call("SayHello", request)

    # Allure 报告中会显示：
    # 🔗 gRPC greeter.SayHello ✅ (50ms)
    #   - 请求数据
    #   - 响应数据
```

### 7. 控制台调试支持

使用 ConsoleDebugObserver 实时查看 gRPC 调用信息：

```python
from df_test_framework.testing.debugging import (
    ConsoleDebugObserver,
    create_console_debugger,
)

# 方式1: 使用工厂函数
debugger = create_console_debugger(
    show_grpc=True,           # 显示 gRPC 调用
    show_grpc_metadata=True,  # 显示元数据
    show_grpc_data=True,      # 显示请求/响应数据
    max_grpc_data_length=500, # 数据截断长度
)
debugger.subscribe()

# 执行 gRPC 调用时会实时打印：
# [gRPC] greeter.SayHello
# ├─ Metadata: x-correlation-id=cor-xxx
# └─ Request: {"name": "World"}
#
# [gRPC] greeter.SayHello ✅ OK (50ms)
# └─ Response: {"message": "Hello World"}
```

### 8. 服务名自动提取

GrpcClient 可以从 stub 类名自动提取服务名：

```python
# stub 类名为 GreeterStub -> 服务名为 Greeter
client = GrpcClient("localhost:50051", stub_class=GreeterStub)
# GrpcEventPublisherMiddleware 的 service_name 自动设置为 "Greeter"

# 也可以手动指定
client = GrpcClient(
    "localhost:50051",
    stub_class=GreeterStub,
    service_name="custom.Greeter",  # 覆盖自动提取的名称
)
```

## 中间件列表

| 中间件 | 说明 | 默认 priority |
|--------|------|---------------|
| GrpcMiddleware | 基类 | 100 |
| GrpcLoggingMiddleware | 日志记录 | 100 |
| GrpcMetadataMiddleware | 添加元数据 | 100 |
| GrpcRetryMiddleware | 重试（指数退避） | 100 |
| GrpcTimingMiddleware | 耗时统计 | 100 |
| GrpcEventPublisherMiddleware | 事件发布 | 999（最内层） |

## 与 HTTP 客户端的对比

| 特性 | HTTP | gRPC |
|------|------|------|
| 中间件基类 | `BaseMiddleware[Request, Response]` | `GrpcMiddleware` (继承自 `BaseMiddleware[GrpcRequest, GrpcResponse]`) |
| 中间件链 | `MiddlewareChain` | `MiddlewareChain` |
| 事件发布 | HttpEventPublisherMiddleware | GrpcEventPublisherMiddleware |
| 开始事件 | HttpRequestStartEvent | GrpcRequestStartEvent |
| 结束事件 | HttpRequestEndEvent | GrpcRequestEndEvent |
| 错误事件 | HttpRequestErrorEvent | GrpcRequestErrorEvent |
| 关联 ID | correlation_id | correlation_id |
| Allure 集成 | ✅ | ✅ |
| 控制台调试 | ✅ | ✅ |

## 升级指南

### 从 v3.31.0 升级

**1. 参数名称变更**:
```python
# v3.31.0
client = GrpcClient("localhost:50051", interceptors=[...])

# v3.32.0
client = GrpcClient("localhost:50051", middlewares=[...])
```

**2. 中间件类名变更**:
```python
# v3.31.0
from df_test_framework.capabilities.clients.grpc.interceptors import LoggingInterceptor

# v3.32.0
from df_test_framework.capabilities.clients.grpc import GrpcLoggingMiddleware
```

**3. GrpcTracingInterceptor**:
```python
# v3.31.0
from df_test_framework.infrastructure.tracing import GrpcTracingInterceptor

# v3.32.0（向后兼容）
from df_test_framework.infrastructure.tracing import GrpcTracingInterceptor  # 仍可用（别名）
from df_test_framework.infrastructure.tracing import GrpcTracingMiddleware   # 推荐
```

**4. 现有测试调整**:
如果测试依赖于精确的中间件数量，需要考虑自动添加的 GrpcEventPublisherMiddleware：
```python
# v3.31.0
client = GrpcClient("localhost:50051")
assert len(client.interceptors) == 0

# v3.32.0
client = GrpcClient("localhost:50051")
assert len(client.middlewares) == 1  # 自动添加 GrpcEventPublisherMiddleware

# 或禁用事件
client = GrpcClient("localhost:50051", enable_events=False)
assert len(client.middlewares) == 0
```

## 测试覆盖

新增 52 个 gRPC 中间件测试：
- `TestGrpcMiddleware` - 基类测试（3 个）
- `TestGrpcLoggingMiddleware` - 日志中间件测试（2 个）
- `TestGrpcMetadataMiddleware` - 元数据中间件测试（4 个）
- `TestGrpcRetryMiddleware` - 重试中间件测试（4 个）
- `TestGrpcTimingMiddleware` - 耗时统计中间件测试（4 个）
- `TestGrpcEventPublisherMiddleware` - 事件发布中间件测试（8 个）
- `TestGrpcClient` - 客户端测试（26 个）
- `TestGrpcTracingMiddleware` - 追踪中间件测试

## 文件变更

### 新增
- `src/df_test_framework/capabilities/clients/grpc/middleware/__init__.py` - 中间件模块导出
- `src/df_test_framework/capabilities/clients/grpc/middleware/base.py` - 中间件基类
- `src/df_test_framework/capabilities/clients/grpc/middleware/logging.py` - 日志中间件
- `src/df_test_framework/capabilities/clients/grpc/middleware/metadata.py` - 元数据中间件
- `src/df_test_framework/capabilities/clients/grpc/middleware/retry.py` - 重试中间件
- `src/df_test_framework/capabilities/clients/grpc/middleware/timing.py` - 耗时统计中间件
- `src/df_test_framework/capabilities/clients/grpc/middleware/event_publisher.py` - 事件发布中间件
- `tests/capabilities/clients/grpc/test_middleware.py` - 中间件测试

### 删除
- `src/df_test_framework/capabilities/clients/grpc/interceptors.py` - 旧的拦截器模式
- `tests/capabilities/clients/grpc/test_interceptors.py` - 旧的拦截器测试

### 修改
- `src/df_test_framework/core/events/types.py` - 新增 gRPC 事件类型
- `src/df_test_framework/core/events/__init__.py` - 导出 gRPC 事件
- `src/df_test_framework/capabilities/clients/grpc/models.py` - 新增 GrpcRequest 数据类
- `src/df_test_framework/capabilities/clients/grpc/__init__.py` - 导出中间件类
- `src/df_test_framework/capabilities/clients/grpc/client.py` - 使用中间件链
- `src/df_test_framework/infrastructure/tracing/interceptors/grpc.py` - 重构为 GrpcTracingMiddleware
- `src/df_test_framework/plugins/builtin/reporting/allure_plugin.py` - gRPC 事件处理
- `src/df_test_framework/testing/debugging/console.py` - gRPC 调试支持
- `tests/capabilities/clients/grpc/test_client.py` - 适配中间件模式
- `tests/unit/infrastructure/tracing/test_interceptors.py` - 适配 GrpcTracingMiddleware

## 设计决策

### 为什么选择中间件模式而不是 gRPC 原生拦截器？

**背景**：gRPC 有原生的拦截器机制（`grpc.UnaryUnaryClientInterceptor`），为什么不直接使用？

**决策**：采用与 HTTP 客户端一致的中间件模式（洋葱模型）。

**理由**：

1. **框架一致性** - HTTP、gRPC、GraphQL 客户端使用统一的中间件 API，降低开发者认知负担
2. **用户面向框架** - 用户使用的是 `GrpcClient`，不是直接操作 gRPC 原生 API
3. **统一抽象** - 用户用同样的方式添加中间件：`client.use(middleware)`

```python
# HTTP 和 gRPC 使用一致的 API
http_client.use(AuthMiddleware())
grpc_client.use(GrpcAuthMiddleware())
```

### 为什么需要 GrpcRequest 数据类？

**背景**：HTTP 有 httpx 的 `Request` 对象，gRPC 没有统一的请求对象。

**决策**：创建 `GrpcRequest` 数据类封装请求信息。

**理由**：

1. **中间件需要完整上下文** - method、message、metadata、timeout
2. **支持中间件修改请求** - 如 `request.with_metadata("key", "value")`
3. **与 HTTP 中间件模式对齐** - 中间件签名一致：`__call__(request, call_next) -> response`

### 为什么中间件是异步的？

**背景**：gRPC Python 主要是同步调用，但中间件设计为异步。

**决策**：保持异步中间件，在同步调用中使用 `asyncio.run()` 执行。

**理由**：

1. **与 HTTP 中间件一致** - HTTP 中间件是异步的
2. **测试框架场景可接受** - `asyncio.run()` 的开销在测试场景下不是瓶颈
3. **未来兼容** - 如果使用 `grpc.aio`，可以直接支持

**已知限制**：
- 在已有事件循环中调用可能有问题（如 pytest-asyncio 的 async 测试中）
- 如果后续有实际问题，可针对性优化

## 下一版本预告

v3.33.0 计划实现 Storage 事件系统统一，将 LocalFile/S3/OSS 存储客户端集成到事件系统中。
