# v3.18.1 发布说明

**发布日期**: 2025-12-10

## 核心特性：顶层中间件配置

v3.18.1 引入了顶层中间件配置支持，允许通过环境变量配置签名中间件和 Bearer Token 中间件，无需在代码中硬编码。

### 主要变更

#### 1. 新增顶层中间件配置字段

在 `FrameworkSettings` 中新增两个顶层字段：

```python
class FrameworkSettings(BaseSettings):
    # ... 其他字段 ...

    # v3.18.1: 顶层中间件配置
    signature: SignatureMiddlewareConfig | None = None
    bearer_token: BearerTokenMiddlewareConfig | None = None
```

#### 2. 环境变量配置支持

现在可以通过 `.env` 文件或环境变量配置中间件：

```bash
# 签名中间件配置
SIGNATURE__ENABLED=true
SIGNATURE__PRIORITY=10
SIGNATURE__ALGORITHM=md5
SIGNATURE__SECRET=your_secret_key
SIGNATURE__HEADER=X-Sign
# 注意：列表类型需要使用 JSON 数组格式
SIGNATURE__INCLUDE_PATHS=["/api/**","/master/**"]
SIGNATURE__EXCLUDE_PATHS=["/health","/metrics"]

# Bearer Token 中间件配置
BEARER_TOKEN__ENABLED=true
BEARER_TOKEN__PRIORITY=20
BEARER_TOKEN__SOURCE=login
BEARER_TOKEN__LOGIN_URL=/admin/login
# 注意：字典类型需要使用 JSON 对象格式
BEARER_TOKEN__CREDENTIALS={"username":"admin","password":"password"}
BEARER_TOKEN__TOKEN_PATH=data.token
BEARER_TOKEN__HEADER=Authorization
BEARER_TOKEN__TOKEN_PREFIX=Bearer
# 注意：列表类型需要使用 JSON 数组格式
BEARER_TOKEN__INCLUDE_PATHS=["/admin/**"]
BEARER_TOKEN__EXCLUDE_PATHS=["/admin/login"]
```

> **重要**:
> - 列表类型的配置（如 `INCLUDE_PATHS`、`EXCLUDE_PATHS`）必须使用 JSON 数组格式
> - 字典类型的配置（如 `CREDENTIALS`）必须使用 JSON 对象格式
> - 不支持嵌套键方式（如 `CREDENTIALS__username`）

#### 3. 自动合并到 http.middlewares

顶层中间件配置会在 Settings 初始化时自动合并到 `http.middlewares`：

- 如果 `signature` 已配置且 `enabled=True`，自动添加到中间件链
- 如果 `bearer_token` 已配置且 `enabled=True`，自动添加到中间件链
- 如果 `http.middlewares` 中已存在同类型中间件，跳过顶层配置（优先使用 http.middlewares）

### 使用示例

#### Before (v3.18.0) - 硬编码中间件

```python
# settings.py
def create_http_config() -> HTTPConfig:
    return HTTPConfig(
        base_url="https://api.example.com",
        middlewares=[
            SignatureMiddlewareConfig(
                algorithm=SignatureAlgorithm.MD5,
                secret="hardcoded_secret",  # 密钥硬编码在代码中
                include_paths=["/api/**"],
            ),
            BearerTokenMiddlewareConfig(
                source=TokenSource.LOGIN,
                login_url="/admin/login",
                credentials={"username": "admin", "password": "pass"},
                include_paths=["/admin/**"],
            ),
        ],
    )

class MySettings(FrameworkSettings):
    http: HTTPConfig = Field(default_factory=create_http_config)
```

#### After (v3.18.1) - 环境变量配置

```python
# settings.py - 简化，无需硬编码中间件
class MySettings(FrameworkSettings):
    http: HTTPConfig = Field(
        default_factory=lambda: HTTPConfig(
            base_url="https://api.example.com",
            # 中间件通过环境变量配置，自动合并
        )
    )
```

```bash
# .env - 所有中间件配置在环境变量中
SIGNATURE__ENABLED=true
SIGNATURE__SECRET=your_secret_from_vault
SIGNATURE__INCLUDE_PATHS=/api/**

BEARER_TOKEN__ENABLED=true
BEARER_TOKEN__SOURCE=login
BEARER_TOKEN__LOGIN_URL=/admin/login
```

### 优势

1. **配置与代码分离** - 敏感信息（密钥、密码）不再硬编码在代码中
2. **环境切换更灵活** - 不同环境使用不同的 `.env` 文件
3. **向后兼容** - 现有的 `http.middlewares` 配置方式仍然有效
4. **CI/CD 友好** - 通过环境变量注入配置，适合容器化部署

### 迁移指南

1. 将 `settings.py` 中的中间件配置移到 `.env` 文件
2. 删除 `create_http_config()` 函数中的 `middlewares` 参数
3. 更新 `.env.example` 添加中间件配置模板

### 兼容性

- **向后兼容**：现有代码无需修改，`http.middlewares` 配置方式仍然有效
- **优先级**：`http.middlewares` 中的同类型中间件优先于顶层配置
- **Python 版本**：要求 Python 3.12+
- **依赖版本**：无变化

### 相关 PR

- [框架] 新增 `signature` 和 `bearer_token` 顶层字段
- [框架] 新增 `_merge_toplevel_middlewares` model_validator
- [项目] gift-card-test 迁移到环境变量配置

---

**完整更新日志**: [CHANGELOG.md](../../CHANGELOG.md)
