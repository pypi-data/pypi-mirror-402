# v3.37.0 发布说明 - 现代化插件系统

**发布日期**: 2025-12-21

## 概述

v3.37.0 完全重写了 pytest 插件系统，采用 2025 年 pytest 官方最佳实践。主要改进包括 pytest11 Entry Points 自动发现、pytest 9.0 原生 TOML 配置、以及使用 config 对象属性管理状态。这次重构删除了约 1000 行代码，大幅简化了架构。

## 核心特性

### 1. pytest11 Entry Points - 自动插件发现

pip install 后插件自动加载，无需在 conftest.py 中手动声明 `pytest_plugins`：

```toml
# pyproject.toml
[project.entry-points.pytest11]
df_test_framework_core = "df_test_framework.testing.fixtures.core"
df_test_framework_env = "df_test_framework.testing.plugins.env_plugin"
df_test_framework_logging = "df_test_framework.testing.plugins.logging_plugin"
df_test_framework_markers = "df_test_framework.testing.plugins.markers"
df_test_framework_allure = "df_test_framework.testing.fixtures.allure"
```

**优势**:
- 安装即用，零配置
- 用户 conftest.py 更简洁
- 符合 pytest 官方推荐方式

### 2. pytest 9.0 原生 TOML 配置

使用 `[tool.pytest]` 替代 `[tool.pytest.ini_options]`：

```toml
# 旧方式 (pytest < 9.0)
[tool.pytest.ini_options]
minversion = "8.0"
testpaths = ["tests"]

# 新方式 (pytest 9.0+)
[tool.pytest]
minversion = "9.0"
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = ["-v", "--strict-markers", "--tb=short"]
timeout = "30"
timeout_method = "thread"
asyncio_mode = "auto"
```

**注意**: pytest-timeout 在原生 TOML 模式下期望 timeout 值为字符串类型。

### 3. config 对象属性状态管理

使用 pytest 官方推荐的 `config` 对象属性管理插件状态，替代自定义管理器类：

```python
# 旧方式 - 使用管理器类
class RuntimeContextManager:
    _instance: RuntimeContext | None = None

    @classmethod
    def get(cls) -> RuntimeContext:
        if cls._instance is None:
            raise RuntimeError("未初始化")
        return cls._instance

# 新方式 - 使用 config 属性
def pytest_configure(config: pytest.Config) -> None:
    # 存储到 config 对象
    config._df_runtime = runtime_context
    config._df_settings = settings
    config._df_current_env = env

@pytest.fixture(scope="session")
def runtime(request: pytest.FixtureRequest) -> RuntimeContext:
    return request.config._df_runtime
```

**config 属性命名规范**:
| 属性 | 用途 |
|------|------|
| `config._df_runtime` | RuntimeContext 实例 |
| `config._df_settings` | 框架配置 (FrameworkSettings) |
| `config._df_current_env` | 当前环境名称 |
| `config._df_env_name` | 命令行指定的环境 |
| `config._df_config_dir` | 配置目录路径 |
| `config._df_test_buses` | 测试隔离的 EventBus 字典 |
| `config._df_cache_cleared` | 配置缓存清理标记 |

### 4. 架构简化 - 删除 managers.py

移除了 `src/df_test_framework/testing/plugins/managers.py`，该文件包含：
- `RuntimeContextManager` - 运行时上下文管理器
- `CacheManager` - 配置缓存管理器
- `ConfigSettingsManager` - 配置设置管理器

所有状态管理功能直接使用 config 对象属性实现，代码量减少约 1000 行。

## 迁移指南

### 从 v3.36.x 迁移

1. **移除 conftest.py 中的 pytest_plugins 声明**（如果有）：

```python
# 旧代码 - 删除这行
pytest_plugins = ["df_test_framework.testing.fixtures.core"]

# 新代码 - conftest.py 可以是空的或只包含项目特定配置
"""pytest 配置文件

v3.37.0: 框架插件通过 pytest11 Entry Points 自动加载
"""
```

2. **如果直接使用了 managers.py**（极少数情况）：

```python
# 旧代码
from df_test_framework.testing.plugins.managers import RuntimeContextManager
runtime = RuntimeContextManager.get()

# 新代码 - 使用 fixture
def test_example(runtime):
    # runtime 由 fixture 提供
    client = runtime.http_client()
```

3. **pytest 配置更新**（可选）：

如果你的项目使用 `[tool.pytest.ini_options]`，可以升级到原生 TOML：

```toml
# 将 [tool.pytest.ini_options] 改为 [tool.pytest]
[tool.pytest]
minversion = "9.0"
# ... 其他配置
```

## 技术细节

### Hook 执行顺序

env_plugin 使用 `@hookimpl(tryfirst=True)` 确保在 core.py 之前执行：

```
pytest_configure 执行顺序:
1. env_plugin.pytest_configure (tryfirst=True)
   - 设置环境变量
   - 加载配置
   - 存储 config._df_settings
2. core.pytest_configure
   - 检测 config._df_settings 是否存在
   - 如果存在，使用已加载的配置
   - 如果不存在，使用 Bootstrap 加载
   - 存储 config._df_runtime
```

### EventBus 测试隔离

每个测试用例拥有独立的 EventBus 实例：

```python
def _get_test_event_bus(config: pytest.Config, test_id: str) -> EventBus:
    """获取测试专用 EventBus"""
    if not hasattr(config, "_df_test_buses"):
        config._df_test_buses = {}

    if test_id not in config._df_test_buses:
        config._df_test_buses[test_id] = EventBus()

    return config._df_test_buses[test_id]

def _cleanup_test_event_bus(config: pytest.Config, test_id: str) -> None:
    """测试结束后清理 EventBus"""
    if hasattr(config, "_df_test_buses"):
        if test_id in config._df_test_buses:
            config._df_test_buses[test_id].clear()
            del config._df_test_buses[test_id]
```

## 文件变更

### 修改
- `pyproject.toml` - 添加 Entry Points，升级 pytest 配置
- `src/df_test_framework/__init__.py` - 版本号和文档更新
- `src/df_test_framework/testing/fixtures/core.py` - 使用 config 属性
- `src/df_test_framework/testing/plugins/env_plugin.py` - 简化状态管理
- `tests/conftest.py` - 移除手动插件声明
- `tests/testing/fixtures/test_fixtures_core.py` - 更新测试用例
- `tests/testing/plugins/test_env_plugin.py` - 更新测试用例

### 删除
- `src/df_test_framework/testing/plugins/managers.py` - 不再需要

## 测试结果

- **通过**: 1891
- **跳过**: 40
- **失败**: 0

## 参考资料

- [pytest Plugin Registration](https://docs.pytest.org/en/stable/how-to/writing_plugins.html#making-your-plugin-installable-by-others)
- [pytest 9.0 TOML Configuration](https://docs.pytest.org/en/stable/reference/customize.html#pyproject-toml)
- [pluggy 1.6.0 Release Notes](https://github.com/pytest-dev/pluggy/releases/tag/v1.6.0)
