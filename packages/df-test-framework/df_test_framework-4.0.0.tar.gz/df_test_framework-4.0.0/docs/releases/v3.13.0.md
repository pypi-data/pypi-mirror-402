# v3.13.0 发布说明

> 发布日期: 2025-12-03

## 概述

v3.13.0 是一个**架构重构版本**，将 UnitOfWork 从继承模式改为配置驱动模式，大幅简化项目使用方式。

## 重大变更

### 移除 `BaseUnitOfWork`

`BaseUnitOfWork` 类已被移除，直接使用 `UnitOfWork`。

```python
# v3.12.x（旧）
from df_test_framework import BaseUnitOfWork

class ProjectUoW(BaseUnitOfWork):
    def __init__(self, session_factory):
        super().__init__(session_factory, repository_package="my_project.repositories")

# v3.13.0（新）
# 无需创建自定义类！
```

### 配置驱动的 UnitOfWork

现在只需要在 `.env` 中配置即可：

```env
# .env
TEST__REPOSITORY_PACKAGE=my_project.repositories
```

框架的 `uow` fixture 会自动读取配置并启用 Repository 自动发现。

## 新增功能

### `TestExecutionConfig.repository_package`

新增配置字段，用于指定 Repository 包路径：

```python
class TestExecutionConfig(BaseModel):
    keep_test_data: bool = False
    repository_package: str | None = None  # 新增
```

### `uow` fixture 配置驱动

`uow` fixture 现在会自动：
1. 从 `runtime.settings.test.repository_package` 读取配置
2. 创建 `UnitOfWork` 并传入 `repository_package`
3. 启用 Repository 自动发现

## 迁移指南

### 从 v3.12.x 迁移

1. **删除自定义 UoW 类**（如 `ProjectUoW`）
2. **删除自定义 `uow` fixture**
3. **添加配置**：

```env
# .env
TEST__REPOSITORY_PACKAGE=your_project.repositories
```

4. **测试代码无需修改**：

```python
def test_example(uow):
    uow.users.create({"name": "test"})  # ✅ 照常工作
```

### 代码量变化

| 文件 | v3.12.x | v3.13.0 | 减少 |
|------|---------|---------|------|
| 自定义 UoW 类 | ~95 行 | 0 行 | -95 行 |
| 自定义 uow fixture | ~70 行 | 0 行 | -70 行 |
| conftest.py 导入 | 1 行 | 0 行 | -1 行 |
| **.env 配置** | 0 行 | 1 行 | +1 行 |
| **总计** | ~166 行 | 1 行 | **-165 行** |

## 文件变更

### 框架核心

- `src/df_test_framework/databases/uow.py` - 移除 `BaseUnitOfWork`
- `src/df_test_framework/databases/__init__.py` - 移除 `BaseUnitOfWork` 导出
- `src/df_test_framework/__init__.py` - 移除 `BaseUnitOfWork` 导出
- `src/df_test_framework/infrastructure/config/schema.py` - 新增 `repository_package`
- `src/df_test_framework/testing/fixtures/core.py` - `uow` fixture 配置驱动
- `src/df_test_framework/cli/templates/project/uow.py` - 更新为配置说明

### 文档

- `docs/api-reference/databases.md` - 更新 API 参考
- `docs/user-guide/*.md` - 更新用户指南
- `docs/architecture/UOW_REFACTORING_PROPOSAL.md` - 新增架构设计文档

## 向后兼容性

### 兼容

- 直接继承 `UnitOfWork` 仍然可用
- 手动创建 `UnitOfWork(session_factory, repository_package="...")` 仍然可用
- 所有 Repository 功能保持不变

### 不兼容

- `BaseUnitOfWork` 类已移除，需要改为 `UnitOfWork`
- 如果项目有自定义 `uow` fixture，建议删除并改用配置

## 测试

- 框架测试：1198 passed, 35 skipped
- 代码检查：All checks passed
