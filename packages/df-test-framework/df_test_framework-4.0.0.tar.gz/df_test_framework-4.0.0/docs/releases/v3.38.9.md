# v3.38.9 - 增强 captured log 支持

**发布日期**: 2025-12-30

## 概述

v3.38.9 增强了 pytest captured log 的 ProcessorFormatter 支持，统一 "Captured log setup/call/teardown" 区域的日志格式，与实时日志格式保持一致。

## 问题背景

v3.38.5 引入了 ProcessorFormatter 来统一 structlog 和 pytest 日志格式，但只替换了以下 handler：

- `log_cli_handler` - 实时日志输出（--log-cli-level）
- `log_file_handler` - 文件日志输出（--log-file）

遗漏了 captured log 相关的 handler：

- `caplog_handler` - caplog fixture 使用的 handler
- `report_handler` - "Captured log setup/call/teardown" 区域

这导致测试失败时显示的 captured log 区域仍然使用 pytest 默认格式，与实时日志格式不一致。

## 主要变更

### 1. logging_plugin.py 增强

在 `pytest_sessionstart` 钩子中新增两个 handler 的 formatter 替换：

```python
# v3.38.9: caplog_handler - caplog fixture 使用的 handler
if hasattr(logging_plugin, "caplog_handler") and logging_plugin.caplog_handler:
    logging_plugin.caplog_handler.setFormatter(processor_formatter)
# v3.38.9: report_handler - "Captured log setup/call/teardown" 区域
if hasattr(logging_plugin, "report_handler") and logging_plugin.report_handler:
    logging_plugin.report_handler.setFormatter(processor_formatter)
```

### 2. pytest 日志 handler 覆盖情况

| Handler | 用途 | ProcessorFormatter |
|---------|------|:------------------:|
| `log_cli_handler` | 实时日志（--log-cli-level） | ✅ v3.38.5 |
| `log_file_handler` | 文件日志（--log-file） | ✅ v3.38.5 |
| `caplog_handler` | caplog fixture | ✅ **v3.38.9** |
| `report_handler` | Captured log 区域 | ✅ **v3.38.9** |

### 3. 效果对比

**之前**（pytest 默认格式）：
```
------------------------------ Captured log setup ------------------------------
2025-12-30 09:45:15 | DEBUG    | faker.factory | Looking for locale...
```

**现在**（structlog ProcessorFormatter）：
```
------------------------------ Captured log call ------------------------------
2025-12-30 02:23:35.881140 [debug    ] 这是 DEBUG 日志    [test.captured_log]
```

## 日志级别配置说明

三个日志级别配置各自负责不同范围：

| 配置项 | 位置 | 控制范围 |
|--------|------|----------|
| `logging.level` | YAML 配置 | 框架内部模块日志级别 |
| `log_level` | pyproject.toml | Captured log 区域捕获级别 |
| `log_cli_level` | pyproject.toml | 实时日志显示级别 |

这种分离设计是正确的：
- YAML 配置控制「框架做什么」
- pyproject.toml 控制「pytest 显示什么」

## 升级指南

无需修改任何代码，升级到 v3.38.9 后 captured log 区域自动使用 structlog 格式。

## 影响的文件

- `src/df_test_framework/testing/plugins/logging_plugin.py`
- `src/df_test_framework/cli/templates/project/pyproject_toml.py`

## 测试

- 新增 `tests/testing/plugins/test_logging_plugin.py` - 10 个单元测试
  - 3 个 ProcessorFormatter 格式化测试
  - 6 个 handler 替换功能测试（含边界情况）
  - 1 个集成测试（验证 caplog 使用 ProcessorFormatter）
- 全部 1927 个测试通过，40 个跳过