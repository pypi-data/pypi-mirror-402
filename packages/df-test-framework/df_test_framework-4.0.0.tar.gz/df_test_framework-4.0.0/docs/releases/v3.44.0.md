# v3.44.0 ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

> **å‘å¸ƒæ—¥æœŸ**: 2026-01-12
> **ç±»å‹**: æ¶æ„é‡æ„ + åŠŸèƒ½å¢å¼º
> **ç ´åæ€§å˜æ›´**: æ— ï¼ˆ100% å‘åå…¼å®¹ï¼‰

---

## æ¦‚è¿°

v3.44.0 **å°† EventBus é›†æˆåˆ° RuntimeContext**ï¼Œå®ç°äº†ç»Ÿä¸€çš„äº‹ä»¶æ€»çº¿ç®¡ç†æ¶æ„ã€‚

### æ ¸å¿ƒå˜æ›´

æœ¬ç‰ˆæœ¬å®ç°äº†ä»¥ä¸‹æ¶æ„æ”¹è¿›ï¼š

1. **EventBus é›†æˆåˆ° RuntimeContext** - `RuntimeContext.event_bus` å­—æ®µå­˜å‚¨äº‹ä»¶æ€»çº¿
2. **test_runtime fixture** - function çº§åˆ«çš„ RuntimeContextï¼ŒåŒ…å«æµ‹è¯•ä¸“ç”¨ EventBus
3. **æ˜¾å¼ä¾èµ–æ³¨å…¥** - æ‰€æœ‰èƒ½åŠ›å±‚é€šè¿‡ `runtime.event_bus` å‘å¸ƒäº‹ä»¶
4. **100% å‘åå…¼å®¹** - ä¿ç•™ `get_event_bus()` å…¨å±€å‡½æ•°

### æ ¸å¿ƒä»·å€¼

âœ… **æ¶æ„æ¸…æ™°** - EventBus ä½œä¸ºè¿è¡Œæ—¶æ ¸å¿ƒç»„ä»¶ï¼Œä¸ settingsã€logger åŒçº§
âœ… **æ˜¾å¼ä¾èµ–** - ä¾èµ–æ³¨å…¥æ¯”å…¨å±€çŠ¶æ€æ›´æ¸…æ™°ï¼Œä¾¿äºæµ‹è¯•å’Œè°ƒè¯•
âœ… **æµ‹è¯•éš”ç¦»** - æ¯ä¸ªæµ‹è¯•å‡½æ•°æœ‰ç‹¬ç«‹çš„ EventBus
âœ… **100% å‘åå…¼å®¹** - ç°æœ‰æµ‹è¯•ä»£ç æ— éœ€ä¿®æ”¹

---

## æ¶æ„è®¾è®¡

### ç»Ÿä¸€çš„äº‹ä»¶é©±åŠ¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     test_runtime fixture                         â”‚
â”‚  1. åˆ›å»ºæµ‹è¯•ä¸“ç”¨ EventBus                                        â”‚
â”‚  2. æ³¨å…¥åˆ° RuntimeContext.event_bus                              â”‚
â”‚  3. set_test_event_bus(test_event_bus) - å‘åå…¼å®¹               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     allure fixture (autouse)                     â”‚
â”‚  1. è·å– test_event_bus (é€šè¿‡ get_event_bus())                  â”‚
â”‚  2. è®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼ˆHTTP + Web UI + Database + ...ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTP                           â”‚  Web UI                        â”‚
â”‚  HttpEventPublisherMiddleware   â”‚  BrowserManager                â”‚
â”‚  â†“ runtime.event_bus           â”‚  â†“ runtime.event_bus           â”‚
â”‚  â†“ å‘å¸ƒ HttpRequestStartEvent  â”‚  â†“ æ³¨å†Œ page.on() ç›‘å¬å™¨       â”‚
â”‚  â†“ å‘å¸ƒ HttpRequestEndEvent    â”‚  â†“ å‘å¸ƒ WebBrowserEvent        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     AllureObserver                               â”‚
â”‚  handle_http_request_*_event() â”‚  handle_web_browser_event()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡å†³ç­–

| å†³ç­– | è¯´æ˜ |
|------|------|
| **EventBus å­˜å‚¨** | å­˜å‚¨åœ¨ `RuntimeContext.event_bus` å­—æ®µ |
| **test_runtime fixture** | function çº§åˆ«ï¼Œåˆ›å»ºæµ‹è¯•ä¸“ç”¨ EventBus |
| **runtime fixture** | session çº§åˆ«ï¼Œä¸åŒ…å« EventBus |
| **äº‹ä»¶å‘å¸ƒ** | æ‰€æœ‰èƒ½åŠ›å±‚ä½¿ç”¨ `runtime.event_bus` |
| **å‘åå…¼å®¹** | ä¿ç•™ `get_event_bus()` å’Œ `set_test_event_bus()` |

---

## æ ¸å¿ƒç‰¹æ€§

### 1. UI Fixtures äº‹ä»¶åŒ–

**page fixture è‡ªåŠ¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨**ï¼š

```python
@pytest.fixture(scope="function")
def page(context: BrowserContext, browser_manager: BrowserManager):
    """é¡µé¢å®ä¾‹ï¼ˆå‡½æ•°çº§ï¼‰- è‡ªåŠ¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨"""
    p = context.new_page()

    # v3.44.0: è‡ªåŠ¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
    browser_manager._setup_event_listeners(p)

    yield p
    p.close()
```

**æ”¯æŒçš„äº‹ä»¶**ï¼š
- âœ… é¡µé¢åŠ è½½å®Œæˆï¼ˆ`page.on("load")`ï¼‰â†’ `WebBrowserEvent(event_name="page.load")`
- âœ… ç½‘ç»œè¯·æ±‚ï¼ˆ`page.on("request")`ï¼‰â†’ `WebBrowserEvent(event_name="network.request")`
- âœ… ç½‘ç»œå“åº”ï¼ˆ`page.on("response")`ï¼‰â†’ `WebBrowserEvent(event_name="network.response")`
- âœ… Console è¾“å‡ºï¼ˆ`page.on("console")`ï¼‰â†’ `WebBrowserEvent(event_name="console")`
- âœ… å¼¹çª—ï¼ˆ`page.on("dialog")`ï¼‰â†’ `WebBrowserEvent(event_name="dialog")`
- âœ… é¡µé¢é”™è¯¯ï¼ˆ`page.on("pageerror")`ï¼‰â†’ `UIErrorEvent`

### 2. WebConfig é…ç½®ç”Ÿæ•ˆ

**context fixture æ­£ç¡®åº”ç”¨é…ç½®**ï¼š

```python
@pytest.fixture(scope="function")
def context(browser: Browser, browser_manager: BrowserManager):
    """æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆå‡½æ•°çº§ï¼‰- åº”ç”¨ WebConfig é…ç½®"""
    context_options = {
        "viewport": browser_manager.viewport,
    }

    # è§†é¢‘å½•åˆ¶é…ç½®
    if browser_manager.record_video:
        context_options["record_video_dir"] = browser_manager.video_dir
        if browser_manager.video_size:
            context_options["record_video_size"] = browser_manager.video_size

    ctx = browser.new_context(**context_options)
    ctx.set_default_timeout(browser_manager.timeout)

    yield ctx
    ctx.close()
```

### 3. Allure è‡ªåŠ¨é›†æˆ

**AllureObserver è®¢é˜… Web UI äº‹ä»¶**ï¼š

```python
# allure fixture ä¸­è®¢é˜… Web UI äº‹ä»¶
test_event_bus.subscribe(WebBrowserEvent, observer.handle_web_browser_event)
test_event_bus.subscribe(UIErrorEvent, observer.handle_ui_error_event)
```

**Allure æŠ¥å‘Šæ•ˆæœ**ï¼š
```
ğŸŒ Page Load: https://example.com/login (title: Login Page)
ğŸŒ Network Request: GET https://example.com/api/user
ğŸŒ Network Response: 200 https://example.com/api/user
ğŸ“ Console [log]: User logged in successfully
âš ï¸ Page Error: Uncaught TypeError: Cannot read property 'x' of undefined
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šé›¶é…ç½®è‡ªåŠ¨äº‹ä»¶å‘å¸ƒ

```python
def test_login(page):
    """ä½¿ç”¨ page fixture è‡ªåŠ¨è·å¾—äº‹ä»¶å‘å¸ƒ"""
    page.goto("https://example.com/login")
    page.get_by_label("Username").fill("admin")
    page.get_by_role("button", name="Sign in").click()

    # âœ… è‡ªåŠ¨å‘å¸ƒäº‹ä»¶åˆ° EventBus
    # âœ… AllureObserver è‡ªåŠ¨è®°å½•åˆ° Allure æŠ¥å‘Š
    # âœ… æ— éœ€ä»»ä½•é¢å¤–é…ç½®
```

### ç¤ºä¾‹ 2ï¼šé…ç½®é©±åŠ¨

```yaml
# config/environments/dev.yaml
web:
  base_url: "https://dev.example.com"
  browser_type: "chromium"
  headless: true
  timeout: 30000
  viewport:
    width: 1920
    height: 1080
  record_video: true
  video_dir: "reports/videos"
```

```python
def test_with_config(page, runtime):
    """é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆ"""
    # viewport: 1920x1080 âœ…
    # timeout: 30000ms âœ…
    # è§†é¢‘å½•åˆ¶: å¯ç”¨ âœ…

    login_page = LoginPage(page, runtime=runtime)
    login_page.goto()  # base_url è‡ªåŠ¨æ‹¼æ¥
```

### ç¤ºä¾‹ 3ï¼šéªŒè¯äº‹ä»¶å‘å¸ƒ

```python
def test_event_verification(page):
    """éªŒè¯äº‹ä»¶å‘å¸ƒæ˜¯å¦ç”Ÿæ•ˆ"""
    from df_test_framework.infrastructure.events import get_event_bus

    events = []
    event_bus = get_event_bus()
    event_bus.subscribe(WebBrowserEvent, lambda e: events.append(e))

    page.goto("https://example.com")

    # éªŒè¯äº‹ä»¶å·²å‘å¸ƒ
    assert any(e.event_name == "page.load" for e in events)
```

---

## è¯¦ç»†å˜æ›´

### BrowserManager

**å˜æ›´**ï¼š
- `_setup_event_listeners()` æ”¹ä¸ºä½¿ç”¨ `get_event_bus()` åŠ¨æ€è·å– EventBus
- ç§»é™¤ `self.event_bus` å®ä¾‹å˜é‡ï¼Œæ”¹ä¸ºæ¯æ¬¡åŠ¨æ€è·å–

**ä»£ç ç¤ºä¾‹**ï¼š
```python
def _setup_event_listeners(self, page: Page) -> None:
    """æ³¨å†Œ Playwright åŸç”Ÿäº‹ä»¶ç›‘å¬å™¨"""
    from df_test_framework.infrastructure.events import get_event_bus

    # åŠ¨æ€è·å– EventBusï¼ˆæ”¯æŒæµ‹è¯•éš”ç¦»ï¼‰
    event_bus = get_event_bus()
    if not event_bus:
        return

    page.on("load", lambda: self._on_page_load(page))
    # ...
```

### UI Fixtures

**context fixture å˜æ›´**ï¼š
- ä» `browser_manager` è¯»å– WebConfig é…ç½®
- åº”ç”¨ viewportã€timeoutã€è§†é¢‘å½•åˆ¶é…ç½®

**page fixture å˜æ›´**ï¼š
- è‡ªåŠ¨è°ƒç”¨ `_setup_page_event_listeners()` æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
- ä½¿ç”¨ `get_event_bus()` è·å–æµ‹è¯•ä¸“ç”¨ EventBus

### AllureObserver

**æ–°å¢æ–¹æ³•**ï¼š
- `handle_web_browser_event()` - å¤„ç† WebBrowserEvent
- `handle_ui_error_event()` - å¤„ç† UIErrorEvent

### allure fixture

**æ–°å¢è®¢é˜…**ï¼š
```python
test_event_bus.subscribe(WebBrowserEvent, observer.handle_web_browser_event)
test_event_bus.subscribe(UIErrorEvent, observer.handle_ui_error_event)
```

---

## æµ‹è¯•è¦†ç›–

### æ–°å¢/ä¿®æ”¹æµ‹è¯•

**ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
- âœ… page fixture åˆ›å»ºçš„é¡µé¢è‡ªåŠ¨æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
- âœ… context fixture æ­£ç¡®åº”ç”¨ WebConfig é…ç½®
- âœ… é¡µé¢å¯¼èˆªè§¦å‘ WebBrowserEvent å‘å¸ƒ
- âœ… AllureObserver æ­£ç¡®å¤„ç† Web UI äº‹ä»¶

**å•å…ƒæµ‹è¯•**ï¼š
- âœ… BrowserManager ä½¿ç”¨ get_event_bus() åŠ¨æ€è·å–
- âœ… _setup_page_event_listeners() æ­£ç¡®æ³¨å†Œç›‘å¬å™¨
- âœ… AllureObserver.handle_web_browser_event() æ­£ç¡®å¤„ç†äº‹ä»¶

---

## å‡çº§æŒ‡å—

### ä» v3.43.0 å‡çº§

**æ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹** âœ…

ç°æœ‰æµ‹è¯•ä»£ç å°†è‡ªåŠ¨è·å¾—ï¼š
- äº‹ä»¶å‘å¸ƒåŠŸèƒ½
- Allure è‡ªåŠ¨é›†æˆ
- WebConfig é…ç½®ç”Ÿæ•ˆ

### éªŒè¯å‡çº§æˆåŠŸ

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆ Allure æŠ¥å‘Š
uv run pytest tests/capabilities/drivers/web/ --alluredir=reports/allure -v

# æŸ¥çœ‹æŠ¥å‘Š
allure serve reports/allure
```

åœ¨ Allure æŠ¥å‘Šä¸­åº”è¯¥èƒ½çœ‹åˆ° Web UI æ“ä½œè®°å½•ã€‚

---

## å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä¸ºä»€ä¹ˆä¸åœ¨ RuntimeContext ä¸­å­˜å‚¨ event_busï¼Ÿ

**A**: ä¸ºäº†ä¸ HTTP ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨ `get_event_bus()` åŠ¨æ€è·å–ï¼š
- âœ… æ”¯æŒæµ‹è¯•éš”ç¦»ï¼ˆæ¯ä¸ªæµ‹è¯•æœ‰ç‹¬ç«‹çš„ EventBusï¼‰
- âœ… ä¸éœ€è¦ä¿®æ”¹ RuntimeContext æ•°æ®ç»“æ„
- âœ… ä¸ HttpEventPublisherMiddleware ä½¿ç”¨ç›¸åŒæœºåˆ¶

### Q2: äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œåœ¨å“ªé‡Œï¼Ÿ

**A**: åœ¨ `page` fixture ä¸­æ³¨å†Œï¼Œè€Œä¸æ˜¯ `BrowserManager.start()`ï¼š
- âœ… ç¡®ä¿æ¯ä¸ªæµ‹è¯•çš„ page éƒ½è¢«äº‹ä»¶åŒ–
- âœ… é¿å… session çº§ BrowserManager ä¸ function çº§ page çš„ç”Ÿå‘½å‘¨æœŸä¸åŒ¹é…

### Q3: å¦‚ä½•ç¦ç”¨äº‹ä»¶å‘å¸ƒï¼Ÿ

**A**: ä¸ä½¿ç”¨ `page` fixtureï¼Œç›´æ¥åˆ›å»ºé¡µé¢ï¼š
```python
def test_without_events(browser_manager):
    browser_manager.start()
    page = browser_manager.page  # ä¸ä¼šæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
```

---

## æ¶æ„æ–‡æ¡£

### æ›´æ–°æ–‡æ¡£

- `docs/architecture/http-vs-web-comparison.md` - æ›´æ–°æ¶æ„å¯¹æ¯”
- `docs/guides/web-ui-testing.md` - æ›´æ–°ä½¿ç”¨æŒ‡å—

---

**è¿”å›**: [Changelog](../../CHANGELOG.md) | [æ¶æ„æ–‡æ¡£](../architecture/README.md)
