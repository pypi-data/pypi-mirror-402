# v3.40.0 - 统一脱敏服务

**发布日期**: 2024-12

## 概述

将日志系统、ConsoleDebugObserver、AllureObserver 的脱敏逻辑统一，实现共享规则、多策略支持、独立开关控制。

## 核心特性

### 统一脱敏服务 (SanitizeService)

- **共享敏感字段定义**：17 个默认敏感字段，支持正则匹配
- **多种脱敏策略**：partial（部分保留）、full（完全隐藏）、hash（哈希值）
- **深度递归脱敏**：支持嵌套 dict/list 结构
- **消息内容正则脱敏**：自动脱敏日志消息中的敏感内容
- **各组件独立开关**：logging/console/allure 可独立启用/禁用

### 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    SanitizeConfig (配置)                     │
│  enabled, sensitive_keys, sensitive_patterns, strategy     │
│  logging.enabled, console.enabled, allure.enabled          │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                 SanitizeService (核心服务)                   │
│  sanitize_value(), sanitize_dict(), is_sensitive()         │
│  支持: full / partial / hash 策略                           │
└──────────┬─────────────────┬─────────────────┬──────────────┘
           │                 │                 │
           ▼                 ▼                 ▼
    ┌──────────┐      ┌──────────────┐   ┌──────────┐
    │  日志    │      │ ConsoleDebug │   │  Allure  │
    │  系统    │      │   Observer   │   │ Observer │
    └──────────┘      └──────────────┘   └──────────┘
```

## 使用方式

### 零配置使用（推荐）

默认配置已覆盖常见场景，无需任何配置即可使用：

```python
from df_test_framework import get_sanitize_service

service = get_sanitize_service()

# 脱敏单个值
service.sanitize_value("password", "mysecretpassword")
# 输出: 'myse****word'

# 脱敏字典
service.sanitize_dict({"password": "secret", "name": "test"})
# 输出: {'password': 'secr****', 'name': 'test'}

# 检查敏感字段
service.is_sensitive("api_key")  # True
service.is_sensitive("username")  # False
```

### 自定义配置（可选）

仅在需要自定义时添加配置：

```yaml
# config/base.yaml
sanitize:
  enabled: true
  default_strategy: partial  # full / partial / hash
  keep_prefix: 4
  keep_suffix: 4

  # 添加项目特定敏感字段（支持正则）
  sensitive_keys:
    - password
    - token
    - secret
    - ".*_key$"      # 正则匹配
    - ".*_secret$"

  # 各组件独立控制
  logging:
    enabled: true
  console:
    enabled: false   # 本地调试时关闭
  allure:
    enabled: true
```

### 环境变量配置

```bash
SANITIZE__ENABLED=true
SANITIZE__DEFAULT_STRATEGY=partial
SANITIZE__CONSOLE__ENABLED=false
```

## 默认敏感字段

| 类别 | 字段 |
|------|------|
| 密码 | password, passwd, pwd |
| Token | token, access_token, refresh_token |
| 密钥 | secret, api_key, apikey |
| 认证 | authorization, auth, credential |
| HTTP Header | x-token, x-api-key, x-sign, x-signature |

## 脱敏策略

| 策略 | 示例输入 | 示例输出 |
|------|----------|----------|
| `partial` | mysecretpassword | myse****word |
| `full` | mysecretpassword | ****** |
| `hash` | mysecretpassword | sha256:a1b2c3d4e5f6... |

## 脱敏范围

| 组件 | 脱敏内容 |
|------|----------|
| 日志系统 | 字段值 + 消息内容正则 |
| ConsoleDebugObserver | HTTP headers |
| AllureObserver | HTTP headers/body/params, GraphQL variables, gRPC metadata |

## 性能影响

| 操作 | 耗时 | 评估 |
|------|------|------|
| `is_sensitive()` | ~0.9μs | 极快 |
| `sanitize_dict()` | ~13μs | 可忽略 |
| 禁用时 | ~0.06μs | 零开销 |

相比 HTTP 请求延迟（50-500ms），脱敏开销 < 0.003%。

## API 参考

### SanitizeService

```python
class SanitizeService:
    def is_sensitive(self, key: str) -> bool:
        """判断字段名是否敏感"""

    def sanitize_value(
        self,
        key: str,
        value: str,
        strategy: SanitizeStrategy | None = None,
    ) -> str:
        """脱敏单个值"""

    def sanitize_dict(
        self,
        data: dict[str, Any] | None,
        context: str = "default",
    ) -> dict[str, Any] | None:
        """脱敏字典（深度递归）"""

    def sanitize_message(self, message: str) -> str:
        """脱敏消息内容（正则匹配）"""

    def is_context_enabled(self, context: str) -> bool:
        """检查指定上下文是否启用脱敏"""
```

### 全局函数

```python
from df_test_framework import (
    get_sanitize_service,   # 获取服务实例
    set_sanitize_service,   # 设置自定义服务（测试用）
    clear_sanitize_service, # 清除缓存
)
```

## 文件变更

| 操作 | 文件 |
|------|------|
| 新增 | `infrastructure/sanitize/__init__.py` |
| 新增 | `infrastructure/sanitize/service.py` |
| 新增 | `infrastructure/config/schema.py` (SanitizeConfig) |
| 修改 | `infrastructure/logging/config.py` |
| 修改 | `testing/debugging/console.py` |
| 修改 | `testing/reporting/allure/observer.py` |

## 测试

新增 33 个单元测试，覆盖：
- 敏感字段匹配（精确 + 正则）
- 各种脱敏策略
- 嵌套字典递归
- 上下文独立控制
- 单例模式
