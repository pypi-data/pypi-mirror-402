# 版本号控制规则

本文档定义 DF Test Framework 的版本号管理规范，基于[语义化版本 2.0.0](https://semver.org/lang/zh-CN/)。

---

## 版本号格式

```
MAJOR.MINOR.PATCH
```

**示例**: `3.45.0`
- MAJOR: 3（主版本号）
- MINOR: 45（次版本号）
- PATCH: 0（修订号）

---

## 1. MAJOR（主版本号）- 破坏性变更

### 何时增加

- ✅ 不兼容的 API 变更
- ✅ 移除废弃的 API
- ✅ 重大架构重构（如 v3.14.0 的五层架构）
- ✅ 升级最低依赖版本（如 Python 3.12 → 3.13）

### 示例

```
v2.x → v3.0.0 (Python 3.12+ 重构)
v3.x → v4.0.0 (移除所有 v3.x 废弃 API)
```

### 频率

**每年 0-2 次**

---

## 2. MINOR（次版本号）- 新功能（向后兼容）

### 何时增加

- ✅ 新增**独立的**功能模块（如新增 GraphQL 客户端）
- ✅ 新增**重要的** API/类/装饰器
- ✅ **完整的**功能增强（不是半成品）

### 判断标准（3 个问题）

在增加 MINOR 版本号前，问自己：

1. **这是一个独立的功能模块吗？**（不是现有功能的增强）
2. **这个功能值得单独写一篇发布文档吗？**
3. **用户会专门为这个功能升级吗？**

**如果 3 个都是 YES → MINOR +1**
**否则 → PATCH +1**

### 应该增加的情况

```
✅ v3.42.0 - Web UI 自动化重构（完整功能）
✅ v3.43.0 - GraphQL 客户端（新模块）
✅ v3.44.0 - 分布式追踪（新能力）
```

### 不应该增加的情况

```
❌ v3.42.0 - UI 配置驱动
❌ v3.43.0 - UI 最佳实践
❌ v3.44.0 - UI 事件驱动
❌ v3.45.0 - UI 架构一致性
   ↑ 这些应该合并为一个 v3.42.0
```

### 不应该增加 MINOR 的情况

- ❌ 功能的渐进式开发（应该合并到一个版本）
- ❌ 小的辅助方法/工具函数
- ❌ 内部重构（不影响用户）
- ❌ 文档更新

### 频率

**每月 0-2 次**（重大功能才发布）

---

## 3. PATCH（修订号）- Bug 修复和小改进

### 何时增加

- ✅ Bug 修复
- ✅ 性能优化
- ✅ 文档更新
- ✅ 小的功能增强（辅助方法）
- ✅ 依赖版本更新（安全修复）

### 示例

```
v3.42.0 → v3.42.1 (修复 bug)
v3.42.1 → v3.42.2 (文档更新)
v3.42.2 → v3.42.3 (性能优化)
```

### 频率

**按需发布**（有 bug 就修）

---

## 版本发布策略

### 策略：功能合并发布

**原则**: 相关功能合并到一个版本，等功能完整后再发布。

**示例**:
```
v3.42.0 - Web UI 自动化重构
  包含：
  - 配置驱动模式
  - 现代最佳实践
  - 事件驱动架构
  - HTTP/UI 架构一致性
  - 脚手架支持
```

**优点**:
- ✅ 版本号增长慢
- ✅ 每个版本都有明确主题
- ✅ 用户升级成本低
- ✅ 发布文档更有价值

---

## 决策流程图

```
新功能开发
    ↓
是否是独立模块？
    ├─ 是 → 是否功能完整？
    │       ├─ 是 → MINOR +1 发布
    │       └─ 否 → 继续开发
    └─ 否 → 是否是现有功能增强？
            ├─ 是 → 合并到相关 MINOR 版本
            └─ 否 → PATCH +1 发布
```

---

## 版本发布检查清单

### 发布前检查

- [ ] 确认功能完整（不是半成品）
- [ ] 确认是否应该合并到现有版本
- [ ] 确认版本号类型（MAJOR/MINOR/PATCH）
- [ ] 运行所有测试（`uv run pytest -v`）
- [ ] 更新 `pyproject.toml` 版本号
- [ ] 更新 `CHANGELOG.md` 添加版本条目
- [ ] 创建 `docs/releases/vX.X.X.md` 详细发布文档
- [ ] 更新相关使用指南（如有新功能）

### 提交规范

```bash
# 功能提交
git commit -m "feat(vX.X.X): 简短描述

详细说明...

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# 版本发布提交
git commit -m "chore(vX.X.X): 版本发布文件更新

更新内容：
- pyproject.toml 版本号：X.X.X → Y.Y.Y
- CHANGELOG.md 新增 vY.Y.Y 条目

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## 未来版本号规划示例

假设从 v3.45.0 开始严格控制：

```
v3.45.0 (当前) - HTTP 与 UI 架构一致性
v3.46.0 (Q1)   - GraphQL 客户端完整支持
v3.46.1        - 修复 GraphQL bug
v3.47.0 (Q2)   - 性能监控增强
v3.47.1        - 文档更新
v3.48.0 (Q3)   - 云原生支持（K8s/Docker）
v4.0.0 (Q4)    - 移除所有废弃 API
```

**预期**: 每季度 1-2 个 MINOR 版本，每年 1 个 MAJOR 版本。

---

## 核心原则总结

1. **MINOR 版本要克制** - 只有独立的重大功能才增加
2. **相关功能要合并** - 不要拆分成多个版本
3. **功能要完整** - 不发布半成品
4. **PATCH 版本要积极** - Bug 修复立即发布

---

## 历史教训

### v3.42.0 - v3.45.0 的问题

**时间**: 2026-01-08 至 2026-01-13（仅 5 天）

**版本跳跃**:
- v3.42.0 - UI 测试配置驱动
- v3.43.0 - 现代 UI 测试最佳实践
- v3.44.0 - Web UI 事件驱动架构
- v3.45.0 - HTTP 与 UI 架构一致性

**问题**: 这些都是同一个主题（Web UI 自动化重构）的渐进式开发，应该合并为一个版本。

**教训**: 从 v3.46.0 开始严格遵守本规则。

---

## 参考资料

- [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)
- [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)
- 项目 CHANGELOG: `CHANGELOG.md`
- 版本发布文档: `docs/releases/`