# æ¡†æ¶æ‹¦æˆªå™¨æ¶æ„åˆ†æ

> **åˆ†ææ—¶é—´**: 2025-11-06
> **åˆ†æå¯¹è±¡**: DF Test Framework v3.2.0 æ‹¦æˆªå™¨æ¶æ„
> **é—®é¢˜**: "æˆ‘æ„Ÿè§‰æˆ‘ä»¬çš„æ–¹å‘æœ‰ç‚¹é—®é¢˜ã€‚é¦–å…ˆæ¡†æ¶çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜"

---

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜1: åŒå±‚æ‹¦æˆªå™¨æœºåˆ¶å¯¼è‡´é‡å¤æ‰§è¡Œ âš ï¸

æ¡†æ¶å­˜åœ¨**ä¸¤ä¸ªç‹¬ç«‹çš„æ‹¦æˆªå™¨æœºåˆ¶**ï¼Œä¼šå¯¼è‡´æ‹¦æˆªå™¨**è¢«æ‰§è¡Œä¸¤æ¬¡**ï¼š

#### 1. HttpClientå±‚æ‹¦æˆªå™¨ï¼ˆclient.py:172-179ï¼‰
```python
# HttpClient.request()
def request(self, method: str, url: str, **kwargs):
    # ğŸ”´ ç¬¬ä¸€æ¬¡åº”ç”¨æ‹¦æˆªå™¨
    for interceptor in self.request_interceptors:
        try:
            kwargs = interceptor(method, url, **kwargs)
        except Exception as e:
            logger.error(f"[HttpClient] æ‹¦æˆªå™¨æ‰§è¡Œå¤±è´¥: {e}")

    # å‘é€è¯·æ±‚
    response = self.client.request(method, url, **kwargs)
    return response
```

#### 2. BaseAPIå±‚æ‹¦æˆªå™¨ï¼ˆbase_api.py:208-259ï¼‰
```python
# BaseAPI._apply_request_interceptors()
def _apply_request_interceptors(self, method: str, url: str, **kwargs):
    for interceptor in self.request_interceptors:
        try:
            new_kwargs = interceptor(method, url, **kwargs)
            if new_kwargs is not None:
                kwargs = {**kwargs, **new_kwargs}
        except Exception as e:
            pass
    return kwargs

# BaseAPI.get()
def get(self, endpoint: str, **kwargs):
    url = self._build_url(endpoint)
    # ğŸ”´ ç¬¬äºŒæ¬¡åº”ç”¨æ‹¦æˆªå™¨
    kwargs = self._apply_request_interceptors("GET", url, **kwargs)
    response = self.http_client.get(url, **kwargs)  # ğŸ”´ è¿™é‡Œä¼šå†æ¬¡è§¦å‘HttpClientçš„æ‹¦æˆªå™¨
    return self._parse_response(response)
```

---

### é—®é¢˜2: æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåºæ··ä¹± âš ï¸

**æ‰§è¡Œæµç¨‹**:
```
æµ‹è¯•ä»£ç è°ƒç”¨API
    â†“
BaseAPI.get(endpoint="/master/cards", ...)
    â†“
BaseAPI._apply_request_interceptors()  # ğŸ”´ ç¬¬1æ¬¡ï¼šåº”ç”¨BaseAPIçš„æ‹¦æˆªå™¨
    â†“
HttpClient.get(url, **kwargs)
    â†“
HttpClient.request()
    â†“
for interceptor in self.request_interceptors:  # ğŸ”´ ç¬¬2æ¬¡ï¼šåº”ç”¨HttpClientçš„æ‹¦æˆªå™¨
    kwargs = interceptor(method, url, **kwargs)
    â†“
httpx.request(method, url, **kwargs)  # ğŸ”´ æœ€ç»ˆè¯·æ±‚
```

**é—®é¢˜**:
- å¦‚æœåŒä¸€ä¸ªæ‹¦æˆªå™¨æ—¢åœ¨BaseAPIåˆåœ¨HttpClient â†’ **æ‰§è¡Œ2æ¬¡**
- BaseAPIçš„æ‹¦æˆªå™¨å…ˆæ‰§è¡Œ â†’ ä½†HttpClientçš„æ‹¦æˆªå™¨ä¼šè¦†ç›–
- æ— æ³•æ§åˆ¶æ‰§è¡Œé¡ºåº

---

### é—®é¢˜3: è‡ªåŠ¨é…ç½®å’Œæ‰‹å·¥é…ç½®çš„å†²çª âš ï¸

#### è‡ªåŠ¨é…ç½®ï¼ˆv3.2æ–°å¢ï¼‰
```python
# settings.py
http: HTTPConfig = Field(
    default_factory=lambda: HTTPConfig(
        base_url="...",
        interceptors=[
            SignatureInterceptorConfig(...),  # é…ç½®åœ¨HttpClientå±‚
        ],
    )
)

# fixtures/http_client.py
@pytest.fixture(scope="session")
def http_client(settings) -> HttpClient:
    return HttpClient(
        base_url=settings.http.base_url,
        config=settings.http,  # ğŸ”´ ä¼šåŠ è½½åˆ°HttpClient.request_interceptors
    )
```

#### æ‰‹å·¥é…ç½®ï¼ˆv3.0å…¼å®¹ï¼‰
```python
# fixtures/apis.py
@pytest.fixture
def master_card_api(http_client, signature_interceptor):
    return MasterCardAPI(
        http_client,
        request_interceptors=[signature_interceptor]  # ğŸ”´ ä¼šåŠ è½½åˆ°BaseAPI.request_interceptors
    )
```

**å†²çªåœºæ™¯**:
1. è‡ªåŠ¨é…ç½® â†’ æ‹¦æˆªå™¨åœ¨HttpClientå±‚
2. æ‰‹å·¥é…ç½® â†’ æ‹¦æˆªå™¨åœ¨BaseAPIå±‚
3. **å¦‚æœåŒæ—¶ä½¿ç”¨** â†’ æ‹¦æˆªå™¨æ‰§è¡Œ2æ¬¡ï¼

---

## ğŸ“Š å…·ä½“ç¤ºä¾‹

### åœºæ™¯1: åªä½¿ç”¨æ‰‹å·¥é…ç½®ï¼ˆå½“å‰gift-card-testé¡¹ç›®ï¼‰

```python
# fixtures/apis.py
@pytest.fixture
def master_card_api(http_client, signature_interceptor):
    return MasterCardAPI(
        http_client,
        request_interceptors=[signature_interceptor]  # BaseAPIå±‚
    )

# æµ‹è¯•ä»£ç 
master_card_api.get("/master/cards")
```

**æ‰§è¡Œæµç¨‹**:
1. `BaseAPI.get()` â†’ åº”ç”¨`signature_interceptor`ï¼ˆBaseAPIå±‚ï¼‰â†’ æ·»åŠ `X-Sign`
2. `HttpClient.get()` â†’ æ²¡æœ‰æ‹¦æˆªå™¨ï¼ˆHttpClientå±‚ä¸ºç©ºï¼‰
3. âœ… **æ­£å¸¸å·¥ä½œ**ï¼Œæ‹¦æˆªå™¨æ‰§è¡Œ1æ¬¡

---

### åœºæ™¯2: åªä½¿ç”¨è‡ªåŠ¨é…ç½®ï¼ˆå–æ¶ˆsettings.pyæ³¨é‡Šï¼‰

```python
# settings.py
http: HTTPConfig = Field(
    default_factory=lambda: HTTPConfig(
        interceptors=[
            SignatureInterceptorConfig(...),  # HttpClientå±‚
        ],
    )
)

# fixtures/apis.py
@pytest.fixture
def master_card_api(http_client):
    return MasterCardAPI(http_client)  # ä¸ä¼ request_interceptors

# æµ‹è¯•ä»£ç 
master_card_api.get("/master/cards")
```

**æ‰§è¡Œæµç¨‹**:
1. `BaseAPI.get()` â†’ æ²¡æœ‰æ‹¦æˆªå™¨ï¼ˆBaseAPIå±‚ä¸ºç©ºï¼‰
2. `HttpClient.get()` â†’ åº”ç”¨`signature_interceptor`ï¼ˆHttpClientå±‚ï¼‰â†’ æ·»åŠ `X-Sign`
3. âœ… **æ­£å¸¸å·¥ä½œ**ï¼Œæ‹¦æˆªå™¨æ‰§è¡Œ1æ¬¡

---

### åœºæ™¯3: åŒæ—¶ä½¿ç”¨è‡ªåŠ¨+æ‰‹å·¥é…ç½® âš ï¸ **é—®é¢˜åœºæ™¯**

```python
# settings.py
http: HTTPConfig = Field(
    default_factory=lambda: HTTPConfig(
        interceptors=[
            SignatureInterceptorConfig(...),  # HttpClientå±‚
        ],
    )
)

# fixtures/apis.py
@pytest.fixture
def master_card_api(http_client, signature_interceptor):
    return MasterCardAPI(
        http_client,
        request_interceptors=[signature_interceptor]  # BaseAPIå±‚
    )

# æµ‹è¯•ä»£ç 
master_card_api.get("/master/cards")
```

**æ‰§è¡Œæµç¨‹**:
1. `BaseAPI.get()` â†’ åº”ç”¨`signature_interceptor`ï¼ˆBaseAPIå±‚ï¼‰â†’ æ·»åŠ `X-Sign: aaa`
2. `HttpClient.get()` â†’ åº”ç”¨`signature_interceptor`ï¼ˆHttpClientå±‚ï¼‰â†’ **è¦†ç›–**`X-Sign: bbb`
3. âŒ **ç­¾åè¢«è®¡ç®—2æ¬¡**ï¼Œæœ€ç»ˆä½¿ç”¨çš„æ˜¯ç¬¬2æ¬¡çš„ç­¾åï¼ˆå¯èƒ½å¯¼è‡´éªŒè¯å¤±è´¥ï¼‰

---

## ğŸ¯ æ ¹æœ¬åŸå› 

### è®¾è®¡å†²çª

1. **v3.0è®¾è®¡**ï¼ˆåŸå§‹è®¾è®¡ï¼‰:
   - æ‹¦æˆªå™¨åœ¨**BaseAPIå±‚**
   - æ‰‹å·¥é…ç½®ï¼š`BaseAPI(http_client, request_interceptors=[...])`
   - HttpClientæ˜¯çº¯HTTPå®¢æˆ·ç«¯ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘

2. **v3.2æ–°å¢**ï¼ˆé…ç½®åŒ–æ‹¦æˆªå™¨ï¼‰:
   - æ‹¦æˆªå™¨åœ¨**HttpClientå±‚**
   - è‡ªåŠ¨é…ç½®ï¼š`HTTPConfig(interceptors=[...])`
   - HttpClientä»é…ç½®åŠ è½½æ‹¦æˆªå™¨

3. **é—®é¢˜**: ä¸¤ç§æœºåˆ¶**æ²¡æœ‰åè°ƒ**ï¼Œå¯¼è‡´å¯èƒ½æ‰§è¡Œ2æ¬¡

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆA: åºŸå¼ƒBaseAPIå±‚æ‹¦æˆªå™¨ â­ **æ¨è**

**åŸå› **:
- HttpClientå±‚æ‹¦æˆªå™¨æ›´åˆç†ï¼ˆæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ï¼‰
- è‡ªåŠ¨é…ç½®æ›´ç®€æ´
- é¿å…é‡å¤æ‰§è¡Œ

**æ”¹åŠ¨**:
1. ä¿ç•™`HttpClient.request_interceptors`
2. **åˆ é™¤**`BaseAPI.request_interceptors`
3. **åˆ é™¤**`BaseAPI._apply_request_interceptors()`
4. æ‰‹å·¥é…ç½®æ”¹ä¸ºæ·»åŠ åˆ°HttpClientï¼š
```python
@pytest.fixture
def http_client_with_signature(settings, signature_interceptor):
    client = HttpClient(base_url=settings.http.base_url)
    client.request_interceptors.append(signature_interceptor)
    return client

@pytest.fixture
def master_card_api(http_client_with_signature):
    return MasterCardAPI(http_client_with_signature)
```

**ä¼˜ç‚¹**:
- âœ… å•ä¸€æ‹¦æˆªå™¨æœºåˆ¶
- âœ… è‡ªåŠ¨é…ç½®å’Œæ‰‹å·¥é…ç½®ä½¿ç”¨åŒä¸€å¥—é€»è¾‘
- âœ… ä¸ä¼šé‡å¤æ‰§è¡Œ

**ç¼ºç‚¹**:
- âŒ **ç ´åv3.0å…¼å®¹æ€§**ï¼ˆæ‰€æœ‰æ‰‹å·¥é…ç½®ä»£ç éœ€è¦æ”¹ï¼‰

---

### æ–¹æ¡ˆB: åºŸå¼ƒHttpClientå±‚æ‹¦æˆªå™¨

**åŸå› **:
- ä¿æŒv3.0å…¼å®¹æ€§
- BaseAPIå±‚æ‹¦æˆªå™¨æ›´çµæ´»ï¼ˆæ¯ä¸ªAPIå¯ä»¥ä¸åŒï¼‰

**æ”¹åŠ¨**:
1. ä¿ç•™`BaseAPI.request_interceptors`
2. **åˆ é™¤**`HttpClient.request_interceptors`
3. **åˆ é™¤**`HttpClient._load_interceptors_from_config()`
4. è‡ªåŠ¨é…ç½®æ”¹ä¸ºåœ¨`http_client` fixtureä¸­åˆ›å»ºï¼š
```python
@pytest.fixture(scope="session")
def http_client(settings) -> HttpClient:
    client = HttpClient(base_url=settings.http.base_url)
    # ä¸åŠ è½½æ‹¦æˆªå™¨ï¼ˆäº¤ç»™BaseAPIå¤„ç†ï¼‰
    return client

@pytest.fixture
def master_card_api(http_client, settings):
    # ä»settingsåŠ è½½æ‹¦æˆªå™¨é…ç½®ï¼Œæ·»åŠ åˆ°BaseAPI
    interceptors = []
    for config in settings.http.interceptors:
        interceptor = InterceptorFactory.create(config)
        interceptors.append(interceptor)
    return MasterCardAPI(http_client, request_interceptors=interceptors)
```

**ä¼˜ç‚¹**:
- âœ… v3.0ä»£ç æ— éœ€ä¿®æ”¹
- âœ… BaseAPIå±‚æ‹¦æˆªå™¨æ›´çµæ´»

**ç¼ºç‚¹**:
- âŒ è‡ªåŠ¨é…ç½®å˜å¤æ‚ï¼ˆæ¯ä¸ªAPI fixtureéƒ½è¦å¤„ç†ï¼‰
- âŒ å¤±å»äº†"é›¶ä»£ç é…ç½®"çš„ä¼˜åŠ¿

---

### æ–¹æ¡ˆC: æ™ºèƒ½åˆå¹¶ä¸¤å±‚æ‹¦æˆªå™¨ â­â­ **å¹³è¡¡æ–¹æ¡ˆ**

**åŸå› **:
- å…¼å®¹v3.0å’Œv3.2
- é¿å…é‡å¤æ‰§è¡Œ

**æ”¹åŠ¨**:
1. BaseAPIå±‚æ‹¦æˆªå™¨ï¼šä¿ç•™
2. HttpClientå±‚æ‹¦æˆªå™¨ï¼šä¿ç•™
3. **BaseAPIä¸è°ƒç”¨HttpClientæ‹¦æˆªå™¨**ï¼ˆå·²æ‰§è¡Œè¿‡ï¼‰
4. ä¿®æ”¹`HttpClient.request()`ï¼Œæ¥å—å‚æ•°`skip_interceptors=False`ï¼š
```python
# HttpClient.request()
def request(self, method, url, skip_interceptors=False, **kwargs):
    if not skip_interceptors:
        for interceptor in self.request_interceptors:
            kwargs = interceptor(method, url, **kwargs)
    response = self.client.request(method, url, **kwargs)
    return response

# BaseAPI.get()
def get(self, endpoint, **kwargs):
    url = self._build_url(endpoint)
    kwargs = self._apply_request_interceptors("GET", url, **kwargs)
    # è·³è¿‡HttpClientæ‹¦æˆªå™¨ï¼ˆBaseAPIå·²å¤„ç†ï¼‰
    response = self.http_client.get(url, skip_interceptors=True, **kwargs)
    return self._parse_response(response)
```

**ä¼˜ç‚¹**:
- âœ… v3.0ä»£ç æ— éœ€ä¿®æ”¹
- âœ… v3.2è‡ªåŠ¨é…ç½®ä¹Ÿèƒ½ç”¨
- âœ… ä¸ä¼šé‡å¤æ‰§è¡Œ

**ç¼ºç‚¹**:
- âŒ é€»è¾‘å¤æ‚ï¼ˆéœ€è¦é¢å¤–å‚æ•°ï¼‰
- âŒ è‡ªåŠ¨é…ç½®+æ‰‹å·¥é…ç½®æ··ç”¨æ—¶ï¼Œåªæœ‰BaseAPIçš„ç”Ÿæ•ˆ

---

### æ–¹æ¡ˆD: æ˜ç¡®åˆ†å·¥ + æ–‡æ¡£è¯´æ˜ â­ **ä¸´æ—¶æ–¹æ¡ˆ**

**åŸå› **:
- ä¸æ”¹ä»£ç 
- åªé€šè¿‡æ–‡æ¡£çº¦æŸä½¿ç”¨æ–¹å¼

**è§„åˆ™**:
1. **è‡ªåŠ¨é…ç½®ï¼ˆv3.2ï¼‰**: åªé…ç½®åœ¨`settings.py`ï¼Œä¸ä¼ `request_interceptors`
2. **æ‰‹å·¥é…ç½®ï¼ˆv3.0ï¼‰**: åªä¼ `request_interceptors`ï¼Œä¸é…ç½®åœ¨`settings.py`
3. **ç¦æ­¢æ··ç”¨**

**ä¼˜ç‚¹**:
- âœ… ä¸æ”¹ä»£ç 
- âœ… v3.0å’Œv3.2éƒ½èƒ½ç”¨

**ç¼ºç‚¹**:
- âŒ ç”¨æˆ·å®¹æ˜“è¯¯ç”¨ï¼ˆæ··ç”¨å¯¼è‡´é‡å¤æ‰§è¡Œï¼‰
- âŒ æ²¡æœ‰ä»æ¶æ„å±‚é¢è§£å†³é—®é¢˜

---

## ğŸ“ æˆ‘çš„æ¨è

### çŸ­æœŸï¼ˆv3.2.1ï¼‰: æ–¹æ¡ˆDï¼ˆæ–‡æ¡£çº¦æŸï¼‰

**ç†ç”±**:
- å½“å‰å¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ‰‹å·¥é…ç½®ï¼ˆv3.0æ–¹å¼ï¼‰
- è‡ªåŠ¨é…ç½®æ˜¯æ–°ç‰¹æ€§ï¼Œè¿˜åœ¨æ¢ç´¢é˜¶æ®µ
- ä¸ç ´åå…¼å®¹æ€§

**è¡ŒåŠ¨**:
1. åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ï¼š**ä¸è¦æ··ç”¨**è‡ªåŠ¨é…ç½®å’Œæ‰‹å·¥é…ç½®
2. åœ¨`HttpClient`å’Œ`BaseAPI`çš„docstringä¸­æ·»åŠ è­¦å‘Š
3. ï¼ˆå¯é€‰ï¼‰æ·»åŠ è¿è¡Œæ—¶æ£€æµ‹ï¼šå¦‚æœåŒæ—¶æœ‰ä¸¤å±‚æ‹¦æˆªå™¨ï¼Œæ‰“å°è­¦å‘Š

---

### é•¿æœŸï¼ˆv4.0ï¼‰: æ–¹æ¡ˆAï¼ˆåºŸå¼ƒBaseAPIæ‹¦æˆªå™¨ï¼‰

**ç†ç”±**:
- HttpClientå±‚æ‹¦æˆªå™¨æ˜¯æ›´åˆç†çš„è®¾è®¡
- æ‰€æœ‰HTTPè¯·æ±‚éƒ½ç»è¿‡åŒä¸€ä¸ªå…¥å£
- è‡ªåŠ¨é…ç½®æ›´ç®€æ´

**è¿ç§»è·¯å¾„**:
1. v3.3: æ ‡è®°`BaseAPI.request_interceptors`ä¸ºdeprecated
2. v3.4: æä¾›è¿ç§»å·¥å…·ï¼ˆè‡ªåŠ¨è½¬æ¢ä»£ç ï¼‰
3. v4.0: ç§»é™¤`BaseAPI.request_interceptors`

---

## ğŸ“ SignatureInterceptor è¯¦è§£

### SignatureInterceptor æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ

`SignatureInterceptor` æ˜¯ä¸€ä¸ª**å¯è°ƒç”¨ç±»ï¼ˆCallable Classï¼‰**ï¼Œå®ç°äº†`RequestInterceptor`åè®®ï¼š

```python
# signature.py:203-239
class SignatureInterceptor(BaseSignatureInterceptor):
    """ç­¾åæ‹¦æˆªå™¨ï¼ˆä¾¿æ·ç±»ï¼‰"""

    def __init__(self, config: SignatureConfig):
        # è‡ªåŠ¨æ ¹æ®config.algorithmé€‰æ‹©ç­¾åç­–ç•¥
        if config.algorithm == "md5":
            strategy = MD5SortedValuesStrategy()
        elif config.algorithm == "sha256":
            strategy = SHA256SortedValuesStrategy()
        # ...
        super().__init__(config, strategy)

    def __call__(self, method: str, url: str, **kwargs) -> Dict[str, Any]:
        """å®ç°callableæ¥å£ - è¿™ä¸ªæ–¹æ³•ä¼šè¢«æ‹¦æˆªå™¨æœºåˆ¶è°ƒç”¨"""
        return self.before_request(method, url, **kwargs)
```

### SignatureInterceptor å¯ä»¥ç”¨åœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆï¼šä¸¤ä¸ªåœ°æ–¹éƒ½å¯ä»¥ç”¨ï¼**

#### 1. BaseAPIå±‚æ‹¦æˆªå™¨ï¼ˆv3.0æ‰‹å·¥é…ç½®ï¼‰âœ… **å½“å‰ä½¿ç”¨**

```python
# fixtures/apis.py
@pytest.fixture(scope="session")
def signature_interceptor(signature_config):
    return SignatureInterceptor(signature_config)  # åˆ›å»ºå®ä¾‹

@pytest.fixture
def master_card_api(http_client, signature_interceptor):
    return MasterCardAPI(
        http_client,
        request_interceptors=[signature_interceptor]  # ğŸ”´ æ·»åŠ åˆ°BaseAPI
    )
```

**æ‰§è¡Œæµç¨‹**:
```
master_card_api.get("/master/cards")
    â†“
BaseAPI.get()
    â†“
BaseAPI._apply_request_interceptors()  # è°ƒç”¨interceptor(method, url, **kwargs)
    â†“
signature_interceptor.__call__()  # SignatureInterceptorå®ä¾‹çš„__call__æ–¹æ³•
    â†“
æ·»åŠ  X-Sign header
    â†“
HttpClient.get()  # ä¸å†æ‰§è¡Œæ‹¦æˆªå™¨ï¼ˆHttpClient.request_interceptorsä¸ºç©ºï¼‰
    â†“
httpx.request()
```

#### 2. HttpClientå±‚æ‹¦æˆªå™¨ï¼ˆv3.2è‡ªåŠ¨é…ç½®ï¼‰

```python
# settings.pyï¼ˆå·²æ³¨é‡Šï¼‰
http: HTTPConfig = Field(
    default_factory=lambda: HTTPConfig(
        interceptors=[
            SignatureInterceptorConfig(  # ğŸ”´ é…ç½®ï¼ˆä¸æ˜¯å®ä¾‹ï¼‰
                type="signature",
                algorithm="md5",
                # ...
            ),
        ],
    )
)

# æ¡†æ¶å†…éƒ¨ä¼šè¿™æ ·å¤„ç†ï¼š
# HttpClient.__init__()
def __init__(self, base_url, config):
    self.request_interceptors = []
    if config and config.interceptors:
        for config_obj in config.interceptors:
            # InterceptorFactory.create()ä¼šåˆ›å»ºSignatureInterceptorå®ä¾‹
            interceptor = InterceptorFactory.create(config_obj)
            self.request_interceptors.append(interceptor)  # ğŸ”´ æ·»åŠ åˆ°HttpClient
```

**æ‰§è¡Œæµç¨‹**:
```
master_card_api.get("/master/cards")
    â†“
BaseAPI.get()
    â†“
BaseAPI._apply_request_interceptors()  # request_interceptorsä¸ºç©ºï¼ˆè·³è¿‡ï¼‰
    â†“
HttpClient.get()
    â†“
HttpClient.request()
    â†“
for interceptor in self.request_interceptors:  # ğŸ”´ æ‰§è¡ŒHttpClientçš„æ‹¦æˆªå™¨
    kwargs = interceptor(method, url, **kwargs)
    â†“
signature_interceptor.__call__()
    â†“
æ·»åŠ  X-Sign header
    â†“
httpx.request()
```

### å…³é”®å‘ç°

1. **SignatureInterceptor æœ¬èº«æ²¡æœ‰é—®é¢˜** âœ…
   - å®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¯è°ƒç”¨ç±»
   - å®ç°äº†`RequestInterceptor`åè®®
   - å¯ä»¥ç”¨åœ¨ä»»ä½•æ¥å—callableçš„åœ°æ–¹

2. **é—®é¢˜åœ¨äºä½¿ç”¨æ–¹å¼** âš ï¸
   - **æ‰‹å·¥é…ç½®**ï¼šç›´æ¥åˆ›å»ºå®ä¾‹ â†’ æ·»åŠ åˆ°`BaseAPI.request_interceptors`
   - **è‡ªåŠ¨é…ç½®**ï¼šé€šè¿‡Config â†’ `InterceptorFactory.create()` â†’ æ·»åŠ åˆ°`HttpClient.request_interceptors`
   - **å¦‚æœæ··ç”¨**ï¼šåŒä¸€ä¸ªç­¾åé€»è¾‘ä¼šæ‰§è¡Œ2æ¬¡ï¼

3. **ä¸¤ç§é…ç½®æ–¹å¼åˆ›å»ºçš„æ˜¯åŒä¸€ä¸ªç±»çš„å®ä¾‹**
   ```python
   # æ‰‹å·¥é…ç½®
   interceptor1 = SignatureInterceptor(config)

   # è‡ªåŠ¨é…ç½®ï¼ˆæ¡†æ¶å†…éƒ¨ï¼‰
   interceptor2 = InterceptorFactory.create(SignatureInterceptorConfig(...))
   # InterceptorFactoryå†…éƒ¨ï¼šreturn SignatureInterceptor(config)

   # interceptor1 å’Œ interceptor2 éƒ½æ˜¯ SignatureInterceptor å®ä¾‹
   # åŠŸèƒ½å®Œå…¨ç›¸åŒï¼
   ```

---

## ğŸ“ å½“å‰gift-card-testé¡¹ç›®çŠ¶æ€

### ç°çŠ¶
- âœ… ä½¿ç”¨**æ‰‹å·¥é…ç½®**ï¼ˆBaseAPIå±‚æ‹¦æˆªå™¨ï¼‰
- âœ… `SignatureInterceptor`å®ä¾‹æ·»åŠ åˆ°`BaseAPI.request_interceptors`
- âœ… `settings.py`ä¸­çš„è‡ªåŠ¨é…ç½®å·²**æ³¨é‡Š**ï¼ˆHttpClientå±‚ä¸ºç©ºï¼‰
- âœ… æ²¡æœ‰æ··ç”¨é—®é¢˜
- âœ… **å½“å‰ä»£ç æ˜¯æ­£ç¡®çš„**

### ä¸ºä»€ä¹ˆå½“å‰ä»£ç æœ‰æ•ˆï¼Ÿ

```python
# fixtures/apis.py:60-71
@pytest.fixture(scope="session")
def signature_interceptor(signature_config):
    return SignatureInterceptor(signature_config)  # åˆ›å»ºå®ä¾‹

@pytest.fixture
def master_card_api(http_client, signature_interceptor):
    return MasterCardAPI(
        http_client,
        request_interceptors=[signature_interceptor]  # åªåœ¨BaseAPIå±‚
    )

# http_client fixture (frameworks/testing/fixtures/http_client.py)
@pytest.fixture(scope="session")
def http_client(settings):
    return HttpClient(
        base_url=settings.http.base_url,
        config=settings.http,  # settings.http.interceptorsä¸ºç©ºï¼ˆå·²æ³¨é‡Šï¼‰
    )
    # æ‰€ä»¥ HttpClient.request_interceptors = []ï¼ˆç©ºåˆ—è¡¨ï¼‰
```

**æ‰§è¡Œè·¯å¾„**:
```
master_card_api.get("/master/cards")
    â†“
BaseAPI._apply_request_interceptors()
    â†“
signature_interceptor(method, url, **kwargs)  # âœ… æ‰§è¡Œ1æ¬¡
    â†“
HttpClient.request()
    â†“
for interceptor in self.request_interceptors:  # self.request_interceptors = []
    pass  # âœ… è·³è¿‡ï¼ˆæ²¡æœ‰æ‹¦æˆªå™¨ï¼‰
    â†“
httpx.request()  # âœ… åªç­¾åäº†1æ¬¡
```

### å»ºè®®
- âœ… ä¿æŒå½“å‰æ–¹å¼ï¼ˆæ‰‹å·¥é…ç½®ï¼‰
- âœ… ä¸è¦å–æ¶ˆ`settings.py`çš„æ³¨é‡Šï¼ˆé¿å…æ··ç”¨ï¼‰
- â³ ç­‰æ¡†æ¶ä¿®å¤åå†è€ƒè™‘è¿ç§»åˆ°è‡ªåŠ¨é…ç½®

---

## âœ… ç»“è®º

### æ¡†æ¶ç¡®å®æœ‰é—®é¢˜

1. **åŒå±‚æ‹¦æˆªå™¨æœºåˆ¶æœªåè°ƒ** â†’ å¯èƒ½é‡å¤æ‰§è¡Œ
2. **è‡ªåŠ¨é…ç½®+æ‰‹å·¥é…ç½®æ··ç”¨** â†’ æ‹¦æˆªå™¨æ‰§è¡Œ2æ¬¡
3. **æ–‡æ¡£ç¼ºå¤±** â†’ ç”¨æˆ·ä¸çŸ¥é“ä¸èƒ½æ··ç”¨

### å½“å‰é¡¹ç›®æ²¡é—®é¢˜

- gift-card-teståªä½¿ç”¨æ‰‹å·¥é…ç½® â†’ âœ… æ­£å¸¸å·¥ä½œ
- è‡ªåŠ¨é…ç½®å·²æ³¨é‡Š â†’ âœ… é¿å…å†²çª

### ä¸‹ä¸€æ­¥

1. **æ¡†æ¶ä¿®å¤**ï¼ˆéœ€è¦è®¨è®ºé€‰æ‹©æ–¹æ¡ˆA/B/C/Dï¼‰
2. **æ–‡æ¡£æ›´æ–°**ï¼ˆæ˜ç¡®ä½¿ç”¨è§„åˆ™ï¼‰
3. **æµ‹è¯•é¡¹ç›®**ï¼ˆä¿æŒå½“å‰æ–¹å¼ï¼Œç­‰æ¡†æ¶ä¿®å¤åå†è¿ç§»ï¼‰
