# V3æ¶æ„æ–‡æ¡£ä¸å®é™…ä»£ç å¯¹æ¯”å®¡è®¡

> **çŠ¶æ€**: âš ï¸ å·²å½’æ¡£
> **åŸç‰ˆæœ¬**: v3.x
> **å½’æ¡£åŸå› **: v4.0.0 å·²å‘å¸ƒï¼Œv3 æ¶æ„å®¡è®¡å·²è¿‡æ—¶
> **å½“å‰æ–‡æ¡£**: è¯·å‚è€ƒ [v4.0 æ¶æ„æ€»è§ˆ](../../architecture/ARCHITECTURE_V4.0.md)
>
> **å®¡è®¡æ—¥æœŸ**: 2025-11-03
> **ç›®çš„**: ç¡®ä¿V3_ARCHITECTURE.mdæ–‡æ¡£æè¿°ä¸å®é™…ä»£ç 100%ä¸€è‡´

---

## âœ… Layer 0: common/ - å®Œå…¨ä¸€è‡´

### æ–‡æ¡£æè¿°
```
common/
â”œâ”€â”€ exceptions.py      # å¼‚å¸¸ä½“ç³»
â”œâ”€â”€ types.py           # ç±»å‹å®šä¹‰
â””â”€â”€ protocols.py       # é€šç”¨Protocol
```

### å®é™…ä»£ç 
```
common/
â”œâ”€â”€ exceptions.py      # âœ… å­˜åœ¨
â”œâ”€â”€ types.py           # âœ… å­˜åœ¨
â””â”€â”€ __init__.py
```

### é—®é¢˜
âš ï¸ **protocols.pyä¸å­˜åœ¨** - æ–‡æ¡£ä¸­æè¿°ä½†å®é™…æœªå®ç°

---

## âš ï¸ Layer 1: èƒ½åŠ›å±‚ - éƒ¨åˆ†ä¸ä¸€è‡´

### 1ï¸âƒ£ clients/ - éƒ¨åˆ†ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
clients/
â””â”€â”€ http/
    â”œâ”€â”€ rest/
    â”‚   â”œâ”€â”€ httpx/     # httpxå®ç°
    â”‚   â””â”€â”€ requests/  # requestså®ç°
    â”œâ”€â”€ graphql/       # GraphQL
    â””â”€â”€ grpc/          # gRPC
```

**å®é™…ä»£ç **:
```
clients/
â””â”€â”€ http/
    â””â”€â”€ rest/
        â”œâ”€â”€ httpx/     # âœ… å­˜åœ¨
        â”œâ”€â”€ protocols.py
        â”œâ”€â”€ factory.py
        â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âŒ `requests/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `graphql/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `grpc/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âœ… `protocols.py` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ
- âœ… `factory.py` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ

---

### 2ï¸âƒ£ drivers/ - éƒ¨åˆ†ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
drivers/
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ playwright/
â”‚   â””â”€â”€ selenium/
â”œâ”€â”€ mobile/
â”‚   â”œâ”€â”€ appium/
â”‚   â””â”€â”€ xcuitest/
â””â”€â”€ desktop/
```

**å®é™…ä»£ç **:
```
drivers/
â””â”€â”€ web/
    â”œâ”€â”€ playwright/    # âœ… å­˜åœ¨
    â”œâ”€â”€ protocols.py
    â”œâ”€â”€ factory.py
    â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âŒ `selenium/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `mobile/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `desktop/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âœ… `protocols.py` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ
- âœ… `factory.py` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ

---

### 3ï¸âƒ£ databases/ - éƒ¨åˆ†ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
databases/
â”œâ”€â”€ mysql/             # MySQL
â”œâ”€â”€ postgresql/        # PostgreSQL
â”œâ”€â”€ redis/             # Redis
â”œâ”€â”€ mongodb/           # MongoDB
â”œâ”€â”€ database.py        # é€šç”¨Databaseç±»
â”œâ”€â”€ repositories/      # Repositoryæ¨¡å¼
â””â”€â”€ factory.py         # DatabaseFactory
```

**å®é™…ä»£ç **:
```
databases/
â”œâ”€â”€ redis/             # âœ… å­˜åœ¨
â”œâ”€â”€ database.py        # âœ… å­˜åœ¨
â”œâ”€â”€ repositories/      # âœ… å­˜åœ¨
â”œâ”€â”€ factory.py         # âœ… å­˜åœ¨
â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âŒ `mysql/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `postgresql/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰
- âŒ `mongodb/` - ä¸å­˜åœ¨ï¼ˆé¢„ç•™ï¼‰

---

### 4ï¸âƒ£ messengers/ - éƒ¨åˆ†ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
messengers/
â”œâ”€â”€ queue/
â”‚   â”œâ”€â”€ kafka/
â”‚   â”œâ”€â”€ rabbitmq/
â”‚   â””â”€â”€ pulsar/
â””â”€â”€ stream/
```

**å®é™…ä»£ç **:
```
messengers/
â”œâ”€â”€ queue/
â”‚   â”œâ”€â”€ kafka/         # âœ… å­˜åœ¨ï¼ˆç©ºï¼‰
â”‚   â””â”€â”€ rabbitmq/      # âœ… å­˜åœ¨ï¼ˆç©ºï¼‰
â””â”€â”€ pubsub/            # âš ï¸ ä¸æ˜¯stream/
    â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âŒ `pulsar/` - ä¸å­˜åœ¨
- âš ï¸ `stream/` vs `pubsub/` - å‘½åä¸ä¸€è‡´
- âœ… æ‰€æœ‰å­ç›®å½•éƒ½æ˜¯ç©ºçš„ï¼ˆä»…__init__.pyï¼‰

---

### 5ï¸âƒ£ storages/ - éƒ¨åˆ†ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
storages/
â”œâ”€â”€ object/
â”‚   â”œâ”€â”€ s3/
â”‚   â”œâ”€â”€ minio/
â”‚   â””â”€â”€ oss/
â””â”€â”€ file/
```

**å®é™…ä»£ç **:
```
storages/
â”œâ”€â”€ object/
â”‚   â”œâ”€â”€ s3/            # âœ… å­˜åœ¨ï¼ˆç©ºï¼‰
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ local/         # âš ï¸ æ–‡æ¡£æœªæåŠ
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ blob/              # âš ï¸ æ–‡æ¡£æœªæåŠ
    â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âŒ `minio/` - ä¸å­˜åœ¨
- âŒ `oss/` - ä¸å­˜åœ¨
- âš ï¸ `local/` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ
- âš ï¸ `blob/` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ

---

### 6ï¸âƒ£ engines/ - å®Œå…¨ä¸ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
engines/
â”œâ”€â”€ batch/
â”‚   â””â”€â”€ spark/
â””â”€â”€ stream/
    â””â”€â”€ flink/
```

**å®é™…ä»£ç **:
```
engines/
â”œâ”€â”€ batch/
â”‚   â”œâ”€â”€ spark/         # âœ… å­˜åœ¨ï¼ˆç©ºï¼‰
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ stream/
â”‚   â”œâ”€â”€ flink/         # âœ… å­˜åœ¨ï¼ˆç©ºï¼‰
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ olap/              # âš ï¸ æ–‡æ¡£æœªæåŠ
    â””â”€â”€ __init__.py
```

**é—®é¢˜**:
- âš ï¸ `olap/` - å­˜åœ¨ä½†æ–‡æ¡£æœªæåŠ

---

## âœ… Layer 2: infrastructure/ - å®Œå…¨ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
infrastructure/
â”œâ”€â”€ config/
â”œâ”€â”€ logging/
â”œâ”€â”€ providers/
â”œâ”€â”€ bootstrap/
â””â”€â”€ runtime/
```

**å®é™…ä»£ç **:
```
infrastructure/
â”œâ”€â”€ config/            # âœ… å­˜åœ¨
â”œâ”€â”€ logging/           # âœ… å­˜åœ¨
â”œâ”€â”€ providers/         # âœ… å­˜åœ¨
â”œâ”€â”€ bootstrap/         # âœ… å­˜åœ¨
â”œâ”€â”€ runtime/           # âœ… å­˜åœ¨
â””â”€â”€ __init__.py
```

**çŠ¶æ€**: âœ… å®Œå…¨ä¸€è‡´

---

## âœ… Layer 3: testing/ - å·²ä¿®æ­£ï¼Œä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
testing/
â”œâ”€â”€ assertions/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ builders/
â”œâ”€â”€ fixtures/
â”œâ”€â”€ plugins/
â””â”€â”€ debug/
```

**å®é™…ä»£ç **:
```
testing/
â”œâ”€â”€ assertions/        # âœ… å­˜åœ¨
â”œâ”€â”€ data/
â”‚   â””â”€â”€ builders/      # âœ… å­˜åœ¨
â”œâ”€â”€ fixtures/          # âœ… å­˜åœ¨
â”œâ”€â”€ plugins/           # âœ… å­˜åœ¨
â”œâ”€â”€ debug/             # âœ… å­˜åœ¨
â””â”€â”€ __init__.py
```

**çŠ¶æ€**: âœ… å®Œå…¨ä¸€è‡´ï¼ˆå·²åœ¨å‰é¢ä¿®æ­£ï¼‰

---

## âœ… Layer 4: æ‰©å±•å’Œå·¥å…·å±‚ - å®Œå…¨ä¸€è‡´

**æ–‡æ¡£æè¿°**:
```
extensions/
models/
utils/
cli/
```

**å®é™…ä»£ç **:
```
extensions/            # âœ… å­˜åœ¨
models/                # âœ… å­˜åœ¨
utils/                 # âœ… å­˜åœ¨
cli/                   # âœ… å­˜åœ¨
```

**çŠ¶æ€**: âœ… å®Œå…¨ä¸€è‡´

---

## âš ï¸ é¢å¤–å‘ç°: patterns/ç›®å½•

**å®é™…ä»£ç **:
```
patterns/              # âš ï¸ åº”è¯¥å·²åˆ é™¤ä½†ä»å­˜åœ¨ï¼ˆç©ºç›®å½•ï¼‰
â””â”€â”€ __pycache__/
```

**é—®é¢˜**:
- patterns/ç›®å½•åœ¨v3é‡æ„ä¸­åº”è¯¥å·²åˆ é™¤
- å†…å®¹å·²ç§»åˆ°databases/repositories/å’Œtesting/data/builders/
- ä½†ç›®å½•ä»ç„¶å­˜åœ¨ï¼ˆä»…åŒ…å«__pycache__ï¼‰

---

## ğŸ“Š é—®é¢˜æ±‡æ€»

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆæ–‡æ¡£æè¿°ä¸å®é™…ä¸ä¸€è‡´ï¼‰

1. **common/protocols.py** - æ–‡æ¡£ä¸­å­˜åœ¨ï¼Œå®é™…ä¸å­˜åœ¨
2. **messengers/stream/** vs **messengers/pubsub/** - å‘½åä¸ä¸€è‡´
3. **storages/blob/** - å®é™…å­˜åœ¨ï¼Œæ–‡æ¡£æœªæåŠ
4. **engines/olap/** - å®é™…å­˜åœ¨ï¼Œæ–‡æ¡£æœªæåŠ

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆé¢„ç•™ç›®å½•æè¿°ä¸å®Œæ•´ï¼‰

5. **clients/http/** - ç¼ºå°‘protocols.pyã€factory.pyè¯´æ˜
6. **drivers/web/** - ç¼ºå°‘protocols.pyã€factory.pyè¯´æ˜
7. **storages/file/local/** - å®é™…å­˜åœ¨ï¼Œæ–‡æ¡£æœªæåŠ

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆé¢„ç•™ä½†æœªå®ç°ï¼‰

8. å¤šä¸ªé¢„ç•™ç›®å½•ï¼ˆrequests/ã€graphql/ã€selenium/ã€mysql/ç­‰ï¼‰- æ–‡æ¡£å·²è¯´æ˜é¢„ç•™

### âšª æ¸…ç†é—®é¢˜

9. **patterns/** - ç©ºç›®å½•åº”åˆ é™¤

---

## ğŸ¯ å»ºè®®ä¿®æ­£

### ä¼˜å…ˆçº§P0ï¼ˆç«‹å³ä¿®æ­£ï¼‰

1. **åˆ é™¤æˆ–è¯´æ˜common/protocols.py**
   - é€‰é¡¹A: åˆ é™¤æ–‡æ¡£ä¸­çš„æè¿°
   - é€‰é¡¹B: åˆ›å»ºç©ºçš„protocols.pyæ–‡ä»¶

2. **ç»Ÿä¸€messengers/å‘½å**
   - é€‰é¡¹A: å°†å®é™…ä»£ç `pubsub/`æ”¹ä¸º`stream/`
   - é€‰é¡¹B: æ–‡æ¡£ä¸­`stream/`æ”¹ä¸º`pubsub/`

3. **è¡¥å……æ–‡æ¡£é—æ¼çš„ç›®å½•**
   - æ·»åŠ `storages/blob/`è¯´æ˜
   - æ·»åŠ `engines/olap/`è¯´æ˜
   - æ·»åŠ `storages/file/local/`è¯´æ˜

### ä¼˜å…ˆçº§P1ï¼ˆå»ºè®®ä¿®æ­£ï¼‰

4. **è¡¥å……protocols.pyå’Œfactory.pyè¯´æ˜**
   - åœ¨clients/å’Œdrivers/æè¿°ä¸­æ·»åŠ è¿™ä¸¤ä¸ªæ–‡ä»¶

5. **åˆ é™¤patterns/ç©ºç›®å½•**
   ```bash
   rm -rf src/df_test_framework/patterns
   ```

### ä¼˜å…ˆçº§P2ï¼ˆå¯é€‰ï¼‰

6. **æ ‡æ³¨é¢„ç•™ç›®å½•çŠ¶æ€**
   - åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ ‡æ³¨å“ªäº›æ˜¯"å·²å®ç°"ã€å“ªäº›æ˜¯"é¢„ç•™ï¼ˆç©ºï¼‰"
   - ä¾‹å¦‚: `mysql/  # â³ é¢„ç•™ï¼ˆæœªå®ç°ï¼‰`

---

## ğŸ“ å»ºè®®çš„æ–‡æ¡£æ›´æ–°æ¨¡æ¿

### clients/æè¿°ä¿®æ­£
```
clients/
â””â”€â”€ http/              # HTTPåè®®
    â””â”€â”€ rest/          # RESTé£æ ¼
        â”œâ”€â”€ httpx/     # âœ… httpxå®ç°ï¼ˆå·²å®ç°ï¼‰
        â”œâ”€â”€ protocols.py  # RESTå®¢æˆ·ç«¯Protocolå®šä¹‰
        â”œâ”€â”€ factory.py    # RESTå®¢æˆ·ç«¯å·¥å‚
        â””â”€â”€ __init__.py
    # é¢„ç•™ï¼ˆæœªå®ç°ï¼‰ï¼š
    # â”œâ”€â”€ graphql/       # GraphQLï¼ˆé¢„ç•™ï¼‰
    # â””â”€â”€ grpc/          # gRPCï¼ˆé¢„ç•™ï¼‰
```

### messengers/æè¿°ä¿®æ­£
```
messengers/
â”œâ”€â”€ queue/             # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”œâ”€â”€ kafka/         # â³ Kafkaï¼ˆé¢„ç•™ï¼‰
â”‚   â””â”€â”€ rabbitmq/      # â³ RabbitMQï¼ˆé¢„ç•™ï¼‰
â””â”€â”€ pubsub/            # å‘å¸ƒè®¢é˜…
    â””â”€â”€ __init__.py    # â³ é¢„ç•™
```

### engines/æè¿°ä¿®æ­£
```
engines/
â”œâ”€â”€ batch/             # æ‰¹å¤„ç†
â”‚   â””â”€â”€ spark/         # â³ Sparkï¼ˆé¢„ç•™ï¼‰
â”œâ”€â”€ stream/            # æµå¤„ç†
â”‚   â””â”€â”€ flink/         # â³ Flinkï¼ˆé¢„ç•™ï¼‰
â””â”€â”€ olap/              # OLAPåˆ†æ
    â””â”€â”€ __init__.py    # â³ é¢„ç•™
```

---

**å®¡è®¡ç»“è®º**:
- âœ… Layer 2ï¼ˆinfrastructureï¼‰å’ŒLayer 4 å®Œå…¨ä¸€è‡´
- âœ… Layer 3ï¼ˆtestingï¼‰å·²ä¿®æ­£ï¼Œå®Œå…¨ä¸€è‡´
- âš ï¸ Layer 0ï¼ˆcommonï¼‰å’ŒLayer 1ï¼ˆèƒ½åŠ›å±‚ï¼‰å­˜åœ¨ä¸ä¸€è‡´
- ğŸ¯ å»ºè®®æŒ‰ä¼˜å…ˆçº§ä¿®æ­£æ–‡æ¡£ï¼Œç¡®ä¿100%å‡†ç¡®

**å®¡è®¡äºº**: Claude Code
**å®¡è®¡æ—¥æœŸ**: 2025-11-03
