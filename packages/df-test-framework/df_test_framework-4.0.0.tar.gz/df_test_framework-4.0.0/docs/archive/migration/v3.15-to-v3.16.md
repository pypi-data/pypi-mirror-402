# v3.15 åˆ° v3.16 è¿ç§»æŒ‡å—

> **ç‰ˆæœ¬**: v3.15.0 â†’ v3.16.0
> **åˆ›å»ºæ—¶é—´**: 2025-12-04
> **çŠ¶æ€**: âš ï¸ å·²å½’æ¡£
> **å½“å‰è¿ç§»æŒ‡å—**: è¯·å‚è€ƒ [v3-to-v4.md](../../migration/v3-to-v4.md)

---

**å½’æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£å·²å½’æ¡£ï¼Œä»…ä¾›å†å²å‚è€ƒã€‚å¦‚æœä½ æ­£åœ¨ä» v3 å‡çº§åˆ° v4ï¼Œè¯·å‚è€ƒæœ€æ–°çš„è¿ç§»æŒ‡å—ã€‚

**åŸæ–‡æ¡£ç±»å‹**: ğŸ”´ ç ´åæ€§å˜æ›´

---

## æ¦‚è¿°

v3.16.0 å®Œå…¨ç§»é™¤äº† Interceptor ç³»ç»Ÿï¼Œç»Ÿä¸€ä½¿ç”¨ Middleware ç³»ç»Ÿã€‚è¿™æ˜¯ä¸€æ¬¡**ç ´åæ€§å˜æ›´**ï¼Œæ‰€æœ‰ä½¿ç”¨ Interceptor çš„ä»£ç éƒ½éœ€è¦è¿ç§»ã€‚

## ä¸»è¦å˜æ›´

### 1. ç§»é™¤ Interceptor ç³»ç»Ÿ

**å·²åˆ é™¤çš„ç±»å’Œæ¨¡å—**ï¼š
- âŒ `InterceptorChain`
- âŒ `PathFilteredInterceptor`
- âŒ `SignatureInterceptor`
- âŒ `BearerTokenInterceptor`
- âŒ `InterceptorFactory`
- âŒ `HTTPSettings`
- âŒ `SignatureInterceptorSettings`
- âŒ `BearerTokenInterceptorSettings`

**ä¿ç•™çš„é…ç½®ç±»**ï¼ˆä»…ç”¨äºè‡ªåŠ¨è¿ç§»ï¼‰ï¼š
- âœ… `InterceptorConfig`ï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰
- âœ… `SignatureInterceptorConfig`ï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰
- âœ… `BearerTokenInterceptorConfig`ï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰
- âœ… `HTTPConfig.migrate_interceptors_to_middlewares()`ï¼ˆè‡ªåŠ¨è¿ç§»æ–¹æ³•ï¼‰

### 2. æ–°çš„ Middleware ç³»ç»Ÿ

**æ–°å¢çš„ç±»**ï¼š
- âœ… `MiddlewareConfig`ï¼ˆåŸºç±»ï¼‰
- âœ… `SignatureMiddlewareConfig`
- âœ… `BearerTokenMiddlewareConfig`
- âœ… `RetryMiddlewareConfig`
- âœ… `LoggingMiddlewareConfig`
- âœ… `MiddlewareFactory`
- âœ… `PathFilteredMiddleware`

---

## è¿ç§»æ­¥éª¤

### Step 1: æ›´æ–°é…ç½®ç±»

#### æ—§æ–¹å¼ï¼ˆv3.15ï¼‰

```python
from df_test_framework.infrastructure.config import (
    HTTPSettings,
    SignatureInterceptorSettings,
    BearerTokenInterceptorSettings,
    FrameworkSettings,
)

class MyHTTPSettings(HTTPSettings):
    signature: SignatureInterceptorSettings = Field(
        default_factory=lambda: SignatureInterceptorSettings(
            enabled=True,
            algorithm="md5",
            secret="my_secret",
            include_paths=["/api/**"],
        )
    )

    bearer_token: BearerTokenInterceptorSettings = Field(
        default_factory=lambda: BearerTokenInterceptorSettings(
            enabled=True,
            token_source="login",
            login_url="/auth/login",
            login_credentials={"username": "admin", "password": "pass"},
        )
    )

class MySettings(FrameworkSettings):
    http_settings: MyHTTPSettings = Field(default_factory=MyHTTPSettings)
```

#### æ–°æ–¹å¼ï¼ˆv3.16ï¼‰

```python
from df_test_framework.infrastructure.config import (
    HTTPConfig,
    SignatureMiddlewareConfig,
    BearerTokenMiddlewareConfig,
    SignatureAlgorithm,
    TokenSource,
    FrameworkSettings,
)

class MySettings(FrameworkSettings):
    http: HTTPConfig = Field(
        default_factory=lambda: HTTPConfig(
            base_url="https://api.example.com",
            timeout=30,
            middlewares=[
                # ç­¾åä¸­é—´ä»¶
                SignatureMiddlewareConfig(
                    enabled=True,
                    priority=10,
                    algorithm=SignatureAlgorithm.MD5,
                    secret="my_secret",
                    include_paths=["/api/**"],
                ),
                # Bearer Token ä¸­é—´ä»¶ï¼ˆæš‚ä¸æ”¯æŒ LOGIN æ¨¡å¼ï¼‰
                # BearerTokenMiddlewareConfig(
                #     enabled=True,
                #     priority=20,
                #     source=TokenSource.STATIC,
                #     token="your_static_token",
                # ),
            ],
        )
    )
```

### Step 2: æ›´æ–°å®¢æˆ·ç«¯ä½¿ç”¨

#### æ—§æ–¹å¼ï¼ˆv3.15ï¼‰

```python
# åŒæ­¥å®¢æˆ·ç«¯
client = HttpClient(
    base_url=settings.http_settings.base_url,
    config=settings.http_settings.http_config,
)

# å¼‚æ­¥å®¢æˆ·ç«¯
async with AsyncHttpClient(
    base_url=settings.http_settings.base_url,
    config=settings.http_settings.http_config,
) as client:
    ...
```

#### æ–°æ–¹å¼ï¼ˆv3.16ï¼‰

```python
# åŒæ­¥å®¢æˆ·ç«¯
client = HttpClient(
    base_url=settings.http.base_url,
    config=settings.http,  # ç›´æ¥ä¼ é€’ HTTPConfig
)

# å¼‚æ­¥å®¢æˆ·ç«¯
async with AsyncHttpClient(
    base_url=settings.http.base_url,
    config=settings.http,  # ç›´æ¥ä¼ é€’ HTTPConfig
) as client:
    ...
```

### Step 3: æ›´æ–°ä¸­é—´ä»¶å‚æ•°å‘½å

v3.16.0 ç»Ÿä¸€äº†ä¸­é—´ä»¶å‚æ•°å‘½åï¼š

#### RetryMiddleware

```python
# æ—§æ–¹å¼
RetryMiddleware(
    max_attempts=3,
    backoff=1.0,
    max_backoff=60.0,
)

# æ–°æ–¹å¼
RetryMiddleware(
    max_retries=3,
    initial_delay=1.0,
    max_delay=60.0,
)
```

#### LoggingMiddleware

```python
# æ—§æ–¹å¼
LoggingMiddleware(
    log_request_headers=True,
    log_request_body=True,
    log_response_headers=False,
    log_response_body=True,
)

# æ–°æ–¹å¼
LoggingMiddleware(
    log_request=True,
    log_response=True,
    log_headers=True,
    log_body=True,
    mask_fields=["password", "token"],
)
```

---

## è‡ªåŠ¨è¿ç§»

v3.16.0 æä¾›äº†è‡ªåŠ¨è¿ç§»åŠŸèƒ½ï¼Œæ—§çš„ `InterceptorConfig` ä¼šè‡ªåŠ¨è½¬æ¢ä¸º `MiddlewareConfig`ï¼š

```python
# è¿™æ ·é…ç½®ä»ç„¶å¯ä»¥å·¥ä½œï¼ˆä¼šè‡ªåŠ¨è¿ç§»ï¼‰
http_config = HTTPConfig(
    base_url="...",
    interceptors=[  # âš ï¸ å·²åºŸå¼ƒï¼Œä½†ä¼šè‡ªåŠ¨è¿ç§»åˆ° middlewares
        SignatureInterceptorConfig(
            type="signature",
            algorithm="md5",
            secret="secret",
        ),
    ],
)

# æ¡†æ¶ä¼šåœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨è¿ç§»å¹¶æ‰“å°è­¦å‘Šï¼š
# [INFO] æ£€æµ‹åˆ°æ—§çš„ interceptors é…ç½®ï¼ˆ1 ä¸ªï¼‰ï¼Œæ­£åœ¨è‡ªåŠ¨è¿ç§»åˆ° middlewares...
# [INFO] âœ… å·²è¿ç§» SignatureInterceptor â†’ SignatureMiddleware
# [INFO] è¿ç§»å®Œæˆï¼æˆåŠŸè¿ç§» 1 ä¸ªä¸­é—´ä»¶ã€‚
```

---

## å·²çŸ¥é—®é¢˜

### 1. BearerTokenMiddleware LOGIN æ¨¡å¼æœªå®ç°

```python
# âŒ æš‚ä¸æ”¯æŒ
BearerTokenMiddlewareConfig(
    source=TokenSource.LOGIN,
    login_url="/auth/login",
    credentials={...},
)
# ä¼šæŠ›å‡º NotImplementedError
```

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼šä½¿ç”¨ STATIC æ¨¡å¼

```python
# âœ… å¯ç”¨
BearerTokenMiddlewareConfig(
    source=TokenSource.STATIC,
    token="your_static_token_here",
)
```

### 2. SignatureMiddleware ç­¾åç®—æ³•å·²ä¿®å¤

v3.16.0 ä¸­é—´ä»¶ç³»ç»Ÿå®Œå…¨æ­£å¸¸å·¥ä½œã€‚å¦‚æœé‡åˆ°ç­¾åéªŒè¯å¤±è´¥ï¼ˆ401ï¼‰é—®é¢˜ï¼Œè¯·ç¡®ä¿ï¼š

1. **ç­¾åç®—æ³•ä¸åç«¯ä¸€è‡´** - SignatureMiddleware å·²å¯¹é½ Java åç«¯ SignatureUtil.java
2. **åªæ‹¼æ¥valueå€¼** - ç­¾åæ—¶ä¸åŒ…å« keyï¼ˆå¦‚ "value1value2secret"ï¼Œè€Œé "k1=v1&k2=v2secret"ï¼‰
3. **timestampä¸å‚ä¸ç­¾å** - timestamp åªæ·»åŠ åˆ° headerï¼Œä¸å‚ä¸ç­¾åè®¡ç®—

è¯¦è§: [v3.16.0 å¼‚æ­¥ä¸­é—´ä»¶è°ƒè¯•è®°å½•](../troubleshooting/v3.16.0_async_middleware_debug.md)

---

## é…ç½®å¯¹ç…§è¡¨

| v3.15 | v3.16 | è¯´æ˜ |
|-------|-------|------|
| `HTTPSettings` | `HTTPConfig` | ç›´æ¥ä½¿ç”¨ Pydantic BaseModel |
| `http_settings` | `http` | å­—æ®µåç®€åŒ– |
| `SignatureInterceptorSettings` | `SignatureMiddlewareConfig` | é…ç½®ç±»é‡å‘½å |
| `BearerTokenInterceptorSettings` | `BearerTokenMiddlewareConfig` | é…ç½®ç±»é‡å‘½å |
| `http_config` å±æ€§ | ç›´æ¥ä½¿ç”¨ `http` | ä¸å†éœ€è¦ `.http_config` |
| `interceptors=[]` | `middlewares=[]` | å­—æ®µé‡å‘½å |

---

## æµ‹è¯•éªŒè¯

è¿ç§»å®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹æµ‹è¯•ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼š

```bash
# 1. è¿è¡Œå•å…ƒæµ‹è¯•
uv run pytest tests/test_core/test_http_client.py -v

# 2. è¿è¡Œé…ç½®è¿ç§»æµ‹è¯•
uv run pytest tests/infrastructure/config/test_interceptor_migration.py -v

# 3. è¿è¡Œä¸­é—´ä»¶å·¥å‚æµ‹è¯•
uv run pytest tests/capabilities/clients/http/middleware/test_factory.py -v
```

---

## è·å–å¸®åŠ©

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹[å®Œæ•´å‘å¸ƒè¯´æ˜](../releases/v3.16.0.md)
2. æŸ¥çœ‹[ç¤ºä¾‹ä»£ç ](../../tests/examples/)
3. æäº¤ Issue: https://github.com/yourorg/df-test-framework/issues

---

**ä½œè€…**: DF QA Team
**æœ€åæ›´æ–°**: 2025-12-04
