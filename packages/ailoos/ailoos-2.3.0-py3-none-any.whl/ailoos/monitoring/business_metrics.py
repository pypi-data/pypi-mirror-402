"""
Business Metrics Engine for Ailoos Platform

This module provides business metrics and KPIs calculation for the Ailoos decentralized AI platform.
It includes ROI calculations, energy efficiency, carbon footprint, operational KPIs, and financial metrics.
"""

import time
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple
import math

# DracmaS constants (source: DracmaSToken/src/core/constants.rs)
DMS_INITIAL_SUPPLY = 1_000_000_000

class BusinessMetricsEngine:
    """
    Engine for calculating business metrics and KPIs for the Ailoos platform.

    This class provides methods to calculate various business metrics including:
    - ROI for nodes (revenue vs costs)
    - Energy efficiency (FLOPs/watt)
    - Carbon footprint (CO2 per training)
    - Operational KPIs (system uptime, average latency, aggregate throughput)
    - Financial metrics (DracmaS distribution, marketplace total value)
    """

    def __init__(self):
        """Initialize the BusinessMetricsEngine with data sources."""
        # Placeholder for data sources - to be integrated later
        self.node_data = {}  # Node performance and cost data
        self.energy_data = {}  # Energy consumption data
        self.carbon_factors = {
            'electricity_co2_per_kwh': 0.4,  # kg CO2 per kWh (global average)
            'training_efficiency_factor': 0.8  # Efficiency factor for training
        }
        self.system_start_time = datetime.now()
        self.latency_measurements = []
        self.throughput_measurements = []

    def calculate_roi(self, node_id: str, revenue: float, costs: float) -> float:
        """
        Calculate Return on Investment (ROI) for a specific node.

        Args:
            node_id: Unique identifier for the node
            revenue: Total revenue generated by the node
            costs: Total costs incurred by the node

        Returns:
            ROI as a percentage (e.g., 150.0 for 150%)
        """
        if costs == 0:
            return float('inf') if revenue > 0 else 0.0

        roi = ((revenue - costs) / costs) * 100
        return round(roi, 2)

    def calculate_energy_efficiency(self, flops: float, power_consumption_watts: float) -> float:
        """
        Calculate energy efficiency in FLOPs per watt.

        Args:
            flops: Floating point operations per second
            power_consumption_watts: Power consumption in watts

        Returns:
            Energy efficiency in FLOPs/watt
        """
        if power_consumption_watts == 0:
            return 0.0

        efficiency = flops / power_consumption_watts
        return round(efficiency, 2)

    def calculate_carbon_footprint(self, training_hours: float, power_consumption_watts: float,
                                 location_factor: float = 1.0) -> float:
        """
        Calculate carbon footprint for AI training in kg CO2.

        Args:
            training_hours: Duration of training in hours
            power_consumption_watts: Average power consumption during training
            location_factor: Location-specific carbon intensity factor

        Returns:
            Carbon footprint in kg CO2
        """
        # Convert watts to kWh
        energy_kwh = (power_consumption_watts / 1000) * training_hours

        # Apply carbon factor and location adjustment
        co2_emissions = energy_kwh * self.carbon_factors['electricity_co2_per_kwh'] * location_factor

        # Apply training efficiency factor
        co2_emissions *= (1 / self.carbon_factors['training_efficiency_factor'])

        return round(co2_emissions, 3)

    def get_business_kpis(self) -> Dict[str, float]:
        """
        Get comprehensive business KPIs for the platform.

        Returns:
            Dictionary containing operational and financial KPIs
        """
        kpis = {}

        # Operational KPIs
        kpis['system_uptime_percentage'] = self._calculate_system_uptime()
        kpis['average_latency_ms'] = self._calculate_average_latency()
        kpis['aggregate_throughput_ops_per_sec'] = self._calculate_aggregate_throughput()

        # Financial KPIs
        kpis['total_dracmas_in_circulation'] = self._get_total_dracmas()
        kpis['marketplace_total_value'] = self._calculate_marketplace_value()
        kpis['dracmas_distribution_gini'] = self._calculate_dracmas_gini_coefficient()

        return kpis

    def _calculate_system_uptime(self) -> float:
        """
        Calculate system uptime percentage.

        Returns:
            Uptime percentage (0-100)
        """
        # Sin fuente real de uptime
        return 0.0

    def _calculate_average_latency(self) -> float:
        """
        Calculate average latency from measurements.

        Returns:
            Average latency in milliseconds
        """
        if not self.latency_measurements:
            return 0.0

        avg_latency = sum(self.latency_measurements) / len(self.latency_measurements)
        return round(avg_latency, 2)

    def _calculate_aggregate_throughput(self) -> float:
        """
        Calculate aggregate throughput across all operations.

        Returns:
            Aggregate throughput in operations per second
        """
        if not self.throughput_measurements:
            return 0.0

        avg_throughput = sum(self.throughput_measurements) / len(self.throughput_measurements)
        return round(avg_throughput, 2)

    def _get_total_dracmas(self) -> float:
        """
        Get total DracmaS tokens in circulation.

        Returns:
            Total DracmaS in circulation
        """
        # Fuente canonica: supply inicial DracmaSToken
        return float(DMS_INITIAL_SUPPLY)

    def _calculate_marketplace_value(self) -> float:
        """
        Calculate total value of the marketplace.

        Returns:
            Total marketplace value in USD equivalent
        """
        # Pendiente de integrar data real del marketplace
        return 0.0

    def _calculate_dracmas_gini_coefficient(self) -> float:
        """
        Calculate Gini coefficient for DracmaS distribution.

        Returns:
            Gini coefficient (0-1, where 0 is perfect equality)
        """
        # Sin distribucion real no se calcula
        return 0.0

    def add_latency_measurement(self, latency_ms: float):
        """
        Add a latency measurement for KPI calculations.

        Args:
            latency_ms: Latency in milliseconds
        """
        self.latency_measurements.append(latency_ms)
        # Keep only last 100 measurements
        if len(self.latency_measurements) > 100:
            self.latency_measurements.pop(0)

    def add_throughput_measurement(self, throughput_ops_per_sec: float):
        """
        Add a throughput measurement for KPI calculations.

        Args:
            throughput_ops_per_sec: Throughput in operations per second
        """
        self.throughput_measurements.append(throughput_ops_per_sec)
        # Keep only last 100 measurements
        if len(self.throughput_measurements) > 100:
            self.throughput_measurements.pop(0)
