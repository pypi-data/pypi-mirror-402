apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-config-{{ .Values.customer }}
  namespace: mindroom-instances
  labels:
    app: synapse
    customer: {{ .Values.customer | quote }}
data:
  homeserver.yaml: |
    # Synapse configuration for {{ .Values.customer }}
    server_name: "{{ .Values.customer }}.{{ .Values.baseDomain }}"
    pid_file: /data/homeserver.pid

    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false

    database:
      name: sqlite3
      args:
        database: /data/homeserver.db

    media_store_path: /data/media_store
    uploads_path: /data/uploads

    # Registration and authentication
    enable_registration: true
    enable_registration_without_verification: true
    # If not provided, fallback to a strong random value
    registration_shared_secret: "{{ .Values.matrix_admin_password | default (randAlphaNum 32) }}"

    # Disable reporting stats
    report_stats: false

    # Keys and secrets (independent defaults when not provided)
    macaroon_secret_key: "{{ .Values.matrix_admin_password | default (randAlphaNum 32) }}"
    form_secret: "{{ .Values.matrix_admin_password | default (randAlphaNum 32) }}"
    signing_key_path: /data/{{ .Values.customer }}.signing.key

    # Trusted key servers
    trusted_key_servers:
      - server_name: "matrix.org"

    # Logging
    log_config: /data/log.config

    # URL preview settings
    url_preview_enabled: false

    # Federation (can be disabled for private instances)
    federation_domain_whitelist: []

    # ========================================
    # COMPLETE RATE LIMITING CONFIGURATION
    # All values set to 10000 to effectively disable rate limiting
    # ========================================

    # Message sending rate limit
    rc_message:
      per_second: 10000
      burst_count: 10000

    # Registration rate limit
    rc_registration:
      per_second: 10000
      burst_count: 10000

    # Registration token validity checks
    rc_registration_token_validity:
      per_second: 10000
      burst_count: 10000

    # Login rate limits
    rc_login:
      address:
        per_second: 10000
        burst_count: 10000
      account:
        per_second: 10000
        burst_count: 10000
      failed_attempts:
        per_second: 10000
        burst_count: 10000

    # Admin redaction rate limit
    rc_admin_redaction:
      per_second: 10000
      burst_count: 10000

    # Room join rate limits
    rc_joins:
      local:
        per_second: 10000
        burst_count: 10000
      remote:
        per_second: 10000
        burst_count: 10000

    # Per-room join rate limit
    rc_joins_per_room:
      per_second: 10000
      burst_count: 10000

    # 3PID validation rate limit
    rc_3pid_validation:
      per_second: 10000
      burst_count: 10000

    # Invite rate limits
    rc_invites:
      per_room:
        per_second: 10000
        burst_count: 10000
      per_user:
        per_second: 10000
        burst_count: 10000
      per_issuer:
        per_second: 10000
        burst_count: 10000

    # Third party invite rate limit
    rc_third_party_invite:
      per_second: 10000
      burst_count: 10000

    # Media creation rate limit
    rc_media_create:
      per_second: 10000
      burst_count: 10000

    # Federation rate limits
    rc_federation:
      window_size: 1000000
      sleep_limit: 10000
      sleep_delay: 1
      reject_limit: 10000
      concurrent: 10000

    # Presence rate limits
    rc_presence:
      per_user:
        per_second: 10000
        burst_count: 10000

    # Delayed event management rate limits
    rc_delayed_event_mgmt:
      per_second: 10000
      burst_count: 10000

    # Report content rate limits
    rc_reports:
      per_second: 10000
      burst_count: 10000

    # Room creation rate limits
    rc_room_creation:
      per_second: 10000
      burst_count: 10000

    # Federation read-receipt transactions
    federation_rr_transactions_per_room_per_second: 10000

  log.config: |
    version: 1
    formatters:
      simple:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'
    handlers:
      console:
        class: logging.StreamHandler
        formatter: simple
        stream: ext://sys.stdout
    root:
      level: INFO
      handlers: [console]
    disable_existing_loggers: false
