name: Build MindRoom
# Builds MindRoom instance images in parallel using native ARM64 runners

on:
  # Build (no push) on PRs to validate Dockerfiles
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'local/instances/deploy/Dockerfile.*'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/build-mindroom.yml'
  # Push images only on releases
  release:
    types: [ published ]
  # Manual trigger with push option
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  # Build each image/platform combination in parallel using native runners
  build:
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        image:
          - backend
          - frontend
        platform:
          - linux/amd64
          - linux/arm64
        include:
          # AMD64 builds on standard runners
          - platform: linux/amd64
            platform_suffix: amd64
            runner: ubuntu-latest
          # ARM64 builds on native ARM runners (free for public repos)
          - platform: linux/arm64
            platform_suffix: arm64
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        buildkitd-flags: --debug
        driver-opts: |
          network=host

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set build vars
      id: vars
      run: |
        echo "dockerfile=local/instances/deploy/Dockerfile.${{ matrix.image }}" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        # Extract version from tag (strip 'v' prefix) or use 0.0.0 for non-release builds
        if [[ "${{ github.ref_name }}" == v* ]]; then
          echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
        else
          echo "version=0.0.0" >> $GITHUB_OUTPUT
        fi

    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ steps.vars.outputs.dockerfile }}
        platforms: ${{ matrix.platform }}
        push: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.push_images) }}
        tags: |
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ matrix.platform_suffix }}
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ github.ref_name }}-${{ matrix.platform_suffix }}
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ steps.vars.outputs.timestamp }}-${{ matrix.platform_suffix }}
        build-args: |
          VERSION=${{ steps.vars.outputs.version }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:buildcache-${{ matrix.platform_suffix }}
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:buildcache-${{ matrix.platform_suffix }},mode=max
        provenance: false
        sbom: false

  # Create multi-arch manifests after all builds complete (only on release/manual push)
  manifest:
    needs: build
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.push_images)
    runs-on: ubuntu-latest
    permissions:
      packages: write

    strategy:
      matrix:
        image:
          - backend
          - frontend

    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push manifest
      run: |
        # Create multi-arch manifest with both amd64 and arm64
        docker manifest create \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:latest \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:amd64 \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:arm64

        docker manifest push ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:latest

        # Also create branch-tagged manifest
        docker manifest create \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ github.ref_name }} \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ github.ref_name }}-amd64 \
          ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ github.ref_name }}-arm64

        docker manifest push ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:${{ github.ref_name }}

        echo "âœ… Multi-arch manifest created for mindroom-${{ matrix.image }}"
        echo "Pull with: docker pull ${{ env.REGISTRY }}/${{ env.OWNER }}/mindroom-${{ matrix.image }}:latest"
