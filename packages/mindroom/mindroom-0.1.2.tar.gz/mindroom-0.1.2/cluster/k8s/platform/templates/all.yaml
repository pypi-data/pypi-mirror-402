# Platform Services Deployment
---
apiVersion: v1
kind: Namespace
metadata:
  name: mindroom-{{ .Values.environment }}
---
# Non-sensitive config for platform services
apiVersion: v1
kind: ConfigMap
metadata:
  name: platform-config
  namespace: mindroom-{{ .Values.environment }}
{{ $prov := .Values.provisioner | default (dict) }}
data:
  PLATFORM_DOMAIN: {{ .Values.domain }}
  ENVIRONMENT: {{ .Values.environment }}
  ENABLE_CLEANUP_SCHEDULER: {{ .Values.cleanupScheduler.enabled | default "false" | quote }}
  SUPABASE_URL: {{ .Values.supabase.url | default "" | quote }}
  SUPABASE_ANON_KEY: {{ .Values.supabase.anonKey | default "" | quote }}
  STRIPE_PUBLISHABLE_KEY: {{ .Values.stripe.publishableKey | default "" | quote }}
  PLATFORM_BACKEND_URL: "http://platform-backend:8000"
  GITEA_USER: {{ .Values.gitea.user }}
---
# Sensitive secrets for platform services
apiVersion: v1
kind: Secret
metadata:
  name: platform-secrets
  namespace: mindroom-{{ .Values.environment }}
type: Opaque
stringData:
  supabase_service_key: {{ .Values.supabase.serviceKey }}
  stripe_secret_key: {{ .Values.stripe.secretKey }}
  stripe_webhook_secret: {{ .Values.stripe.webhookSecret }}
  provisioner_api_key: {{ .Values.provisioner.apiKey }}
  gitea_token: {{ .Values.gitea.token }}
  openai_key: {{ .Values.apiKeys.openai | default "" }}
  anthropic_key: {{ .Values.apiKeys.anthropic | default "" }}
  openrouter_key: {{ .Values.apiKeys.openrouter | default "" }}
  google_key: {{ .Values.apiKeys.google | default "" }}
  deepseek_key: {{ .Values.apiKeys.deepseek | default "" }}
---
# Docker registry secret
apiVersion: v1
kind: Secret
metadata:
  name: gitea-registry
  namespace: mindroom-{{ .Values.environment }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf "{\"auths\":{\"git.nijho.lt\":{\"username\":\"basnijholt\",\"password\":\"%s\",\"auth\":\"%s\"}}}" .Values.gitea.token (printf "basnijholt:%s" .Values.gitea.token | b64enc) | b64enc }}
---
# Customer Portal
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-frontend
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-frontend
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: platform-frontend
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: platform-frontend
        environment: {{ .Values.environment }}
    spec:
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/platform-frontend:{{ .Values.imageTag }}
        ports:
        - containerPort: 3000
        envFrom:
        - configMapRef:
            name: platform-config
        env:
        - name: NODE_ENV
          value: production
        - name: PLATFORM_DOMAIN
          valueFrom:
            configMapKeyRef:
              name: platform-config
              key: PLATFORM_DOMAIN
        - name: SUPABASE_URL
          valueFrom:
            configMapKeyRef:
              name: platform-config
              key: SUPABASE_URL
        - name: SUPABASE_ANON_KEY
          valueFrom:
            configMapKeyRef:
              name: platform-config
              key: SUPABASE_ANON_KEY
---
apiVersion: v1
kind: Service
metadata:
  name: platform-frontend
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-frontend
    environment: {{ .Values.environment }}
spec:
  selector:
    app: platform-frontend
    environment: {{ .Values.environment }}
  ports:
  - port: 3000
    targetPort: 3000
---
# Unified Backend (Admin API + Provisioner + Stripe Handler)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-backend
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-backend
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: platform-backend
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: platform-backend
        environment: {{ .Values.environment }}
    spec:
      serviceAccountName: platform-backend
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/platform-backend:{{ .Values.imageTag }}
        ports:
        - containerPort: 8000
        envFrom:
        - configMapRef:
            name: platform-config
        env:
        # Point backend secrets to mounted files for safer access
        - name: SUPABASE_SERVICE_KEY_FILE
          value: "/etc/secrets/supabase_service_key"
        - name: STRIPE_SECRET_KEY_FILE
          value: "/etc/secrets/stripe_secret_key"
        - name: STRIPE_WEBHOOK_SECRET_FILE
          value: "/etc/secrets/stripe_webhook_secret"
        - name: PROVISIONER_API_KEY_FILE
          value: "/etc/secrets/provisioner_api_key"
        - name: GITEA_TOKEN_FILE
          value: "/etc/secrets/gitea_token"
        - name: OPENAI_API_KEY_FILE
          value: "/etc/secrets/openai_key"
        - name: ANTHROPIC_API_KEY_FILE
          value: "/etc/secrets/anthropic_key"
        - name: OPENROUTER_API_KEY_FILE
          value: "/etc/secrets/openrouter_key"
        - name: GOOGLE_API_KEY_FILE
          value: "/etc/secrets/google_key"
        - name: DEEPSEEK_API_KEY_FILE
          value: "/etc/secrets/deepseek_key"
        volumeMounts:
        - name: platform-sensitive
          mountPath: /etc/secrets
          readOnly: true
      volumes:
      - name: platform-sensitive
        secret:
          secretName: platform-secrets
          defaultMode: 0400
---
apiVersion: v1
kind: Service
metadata:
  name: platform-backend
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-backend
    environment: {{ .Values.environment }}
spec:
  selector:
    app: platform-backend
    environment: {{ .Values.environment }}
  ports:
  - name: http
    port: 8000
    targetPort: 8000
{{- if .Values.monitoring.enabled }}
{{- $monitoring := .Values.monitoring | default (dict) }}
{{- $alerts := $monitoring.alerts | default (dict) }}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: platform-backend
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-backend
    release: {{ $monitoring.releaseLabel | default "monitoring" }}
spec:
  namespaceSelector:
    matchNames:
    - mindroom-{{ .Values.environment }}
  selector:
    matchLabels:
      app: platform-backend
      environment: {{ .Values.environment }}
  endpoints:
  - port: http
    path: /metrics
    scheme: http
    interval: {{ $monitoring.scrapeInterval | default "30s" }}
    scrapeTimeout: {{ $monitoring.scrapeTimeout | default "10s" }}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: platform-security-alerts
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: platform-backend
    release: {{ $monitoring.releaseLabel | default "monitoring" }}
spec:
  groups:
  - name: mindroom-security
    rules:
    - alert: MindroomAuthBlockedIP
      expr: 'mindroom_blocked_ips > {{ $alerts.blockedIpThreshold | default 0 }}'
      for: {{ $alerts.blockedIpFor | default "5m" }}
      labels:
        severity: critical
      annotations:
        summary: 'MindRoom auth guard blocked an IP address'
        description: 'At least one IP has been blocked by the auth guard for over {{ $alerts.blockedIpFor | default "5m" }}.'
    - alert: MindroomAdminUnauthorizedSpike
      expr: 'increase(mindroom_admin_verifications_total{outcome="unauthorized"}[{{ $alerts.adminUnauthorizedWindow | default "5m" }}]) > {{ $alerts.adminUnauthorizedThreshold | default 5 }}'
      for: {{ $alerts.adminUnauthorizedFor | default "1m" }}
      labels:
        severity: high
      annotations:
        summary: 'Spike in unauthorized admin verification attempts'
        description: 'More than {{ $alerts.adminUnauthorizedThreshold | default 5 }} unauthorized admin attempts observed within {{ $alerts.adminUnauthorizedWindow | default "5m" }}.'
    - alert: MindroomBlockedRequestFlood
      expr: 'increase(mindroom_auth_events_total{actor="user", outcome="blocked_request"}[{{ $alerts.blockedRequestWindow | default "5m" }}]) > {{ $alerts.blockedRequestThreshold | default 10 }}'
      for: {{ $alerts.blockedRequestFor | default "2m" }}
      labels:
        severity: high
      annotations:
        summary: 'Spike in blocked user requests'
        description: 'More than {{ $alerts.blockedRequestThreshold | default 10 }} blocked user requests observed in {{ $alerts.blockedRequestWindow | default "5m" }}.'
{{- end }}
# Admin Dashboard (Static Frontend)
# Admin dashboard removed - functionality merged into platform-frontend
