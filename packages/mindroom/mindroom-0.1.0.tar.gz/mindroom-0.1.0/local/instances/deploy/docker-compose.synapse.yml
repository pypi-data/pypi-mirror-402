# Synapse Matrix Server Overlay for Mindroom Federation
# Full-featured Matrix server with PostgreSQL and Redis
# Usage: docker compose --env-file .env.{instance} -f docker-compose.yml -f docker-compose.synapse.yml up -d

services:
  postgres:
    image: postgres:15-alpine
    container_name: ${INSTANCE_NAME:-mindroom}-postgres
    environment:
      POSTGRES_DB: synapse
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-synapse_password}
      POSTGRES_INITDB_ARGS: --encoding=UTF8 --locale=C
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mindroom-network

  redis:
    image: redis:7-alpine
    container_name: ${INSTANCE_NAME:-mindroom}-redis
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mindroom-network

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: ${INSTANCE_NAME:-mindroom}-synapse
    environment:
      SYNAPSE_CONFIG_PATH: /data/homeserver.yaml
      SYNAPSE_SERVER_NAME: m-${INSTANCE_DOMAIN}
      SYNAPSE_REPORT_STATS: "no"
      UID: 1000
      GID: 1000
    volumes:
      # Bind mount the entire synapse config directory
      # DATA_DIR should be set in the .env file
      - ${DATA_DIR}/synapse:/data
    # Ports are handled by Traefik - no direct host exposure needed
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/_matrix/client/versions"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Federation requires Matrix domains to resolve to Traefik
    # For LOCAL deployments: Add your Matrix domains here pointing to your Docker network gateway
    # To find your gateway IP, run: docker network inspect mynetwork | jq '.[0].IPAM.Config[0].Gateway'
    # For PUBLIC deployments: Remove the entire extra_hosts section
    extra_hosts:
      - "m-try.mindroom.chat:172.20.0.1"
      - "m-alt.mindroom.chat:172.20.0.1"
      - "m-default.mindroom.chat:172.20.0.1"
      - "m-test.mindroom.chat:172.20.0.1"
      - "m-test-2.mindroom.chat:172.20.0.1"
      - "m-test-3.mindroom.chat:172.20.0.1"
      - "m-test-4.mindroom.chat:172.20.0.1"
      - "m-test-5.mindroom.chat:172.20.0.1"
    networks:
      - mindroom-network
      - mynetwork  # Add Traefik network
    labels:
      - traefik.enable=true

      # Production HTTPS route (m-mything.lab.mydomain.com)
      - traefik.http.routers.${INSTANCE_NAME}-matrix.rule=Host(`m-${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME}-matrix.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME}-matrix.tls=true
      - traefik.http.routers.${INSTANCE_NAME}-matrix.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME}-matrix.service=${INSTANCE_NAME}-matrix
      - traefik.http.services.${INSTANCE_NAME}-matrix.loadbalancer.server.port=8008

      # Federation on port 8448
      - traefik.http.routers.${INSTANCE_NAME}-fed.rule=Host(`m-${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME}-fed.entrypoints=matrix-fed
      - traefik.http.routers.${INSTANCE_NAME}-fed.tls=true
      - traefik.http.routers.${INSTANCE_NAME}-fed.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME}-fed.service=${INSTANCE_NAME}-matrix

  # Update backend to know about Matrix server
  backend:
    environment:
      - MATRIX_HOMESERVER=http://synapse:8008
      - MATRIX_SERVER_NAME=m-${INSTANCE_DOMAIN}
    depends_on:
      synapse:
        condition: service_healthy

networks:
  mindroom-network:
    driver: bridge
  mynetwork:
    external: true

volumes:
  # Named volumes for each instance (prefixed with instance name)
  # Docker manages permissions automatically
  postgres-data:
    name: ${INSTANCE_NAME:-mindroom}-postgres-data
  redis-data:
    name: ${INSTANCE_NAME:-mindroom}-redis-data
