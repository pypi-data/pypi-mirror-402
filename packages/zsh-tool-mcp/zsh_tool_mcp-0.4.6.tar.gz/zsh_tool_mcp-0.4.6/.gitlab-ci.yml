# GitLab CI: Test, Lint, and Sync
# Real CI that actually checks code quality

stages:
  - test
  - lint
  - publish
  - sync

variables:
  GITHUB_REPO: "git@github.com:ArkTechNWA/zsh-tool.git"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# Cache pip downloads between jobs
cache:
  paths:
    - .pip-cache/

# =============================================================================
# Test Stage
# =============================================================================

test:
  stage: test
  image: python:3.13-slim
  before_script:
    - apt-get update && apt-get install -y zsh
    - python -m pip install --upgrade pip
    - pip install pytest pytest-cov pytest-asyncio
    - pip install -e .
  script:
    - python -m pytest tests/ -v --cov=zsh_tool --cov-report=term --cov-report=xml:coverage.xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# =============================================================================
# Lint Stage
# =============================================================================

lint:
  stage: lint
  image: python:3.13-slim
  before_script:
    - pip install ruff
  script:
    - ruff check zsh_tool/ --output-format=gitlab > ruff-report.json || true
    - ruff check zsh_tool/ --statistics
  artifacts:
    reports:
      codequality: ruff-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# =============================================================================
# Publish Stage (PyPI)
# =============================================================================

publish-pypi:
  stage: publish
  image: python:3.13-slim
  before_script:
    - pip install build twine
  script:
    - python -m build
    - twine upload dist/* --non-interactive
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+/
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  environment:
    name: pypi
    url: https://pypi.org/project/zsh-tool-mcp/

# =============================================================================
# Sync Stage (GitHub Mirror)
# =============================================================================

sync-to-github:
  stage: sync
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_DEPLOY_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
    - git config --global user.email "claude@arktechnwa.com"
    - git config --global user.name "Johnny5 CI"
  script:
    - git remote add github $GITHUB_REPO || git remote set-url github $GITHUB_REPO
    - git fetch --unshallow origin || true
    - git push github HEAD:refs/heads/master --force
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        git push github "$CI_COMMIT_TAG"
      fi
