# GitLab CI: Test, Lint, and Sync
# Real CI that actually checks code quality

stages:
  - test
  - lint
  - publish
  - sync

variables:
  GITHUB_REPO: "git@github.com:ArkTechNWA/zsh-tool.git"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# Cache pip downloads between jobs
cache:
  paths:
    - .pip-cache/

# =============================================================================
# Test Stage
# =============================================================================

test:
  stage: test
  image: python:3.13-slim
  before_script:
    - apt-get update && apt-get install -y zsh
    - python -m pip install --upgrade pip
    - pip install pytest pytest-cov pytest-asyncio
    - pip install -e .
  script:
    - python -m pytest tests/ -v --cov=zsh_tool --cov-report=term --cov-report=xml:coverage.xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH  # Only branches - tags inherit commit status

# =============================================================================
# Lint Stage
# =============================================================================

version-check:
  stage: lint
  image: python:3.13-slim
  script:
    - python scripts/version-check.py
  rules:
    - if: $CI_COMMIT_BRANCH  # All branches

lint:
  stage: lint
  image: python:3.13-slim
  before_script:
    - pip install ruff
  script:
    - ruff check zsh_tool/ --output-format=gitlab > ruff-report.json || true
    - ruff check zsh_tool/ --statistics
  artifacts:
    reports:
      codequality: ruff-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH  # Only branches

# =============================================================================
# Publish Stage (PyPI + GitLab Release)
# =============================================================================

# Manual publish from master (emergency/testing)
publish-pypi:
  stage: publish
  image: python:3.13-slim
  before_script:
    - pip install build twine
  script:
    - python -m build
    - twine upload dist/* --non-interactive
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  environment:
    name: pypi
    url: https://pypi.org/project/zsh-tool-mcp/

# Full release: PyPI publish + GitLab Release creation
# Manual button on tags - one click does everything
# Gate: requires passing pipeline on the commit before publishing
release:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script:
    - apk add --no-cache python3 py3-pip curl jq
    - pip install build twine --break-system-packages
    # Gate: require passing pipeline on this commit
    - |
      PASS_COUNT=$(curl -s "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/pipelines?sha=${CI_COMMIT_SHA}&status=success" \
        -H "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" | jq 'length')
      if [ "$PASS_COUNT" -eq 0 ]; then
        echo "❌ No passing pipeline for commit ${CI_COMMIT_SHA}"
        echo "   Tests must pass before release."
        exit 1
      fi
      echo "✓ Commit has passing pipeline"
  script:
    - python3 -m build
    - twine upload dist/* --non-interactive
    - echo "Published to PyPI, creating GitLab Release..."
  release:
    tag_name: $CI_COMMIT_TAG
    name: "$CI_COMMIT_TAG"
    description: "Release $CI_COMMIT_TAG - [PyPI](https://pypi.org/project/zsh-tool-mcp/$CI_COMMIT_TAG/)"
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  environment:
    name: pypi
    url: https://pypi.org/project/zsh-tool-mcp/

# =============================================================================
# Sync Stage (GitHub Mirror)
# =============================================================================

sync-to-github:
  stage: sync
  image: alpine:latest
  needs:
    - job: release
      optional: true  # On master (no release), allows manual sync
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success  # Auto-sync after release succeeds
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_DEPLOY_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
    - git config --global user.email "claude@arktechnwa.com"
    - git config --global user.name "Johnny5 CI"
  script:
    - git remote add github $GITHUB_REPO || git remote set-url github $GITHUB_REPO
    - git fetch --unshallow origin || true
    - git push github HEAD:refs/heads/master --force
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        git push github "$CI_COMMIT_TAG"
      fi
