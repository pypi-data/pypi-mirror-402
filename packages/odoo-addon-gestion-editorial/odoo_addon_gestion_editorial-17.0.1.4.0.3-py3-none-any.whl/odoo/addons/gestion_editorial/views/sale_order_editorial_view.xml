<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <record id="sale_order_form_editorial_view" model="ir.ui.view">
    <field name="name">sale.order.editorial.form.view</field>
    <field name="model">sale.order</field>
    <field name="inherit_id" ref="sale.view_order_form"/>
    <field name="arch" type="xml">
      <field name="partner_id" position="after">
        <field name="is_deposit_sale_order" invisible="1"/>
        <field name="is_client_default_pricelist" invisible="1"/>
        <field name="order_type" invisible="1"/>
      </field>

      <field name="order_line" position="attributes">
          <attribute name="editable">bottom</attribute>
      </field>

      <!-- Hide Create Invoice button for deposit sales + deposit returns -->
      <!-- For liqs, always show button -->
      <button name="%(sale.action_view_sale_advance_payment_inv)d" class="btn-primary" position="attributes">
        <attribute name="invisible">order_type == 'SALE_DEPR' or (is_deposit_sale_order and order_type != 'SALE_LIQ') or invoice_status != 'to invoice'</attribute>
      </button>

      <!-- Add confirm dialog when client default pricelist != sale order pricelist -->
      <xpath expr="//button[@id='action_confirm']" position="replace">
        <button name="action_confirm" id="action_confirm" data-hotkey="q" string="Confirmar" class="btn-primary" type="object" context="{'validate_analytic': True}" 
          confirm="La tarifa de esta venta es diferente a la tarifa que tiene este cliente por defecto. ¿Deseas continuar?"
          invisible="state != 'sent' or is_client_default_pricelist"/>
        <button name="action_confirm" id="action_confirm" data-hotkey="q" string="Confirmar" class="btn-primary" type="object" context="{'validate_analytic': True}" 
          invisible="state != 'sent' or not is_client_default_pricelist"/>
      </xpath>

      <xpath expr="//button[@name='action_confirm' and not(@id)]" position="replace">
        <button name="action_confirm" data-hotkey="q" string="Confirmar" type="object" context="{'validate_analytic': True}" 
          confirm="La tarifa de esta venta es diferente a la tarifa que tiene este cliente por defecto. ¿Deseas continuar?"
          invisible="state != 'draft' or is_client_default_pricelist"/>
        <button name="action_confirm" data-hotkey="q" string="Confirmar" type="object" context="{'validate_analytic': True}" 
          invisible="state != 'draft' or not is_client_default_pricelist"/>
      </xpath>

      <!-- View mods for availiability function (Graph icon) in sale order line -->
      <xpath expr="//field[@name='virtual_available_at_date']" position="after">
        <field name="in_stock_qty" invisible="1"/>
        <field name="in_distribution_qty" invisible="1"/>
      </xpath>
      <xpath expr="//widget[@name='qty_at_date_widget']" position="replace">
        <widget name="sale_order_widget" width="20px"/>
      </xpath>
      <xpath expr="//widget[@name='qty_at_date_widget']" position="replace">
        <widget name="sale_order_widget" width="20px"/>
      </xpath>
      <!-- Add barcode to sale order view -->
      <xpath expr="//field[@name='order_line']//tree//field[@name='product_template_id']" position="after">
        <field name="product_barcode"/>
      </xpath>
    </field>
  </record>

  <!-- Hide deposit sales from "To Invoice" view -->
  <record id="sale.action_orders_to_invoice" model="ir.actions.act_window">
      <field name="domain" 
        eval="[('invoice_status','=','to invoice'), 
        ('pricelist_id.route_id', '!=', ref('gestion_editorial.route_deposit_sales'))]"/>
  </record>

</odoo>
