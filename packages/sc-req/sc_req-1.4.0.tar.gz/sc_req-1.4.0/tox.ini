[tox]
envlist = py,html-sphinx{7,8,9,L},pdf-sphinx{7,8,9,L},xepdf-sphinx{7,8,9,L},report

[testenv]
usedevelop = true
deps = coverage
    sphinx7: sphinx == 7.4.7
    sphinx8: sphinx == 8.2.3
    sphinx9: sphinx == 9.1.0
    sphinxL: sphinx
allowlist_externals=sh
commands = 
    html: coverage run --data-file {toxworkdir}/coverage_{envname} -m sphinx.cmd.build -d "{toxworkdir}/doc_{envname}_doctree" doc "{toxworkdir}/doc_{envname}" -W -E -bhtml
    pdf: coverage run --data-file {toxworkdir}/coverage_{envname} -m sphinx.cmd.build -d "{toxworkdir}/doc_{envname}_doctree" doc "{toxworkdir}/doc_{envname}" -W -E -blatex
    pdf: sh -c "cd {toxworkdir}/doc_{envname} && make && cd ../.."
    xepdf: coverage run --data-file {toxworkdir}/coverage_{envname} -m sphinx.cmd.build -D latex_engine=xelatex -d "{toxworkdir}/doc_{envname}_doctree" doc "{toxworkdir}/doc_{envname}" -W -E -blatex
    xepdf: sh -c "cd {toxworkdir}/doc_{envname} && make && cd ../.."

[testenv:py]
deps = sphinx
    pytest
commands =
    pytest tests

[testenv:clean]
commands = 
    sh -c "rm -rf {toxworkdir}/doc_*"
    sh -c "rm -rf {toxworkdir}/coverage*"

[testenv:report]
description = Build coverage report
deps = coverage
commands = 
    coverage combine --data-file {toxworkdir}/coverage {toxworkdir}/coverage_html-sphinx7  {toxworkdir}/coverage_html-sphinx8 {toxworkdir}/coverage_html-sphinx9  {toxworkdir}/coverage_html-sphinxL  {toxworkdir}/coverage_pdf-sphinx7  {toxworkdir}/coverage_pdf-sphinx8 {toxworkdir}/coverage_pdf-sphinx9  {toxworkdir}/coverage_pdf-sphinxL
    coverage report --data-file {toxworkdir}/coverage 
    coverage html --data-file {toxworkdir}/coverage -d {toxworkdir}/coverage-html/
    coverage xml --data-file {toxworkdir}/coverage -o {toxworkdir}/coverage.xml
