"""
XSource Security - Report Export

Export scan results to JSON and other formats.
"""

import json
from pathlib import Path
from typing import Optional
from datetime import datetime

from .scanner import ScanReport


def save_json_report(report: ScanReport, output_path: Optional[str] = None) -> str:
    """Save scan report as JSON file.

    Args:
        report: ScanReport instance
        output_path: Optional output path (default: xsource_report_TIMESTAMP.json)

    Returns:
        Path to saved file
    """
    if output_path is None:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        output_path = f"xsource_report_{timestamp}.json"

    path = Path(output_path)
    report_dict = report.to_dict()

    with open(path, "w", encoding="utf-8") as f:
        json.dump(report_dict, f, indent=2, ensure_ascii=False)

    return str(path)


def load_json_report(input_path: str) -> dict:
    """Load a previously saved JSON report.

    Args:
        input_path: Path to JSON report file

    Returns:
        Report dictionary
    """
    with open(input_path, "r", encoding="utf-8") as f:
        return json.load(f)


def generate_markdown_report(report: ScanReport) -> str:
    """Generate a Markdown report string.

    Args:
        report: ScanReport instance

    Returns:
        Markdown formatted report
    """
    lines = []

    # Header
    lines.append("# XSource Security Scan Report")
    lines.append("")
    lines.append(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    lines.append(f"**Target:** {report.target}")
    lines.append(f"**Provider:** {report.provider.value}")
    lines.append(f"**Model:** {report.model}")
    lines.append("")

    # Summary
    lines.append("## Summary")
    lines.append("")
    lines.append(f"| Metric | Value |")
    lines.append("|--------|-------|")
    lines.append(f"| Security Score | **{report.security_score:.1f}/100** |")
    lines.append(f"| Vectors Tested | {report.total_vectors} |")
    lines.append(f"| Vulnerabilities | {report.vulnerable_count} |")
    lines.append(f"| Safe | {report.safe_count} |")
    lines.append(f"| Errors | {report.error_count} |")
    lines.append("")

    # Severity Breakdown
    lines.append("## Severity Breakdown")
    lines.append("")
    counts = report.severity_counts
    lines.append("| Severity | Count |")
    lines.append("|----------|-------|")
    for sev in ["critical", "high", "medium", "low", "info"]:
        if counts[sev] > 0:
            emoji = {"critical": "", "high": "", "medium": "", "low": "", "info": ""}[sev]
            lines.append(f"| {emoji} {sev.upper()} | {counts[sev]} |")
    lines.append("")

    # Category Breakdown
    lines.append("## Category Breakdown")
    lines.append("")
    cat_counts = report.category_counts
    category_names = {
        "prompt_injection": "Prompt Injection",
        "jailbreak": "Jailbreak",
        "pii_leak": "PII Leakage",
        "system_prompt_leak": "System Prompt Leak",
        "mcp_basic": "MCP/Tool Abuse",
    }
    lines.append("| Category | Vulnerable | Total |")
    lines.append("|----------|------------|-------|")
    for cat_id, stats in cat_counts.items():
        name = category_names.get(cat_id, cat_id)
        lines.append(f"| {name} | {stats['vulnerable']} | {stats['total']} |")
    lines.append("")

    # Detailed Findings
    vulnerable_results = [r for r in report.results if r.vulnerable]
    if vulnerable_results:
        lines.append("## Detailed Findings")
        lines.append("")
        for result in vulnerable_results:
            severity = result.vector.severity.value.upper()
            lines.append(f"### {severity}: {result.vector.name}")
            lines.append("")
            lines.append(f"- **Category:** {result.vector.category.value.replace('_', ' ').title()}")
            lines.append(f"- **ID:** {result.vector.id}")
            lines.append(f"- **Description:** {result.vector.description}")
            lines.append(f"- **Matched Indicators:** {', '.join(result.matched_indicators) or 'N/A'}")
            lines.append("")
    else:
        lines.append("## Findings")
        lines.append("")
        lines.append("No vulnerabilities detected.")
        lines.append("")

    # Footer
    lines.append("---")
    lines.append("")
    lines.append("*Generated by XSource CLI - Free Tier (50 vectors)*")
    lines.append("")
    lines.append("**Want more?** Upgrade at [xsourcesec.com/pricing](https://xsourcesec.com/pricing)")

    return "\n".join(lines)


def save_markdown_report(report: ScanReport, output_path: Optional[str] = None) -> str:
    """Save scan report as Markdown file.

    Args:
        report: ScanReport instance
        output_path: Optional output path (default: xsource_report_TIMESTAMP.md)

    Returns:
        Path to saved file
    """
    if output_path is None:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        output_path = f"xsource_report_{timestamp}.md"

    path = Path(output_path)
    markdown = generate_markdown_report(report)

    with open(path, "w", encoding="utf-8") as f:
        f.write(markdown)

    return str(path)
