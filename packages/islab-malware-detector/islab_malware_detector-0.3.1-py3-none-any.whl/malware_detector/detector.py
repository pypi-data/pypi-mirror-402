"""Base detector class for malware detection.

This module provides the abstract base class for all malware detectors.
Subclasses must implement train(), evaluate(), and predict() methods.

Typical usage:
    from malware_detector import BaseDetector, BaseDetectorConfig

    class MyDetector(BaseDetector):
        def train(self) -> Path:
            # Train the model
            ...
            return self.config.output.model

        def evaluate(self) -> dict[str, Any]:
            # Evaluate the model
            ...
            return {"accuracy": 0.95}

        def predict(self) -> Path:
            # Run predictions
            ...
            return self.config.output.prediction

    detector = MyDetector()
    model_path = detector.train()
"""

from abc import ABC, abstractmethod
from pathlib import Path
from typing import Any

import structlog

from .config import BaseDetectorConfig


class BaseDetector(ABC):
    """Abstract base class for malware detectors.

    This class defines the interface for all malware detectors.
    Subclasses must implement train(), evaluate(), and predict() methods.

    Attributes:
        config_class: Configuration class to use for this detector.
        config: The loaded configuration instance.
        logger: Structured logger bound to this detector.
    """

    config_class: type[BaseDetectorConfig] = BaseDetectorConfig

    def __init__(self, config: BaseDetectorConfig | None = None) -> None:
        """Initialize the detector with configuration.

        Args:
            config: Configuration instance. If None, creates default
                configuration using config_class.
        """
        self.config = config or self.config_class()
        self.logger = structlog.get_logger().bind(
            detector=self.__class__.__name__,
        )

    def ensure_directory_exists(self, path: Path) -> None:
        """Ensure parent directory exists for a given path.

        Args:
            path: File or directory path. If path has a suffix (file),
                creates parent directory. Otherwise creates the directory.
        """
        directory = path.parent if path.suffix else path
        directory.mkdir(parents=True, exist_ok=True)
        self.logger.debug("directory_created", path=str(directory))

    @abstractmethod
    def train(self) -> Path:
        """Train the detector model.

        Returns:
            Path to the saved model.
        """
        ...

    @abstractmethod
    def evaluate(self) -> dict[str, Any]:
        """Evaluate the detector on test data.

        Returns:
            Dictionary containing evaluation metrics.
        """
        ...

    @abstractmethod
    def predict(self) -> Path:
        """Run prediction on input data.

        Returns:
            Path to the prediction output file.
        """
        ...

    @classmethod
    def create_cli(cls) -> "typer.Typer":  # noqa: F821
        """Create CLI application for this detector.

        Subclasses can call this method and add additional commands
        to the returned Typer application.

        Returns:
            Configured Typer application with train, evaluate, predict commands.
        """
        from .cli import build_cli

        return build_cli(cls, cls.config_class)
