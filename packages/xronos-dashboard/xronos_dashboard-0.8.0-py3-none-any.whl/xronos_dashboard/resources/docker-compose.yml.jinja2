# SPDX-FileCopyrightText: Copyright (c) Xronos Inc.
# SPDX-License-Identifier: LicenseRef-Xronos-Commercial-License-v1

services:
  otel-collector:
    image: xronosinc/xronos-otelcol-influxdb:{{version}}
    pull_policy: missing
    container_name: xronos-otel-collector
    hostname: otel-collector
    networks:
      - xronos-dashboard
    command: ["--config=/etc/otel_collector/config.yaml"]
    volumes:
      - ./otel_collector/config.yml:/etc/otel_collector/config.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "13133:13133" # healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:13133"]
      start_period: 5s
      start_interval: 0.1s
      interval: 10s
      timeout: 5s
      retries: 5
{% if fully_local %}
  influxdb:
    image: influxdb:2.7.10-alpine
    pull_policy: if_not_present
    container_name: xronos-influxdb
    hostname: influxdb
    networks:
      - xronos-dashboard
    ports:
      - "8086:8086/tcp"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=xronos-traces  # passwords must be at least 8 characters long. Insecure password OK because this is a local deployment
      - DOCKER_INFLUXDB_INIT_ORG={{organization}}
      - DOCKER_INFLUXDB_INIT_BUCKET={{database}}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN={{token}}
    volumes:
      - xronos-influxdb-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      start_period: 5s
      start_interval: 0.1s
      interval: 10s
      timeout: 5s
      retries: 5
{% endif %}
  grafana:
    image: xronosinc/xronos-dashboard:{{version}}
    pull_policy: missing
    container_name: xronos-dashboard
    hostname: grafana
    networks:
      - xronos-dashboard
{% if fully_local %}
    links:
      - influxdb
{% endif %}
    ports:
      - "3000:3000"
    extra_hosts:
    - "host.docker.internal:host-gateway"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: xronos
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - xronos-grafana-data:/var/lib/grafana
      - ./grafana/datasources/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    deploy:
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      start_period: 10s
      start_interval: 0.1s
      interval: 10s
      timeout: 5s
      retries: 5
networks:
  xronos-dashboard:
    name: xronos-dashboard
    driver: bridge
volumes:
  xronos-influxdb-data:
  xronos-grafana-data:
