import datetime
from typing import ClassVar
from typing import Optional

import pandas

from armis_sdk.entities.data_export.base_exported_entity import BaseExportedEntity


class Vulnerability(BaseExportedEntity):
    """
    This class represents a vulnerability row that was exported using the data export API.
    """

    entity_name: ClassVar[str] = "vulnerabilities"

    device_id: int
    """The id of the device with the vulnerability"""

    cve_uid: str
    """
    The unique CVE identifier

    **Example**: `CVE-2025-53799`
    """

    advisory_id: Optional[str]
    """
    The id of the advisory

    **Example**: `KB5065429`
    """

    remediation_types: list[str]
    """
    The list of remediation types

    **Example**: `["VERSION_UPDATE"]`
    """

    avm_rating: Optional[str]
    """The Armis AVM (Asset Vulnerability Management) rating of the vulnerability"""

    match_source: list[str]
    """
    The list of sources for the match

    **Example**: `["Profile Matching"]`
    """

    status: str
    """
    The status of the vulnerability in relation to the device

    **Example**: `Open`
    """

    status_change_time: Optional[datetime.datetime]
    """When was the status last changed"""

    status_change_reason: Optional[str]
    """The reason for the status change"""

    @classmethod
    def series_to_model(cls, series: pandas.Series) -> "Vulnerability":
        return Vulnerability(
            device_id=series.loc["device_id"],
            cve_uid=series.loc["vulnerability_cve_uid"],
            advisory_id=cls._value_or_none(series.loc["vulnerability_advisory_id"]),
            remediation_types=cls._to_list(
                series.loc["vulnerability_remediation_types"]
            ),
            avm_rating=cls._value_or_none(series.loc["avm_rating"]),
            match_source=cls._to_list(series.loc["match_source"]),
            status=series.loc["status"],
            status_change_time=cls._value_or_none(series.loc["status_change_time"]),
            status_change_reason=cls._value_or_none(series.loc["status_change_reason"]),
        )
