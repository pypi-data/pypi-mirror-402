Metadata-Version: 2.4
Name: bkflow-sdk
Version: 0.0.44
Summary: A Django app to provide bkflow interface api.
Author-email: blueking <blueking@tencent.com>
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: Django >=3.2, <6
Requires-Dist: djangorestframework >= 3.14, <4
Requires-Dist: drf-yasg >= 1.20.0, <2
Requires-Dist: requests >= 2.28.2, <3
Requires-Dist: pytest >=7.0.1,<8 ; extra == "test"
Requires-Dist: pytest-django>=4.5.2,<5.0 ; extra == "test"
Requires-Dist: pytest-cov>=4.0.0 ; extra == "test"
Requires-Dist: djangorestframework >3, <4 ; extra == "test"
Project-URL: Home, https://github.com/TencentBlueKing/bkflow-sdk
Provides-Extra: test

# BKFlow SDK

[![License](https://img.shields.io/badge/license-MIT-brightgreen.svg)](LICENSE)
[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue.svg)](https://www.python.org/downloads/)
[![Django Version](https://img.shields.io/badge/django-3.2%2B-green.svg)](https://www.djangoproject.com/)

[English](README_EN.md) | ç®€ä½“ä¸­æ–‡

## ðŸ“– é¡¹ç›®ç®€ä»‹

BKFlow SDK æ˜¯ä¸€ä¸ªç”¨äºŽé›†æˆè“é²¸æµç¨‹å¼•æ“Žï¼ˆBlueKing Flow Engineï¼‰çš„ Django åº”ç”¨ç¨‹åº SDKã€‚å®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„ API æŽ¥å£å’Œå®¢æˆ·ç«¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿåœ¨è‡ªå·±çš„ Django é¡¹ç›®ä¸­å¯¹æŽ¥ BKFlow æµç¨‹ç¼–æŽ’èƒ½åŠ›ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- ðŸš€ **å¿«é€Ÿé›†æˆ**ï¼šåªéœ€ç®€å•é…ç½®å³å¯åœ¨ Django é¡¹ç›®ä¸­ä½¿ç”¨
- ðŸ”Œ **å®Œæ•´çš„ API å°è£…**ï¼šæä¾›æµç¨‹æ¨¡æ¿ã€ä»»åŠ¡ã€æ’ä»¶ç­‰å®Œæ•´çš„ API æŽ¥å£
- ðŸŽ¯ **çµæ´»çš„æ‰©å±•**ï¼šæ”¯æŒé€šè¿‡ Signal æœºåˆ¶è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘
- ðŸ›¡ï¸ **å®‰å…¨è®¤è¯**ï¼šå†…ç½®å®Œå–„çš„è®¤è¯å’Œæƒé™ç®¡ç†
- ðŸ“Š **ä¸°å¯Œçš„åŠŸèƒ½**ï¼šæ”¯æŒæµç¨‹æ¨¡æ¿ç®¡ç†ã€ä»»åŠ¡æ‰§è¡Œã€æ’ä»¶ç³»ç»Ÿã€å˜é‡ç®¡ç†ç­‰
- ðŸ”§ **è‡ªå®šä¹‰è¯·æ±‚å¤´**ï¼šæ”¯æŒåœ¨ API è°ƒç”¨æ—¶ä¼ å…¥è‡ªå®šä¹‰ headersï¼Œçµæ´»æŽ§åˆ¶è¯·æ±‚è¡Œä¸º

### ðŸŽ¯ ä¸»è¦åŠŸèƒ½

- **æµç¨‹æ¨¡æ¿ç®¡ç†**ï¼šåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æµç¨‹æ¨¡æ¿ï¼Œæµç¨‹æ¨¡æ¿åˆ—è¡¨æŸ¥è¯¢å’Œç­›é€‰ï¼Œæµç¨‹æ“ä½œè®°å½•è¿½è¸ª
- **ä»»åŠ¡ç®¡ç†**ï¼šåˆ›å»ºå’Œæ‰§è¡Œä»»åŠ¡ï¼ŒæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å’Œè¯¦æƒ…ï¼Œæ‰¹é‡èŽ·å–ä»»åŠ¡çŠ¶æ€ï¼Œä»»åŠ¡ Mock æ•°æ®èŽ·å–
- **æ’ä»¶ç³»ç»Ÿ**ï¼šå†…ç½®æ’ä»¶ç®¡ç†ï¼Œç¬¬ä¸‰æ–¹æ’ä»¶é›†æˆï¼Œæ’ä»¶å…ƒä¿¡æ¯æŸ¥è¯¢ï¼Œå†³ç­–è¡¨æ’ä»¶æ”¯æŒ
- **å˜é‡ç®¡ç†**ï¼šç³»ç»Ÿå˜é‡ç®¡ç†ï¼Œè‡ªå®šä¹‰å˜é‡ç®¡ç†ï¼Œå˜é‡å¼•ç”¨åˆ†æžï¼Œå˜é‡é¢„è§ˆåŠŸèƒ½

## ðŸš€ å¿«é€Ÿå¼€å§‹

### ðŸ“¦ å®‰è£…

```bash
pip install bkflow-sdk
```

### âš™ï¸ é…ç½®

#### 1. æ·»åŠ åˆ° Django é¡¹ç›®

åœ¨ Django é¡¹ç›®çš„ `settings.py` ä¸­æ·»åŠ é…ç½®ï¼š

```python
INSTALLED_APPS = [
    # ... å…¶ä»–åº”ç”¨
    "bkflow.interface",
]

# è“é²¸åº”ç”¨é…ç½®ï¼ˆå¿…å¡«ï¼‰
APP_CODE = "your-app-code"  # è“é²¸åº”ç”¨ID
SECRET_KEY = "your-secret-key"  # è“é²¸åº”ç”¨å¯†é’¥
```

**BKFlow SDK é…ç½®æ”¯æŒä¸¤ç§æ–¹å¼ï¼ˆä»»é€‰å…¶ä¸€æˆ–æ··åˆä½¿ç”¨ï¼‰ï¼š**

##### æ–¹å¼1ï¼šç›´æŽ¥åœ¨ Django settings ä¸­å£°æ˜Žï¼ˆæŽ¨èï¼‰

```python
# BKFlow SDK é…ç½®ï¼ˆå¿…å¡«ï¼‰
BKFLOW_SDK_APIGW_HOST = "https://your-bkflow-api-gateway.com"  # BKFlow API ç½‘å…³åœ°å€
BKFLOW_SDK_DEFAULT_SPACE_ID = 1  # é»˜è®¤ç©ºé—´IDï¼ˆå¯é€‰ï¼Œå¦‚æžœä¸é…ç½® BKFLOW_SDK_SPACE_TRANSFORMER åˆ™å¿…é¡»é…ç½®ï¼‰
BKFLOW_SDK_SPACE_TRANSFORMER = "your_module.path.function_name"  # å¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºŽæ ¹æ® scope_type å’Œ scope_value åŠ¨æ€èŽ·å– space_idï¼Œæ ¼å¼ï¼šmodule.path.function_name æˆ– module.path.ClassName.method_name
BKFLOW_SDK_APIGW_HEADERS_GENERATOR = "your_module.path.function_name"  # å¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºŽæ ¹æ® request åŠ¨æ€èŽ·å– headersï¼Œæ ¼å¼ï¼šmodule.path.function_name æˆ– module.path.ClassName.method_name
```

##### æ–¹å¼2ï¼šåœ¨ BKFLOW_SDK å­—å…¸ä¸­é…ç½®ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰

```python
# BKFlow SDK é…ç½®ï¼ˆå¿…å¡«ï¼‰
BKFLOW_SDK = {
    "BKFLOW_SDK_APIGW_HOST": "https://your-bkflow-api-gateway.com",  # BKFlow API ç½‘å…³åœ°å€
    "BKFLOW_SDK_DEFAULT_SPACE_ID": 1,  # é»˜è®¤ç©ºé—´IDï¼ˆå¯é€‰ï¼Œå¦‚æžœä¸é…ç½® BKFLOW_SDK_SPACE_TRANSFORMER åˆ™å¿…é¡»é…ç½®ï¼‰
    "BKFLOW_SDK_SPACE_TRANSFORMER": "your_module.path.function_name",  # å¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºŽæ ¹æ® scope_type å’Œ scope_value åŠ¨æ€èŽ·å– space_id
    "BKFLOW_SDK_APIGW_HEADERS_GENERATOR": "your_module.path.function_name",  # å¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºŽæ ¹æ® request åŠ¨æ€èŽ·å– headers
}
```

**é…ç½®ä¼˜å…ˆçº§è¯´æ˜Žï¼š**
- å¦‚æžœåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼é…ç½®ç›¸åŒçš„é…ç½®é¡¹ï¼Œ`BKFLOW_SDK` å­—å…¸ä¸­çš„é…ç½®ä¼˜å…ˆçº§æ›´é«˜
- ä¸¤ç§æ–¹å¼å¯ä»¥æ··åˆä½¿ç”¨ï¼Œæœªåœ¨å­—å…¸ä¸­é…ç½®çš„é¡¹ä¼šä»Žç›´æŽ¥å£°æ˜Žçš„é…ç½®ä¸­è¯»å–
- æŽ¨èä½¿ç”¨æ–¹å¼1ï¼ˆç›´æŽ¥å£°æ˜Žï¼‰ï¼Œé…ç½®æ›´ç®€æ´ç›´è§‚

#### 2. é…ç½® URL è·¯ç”±

åœ¨é¡¹ç›®çš„ `urls.py` ä¸­æ·»åŠ è·¯ç”±ï¼š

```python
# urls.py
from django.urls import include, path

urlpatterns = [
    # ... å…¶ä»–è·¯ç”±
    path("api/bkflow/", include("bkflow.interface.urls")),
]
```

#### 3. çŽ¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# .env æ–‡ä»¶
export BKFLOW_SDK_APIGW_HOST="https://your-bkflow-api-gateway.com"
export BKFLOW_SDK_DEFAULT_SPACE_ID=1
export BKFLOW_SDK_SPACE_TRANSFORMER="your_module.path.function_name"  # å¯é€‰ï¼Œç”¨äºŽåŠ¨æ€èŽ·å– space_idï¼Œæ”¯æŒ module.path.function_name æˆ– module.path.ClassName.method_name
export BKFLOW_SDK_APIGW_HEADERS_GENERATOR="your_module.path.function_name"  # å¯é€‰ï¼Œç”¨äºŽåŠ¨æ€èŽ·å– headersï¼Œæ”¯æŒ module.path.function_name æˆ– module.path.ClassName.method_name
export BK_APIGW_STAGE_NAME="prod"  # çŽ¯å¢ƒï¼šprod/stag/test
```

#### 4. é…ç½®è‡ªå®šä¹‰å‡½æ•°ï¼ˆå¯é€‰ï¼‰

##### BKFLOW_SDK_SPACE_TRANSFORMER ç¤ºä¾‹

```python
# utils/space.py
def get_space_id(scope_type=None, scope_value=None):
    """æ ¹æ® scope_type å’Œ scope_value è¿”å›ž space_id"""
    if scope_type == "project":
        return int(scope_value) + 1000  # ç¤ºä¾‹ï¼šé¡¹ç›®IDæ˜ å°„
    return None  # è¿”å›ž None æ—¶ä½¿ç”¨ BKFLOW_SDK_DEFAULT_SPACE_ID

# settings.py
BKFLOW_SDK_SPACE_TRANSFORMER = "utils.space.get_space_id"
```

##### BKFLOW_SDK_APIGW_HEADERS_GENERATOR ç¤ºä¾‹

```python
# utils/headers.py
import json
from django.conf import settings

def generate_headers(request):
    """æ ¹æ® request ç”Ÿæˆ headers"""
    return {
        "X-Bkapi-Authorization": json.dumps({
            "bk_app_code": settings.APP_CODE,
            "bk_app_secret": settings.SECRET_KEY,
            "bk_ticket": request.COOKIES.get("bk_ticket", ""),
        })
    }

# settings.py
BKFLOW_SDK_APIGW_HEADERS_GENERATOR = "utils.headers.generate_headers"
```

## ðŸ“š åŸºæœ¬ä½¿ç”¨

### ä½¿ç”¨ API å®¢æˆ·ç«¯

```python
from bkflow.client.core import get_client_by_user

# èŽ·å–å®¢æˆ·ç«¯å®žä¾‹
client = get_client_by_user("admin")

# èŽ·å–æµç¨‹æ¨¡æ¿åˆ—è¡¨
templates = client.bkflow.list_templates(
    path_params={"space_id": 1},
    limit=20,
    offset=0
)

# åˆ›å»ºæµç¨‹æ¨¡æ¿
template = client.bkflow.create_template(
    path_params={"space_id": 1},
    name="æµ‹è¯•æµç¨‹",
    pipeline_tree={
        "activities": {},
        "constants": {},
        "gateways": {},
    },
    operator="admin"
)

# åˆ›å»ºä»»åŠ¡
task = client.bkflow.create_task(
    {
        "template_id": 100,
        "name": "æµ‹è¯•ä»»åŠ¡",
        "creator": "admin",
        "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡",
        "constants": {"key1": "value1"}
    },
    path_params={"space_id": 1}
)
```

### ä½¿ç”¨è‡ªå®šä¹‰ Headers

å¯¹äºŽéœ€è¦ token è®¤è¯çš„æŽ¥å£ï¼Œéœ€è¦åœ¨ headers ä¸­ä¼ å…¥ tokenï¼š

```python
from bkflow.client.core import get_client_by_user
from bkflow.config.default import API_TOKEN_HEADER_KEY

client = get_client_by_user("admin")

# è°ƒç”¨éœ€è¦ token çš„æŽ¥å£
template = client.bkflow.fetch_template(
    path_params={"template_id": 100},
    headers={API_TOKEN_HEADER_KEY: "your-token-value"}
)

# ä¼ å…¥è‡ªå®šä¹‰ headers
result = client.bkflow.list_templates(
    path_params={"space_id": 1},
    headers={
        "X-Request-ID": "req-12345",
        "X-Client-Version": "1.0.0",
    }
)
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. é…ç½®è¦æ±‚

- **å¿…å¡«é…ç½®**ï¼š
  - `BKFLOW_SDK_APIGW_HOST`ï¼šBKFlow API ç½‘å…³åœ°å€ï¼Œå¿…é¡»æ­£ç¡®é…ç½®
  - `APP_CODE` å’Œ `SECRET_KEY`ï¼šè“é²¸åº”ç”¨è®¤è¯ä¿¡æ¯ï¼Œå¿…é¡»é…ç½®

- **å¯é€‰é…ç½®**ï¼š
  - `BKFLOW_SDK_DEFAULT_SPACE_ID`ï¼šé»˜è®¤ç©ºé—´IDï¼Œå¦‚æžœä¸é…ç½® `BKFLOW_SDK_SPACE_TRANSFORMER` åˆ™å¿…é¡»é…ç½®æ­¤é€‰é¡¹
  - `BKFLOW_SDK_SPACE_TRANSFORMER`ï¼šå¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼Œæ ¼å¼ä¸º `module.path.function_name` æˆ– `module.path.ClassName.method_name`ï¼Œç”¨äºŽæ ¹æ® `scope_type` å’Œ `scope_value` åŠ¨æ€èŽ·å– `space_id`ã€‚è¯¥å‡½æ•°æŽ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`scope_type` å’Œ `scope_value`ï¼Œè¿”å›ž `space_id`ã€‚å¦‚æžœé…ç½®äº†æ­¤é€‰é¡¹ï¼Œå°†ä¼˜å…ˆä½¿ç”¨æ­¤å‡½æ•°èŽ·å– `space_id`ï¼Œå¦åˆ™ä½¿ç”¨ `BKFLOW_SDK_DEFAULT_SPACE_ID`
  - `BKFLOW_SDK_APIGW_HEADERS_GENERATOR`ï¼šå¯æ‰§è¡Œå‡½æ•°è·¯å¾„ï¼Œæ ¼å¼ä¸º `module.path.function_name` æˆ– `module.path.ClassName.method_name`ï¼Œç”¨äºŽæ ¹æ® `request` åŠ¨æ€èŽ·å– headersã€‚è¯¥å‡½æ•°æŽ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼š`request`ï¼ˆDjango request å®žä¾‹ï¼‰ï¼Œè¿”å›žä¸€ä¸ª headers å­—å…¸ã€‚å¦‚æžœé…ç½®äº†æ­¤é€‰é¡¹ï¼Œ`get_redirect_client_with_auth` å°†ä¼˜å…ˆä½¿ç”¨æ­¤å‡½æ•°èŽ·å– headersï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„ headers ç”Ÿæˆé€»è¾‘ï¼ˆä»Ž cookies å’Œ META ä¸­èŽ·å–è®¤è¯ä¿¡æ¯ï¼‰
  - `BK_APIGW_STAGE_NAME`ï¼šAPI ç½‘å…³çŽ¯å¢ƒï¼Œé»˜è®¤ä¸º `prod`

**é…ç½®æ–¹å¼è¯´æ˜Žï¼š**
- æ‰€æœ‰ä»¥ `BKFLOW_SDK` å‰ç¼€å¼€å¤´çš„é…ç½®é¡¹æ”¯æŒä¸¤ç§å£°æ˜Žæ–¹å¼ï¼š
  1. **ç›´æŽ¥å£°æ˜Ž**ï¼šåœ¨ `settings.py` ä¸­ç›´æŽ¥å£°æ˜Ž `BKFLOW_SDK_XXX = value`
  2. **å­—å…¸é…ç½®**ï¼šåœ¨ `BKFLOW_SDK` å­—å…¸ä¸­é…ç½® `BKFLOW_SDK = {"BKFLOW_SDK_XXX": value}`
- å¦‚æžœåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼é…ç½®ç›¸åŒçš„é…ç½®é¡¹ï¼Œ`BKFLOW_SDK` å­—å…¸ä¸­çš„é…ç½®ä¼˜å…ˆçº§æ›´é«˜
- ä¸¤ç§æ–¹å¼å¯ä»¥æ··åˆä½¿ç”¨ï¼ŒæŽ¨èä½¿ç”¨ç›´æŽ¥å£°æ˜Žæ–¹å¼ï¼Œé…ç½®æ›´ç®€æ´ç›´è§‚

### 2. Token è®¤è¯

éƒ¨åˆ†æŽ¥å£éœ€è¦ token è®¤è¯ï¼ˆæ ‡è®°ä¸º `token_required=True`ï¼‰ï¼Œè°ƒç”¨è¿™äº›æŽ¥å£æ—¶å¿…é¡»åœ¨ headers ä¸­ä¼ å…¥ `BKFLOW-TOKEN`ï¼š

```python
from bkflow.config.default import API_TOKEN_HEADER_KEY

# éœ€è¦ token çš„æŽ¥å£ç¤ºä¾‹
client.bkflow.fetch_template(
    path_params={"template_id": 100},
    headers={API_TOKEN_HEADER_KEY: "your-token"}
)
```

### 3. Headers åˆå¹¶è§„åˆ™

- `BaseAPIClient`ï¼šè°ƒç”¨æ—¶ä¼ å…¥çš„ headers ä¼šè¦†ç›–å®¢æˆ·ç«¯å®žä¾‹çš„ headers
- `RequestAPIClient`ï¼šå®¢æˆ·ç«¯å®žä¾‹çš„ headers ä¼šè¦†ç›–è°ƒç”¨æ—¶ä¼ å…¥çš„ headers

### 4. é”™è¯¯å¤„ç†

SDK ä¼šè‡ªåŠ¨å¤„ç† API è°ƒç”¨å¼‚å¸¸ï¼Œè¿”å›žç»Ÿä¸€çš„é”™è¯¯æ ¼å¼ï¼š

```python
{
    "result": False,
    "message": "é”™è¯¯ä¿¡æ¯",
    "data": None
}
```

### 5. ç”¨æˆ·è®¤è¯

ä½¿ç”¨ `get_client_by_user()` æ—¶ï¼Œéœ€è¦ç¡®ä¿ï¼š
- ç”¨æˆ·å·²é€šè¿‡è“é²¸è®¤è¯
- å·²æ­£ç¡®é…ç½® `bkoauth` æˆ–ä½¿ç”¨ `bk_ticket`/`bk_token` è¿›è¡Œè®¤è¯

## ðŸ“‹ ç‰ˆæœ¬åŽ†å²

æŸ¥çœ‹ [release.md](release.md) äº†è§£ç‰ˆæœ¬æ›´æ–°åŽ†å²ã€‚

### å½“å‰ç‰ˆæœ¬

- **æœ€æ–°ç‰ˆæœ¬** - åŠŸèƒ½æ›´æ–°
  - âœ¨ **æ–°å¢žåŠŸèƒ½**ï¼šæ”¯æŒåœ¨ API è°ƒç”¨æ—¶ä¼ å…¥è‡ªå®šä¹‰ headers
  - ðŸ› **Bug ä¿®å¤**ï¼šä¿®å¤äº† token éªŒè¯é€»è¾‘
  - âœ… **æµ‹è¯•å®Œå–„**ï¼šæ·»åŠ äº†è‡ªå®šä¹‰ headers åŠŸèƒ½çš„å®Œæ•´æµ‹è¯•ç”¨ä¾‹

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ðŸ”— ç›¸å…³é“¾æŽ¥

- [è“é²¸æ™ºäº‘å®˜ç½‘](https://bk.tencent.com/)
- [é¡¹ç›®ä¸»é¡µ](https://github.com/TencentBlueKing/bkflow-sdk)
- [é—®é¢˜åé¦ˆ](https://github.com/TencentBlueKing/bkflow-sdk/issues)

## ðŸ’¬ æ”¯æŒ

å¦‚æžœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼èŽ·å–å¸®åŠ©ï¼š

- æäº¤ [Issue](https://github.com/TencentBlueKing/bkflow-sdk/issues)
- æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£
- åŠ å…¥è“é²¸ç¤¾åŒºè®¨è®º

---

Copyright Â© 2022 THL A29 Limited, a Tencent company. All Rights Reserved.

