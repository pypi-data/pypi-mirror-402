name: Build

on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatch jupyterlab

      - name: Install Node dependencies
        run: jlpm install

      - name: Build the extension
        run: |
          jlpm run build
          python -m build --wheel

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jupyterlab-bucket-explorer-dist
          path: dist/
          retention-days: 7

  test-install:
    name: Test Installation
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: jupyterlab-bucket-explorer-dist

      - name: Install extension
        run: |
          pip install jupyterlab==4.4.10
          pip install jupyterlab_bucket_explorer*.whl

      - name: Verify installation
        run: |
          jupyter labextension list
          jupyter labextension list 2>&1 | grep -i "jupyterlab-bucket-explorer"
          jupyter server extension list
          jupyter server extension list 2>&1 | grep -i "jupyterlab_bucket_explorer"

  test-python:
    name: Python Tests
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -c constraints-test.txt .[test]

      - name: Run pytest
        run: |
          pytest -q

  test-frontend:
    name: Frontend Unit Tests
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          pip install jupyterlab
          jlpm install

      - name: Run Jest
        run: |
          jlpm test

  test-ui:
    name: UI Tests
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Start MinIO (E2E)
        run: |
          docker run -d --name minio \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:RELEASE.2024-12-18T13-15-44Z server /data --console-address ":9001"

      - name: Wait for MinIO (E2E)
        run: |
          for i in {1..7}; do
            if curl -sf http://127.0.0.1:9000/minio/health/ready; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: .playwright-browsers
          key: ${{ runner.os }}-playwright-${{ hashFiles('ui-tests/package.json', 'ui-tests/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: jupyterlab-bucket-explorer-dist
          path: dist/

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyterlab
          pip install dist/*.whl
          pip install -c constraints-test.txt pytest pytest-tornasync

      - name: Install Node dependencies
        run: jlpm install

      - name: Seed MinIO data (E2E)
        env:
          S3_ENDPOINT: http://127.0.0.1:9000
          S3_ACCESS_KEY: minioadmin
          S3_SECRET_KEY: minioadmin
          S3_REGION: us-east-1
        run: |
          pip install boto3
          python - <<'PY'
          import os
          import boto3

          s3 = boto3.resource(
              "s3",
              endpoint_url=os.environ["S3_ENDPOINT"],
              aws_access_key_id=os.environ["S3_ACCESS_KEY"],
              aws_secret_access_key=os.environ["S3_SECRET_KEY"],
              region_name=os.environ["S3_REGION"],
          )
          bucket = s3.Bucket("ci-bucket")
          bucket.create()
          bucket.put_object(Key="hello.txt", Body=b"hello")
          PY

      - name: Install UI test dependencies
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.playwright-browsers
        run: |
          cd ui-tests
          jlpm install
          jlpm playwright install --with-deps

      - name: Run UI tests
        env:
          E2E_MINIO: "1"
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.playwright-browsers
          PYTHON: ${{ env.pythonLocation }}/bin/python
          S3_ENDPOINT: http://127.0.0.1:9000
          S3_ACCESS_KEY: minioadmin
          S3_SECRET_KEY: minioadmin
          S3_REGION: us-east-1
        run: |
          export PATH="${pythonLocation}/bin:${PATH}"
          cd ui-tests
          jlpm playwright test

      - name: DEBUG - Upload MinIO logs (runs only on failure)
        if: ${{ failure() }}
        run: |
          # DEBUG: runs only on failure
          mkdir -p .artifacts
          docker logs minio > .artifacts/minio.log 2>&1 || true
          # DEBUG: runs only on failure

      - name: DEBUG - upload MinIO logs artifact (runs only on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: debug-minio-logs
          path: .artifacts/minio.log

      - name: DEBUG - server start smoke check (runs only on failure)
        if: ${{ failure() }}
        run: |
          # DEBUG: runs only on failure
          export PATH="${pythonLocation}/bin:${PATH}"
          cd ui-tests
          jlpm start & sleep 10
          curl -I http://localhost:8888/lab || true
          # Capture recent logs if any (best-effort)
          find .jupyter -type f -maxdepth 4 -print -exec tail -n 200 {} \; || true
          # DEBUG: runs only on failure
