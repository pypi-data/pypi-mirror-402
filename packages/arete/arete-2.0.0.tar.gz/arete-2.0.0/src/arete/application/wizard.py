import os
from pathlib import Path

from arete.application.utils.common import detect_anki_paths


def run_init_wizard():
    print("Welcome to arete Configuration Wizard!")
    print("This will verify your setup and create a ~/.config/arete/config.toml file.")
    print("")

    # 1. Vault Root
    vault_root = _ask_path("Obsidian Vault Root", default=str(Path.home() / "Obsidian Vault"))

    # 2. Anki Media
    detected_base, detected_media = detect_anki_paths()
    anki_media = _ask_path(
        "Anki Media Directory", default=str(detected_media) if detected_media else None
    )

    # 3. Backend
    print("\nSelect Anki Backend:")
    print("  1. auto (Try AnkiConnect, fall back to apy) [Default]")
    print("  2. ankiconnect (Requires Anki running + AnkiConnect add-on)")
    print("  3. direct (Direct DB access, requires Anki closed)")
    choice = input("Select backend [1]: ") or "1"

    backend = "auto"
    if choice == "2":
        backend = "ankiconnect"
    elif choice == "3":
        backend = "direct"

    # Generate config content
    config_content = f"""# arete Configuration
# Generated by arete init

# Path to your Obsidian Vault
vault_root = "{vault_root}"

# Path to Anki Media folder
anki_media_dir = "{anki_media}"

# Anki Backend (auto, ankiconnect, apy)
backend = "{backend}"

# Default verbosity (0=WARNING, 1=INFO, 2=DEBUG)
verbose = 1

# Optional: Set a default input path if you always run on the same file/folder
# path = "{vault_root}"
"""

    target_path = Path.home() / ".config/arete/config.toml"
    # Ensure directory exists
    target_path.parent.mkdir(parents=True, exist_ok=True)

    if target_path.exists():
        ovr = input(f"\n{target_path} already exists. Overwrite? [y/N]: ").strip().lower()
        if ovr != "y":
            print("Aborted.")
            return

    try:
        with open(target_path, "w", encoding="utf-8") as f:
            f.write(config_content)
        print(f"\nConfiguration saved to {target_path}")
        print("You can now run 'arete <path>' without specifying media/vault flags.")
    except Exception as e:
        print(f"Error writing config: {e}")


def _ask_path(label: str, default: str | None = None) -> str:
    while True:
        prompt = f"{label} "
        if default:
            prompt += f"[{default}]: "
        else:
            prompt += ": "

        val = input(prompt).strip()
        if not val and default:
            val = default

        if not val:
            print("Value required.")
            continue

        # Basic expansion
        p = Path(os.path.expanduser(val)).resolve()
        if not p.exists():
            print(f"Warning: Path '{p}' does not exist.")
            confirm = input("Use anyway? [y/N]: ").strip().lower()
            if confirm == "y":
                return str(p)
        else:
            return str(p)
