name: Create Version

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Ensure main branch
        run: |
          BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          if [ "$BRANCH" != "main" ]; then
            echo "This workflow can only run on main (current: $BRANCH)"
            exit 1
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Read and convert version (PEP 440 → SemVer)
        id: version
        run: |
          python - <<'PY'
          import re, tomllib, os

          with open("pyproject.toml", "rb") as f:
              raw = tomllib.load(f)["project"]["version"]

          pep440 = re.compile(
              r"^(?P<base>\d+\.\d+\.\d+)"
              r"(?:(?P<pre>a|b|rc)(?P<pre_n>\d+))?"
              r"(?:(?:\.post)(?P<post_n>\d+))?$"
          )

          m = pep440.fullmatch(raw)
          if not m:
              raise SystemExit(f"Unsupported PEP 440 version: {raw}")

          base = m["base"]
          semver = base

          if m["pre"]:
              label = {"a": "alpha", "b": "beta", "rc": "rc"}[m["pre"]]
              semver += f"-{label}.{m['pre_n']}"

          if m["post_n"]:
              semver += f"+post.{m['post_n']}"

          # Write to GITHUB_OUTPUT
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"raw={raw}\n")
              f.write(f"semver={semver}\n")

          print(f"Version: {raw} → {semver}")
          PY

      - name: Fetch and prune tags
        run: git fetch --tags --prune

      - name: Fail if tag already exists
        run: |
          VERSION="${{ steps.version.outputs.semver }}"
          if git ls-remote --tags origin "v$VERSION" | grep -q .; then
            echo "Tag v$VERSION already exists"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ steps.version.outputs.semver }}"
          git tag "v$VERSION" -m "Version $VERSION"
          git push origin "v$VERSION"
