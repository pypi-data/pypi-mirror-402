# Copyright 2025 Terradue
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: '3'

tasks:

  install_prerequisites:
    internal: true
    cmds:
    - pip install datamodel-code-generator json-schema-for-humans csvkit

  generate_jsonschema_doc:
    cmds:
    - generate-schema-doc --config template_name=md ./schemas ./docs/schemas

  datamodel_codegen:
    internal: true
    cmds:
    - |
      datamodel-codegen --input ./schemas/{{.SCHEMA}}.yaml \
                        --input-file-type jsonschema \
                        --output-model-type pydantic_v2.BaseModel \
                        --base-class transpiler_mate.TranspilerBaseModel \
                        --additional-imports "pydantic.AliasChoices,typing.Any,transpiler_mate.TranspilerBaseModel" \
                        --field-constraints \
                        --use-schema-description \
                        --collapse-root-models \
                        --capitalise-enum-members \
                        --use-one-literal-as-default \
                        --strip-default-none \
                        --snake-case-field \
                        {{if eq .USE_CUSTOM_TEMPLATES "true"}}--custom-template-dir ./templates{{end}}\
                        --output ./src/transpiler_mate/{{.TARGET_DIR}}/{{.SCHEMA}}_models.py

  process_datacite:
    cmds:
    - task: datamodel_codegen
      vars:
        SCHEMA: 'datacite_4_6'
        USE_CUSTOM_TEMPLATES: 'false'
        TARGET_DIR: 'datacite'

  process_schemaorg:
    cmds:
    - task: datamodel_codegen
      vars:
        SCHEMA: 'software_application'
        USE_CUSTOM_TEMPLATES: 'true'
        TARGET_DIR: 'metadata'

  process_ogcrecord:
    cmds:
    - task: datamodel_codegen
      vars:
        SCHEMA: 'ogcapi_records'
        USE_CUSTOM_TEMPLATES: 'false'
        TARGET_DIR: 'ogcapi_records'

  download_licenses_index:
    cmds:
    - |
      echo "# Transpiler Mate (c) 2025
      # 
      # Transpiler Mate is licensed under
      # Creative Commons Attribution-ShareAlike 4.0 International.
      # 
      # You should have received a copy of the license along with this work.
      # If not, see <https://creativecommons.org/licenses/by-sa/4.0/>.

      from .software_application_models import CreativeWork
      from pydantic import AnyUrl
      from typing import Mapping
      
      LICENSES_INDEX: Mapping[str, CreativeWork] = {" > ./src/transpiler_mate/metadata/licenses.py
    - |
      curl -s https://raw.githubusercontent.com/spdx/license-list-data/refs/heads/main/json/licenses.json \
      | jq -r --arg sq "'" '.licenses[] |
      "  \($sq)\(.licenseId)\($sq): CreativeWork(
          identifier=\($sq)\(.licenseId)\($sq),
          name=\($sq)\(.name | gsub($sq; "\u005C\u0027"))\($sq),
          url=AnyUrl(\($sq)\((.seeAlso[0] // .reference // ""))\($sq))
        ), # type: ignore"' \
      >> ./src/transpiler_mate/metadata/licenses.py
    - echo "}" >> ./src/transpiler_mate/metadata/licenses.py

  download_science_keywords_index:
    cmds:
    - |
      echo "# Transpiler Mate (c) 2025
      # 
      # Transpiler Mate is licensed under
      # Creative Commons Attribution-ShareAlike 4.0 International.
      # 
      # You should have received a copy of the license along with this work.
      # If not, see <https://creativecommons.org/licenses/by-sa/4.0/>.

      from pydantic import (
        AnyUrl,
        BaseModel,
        computed_field
      )
      from typing import (
        Mapping,
        Optional,
        Sequence
      )
      
      class ScienceKeywordRecord(BaseModel):
        @computed_field
        @property
        def scheme(self) -> str:
            return 'GCMD Science Keywords'
        category: str
        topic: Optional[str] = None
        term: Optional[str] = None
        variable_level_1: Optional[str] = None
        variable_level_2: Optional[str] = None
        variable_level_3: Optional[str] = None
        detailed_variable: Optional[str] = None
        identifier: str
        @computed_field
        @property
        def uri(self) -> AnyUrl:
            return AnyUrl(f'https://cmr.earthdata.nasa.gov/kms/concept/{self.identifier}')
        @computed_field
        @property
        def hierarchy_list(self) -> Sequence[str]:
            hierarchy = [self.category]

            def _add(keyword: str | None):
                if keyword:
                    hierarchy.append(keyword)

            _add(self.topic)
            _add(self.term)
            _add(self.variable_level_1)
            _add(self.variable_level_2)
            _add(self.variable_level_3)
            _add(self.detailed_variable)

            return hierarchy

      KEYWORDS_INDEX: Mapping[str, ScienceKeywordRecord] = {" > ./src/transpiler_mate/ogc_record/sciencekeywords.py
    - |
      curl -s --location "https://gcmd.earthdata.nasa.gov/kms/concepts/concept_scheme/sciencekeywords?format=csv" \
      | tail -n +2 \
      | mlr --icsv --ojson cat \
      | jq -r --arg sq "'" '.[] |
      "  \($sq)\(.UUID)\($sq): ScienceKeywordRecord(
          category=\($sq)\(.Category)\($sq),
          topic=\($sq)\(.Topic)\($sq),
          term=\($sq)\(.Term)\($sq),
          variable_level_1=\($sq)\(.Variable_Level_1)\($sq),
          variable_level_2=\($sq)\(.Variable_Level_2)\($sq),
          variable_level_3=\($sq)\(.Variable_Level_3)\($sq),
          detailed_variable=\($sq)\(.Detailed_Variable)\($sq),
          identifier=\($sq)\(.UUID)\($sq)
        ),"' >> ./src/transpiler_mate/ogc_record/sciencekeywords.py
    - echo "}" >> ./src/transpiler_mate/ogc_record/sciencekeywords.py

  default:
    deps:
    - install_prerequisites
    cmds:
    - task: generate_jsonschema_doc
    - task: process_datacite
    - task: process_schemaorg
    - task: download_licenses_index
    - task: download_science_keywords_index
