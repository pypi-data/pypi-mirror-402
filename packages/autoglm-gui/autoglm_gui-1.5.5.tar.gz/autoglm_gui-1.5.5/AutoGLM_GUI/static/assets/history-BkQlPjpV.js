import{o as K,u as de,r,p as xe,j as e,B as h,f as m,C as E,g as he,q as me,s as ge}from"./index-CH4jPveL.js";import{T as F,L as H,C as ue,c as pe,D as je,d as fe,e as ye,f as Ne}from"./dialog-IM0Ds7Lf.js";import{S as ke,a as be,b as ve,c as we,d as R,A as z,e as B,f as V,g as q,h as I,i as J,j as U,k as X}from"./alert-dialog-BvDNaR9v.js";import{C as Y,a as G,b as De}from"./popover-BnpBfSOh.js";import{E as Se,C as Ce}from"./eye-BWBwz8sy.js";const Pe=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],Le=K("bot",Pe);const Ae=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],_e=K("user",Ae);function Fe(){const t=de(),[N,Q]=r.useState([]),[n,k]=r.useState(""),[o,x]=r.useState([]),[W,b]=r.useState(!1),[v,w]=r.useState(!1),[D,g]=r.useState(0),[S,u]=r.useState(0),[Z,p]=r.useState(!1),[ee,j]=r.useState(!1),[f,C]=r.useState(null),[se,P]=r.useState(!1),[i,te]=r.useState(null),[y,L]=r.useState(new Set),ae=20;r.useEffect(()=>{(async()=>{try{const a=await he();Q(a),a.length>0&&!n&&k(a[0].serial)}catch(a){console.error("Failed to load devices:",a)}})()},[n]);const A=r.useCallback(async(s,a=!0)=>{if(s)try{a?(b(!0),u(0)):w(!0);const l=a?0:S,c=await xe(s,ae,l);x(a?c.records:d=>[...d,...c.records]),g(c.total),u(l+c.records.length)}catch(l){console.error("Failed to load history:",l)}finally{b(!1),w(!1)}},[S]);r.useEffect(()=>{n&&A(n,!0)},[n]);const le=()=>{n&&o.length<D&&A(n,!1)},re=async()=>{if(n){try{await me(n),x([]),g(0),u(0)}catch(s){console.error("Failed to clear history:",s)}p(!1)}},ne=async()=>{if(!(!n||!f)){try{await ge(n,f),x(s=>s.filter(a=>a.id!==f)),g(s=>s-1)}catch(s){console.error("Failed to delete record:",s)}j(!1),C(null)}},_=s=>{te(s);const a=new Set;s.messages.forEach(l=>{l.step!==null&&l.step!==void 0&&a.add(l.step)}),L(a),P(!0)},ie=s=>{L(a=>{const l=new Set(a);return l.has(s)?l.delete(s):l.add(s),l})},M=s=>s<1e3?`${s}ms`:s<6e4?`${(s/1e3).toFixed(1)}s`:`${(s/6e4).toFixed(1)}min`,ce=s=>{const a=new Date(s),l=new Date,c=a.toDateString()===l.toDateString(),d=new Date(l);d.setDate(d.getDate()-1);const oe=a.toDateString()===d.toDateString(),$=a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});return c?`${t.history.today} ${$}`:oe?`${t.history.yesterday} ${$}`:a.toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},T=s=>({chat:t.historyPage.source.chat,layered:t.historyPage.source.layered,scheduled:t.historyPage.source.scheduled})[s]||s,O=s=>{switch(s){case"chat":return"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300";case"layered":return"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300";case"scheduled":return"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300";default:return"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}};return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:t.historyPage.title}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ke,{value:n,onValueChange:k,children:[e.jsx(be,{className:"w-[200px]",children:e.jsx(ve,{placeholder:t.historyPage.selectDevice})}),e.jsx(we,{children:N.length===0?e.jsx(R,{value:"_none",disabled:!0,children:t.historyPage.noDevices}):N.map(s=>e.jsx(R,{value:s.serial,children:s.model||s.serial},s.serial))})]}),o.length>0&&e.jsxs(h,{variant:"destructive",size:"sm",onClick:()=>p(!0),children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),t.historyPage.clearAll]})]})]}),W?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(H,{className:"w-8 h-8 animate-spin text-slate-400"})}):o.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:t.historyPage.noRecords}),e.jsx("p",{className:"text-sm text-slate-400 dark:text-slate-500 mt-2",children:t.historyPage.noRecordsDesc})]}):e.jsxs("div",{className:"space-y-4",children:[o.map(s=>e.jsx(ue,{className:"hover:shadow-md transition-shadow cursor-pointer",onClick:()=>_(s),children:e.jsx(pe,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 dark:text-slate-100 line-clamp-2 mb-2",children:s.task_text}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 line-clamp-2 mb-3",children:s.final_message}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[s.success?e.jsxs(m,{variant:"outline",className:"text-green-600 border-green-300 dark:text-green-400 dark:border-green-700",children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),t.historyPage.success]}):e.jsxs(m,{variant:"outline",className:"text-red-600 border-red-300 dark:text-red-400 dark:border-red-700",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),t.historyPage.failed]}),e.jsxs(m,{className:O(s.source),children:[T(s.source),s.source_detail&&`: ${s.source_detail}`]}),s.steps>0&&e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:t.historyPage.steps.replace("{count}",String(s.steps))}),e.jsxs("span",{className:"text-slate-500 dark:text-slate-400 flex items-center",children:[e.jsx(E,{className:"w-3 h-3 mr-1"}),M(s.duration_ms)]}),e.jsx("span",{className:"text-slate-400 dark:text-slate-500",children:ce(s.start_time)})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"text-slate-400 hover:text-blue-500",onClick:a=>{a.stopPropagation(),_(s)},children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"text-slate-400 hover:text-red-500",onClick:a=>{a.stopPropagation(),C(s.id),j(!0)},children:e.jsx(F,{className:"w-4 h-4"})})]})]})})},s.id)),o.length<D&&e.jsx("div",{className:"text-center py-4",children:e.jsx(h,{variant:"outline",onClick:le,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 mr-2 animate-spin"}),t.historyPage.loading]}):t.historyPage.loadMore})})]}),e.jsx(z,{open:Z,onOpenChange:p,children:e.jsxs(B,{children:[e.jsxs(V,{children:[e.jsx(q,{children:t.historyPage.clearAll}),e.jsx(I,{children:t.historyPage.clearAllConfirm})]}),e.jsxs(J,{children:[e.jsx(U,{children:t.common.cancel}),e.jsx(X,{onClick:re,children:t.common.confirm})]})]})}),e.jsx(z,{open:ee,onOpenChange:j,children:e.jsxs(B,{children:[e.jsxs(V,{children:[e.jsx(q,{children:t.common.delete}),e.jsx(I,{children:t.historyPage.deleteConfirm})]}),e.jsxs(J,{children:[e.jsx(U,{children:t.common.cancel}),e.jsx(X,{onClick:ne,children:t.common.confirm})]})]})}),e.jsx(je,{open:se,onOpenChange:P,children:e.jsxs(fe,{className:"max-w-2xl max-h-[80vh] flex flex-col overflow-hidden",children:[e.jsx(ye,{className:"flex-shrink-0",children:e.jsxs(Ne,{className:"flex items-center gap-2",children:[i?.success?e.jsx(Y,{className:"w-5 h-5 text-green-500"}):e.jsx(G,{className:"w-5 h-5 text-red-500"}),t.historyPage.detailTitle||"对话详情"]})}),i&&e.jsx("div",{className:"overflow-y-auto max-h-[calc(80vh-120px)] pr-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-slate-50 dark:bg-slate-900 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:t.historyPage.taskLabel||"任务"}),e.jsx("p",{className:"text-sm text-slate-900 dark:text-slate-100",children:i.task_text})]}),e.jsx("div",{className:"space-y-3",children:i.messages.length>0?i.messages.map((s,a)=>e.jsx("div",{className:"space-y-2",children:s.role==="user"?e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0",children:e.jsx(_e,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),e.jsx("div",{className:"flex-1 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg",children:e.jsx("p",{className:"text-sm text-slate-900 dark:text-slate-100",children:s.content})})]}):e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900 flex items-center justify-center flex-shrink-0",children:e.jsx(Le,{className:"w-4 h-4 text-emerald-600 dark:text-emerald-400"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[s.step!==null&&s.step!==void 0&&e.jsxs("button",{className:"flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200",onClick:()=>ie(s.step),children:[y.has(s.step)?e.jsx(De,{className:"w-3 h-3"}):e.jsx(Ce,{className:"w-3 h-3"}),t.historyPage.stepLabel?.replace("{step}",String(s.step))||`步骤 ${s.step}`]}),s.thinking&&(s.step===null||s.step===void 0||y.has(s.step))&&e.jsxs("div",{className:"p-3 bg-slate-100 dark:bg-slate-800 rounded-lg",children:[e.jsx("p",{className:"text-xs font-medium text-slate-500 dark:text-slate-400 mb-1",children:t.historyPage.thinkingLabel||"思考"}),e.jsx("p",{className:"text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap",children:s.thinking})]}),s.action&&(s.step===null||s.step===void 0||y.has(s.step))&&e.jsxs("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg",children:[e.jsx("p",{className:"text-xs font-medium text-amber-600 dark:text-amber-400 mb-1",children:t.historyPage.actionLabel||"动作"}),e.jsx("pre",{className:"text-xs text-slate-700 dark:text-slate-300 overflow-x-auto",children:JSON.stringify(s.action,null,2)})]})]})]})},a)):e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 text-center py-4",children:t.historyPage.noMessages||"暂无详细消息记录"})}),e.jsxs("div",{className:`p-3 rounded-lg ${i.success?"bg-green-50 dark:bg-green-900/20":"bg-red-50 dark:bg-red-900/20"}`,children:[e.jsx("p",{className:`text-xs font-medium mb-1 ${i.success?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:t.historyPage.resultLabel||"结果"}),e.jsx("p",{className:"text-sm text-slate-900 dark:text-slate-100",children:i.final_message})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs text-slate-500 dark:text-slate-400 pt-2 border-t border-slate-200 dark:border-slate-700",children:[e.jsx("span",{children:t.historyPage.steps.replace("{count}",String(i.steps))}),e.jsxs("span",{className:"flex items-center",children:[e.jsx(E,{className:"w-3 h-3 mr-1"}),M(i.duration_ms)]}),e.jsx(m,{className:O(i.source),children:T(i.source)})]})]})})]})})]})}export{Fe as component};
