#!/usr/bin/python3
###########################################################################################
#  package:   pNbody
#  file:      plotCylindricalProfile
#  brief:     
#  copyright: GPLv3
#             Copyright (C) 2019 EPFL (Ecole Polytechnique Federale de Lausanne)
#             LASTRO - Laboratory of Astrophysics of EPFL
#  author:    Yves Revaz <yves.revaz@epfl.ch>
#
# This file is part of Gtools.
###########################################################################################

import os
import numpy as np
import argparse

import matplotlib.pyplot as plt
from pNbody import Nbody
from pNbody import plot

####################################################################
# option parser
####################################################################

description="""plot the star formation rate as a function of time"""
epilog     ="""
Examples:
--------
# Star formation rate
plotSFRvsTime                   snapshot.hdf5
plotSFRvsTime  --xmax 2         snapshot.hdf5
plotSFRvsTime  --xmax 2 --nx 50 snapshot.hdf5

# Cumulative stellar mass
plotSFRvsTime  --y M                 snapshot.hdf5
plotSFRvsTime  --y M --xmax 2         snapshot.hdf5
plotSFRvsTime  --y M --xmax 2 --nx 50 snapshot.hdf5

"""

parser = argparse.ArgumentParser(description=description,epilog=epilog,formatter_class=argparse.RawDescriptionHelpFormatter)

plot.add_files_options(parser)
plot.add_arguments_units(parser)
plot.add_arguments_reduc(parser)
plot.add_arguments_center(parser)
plot.add_arguments_select(parser)
plot.add_arguments_info(parser)
plot.add_comoving_options(parser)
plot.add_arguments_legend(parser)
plot.add_arguments_icshift(parser)
plot.add_arguments_cmd(parser)


parser.add_argument(action="store", 
                    dest="files", 
                    metavar='FILE', 
                    type=str,
                    default=None,
                    nargs='*',
                    help='a list of files')                     


parser.add_argument("-o",
                    action="store",
                    type=str,
                    dest="outputfilename",
                    default=None,
                    help="Name of the output file")  



parser.add_argument('--xmin',
                    action="store", 
                    dest="xmin", 
                    metavar='FLOAT', 
                    type=float,
                    default=0,
                    help='x min')

parser.add_argument('--xmax',
                    action="store", 
                    dest="xmax", 
                    metavar='FLOAT', 
                    type=float,
                    default=14,
                    help='x max')


parser.add_argument('--nx',
                    action="store", 
                    dest="nx", 
                    metavar='INT', 
                    type=int,
                    default=500,
                    help='x discretisation')

parser.add_argument('--ymin',
                    action="store", 
                    dest="ymin", 
                    metavar='FLOAT', 
                    type=float,
                    default=None,
                    help='y min')

parser.add_argument('--ymax',
                    action="store", 
                    dest="ymax", 
                    metavar='FLOAT', 
                    type=float,
                    default=None,
                    help='y max')

                                        
parser.add_argument('--log',
                    action="store", 
                    dest="log", 
                    metavar='STR', 
                    type=str,
                    default=None,
                    help='log scale (None,x,y,xy)')


parser.add_argument('-y','--y',
                    action="store", 
                    dest="y", 
                    metavar='STR', 
                    type=str,
                    default='SFR',
                    help='quantity to plot in the y axis (SFR, M)')

parser.add_argument("--colormap",
                    action="store", 
                    default='jet',
                    help='matplotlib colormap name (e.g. mycmap, tab20c, Greys, jet, binary)') 



#######################################
# MakePlot
#######################################


def MakePlot(opt):
  
  params = {
    "axes.labelsize": 14,
    "axes.titlesize": 18,
    "font.size": 12,
    "legend.fontsize": 12,
    "xtick.labelsize": 14,
    "ytick.labelsize": 14,
    "text.usetex": True,
    "figure.subplot.left": 0.15,
    "figure.subplot.right": 0.95,
    "figure.subplot.bottom": 0.15,
    "figure.subplot.top": 0.95,
    "figure.subplot.wspace": 0.02,
    "figure.subplot.hspace": 0.02,
    "figure.figsize" : (8, 6),
    "lines.markersize": 6,
    "lines.linewidth": 2.0,
  }
  plt.rcParams.update(params)
  
  
  # create the plot
  fig = plt.gcf()
  fig.set_size_inches(8,6)
  ax  = plt.gca()


  # get a list of color
  colors = plot.ColorList(n=len(opt.files),colormap=opt.colormap)
  
  # list of points
  datas = []
  
  
  #################################
  # loop over files
  
  for filename in opt.files:
    
    nb = Nbody(filename, ftype=opt.ftype)

    # base name
    bname = os.path.basename(filename)
    
    ################
    # keep only stars
    ################

    nb = nb.select("stars")
    
    ################
    # units
    ################
    
    # define local units
    unit_params = plot.apply_arguments_units(opt)
    nb.set_local_system_of_units(params=unit_params)
    
    ################
    # apply options
    ################
    nb = plot.apply_arguments_icshift(nb, opt)
    nb = plot.apply_arguments_comoving(nb, opt)
    nb = plot.apply_arguments_reduc(nb, opt)
    nb = plot.apply_arguments_select(nb, opt)
    nb = plot.apply_arguments_center(nb, opt)
    nb = plot.apply_arguments_cmd(nb, opt)
    nb = plot.apply_arguments_info(nb, opt)
    nb = plot.apply_arguments_display(nb, opt)


    ################
    # some info
    ################
    print("---------------------------------------------------------")
    nb.localsystem_of_units.info()
    nb.ComovingIntegrationInfo()
    print("---------------------------------------------------------")


    if opt.y == "SFR":
      x,y =  nb.StarFormationvsTime(tmin=opt.xmin,tmax=opt.xmax,nt=opt.nx,unitsTime="Gyr",unitsMass="Msol")
      datas.append(plot.DataPoints(x,y,color=colors.get(),label=bname,tpe='points'))
      xlabel = r'$\rm{Time}\,\left[ Gyr \right]$'
      ylabel = r'$\rm{Sfr}\,\left[ M_\odot/yr \right]$'
    else:
      x,y =  nb.StellarMassvsTime(tmin=opt.xmin,tmax=opt.xmax,nt=opt.nx,unitsTime="Gyr",unitsMass="Msol")
      datas.append(plot.DataPoints(x,y,color=colors.get(),label=bname,tpe='points'))
      xlabel = r'$\rm{Time}\,\left[ Gyr \right]$'
      ylabel = r'$\rm{Cumulative\,\,Stellar\,\,Mass}\,\left[ M_\odot\right]$'
      
      
      
  ##################
  # plot all
  ##################

  for d in datas:
    ax.plot(d.x, d.y, color=d.color)

  # set limits
  xmin, xmax, ymin, ymax, log = plot.SetLimitsFromDataPoints(datas, opt.xmin, opt.xmax, opt.ymin, opt.ymax, opt.log)

  # set the axis (the extention is done in the previous command)
  plot.SetAxis(ax,xmin,xmax,ymin,ymax,log,extend=False)
  
  # labels
  ax.set_xlabel(xlabel)
  ax.set_ylabel(ylabel)
  
  # legend
  if opt.legend:
    plot.LegendFromDataPoints(ax, datas, opt.legend_loc)



  # save or display
  if opt.outputfilename:
    plt.savefig(opt.outputfilename)
  else:
    plt.show()    
      


#################################
# main
#################################

if __name__ == '__main__':  
  
  opt = parser.parse_args()
  MakePlot(opt)
