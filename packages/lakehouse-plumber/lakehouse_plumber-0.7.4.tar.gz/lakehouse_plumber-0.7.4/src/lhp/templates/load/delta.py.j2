@dp.temporary_view()
def {{ target }}():
    """{{ description }}"""
    {% if readMode == "stream" %}
    df = spark.readStream{% if reader_options %}{% for key, value in reader_options.items() %} \
        .option("{{ key }}", {% if value is boolean %}{{ value|string|title }}{% elif value is number %}{{ value }}{% else %}"{{ value|replace('\\', '\\\\')|replace('"', '\\"') }}"{% endif %}){% endfor %}{% endif %}.table("{{ table_ref }}")
    {% else %}
    df = spark.read{% if reader_options %}{% for key, value in reader_options.items() %} \
        .option("{{ key }}", {% if value is boolean %}{{ value|string|title }}{% elif value is number %}{{ value }}{% else %}"{{ value|replace('\\', '\\\\')|replace('"', '\\"') }}"{% endif %}){% endfor %}{% endif %}.table("{{ table_ref }}")
    {% endif %}
    {% if where_clauses %}
    {% for clause in where_clauses %}
    df = df.where("{{ clause }}")
    {% endfor %}
    {% endif %}
    {% if select_columns %}
    
    # Apply column selection
    df = df.select({{ select_columns | tojson }})
    {% endif %}
    {% if add_operational_metadata %}
    
    # Add operational metadata columns
    {% for col_name, expression in metadata_columns.items()|sort %}
    df = df.withColumn('{{ col_name }}', {{ expression }})
    {% endfor %}
    {% endif %}
    
    return df 