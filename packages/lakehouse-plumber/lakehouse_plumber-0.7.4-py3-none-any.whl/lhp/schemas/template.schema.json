{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "LakehousePlumber Template",
    "description": "Schema for LakehousePlumber template files",
    "type": "object",
    "required": ["name"],
    "properties": {
        "name": {
            "type": "string",
            "description": "Name of the template"
        },
        "version": {
            "type": "string",
            "default": "1.0",
            "description": "Version of the template"
        },
        "description": {
            "type": "string",
            "description": "Description of the template"
        },
        "presets": {
            "type": "array",
            "description": "List of preset names to apply to template actions",
            "items": {
                "type": "string"
            },
            "default": []
        },
        "parameters": {
            "type": "array",
            "description": "Template parameters",
            "items": {
                "type": "object",
                "required": ["name"],
                "properties": {
                    "name": {
                        "type": "string",
                        "description": "Parameter name"
                    },
                    "type": {
                        "type": "string",
                        "enum": ["string", "number", "boolean", "array", "object"],
                        "default": "string",
                        "description": "Parameter type"
                    },
                    "required": {
                        "type": "boolean",
                        "default": false,
                        "description": "Whether this parameter is required"
                    },
                    "description": {
                        "type": "string",
                        "description": "Parameter description"
                    },
                    "default": {
                        "description": "Default value for the parameter"
                    }
                }
            },
            "default": []
        },
        "actions": {
            "type": "array",
            "description": "List of actions in the template",
            "items": {
                "$ref": "#/definitions/Action"
            },
            "default": []
        }
    },
    "definitions": {
        "Action": {
            "type": "object",
            "required": ["name", "type"],
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Name of the action (can use template parameters with {{ }})"
                },
                "type": {
                    "type": "string",
                    "enum": ["load", "transform", "write"],
                    "description": "Type of action"
                },
                "source": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "array",
                            "items": {
                                "oneOf": [
                                    {
                                        "type": "string"
                                    },
                                    {
                                        "type": "object"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "object",
                            "properties": {
                                "type": {
                                    "type": "string",
                                    "enum": ["cloudfiles", "delta", "sql", "python", "jdbc", "custom_datasource", "kafka"]
                                },
                                "path": {
                                    "type": "string",
                                    "description": "Path to data files (can use template parameters with {{ }})"
                                },
                                "format": {
                                    "type": "string",
                                    "enum": ["json", "parquet", "csv", "avro", "orc", "text", "binaryfile", "xml"],
                                    "description": "File format"
                                },
                                "database": {
                                    "type": "string",
                                    "description": "Database name (can use template parameters with {{ }})"
                                },
                                "table": {
                                    "type": "string",
                                    "description": "Table name (can use template parameters with {{ }})"
                                },
                                "catalog": {
                                    "type": "string",
                                    "description": "Catalog name (can use template parameters with {{ }})"
                                },
                                "sql": {
                                    "type": "string",
                                    "description": "SQL query (can use template parameters with {{ }})"
                                },
                                "sql_path": {
                                    "type": "string",
                                    "description": "Path to SQL file (can use template parameters with {{ }})"
                                },
                                "url": {
                                    "type": "string",
                                    "description": "JDBC URL (can use template parameters with {{ }})"
                                },
                                "user": {
                                    "type": "string",
                                    "description": "Database user (can use template parameters with {{ }})"
                                },
                                "password": {
                                    "type": "string",
                                    "description": "Database password (can use template parameters with {{ }})"
                                },
                                "driver": {
                                    "type": "string",
                                    "description": "JDBC driver (can use template parameters with {{ }})"
                                },
                                "query": {
                                    "type": "string",
                                    "description": "SQL query for JDBC (can use template parameters with {{ }})"
                                },
                                "module_path": {
                                    "type": "string",
                                    "description": "Python module path (can use template parameters with {{ }})"
                                },
                                "function_name": {
                                    "type": "string",
                                    "description": "Python function name (can use template parameters with {{ }})"
                                },
                                "parameters": {
                                    "oneOf": [
                                        {
                                            "type": "object",
                                            "additionalProperties": true
                                        },
                                        {"type": "string"}
                                    ],
                                    "description": "Parameters for Python source (can use template parameters with {{ }})"
                                },
                                "options": {
                                    "oneOf": [
                                        {
                                            "type": "object",
                                            "additionalProperties": true
                                        },
                                        {"type": "string"}
                                    ],
                                    "description": "Reader options (can use template parameters with {{ }})"
                                },
                                "format_options": {
                                    "type": "object",
                                    "description": "Format-specific options (can use template parameters with {{ }})",
                                    "additionalProperties": true
                                },
                                "schema": {
                                    "type": "string",
                                    "description": "Schema definition as string (DDL, path, or template parameter with {{ }}). Note: For schema transforms, use 'schema_inline' or 'schema_file' at action level instead."
                                },
                                "schema_file": {
                                    "type": "string",
                                    "description": "Path to schema file for schema transforms (recommended) (can use template parameters with {{ }})"
                                },
                                "readMode": {
                                    "type": "string",
                                    "enum": ["batch", "stream"],
                                    "description": "Read mode"
                                },
                                "schema_location": {
                                    "type": "string",
                                    "description": "Schema location (can use template parameters with {{ }})"
                                },
                                "schema_infer_column_types": {
                                    "oneOf": [
                                        {"type": "boolean"},
                                        {"type": "string"}
                                    ],
                                    "description": "Whether to infer column types (can use template parameters with {{ }})"
                                },
                                "max_files_per_trigger": {
                                    "type": "string",
                                    "description": "Maximum files per trigger (can use template parameters with {{ }})"
                                },
                                "schema_evolution_mode": {
                                    "type": "string",
                                    "enum": ["addNewColumns", "rescue", "failOnNewColumns"],
                                    "description": "Schema evolution mode"
                                },
                                "rescue_data_column": {
                                    "type": "string",
                                    "description": "Column for rescued data (can use template parameters with {{ }})"
                                },
                                "where_clause": {
                                    "type": "string",
                                    "description": "WHERE clause for filtering (can use template parameters with {{ }})"
                                },
                                "select_columns": {
                                    "oneOf": [
                                        {
                                            "type": "array",
                                            "items": {"type": "string"}
                                        },
                                        {"type": "string"}
                                    ],
                                    "description": "Columns to select (can use template parameters with {{ }})"
                                }
                            }
                        }
                    ],
                    "description": "Source configuration for the action (can use template parameters with {{ }})"
                },
                "target": {
                    "type": "string",
                    "description": "Target view or table name (can use template parameters with {{ }})"
                },
                "description": {
                    "type": "string",
                    "description": "Description of the action (can use template parameters with {{ }})"
                },
                "readMode": {
                    "type": "string",
                    "enum": ["batch", "stream"],
                    "description": "Read mode: 'batch' or 'stream'"
                },
                "write_target": {
                    "$ref": "#/definitions/WriteTarget",
                    "description": "Write target configuration"
                },
                "transform_type": {
                    "type": "string",
                    "enum": ["sql", "python", "data_quality", "temp_table", "schema"],
                    "description": "Type of transformation"
                },
                "sql": {
                    "type": "string",
                    "description": "SQL query for the action (can use template parameters with {{ }})"
                },
                "sql_path": {
                    "type": "string",
                    "description": "Path to SQL file (can use template parameters with {{ }})"
                },
                "operational_metadata": {
                    "oneOf": [
                        {"type": "boolean"},
                        {
                            "type": "array",
                            "items": {"type": "string"}
                        },
                        {"type": "string"}
                    ],
                    "description": "Operational metadata configuration (can use template parameters with {{ }} - use true/false for boolean or array for column list)"
                },
                "expectations_file": {
                    "type": "string",
                    "description": "Path to expectations file for data quality transforms (can use template parameters with {{ }})"
                },
                "schema_inline": {
                    "type": "string",
                    "description": "Inline schema definition for schema transforms (arrow or YAML format, can use template parameters with {{ }})"
                },
                "schema_file": {
                    "type": "string",
                    "description": "Path to external schema file for schema transforms (can use template parameters with {{ }})"
                },
                "enforcement": {
                    "type": "string",
                    "description": "Schema enforcement mode for schema transforms: 'strict' or 'permissive' (can use template parameters with {{ }}). Default: permissive"
                },
                "once": {
                    "oneOf": [
                        {"type": "boolean"},
                        {"type": "string"}
                    ],
                    "description": "Whether this is a one-time flow/backfill (can use template parameters with {{ }})"
                },
                "module_path": {
                    "type": "string",
                    "description": "Path to Python module for Python transforms (can use template parameters with {{ }})"
                },
                "function_name": {
                    "type": "string",
                    "description": "Function name for Python transforms (can use template parameters with {{ }})"
                },
                "parameters": {
                    "oneOf": [
                        {
                            "type": "object",
                            "additionalProperties": true
                        },
                        {"type": "string"}
                    ],
                    "description": "Parameters for Python transforms (can use template parameters with {{ }})"
                },
                "custom_datasource_class": {
                    "type": "string",
                    "description": "Name of the custom DataSource class for custom_datasource load actions (can use template parameters with {{ }})"
                },
                "schema_file": {
                    "type": "string",
                    "description": "Path to schema file for schema transforms (can use template parameters with {{ }})"
                }
            }
        },
        "WriteTarget": {
            "type": "object",
            "required": ["type"],
            "properties": {
                "type": {
                    "type": "string",
                    "enum": ["streaming_table", "materialized_view", "sink"],
                    "description": "Type of write target"
                },
                "database": {
                    "type": "string",
                    "description": "Target database name (can use template parameters with {{ }})"
                },
                "table": {
                    "type": "string",
                    "description": "Target table name (can use template parameters with {{ }})"
                },
                "create_table": {
                    "oneOf": [
                        {"type": "boolean"},
                        {"type": "string"}
                    ],
                    "description": "Whether to create the table (can use template parameters with {{ }})"
                },
                "comment": {
                    "type": "string",
                    "description": "Table comment (can use template parameters with {{ }})"
                },
                "table_properties": {
                    "oneOf": [
                        {
                            "type": "object",
                            "additionalProperties": true
                        },
                        {"type": "string"}
                    ],
                    "description": "Delta table properties (can use template parameters with {{ }})"
                },
                "partition_columns": {
                    "oneOf": [
                        {
                            "type": "array",
                            "items": {"type": "string"}
                        },
                        {"type": "string"}
                    ],
                    "description": "Partition columns (can use template parameters with {{ }})"
                },
                "cluster_columns": {
                    "oneOf": [
                        {
                            "type": "array",
                            "items": {"type": "string"}
                        },
                        {"type": "string"}
                    ],
                    "description": "Cluster columns (can use template parameters with {{ }})"
                },
                "spark_conf": {
                    "oneOf": [
                        {
                            "type": "object",
                            "additionalProperties": true
                        },
                        {"type": "string"}
                    ],
                    "description": "Spark configuration (can use template parameters with {{ }})"
                },
                "schema": {
                    "type": "string",
                    "description": "Table schema (legacy, use 'table_schema' instead. Can use template parameters with {{ }})"
                },
                "table_schema": {
                    "type": "string",
                    "description": "Table schema definition (DDL string or external file path. Can use template parameters with {{ }})"
                },
                "row_filter": {
                    "type": "string",
                    "description": "Row filter expression"
                },
                "temporary": {
                    "oneOf": [
                        {"type": "boolean"},
                        {"type": "string"}
                    ],
                    "description": "Whether the table is temporary (can use template parameters with {{ }})"
                },
                "path": {
                    "type": "string",
                    "description": "Table path (can use template parameters with {{ }})"
                },
                "refresh_schedule": {
                    "type": "string",
                    "description": "Refresh schedule for materialized views"
                },
                "sql": {
                    "type": "string",
                    "description": "SQL query for materialized views (can use template parameters with {{ }})"
                },
                "sink_type": {
                    "type": "string",
                    "enum": ["delta", "kafka", "custom"],
                    "description": "Type of sink (delta, kafka, custom)"
                },
                "sink_name": {
                    "type": "string",
                    "description": "Name of the sink (can use template parameters with {{ }})"
                },
                "bootstrap_servers": {
                    "type": "string",
                    "description": "Kafka bootstrap servers (for Kafka/Event Hubs sinks) (can use template parameters with {{ }})"
                },
                "topic": {
                    "type": "string",
                    "description": "Kafka topic (for Kafka/Event Hubs sinks) (can use template parameters with {{ }})"
                },
                "module_path": {
                    "type": "string",
                    "description": "Path to custom sink module (for custom sinks) (can use template parameters with {{ }})"
                },
                "custom_sink_class": {
                    "type": "string",
                    "description": "Custom sink class name (for custom sinks) (can use template parameters with {{ }})"
                },
                "options": {
                    "type": "object",
                    "additionalProperties": true,
                    "description": "Sink-specific options. For delta sinks: must contain either 'tableName' OR 'path' (not both). For kafka sinks: can include kafka.* prefixed options. Additional options pass through for forward compatibility. (can use template parameters with {{ }})"
                },
                "mode": {
                    "type": "string",
                    "enum": ["cdc", "snapshot_cdc"],
                    "description": "Table mode for CDC operations"
                },
                "cdc_config": {
                    "oneOf": [
                        {
                            "type": "object",
                            "additionalProperties": true
                        },
                        {"type": "string"}
                    ],
                    "description": "CDC configuration for change data capture (can use template parameters with {{ }})"
                },
                "snapshot_cdc_config": {
                    "oneOf": [
                        {
                            "type": "object",
                            "additionalProperties": true
                        },
                        {"type": "string"}
                    ],
                    "description": "Snapshot CDC configuration (can use template parameters with {{ }})"
                }
            }
        }
    }
} 