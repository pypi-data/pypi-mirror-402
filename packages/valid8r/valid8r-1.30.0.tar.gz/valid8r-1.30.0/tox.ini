[tox]
isolated_build = True
envlist = py311, py312, py313, py314

[testenv]
deps =
    pytest
    pytest-asyncio
    behave
    click>=8.1.0,<8.2.0
    coverage
    pytest-cov
    pytest-mock
    pytest-sugar
    typer>=0.20.0
    pytest-benchmark
    marshmallow
    cerberus
    pyyaml
    fastapi
    httpx
setenv =
    PYTHONPATH = {toxinidir}
commands =
    # Install package in development mode so tests use the actual source
    pip install -e .
    # Run unit tests with pytest (excluding benchmarks by default)
    pytest tests/unit tests/bdd {posargs} --cov=valid8r --cov-report=term
    # Run BDD tests with behave
    behave tests/bdd/features

[testenv:lint]
deps =
    ruff
    isort
    mypy
commands =
    ruff check .
    ruff format .
    isort --check-only valid8r tests
    mypy valid8r

[testenv:docs]
deps =
    sphinx
    sphinx-rtd-theme
    sphinx-autodoc-typehints
    sphinx-copybutton
    sphinx-autoapi
    myst-parser
    linkify-it-py
commands =
    sphinx-build -b html docs docs/_build/html

[testenv:coverage]
description = Run all tests with combined coverage from pytest and behave
deps =
    pytest
    pytest-asyncio
    behave
    click>=8.1.0,<8.2.0
    coverage
    pytest-cov
    pytest-mock
    typer>=0.20.0
    pyyaml
    fastapi
    httpx
commands =
    pip install -e .
    # Clean up any previous coverage data
    coverage erase
    # Run BDD tests (creates .coverage.bdd via environment.py)
    behave tests/bdd/features
    # Run unit tests with pytest using coverage directly (creates .coverage.pytest)
    coverage run --data-file=.coverage.pytest -m pytest tests/unit
    # Combine all coverage data files
    coverage combine .coverage.bdd .coverage.pytest
    # Generate reports
    coverage report -m
    coverage html
    coverage xml

[testenv:bdd]
description = Run BDD tests with behave (includes coverage collection)
deps =
    behave
    click>=8.1.0,<8.2.0
    coverage
    pytest
    typer>=0.20.0
    pyyaml
    fastapi
    httpx
commands =
    pip install -e .
    # BDD tests collect coverage via environment.py hooks
    behave tests/bdd/features
    # Show BDD-only coverage report
    coverage report -m --data-file=.coverage.bdd

[testenv:doctests]
description = Run doctests in code and documentation
deps =
    pytest
commands =
    pip install -e .
    pytest --doctest-modules valid8r/core/parsers.py

[testenv:benchmarks]
description = Run performance benchmarks
deps =
    pytest
    pytest-benchmark
    marshmallow
    cerberus
commands =
    pip install -e .
    # Run benchmark correctness tests first
    pytest tests/benchmarks/test_benchmark_correctness.py -v
    # Then run performance benchmarks
    pytest tests/benchmarks/test_benchmarks.py --benchmark-only --benchmark-sort=name

[testenv:security]
description = Run security tests and ReDoS detection
deps =
    pytest
    pytest-cov
    regexploit
commands =
    pip install -e .
    # Run security tests (including ReDoS protection tests)
    pytest tests/security/ -v --cov=scripts/check_regex_safety --cov-report=term
    # Run ReDoS scanner on the entire codebase
    python scripts/check_regex_safety.py valid8r/
