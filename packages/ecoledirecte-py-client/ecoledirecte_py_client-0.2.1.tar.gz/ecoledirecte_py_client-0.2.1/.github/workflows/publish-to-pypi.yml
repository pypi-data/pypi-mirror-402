name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Validate version matches release tag
        run: |
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          RELEASE_VERSION=${RELEASE_TAG#v}
          
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          echo "Release tag: $RELEASE_TAG"
          echo "Release version: $RELEASE_VERSION"
          
          if [ "$PYPROJECT_VERSION" != "$RELEASE_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "pyproject.toml has version $PYPROJECT_VERSION"
            echo "but release tag is $RELEASE_TAG"
            echo "Please update pyproject.toml version to match the release tag"
            exit 1
          fi
          
          echo "âœ“ Version validation passed"
      
      - name: Build package
        run: uv build
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
