name: CI/CD

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]

jobs:
  # Build and test SDK
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Lint (Ruff)
        run: uv run ruff check .

      - name: Type check (mypy)
        run: uv run mypy src/scp_sdk

      - name: Run tests
        run: uv run pytest -v --cov=scp_sdk --cov-report=term-missing

      - name: Sync Project Version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF_NAME#v}
            echo "Type: Tagged Release"
          else
            LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
            if [ -z "$LAST_TAG" ]; then
              VERSION="0.0.0-dev"
              echo "Type: Dev Build (No tags found)"
            else
              VERSION="${LAST_TAG#v}-dev"
              echo "Type: Dev Build (Last tag: $LAST_TAG)"
            fi
          fi

          echo "Syncing pyproject.toml to version: $VERSION"
          uv version "$VERSION"
          uv version

      - name: Build package
        run: uv build

      - name: Upload Build Artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: scp-sdk-dist
          path: dist/*
          retention-days: 1

  # Publish SDK to PyPI on tag
  publish:
    name: Publish to PyPI
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: scp-sdk-dist
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
