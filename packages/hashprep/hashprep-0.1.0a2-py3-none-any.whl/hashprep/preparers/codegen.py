from typing import List, Dict
from ..checks.core import Issue

class CodeGenerator:
    def __init__(self, issues: List[Dict]):
        self.issues = issues

    def generate_pandas_script(self) -> str:
        code = ["import pandas as pd", "import numpy as np", ""]
        code.append("# Automated fixes generated by HashPrep")
        code.append("def apply_fixes(df):")
        code.append("    df = df.copy()")
        
        for issue_dict in self.issues:
            issue = issue_dict["issue"]
            snippet = issue_dict["code"]
            if snippet:
                # Indent snippet
                indented = "\n".join([f"    {line}" for line in snippet.split("\n")])
                code.append(f"    # Fix for {issue.category} in {issue.column}")
                code.append(indented)
        
        code.append("    return df")
        return "\n".join(code)

    def generate_sklearn_pipeline(self) -> str:
        # This is more complex as it requires mapping columns to transformers
        code = [
            "from sklearn.pipeline import Pipeline",
            "from sklearn.compose import ColumnTransformer",
            "from sklearn.impute import SimpleImputer",
            "from sklearn.preprocessing import StandardScaler, OneHotEncoder",
            "",
            "# Example Pipeline structure based on issues",
            "numeric_features = []",
            "categorical_features = []",
            "drop_features = []",
            ""
        ]
        
        dropped_cols = []
        for issue_dict in self.issues:
            issue = issue_dict["issue"]
            if issue.category in ["high_missing_values", "empty_column", "single_value_columns"]:
                dropped_cols.append(issue.column)
        
        if dropped_cols:
            code.append(f"drop_features = {dropped_cols}")
            
        code.append("preprocessor = ColumnTransformer(")
        code.append("    transformers=[")
        code.append("        ('drop', 'drop', drop_features),")
        code.append("        # Add other transformations here")
        code.append("    ],")
        code.append("    remainder='passthrough'")
        code.append(")")
        code.append("")
        code.append("pipeline = Pipeline(steps=[('preprocessor', preprocessor)])")
        
        return "\n".join(code)
