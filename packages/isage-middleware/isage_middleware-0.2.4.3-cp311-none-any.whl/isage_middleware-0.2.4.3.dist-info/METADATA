Metadata-Version: 2.1
Name: isage-middleware
Version: 0.2.4.3
Summary: SAGE Middleware - Streaming-Augmented Generative Execution
Author-email: IntelliStream Team <shuhao_zhang@hust.edu.cn>
License: MIT
Project-URL: Homepage, https://github.com/intellistream/SAGE
Project-URL: Repository, https://github.com/intellistream/SAGE.git
Project-URL: Documentation, https://intellistream.github.io/SAGE-Pub/
Project-URL: Issues, https://github.com/intellistream/SAGE/issues
Keywords: data,api,reasoning,dataflow,llm,ml,middleware,framework,rag,intellistream,ai,sage
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: Intended Audience :: Science/Research
Classifier: Operating System :: OS Independent
Classifier: Topic :: Scientific/Engineering :: Artificial Intelligence
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Topic :: System :: Distributed Computing
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: openai<1.91.0,>=1.52.0
Requires-Dist: httpx<1.0.0,>=0.28.0
Requires-Dist: aiohttp<4.0.0,>=3.12.0
Requires-Dist: beautifulsoup4<5.0.0,>=4.12.0
Requires-Dist: feedparser<7.0.0,>=6.0.11
Requires-Dist: json-repair<1.0.0,>=0.30.0
Requires-Dist: bm25s<1.0.0,>=0.2.13
Requires-Dist: rank-bm25<1.0.0,>=0.2.0
Requires-Dist: PyStemmer<4.0.0,>=3.0.0
Provides-Extra: all
Requires-Dist: isage-middleware[auth,compression,libs,llm-providers,ml,neuromem,queue,streaming,vdb]; extra == "all"
Provides-Extra: auth
Requires-Dist: python-jose[cryptography]<4.0.0,>=3.5.0; extra == "auth"
Requires-Dist: passlib[argon2]<2.0.0,>=1.7.4; extra == "auth"
Provides-Extra: compression
Requires-Dist: llmlingua<1.0.0,>=0.2.0; extra == "compression"
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: ruff==0.14.6; extra == "dev"
Requires-Dist: mypy>=1.7.0; extra == "dev"
Requires-Dist: pybind11>=2.10.0; extra == "dev"
Provides-Extra: libs
Requires-Dist: isage-libs; extra == "libs"
Requires-Dist: isage-agentic>=0.1.0.0; extra == "libs"
Requires-Dist: isage-eval>=0.1.0.0; extra == "libs"
Requires-Dist: isage-finetune>=0.1.0.0; extra == "libs"
Requires-Dist: isage-privacy>=0.1.0.0; extra == "libs"
Requires-Dist: isage-rag>=0.1.0.0; extra == "libs"
Requires-Dist: isage-safety>=0.1.0.0; extra == "libs"
Requires-Dist: isage-refiner>=0.1.0.0; extra == "libs"
Provides-Extra: llm-providers
Requires-Dist: ollama<1.0.0,>=0.5.0; extra == "llm-providers"
Requires-Dist: zhipuai<3.0.0,>=2.1.0; extra == "llm-providers"
Requires-Dist: cohere<6.0.0,>=5.16.0; extra == "llm-providers"
Requires-Dist: anthropic<1.0.0,>=0.25.0; extra == "llm-providers"
Provides-Extra: ml
Requires-Dist: transformers<4.54.0,>=4.52.0; extra == "ml"
Requires-Dist: tokenizers<0.24.0,>=0.21.0; extra == "ml"
Requires-Dist: sentence-transformers<4.0.0,>=3.1.0; extra == "ml"
Requires-Dist: InstructorEmbedding<2.0.0,>=1.0.0; extra == "ml"
Requires-Dist: accelerate<2.0.0,>=1.9.0; extra == "ml"
Requires-Dist: huggingface-hub<1.0.0,>=0.34.0; extra == "ml"
Requires-Dist: peft<1.0.0,>=0.18.0; extra == "ml"
Requires-Dist: scipy<2.0.0,>=1.15.0; extra == "ml"
Provides-Extra: neuromem
Requires-Dist: isage-neuromem>=0.2.1.1; extra == "neuromem"
Provides-Extra: queue
Requires-Dist: celery<6.0.0,>=5.5.0; extra == "queue"
Requires-Dist: flower<3.0.0,>=2.0.0; extra == "queue"
Provides-Extra: streaming
Requires-Dist: isage-flow>=0.1.1; extra == "streaming"
Requires-Dist: isage-tsdb>=0.1.5; extra == "streaming"
Provides-Extra: vdb
Requires-Dist: isage-vdb>=0.1.5; extra == "vdb"
Requires-Dist: faiss-cpu<2.0.0,>=1.7.0; extra == "vdb"

# SAGE Middlewareï¼ˆä¸­é—´ä»¶ï¼‰

## ğŸ“‹ Overview

ç”¨äºæ„å»ºå¸¦æœ‰ AI èƒ½åŠ›çš„æµå¼æ•°æ®åº”ç”¨çš„ä¸­é—´ä»¶å±‚ï¼Œé›†æˆäº†å¤šå®¶å¤§æ¨¡å‹æä¾›å•†ã€å¼‚æ­¥ä»»åŠ¡ã€é‰´æƒä»¥åŠé«˜æ€§èƒ½çš„æ•°æ®å¤„ç†ç»„ä»¶ã€‚

## ğŸ§­ Governance / å›¢é˜Ÿåä½œåˆ¶åº¦

- `docs/governance/TEAM.md`
- `docs/governance/MAINTAINERS.md`
- `docs/governance/DEVELOPER_GUIDE.md`
- `docs/governance/PR_CHECKLIST.md`
- `docs/governance/SELF_HOSTED_RUNNER.md`
- `docs/governance/TODO.md`

## âœ¨ Key Features

- ğŸ¤– **LLM æ¨ç†**ï¼š
  - **sageLLM** âœ… æ¨èï¼šç»Ÿä¸€ LLM æ¨ç†å¼•æ“ï¼Œæ”¯æŒ CUDA/Ascend/Mock åç«¯
  - vLLM âš ï¸ å·²å¼ƒç”¨ï¼šå°†åœ¨ v0.4.0 ç§»é™¤ï¼Œè¯·è¿ç§»è‡³ sageLLM
- ğŸ” æ£€ç´¢ä¸å‘é‡ï¼šRAGã€BM25ã€FAISS ç­‰
- ğŸ“‹ ä»»åŠ¡è°ƒåº¦ï¼šCelery å¼‚æ­¥ä»»åŠ¡
- ğŸ” å®‰å…¨é‰´æƒï¼šJWTã€å¯†ç å­¦å·¥å…·
- âš™ï¸ æ ¸å¿ƒç»„ä»¶ï¼š
  - `sage_db`ï¼šæ•°æ®åº“/å‘é‡å­˜å‚¨ç›¸å…³ç»„ä»¶ï¼ˆå« C/C++ æ‰©å±•ï¼‰
  - `sage_flow`ï¼šé«˜æ€§èƒ½å‘é‡æµå¤„ç†ï¼ˆå¯èƒ½åŒ…å«æ‰©å±•æˆ–ç‹¬ç«‹å­æ¨¡å—ï¼‰

## ğŸš€ Installation

```bash
pip install isage-middleware

# å¯é€‰ï¼šVLLM æ”¯æŒï¼ˆéœ€è¦ CUDAï¼‰
pip install isage-common[vllm]

# å¯é€‰ï¼šä¸å®Œæ•´ SAGE æ¡†æ¶é›†æˆ
pip install isage-middleware[sage]
```

## ğŸ“– Quick Start

### LLM æ¨ç†ï¼ˆæ¨èï¼šsageLLMï¼‰

```python
from sage.middleware.operators.llm import SageLLMGenerator

# è‡ªåŠ¨é€‰æ‹©æœ€ä½³åç«¯
generator = SageLLMGenerator(
    model_path="Qwen/Qwen2.5-7B-Instruct",
    backend_type="auto",  # auto/cuda/ascend/mock
    temperature=0.7,
    max_tokens=2048,
)

result = generator.execute("ä½ å¥½ï¼Œä¸–ç•Œï¼")
print(result)
```

### API å®¢æˆ·ç«¯

```python
from sage.middleware.api.client import APIClient
from sage.middleware.auth.jwt import JWTManager

client = APIClient()
jwt_manager = JWTManager()

resp = client.chat_completion(
    provider="openai",
    messages=[{"role": "user", "content": "Hello!"}],
)
print(resp)
```

> ğŸ“– **è¿ç§»æŒ‡å—**ï¼šå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ `VLLMGenerator`ï¼Œè¯·å‚é˜…
> [vLLM to sageLLM Migration Guide](../../docs-public/docs_src/dev-notes/migration/VLLM_TO_SAGELLM_MIGRATION.md)

## é…ç½®ç¤ºä¾‹

```yaml
# config.yaml
middleware:
  auth:
    secret_key: "your-secret-key"  # pragma: allowlist secret
    algorithm: "HS256"
  providers:
    openai:
      api_key: "sk-..."  # pragma: allowlist secret
      base_url: "https://api.openai.com/v1"
```

## å¼€å‘ä¸æœ¬åœ°å®‰è£…

```bash
git clone https://github.com/intellistream/SAGE.git
cd SAGE/packages/sage-middleware
pip install -e .
```

> è¯´æ˜ï¼šä¸­é—´ä»¶ç»„ä»¶ï¼ˆsage_db/sage_flow/sage_tsdb ç­‰ï¼‰ç°å·²éšæºç ç›´æ¥æä¾›æˆ–é€šè¿‡ pip ä¾èµ–åˆ†å‘ï¼Œæ— éœ€åˆå§‹åŒ–ä»»ä½•å­æ¨¡å—ã€‚

## æ–°å¢ä¸­é—´ä»¶ç»„ä»¶çš„è§„èŒƒï¼ˆé‡è¦ï¼‰

å½“ä½ æ·»åŠ æ–°çš„ä¸­é—´ä»¶ç»„ä»¶ï¼ˆä¾‹å¦‚ `sage_foo`ï¼‰æ—¶ï¼Œè¯·åŠ¡å¿…åœ¨ `setup.py` ä¸­æ¥å…¥å…¶æ„å»ºé€»è¾‘ï¼Œè¿™æ ·åœ¨å®‰è£… `isage-middleware` æ—¶ä¼šè‡ªåŠ¨æ„å»º/å‡†å¤‡è¯¥ç»„ä»¶ã€‚

å»ºè®®éµå¾ªä»¥ä¸‹çº¦å®šï¼š

### 1. ç›®å½•ç»“æ„

- `src/sage/middleware/components/sage_foo/`
  - `__init__.py`ï¼ˆPython åŒ…ï¼‰
  - ï¼ˆå¦‚åŒ…å« C/C++ éƒ¨åˆ†ï¼‰`cmake/`ã€`build.sh`ã€`CMakeLists.txt`
  - å…¶ä»–æºç /èµ„æºæ–‡ä»¶

### 2. C++ æ‰©å±•ä¸ä¾èµ–è¦æ±‚

å¦‚æœç»„ä»¶åŒ…å« C/C++ æ‰©å±•ï¼Œ**å¿…é¡»**éµå®ˆä»¥ä¸‹ä¾èµ–çº¦æŸï¼Œä»¥ä¸ç°æœ‰ `sage_db`ã€`sage_flow` ä¿æŒä¸€è‡´ï¼š

> **æ³¨æ„**: ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä¸­çš„ `SAGE_COMMON_DEPS_FILE` ç­‰å˜é‡æ˜¯ CMake ç¯å¢ƒå˜é‡ï¼Œéå ä½ç¬¦ã€‚

1. **å…±äº«ä¾èµ–å…¥å£ï¼š**

   - åœ¨ `CMakeLists.txt` ä¸­ä¼˜å…ˆåŠ è½½å…±äº«ä¾èµ–è„šæœ¬ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ï¼‰ï¼š
     ```cmake
     set(_sage_foo_shared_deps FALSE)
     # Check if shared deps file is defined
     if(DEFINED SAGE_COMMON_DEPS_FILE AND EXISTS "$ENV(SAGE_COMMON_DEPS_FILE)")
         include("$ENV(SAGE_COMMON_DEPS_FILE)")
         set(_sage_foo_shared_deps TRUE)
     endif()
     ```
   - å…±äº«è„šæœ¬ä¼šæä¾› `pybind11::module`ã€ç»Ÿä¸€çš„å¯è§æ€§ç¼–è¯‘é€‰é¡¹ã€ä»¥åŠå…¨éƒ¨ gperftools é…ç½®å˜é‡ã€‚

1. **æœ¬åœ°å›é€€è„šæœ¬ï¼š**

   - è¯·åœ¨ç»„ä»¶ç›®å½•çš„ `cmake/` ä¸‹æä¾› `pybind11_dependency.cmake` å’Œï¼ˆå¦‚éœ€è¦ï¼‰`gperftools.cmake`ï¼Œç”¨äºåœ¨ç‹¬ç«‹æ„å»ºæˆ–å…±äº«è„šæœ¬ç¼ºå¤±æ—¶ä¸‹è½½ä¾èµ–ã€‚
   - åœ¨ `CMakeLists.txt` ä¸­æ£€æµ‹ `_sage_foo_shared_deps`ï¼Œè‹¥ä¸º `FALSE` å†åŠ è½½æœ¬åœ°è„šæœ¬ï¼š
     ```cmake
     if(NOT _sage_foo_shared_deps)
         include(cmake/pybind11_dependency.cmake)
     endif()
     ```

1. **gperftools çº¦å®šï¼š**

   - æ–°å¢æ‰©å±•åº”æš´éœ² `ENABLE_GPERFTOOLS` é€‰é¡¹ï¼Œå¹¶é»˜è®¤éµå¾ª `SAGE_ENABLE_GPERFTOOLS` ç¯å¢ƒå˜é‡ã€‚
   - åªæœ‰åœ¨ç¡®è®¤æ‰¾åˆ° `SAGE_GPERFTOOLS_LIBS`ï¼ˆæˆ–æœ¬åœ°å›é€€è„šæœ¬æˆåŠŸè§£æï¼‰æ—¶æ‰é“¾æ¥ gperftoolsï¼›å¦åˆ™åŠ¡å¿…ç¦ç”¨è¯¥é€‰é¡¹å¹¶ç»™å‡ºæ¸…æ™°æ—¥å¿—ã€‚

1. **ç¯å¢ƒå˜é‡çº¦å®šï¼š**

   - å…±äº«è„šæœ¬ä¼šè®¾ç½® `SAGE_COMMON_COMPILE_OPTIONS`ã€`SAGE_COMMON_COMPILE_DEFINITIONS` ç­‰å˜é‡ï¼Œè¯·åœ¨ç›®æ ‡ä¸Šå¼•ç”¨ï¼Œé¿å…é‡å¤é…ç½®ã€‚
   - æ–°æ‰©å±•è‹¥éœ€è¦è‡ªå®šä¹‰å˜é‡ï¼ŒåŠ¡å¿…æä¾›åˆç†çš„é»˜è®¤å€¼ï¼Œå¹¶å…è®¸é€šè¿‡ç¯å¢ƒå˜é‡è¦†å†™ã€‚

1. **æ‰“åŒ…è¦æ±‚ï¼š**

   - `pyproject.toml` ä¸­éœ€åŒ…å« `"sage.middleware.components.sage_foo" = ["cmake/*.cmake"]` ç­‰æ¡ç›®ï¼Œä¿è¯ CMake
     è„šæœ¬åœ¨å‘å¸ƒåŒ…å†…ã€‚
   - å¦‚æ‰©å±•å­˜åœ¨ Python ä¾§ç»‘å®šï¼ˆ`python/` ç›®å½•ï¼‰ï¼Œç¡®ä¿ `pyproject.toml` ä¸­çš„ `package-data` åŒæ­¥æ›´æ–°ã€‚

### 3. æ„å»ºè„šæœ¬

- å¦‚æœç»„ä»¶éœ€è¦ç¼–è¯‘æˆ–é¢å¤–å‡†å¤‡å·¥ä½œï¼Œè¯·æä¾›æ ‡å‡†çš„ `build.sh`ï¼Œæ”¯æŒæ— äº¤äº’æ‰§è¡Œï¼š
  - `bash build.sh --install-deps`
- `build.sh` åº”è¯»å–ç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆå¦‚ä¾èµ–æ–‡ä»¶è·¯å¾„ã€gperftools å¼€å…³ç­‰ï¼‰ï¼Œå¹¶åœ¨è°ƒç”¨ `cmake` æ—¶é€ä¼ ï¼ˆå‚è€ƒ `sage_db`ã€`sage_flow`ï¼‰ã€‚

### 4. åœ¨ `setup.py` ä¸­æ¥å…¥

- åœ¨è‡ªå®šä¹‰çš„ `build_ext` æµç¨‹ä¸­ï¼š
  - æ–°å¢ `build_sage_foo()` æ–¹æ³•ï¼ˆå‚ç…§ç°æœ‰ `build_sage_db()` / `build_sage_flow()`ï¼‰ã€‚
  - ä½¿ç”¨ç»Ÿä¸€çš„ `_shared_env()` å¸®åŠ©å‡½æ•°ä¸ºå­è¿›ç¨‹æ³¨å…¥å…±äº«ä¾èµ–ç¯å¢ƒã€‚
  - åœ¨ `run()` ä¸­è°ƒç”¨ `self.build_sage_foo()`ï¼Œå¹¶ä¿è¯å¤±è´¥ä¸é˜»æ–­å®‰è£…ï¼ˆæ‰“å°æ¸…æ™°æ—¥å¿—å³å¯ï¼‰ã€‚

### 5. ç¯å¢ƒå˜é‡å¼€å…³ï¼ˆå¯é€‰ï¼‰

- é€šè¿‡è®¾ç½® `SAGE_SKIP_C_EXTENSIONS=1` å¯ä»¥è·³è¿‡æ‰€æœ‰æ‰©å±•æ„å»ºï¼ˆè°ƒè¯•çº¯ Python é€»è¾‘æ—¶å¸¸ç”¨ï¼‰ã€‚

### 6. CI ä¸å­æ¨¡å—æç¤º

- CI ä¼šé€’å½’æ£€å‡ºå­æ¨¡å—å¹¶æŒ‰ `setup.py` çš„é€»è¾‘å°è¯•æ„å»ºã€‚
- ä¸­é—´ä»¶ç»„ä»¶ä¸å†é€šè¿‡ Git submodule åˆ†å‘ï¼›è¯·ä¸è¦åœ¨ CI æˆ–æœ¬åœ°æ‰§è¡Œå­æ¨¡å—åˆå§‹åŒ–å‘½ä»¤ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ PRï¼è¯·å…ˆé˜…è¯»ä»“åº“æ ¹ç›®å½•çš„ [CONTRIBUTING.md](../../CONTRIBUTING.md)ã€‚

## ğŸ“„ License

MIT License - see [LICENSE](../../LICENSE) for details.
