<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clouvel Pro Admin</title>
  <style>
    :root {
      --bg: #0f1117;
      --bg-card: #1a1d27;
      --bg-hover: #252a36;
      --primary: #10B981;
      --primary-dim: #059669;
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --border: #2d3748;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Layout */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header h1 span { color: var(--primary); }

    .api-key-form {
      display: flex;
      gap: 0.5rem;
    }

    .api-key-form input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      color: var(--text);
      width: 300px;
    }

    .api-key-form button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 500;
    }

    .api-key-form button:hover { background: var(--primary-dim); }

    /* Navigation */
    .nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .nav button {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1.5rem;
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav button:hover { background: var(--bg-hover); }
    .nav button.active {
      background: var(--primary);
      border-color: var(--primary);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .stat-card .label {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .stat-card .value.success { color: var(--primary); }
    .stat-card .value.danger { color: var(--danger); }
    .stat-card .value.warning { color: var(--warning); }
    .stat-card .value.info { color: var(--info); }

    /* Tables */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 { font-size: 1.1rem; }

    .card-header button {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem 1.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      color: var(--text-dim);
      font-weight: 500;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover { background: var(--bg-hover); }

    /* Badges */
    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--primary); }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--info); }

    /* Action buttons */
    .btn-action {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.4rem 0.8rem;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 0.5rem;
    }

    .btn-action:hover { background: var(--bg-hover); color: var(--text); }
    .btn-action.danger:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .btn-action.success:hover { background: rgba(16, 185, 129, 0.2); color: var(--primary); }

    /* Hidden sections */
    .section { display: none; }
    .section.active { display: block; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-dim);
    }

    /* Empty state */
    .empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-dim);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h3 {
      margin-bottom: 1rem;
    }

    .modal-content input, .modal-content textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      color: var(--text);
      margin-bottom: 1rem;
    }

    .modal-content textarea { min-height: 100px; resize: vertical; }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .modal-actions button {
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-cancel {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-confirm {
      background: var(--danger);
      border: none;
      color: white;
    }

    .btn-confirm.success { background: var(--primary); }

    /* Audit Log Colors */
    .event-auth_failure { color: var(--danger); }
    .event-rate_limited { color: var(--warning); }
    .event-brute_force { color: var(--danger); }
    .event-anomaly_detected { color: var(--warning); }
    .event-refund_processed { color: var(--info); }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .header { flex-direction: column; gap: 1rem; }
      .api-key-form { width: 100%; }
      .api-key-form input { flex: 1; }
      .nav { flex-wrap: wrap; }
      th, td { padding: 0.75rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1><span>Clouvel</span> Pro Admin</h1>
      <form class="api-key-form" onsubmit="return connect(event)">
        <input type="password" id="apiKey" placeholder="Admin API Key" required>
        <button type="submit" id="connectBtn">Connect</button>
      </form>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <button class="active" data-section="overview">Overview</button>
      <button data-section="licenses">Licenses</button>
      <button data-section="refunds">Refunds</button>
      <button data-section="audit">Audit Log</button>
      <button data-section="security">Security</button>
    </nav>

    <!-- Overview Section -->
    <section id="overview" class="section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Active Licenses</div>
          <div class="value success" id="stat-active">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Total Licenses</div>
          <div class="value" id="stat-total">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Refunded</div>
          <div class="value danger" id="stat-refunded">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Blocked</div>
          <div class="value warning" id="stat-blocked">-</div>
        </div>
        <div class="stat-card">
          <div class="label">24h API Calls</div>
          <div class="value info" id="stat-requests">-</div>
        </div>
        <div class="stat-card">
          <div class="label">24h Anomalies</div>
          <div class="value warning" id="stat-anomalies">-</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Recent Activity</h2>
          <button onclick="loadOverview()">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Event</th>
              <th>License</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="recent-activity">
            <tr><td colspan="4" class="loading">Connect to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Licenses Section -->
    <section id="licenses" class="section">
      <div class="card">
        <div class="card-header">
          <h2>License Management</h2>
          <button onclick="loadLicenses()">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>License Key</th>
              <th>Tier</th>
              <th>Status</th>
              <th>Machines</th>
              <th>Last Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="licenses-table">
            <tr><td colspan="6" class="loading">Connect to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Refunds Section -->
    <section id="refunds" class="section">
      <div class="card">
        <div class="card-header">
          <h2>Refund History</h2>
          <button onclick="loadRefunds()">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>License Key</th>
              <th>Order ID</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="refunds-table">
            <tr><td colspan="4" class="loading">Connect to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Audit Log Section -->
    <section id="audit" class="section">
      <div class="card">
        <div class="card-header">
          <h2>Audit Log</h2>
          <button onclick="loadAuditLog()">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Event Type</th>
              <th>License</th>
              <th>IP</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="audit-table">
            <tr><td colspan="5" class="loading">Connect to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Security Section -->
    <section id="security" class="section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Suspicion Level 1</div>
          <div class="value warning" id="sec-level1">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Suspicion Level 2</div>
          <div class="value warning" id="sec-level2">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Suspicion Level 3</div>
          <div class="value danger" id="sec-level3">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Sharing Suspects</div>
          <div class="value danger" id="sec-sharing">-</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Anomaly Detection</h2>
          <button onclick="loadSecurity()">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>License</th>
              <th>Suspicion Score</th>
              <th>Countries</th>
              <th>Machines</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="security-table">
            <tr><td colspan="5" class="loading">Connect to load data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Block Modal -->
  <div class="modal" id="blockModal">
    <div class="modal-content">
      <h3>Block License</h3>
      <input type="text" id="blockLicense" placeholder="License Key" readonly>
      <textarea id="blockReason" placeholder="Reason for blocking..."></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal('blockModal')">Cancel</button>
        <button class="btn-confirm" onclick="confirmBlock()">Block</button>
      </div>
    </div>
  </div>

  <!-- Unblock Modal -->
  <div class="modal" id="unblockModal">
    <div class="modal-content">
      <h3>Unblock License</h3>
      <input type="text" id="unblockLicense" placeholder="License Key" readonly>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal('unblockModal')">Cancel</button>
        <button class="btn-confirm success" onclick="confirmUnblock()">Unblock</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'https://clouvel-license-webhook.vnddns999.workers.dev';
    let API_KEY = localStorage.getItem('clouvel_admin_key') || '';

    // Navigation
    document.querySelectorAll('.nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.section).classList.add('active');
        loadSection(btn.dataset.section);
      });
    });

    // Connect
    function connect(e) {
      e.preventDefault();
      API_KEY = document.getElementById('apiKey').value;
      localStorage.setItem('clouvel_admin_key', API_KEY);
      document.getElementById('connectBtn').textContent = 'Connected';
      loadOverview();
      return false;
    }

    // Auto-connect if key exists
    if (API_KEY) {
      document.getElementById('apiKey').value = API_KEY;
      document.getElementById('connectBtn').textContent = 'Connected';
      setTimeout(loadOverview, 100);
    }

    // API Helper
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json'
        }
      };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${API_BASE}${endpoint}`, options);
      return res.json();
    }

    // Load sections
    function loadSection(section) {
      if (!API_KEY) return;
      switch(section) {
        case 'overview': loadOverview(); break;
        case 'licenses': loadLicenses(); break;
        case 'refunds': loadRefunds(); break;
        case 'audit': loadAuditLog(); break;
        case 'security': loadSecurity(); break;
      }
    }

    // Overview
    async function loadOverview() {
      try {
        const data = await apiCall('/admin/dashboard');
        if (data.error) throw new Error(data.message);

        document.getElementById('stat-active').textContent = data.stats?.active || 0;
        document.getElementById('stat-total').textContent = data.stats?.total || 0;
        document.getElementById('stat-refunded').textContent = data.stats?.refunded || 0;
        document.getElementById('stat-blocked').textContent = data.stats?.blocked || 0;
        document.getElementById('stat-requests').textContent = data.stats?.requests_24h || 0;
        document.getElementById('stat-anomalies').textContent = data.stats?.anomalies_24h || 0;

        const tbody = document.getElementById('recent-activity');
        if (data.recent_events?.length) {
          tbody.innerHTML = data.recent_events.slice(0, 10).map(e => `
            <tr>
              <td>${formatTime(e.timestamp)}</td>
              <td><span class="event-${e.type}">${e.type}</span></td>
              <td>${maskLicense(e.license_key)}</td>
              <td>${e.details || '-'}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">No recent activity</td></tr>';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('recent-activity').innerHTML =
          `<tr><td colspan="4" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    // Licenses
    async function loadLicenses() {
      try {
        const data = await apiCall('/admin/dashboard');
        if (data.error) throw new Error(data.message);

        const tbody = document.getElementById('licenses-table');
        if (data.licenses?.length) {
          tbody.innerHTML = data.licenses.map(l => `
            <tr>
              <td>${maskLicense(l.license_key)}</td>
              <td>${l.tier || 'personal'}</td>
              <td>${getStatusBadge(l.status)}</td>
              <td>${l.machines || 0}</td>
              <td>${formatTime(l.last_active)}</td>
              <td>
                ${l.status === 'blocked'
                  ? `<button class="btn-action success" onclick="showUnblock('${l.license_key}')">Unblock</button>`
                  : `<button class="btn-action danger" onclick="showBlock('${l.license_key}')">Block</button>`
                }
                <button class="btn-action" onclick="analyzeLicense('${l.license_key}')">Analyze</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">No licenses found</td></tr>';
        }
      } catch (err) {
        document.getElementById('licenses-table').innerHTML =
          `<tr><td colspan="6" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    // Refunds
    async function loadRefunds() {
      try {
        const data = await apiCall('/admin/dashboard');
        if (data.error) throw new Error(data.message);

        const tbody = document.getElementById('refunds-table');
        if (data.refunds?.length) {
          tbody.innerHTML = data.refunds.map(r => `
            <tr>
              <td>${formatTime(r.refunded_at)}</td>
              <td>${maskLicense(r.license_key)}</td>
              <td>${r.order_id || '-'}</td>
              <td>${r.reason || 'N/A'}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">No refunds found</td></tr>';
        }
      } catch (err) {
        document.getElementById('refunds-table').innerHTML =
          `<tr><td colspan="4" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    // Audit Log
    async function loadAuditLog() {
      try {
        const data = await apiCall('/stats/audit');
        if (data.error) throw new Error(data.message);

        const tbody = document.getElementById('audit-table');
        if (data.events?.length) {
          tbody.innerHTML = data.events.slice(0, 50).map(e => `
            <tr>
              <td>${formatTime(e.timestamp)}</td>
              <td><span class="event-${e.type}">${e.type}</span></td>
              <td>${maskLicense(e.license_key)}</td>
              <td>${e.ip || '-'}</td>
              <td>${e.details || '-'}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No audit events</td></tr>';
        }
      } catch (err) {
        document.getElementById('audit-table').innerHTML =
          `<tr><td colspan="5" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    // Security
    async function loadSecurity() {
      try {
        const data = await apiCall('/stats/anomaly');
        if (data.error) throw new Error(data.message);

        document.getElementById('sec-level1').textContent = data.level1_count || 0;
        document.getElementById('sec-level2').textContent = data.level2_count || 0;
        document.getElementById('sec-level3').textContent = data.level3_count || 0;
        document.getElementById('sec-sharing').textContent = data.sharing_suspects || 0;

        const tbody = document.getElementById('security-table');
        if (data.anomalies?.length) {
          tbody.innerHTML = data.anomalies.map(a => `
            <tr>
              <td>${maskLicense(a.license_key)}</td>
              <td><span class="badge ${getSuspicionBadge(a.suspicion_score)}">${a.suspicion_score}</span></td>
              <td>${a.countries || 0}</td>
              <td>${a.machines || 0}</td>
              <td>
                <button class="btn-action danger" onclick="showBlock('${a.license_key}')">Block</button>
                <button class="btn-action" onclick="checkSharing('${a.license_key}')">Check Sharing</button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No anomalies detected</td></tr>';
        }
      } catch (err) {
        document.getElementById('security-table').innerHTML =
          `<tr><td colspan="5" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    // Block/Unblock
    function showBlock(license) {
      document.getElementById('blockLicense').value = license;
      document.getElementById('blockModal').classList.add('active');
    }

    function showUnblock(license) {
      document.getElementById('unblockLicense').value = license;
      document.getElementById('unblockModal').classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    async function confirmBlock() {
      const license = document.getElementById('blockLicense').value;
      const reason = document.getElementById('blockReason').value;

      try {
        await apiCall('/admin/block', 'POST', { license_key: license, reason });
        closeModal('blockModal');
        loadLicenses();
        alert('License blocked successfully');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function confirmUnblock() {
      const license = document.getElementById('unblockLicense').value;

      try {
        await apiCall('/admin/unblock', 'POST', { license_key: license });
        closeModal('unblockModal');
        loadLicenses();
        alert('License unblocked successfully');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function analyzeLicense(license) {
      try {
        const data = await apiCall('/analyze/license', 'POST', { license_key: license });
        alert(JSON.stringify(data, null, 2));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function checkSharing(license) {
      try {
        const data = await apiCall('/admin/check-sharing', 'POST', { license_key: license });
        alert(JSON.stringify(data, null, 2));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Helpers
    function formatTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleString('ko-KR', {
        month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function maskLicense(key) {
      if (!key) return '-';
      if (key.length <= 12) return key;
      return key.slice(0, 8) + '...' + key.slice(-4);
    }

    function getStatusBadge(status) {
      const badges = {
        active: 'badge-success',
        blocked: 'badge-danger',
        suspended: 'badge-warning',
        refunded: 'badge-danger'
      };
      return `<span class="badge ${badges[status] || 'badge-info'}">${status || 'unknown'}</span>`;
    }

    function getSuspicionBadge(score) {
      if (score >= 90) return 'badge-danger';
      if (score >= 60) return 'badge-warning';
      return 'badge-info';
    }
  </script>
</body>
</html>
