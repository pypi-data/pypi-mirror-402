"""
CSV Schedule Generation System.

Generates comprehensive CSV files with detailed formatting for all cruise activities.
"""

import csv
import logging
from pathlib import Path

from cruiseplan.calculators.scheduler import ActivityRecord
from cruiseplan.output.output_utils import (
    format_operation_action,
    get_activity_depth,
    round_time_to_minute,
)
from cruiseplan.schema import CruiseConfig
from cruiseplan.utils.coordinates import CoordConverter

logger = logging.getLogger(__name__)


class CSVGenerator:
    """
    Manages CSV generation for cruise schedules with comprehensive formatting.
    """

    def __init__(self):
        """Initialize the CSV generator."""
        pass

    def _get_display_label(self, activity: dict) -> str:
        """
        Get appropriate display label for an activity.

        For ports, use display_name if available, otherwise use label.
        For other activities, use label directly.

        Parameters
        ----------
        activity : dict
            Activity record

        Returns
        -------
        str
            Display label for the activity
        """
        label = activity.get("label", "")

        # For port activities, prefer display_name over label
        if activity.get("activity", "").lower() == "port":
            display_name = activity.get("display_name", "")
            if display_name:
                # Extract just the city name (before comma) for cleaner display
                return display_name.split(",")[0].strip()

        return label

    def _get_depth_value(self, activity: dict) -> str:
        """
        Get depth value prioritizing operation_depth over water_depth.

        Parameters
        ----------
        activity : dict
            Activity record with depth information

        Returns
        -------
        str
            Depth value as string (rounded to whole number) or "0" if no depth available
        """
        depth = get_activity_depth(activity)
        return str(round(depth))

    def generate_schedule_csv(
        self, config: CruiseConfig, timeline: list[ActivityRecord], output_file: Path
    ) -> Path:
        """
        Generate CSV schedule output with comprehensive formatting.

        Parameters
        ----------
        config : CruiseConfig
            The cruise configuration object
        timeline : List[ActivityRecord]
            Timeline generated by the scheduler
        output_file : Path
            Path to output CSV file

        Returns
        -------
        Path
            Path to generated CSV file
        """
        # Define CSV fieldnames with comprehensive column structure
        fieldnames = [
            "activity",
            "label",
            "operation_action",
            "start_time",
            "end_time",
            "Transit dist [nm]",
            "Vessel speed [kt]",
            "Duration [hrs]",
            "Depth [m]",
            "Lat [deg]",
            "Lon [deg]",
            "Lat [deg_rounded]",
            "Lat [min]",
            "Lon [deg_rounded]",
            "Lon [min]",
            "leg_name",
        ]

        # Write CSV file
        output_file.parent.mkdir(parents=True, exist_ok=True)
        with open(output_file, "w", newline="", encoding="utf-8") as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)

            writer.writeheader()
            for activity in timeline:
                # Format datetime for CSV - round to nearest minute
                start_time = round_time_to_minute(activity["start_time"])
                end_time = round_time_to_minute(activity["end_time"])

                # Convert duration to hours and round to nearest 0.1 hour
                duration_hours = round(activity["duration_minutes"] / 60.0, 1)

                # Round distance to nearest 0.1 nm using unified dist_nm field
                transit_dist_nm = round(activity.get("dist_nm", 0.0), 1)

                # Vessel speed - 0 for station operations, actual speed for transits
                activity_type = activity.get("activity", "").lower()
                if activity_type in {"transit", "port_departure", "port_arrival"}:
                    vessel_speed = activity.get("vessel_speed_kt", 0)
                    # For scientific transits with 0 speed, try to calculate from distance/time
                    if vessel_speed == 0 and transit_dist_nm > 0 and duration_hours > 0:
                        vessel_speed = round(transit_dist_nm / duration_hours, 1)
                else:
                    vessel_speed = 0  # Station operations have 0 vessel speed

                # Format operation and action using correct field names (with backward compatibility)
                op_type = activity.get("op_type") or activity.get("operation_type", "")
                operation_action = format_operation_action(
                    op_type, activity.get("action", "")
                )

                # Coordinate conversions using existing utilities
                # Use entry coordinates (with backward compatibility for legacy tests)
                lat_decimal = activity.get("entry_lat")
                lon_decimal = activity.get("entry_lon")
                lat_deg_float, lat_min = CoordConverter.decimal_degrees_to_ddm(
                    lat_decimal
                )
                lon_deg_float, lon_min = CoordConverter.decimal_degrees_to_ddm(
                    lon_decimal
                )
                # Preserve sign for rounded degrees
                lat_deg_rounded = (
                    int(lat_deg_float) if lat_decimal >= 0 else -int(lat_deg_float)
                )
                lon_deg_rounded = (
                    int(lon_deg_float) if lon_decimal >= 0 else -int(lon_deg_float)
                )
                # Preserve sign for minutes when coordinate is negative
                lat_min = round(lat_min if lat_decimal >= 0 else -lat_min, 2)
                lon_min = round(lon_min if lon_decimal >= 0 else -lon_min, 2)

                row = {
                    "activity": activity["activity"],
                    "label": activity["label"],
                    "operation_action": operation_action,
                    "start_time": start_time.isoformat(),
                    "end_time": end_time.isoformat(),
                    "Transit dist [nm]": transit_dist_nm,
                    "Vessel speed [kt]": vessel_speed,
                    "Duration [hrs]": duration_hours,
                    "Depth [m]": self._get_depth_value(activity),
                    "Lat [deg]": round(
                        lat_decimal, 6
                    ),  # High precision decimal degrees
                    "Lon [deg]": round(
                        lon_decimal, 6
                    ),  # High precision decimal degrees
                    "Lat [deg_rounded]": lat_deg_rounded,
                    "Lat [min]": lat_min,
                    "Lon [deg_rounded]": lon_deg_rounded,
                    "Lon [min]": lon_min,
                    "leg_name": activity.get("leg_name", ""),
                }

                writer.writerow(row)

        return output_file


def generate_csv_schedule(
    config: CruiseConfig, timeline: list[ActivityRecord], output_file: Path
) -> Path:
    """
    Main interface to generate CSV schedule from scheduler timeline.

    Parameters
    ----------
    config : CruiseConfig
        The cruise configuration object
    timeline : List[ActivityRecord]
        Timeline generated by the scheduler
    output_file : Path
        Path to output CSV file

    Returns
    -------
    Path
        Path to generated CSV file
    """
    logger = logging.getLogger(__name__)
    logger.info(f"ðŸ“Š CSV Generator: Starting generation of {output_file}")
    logger.info(f"   Timeline contains {len(timeline)} activities")

    generator = CSVGenerator()
    return generator.generate_schedule_csv(config, timeline, output_file)
