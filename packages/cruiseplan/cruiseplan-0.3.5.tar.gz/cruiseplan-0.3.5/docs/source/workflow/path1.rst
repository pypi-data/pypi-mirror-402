.. _user_workflow_path_1:

Path 1: Basic Planning Workflow
================================

**Best for:** First-time users, simple cruises, when historical data is not needed

**Time required:** 30-60 minutes to create a first draft of a cruise

.. figure:: ../_static/diagrams/cruiseplan_process.png
   :align: center
   :alt: CruisePlan Process Overview
   :width: 100%
   
   **CruisePlan Process Overview**: The complete workflow from data preparation through final deliverables, showing the unified ``cruiseplan process`` command and individual command options. Path 1 follows Phase 1 with only the "cruiseplan bathymetry" step, then Phase 2 and Phase 3 as normal. CruisePlan commands are in red, files in black, and the blue box indicates where manual editing occurs.

---- 

Phase 1: Data Preparation
---------------------------------

Step 1.1: Download Bathymetry
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**Purpose:** Provides depth information for station planning and automatic depth enrichment.

Essential first step:  :ref:`download_bathymetry`.  You've succeeeded when you have the file ``data/bathymetry/ETOPO_2022_v1_60s_N90W180_bed.nc`` available.  When in doubt, start with the ETOPO (default) only. 

.. figure:: ../_static/screenshots/data_directory_structure.png
   :alt: Bathymetry data directory structure showing downloaded files
   :width: 600px
   :align: center
   
   Directory structure (Mac OS Finder) showing bathymetry files in ``data/bathymetry/``

.. note::
  See :ref:`Bathymetry subcommand CLI reference <subcommand-bathymetry>` for full options and examples.

----

Phase 2: Cruise Configuration
-----------------------------

Step 2.1: Pick Stations
~~~~~~~~~~~~~~~~~~~~~~~

**Purpose:** Visually select station locations using an interactive map interface.

.. code-block:: bash

   cruiseplan stations --lat 45 70 --lon -65 -5 -o output_dir
   
This will plot a map within the region specified (or defaults to the subpolar North Atlantic if not specified), and add contours of bathymetry.  It has various input modes for cruise activities at fixed points (stations), along lines (transects) or within areas (box surveys).  The navigation mode allows panning and zooming to explore the map without accidently clicking to add stations.

.. figure:: ../_static/screenshots/station_picker_startup.png
   :alt: Station picker interface showing three-panel layout
   :width: 800px
   :align: center
   
   Interactive station picker interface with map, controls, and status panels  

**Interactive Controls:**

Four modes of inputs:

- ``p`` or ``w``: Place point stations (CTD stations, moorings)
- ``l`` or ``s``: Draw line transects (underway surveys)
- ``a``: Define area operations (box surveys)
- ``n``: Navigation mode (pan/zoom)

.. figure:: ../_static/screenshots/station_picker_point_mode.png
   :alt: Station picker in point placement mode
   :width: 700px
   :align: center
   
   Point placement mode for adding individual stations (CTD, moorings).  Note the status in the upper right corner has changed to "Mode: Point".

Additional commands can be used anytime:

- ``u``: Undo last operation
- ``r``: Remove operation (click to select)
- ``y``: Save to YAML file
- ``Escape``: Exit without saving

.. figure:: ../_static/screenshots/station_picker_multiple_stations.png
   :alt: Multiple stations placed on the map
   :width: 700px
   :align: center
   
   Example cruise plan with multiple stations showing position on the map.
   
   
.. warning::
  If you don't specify an output file, the command will create ``stations.yaml`` in the default directory (``./data``). Running the command multiple times will overwrite that file. There is a prompt to confirm overwriting (otherwise it will not save); or run ``cruiseplan stations --overwrite`` to overwrite without prompting.


**What this creates:**

- A stub YAML configuration file with station coordinates
- Basic structure for stations, transects, and areas
- Geographic positions without operational details

**Example output structure:** See a full example in `example_yaml.rst <example_yaml.html>`_.

.. code-block:: yaml

  # CruisePlan YAML Configuration
  # Generated by Interactive Station Picker
  # Creation Date: 2025-12-18T10:41:20

  # ======================================================================================
  # CRUISE PLANNING WORKFLOW - Next Steps:
  # ======================================================================================
  # 1. Review and update all 'UPDATE-*' placeholders below
  # 2. Set operation_type (CTD, mooring, water_sampling, etc.)
  # 3. Set action (profile, deployment, recovery, etc.)  
  # 4. Run validation: cruiseplan validate <filename>
  # 5. Add depths: cruiseplan enrich <filename> --add-depths --add-coords --expand-sections   
  # 6. Generate schedule: cruiseplan schedule <filename>

  # ======================================================================================
  # FIELD DOCUMENTATION:
  # ======================================================================================
  # Required fields are marked with [REQUIRED]
  # Optional fields are marked with [OPTIONAL]
  # Fields marked 'UPDATE-*' must be reviewed and updated

  # For complete field reference, see: 
  # https://ocean-uhh.github.io/cruiseplan/yaml_reference.html
  # [REQUIRED] Unique identifier for this cruise
  cruise_name: Interactive_Session
  # [OPTIONAL] Human-readable cruise description
  description: Cruise plan created with interactive station picker
  # [REQUIRED] Default transit speed in knots
  default_vessel_speed: 10.0
  # [REQUIRED] Default distance between stations in kilometers
  default_distance_between_stations: 40.0
  calculate_transfer_between_sections: true
  calculate_depth_via_bathymetry: true
  # [REQUIRED] Cruise start date (ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ)
  start_date: '1970-01-01T00:00:00Z'
  # [REQUIRED] Cruise schedule organized by legs
  # Departure/arrival ports are now defined within each leg
  legs:
    - name: "Main_Survey"
      departure_port:
        name: UPDATE-departure-port-name  # Update with actual port name
        latitude: 0.0  # Update with actual port coordinates
        longitude: 0.0
        timezone: GMT+0
      arrival_port:
        name: UPDATE-arrival-port-name    # Update with actual port name  
        latitude: 0.0  # Update with actual port coordinates
        longitude: 0.0
        timezone: GMT+0
      first_station: "STN_001"  # First operational station
      last_station: "STN_999"   # Last operational station
      activities: []  # Will be populated with station/cluster references


.. warning::
  **Critical Next Step:** The station picker creates placeholder values that will trigger validation warnings. You need to **manually edit the YAML** to specify actual operation types and actions before proceeding.  


----

.. _manual_editing_configuration:

Step 2.2: Manual Configuration Editing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
**Purpose:** Define what scientific operations will happen at each location. If you do not, however, the validation (Step 4) will still pass with warnings.  Operations will default to the same values as "CTD" and "profile" for stations, but will not update the YAML configuration (so you know where you've updated or not).


**Operation Type Guide:**

.. list-table::
   :widths: 20 20 20 40
   :header-rows: 1

   * - **Operation**
     - **Action**
     - **Duration**
     - **Description**
   * - ``CTD``
     - ``profile``
     - Auto-calculated
     - Water column profiling, duration based on depth
   * - ``mooring``
     - ``deployment``/``recovery``
     - **Manual required**
     - Mooring operations, default 60 minutes
   * - ``water_sampling``
     - ``sampling``
     - Auto-calculated
     - Water/biological sampling
   * - ``calibration``
     - ``calibration``
     - Auto-calculated
     - Equipment calibration

.. warning::
  ⚠️ **Important**: Mooring operations require manual duration specification. CTD operations are automatically calculated based on depth.


1. **Replace placeholder values** for each station:

.. code-block:: yaml

   points:
     - name: "STN_001"
       latitude: 60.5
       longitude: -30.2
       depth: 2847.3               # Auto-populated from bathymetry
       comment: "Interactive selection"
       operation_type: "CTD"        # REPLACE: UPDATE-CTD-mooring-etc
       action: "profile"            # REPLACE: UPDATE-profile-sampling-etc
       # duration: 120              # OPTIONAL: manual override (minutes)

2. **Define leg activities** (determines station visit order):

.. code-block:: yaml

   legs:
     - name: "Northern_Survey"
       strategy: "sequential"
       activities: ["STN_001", "STN_002", "STN_003"]  # Visit order

3. **Add/edit cruise metadata**:

otherwise, your cruise will start at 0.0, 0.0!

.. code-block:: yaml

   cruise_name: "My_Research_Cruise_2024"
   description: "Oceanographic survey of the North Atlantic"
   start_date: "2024-07-01T08:00:00Z"
   
   legs:
     - name: "Atlantic_Survey"
       departure_port:
         name: "Reykjavik"
         latitude: 64.1466
         longitude: -21.9426
       arrival_port:
         name: "St. Johns"  
         latitude: 47.5705
         longitude: -52.6979
       first_activity: "STN_001"
       last_activity: "STN_005"
       activities: ["STN_001", "STN_002", "STN_003", "STN_004", "STN_005"]

4. **Use Global Ports Reference**:

CruisePlan includes a comprehensive registry of research ports worldwide. See the complete :ref:`global_ports_reference` for all available ports with coordinates.

You can reference global ports directly in YAML instead of specifying coordinates:

.. code-block:: yaml

   legs:
     - name: "Atlantic_Survey"  
       departure_port: "port_reykjavik"  # Reference to global port
       arrival_port: "port_st_johns"     # Reference to global port
       # No need to specify coordinates - they're looked up automatically

**Common Research Ports** (see full list in :ref:`global_ports_reference`):

- ``port_reykjavik`` - Reykjavik, Iceland
- ``port_bremerhaven`` - Bremerhaven, Germany  
- ``port_woods_hole`` - Woods Hole, Massachusetts
- ``port_st_johns`` - St. Johns, Newfoundland
- ``port_tromso`` - Tromsø, Norway

For programmatic access or regional filtering, see the :ref:`global_ports_reference` documentation.


----

.. _process_configuration:

Step 2.3: Process Configuration (enrich, validate + map)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**Purpose:** Automatically add depth information and formatted coordinates to your stations. Checks for errors and inconsistencies before scheduling.

**Option A: Unified Processing (Recommended)**

.. code-block:: bash

   cruiseplan process -c my_cruise.yaml --output expedition_2024

This unified command runs all three steps (enrichment, validation, and map generation) with smart defaults:

- All enrichment options enabled by default (depths, coordinates, sections, ports)
- Comprehensive validation with depth checking
- PNG map and KML catalog generation
- Predictable output filenames: ``expedition_2024_enriched.yaml``, ``expedition_2024_map.png``, ``expedition_2024_catalog.kml``

**Option B: Individual Commands**

For fine-grained control, use individual commands:

.. code-block:: bash

   cruiseplan enrich -c my_cruise.yaml --output expedition_2024
   cruiseplan validate -c data/expedition_2024_enriched.yaml --check-depths
   cruiseplan map -c data/expedition_2024_enriched.yaml --output expedition_map

.. note::
   The unified ``cruiseplan process`` command is recommended for most users as it provides smart defaults and streamlined workflow. For advanced users who need fine-grained control over each step, individual commands offer maximum flexibility.
   
   See :ref:`Process subcommand CLI reference <subcommand-process>` for complete options and examples.

**Common Processing Details:**

- Queries bathymetry database for depth at each station
- Adds ``depth`` field to stations that lack it (unless ``--no-depths`` specified), but note it preserves any manually specified depths
- Adds ``position_string`` field with formatted coordinates (unless ``--no-coords`` specified)
- **Section Expansion**: Converts transit route definitions into individual station definitions (unless ``--no-sections`` specified)
- **Leg Anchor Updates**: Automatically updates ``first_waypoint`` and ``last_waypoint`` fields in legs to reference the newly created stations
- Expands ports to full definitions if only a name was provided (unless ``--no-ports`` specified)


**Validation checks:**

- Required fields are present
- Operation type/action combinations are valid
- Coordinates are within valid ranges
- **Duplicate detection**: Station names, leg names must be unique
- **Potential duplicates**: Warns about stations with identical coordinates and operations
- Depth values are reasonable (if ``--check-depths`` specified)
- Leg definitions reference existing stations

**Example enrichment:**

.. code-block:: yaml

   # Before enrichment (from station picker):
   - name: "STN_001"
     latitude: 60.5
     longitude: -30.2
     depth: -9999.0
     operation_type: "CTD"                    # User updated from placeholder
     action: "profile"                        # User updated from placeholder

   # After enrichment:
   - name: "STN_001"
     latitude: 60.5
     longitude: -30.2
     operation_type: "CTD"
     action: "profile"
     depth: 2847.3                            # Updated from bathymetry
     position_string: "60°30.0'N 30°12.0'W"  # Added automatically

**Section Expansion Example:**

The ``--expand-sections`` option transforms transit route definitions into individual stations and automatically updates leg routing anchors:

.. code-block:: yaml

   # Before expansion:
   lines:
     - name: "OVIDE_Section" 
       operation_type: "ctd_section"
       spacing_km: 50.0
       route:
         - latitude: 40.33
           longitude: -10.0
         - latitude: 59.75
           longitude: -42.0
   
   legs:
     - name: "Main_Survey"
       first_activity: "OVIDE_Section"        # References line
       last_activity: "OVIDE_Section"
       activities: ["OVIDE_Section"]
   
   # After expansion:
   points:
     - name: "OVIDE_Section_001"
       latitude: 40.33
       longitude: -10.0
       operation_type: "CTD"
       action: "profile"
       depth: 4327.2                          # From bathymetry
     - name: "OVIDE_Section_002" 
       latitude: 41.22                        # Spherical interpolation
       longitude: -12.4
       operation_type: "CTD"
       action: "profile"
       depth: 3891.5
     # ... additional stations at 50km intervals
     - name: "OVIDE_Section_040"
       latitude: 59.75
       longitude: -42.0
       operation_type: "CTD"
       action: "profile"
       depth: 2156.8
   
   legs:
     - name: "Main_Survey"  
       first_activity: "OVIDE_Section_001"    # Auto-updated to first station
       last_activity: "OVIDE_Section_040"     # Auto-updated to last station  
       activities: ["OVIDE_Section_001", "OVIDE_Section_002", ..., "OVIDE_Section_040"]

**Automatic Waypoint Resolution:**

- ``first_waypoint`` automatically resolves to the first generated station along the route
- ``last_waypoint`` automatically resolves to the last generated station along the route  
- Leg activities are updated to include all generated stations in sequential order
- Original transit definitions are preserved but no longer used in scheduling

.. figure:: ../_static/screenshots/yaml_enrichment_comparison.png
   :alt: YAML before and after enrichment showing added depth and position_string fields
   :width: 600px
   :align: center
   
   YAML before and after enrichment showing added depth and position_string fields

.. note::
  See :ref:`Enrich subcommand CLI reference <subcommand-enrich>` in :doc:`../cli/enrich` for full options and examples.


.. code-block:: bash

   cruiseplan validate -c my_cruise.yaml --check-depths

.. figure:: ../_static/screenshots/validate_command_results.png
   :alt: Validation results showing successful checks and warnings
   :width: 700px
   :align: center
   
   Configuration validation with station-specific error messages and depth checks

**Validation checks:**

- Required fields are present
- Operation type/action combinations are valid
- Coordinates are within valid ranges
- **Duplicate detection**: Station names, leg names must be unique
- **Potential duplicates**: Warns about stations with identical coordinates and operations
- Depth values are reasonable (if ``--check-depths`` specified)
- Leg definitions reference existing stations

**Common issues and solutions:**

.. list-table::
   :widths: 40 60
   :header-rows: 1

   * - **Error**
     - **Solution**
   * - "Missing operation_type"
     - Add ``operation_type`` field to all stations
   * - "Invalid action for CTD"
     - Use ``action: "profile"`` for CTD stations
   * - "Mooring missing duration"
     - Add ``duration: 180`` (or appropriate minutes) to mooring
   * - "Station not found in leg"
     - Check station names match exactly in leg definitions
   * - "Duplicate station name 'STN_X' found N times"
     - Rename duplicate stations to have unique names
   * - "Duplicate leg name 'LEG_X' found N times"  
     - Rename duplicate legs to have unique names
   * - "Potentially duplicate stations"
     - Review stations with identical coordinates - may be intentional

.. note::
  See :ref:`Validate subcommand CLI reference <subcommand-validate>` for full options and examples.

----

.. _generate_schedule_outputs:

Phase 3: Generate Schedule and Outputs
--------------------------------------

**Purpose:** Create detailed cruise timeline and export professional outputs.

.. code-block:: bash

   # Generate all output formats
   cruiseplan schedule -c my_cruise.yaml --format all
   
   # Or specific formats
   cruiseplan schedule -c my_cruise.yaml --format netcdf
   cruiseplan schedule -c my_cruise.yaml --format latex

.. figure:: ../_static/screenshots/schedule_generation.png
   :alt: Schedule generation process with progress output
   :width: 700px
   :align: center
   
   Schedule generation showing timeline calculations and output file creation

**Output formats:**

- **NetCDF**: CF-compliant scientific data files for analysis
- **HTML**: Interactive web summary with maps and tables
- **LaTeX**: Professional tables for cruise proposals/reports  
- **CSV**: Tabular data for Excel/analysis
- **KML**: Google Earth visualization

.. figure:: ../_static/screenshots/schedule_html_output.png
   :alt: Generated HTML schedule summary
   :width: 700px
   :align: center
   
   Professional HTML schedule output with timeline and station details

.. figure:: ../_static/screenshots/schedule_map_output.png
   :alt: Generated cruise track map
   :width: 700px
   :align: center
   
   Publication-ready cruise track map with stations and bathymetric background

**What you get:**

- Detailed timeline with arrival/departure times
- Transit distance and duration calculations
- Station operation durations
- Professional documentation ready for proposals

.. note::
  See :ref:`Schedule subcommand CLI reference <subcommand-schedule>` in :doc:`../cli/schedule` for full options and examples. 

