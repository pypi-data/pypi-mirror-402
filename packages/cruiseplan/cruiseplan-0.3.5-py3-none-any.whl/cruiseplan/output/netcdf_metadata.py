"""
Centralized NetCDF metadata management for CF-1.8 compliant outputs.

This module provides standardized metadata definitions and factory functions
for creating consistent NetCDF global attributes and variable attributes
across all NetCDF output types. Eliminates duplication and ensures adherence
to CF conventions.
"""

from datetime import datetime
from typing import Any

from cruiseplan.schema import CruiseConfig


# Global attributes factory functions
def create_global_attributes(
    feature_type: str,
    config: CruiseConfig,
    title_template: str,
    source: str = "YAML configuration file",
) -> dict[str, Any]:
    """
    Create standardized global attributes for NetCDF files.

    Parameters
    ----------
    feature_type : str
        CF feature type ("point", "trajectory", "timeSeries", etc.)
    config : CruiseConfig
        Cruise configuration object containing metadata
    title_template : str
        Template for the title (e.g., "Point Operations: {cruise_name}")
    source : str, optional
        Data source description

    Returns
    -------
    Dict[str, Any]
        Dictionary of global attributes following CF-1.8 conventions
    """
    return {
        "featureType": feature_type,
        "title": title_template.format(cruise_name=config.cruise_name),
        "institution": "Generated by CruisePlan software",
        "source": source,
        "Conventions": "CF-1.8",
        "cruise_name": config.cruise_name,
        "creation_date": datetime.now().replace(microsecond=0).isoformat(),
        "coordinate_system": "WGS84",
        "depth_datum": "Mean Sea Level",
    }


# Standard variable attribute templates
COORDINATE_VARIABLES = {
    "longitude": {
        "standard_name": "longitude",
        "long_name": "ship longitude",
        "units": "degrees_east",
    },
    "latitude": {
        "standard_name": "latitude",
        "long_name": "ship latitude",
        "units": "degrees_north",
    },
    "time": {
        "standard_name": "time",
        "long_name": "time of ship position",
        "units": "days since 1970-01-01 00:00:00",
        "calendar": "gregorian",
    },
}

# Updated depth variables with semantic clarity
DEPTH_VARIABLES = {
    "water_depth": {
        "standard_name": "sea_floor_depth_below_sea_surface",
        "long_name": "water depth at station location",
        "units": "meters",
        "positive": "down",
        "description": "Depth from sea level to seafloor at station location",
    },
    "operation_depth": {
        "standard_name": "depth",
        "long_name": "target operation depth",
        "units": "meters",
        "positive": "down",
        "description": "Target depth for operation (e.g., CTD cast depth)",
    },
    # Legacy depth variable for backward compatibility
    "waterdepth": {
        "long_name": "water depth",
        "units": "meters",
        "positive": "down",
        "description": "DEPRECATED: Use water_depth for seafloor depth or operation_depth for target operation depth",
    },
}

STATION_VARIABLES = {
    "station_name": {
        "long_name": "station identifier",
        "description": "Unique identifier for the sampling station",
    },
    "operation_type": {
        "long_name": "operation type",
        "description": "Type of scientific operation performed",
    },
    "action": {
        "long_name": "operation action",
        "description": "Specific action taken during the operation",
    },
    "duration": {
        "long_name": "operation duration",
        "units": "hours",
        "description": "Duration of the operation in hours",
    },
    "comment": {
        "long_name": "operation comment",
        "description": "Human-readable comment about the operation",
    },
}

SCHEDULE_VARIABLES = {
    "activity": {
        "long_name": "activity type",
        "description": "Type of cruise activity (Station, Transit, etc.)",
    },
    "label": {
        "long_name": "activity label",
        "description": "Human-readable label for the activity",
    },
    "start_time": {
        "standard_name": "time",
        "long_name": "activity start time",
        "units": "days since 1970-01-01 00:00:00",
        "calendar": "gregorian",
    },
    "end_time": {
        "standard_name": "time",
        "long_name": "activity end time",
        "units": "days since 1970-01-01 00:00:00",
        "calendar": "gregorian",
    },
    "duration_minutes": {
        "long_name": "activity duration",
        "units": "minutes",
        "description": "Duration of the activity in minutes",
    },
    "dist_nm": {
        "long_name": "distance",
        "units": "nautical_miles",
        "description": "Distance associated with this activity (transit distance or operation distance)",
    },
}

TRANSIT_VARIABLES = {
    "route_length": {
        "long_name": "route length",
        "units": "nautical_miles",
        "description": "Total length of the transit route",
    },
    "vessel_speed": {
        "long_name": "vessel speed",
        "units": "knots",
        "description": "Vessel speed during transit",
    },
}


def get_variable_attributes(variable_name: str) -> dict[str, Any]:
    """
    Get standardized attributes for a variable name.

    Parameters
    ----------
    variable_name : str
        Name of the variable to get attributes for

    Returns
    -------
    Dict[str, Any]
        Dictionary of variable attributes, empty dict if not found
    """
    # Check all variable dictionaries for the variable name
    for var_dict in [
        COORDINATE_VARIABLES,
        DEPTH_VARIABLES,
        STATION_VARIABLES,
        SCHEDULE_VARIABLES,
        TRANSIT_VARIABLES,
    ]:
        if variable_name in var_dict:
            return var_dict[variable_name].copy()

    # Return empty dict for unknown variables (will use defaults)
    return {}


def create_coordinate_variables(
    times, lats, lons, depths=None, operation_depths=None
) -> dict[str, tuple]:
    """
    Create standardized coordinate variable definitions for xarray Dataset.

    Parameters
    ----------
    times : array_like
        Time values
    lats : array_like
        Latitude values
    lons : array_like
        Longitude values
    depths : array_like, optional
        Water depth values (seafloor depth)
    operation_depths : array_like, optional
        Operation depth values (target depth for operations)

    Returns
    -------
    Dict[str, tuple]
        Dictionary of coordinate variable definitions for xarray.Dataset
    """
    coord_vars = {
        "latitude": (["obs"], lats, get_variable_attributes("latitude")),
        "longitude": (["obs"], lons, get_variable_attributes("longitude")),
    }

    if times is not None:
        coord_vars["time"] = (["obs"], times, get_variable_attributes("time"))

    if depths is not None:
        coord_vars["water_depth"] = (
            ["obs"],
            depths,
            get_variable_attributes("water_depth"),
        )

    if operation_depths is not None:
        coord_vars["operation_depth"] = (
            ["obs"],
            operation_depths,
            get_variable_attributes("operation_depth"),
        )

    return coord_vars


def create_operation_variables(
    names, types, actions, durations, comments=None
) -> dict[str, tuple]:
    """
    Create standardized operation variable definitions for xarray Dataset.

    Parameters
    ----------
    names : array_like
        Station/operation names
    types : array_like
        Operation types
    actions : array_like
        Operation actions
    durations : array_like
        Operation durations
    comments : array_like, optional
        Operation comments

    Returns
    -------
    Dict[str, tuple]
        Dictionary of operation variable definitions for xarray.Dataset
    """
    op_vars = {
        "station_name": (["obs"], names, get_variable_attributes("station_name")),
        "operation_type": (["obs"], types, get_variable_attributes("operation_type")),
        "action": (["obs"], actions, get_variable_attributes("action")),
        "duration": (["obs"], durations, get_variable_attributes("duration")),
    }

    if comments is not None:
        op_vars["comment"] = (["obs"], comments, get_variable_attributes("comment"))

    return op_vars
