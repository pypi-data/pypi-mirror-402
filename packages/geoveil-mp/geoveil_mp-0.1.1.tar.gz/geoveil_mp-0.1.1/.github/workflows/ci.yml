name: CI/CD

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Run Rust tests (no Python wheel)
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Run Rust tests
        run: cargo test --verbose

  # Build and test Python wheel using manylinux container
  test-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build wheel in manylinux container
        uses: PyO3/maturin-action@v1
        with:
          manylinux: 2_17
          args: --release --features python -i python3.10
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install and test
        run: |
          pip install target/wheels/*.whl
          python -c "import geoveil_mp as gm; print(f'Version: {gm.version()}')"

  # Build wheels for multiple platforms
  build-wheels:
    needs: [test, test-python]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Build wheel (Linux)
        if: runner.os == 'Linux'
        uses: PyO3/maturin-action@v1
        with:
          manylinux: 2_17
          args: --release --strip --features python -i python${{ matrix.python-version }}
          
      - name: Build wheel (Windows/macOS)
        if: runner.os != 'Linux'
        run: |
          pip install maturin
          maturin build --release --strip --features python
        
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python-version }}
          path: target/wheels/*.whl

  # Publish to PyPI on tag
  publish:
    needs: build-wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/geoveil-mp
    permissions:
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: wheels
          merge-multiple: true
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install maturin
        run: pip install maturin
        
      - name: Build source distribution
        run: maturin build --release --sdist --features python
        
      - name: Collect all wheels
        run: |
          mkdir -p dist
          cp wheels/*.whl dist/ || true
          cp target/wheels/*.tar.gz dist/ || true
          ls -la dist/
          
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
