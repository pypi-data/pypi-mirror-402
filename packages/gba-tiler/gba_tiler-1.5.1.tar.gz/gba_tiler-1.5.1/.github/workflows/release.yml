name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag format
        id: validate
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "Tag: $TAG"
          
          # Match stable releases only (v1.2.3)
          # Exclude pre-releases: v1.2.3a1, v1.2.3-alpha1, v1.2.3b2, v1.2.3-beta2, v1.2.3rc3, v1.2.3-rc3
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "✓ Stable release tag detected: $TAG"
            echo "is_stable=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc|a|b)[0-9]+|a[0-9]+|b[0-9]+|rc[0-9]+)$ ]]; then
            echo "⊘ Pre-release tag detected: $TAG (skipping GitHub release)"
            echo "is_stable=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Invalid tag format: $TAG"
            exit 1
          fi

      - name: Create GitHub Release
        if: steps.validate.outputs.is_stable == 'true'
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Installation
            
            ```bash
            pip install gba-tiler==${{ github.ref_name }}
            ```
            
            ## PyPI Package
            
            https://pypi.org/project/gba-tiler/${{ github.ref_name }}/
            
            ## Changes
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for details.
