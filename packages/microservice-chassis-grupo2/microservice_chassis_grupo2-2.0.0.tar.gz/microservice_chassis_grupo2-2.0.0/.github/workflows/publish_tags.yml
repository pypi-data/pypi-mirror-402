name: Publish (tags)

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade build twine setuptools_scm[toml]

      - name: Debug versioning (must match the tag)
        run: |
          echo "GITHUB_REF_NAME=${GITHUB_REF_NAME}"
          git describe --tags --dirty --always || true
          python -c "from setuptools_scm import get_version; print('setuptools_scm version ->', get_version())"

      - name: Clean build artifacts
        run: |
          rm -rf dist build *.egg-info

      - name: Build package
        run: |
          python -m build

      - name: Twine check
        run: |
          python -m twine check dist/*

      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI }}
        run: |
          python -m twine upload dist/*
