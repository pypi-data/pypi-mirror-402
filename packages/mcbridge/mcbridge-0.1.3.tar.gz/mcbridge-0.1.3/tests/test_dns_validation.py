from pathlib import Path

import pytest


def test_dns_override_template_emits_cname_for_hostname(mcbridge_modules):
    _, _, ap, dns = mcbridge_modules

    override_block = dns._dns_override_template({"target": "example.test", "redirect": "keep.example", "enabled": True})
    ap_override_block = ap._dns_override_template({"target": "example.test", "redirect": "keep.example", "enabled": True})

    assert "cname=keep.example,example.test" in override_block
    assert "address=/keep.example/" not in override_block
    assert "cname=keep.example,example.test" in ap_override_block
    assert "address=/keep.example/" not in ap_override_block


def test_dns_override_template_emits_address_for_ip(mcbridge_modules, tmp_path: Path):
    _, _, ap, dns = mcbridge_modules

    override_block = dns._dns_override_template({"target": "192.0.2.9", "redirect": "keep.example", "enabled": True})
    ap_override_block = ap._dns_override_template({"target": "192.0.2.9", "redirect": "keep.example", "enabled": True})

    assert "address=/keep.example/192.0.2.9" in override_block
    assert "cname=keep.example" not in override_block
    assert "address=/keep.example/192.0.2.9" in ap_override_block
    assert "cname=keep.example" not in ap_override_block


def test_normalise_ap_section_body_splits_combined_directives(mcbridge_modules, tmp_path: Path):
    _, _, _, dns = mcbridge_modules

    combined_body = "\n".join(
        [
            "",
            dns.MANAGE_AP_SECTION_START,
            "# Generated by mcbridge manage-ap",
            "interface=wlan0ap bind-interfaces",
            "dhcp-range=192.168.50.10,192.168.50.60,12h dhcp-option=3,192.168.50.1 dhcp-option=6,192.168.50.1",
            dns.MANAGE_AP_SECTION_END,
            "",
        ]
    )

    normalised = dns._normalise_ap_section_body(combined_body)

    lines = [line.strip() for line in normalised.splitlines() if line.strip()]
    assert "interface=wlan0ap" in lines
    assert "bind-interfaces" in lines
    assert "dhcp-range=192.168.50.10,192.168.50.60,12h" in lines
    assert "dhcp-option=3,192.168.50.1" in lines
    assert "dhcp-option=6,192.168.50.1" in lines


def test_dnsmasq_template_includes_override_body_once(mcbridge_modules, tmp_path: Path):
    _, _, ap, dns = mcbridge_modules
    override_body = dns._dns_override_template({"target": "redirect.test", "redirect": "keep.example", "enabled": True})

    rendered = ap._dnsmasq_template({"ssid": "Minecraft", "subnet_octet": 55}, override_body=override_body)

    assert rendered.count(ap.MANAGE_AP_SECTION_START) == 1
    assert rendered.count(ap.MANAGE_DNSMASQ_SECTION_START) == 1
    assert "cname=keep.example,redirect.test" in rendered
    assert "dhcp-range=192.168.55.10,192.168.55.60,12h" in rendered


def test_deduplicate_managed_sections_rebuilds_dnsmasq(mcbridge_modules, tmp_path: Path):
    _, _, ap, _ = mcbridge_modules

    duplicated = "\n".join(
        [
            ap.MANAGE_AP_SECTION_START,
            "interface=wlan0ap",
            ap.MANAGE_AP_SECTION_END,
            ap.MANAGE_AP_SECTION_START,
            "interface=wlan0ap",
            ap.MANAGE_AP_SECTION_END,
            ap.MANAGE_DNSMASQ_SECTION_START,
            "# overrides disabled",
            ap.MANAGE_DNSMASQ_SECTION_END,
        ]
    )

    cleaned, deduped = ap._deduplicate_managed_sections(duplicated)

    assert deduped is True
    assert cleaned.count(ap.MANAGE_AP_SECTION_START) == 1
    assert cleaned.count(ap.MANAGE_DNSMASQ_SECTION_START) == 1
    assert "# overrides" in cleaned
