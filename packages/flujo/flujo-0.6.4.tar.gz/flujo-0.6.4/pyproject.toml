[build-system]
requires      = ["hatchling"]
build-backend = "hatchling.build"

# --------------------------------------------------------------------------- #
# Core project metadata (PEP 621)
# --------------------------------------------------------------------------- #
[project]
name = "flujo"
version = "0.6.4"  # Security: fix CVEs in mcp, starlette, remove pytest-forked
description = "A modern, type-safe framework for building AI-powered applications with structured outputs and robust error handling."
readme = "README.md"
license = {text = "AGPL-3.0"}
requires-python = ">=3.13"
keywords = ["ai", "llm", "pipeline", "workflow", "agent", "async", "type-safe"]
authors = [
    {name = "Alvaro Andres Alvarez", email = "aandresalvarez@gmail.com"}
]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: GNU Affero General Public License v3",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "Topic :: Scientific/Engineering :: Artificial Intelligence",
    "Typing :: Typed",
]
dependencies = [
    "pydantic>=2.11.7,<2.13",
    "pydantic-ai>=1.0.15,<1.26.0",
    "openai>=2.1.0,<3.0",
    "pydantic-settings>=2.0.0",
    "aiosqlite>=0.19.0",
    "anyio>=4.0.0",
    "tenacity>=8.2.0",
    "typer>=0.16.1",
    "rich>=13.0.0",
    "pydantic-evals>=0.4.7",
    "uvloop>=0.19.0; sys_platform != 'win32'", # Performance optimization for Unix systems
    "orjson>=3.9.0", # Faster JSON serialization
    "blake3>=0.4.0", # Faster cryptographic hashing
    "numpy>=1.20.0",
    "PyYAML>=6.0",
    "ruamel.yaml>=0.18",
     # Security: pin transitive deps to fix CVEs
     "mcp>=1.23.0",  # Fix GHSA-9h52-p55h-vw2f (DNS rebinding)
     "starlette>=0.49.1",  # Fix GHSA-7f5h-v6xp-fcq8
]
# Optional dependency groups (install with: `pip install .[dev]`, etc.)
[project.optional-dependencies]
dev = [
  "ruff==0.14.10",
  "mypy==1.12.0",
  "pip-audit==2.7.3",
  "pytest==8.3.3",
  "pytest-cov==5.0.0",
  "pytest-asyncio==0.24.0",
  "pytest-xdist==3.6.1",  # Added for parallel test execution
  "pytest-timeout==2.3.1",  # Hard kill hanging tests
   # pytest-forked removed: depends on 'py' package with unfixed CVE PYSEC-2022-42969
  "pytest-randomly==3.15.0",  # Randomize test order
  "pytest-rerunfailures==13.0",
  "pytest-picked==0.4.6",  # Alternative to testmon
  "pytest-split==0.10.0",  # Deterministic sharding for CI
  "pytest-deadfixtures==2.2.1",  # Find unused fixtures
  "hypothesis==6.112.0",
  "vcrpy==6.0.1",
  "build==1.2.2.post1",     # Added for package building
  "twine==5.1.1",     # Added for package uploading
  "pytest-benchmark==4.0.0",
  "bandit==1.7.9",
  "cyclonedx-python-lib==7.4.0",  # SBOM library (used by pip-audit output)
   "logfire==4.0.0", # Updated for compatibility with pydantic-graph 0.4.7
   "sqlvalidator==0.0.8",
  "prometheus-client==0.22.1",  # Required for prometheus tests
  "httpx==0.28.1",  # Required for prometheus integration tests (compatible with google-genai)
]
"aop-extras" = [
  "pyjson5>=1.6; python_version>='3.8'",
  "json-repair>=0.16",
]
skills = [
  "ddgs",
  "httpx",
  "aiofiles",
  "pyfiglet",
]
docker = [
  "docker>=7.0.0; python_version < '3.13'",
]
pii = [
  "presidio-analyzer>=2.2.0",
  "presidio-anonymizer>=2.2.0",
]
docs = [
    "mkdocs",
    "mkdocs-material", # Added for a professional theme
    "mkdocstrings[python]",
    "mkdocs-redirects",
]
opentelemetry = ["opentelemetry-sdk>=1.26", "opentelemetry-exporter-otlp-proto-http>=1.26"]
lens = [
  "opentelemetry-sdk>=1.20,<2.0",
  "opentelemetry-exporter-otlp-proto-http>=1.20,<2.0",
  "prometheus-client>=0.22.1,<0.23.0",
]
bench = [
    "pytest-benchmark>=4.0.0",
    "numpy>=1.20.0",
]
logfire = ["logfire>=4.0.0"] # Updated for compatibility with pydantic-graph 0.4.7
sql = ["sqlvalidator>=0.0.8"]
templating = ["Jinja2>=3.1"]
yaml_tools = ["ruamel.yaml>=0.18"]
postgres = ["asyncpg>=0.29.0"]

# Prometheus-related dependencies (install with: `pip install .[prometheus]`)
prometheus = [
    "prometheus-client>=0.22.1,<0.23.0"
]

# CLI entry point (install adds `flujo` command to PATH)
[project.scripts]
flujo = "flujo.cli.main:app"

# Project links (PEP 621)
[project.urls]
Homepage = "https://github.com/aandresalvarez/flujo"
Repository = "https://github.com/aandresalvarez/flujo"
Documentation = "https://aandresalvarez.github.io/flujo/"
Bug_Tracker = "https://github.com/aandresalvarez/flujo/issues"
Changelog = "https://github.com/aandresalvarez/flujo/blob/main/CHANGELOG.md"

# --------------------------------------------------------------------------- #
# Tool-specific configuration
# --------------------------------------------------------------------------- #
[tool.mypy]
python_version = "3.13"
strict         = true
plugins = ["pydantic.mypy"]

# Focus type checking on the core library first. Examples are excluded as they are
# meant to be educational and may not follow strict typing.
exclude = [
    "examples/.*",
    "flujo/telemetry/prometheus.py",
    ".*/site-packages/",
]

# Allow third-party libraries that do not ship type information.
[[tool.mypy.overrides]]
module = [
    "pydantic_ai.*",
    "pydantic_evals",
    "tenacity",
    "yaml",
    "duckduckgo_search",
    "ddgs",
    "tomli",
    "sqlvalidator",
    "vcr",
    "logfire",
  "numpy",
  "orjson",
  "json5",
  "pyjson5",
  "blake3",
    "xxhash",
    "opentelemetry.sdk.trace",
    "opentelemetry.sdk.trace.export"
]
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = [
    "aiosqlite",
    "aiofiles",
]
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = [
    "opentelemetry",
    "opentelemetry.sdk",
    "opentelemetry.exporter.otlp.proto.http.trace_exporter",
    "prometheus_client",
    "prometheus_client.core",
    "prometheus_client.registry",
]
ignore_missing_imports = true

# Exclude external libraries with known mypy issues
[[tool.mypy.overrides]]
module = [
    "pydantic_ai.*",
]
ignore_errors = true

# Known mypy limitation with async wrapper patterns in step_logic
[[tool.mypy.overrides]]
module = "flujo.application.core.step_logic"
disable_error_code = ["no-any-return"]

[[tool.mypy.overrides]]
module = [
    # Validation/linting modules with complex dynamic logic
    "flujo.validation.linters_orchestration",
    "flujo.validation.linters_extended",
    # Execution finalization with async patterns
    "flujo.application.core.execution.execution_manager_finalization",
    # Mermaid generation with complex string handling
    "flujo.domain.dsl.pipeline_mermaid",
]
ignore_errors = true


# Coverage configuration to make reports robust across environments
[tool.coverage.run]
source = ["flujo"]
parallel = true
relative_files = true

[tool.coverage.report]
show_missing = true
skip_empty = true

[tool.coverage.paths]
source = [
  "flujo",
  "*/work/flujo/flujo/flujo",
  "*/Documents/Code/flujo/flujo",
]


# Relax mypy on complex, dynamically-typed policy and executor modules
[[tool.mypy.overrides]]
module = [
  "flujo.application.core.step_policies",
  "flujo.application.core.execution.execution_manager",
  "flujo.application.core.step_executor",
  "flujo.domain.dsl.step",
]
disable_error_code = [
  "no-any-return",
  "union-attr",
  "attr-defined",
  "arg-type",
  "call-arg",
  "type-arg",
  "misc",
  "assignment",
]

[[tool.mypy.overrides]]
module = [
  "flujo.domain.validation",
]
disable_error_code = [
  "misc",
]

[[tool.mypy.overrides]]
module = [
  "flujo.infra.settings",
]
disable_error_code = [
  "no-any-return",
]

[[tool.mypy.overrides]]
module = [
  "flujo.application.core.execution.loop_executor",
  "flujo.plugins.sql_validator",
  "flujo.application.runner",
]
disable_error_code = [
  "no-untyped-def",
  "no-any-return",
  "union-attr",
  "assignment",
  "redundant-cast",
  "attr-defined",
]

[[tool.mypy.overrides]]
module = [
  "flujo.domain.blueprint.loader",
  "flujo.domain.blueprint.model_generator",
]
disable_error_code = [
  "no-any-return",
  "valid-type",
  "arg-type",
  "attr-defined",
  "misc",
  "no-untyped-def",
]

[[tool.mypy.overrides]]
module = [
  "flujo.state.backends.sqlite",
]
disable_error_code = [
  "misc",
]

[[tool.mypy.overrides]]
module = [
  "asyncpg",
  "asyncpg.*",
]
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = [
  "flujo.cli.helpers",
  "flujo.cli.main",
]
disable_error_code = [
  "no-untyped-call",
  "no-any-return",
]

[[tool.mypy.overrides]]
module = [
  "flujo.telemetry.prometheus",
]
disable_error_code = [
  "arg-type",
]


[tool.ruff]
line-length = 100

[tool.ruff.lint]
per-file-ignores = { "tests/benchmarks/*.py" = ["E402"], "tests/unit/test_extract.py" = ["E402"] }


[tool.pytest.ini_options]
# Note: asyncio_mode is deprecated in pytest 8+, using pytest-asyncio auto mode
asyncio_mode = "auto"
# asyncio_default_fixture_loop_scope = "function"  # Disabled: deprecated in pytest-asyncio 0.24+ / pytest 8+
testpaths = ["tests", "tests/architecture"]
norecursedirs = [
  ".hypothesis",  # Ensure Hypothesis' workdir is ignored to avoid plugin warnings
  "bug_reports",
  "manual_testing",
  "scripts",
  "dist",
  "build",
  "output",
  ".venv",
  "venv",
  ".git",
]
markers = [
  "e2e: marks tests as end-to-end (requires network access or VCR cassettes)",
  "benchmark: marks tests as benchmarks (requires pytest-benchmark)",
  "asyncio: marks tests as async (handled by pytest-asyncio)",
  "anyio: marks tests that use anyio's event loop and concurrency primitives",
  "serial: marks tests that must run serially to avoid concurrency issues",
  "slow: marks tests that are slow and should be run separately",
  "veryslow: marks extremely slow tests that must never run in fast suites",
  "ultra_slow: marks ultra-long stress tests; excluded from fast suites",
  "fast: marks tests that are fast and can be run in parallel",
  "integration: marks integration tests for subsystems like the Architect",
  "no_collect: marks classes that should not be collected as test classes",
  "stress: marks stress/resource tests",
  "memory: marks memory-focused tests",
  "timeout: marks tests with custom timeout (override global)",
  "hypothesis: marks property-based tests (requires hypothesis)",
]
filterwarnings = [
  "ignore:coroutine 'AsyncMockMixin._execute_mock_call' was never awaited:RuntimeWarning",
  "ignore::pytest.PytestUnraisableExceptionWarning",
  "ignore::pytest.PytestDeprecationWarning",
  "ignore::pytest.PytestUnhandledThreadExceptionWarning",

]
# Global test execution guardrails (safe options that don't require plugins)
addopts = [
  "--strict-markers",
  "--strict-config",
  "--tb=short",
  "-ra",  # Show xfailed/xpassed/skip reasons
  "--durations=25",  # List top 25 slowest tests
  "--durations-min=0.5",  # Only report if slower than 0.5s
  "-q",  # Quiet by default; Makefile can override with -v
]
# Note: timeout and faulthandler options are set per-target in Makefile
# to ensure proper plugin loading
# Performance optimization: disable output capture for faster execution
# addopts = ["--no-cov", "--tb=short"]  # Uncomment for maximum speed

# Force pytest-asyncio plugin loading for all test runs
# Only enforce pytest-asyncio; pytest-anyio is optional in CI images.
required_plugins = ["pytest-asyncio"]

# --------------------------------------------------------------------------- #
# Build system configuration
# --------------------------------------------------------------------------- #
[tool.hatch.build.targets.wheel]
packages = ["flujo"]
include = [
    "flujo/py.typed",
]

[tool.hatch.build.targets.sdist]
include = [
    "flujo",
    "tests",
    "docs",
    "examples",
    "README.md",
    "LICENSE",
    "CHANGELOG.md",
    "pyproject.toml",
]


[tool.hatch.build.targets.wheel.shared-data]
"README.md" = "share/doc/flujo/README.md"
"LICENSE" = "share/doc/flujo/LICENSE"
"CHANGELOG.md" = "share/doc/flujo/CHANGELOG.md"

# Note: This project uses uv for dependency management and development workflow.
# The Makefile provides convenient commands that use uv under the hood.
# For local development, use: make install, make test, make all, etc.

# Suppress LogfireNotConfiguredWarning for users who do not enable Logfire
[tool.logfire]
ignore_no_config = true

[dependency-groups]
dev = [
]
