name: FlujoArchitect-GPT5
version: "2.0"

agents:
  architect_agent:
    model: "openai:gpt-5"
    model_settings:
      reasoning: { effort: "high" }
      text: { verbosity: "low" }
    system_prompt: |
      You are the Flujo AI Architect. Your goal is to convert a user's high-level objective into a complete and valid `flujo pipeline.yaml` file.

      You will be given the user's goal and a list of available built-in skills.

      YOUR PROCESS:
      1.  Decompose the user's goal into a logical sequence of discrete steps.
      2.  Implement each step. You have two choices for implementation:
          a.  If a built-in skill perfectly matches the step's purpose, use it by setting `agent: {id: "skill_id"}`.
          b.  If no skill is a perfect match, you MUST design a new, lightweight LLM agent for that step. Define this new agent under the top-level `agents:` section and reference it with `uses: agents.<new_agent_name>`.
      3.  Assemble the complete, valid `pipeline.yaml` string.

      OUTPUT REQUIREMENTS:
      - The output MUST be a Pydantic model: `YamlWriter(yaml_text: str)`.
      - The `yaml_text` field MUST contain ONLY the raw YAML string.
      - Do NOT include any explanations, apologies, or markdown formatting in your response.
    output_schema:
      type: object
      properties:
        yaml_text: { type: string }
      required: [yaml_text]

  repair_agent:
    model: "openai:gpt-5"
    model_settings:
      reasoning: { effort: "medium" }
      text: { verbosity: "high" }
    timeout: 120
    system_prompt: |
      You are a Flujo YAML debugger. You will receive an invalid YAML snippet and a validation error report.
      Your task is to fix the YAML and return the corrected version.
      The output MUST be a Pydantic model: `YamlWriter(yaml_text: str)`.
    output_schema:
      type: object
      properties:
        yaml_text: { type: string }
      required: [yaml_text]

steps:
  # STEP 1: Design & Build
  - kind: step
    name: DesignAndBuildBlueprint
    uses: agents.architect_agent
    updates_context: true
    # Provide both goal and available skills as a single, structured prompt
    input: |
      USER_GOAL:
      {{ context.user_goal }}

      AVAILABLE_SKILLS_JSON:
      {{ context.available_skills }}

  # STEP 2: Validate & Repair loop
  - kind: loop
    name: ValidateAndRepair
    loop:
      max_loops: 2
      exit_condition: "flujo.builtins:exit_when_yaml_valid"
      body:
        - kind: step
          name: ExtractYamlForValidation
          agent:
            id: "flujo.builtins.extract_yaml_text"
        - kind: step
          name: ValidateGeneratedYAML
          agent:
            id: "flujo.builtins.validate_yaml"
        - kind: step
          name: SetValidationFlag
          agent:
            id: "flujo.builtins.validation_report_to_flag"
          updates_context: true
        - kind: conditional
          name: ValidityBranch
          condition: "flujo.utils.context:predicate_is_valid_report"
          branches:
            valid:
              - kind: step
                name: Finish
                agent:
                  id: "flujo.builtins.passthrough"
            invalid:
              - kind: step
                name: RepairBlueprint
                uses: agents.repair_agent
                updates_context: true
                # Provide both the invalid YAML and the validation report
                input: |
                  CURRENT_YAML:
                  {{ context.generated_yaml or context.yaml_text or '' }}

                  VALIDATION_REPORT_JSON:
                  {{ previous_step }}
