version: "0.1"
name: "test_hitl_nested_context"
description: "Test YAML to trigger HITL-NESTED-001 validation ERROR for HITL in conditional branches within loops"

# Note: HITL directly inside a loop body (without a conditional) is allowed and should
# not trigger HITL-NESTED-001. This fixture focuses solely on the unsupported patterns.

steps:
  # This should trigger HITL-NESTED-001 ERROR - HITL inside conditional
  - kind: conditional
    name: check_status
    condition_expression: "true"
    branches:
      true:
        # ❌ HITL-NESTED-001 ERROR: HITL step inside conditional (SILENTLY SKIPPED AT RUNTIME)
        - kind: hitl
          name: ask_user_in_conditional
          message: "Need input?"
          sink_to: "import_artifacts.input"
        
        - kind: step
          name: process
          agent:
            id: "flujo.builtins.passthrough"
          input: "Processing..."
  
  # This should trigger HITL-NESTED-001 ERROR - HITL inside conditional inside loop (WORST CASE)
  - kind: loop
    name: nested_loop
    loop:
      body:
        - kind: conditional
          name: check_nested
          condition_expression: "true"
          branches:
            true:
              # ❌ HITL-NESTED-001 CRITICAL ERROR: HITL step inside conditional inside loop (GUARANTEED SILENT FAILURE)
              - kind: hitl
                name: ask_user_deeply_nested
                message: "Deeply nested question?"
                sink_to: "import_artifacts.nested_answer"
      
      max_loops: 2
  
  # ✅ This should NOT trigger HITL-NESTED-001 - top-level HITL is fine
  - kind: hitl
    name: ask_user_top_level
    message: "This is fine - top-level HITL"
    sink_to: "import_artifacts.top_level_answer"
