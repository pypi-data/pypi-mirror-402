import{w as Ht,h as lt,p as U,$ as pt,f as M,a as j,g as e,b as d,c as I,r as A,s as S,t as G,n as bt,u as re,d as Rt,e as ot}from"../chunks/Yb_TZ_Rf.js";import{G as de}from"../chunks/BDOtEUpJ.js";import{u as J}from"../chunks/C3A6m4-m.js";import"../chunks/CWj6FrbW.js";import{c as V,a as m,f as B,t as At,b as ce}from"../chunks/DnGquTil.js";import{i as T,s as R,a as X,b as Tt,m as Ut}from"../chunks/DVJdaASW.js";import{S as jt}from"../chunks/CI5--nSk.js";import{b as ue,a as me}from"../chunks/DtWZc_tl.js";import{S as ve}from"../chunks/DnCfFZRi.js";import{r as K}from"../chunks/Bz2KBNfb.js";import{e as xt}from"../chunks/BwfxcG-Y.js";import{s as St}from"../chunks/DTWlVeDn.js";import{s as yt,e as ge,u as fe,k as _e,b as he,a as pe,t as It}from"../chunks/Dcv4bg-q.js";import{g as st,d as be,c as Ae}from"../chunks/C1bEftoN.js";import{U as xe,O as Ie,ap as Kt,aq as Se,ar as ye,as as we,at as De,au as Ce,M as qt,S as Pe,c as ke,C as zt,y as Vt,z as Me,u as Be,v as Ee,K as Ne,a as Le,B as Fe}from"../chunks/DcA8i6zt.js";import"../chunks/CvGjimpO.js";import"../chunks/BztKn-jM.js";import"../chunks/69_IOA4Y.js";import{p as q}from"../chunks/CnA6nQDP.js";import{S as Re}from"../chunks/xmQHzaB1.js";import{S as Te}from"../chunks/DOL8rH4R.js";import{Z as Ue,I as je,a as Oe}from"../chunks/_l1FkI_E.js";import{S as He}from"../chunks/AfXAZz1B.js";import{f as Ot}from"../chunks/DELrRF6e.js";import{A as Ke}from"../chunks/CtIwLgFN.js";import{s as Z}from"../chunks/CGH6oPk7.js";import{j as qe,k as ze,a as Ve,e as Qe,l as We,m as Ge}from"../chunks/BQhJr0Qw.js";import{B as Ze,a as Ye,b as it,c as _t,H as Je,d as ht,D as Xe,e as $e}from"../chunks/Dqab5VQB.js";import{C as ta}from"../chunks/Bo4LlNYj.js";import{S as ea}from"../chunks/bxODVucJ.js";import{F as aa}from"../chunks/Dkrl7KTO.js";const na=({annotationIndex:i,...t})=>{const a=Ht({isLoading:!1});return(async()=>{a.update(n=>({...n,isLoading:!0}));try{const{data:n}=await de({path:{collection_id:t.collection_id},query:{cursor:i>0?i-1:0,limit:3,annotation_label_ids:t.annotation_label_ids,tag_ids:t.tag_ids}});if(!n){a.update(r=>({...r,isLoading:!1,error:"No annotations data received",data:void 0}));return}const{setfilteredAnnotationCount:o}=J();o(n.total_count);let s;const c=i>0?n.data[0]:void 0;n.data.length>1&&(s=i===0?n.data[1]:n.data[2]),a.update(r=>({...r,isLoading:!1,error:void 0,data:{annotationNext:s,annotationPrevious:c}}))}catch(n){a.update(o=>({...o,isLoading:!1,error:String(n)}))}})(),a},oa=async({parent:i,params:{collection_id:t,annotationId:a,annotationIndex:l}})=>{const{annotationsSelectedTagsIds:n,annotationsSelectedAnnotationLabelsIds:o,collection:s}=await i(),c=parseInt(l,10),r=Ht();if(!s)throw new Error("Collection data not found");return na({annotationIndex:c,collection_id:t,currentAnnotationId:a,annotation_label_ids:Array.from(lt(o)),tag_ids:Array.from(lt(n))}).subscribe(({data:v})=>{r.set(v)}),{annotationAdjacents:r,annotationIndex:c,annotationId:a,collection:s}},cn=Object.freeze(Object.defineProperty({__proto__:null,load:oa},Symbol.toStringTag,{value:"Module"}));var ia=B('<div data-testid="annotation-navigation"><!></div>');function la(i,t){U(t,!0);const a=()=>R(e(s),"$annotationAdjacents",l),[l,n]=X(),o=d(()=>q.data.annotationIndex),s=d(()=>q.data.annotationAdjacents),c=q.data.collectionId,r=()=>{a().annotationNext&&st(K.toSampleWithAnnotation({collectionId:c,sampleId:a().annotationNext.parent_sample_id,annotationId:a().annotationNext.sample_id,annotationIndex:e(o)+1}),{invalidateAll:!0})},v=()=>{a().annotationPrevious&&st(K.toSampleWithAnnotation({collectionId:c,sampleId:a().annotationPrevious.parent_sample_id,annotationId:a().annotationPrevious.sample_id,annotationIndex:e(o)-1}),{invalidateAll:!0})},x=h=>{switch(h.key){case"ArrowRight":r();break;case"ArrowLeft":v();break}};var g=V();xt("keydown",pt,x);var w=M(g);{var D=h=>{var C=ia(),L=I(C);{let N=d(()=>!!a().annotationPrevious),y=d(()=>!!a().annotationNext);He(L,{get hasPrevious(){return e(N)},get hasNext(){return e(y)},onPrevious:v,onNext:r})}A(C),m(h,C)};T(w,h=>{a()&&h(D)})}m(i,g),j(),n()}var sa=B('<span class="text-sm"> </span> <span class="break-all text-sm"> </span>',1);function ra(i,t){var a=sa(),l=M(a),n=I(l,!0);A(l);var o=S(l,2),s=I(o,!0);A(o),G(()=>{Z(n,t.label),yt(o,"data-testid",`annotation-metadata-${t.id}`),Z(s,t.value)}),m(i,a)}var da=B('<span class="break-all text-sm"> </span>'),ca=B('<span class="text-sm"> </span> <!>',1);function ua(i,t){U(t,!0);const a=()=>R(s,"$result",n),l=()=>R(t.isEditingMode,"$isEditingMode",n),[n,o]=X(),s=xe({collectionId:t.collectionId}),{addReversibleAction:c}=J(),{updateAnnotation:r,refetch:v}=Ie({collectionId:t.collectionId,annotationId:t.annotationId,onUpdate:t.onUpdate}),{updateAnnotations:x}=Kt({collectionId:t.collectionId}),g=d(()=>De(a().data||[])),w=d(()=>{const p=e(g).find(b=>b.value===t.value);return p||{value:t.value,label:t.value}});var D=ca(),h=M(D),C=I(h,!0);A(h);var L=S(h,2);{var N=p=>{{const b=(u,f)=>{let E=()=>f==null?void 0:f().inputValue;we(u,{get label(){return E()}})};let k=d(()=>e(g).find(u=>{var f;return u.value===((f=e(w))==null?void 0:f.value)}));Se(p,{get items(){return e(g)},get selectedItem(){return e(k)},name:"annotation-label",placeholder:"Select or create a label",onSelect:u=>{ye({annotations:[{sample_id:t.annotationId,annotation_label:{annotation_label_name:t.value}}],collectionId:t.collectionId,addReversibleAction:c,updateAnnotations:x,refresh:v}),r({annotation_id:t.annotationId,collection_id:t.collectionId,label_name:u.value})},notFound:b,$$slots:{notFound:!0}})}},y=p=>{var b=da();yt(b,"data-testid","annotation-metadata-label");var k=I(b,!0);A(b),G(()=>Z(k,t.value)),m(p,b)};T(L,p=>{l()?p(N):p(y,!1)})}G(()=>Z(C,t.label)),m(i,D),j(),o()}var ma=B('<div class="flex flex-col gap-4"><div class="grid grid-cols-[6rem_1fr] gap-y-3 text-diffuse-foreground"></div></div>');function va(i,t){U(t,!0);const{collectionId:a}=q.data,l=d(()=>{var v,x;if(!t.annotation)return[];let r=[{id:"label",label:"Label:",value:(x=(v=t.annotation)==null?void 0:v.annotation_label)==null?void 0:x.annotation_label_name},{id:"type",label:"Type:",value:Ke[t.annotation.annotation_type]||"Unknown"}];if(t.annotation&&!Ce(t.annotation)){const{height:g,width:w}=qt(t.annotation);r=[{id:"height",label:"Height:",value:Ot(Math.round(g))+"px"},{id:"width",label:"Width:",value:Ot(Math.round(w))+"px"},...r]}return r}),{isEditingMode:n}=q.data.globalStorage;var o=V(),s=M(o);{var c=r=>{Pe(r,{title:"Annotation details",children:(v,x)=>{var g=ma(),w=I(g);ge(w,21,()=>e(l),({label:D,value:h,id:C})=>D,(D,h)=>{let C=()=>e(h).label,L=()=>e(h).value,N=()=>e(h).id;var y=V(),p=M(y);{var b=u=>{ua(u,{get onUpdate(){return t.onUpdate},get annotationId(){return t.annotation.sample_id},get collectionId(){return a},get label(){return C()},get value(){return L()},get isEditingMode(){return n}})},k=u=>{ra(u,{get label(){return C()},get id(){return N()},get value(){return L()}})};T(p,u=>{N()==="label"&&n?u(b):u(k,!1)})}m(D,y)}),A(w),A(g),m(v,g)}})};T(s,r=>{e(l).length>0&&r(c)})}m(i,o),j()}const ga=()=>{const i=ke(qe());return i.subscribe(()=>{}),{removeTagFromAnnotation:(a,l)=>new Promise((n,o)=>{lt(i).mutate({path:{annotation_id:a,tag_id:l}},{onSuccess:()=>n(),onError:s=>o(s)})})}};var fa=B('<div class="flex h-full min-h-0 flex-col space-y-4 overflow-hidden dark:[color-scheme:dark]"><!> <!> <!></div>');function _a(i,t){U(t,!0);const{removeTagFromAnnotation:a}=ga(),l=d(()=>{var o;return((o=t.annotation.tags)==null?void 0:o.map(s=>({tagId:s.tag_id,name:s.name})))??[]}),n=async o=>{await a(t.annotation.sample_id,o)};zt(i,{className:"h-full",children:(o,s)=>{Vt(o,{className:"h-full flex flex-col",children:(c,r)=>{var v=fa(),x=I(v);Me(x,{get tags(){return e(l)},onClick:n});var g=S(x,2);va(g,{get annotation(){return t.annotation},get onUpdate(){return t.onUpdate}});var w=S(g,2);St(w,()=>t.sampleDetails),A(v),m(c,v)},$$slots:{default:!0}})},$$slots:{default:!0}}),j()}var ha=B('<!> <span class="hidden sm:inline">Home</span>',1),pa=B('<!> <span class="max-w-[150px] truncate"> </span>',1),ba=B('<!> <span class="hidden sm:inline">Annotations</span>',1),Aa=B('<!> <span class="max-w-[200px] truncate"><!></span>',1),xa=B("<!> <!> <!> <!> <!> <!> <!>",1);function Ia(i,t){U(t,!0);const a=()=>R(o,"$filteredAnnotationCount",l),[l,n]=X(),{filteredAnnotationCount:o}=J();Ze(i,{class:"mb-2",children:(s,c)=>{Ye(s,{children:(r,v)=>{var x=xa(),g=M(x);it(g,{children:(y,p)=>{{let b=d(()=>K.toCollectionHome(t.rootCollection.collection_id));_t(y,{get href(){return e(b)},class:"flex items-center gap-2",children:(k,u)=>{var f=ha(),E=M(f);Je(E,{class:"h-4 w-4"}),bt(2),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var w=S(g,2);ht(w,{});var D=S(w,2);it(D,{children:(y,p)=>{{let b=d(()=>K.toCollectionHome(t.rootCollection.collection_id));_t(y,{get href(){return e(b)},class:"flex items-center gap-2",children:(k,u)=>{var f=pa(),E=M(f);Xe(E,{class:"h-4 w-4"});var P=S(E,2),F=I(P,!0);A(P),G(()=>Z(F,t.rootCollection.name)),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var h=S(D,2);ht(h,{});var C=S(h,2);it(C,{children:(y,p)=>{{let b=d(()=>K.toAnnotations(q.params.collection_id));_t(y,{get href(){return e(b)},class:"flex items-center gap-2",children:(k,u)=>{var f=ba(),E=M(f);ta(E,{class:"h-4 w-4"}),bt(2),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var L=S(C,2);ht(L,{});var N=S(L,2);it(N,{children:(y,p)=>{$e(y,{class:"flex items-center gap-2",children:(b,k)=>{var u=Aa(),f=M(u);ea(f,{class:"h-4 w-4"});var E=S(f,2),P=I(E);{var F=O=>{var Q=At();G(()=>Z(Q,`Annotation ${t.annotationIndex+1} of ${a()??""}`)),m(O,Q)},$=O=>{var Q=At("Annotation");m(O,Q)};T(P,O=>{t.annotationIndex!==void 0?O(F):O($,!1)})}A(E),m(b,u)},$$slots:{default:!0}})},$$slots:{default:!0}}),m(r,x)},$$slots:{default:!0}})},$$slots:{default:!0}}),j(),n()}var Sa=ce("<image></image><g><!></g>",1),ya=B('<div class="h-full w-full overflow-hidden"><div class="sample relative h-full w-full"><div class="absolute right-4 top-2 z-30"><!></div> <!> <!></div></div>'),wa=B('<div class="flex h-full w-full items-center justify-center"><!></div>'),Da=B('<div class="flex h-full w-full flex-col space-y-4"><div class="flex w-full items-center justify-between"><!> <!></div> <!> <div class="flex min-h-0 flex-1 gap-4"><div class="flex-1"><!></div> <div class="relative w-[375px]"><!></div></div></div>');function Qt(i,t){U(t,!0);const a=()=>R(O,"$isEditingMode",r),l=()=>R(f,"$rootCollection",r),n=()=>R(wt,"$imageBrightness",r),o=()=>R(Dt,"$imageContrast",r),s=()=>R(g,"$selectedSampleAnnotationCropIds",r),c=()=>R(h,"$isHidden",r),[r,v]=X(),{toggleSampleAnnotationCropSelection:x,selectedSampleAnnotationCropIds:g,clearReversibleActions:w,addReversibleAction:D}=J(),{isHidden:h,handleKeyEvent:C}=Be(),{settingsStore:L}=fe(),N=" ",y=lt(L).key_go_back;let p=Rt(!1);const b=()=>{var _;(_=t.annotationDetails.parent_sample_data)!=null&&_.sample.collection_id?st(K.toAnnotations(t.annotationDetails.parent_sample_data.sample.collection_id)):st("/")},k=_=>{switch(_.key){case y:b();break;case" ":_.preventDefault(),a()?ot(p,!0):x(t.collectionId,e(F));break;case N:_.preventDefault(),x(t.collectionId,e(F));break}C(_)},u=_=>{_.key===" "&&ot(p,!1),C(_)},{rootCollection:f}=Ee({collectionId:t.collectionId});be(()=>{w()});const E=_=>{if(e(P)){const H={annotation_id:e(P).sample_id,collection_id:t.collectionId,bounding_box:_};(async()=>{try{await t.updateAnnotation(H),Oe({annotation:e(P),collection_id:t.collectionId,addReversibleAction:D,updateAnnotation:t.updateAnnotation})}catch(et){It.error("Failed to update annotations:"+et.message)}})()}};let P=d(()=>t.annotationDetails.annotation),F=d(()=>e(P).sample_id),$=d(()=>e(P)?qt(e(P)):void 0);const{isEditingMode:O}=q.data.globalStorage,Q=d(()=>e(p)?"grab":"auto"),Gt=d(()=>a()&&!e(p));let tt=Rt(void 0);re(()=>{!e(tt)&&e($)&&ot(tt,e($),!0)}),Ae(()=>{ot(tt,void 0)});const{imageBrightness:wt,imageContrast:Dt}=J();var rt=Da();xt("keydown",pt,k),xt("keyup",pt,u);var dt=I(rt),Ct=I(dt);{var Zt=_=>{Ia(_,{get rootCollection(){return l().data},get annotationIndex(){return t.annotationIndex}})};T(Ct,_=>{l().data&&_(Zt)})}var Yt=S(Ct,2);{var Jt=_=>{je(_,{get brightness(){return Ut(),n()},set brightness(H){Tt(wt,H)},get contrast(){return Ut(),o()},set contrast(H){Tt(Dt,H)}})};T(Yt,_=>{a()&&_(Jt)})}A(dt);var Pt=S(dt,2);Re(Pt,{class:"bg-border-hard"});var kt=S(Pt,2),ct=I(kt),Xt=I(ct);zt(Xt,{className:"h-full",children:(_,H)=>{Vt(_,{className:"h-full",children:(Y,et)=>{var Bt=V(),te=M(Bt);{var ee=W=>{var z=ya(),at=I(z),ut=I(at),ne=I(ut);{let Nt=d(()=>{var nt;return(nt=s()[t.collectionId])==null?void 0:nt.has(e(F))});Ne(ne,{onSelect:()=>x(t.collectionId,e(F)),get isSelected(){return e(Nt)}})}A(ut);var Et=S(ut,2);la(Et,{});var oe=S(Et,2);Ue(oe,{get width(){return t.parentSample.width},get height(){return t.parentSample.height},get cursor(){return e(Q)},get boundingBox(){return e(tt)},zoomableContent:(nt,mt)=>{let ie=()=>mt==null?void 0:mt().scale;var Lt=Sa(),vt=M(Lt),gt=S(vt);let Ft;var le=I(gt);_e(le,()=>e(P).sample_id,ft=>{{let se=d(()=>({x:0,y:0,width:t.parentSample.width,height:t.parentSample.height}));Te(ft,{get annotation(){return e(P)},showLabel:!0,get scale(){return ie()},get imageWidth(){return t.parentSample.width},get isResizable(){return e(Gt)},onBoundingBoxChanged:E,get constraintBox(){return e(se)}})}}),A(gt),G(ft=>{yt(vt,"href",t.parentSample.url),he(vt,`filter: brightness(${n()}) contrast(${o()})`),Ft=pe(gt,0,"",null,Ft,ft)},[()=>({invisible:c()})]),m(nt,Lt)},$$slots:{zoomableContent:!0}}),A(at),A(z),m(W,z)},ae=W=>{var z=wa(),at=I(z);Le(at,{size:"large",align:"center"}),A(z),m(W,z)};T(te,W=>{e(P)?W(ee):W(ae,!1)})}m(Y,Bt)},$$slots:{default:!0}})},$$slots:{default:!0}}),A(ct);var Mt=S(ct,2),$t=I(Mt);_a($t,{get annotation(){return e(P)},get onUpdate(){return t.refetch},sampleDetails:H=>{var Y=V(),et=M(Y);St(et,()=>t.parentSampleDetails),m(H,Y)},$$slots:{sampleDetails:!0}}),A(Mt),A(kt),A(rt),m(i,rt),j(),v()}var Ca=B("<!> <!>",1);function Wt(i,t){var a=Ca(),l=M(a);St(l,()=>t.children);var n=S(l,2);Fe(n,{variant:"secondary",get href(){return t.href},children:(o,s)=>{bt();var c=At("View sample");m(o,c)},$$slots:{default:!0}}),m(i,a)}function Pa(i,t){U(t,!0);const a=d(()=>t.annotationDetails.parent_sample_data);{const l=o=>{{let s=d(()=>K.toSample({sampleId:e(a).sample.sample_id,collectionId:e(a).sample.collection_id}));Wt(o,{get href(){return e(s)},children:(c,r)=>{ve(c,{get sample(){return e(a)},showCustomMetadata:!1})}})}};let n=d(()=>({width:e(a).width,height:e(a).height,url:`${ue}/sample/${e(a).sample.sample_id}`}));Qt(i,{get annotationDetails(){return t.annotationDetails},get updateAnnotation(){return t.updateAnnotation},get refetch(){return t.refetch},get annotationIndex(){return t.annotationIndex},get collection(){return t.collection},get collectionId(){return t.collection.collection_id},get parentSample(){return e(n)},parentSampleDetails:l,$$slots:{parentSampleDetails:!0}})}j()}function ka(i,t){U(t,!0);const a=d(()=>t.annotationDetails.parent_sample_data);{const l=o=>{{let s=d(()=>K.toFramesDetails(e(a).sample.collection_id,e(a).sample_id));Wt(o,{get href(){return e(s)},children:(c,r)=>{aa(c,{get sample(){return e(a)}})}})}};let n=d(()=>({width:e(a).video.width,height:e(a).video.height,url:`${me}/${e(a).sample_id}`}));Qt(i,{get annotationDetails(){return t.annotationDetails},get updateAnnotation(){return t.updateAnnotation},get refetch(){return t.refetch},get annotationIndex(){return t.annotationIndex},get collection(){return t.collection},get collectionId(){return t.collection.collection_id},get parentSample(){return e(n)},parentSampleDetails:l,$$slots:{parentSampleDetails:!0}})}j()}const Ma=({collectionId:i,annotationId:t,onUpdate:a})=>{const l=ze({path:{sample_id:t}}),n=Ve(),{updateAnnotations:o}=Kt({collectionId:i}),s=Qe(l),c=()=>{n.invalidateQueries({queryKey:l.queryKey}),n.invalidateQueries({queryKey:We({path:{collection_id:i}}).queryKey}),n.invalidateQueries({queryKey:Ge({path:{collection_id:i}}).queryKey})};return{updateAnnotation:async v=>{try{await o([v]),c(),It.success("Annotation updated successfully"),a==null||a()}catch(x){It.error("Failed to update annotation:"+x.message)}},annotation:s,refetch:c}};var Ba=B('<div class="flex h-full w-full space-x-4 px-4 pb-4" data-testid="annotation-details"><div class="h-full w-full space-y-6 rounded-[1vw] bg-card p-4"><!></div></div>');function un(i,t){U(t,!0);const a=()=>R(e(x),"$annotationDetailsResponse",l),[l,n]=X(),o=d(()=>t.data.annotationId),s=d(()=>t.data.collection),c=d(()=>t.data.annotationIndex),r=q.params.collection_id,v=d(()=>Ma({collectionId:r,annotationId:e(o)})),x=d(()=>e(v).annotation),g=d(()=>e(v).updateAnnotation),w=d(()=>e(v).refetch);var D=Ba(),h=I(D),C=I(h);{var L=N=>{var y=V(),p=M(y);{var b=u=>{ka(u,{get annotationDetails(){return a().data},get annotationIndex(){return e(c)},get updateAnnotation(){return e(g)},get refetch(){return e(w)},get collection(){return e(s)}})},k=u=>{var f=V(),E=M(f);{var P=F=>{Pa(F,{get annotationDetails(){return a().data},get annotationIndex(){return e(c)},get updateAnnotation(){return e(g)},get refetch(){return e(w)},get collection(){return e(s)}})};T(E,F=>{a().data.parent_sample_type==jt.IMAGE&&F(P)},!0)}m(u,f)};T(p,u=>{a().data.parent_sample_type==jt.VIDEO_FRAME?u(b):u(k,!1)})}m(N,y)};T(C,N=>{a().data&&e(o)&&e(s)&&N(L)})}A(h),A(D),m(i,D),j(),n()}export{un as component,cn as universal};
