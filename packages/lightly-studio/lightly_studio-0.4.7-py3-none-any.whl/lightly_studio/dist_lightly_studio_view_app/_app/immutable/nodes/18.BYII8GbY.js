import{d as et,e as tt,g as at}from"../chunks/BDOtEUpJ.js";import{w as st,h as oe,p as ot,d as W,O as rt,u as Ae,g as e,e as T,a as it,b as g,s as o,c as r,r as i,f as K,t as De,n as nt}from"../chunks/Yb_TZ_Rf.js";import{u as Me}from"../chunks/C3A6m4-m.js";import{u as lt}from"../chunks/BG8lOwfA.js";import{t as dt,v as ct,w as mt,x as ut,C as je,y as Te,z as pt,S as $e,B as vt,D as ft}from"../chunks/DcA8i6zt.js";import{u as _t,c as gt,f as ht,a as xt,e as yt}from"../chunks/BQhJr0Qw.js";import"../chunks/CWj6FrbW.js";import{s as R}from"../chunks/CGH6oPk7.js";import{f as E,a as b,c as ke,t as $t}from"../chunks/DnGquTil.js";import{i as z,a as bt,s as re}from"../chunks/DVJdaASW.js";import{k as Ct,e as wt,i as Vt,t as ie}from"../chunks/Dcv4bg-q.js";import{d as Ft}from"../chunks/BwfxcG-Y.js";import{b as Pt}from"../chunks/CmJZ_CaC.js";import"../chunks/BztKn-jM.js";import"../chunks/CvGjimpO.js";import"../chunks/69_IOA4Y.js";import{p as Be}from"../chunks/CnA6nQDP.js";import{g as Oe}from"../chunks/C1bEftoN.js";import{S as St}from"../chunks/xmQHzaB1.js";import"../chunks/DtWZc_tl.js";import{r as ne}from"../chunks/Bz2KBNfb.js";import{u as It}from"../chunks/BKhhfA14.js";import{M as Nt}from"../chunks/Dqab5VQB.js";import{V as Et}from"../chunks/CjyESLw3.js";import{V as At}from"../chunks/27DEeZim.js";import{S as Dt}from"../chunks/AfXAZz1B.js";import{D as jt}from"../chunks/Bkoo7fNK.js";const Tt=({collection_id:v,sampleIndex:n,filter:f})=>{const l=st({isLoading:!1});return(async()=>{l.update(m=>({...m,isLoading:!0,error:void 0}));try{const{data:m}=await et({path:{collection_id:v},query:{cursor:n<1?0:n-1,limit:3},body:{filter:f},throwOnError:!0}),{setfilteredSampleCount:h}=Me();h(m==null?void 0:m.total_count);let H;const k=n>0?m.data[0]:void 0;m.data.length>2&&(H=n===0?m.data[1]:m.data[2]),l.update(P=>({...P,isLoading:!1,sampleNext:H,samplePrevious:k,error:void 0}))}catch(m){l.update(h=>({...h,isLoading:!1,error:m.message||"Failed to load adjacent videos"}))}})(),l};function kt({tagIds:v,metadata:n,annotationIds:f,bounds:l}){return{sample_filter:{tag_ids:v.size>0?[...v]:void 0,metadata_filters:n?gt(n):void 0},annotation_frames_label_ids:[...f],...l}}const Bt=async({params:v,url:n})=>{const f=v.collection_id,l=v.sample_id,A=n.searchParams.get("index"),m=A!==null?Number(A):null;let h=null;if(m!==null){const{selectedAnnotationFilterIds:k}=Me(),{videoBoundsValues:P}=dt(),{metadataValues:Q}=_t(),{tagsSelected:G}=lt({collection_id:f,kind:["sample"]}),le=oe(G),de=oe(Q),ce=oe(k),me=oe(P),ue=kt({tagIds:le,metadata:de,annotationIds:ce,bounds:me});h=Tt({collection_id:f,sampleIndex:m,filter:ue})}return{sample:(await tt({path:{sample_id:l}})).data,videoIndex:m,videoAdjacents:h}},$a=Object.freeze(Object.defineProperty({__proto__:null,load:Bt},Symbol.toStringTag,{value:"Module"})),Ot=({sampleId:v})=>{const n=ht({path:{sample_id:v}}),f=xt(),l=yt(n);return{refetch:()=>{f.invalidateQueries({queryKey:n.queryKey})},video:l}};var Mt=E("<!> <!>",1),Rt=E('<div class="video-frame-container relative overflow-hidden rounded-lg bg-black svelte-43x0cv"><!> <!></div>'),zt=E('<div class="min-w-full space-y-3 text-diffuse-foreground"><div class="flex items-start gap-3"><span class="truncate text-sm font-medium" title="Width">Width:</span> <span class="text-sm"> </span></div> <div class="flex items-start gap-3"><span class="truncate text-sm font-medium" title="Height">Height:</span> <span class="text-sm"> </span></div> <div class="flex items-start gap-3"><span class="truncate text-sm font-medium" title="Duration">Duration:</span> <span class="text-sm"> </span></div> <div class="flex items-start gap-3"><span class="truncate text-sm font-medium" title="FPS">FPS:</span> <span class="text-sm"> </span></div></div>'),Ht=(v,n,f)=>{var l;return n(((l=e(f))==null?void 0:l.sample_id)??"")},Qt=E('<button type="button" class="mb-2 flex h-8 items-center justify-center rounded-sm bg-card px-2 py-0 text-diffuse-foreground transition-colors hover:bg-primary hover:text-primary-foreground" data-testid="add-caption-button">+</button>'),Lt=E('<div class="flex flex-col gap-3 space-y-4"><div class="flex flex-col gap-2"><!> <!></div></div>'),qt=E('<div class="space-y-2 text-sm text-diffuse-foreground"><div class="flex items-center gap-2"><span class="font-medium">Frame #:</span> <span> </span></div> <div class="flex items-center gap-2"><span class="font-medium">Timestamp:</span> <span> </span></div></div> <!>',1),Ut=E("<!> <!> <!> <!> <!>",1),Wt=E('<div class="flex h-full w-full flex-col space-y-4"><div class="flex w-full items-center"><!></div> <!> <div class="flex min-h-0 flex-1 gap-4"><!> <!></div></div>');function ba(v,n){ot(n,!0);const f=()=>re(e(ze),"$videoQuery",h),l=()=>re(e(Q),"$videoAdjacents",h),A=()=>re(de,"$rootCollection",h),m=()=>re(Re,"$isEditingMode",h),[h,H]=bt(),k=g(()=>n.data.sample),P=g(()=>n.data.videoIndex),Q=g(()=>n.data.videoAdjacents),{collectionId:G}=Be.data,{removeTagFromSample:le}=It({collectionId:G}),{rootCollection:de,refetch:ce}=ct({collectionId:G}),{deleteCaption:me}=mt(),{createCaption:ue}=ut(),{isEditingMode:Re}=Be.data.globalStorage,be=g(()=>{var t;return Ot({sampleId:((t=e(k))==null?void 0:t.sample_id)??""})}),ze=g(()=>e(be).video),Z=g(()=>e(be).refetch),s=g(()=>f().data??e(k)),He=g(()=>{var t,a,d;return((d=(a=(t=e(s))==null?void 0:t.sample)==null?void 0:a.tags)==null?void 0:d.map(D=>({tagId:D.tag_id,name:D.name})))??[]}),Qe=async t=>{var a;if((a=e(s))!=null&&a.sample_id)try{await le(e(s).sample_id,t),e(Z)()}catch(d){console.error("Error removing tag from video:",d)}},Ce=g(()=>{var t,a;return((a=(t=e(s))==null?void 0:t.sample)==null?void 0:a.captions)??[]}),Le=async t=>{var a;if((a=e(s))!=null&&a.sample_id)try{await me(t),ie.success("Caption deleted successfully"),e(Z)()}catch(d){ie.error("Failed to delete caption. Please try again."),console.error("Error deleting caption:",d)}},qe=async t=>{var a;if((a=e(s))!=null&&a.sample_id)try{await ue({parent_sample_id:t}),ie.success("Caption created successfully"),e(Z)(),e(Ce).length||ce()}catch(d){ie.error("Failed to create caption. Please try again."),console.error("Error creating caption:",d)}},Ue=()=>{e(Z)()};let L=W(null),J=W(rt([])),S=W(void 0),we=null,pe=W(0),Ve=W(0),Fe=0,X=0,q=!1,ve=!1;const fe=25;let _e;Ae(()=>{if(!e(L))return;const t=()=>{var d;const a=(d=e(L))==null?void 0:d.getBoundingClientRect();T(pe,(a==null?void 0:a.width)??0,!0),T(Ve,(a==null?void 0:a.height)??0,!0)};return t(),_e=new ResizeObserver(t),_e.observe(e(L)),()=>_e.disconnect()});function We(t,a){T(S,t,!0),a!=null&&a%fe==0&&a!=0&&Fe<a&&Pe()}async function Pe(){var d,D,C,N,j;if(q||ve)return;q=!0;const t=await at({path:{video_frame_collection_id:(D=(d=e(s))==null?void 0:d.frame)==null?void 0:D.sample.collection_id},query:{cursor:X,limit:fe},body:{filter:{video_id:(C=e(s))==null?void 0:C.sample_id}}}),a=((N=t==null?void 0:t.data)==null?void 0:N.data)??[];if(a.length===0){ve=!0,q=!1;return}T(J,[...e(J),...a],!0),X=((j=t==null?void 0:t.data)==null?void 0:j.nextCursor)??X+fe,q=!1}function Ke(){Pe()}function Ge(){var a;if(e(P)===null||!e(s)||!e(Q))return null;const t=(a=l())==null?void 0:a.sampleNext;if(!t)return null;Oe(ne.toVideosDetails(e(s).sample.collection_id,t.sample_id,e(P)+1))}function Ze(){var a;if(e(P)===null||!e(s)||!e(Q))return null;const t=(a=l())==null?void 0:a.samplePrevious;if(!t)return null;Oe(ne.toVideosDetails(e(s).sample.collection_id,t.sample_id,e(P)-1))}let Se=null;Ae(()=>{if(!e(s))return;const t=e(s).sample_id;t!==Se&&(T(J,e(s).frame?[e(s).frame]:[],!0),T(S,e(s).frame??null,!0),X=0,Fe=0,q=!1,ve=!1,Se=t)});var ge=Wt(),he=r(ge),Je=r(he);{var Xe=t=>{jt(t,{get rootCollection(){return A().data},section:"Videos",subsection:"Video",get navigateTo(){return ne.toVideos},get index(){return e(P)}})};z(Je,t=>{A().data&&t(Xe)})}i(he);var Ie=o(he,2);St(Ie,{class:"mb-4 bg-border-hard"});var Ne=o(Ie,2),Ee=r(Ne);je(Ee,{className:"flex w-[60vw] flex-col",children:(t,a)=>{Te(t,{className:"flex h-full flex-col gap-4 overflow-hidden",children:(d,D)=>{var C=Rt(),N=r(C);{var j=p=>{{let B=g(()=>{var w;return!!((w=l())!=null&&w.samplePrevious)}),_=g(()=>{var w;return!!((w=l())!=null&&w.sampleNext)});Dt(p,{get hasPrevious(){return e(B)},get hasNext(){return e(_)},onPrevious:Ze,onNext:Ge})}};z(N,p=>{l()&&p(j)})}var Y=o(N,2);Ct(Y,()=>{var p;return(p=e(s))==null?void 0:p.sample_id},p=>{var B=ke(),_=K(B);{var w=u=>{var x=Mt(),V=K(x);At(V,{get video(){return e(s)},get frames(){return e(J)},muted:!0,controls:!0,update:We,className:"block h-full w-full",onplay:Ke,get videoEl(){return e(L)},set videoEl(c){T(L,c,!0)}});var I=o(V,2);{var F=c=>{Et(c,{get width(){return e(pe)},get height(){return e(Ve)},get sample(){return e(S)},showLabel:!0,get sampleWidth(){return e(s).width},get sampleHeight(){return e(s).height}})};z(I,c=>{e(S)&&e(pe)>0&&c(F)})}b(u,x)};z(_,u=>{e(s)&&u(w)})}b(p,B)}),i(C),Pt(C,p=>we=p,()=>we),b(d,C)},$$slots:{default:!0}})},$$slots:{default:!0}});var Ye=o(Ee,2);je(Ye,{className:"flex flex-1 flex-col overflow-hidden",children:(t,a)=>{Te(t,{className:"h-full overflow-y-auto",children:(d,D)=>{var C=Ut(),N=K(C);pt(N,{get tags(){return e(He)},onClick:Qe});var j=o(N,2);$e(j,{title:"Sample details",children:(_,w)=>{var u=zt(),x=r(u),V=o(r(x),2),I=r(V);i(V),i(x);var F=o(x,2),c=o(r(F),2),y=r(c);i(c),i(F);var O=o(F,2),ee=o(r(O),2),te=r(ee);i(ee),i(O);var U=o(O,2),ae=o(r(U),2),xe=r(ae,!0);i(ae),i(U),i(u),De(($,M)=>{var ye,se;R(I,`${((ye=e(s))==null?void 0:ye.width)??""}px`),R(y,`${((se=e(s))==null?void 0:se.height)??""}px`),R(te,`${$??""} seconds`),R(xe,M)},[()=>{var $,M;return(M=($=e(s))==null?void 0:$.duration_s)==null?void 0:M.toFixed(2)},()=>{var $;return($=e(s))==null?void 0:$.fps.toFixed(2)}]),b(_,u)}});var Y=o(j,2);Nt(Y,{get metadata_dict(){var _;return(_=e(s))==null?void 0:_.sample.metadata_dict}});var p=o(Y,2);$e(p,{title:"Captions",children:(_,w)=>{var u=Lt(),x=r(u),V=r(x);wt(V,17,()=>e(Ce),Vt,(c,y)=>{ft(c,{get caption(){return e(y)},onDeleteCaption:()=>Le(e(y).sample_id),onUpdate:Ue})});var I=o(V,2);{var F=c=>{var y=Qt();y.__click=[Ht,qe,s],b(c,y)};z(I,c=>{m()&&c(F)})}i(x),i(u),b(_,u)}});var B=o(p,2);$e(B,{title:"Current Frame",children:(_,w)=>{var u=ke(),x=K(u);{var V=I=>{var F=qt(),c=K(F),y=r(c),O=o(r(y),2),ee=r(O,!0);i(O),i(y);var te=o(y,2),U=o(r(te),2),ae=r(U);i(U),i(te),i(c);var xe=o(c,2);{let $=g(()=>ne.toFramesDetails(e(S).sample.collection_id,e(S).sample_id));vt(xe,{variant:"secondary",class:"mt-4 w-full",get href(){return e($)},children:(M,ye)=>{nt();var se=$t("View frame");b(M,se)},$$slots:{default:!0}})}De($=>{R(ee,e(S).frame_number),R(ae,`${$??""} s`)},[()=>e(S).frame_timestamp_s.toFixed(3)]),b(I,F)};z(x,I=>{e(S)&&I(V)})}b(_,u)}}),b(d,C)},$$slots:{default:!0}})},$$slots:{default:!0}}),i(Ne),i(ge),b(v,ge),it(),H()}Ft(["click"]);export{ba as component,$a as universal};
