import"../chunks/CWj6FrbW.js";import{w as j,h as q,p as Y,d as B,O as se,c as L,e as H,g as e,s as O,r as D,t as R,a as Z,u as re,b as l,f as ne}from"../chunks/Yb_TZ_Rf.js";import{f as Q,a as M,c as de}from"../chunks/DnGquTil.js";import{i as G,s as m,a as le}from"../chunks/DVJdaASW.js";import{b as ce,a as ue,u as me,c as fe}from"../chunks/BQhJr0Qw.js";import{r as ge,t as ve,g as _e}from"../chunks/DcA8i6zt.js";import{p as he}from"../chunks/D7RkCIym.js";import{u as U}from"../chunks/C3A6m4-m.js";import{s as pe}from"../chunks/CGH6oPk7.js";import{d as ye}from"../chunks/BwfxcG-Y.js";import{b as W}from"../chunks/Dcv4bg-q.js";import{g as be}from"../chunks/BDOtEUpJ.js";import{r as xe}from"../chunks/Bz2KBNfb.js";import{g as Se}from"../chunks/CNJerZyL.js";import{V as Ve}from"../chunks/CjyESLw3.js";import{g as we}from"../chunks/C1bEftoN.js";import{V as Ie}from"../chunks/27DEeZim.js";import{u as Fe}from"../chunks/BG8lOwfA.js";import{S as Ee}from"../chunks/CVsKQj9T.js";const Ce=(y,t,o)=>{const f=ce({path:{collection_id:y},query:{limit:30},body:{filter:t,text_embedding:o}}),d=ge({...f,getNextPageParam:i=>i.nextCursor||void 0}),g=ue(),b=()=>{g.invalidateQueries({queryKey:f.queryKey})},v=j([]),c=j(0);return d.subscribe(i=>{if(i.isSuccess){const s=i.data.pages.flatMap(V=>V.data);v.set(s),c.set(i.data.pages[0].total_count)}}),{data:v,loadMore:()=>{q(d).hasNextPage&&!q(d).isFetchingNextPage&&q(d).fetchNextPage()},query:d,refresh:b,totalCount:c}};function Ae(y,t){we(xe.toVideosDetails(t.video.sample.collection_id,t.video.sample_id,t.index))}var Me=Q('<div class="absolute bottom-1 right-1 z-10 flex items-center rounded bg-black/60 px-1.5 py-0.5 text-xs font-medium text-white backdrop-blur-sm"><span class="mr-1.5 block h-2 w-2 rounded-full"></span> </div>'),Ne=Q('<div class="video-frame-container relative overflow-hidden rounded-lg svelte-1s2jysz" role="img"><!> <!> <!></div>');function Pe(y,t){Y(t,!0);let o=B(null),f=B(null),d=0,g=!1,b=!1;const v=25;let c=null;const w=200;let i=!1,s=B(se(t.video.frame==null?[]:[t.video.frame]));async function V(){i=!0,c=setTimeout(async()=>{await F(),e(o)&&(e(o).readyState<2&&await new Promise(a=>{var r;return(r=e(o))==null?void 0:r.addEventListener("loadeddata",a,{once:!0})}),i&&e(o).play())},w)}function N(){var a;i=!1,c&&(clearTimeout(c),c=null),e(o)&&((a=e(o))==null||a.pause(),e(o).currentTime=0)}function I(a,r){H(f,a,!0),r!=null&&r%v==0&&r!=0&&F()}async function F(){var p,n,_;if(g||b)return;g=!0;const a=await be({path:{video_frame_collection_id:(p=t.video.frame)==null?void 0:p.sample.collection_id},query:{cursor:d,limit:v},body:{filter:{video_id:t.video.sample_id}}}),r=((n=a==null?void 0:a.data)==null?void 0:n.data)??[];if(r.length===0){b=!0,g=!1;return}H(s,[...e(s),...r],!0),d=((_=a==null?void 0:a.data)==null?void 0:_.nextCursor)??d+v,g=!1}var h=Ne();h.__dblclick=[Ae,t];var E=L(h);Ie(E,{get video(){return t.video},get frames(){return e(s)},update:I,muted:!0,playsinline:!0,preload:"metadata",handleMouseEnter:V,handleMouseLeave:N,className:"h-full w-full cursor-pointer rounded-lg shadow-md",get videoEl(){return e(o)},set videoEl(a){H(o,a,!0)}});var C=O(E,2);{var x=a=>{Ve(a,{get width(){return t.size},get height(){return t.size},get sampleWidth(){return t.video.width},get sampleHeight(){return t.video.height},get sample(){return e(f)}})};G(C,a=>{e(f)&&a(x)})}var P=O(C,2);{var k=a=>{var r=Me(),p=L(r),n=O(p);D(r),R((_,z)=>{W(p,`background-color: ${_??""}`),pe(n,` ${z??""}`)},[()=>Se(t.video.similarity_score),()=>t.video.similarity_score.toFixed(2)]),M(a,r)};G(P,a=>{t.video.similarity_score!==void 0&&t.video.similarity_score!==null&&a(k)})}D(h),R(()=>W(h,`width: var(${t.video.width}); height: var(${t.video.height});`)),M(y,h),Z()}ye(["dblclick"]);var ke=Q('<div class="flex flex-1 flex-col space-y-4"><!></div>');function et(y,t){Y(t,!0);const o=()=>m(he,"$page",s),f=()=>m(I,"$metadataValues",s),d=()=>m(N,"$tagsSelected",s),g=()=>m(e(F),"$selectedAnnotationsFilterIds",s),b=()=>m(h,"$videoBoundsValues",s),v=()=>m(C,"$textEmbedding",s),c=()=>m(e(P),"$data",s),w=()=>m(e(r),"$totalCount",s),i=()=>m(e(k),"$query",s),[s,V]=le(),{tagsSelected:N}=Fe({collection_id:o().params.collection_id,kind:["sample"]}),{metadataValues:I}=me(),F=l(()=>t.data.selectedAnnotationFilterIds),{videoBoundsValues:h}=ve(),E=l(()=>({sample_filter:{metadata_filters:I?fe(f()):void 0,tag_ids:d().size>0?Array.from(d()):void 0},annotation_frames_label_ids:g(),...b()})),{textEmbedding:C}=U(),x=l(()=>{var A;return Ce(o().params.collection_id,e(E),(A=v())==null?void 0:A.embedding)}),P=l(()=>e(x).data),k=l(()=>e(x).query),a=l(()=>e(x).loadMore),r=l(()=>e(x).totalCount),{setfilteredSampleCount:p}=U();let n=l(c);re(()=>{p(w())});var _=ke(),z=L(_);{const A=($,u)=>{let S=()=>u==null?void 0:u().index,ee=()=>u==null?void 0:u().style,te=()=>u==null?void 0:u().sampleSize;var K=de(),ae=ne(K);{var ie=T=>{_e(T,{get style(){return ee()},get index(){return S()},dataTestId:"video-grid-item",get sampleId(){return e(n)[S()].sample_id},get collectionId(){return o().params.collection_id},get dataSampleName(){return e(n)[S()].sample_id},item:oe=>{Pe(oe,{get video(){return e(n)[S()]},get size(){return te()},get index(){return S()}})},$$slots:{item:!0}})};G(ae,T=>{e(n)[S()]&&T(ie)})}M($,K)};let J=l(()=>({loading:i().isPending&&e(n).length===0,error:i().isError,empty:i().isSuccess&&e(n).length===0,success:i().isSuccess&&e(n).length>0})),X=l(()=>({loadMore:e(a),disabled:!i().hasNextPage||i().isFetchingNextPage,loading:i().isFetchingNextPage}));Ee(z,{get itemCount(){return e(n).length},overScan:20,testId:"video-grid",message:{loading:"Loading videos...",error:"Error loading videos",empty:{title:"No videos found",description:"This collection doesn't contain any videos."}},get status(){return e(J)},get loader(){return e(X)},gridItem:A,$$slots:{gridItem:!0}})}D(_),M(y,_),Z(),V()}export{et as component};
