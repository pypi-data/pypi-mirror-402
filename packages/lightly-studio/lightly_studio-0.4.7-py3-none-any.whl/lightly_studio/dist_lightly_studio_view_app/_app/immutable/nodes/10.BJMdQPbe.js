import"../chunks/CWj6FrbW.js";import{p as Pe,d as I,O as Te,u as ke,g as e,b as l,e as _,c as y,s as ae,f as k,r as b,t as xe,a as Me,w as Qe,h as Ie,n as Ue}from"../chunks/Yb_TZ_Rf.js";import{f as p,c as U,a as i}from"../chunks/DnGquTil.js";import{i as S,s as pe,a as Ne}from"../chunks/DVJdaASW.js";import{d as Ve,S as We,e as je,b as fe,u as Ae,i as qe,s as Le,t as Ce,k as Ee,a as Re}from"../chunks/Dcv4bg-q.js";import{E as Be,b as ve,F as Ke,H as Ge,r as Ye,w as Je,x as Xe,C as Ze,y as $e,D as et,h as Fe,a as He,L as tt}from"../chunks/DcA8i6zt.js";import{p as Q,r as at,b as De}from"../chunks/CmJZ_CaC.js";import{h as it,a as rt,e as ot,f as st}from"../chunks/BQhJr0Qw.js";import{S as lt}from"../chunks/xmQHzaB1.js";import"../chunks/CvGjimpO.js";import{u as nt}from"../chunks/C3A6m4-m.js";import"../chunks/BztKn-jM.js";import"../chunks/69_IOA4Y.js";import{p as Oe}from"../chunks/CnA6nQDP.js";import"../chunks/C1bEftoN.js";import{a as dt}from"../chunks/DtWZc_tl.js";import{I as ct}from"../chunks/7Gu-QONR.js";import{s as ce}from"../chunks/DTWlVeDn.js";import{d as vt}from"../chunks/BwfxcG-Y.js";import{S as ze}from"../chunks/CI5--nSk.js";const ft=Ke(),mt=Ge();var ut=p("<div><!></div>"),gt=p("<div><!></div>"),ht=p("<div><!></div>"),_t=p("<div><!></div>"),xt=p("<div><!></div>"),pt=p("<div><!> <div><!> <!></div> <!></div>");function yt(B,t){Pe(t,!0);let x=Q(t,"height",3,"100%"),K=Q(t,"width",3,"100%"),P=Q(t,"stickyIndices",19,()=>[]),O=Q(t,"overScan",3,1),N=Q(t,"marginLeft",3,0),c=Q(t,"marginTop",3,0),se=Q(t,"layout",3,"vertical"),V=Q(t,"scrollPosition",15,0),le=Q(t,"scrollAlignment",3,"auto"),ie=Q(t,"scrollBehavior",3,"auto"),M=Q(t,"getKey",3,a=>a),ye=at(t,["$$slots","$$events","$$legacy","itemCount","itemSize","height","width","stickyIndices","overScan","marginLeft","marginTop","layout","scrollPosition","scrollAlignment","scrollBehavior","getKey","onscroll","header","item","placeholder","footer"]),T=I(void 0),G=I(Te(V())),W=I(0),Y=I(0),j=I(0),$=I(0),J=I(0),me=I(0),n=I(Te([])),v=!1,re=!1,ue=I(!1);function ne(a,r=le(),d=ie()){ge(be(a,r),d)}function ee(a,r=ie()){ge(a,r)}const be=(a,r)=>{const d=e(m)?c()+e(W):N()+e(Y),C=a*t.itemSize+d,D=C-e(Z)+t.itemSize+d;let o;switch(r){case"start":o=C;break;case"center":o=C-(e(Z)-t.itemSize)/2;break;case"end":o=D;break;default:o=Math.max(D,Math.min(C,V()));break}return Math.max(0,Math.min(e(u)-e(Z),o))},ge=(a,r=ie())=>{e(T)&&(v=!0,e(T).scrollTo({[e(m)?"top":"left"]:a,behavior:r}),v=!1)},he=a=>{e(T)&&!v&&!re&&(v=!0,e(T).scrollTo({top:a,behavior:ie()}),v=!1)},f=a=>{const r=a*t.itemSize;return`position: absolute; transform: translate3d(${e(m)?`${N()}px, ${r+c()}px`:`${e(Y)+r+N()}px, ${c()}px`}, 0px); ${e(z)} will-change: transform;`},X=a=>{re=!0,v||(e(m)?(_(G,Math.max(0,a.currentTarget.scrollTop-e(W)),!0),V(a.currentTarget.scrollTop)):(_(G,Math.max(0,a.currentTarget.scrollLeft-e(Y)),!0),V(a.currentTarget.scrollLeft)),e(Se)(e(G))),ft(()=>{re=!1})};let m=l(()=>se()==="vertical"),u=l(()=>t.itemCount*t.itemSize),z=l(()=>e(m)?`height: ${t.itemSize}px; width: ${N()>0?`${e(me)-N()}px`:"100%"};`:`height: ${c()>0?`${e($)-c()}px`:"100%"}; width: ${t.itemSize}px;`),Z=l(()=>e(m)?e(j):e(J));ke(()=>{e(Z)&&_(n,Be(t.itemCount,t.itemSize,e(Z),O(),e(G)),!0)}),ke(()=>{e(T)&&he(V())});let Se=l(()=>mt(e(Z),{fast:()=>{_(ue,!0)},slow:()=>{_(ue,!1)}}));var we={scrollToIndex:ne,scrollToPosition:ee},g=pt(),_e=a=>{var r;X(a),(r=t.onscroll)==null||r.call(t,a)};Ve(g,a=>({onscroll:_e,...ye,[We]:a}),[()=>({position:"relative",overflow:"auto",height:typeof x()=="number"?`${x()}px`:x(),width:typeof K()!="number"?K():`${K()}px`})]);var oe=y(g);{var L=a=>{var r=U(),d=k(r);{var C=o=>{var s=ut(),h=y(s);ce(h,()=>t.header),b(s),ve(s,"offsetHeight",H=>_(W,H)),i(o,s)},D=o=>{var s=gt();fe(s,"",{},{position:"absolute"});var h=y(s);ce(h,()=>t.header),b(s),ve(s,"offsetWidth",H=>_(Y,H)),i(o,s)};S(d,o=>{e(m)?o(C):o(D,!1)})}i(a,r)};S(oe,a=>{t.header&&a(L)})}var E=ae(oe,2);let F;var w=y(E);{var A=a=>{const r=l(()=>Math.max(...P().filter(o=>o<e(n)[0])));var d=U(),C=k(d);{var D=o=>{var s=ht();let h;var H=y(s);ce(H,()=>t.item,()=>({index:e(r),style:""})),b(s),xe(de=>h=fe(s,"",h,de),[()=>({position:"sticky",top:e(m)?`${c()}px`:"0px",left:e(m)?"0px":`${N()}px`,"z-index":"1"})]),i(o,s)};S(C,o=>{e(r)>=0&&o(D)})}i(a,d)};S(w,a=>{P().length&&e(n).length&&a(A)})}var q=ae(w,2);je(q,17,()=>e(n),a=>M()(a),(a,r)=>{const d=l(()=>f(e(r)));var C=U(),D=k(C);{var o=h=>{var H=U(),de=k(H);ce(de,()=>t.item,()=>({index:e(r),style:e(d)})),i(h,H)},s=h=>{var H=U(),de=k(H);ce(de,()=>t.placeholder,()=>({index:e(r),style:e(d)})),i(h,H)};S(D,h=>{!e(ue)||!t.placeholder?h(o):h(s,!1)})}i(a,C)}),b(E);var te=ae(E,2);{var R=a=>{var r=U(),d=k(r);{var C=o=>{var s=_t(),h=y(s);ce(h,()=>t.footer),b(s),i(o,s)},D=o=>{var s=xt();let h;var H=y(s);ce(H,()=>t.footer),b(s),xe(de=>h=fe(s,"",h,de),[()=>({position:"absolute",top:"0px",left:`${e(Y)+t.itemCount*t.itemSize+N()}px`})]),i(o,s)};S(d,o=>{e(m)?o(C):o(D,!1)})}i(a,r)};S(te,a=>{t.footer&&a(R)})}return b(g),De(g,a=>_(T,a),()=>e(T)),xe(a=>F=fe(E,"",F,a),[()=>({height:e(m)?`${e(u)}px`:"100%",width:e(m)?"100%":`${e(u)}px`})]),ve(g,"offsetHeight",a=>_(j,a)),ve(g,"clientHeight",a=>_($,a)),ve(g,"offsetWidth",a=>_(J,a)),ve(g,"clientWidth",a=>_(me,a)),i(B,g),Me(we)}const bt=(...B)=>{const t=it(...B),x=Ye({...t,getNextPageParam:c=>c.nextCursor||void 0}),K=rt(),P=()=>{K.invalidateQueries({queryKey:t.queryKey})},O=Qe([]);return x.subscribe(c=>{if(c.isSuccess){const se=c.data.pages.flatMap(V=>V.data);O.set(se)}}),{data:O,loadMore:()=>{Ie(x).hasNextPage&&!Ie(x).isFetchingNextPage&&Ie(x).fetchNextPage()},query:x,refresh:P}};var St=p('<img class="sample-image rounded-lg bg-black svelte-3s9cf" loading="lazy"/>'),wt=p('<div class="sample-image flex items-center justify-center rounded-lg bg-black svelte-3s9cf"><div class="text-white">Loading...</div></div>'),Ct=p('<div class="sample-image flex items-center justify-center rounded-lg bg-black svelte-3s9cf"><div class="text-white">No frame available</div></div>'),It=(B,t,x)=>t(x.item.sample_id),zt=p('<button type="button" class="mb-2 flex h-8 items-center justify-center rounded-sm bg-card px-2 py-0 text-diffuse-foreground transition-colors hover:bg-primary hover:text-primary-foreground" data-testid="add-caption-button">+</button>'),kt=p('<!> <div class="flex h-full w-full flex-1 flex-col overflow-auto px-4 py-2"><!> <!></div>',1),Pt=p("<div><!></div>");function Mt(B,t){Pe(t,!0);const x=()=>pe(se,"$gridViewSampleRenderingStore",O),K=()=>pe(ye,"$videoQuery",O),P=()=>pe(V,"$isEditingMode",O),[O,N]=Ne(),c=Q(t,"maxHeight",3,"100%"),{gridViewSampleRenderingStore:se}=Ae(),{isEditingMode:V}=Oe.data.globalStorage;let le=l(x);const ie=l(()=>Oe.data.collection),M=l(()=>{var n;return(n=e(ie))==null?void 0:n.sample_type}),ye=ot({...st({path:{sample_id:t.item.sample_id}}),enabled:()=>e(M)===ze.VIDEO}),T=l(()=>K().data),G=l(()=>{var n,v;return(v=(n=e(T))==null?void 0:n.frame)==null?void 0:v.sample_id}),{deleteCaption:W}=Je(),Y=async n=>{if(t.item)try{await W(n),Ce.success("Caption deleted successfully"),t.onUpdate()}catch(v){Ce.error("Failed to delete caption. Please try again."),console.error("Error deleting caption:",v)}},{createCaption:j}=Xe(),$=async n=>{try{await j({parent_sample_id:n}),Ce.success("Caption created successfully"),t.onUpdate()}catch(v){Ce.error("Failed to create caption. Please try again."),console.error("Error creating caption:",v)}};var J=Pt(),me=y(J);Ze(me,{className:"h-full",children:(n,v)=>{$e(n,{className:"h-full flex min-h-0 flex-row items-center dark:[color-scheme:dark]",children:(re,ue)=>{var ne=kt(),ee=k(ne);{var be=u=>{Fe(u,{get sample(){return t.item},get objectFit(){return e(le)}})},ge=u=>{var z=U(),Z=k(z);{var Se=g=>{var _e=U(),oe=k(_e);{var L=F=>{var w=St();xe(()=>{Le(w,"src",`${dt}/${e(G)}`),Le(w,"alt",t.item.file_path_abs??t.item.sample_id),fe(w,`--object-fit: ${e(le)??""}`)}),i(F,w)},E=F=>{var w=U(),A=k(w);{var q=R=>{var a=wt();i(R,a)},te=R=>{var a=Ct();i(R,a)};S(A,R=>{K().isPending?R(q):R(te,!1)},!0)}i(F,w)};S(oe,F=>{e(G)?F(L):F(E,!1)})}i(g,_e)},we=g=>{Fe(g,{get sample(){return t.item},get objectFit(){return e(le)}})};S(Z,g=>{e(M)===ze.VIDEO?g(Se):g(we,!1)},!0)}i(u,z)};S(ee,u=>{e(M)===ze.IMAGE?u(be):u(ge,!1)})}var he=ae(ee,2),f=y(he);je(f,17,()=>t.item.captions,qe,(u,z)=>{et(u,{get caption(){return e(z)},onDeleteCaption:()=>Y(e(z).sample_id),get onUpdate(){return t.onUpdate}})});var X=ae(f,2);{var m=u=>{var z=zt();z.__click=[It,$,t],i(u,z)};S(X,u=>{P()&&u(m)})}b(he),i(re,ne)},$$slots:{default:!0}})},$$slots:{default:!0}}),b(J),xe(()=>fe(J,`height: ${c()}; max-height: ${c()};`)),i(B,J),Me(),N()}vt(["click"]);var Tt=p('<div class="flex h-full w-full items-center justify-center"><!> <div>Loading samples...</div></div>'),Lt=p('<div data-testid="caption-grid-item"><!></div>'),Et=p('<div class="flex justify-center p-4"><!></div>'),Ft=p("<!> <!>",1),Ht=p('<div class="flex flex-1 flex-col space-y-4"><div class="my-2 flex items-center space-x-4"><div class="flex-1"><div class="text-2xl font-semibold">Captions</div></div> <div class="w-4/12"><!></div></div> <!> <div class="h-full w-full flex-1 overflow-hidden"><!></div></div>');function Ot(B,t){Pe(t,!0);const x=()=>pe(e(se),"$data",O),K=()=>pe(ye,"$sampleSize",O),P=()=>pe(e(V),"$query",O),[O,N]=Ne(),c=l(()=>bt({body:{filters:{collection_id:t.collectionId,has_captions:!0}}})),se=l(()=>e(c).data),V=l(()=>e(c).query),le=l(()=>e(c).loadMore),ie=l(()=>e(c).refresh);let M=I(null);const{sampleSize:ye}=nt();let T=I(0),G=I(0),W=I(0),Y=I(0);ke(()=>{if(!e(M))return;_(G,e(Y)/K().width),_(W,e(G)-$),_(T,e(M).clientHeight,!0);const f=new ResizeObserver(()=>{e(M)&&_(T,e(M).clientHeight,!0)});return f.observe(e(M)),()=>{f.disconnect()}});let j=l(x);const $=8,J=32,me=l(()=>e(T)+$);var n=Ht(),v=y(n),re=ae(y(v),2),ue=y(re);ct(ue,{}),b(re),b(v);var ne=ae(v,2);lt(ne,{class:"mb-4 bg-border-hard"});var ee=ae(ne,2),be=y(ee);{var ge=f=>{var X=Tt(),m=y(X);He(m,{}),Ue(2),b(X),i(f,X)},he=f=>{var X=U(),m=k(X);{var u=z=>{{const Z=(oe,L)=>{let E=()=>L==null?void 0:L().index,F=()=>L==null?void 0:L().style;var w=U(),A=k(w);{var q=te=>{var R=U(),a=k(R);Ee(a,()=>e(j)[E()].sample_id+(P().dataUpdatedAt??0),r=>{var d=Lt();Re(d,1,`w-full pb-[${$}]`);var C=y(d);{let D=l(()=>`${e(W)}px`);Mt(C,{get maxHeight(){return e(D)},get item(){return e(j)[E()]},get onUpdate(){return e(ie)}})}b(d),xe(()=>fe(d,F())),i(r,d)}),i(te,R)};S(A,te=>{e(j)[E()]&&te(q)})}i(oe,w)},Se=oe=>{var L=Ft(),E=k(L);Ee(E,()=>e(j).length,A=>{{let q=l(()=>!P().hasNextPage||P().isFetchingNextPage);tt(A,{get onIntersect(){return e(le)},get disabled(){return e(q)}})}});var F=ae(E,2);{var w=A=>{var q=Et(),te=y(q);He(te,{}),b(q),i(A,q)};S(F,A=>{P().isFetchingNextPage&&A(w)})}i(oe,L)};let we=l(()=>e(W)+$),g=l(()=>e(W)-J),_e=l(()=>e(W)-J);yt(z,{get itemCount(){return e(j).length},get height(){return e(me)},get itemSize(){return e(we)},class:"dark:[color-scheme:dark]",get style(){return`--sample-width: ${e(g)??""}px; --sample-height: ${e(_e)??""}px;`},item:Z,footer:Se,$$slots:{item:!0,footer:!0}})}};S(m,z=>{P().isSuccess&&e(j).length>0&&z(u)},!0)}i(f,X)};S(be,f=>{P().isPending&&e(j).length===0?f(ge):f(he,!1)})}b(ee),De(ee,f=>_(M,f),()=>e(M)),b(n),ve(ee,"clientWidth",f=>_(Y,f)),i(B,n),Me(),N()}function aa(B,t){const{collectionId:x}=t.data;Ot(B,{get collectionId(){return x}})}export{aa as component};
