"""Export LightlyStudio version information to JSON file."""

import argparse
import json
import subprocess
from importlib import metadata
from typing import TypedDict


class VersionInfo(TypedDict):
    """Version information of LightlyStudio."""

    version: str
    """Version from package metadata."""

    git_sha: str
    """Git SHA of the current commit."""

    is_tagged_commit: bool
    """Whether the current commit is tagged with vX.Y.Z where X.Y.Z is the version."""

    _comment: str
    """Documentation comment."""


def get_version_info() -> VersionInfo:
    """Retrieve version information of LightlyStudio."""
    version = metadata.version("lightly-studio")
    git_sha = subprocess.check_output(["git", "rev-parse", "--short", "HEAD"], text=True).strip()
    tag = f"v{version}"
    try:
        tag_sha = subprocess.check_output(["git", "rev-parse", "--short", tag], text=True).strip()
    except subprocess.CalledProcessError:
        tag_sha = ""

    return VersionInfo(
        version=version,
        git_sha=git_sha,
        is_tagged_commit=(tag_sha == git_sha),
        _comment="Autogenerated by export_version.py. Do not edit manually.",
    )


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Export LightlyStudio version to a file.")
    parser.add_argument(
        "--output",
        type=str,
        default="version.json",
        help="The output file path for the OpenAPI schema (default: openapi.json).",
    )
    args = parser.parse_args()

    version_info = get_version_info()
    print(version_info)
    with open(args.output, "w") as f:
        json.dump(version_info, f, indent=2)
