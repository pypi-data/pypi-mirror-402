"""Tests for the MCP server.

Generated by GRIMLOCK MCP Factory
"""

import json

import httpx
import pytest
import respx

from n8n_mcp.server import list_tools, call_tool


class TestListTools:
    """Tests for list_tools handler."""

    @pytest.mark.asyncio
    async def test_list_tools_returns_check_workflows(self) -> None:
        """Test that list_tools returns check_workflows tool."""
        tools = await list_tools()

        assert len(tools) == 1
        assert tools[0].name == "check_workflows"
        assert "workflow" in tools[0].description.lower()

    @pytest.mark.asyncio
    async def test_check_workflows_tool_schema(self) -> None:
        """Test that check_workflows has correct schema."""
        tools = await list_tools()
        check_workflows_tool = tools[0]

        schema = check_workflows_tool.inputSchema
        # Should be a minimal schema with no required properties
        assert schema["type"] == "object"
        # Empty input schema should have no required fields
        assert schema.get("required", []) == []


class TestCallTool:
    """Tests for call_tool handler."""

    @pytest.mark.asyncio
    async def test_call_check_workflows(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
        sample_workflows_response: dict,
        sample_executions_response: dict,
    ) -> None:
        """Test calling check_workflows tool."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(200, json=sample_workflows_response))

        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/executions"
        ).mock(return_value=httpx.Response(200, json=sample_executions_response))

        result = await call_tool("check_workflows", {})

        assert len(result) == 1
        assert result[0].type == "text"

        data = json.loads(result[0].text)
        assert data["total_workflows"] == 3

    @pytest.mark.asyncio
    async def test_call_unknown_tool_raises(self) -> None:
        """Test that calling unknown tool raises ValueError."""
        with pytest.raises(ValueError, match="Unknown tool"):
            await call_tool("nonexistent_tool", {})

    @pytest.mark.asyncio
    async def test_call_tool_case_sensitivity(self) -> None:
        """Test that tool names are case-sensitive."""
        with pytest.raises(ValueError, match="Unknown tool"):
            await call_tool("CHECK_WORKFLOWS", {})

        with pytest.raises(ValueError, match="Unknown tool"):
            await call_tool("Check_Workflows", {})
