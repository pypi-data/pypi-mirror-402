"""
PROJECT.md Generator - Living requirements document.

Generates a GSD-style PROJECT.md from project config and sprint data.
"""

from __future__ import annotations

from pathlib import Path
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from vk.sync.models import ProjectConfig, SprintConfig


def generate_project_md(
    project: ProjectConfig,
    sprint: SprintConfig | None,
    output_dir: Path,
    quality_gates: list | None = None,
) -> Path:
    """Generate PROJECT.md - living requirements document.

    Args:
        project: Project configuration
        sprint: Current sprint configuration (optional)
        output_dir: Directory to write PROJECT.md
        quality_gates: List of quality gate configs (optional)
    """

    tech_stack = project.tech_stack

    # Format tech stack section
    tech_lines = []
    if tech_stack.languages:
        tech_lines.append(f"- **Languages**: {', '.join(tech_stack.languages)}")
    if tech_stack.frameworks:
        tech_lines.append(f"- **Frameworks**: {', '.join(tech_stack.frameworks)}")
    if tech_stack.databases:
        tech_lines.append(f"- **Databases**: {', '.join(tech_stack.databases)}")
    if tech_stack.tools:
        tech_lines.append(f"- **Tools**: {', '.join(tech_stack.tools)}")
    tech_section = "\n".join(tech_lines) if tech_lines else "_Not configured_"

    # Format objectives
    objectives_section = (
        "\n".join(f"- {obj}" for obj in project.objectives)
        if project.objectives
        else "_No objectives defined_"
    )

    # Format success criteria
    criteria_section = (
        "\n".join(f"- {c}" for c in project.success_criteria)
        if project.success_criteria
        else "_No criteria defined_"
    )

    # Format current sprint section
    sprint_section = _format_sprint_section(sprint) if sprint else "_No active sprint_"

    # Format constraints section
    constraints_section = _format_constraints_section(quality_gates)

    content = f"""# {project.name}

> Living requirements document - auto-generated by VibeKit

## Vision

{project.description or "_No description provided._"}

## Objectives

{objectives_section}

## Success Criteria

{criteria_section}

## Tech Stack

{tech_section}

## Current Sprint

{sprint_section}

## Constraints

{constraints_section}

## Quick Reference

| Resource | Path |
|----------|------|
| Current state | `.vk/INDEX.yaml` |
| Human state | `.vk/STATE.md` |
| Task plans | `.vk/plans/ready/` |
| Agents | `.claude/agents/` |
| Rules | `.claude/rules/` |
| Patterns | `.claude/patterns/` |
"""

    output_path = output_dir / "PROJECT.md"
    output_path.write_text(content)
    return output_path


def _format_sprint_section(sprint: SprintConfig) -> str:
    """Format sprint section for PROJECT.md."""
    lines = [f"**{sprint.name}**"]

    if sprint.goal:
        lines.append(f"\n_{sprint.goal}_")

    lines.append(f"\n- **Status**: {sprint.status}")

    if sprint.start_date:
        lines.append(f"- **Start**: {sprint.start_date.strftime('%Y-%m-%d')}")
    if sprint.end_date:
        lines.append(f"- **End**: {sprint.end_date.strftime('%Y-%m-%d')}")

    # Count tasks across requirements
    total_tasks = 0
    completed_tasks = 0
    for req in sprint.requirements:
        for task in req.tasks:
            total_tasks += 1
            if task.status.value == "completed":
                completed_tasks += 1

    if total_tasks > 0:
        progress = int((completed_tasks / total_tasks) * 100)
        lines.append(f"- **Progress**: {completed_tasks}/{total_tasks} tasks ({progress}%)")

    # Add requirements and tasks sections
    if sprint.requirements:
        lines.append("\n### Requirements & Tasks\n")
        for req in sprint.requirements:
            # Show requirement type (feat/fix/refactor) with title
            req_type = req.type.value if req.type else "feat"
            lines.append(f"**{req.requirement_id} ({req_type})** {req.title}\n")

            if req.tasks:
                # Task table header - include Assignee column
                lines.append("| Task | Title | Status | Priority | Assignee | Files |")
                lines.append("|------|-------|--------|----------|----------|-------|")

                for task in req.tasks:
                    # Format status with emoji
                    status_map = {
                        "completed": "‚úÖ Done",
                        "in_progress": "üîÑ Active",
                        "blocked": "üö´ Blocked",
                        "pending": "‚è≥ Pending",
                    }
                    status_display = status_map.get(task.status.value, task.status.value)

                    # Format priority
                    priority_display = task.priority.value.upper()

                    # Format assignee
                    assignee_display = task.assignee if task.assignee else "_unassigned_"

                    # Format files_likely - show first 2 files if available
                    files_display = ""
                    if task.files_likely:
                        files_short = task.files_likely[:2]
                        files_display = ", ".join(f"`{f}`" for f in files_short)
                        if len(task.files_likely) > 2:
                            files_display += f" +{len(task.files_likely) - 2}"
                    else:
                        files_display = "_TBD_"

                    lines.append(
                        f"| {task.task_id} | {task.title} | {status_display} | "
                        f"{priority_display} | {assignee_display} | {files_display} |"
                    )

                lines.append("")  # Empty line after table

    return "\n".join(lines)


def _format_constraints_section(quality_gates: list | None) -> str:
    """Format constraints section with quality gates.

    Args:
        quality_gates: List of QualityGate configs or None

    Returns:
        Formatted constraints section as markdown
    """
    lines = [
        "- Follow patterns in `.claude/patterns/`",
        "- Adhere to rules in `.claude/rules/`",
    ]

    # Add quality gates if available
    if quality_gates and len(quality_gates) > 0:
        lines.append("- Quality gates must pass:")
        for gate in quality_gates:
            # Determine icon based on required status
            if gate.required:
                icon = "‚úÖ"
                suffix = "(required)"
            elif gate.enabled:
                icon = "‚ö†Ô∏è"
                suffix = "(warning)"
            else:
                icon = "‚ÑπÔ∏è"
                suffix = "(info)"

            lines.append(f"  - {icon} {gate.name} {suffix}")
    else:
        lines.append("- Quality gates must pass before task completion")

    lines.append("- Read `.vk/INDEX.yaml` for current state")

    return "\n".join(lines)
