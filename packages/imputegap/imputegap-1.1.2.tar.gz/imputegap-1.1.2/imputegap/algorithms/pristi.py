import time

from imputegap.wrapper.AlgoPython.PriSTI.recovPriSTI import recovPriSTI


def pristi(incomp_data, seq_len=-1, batch_size=-1, epochs=10, sliding_windows=1, target_strategy="mix", nsamples=100, num_workers=0, tr_ratio=0.9, seed=1, logs=True, verbose=True):
    """
    Perform time series imputation using the PriSTI (Probabilistic Imputation via Sequential Targeted Imputation) algorithm.

    This method uses a diffusion-based generative model with temporal and feature embeddings
    to reconstruct missing values in multivariate time series. It supports multiple
    imputation strategies and can operate in both conditional and unconditional modes.

    Parameters
    ----------
     incomp_data : numpy.ndarray
        The input matrix with contamination (missing values represented as NaNs).

    seq_len : int, optional
        Length of the input sequence for the encoder. If -1, it will be automatically determined (default: -1).

    batch_size : int, optional
        Number of samples per batch during training/inference. If -1, it will be auto-set (default: -1).

    epochs : int, optional
        Number of epoch for training the model (default: 10).

    sliding_windows: int, optional
        Stride between consecutive training windows (default is 1). If set to -1, the window size is equal to seq_len.
        Use values â‰¥ 1 for univariate datasets (window strategy) and -1 for multivariate datasets (sample strategy).

    target_strategy: str, optional
        The strategy to use for targeting missing values pattern. Options include: "mix", "block", "random" (default is "mix").

    nsamples: int, optional
        Number of trajectories generated by the diffusion process (default: 1).

    num_workers: int, optional
         Number of worker for multiprocess (default is 0).

    tr_ratio: float, optional
         Split ratio between training and testing sets (default is 0.9).

    seed : int, optional
        Random seed for reproducibility (default: 2021).

    logs : bool, optional
        Whether to print/log execution time and key events (default: True).

    verbose : bool, optional
        Whether to print detailed output information during execution (default: True).

    Returns
    -------
    numpy.ndarray
        The imputed time series with missing values recovered.
        Shape matches that of the input array.

     Example
     -------
        >>> recov_data = pristi(incomp_data, seq_len=48, batch_size=16)
        >>> print(recov_data.shape)

    References
    ----------
    M. Liu, H. Huang, H. Feng, L. Sun, B. Du and Y. Fu, "PriSTI: A Conditional Diffusion Framework for Spatiotemporal Imputation," 2023 IEEE 39th International Conference on Data Engineering (ICDE), Anaheim, CA, USA, 2023, pp. 1927-1939, doi: 10.1109/ICDE55515.2023.00150.
    https://github.com/LMZZML/PriSTI
    """
    start_time = time.time()  # Record start time

    recov_data = recovPriSTI(incomp_data=incomp_data, seq_len=seq_len, batch_size=batch_size, epochs=epochs, sliding_windows=sliding_windows, target_strategy=target_strategy, nsamples=nsamples, num_workers=num_workers, tr_ratio=tr_ratio, seed=seed, verbose=verbose)

    end_time = time.time()
    if logs and verbose:
        print(f"\n> logs: imputation priSTI - Execution Time: {(end_time - start_time):.4f} seconds\n")

    return recov_data
