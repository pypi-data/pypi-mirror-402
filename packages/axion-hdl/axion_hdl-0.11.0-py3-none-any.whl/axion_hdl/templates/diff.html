{% extends 'base.html' %}

{% block head %}
<style>
    .diff-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .diff-header {
        background: var(--hover-bg);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .diff-header h5 {
        margin: 0;
        color: var(--text-color);
        font-weight: 600;
    }

    .diff-toggle {
        display: flex;
        gap: 0.5rem;
    }

    .diff-toggle .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .diff-toggle .btn.active {
        background: var(--primary-color);
        color: white;
    }

    .diff-toggle .btn:not(.active) {
        background: var(--hover-bg);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
    }

    /* Unified diff view */
    .diff-unified {
        font-family: 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        overflow-x: auto;
    }

    .diff-unified .diff-line {
        padding: 2px 1rem;
        white-space: pre;
        border-left: 3px solid transparent;
    }

    .diff-unified .diff-line.addition {
        background: rgba(34, 197, 94, 0.15);
        border-left-color: #22c55e;
        color: #4ade80;
    }

    [data-theme="light"] .diff-unified .diff-line.addition {
        background: #dcfce7;
        color: #166534;
    }

    .diff-unified .diff-line.deletion {
        background: rgba(239, 68, 68, 0.15);
        border-left-color: #ef4444;
        color: #f87171;
    }

    [data-theme="light"] .diff-unified .diff-line.deletion {
        background: #fee2e2;
        color: #991b1b;
    }

    .diff-unified .diff-line.header {
        background: var(--hover-bg);
        color: var(--text-muted);
        font-weight: 500;
        border-left-color: var(--text-muted);
    }

    .diff-unified .diff-line.context {
        background: var(--card-bg);
        color: var(--text-color);
    }

    /* Side-by-side diff view */
    .diff-split {
        display: none;
        font-family: 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', monospace;
        font-size: 0.85rem;
    }

    .diff-split.active {
        display: flex;
    }

    .diff-split-pane {
        flex: 1;
        overflow-x: auto;
    }

    .diff-split-pane.left {
        border-right: 1px solid var(--border-color);
    }

    .diff-split-pane .pane-header {
        background: var(--hover-bg);
        padding: 0.5rem 1rem;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        text-align: center;
    }

    .diff-split-pane .pane-header.old {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }

    [data-theme="light"] .diff-split-pane .pane-header.old {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #991b1b;
    }

    .diff-split-pane .pane-header.new {
        background: rgba(34, 197, 94, 0.1);
        color: #4ade80;
    }

    [data-theme="light"] .diff-split-pane .pane-header.new {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: #166534;
    }

    .diff-split .diff-line {
        padding: 2px 1rem;
        white-space: pre;
        min-height: 1.6em;
        line-height: 1.6;
    }

    .diff-split .left .diff-line.deletion {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
    }

    [data-theme="light"] .diff-split .left .diff-line.deletion {
        background: #fee2e2;
        color: #991b1b;
    }

    .diff-split .right .diff-line.addition {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
    }

    [data-theme="light"] .diff-split .right .diff-line.addition {
        background: #dcfce7;
        color: #166534;
    }

    .diff-split .diff-line.empty {
        background: var(--hover-bg);
    }

    /* No changes message */
    .no-changes {
        padding: 3rem;
        text-align: center;
        color: var(--text-muted);
    }

    .no-changes i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #10b981;
    }

    /* Button styling */
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn-confirm {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-cancel {
        background: var(--hover-bg);
        color: var(--text-color);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        background: var(--border-color);
    }

    .file-path {
        font-family: monospace;
        font-size: 0.875rem;
        color: var(--text-muted);
        background: var(--hover-bg);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}

<div class="hero" style="padding: 1.5rem 0;">
    <h1><i class="bi bi-file-diff me-2"></i>Review Changes</h1>
    <p class="subtitle">Module: <strong>{{ module_name }}</strong></p>
</div>

{% if file_path %}
<div class="mb-3">
    <span class="file-path"><i class="bi bi-file-code me-1"></i>{{ file_path }}</span>
</div>
{% endif %}

{% if diff %}
<div class="diff-container">
    <div class="diff-header">
        <h5><i class="bi bi-git me-2"></i>Changes Preview</h5>
        <div class="diff-toggle">
            <button class="btn active" onclick="showUnified()" id="btn-unified">
                <i class="bi bi-list"></i> Unified
            </button>
            <button class="btn" onclick="showSplit()" id="btn-split">
                <i class="bi bi-layout-split"></i> Side by Side
            </button>
        </div>
    </div>

    <!-- Unified diff view -->
    <div class="diff-unified" id="diff-unified">
        {% for line in diff.split('\n') %}
        {% if line.startswith('+++') or line.startswith('---') or line.startswith('@@') %}
        <div class="diff-line header">{{ line }}</div>
        {% elif line.startswith('+') %}
        <div class="diff-line addition">{{ line }}</div>
        {% elif line.startswith('-') %}
        <div class="diff-line deletion">{{ line }}</div>
        {% else %}
        <div class="diff-line context">{{ line }}</div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Side-by-side diff view -->
    <div class="diff-split" id="diff-split">
        <div class="diff-split-pane left">
            <div class="pane-header old"><i class="bi bi-file-minus me-1"></i>Original</div>
            <div class="pane-content">
                {% for line in diff.split('\n') %}
                {% if line.startswith('---') or line.startswith('@@') %}
                <div class="diff-line header">{{ line }}</div>
                {% elif line.startswith('-') and not line.startswith('---') %}
                <div class="diff-line deletion">{{ line[1:] }}</div>
                {% elif line.startswith('+') and not line.startswith('+++') %}
                <div class="diff-line empty">&nbsp;</div>
                {% elif not line.startswith('+++') %}
                <div class="diff-line context">{{ line[1:] if line.startswith(' ') else line }}</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class="diff-split-pane right">
            <div class="pane-header new"><i class="bi bi-file-plus me-1"></i>Modified</div>
            <div class="pane-content">
                {% for line in diff.split('\n') %}
                {% if line.startswith('+++') or line.startswith('@@') %}
                <div class="diff-line header">{{ line }}</div>
                {% elif line.startswith('+') and not line.startswith('+++') %}
                <div class="diff-line addition">{{ line[1:] }}</div>
                {% elif line.startswith('-') and not line.startswith('---') %}
                <div class="diff-line empty">&nbsp;</div>
                {% elif not line.startswith('---') %}
                <div class="diff-line context">{{ line[1:] if line.startswith(' ') else line }}</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="action-buttons">
    <a href="/module/{{ module_name }}{% if file_path %}?file={{ file_path | urlencode }}{% endif %}"
        class="btn-cancel">
        <i class="bi bi-x-lg"></i> Cancel
    </a>
    <form action="/api/confirm_save" method="post" style="margin: 0;">
        <input type="hidden" name="change_key" value="{{ change_key }}">
        <button type="submit" class="btn-confirm">
            <i class="bi bi-check-lg"></i> Confirm & Save
        </button>
    </form>
</div>

{% else %}
<div class="diff-container">
    <div class="no-changes">
        <i class="bi bi-check-circle-fill"></i>
        <h4>No Changes Detected</h4>
        <p>The source file content is identical to your edits.</p>
    </div>
</div>

<div class="action-buttons">
    <a href="/module/{{ module_name }}{% if file_path %}?file={{ file_path | urlencode }}{% endif %}"
        class="btn-cancel">
        <i class="bi bi-arrow-left"></i> Back to Editor
    </a>
</div>
{% endif %}

<script>
    function showUnified() {
        document.getElementById('diff-unified').style.display = 'block';
        document.getElementById('diff-split').classList.remove('active');
        document.getElementById('btn-unified').classList.add('active');
        document.getElementById('btn-split').classList.remove('active');
    }

    function showSplit() {
        document.getElementById('diff-unified').style.display = 'none';
        document.getElementById('diff-split').classList.add('active');
        document.getElementById('btn-unified').classList.remove('active');
        document.getElementById('btn-split').classList.add('active');
    }
</script>
{% endblock %}