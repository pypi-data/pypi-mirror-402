version: '3.9'

# ================================================================================
# RAG Memory MCP Server - Multi-Instance Docker Compose Template
# ================================================================================
# This is a PARAMETERIZED template for running multiple RAG Memory MCP instances.
# Each instance gets its own PostgreSQL, Neo4j, MCP server, and backup service.
#
# NAMING CONVENTION (CRITICAL FOR SAFETY):
#   All containers use prefix: rag-memory-mcp-{service}-{instance}
#   This distinguishes MCP stack containers from other rag-memory containers.
#
#   Container names:
#     - rag-memory-mcp-postgres-{instance}
#     - rag-memory-mcp-neo4j-{instance}
#     - rag-memory-mcp-server-{instance}
#     - rag-memory-mcp-backup-{instance}
#
#   Volume names (via project prefix):
#     - rag-memory-mcp-{instance}_postgres_data
#     - rag-memory-mcp-{instance}_neo4j_data
#     - rag-memory-mcp-{instance}_neo4j_logs
#
# Required environment variables (set via CLI or .env):
#   - INSTANCE_NAME: Unique instance identifier (e.g., "primary", "research")
#   - POSTGRES_PORT: PostgreSQL port (default: 54320)
#   - NEO4J_BOLT_PORT: Neo4j Bolt protocol port (default: 7687)
#   - NEO4J_HTTP_PORT: Neo4j HTTP/Browser port (default: 7474)
#   - MCP_PORT: MCP server SSE port (default: 8000)
#   - RAG_CONFIG_DIR: Path to config directory with config.yaml
#   - BACKUP_ARCHIVE_PATH: Path to backup archive directory
#
# Usage:
#   docker compose -p rag-memory-mcp-<instance-name> \
#     --env-file <env-file> \
#     -f docker-compose.instance.yml up -d
#
# Port Allocation Strategy (handled by instance registry):
#   Instance 1: PostgreSQL=54320, Neo4j Bolt=7687, Neo4j HTTP=7474, MCP=8000
#   Instance 2: PostgreSQL=54330, Neo4j Bolt=7688, Neo4j HTTP=7475, MCP=8001
#   Instance 3: PostgreSQL=54340, Neo4j Bolt=7689, Neo4j HTTP=7476, MCP=8002
# ================================================================================

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: rag-memory-mcp-postgres-${INSTANCE_NAME}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-raguser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ragpassword}
      POSTGRES_DB: ${POSTGRES_DB:-rag_memory}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../init.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-raguser} -d ${POSTGRES_DB:-rag_memory} && psql -U ${POSTGRES_USER:-raguser} -d ${POSTGRES_DB:-rag_memory} -tc 'SELECT 1' > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${POSTGRES_PORT:-54320}:5432"
    restart: unless-stopped
    networks:
      - rag-network
    labels:
      rag.memory.mcp.instance: "${INSTANCE_NAME}"
      rag.memory.mcp.service: "postgres"

  neo4j:
    image: neo4j:5-community
    container_name: rag-memory-mcp-neo4j-${INSTANCE_NAME}
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-graphiti-password}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
    volumes:
      - neo4j_data:/var/lib/neo4j/data
      - neo4j_logs:/var/lib/neo4j/logs
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-graphiti-password} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${NEO4J_BOLT_PORT:-7687}:7687"
      - "${NEO4J_HTTP_PORT:-7474}:7474"
    restart: unless-stopped
    networks:
      - rag-network
    labels:
      rag.memory.mcp.instance: "${INSTANCE_NAME}"
      rag.memory.mcp.service: "neo4j"

  server:
    # Image is built by setup.py using repo's docker-compose.yml
    # Do NOT add build section here - this template runs from system config dir
    image: rag-memory-mcp-server:latest
    container_name: rag-memory-mcp-server-${INSTANCE_NAME}
    shm_size: '2gb'
    ipc: host
    cap_add:
      - SYS_ADMIN
    environment:
      # Database URLs use Docker service names (internal network)
      DATABASE_URL: postgresql://${POSTGRES_USER:-raguser}:${POSTGRES_PASSWORD:-ragpassword}@postgres:5432/${POSTGRES_DB:-rag_memory}
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-graphiti-password}
      # Instance identification
      INSTANCE_NAME: ${INSTANCE_NAME}
      # CORS allowed origins for web frontend file uploads (comma-separated)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173}
    volumes:
      # Config directory (read-only)
      - ${RAG_CONFIG_DIR}:/root/.config/rag-memory:ro
      # USER_MOUNTS_PLACEHOLDER - Setup script will insert user directory mounts here
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 45s
    ports:
      - "${MCP_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: on-failure
    networks:
      - rag-network
    labels:
      rag.memory.mcp.instance: "${INSTANCE_NAME}"
      rag.memory.mcp.service: "server"

  backup:
    image: offen/docker-volume-backup:latest
    container_name: rag-memory-mcp-backup-${INSTANCE_NAME}
    restart: always
    volumes:
      - postgres_data:/backup/postgres:ro
      - neo4j_data:/backup/neo4j:ro
      - neo4j_logs:/backup/neo4j_logs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${BACKUP_ARCHIVE_PATH}:/archive
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      BACKUP_SOURCES: /backup
      BACKUP_FILENAME: "backup-${INSTANCE_NAME}-%Y-%m-%d_%H-%M-%S.tar.gz"
      BACKUP_FILENAME_EXPAND: "true"
      BACKUP_CRON_EXPRESSION: "${BACKUP_CRON_EXPRESSION:-5 2 * * *}"
      BACKUP_ARCHIVE: "/archive"
      BACKUP_LATEST_SYMLINK: "backup-${INSTANCE_NAME}-latest.tar.gz"
      BACKUP_RETENTION_DAYS: "${BACKUP_RETENTION_DAYS:-14}"
      BACKUP_PRUNING_PREFIX: "backup-${INSTANCE_NAME}-"
    healthcheck:
      test: ["CMD-SHELL", "test -w /archive || exit 1"]
      interval: 300s
      timeout: 10s
      retries: 2
      start_period: 30s
    networks:
      - rag-network
    labels:
      rag.memory.mcp.instance: "${INSTANCE_NAME}"
      rag.memory.mcp.service: "backup"
      description: "RAG Memory MCP - Automated Daily Backups for ${INSTANCE_NAME}"

volumes:
  postgres_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local

networks:
  rag-network:
    driver: bridge
