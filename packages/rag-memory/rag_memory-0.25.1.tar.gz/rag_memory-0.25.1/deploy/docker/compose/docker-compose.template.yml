version: '3.9'

# ================================================================================
# RAG Memory Local Deployment - Docker Compose Configuration
# ================================================================================
# This file defines all services for local development
# Configuration files are stored in OS-standard location via platformdirs
#   macOS: ~/Library/Application Support/rag-memory/
#   Linux: ~/.config/rag-memory/
#   Windows: %APPDATA%\rag-memory\
#   - config.yaml (application configuration, created by setup.py)
#
# NAMING CONVENTION (CRITICAL FOR SAFETY):
#   All containers use prefix: rag-memory-mcp-{service}-{instance}
#   This distinguishes MCP stack containers from other rag-memory containers.
#
# Usage:
#   This is a template file. Run setup.py to generate docker-compose.yml
#   After setup: docker-compose up -d
# Environment variables (set by setup.py in .env file):
#   - PROD_POSTGRES_PORT (default: 54320)
#   - PROD_NEO4J_BOLT_PORT (default: 7687)
#   - PROD_NEO4J_HTTP_PORT (default: 7474)
#   - PROD_MCP_PORT (default: 8000)
#   - BACKUP_CRON_EXPRESSION (default: 5 2 * * *)
#   - BACKUP_ARCHIVE_PATH (path to backup directory on host)
# ================================================================================

services:
  postgres-local:
    image: pgvector/pgvector:pg16
    container_name: rag-memory-mcp-postgres-local
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-raguser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ragpassword}
      POSTGRES_DB: ${POSTGRES_DB:-rag_memory}
    volumes:
      - postgres_data_local:/var/lib/postgresql/data
      - ../init.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-raguser} -d ${POSTGRES_DB:-rag_memory} && psql -U ${POSTGRES_USER:-raguser} -d ${POSTGRES_DB:-rag_memory} -tc 'SELECT 1' > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${PROD_POSTGRES_PORT:-54320}:5432"
    restart: unless-stopped
    networks:
      - rag-memory-local
    labels:
      rag.memory.mcp.instance: "local"
      rag.memory.mcp.service: "postgres"

  neo4j-local:
    image: neo4j:5-community
    container_name: rag-memory-mcp-neo4j-local
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-graphiti-password}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
    volumes:
      - neo4j_data_local:/var/lib/neo4j/data
      - neo4j_logs_local:/var/lib/neo4j/logs
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-graphiti-password} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${PROD_NEO4J_BOLT_PORT:-7687}:7687"  # Bolt - Database protocol
      - "${PROD_NEO4J_HTTP_PORT:-7474}:7474"  # HTTP - Neo4j Browser UI
    restart: unless-stopped
    networks:
      - rag-memory-local
    labels:
      rag.memory.mcp.instance: "local"
      rag.memory.mcp.service: "neo4j"

  rag-mcp-local:
    # Use pre-built image if available, otherwise build
    image: rag-memory-mcp-server:latest
    build:
      context: ../../../
      dockerfile: deploy/docker/Dockerfile
    container_name: rag-memory-mcp-server-local
    shm_size: '2gb'  # Required for Chromium/Playwright web crawling
    ipc: host  # Recommended by Playwright for Chromium to avoid memory issues
    cap_add:
      - SYS_ADMIN  # Recommended by Playwright for Chromium in Docker
    environment:
      # Override database URLs to use Docker service names instead of localhost
      DATABASE_URL: postgresql://${POSTGRES_USER:-raguser}:${POSTGRES_PASSWORD:-ragpassword}@postgres-local:5432/${POSTGRES_DB:-rag_memory}
      NEO4J_URI: bolt://neo4j-local:7687
      # NEO4J_USER and NEO4J_PASSWORD will come from config.yaml
      # CORS allowed origins for web frontend file uploads (comma-separated)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173}
    volumes:
      # Mount config directory so MCP server can read config.yaml
      # Config includes server settings and directory mount specifications
      - ${RAG_CONFIG_DIR}:/root/.config/rag-memory:ro
      # USER_MOUNTS_PLACEHOLDER - Setup script will insert user directory mounts here
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 45s
    ports:
      - "${MCP_SSE_PORT:-8000}:8000"
    depends_on:
      postgres-local:
        condition: service_healthy
      neo4j-local:
        condition: service_healthy
    restart: on-failure
    networks:
      - rag-memory-local
    labels:
      rag.memory.mcp.instance: "local"
      rag.memory.mcp.service: "server"

  # ============================================================================
  # Automated Backups - Creates daily TAR archives of database volumes
  # ============================================================================
  backup-local:
    image: offen/docker-volume-backup:latest
    container_name: rag-memory-mcp-backup-local
    restart: always
    volumes:
      - postgres_data_local:/backup/postgres:ro
      - neo4j_data_local:/backup/neo4j:ro
      - neo4j_logs_local:/backup/neo4j_logs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # BACKUP_MOUNT_PLACEHOLDER - Setup script will insert backup destination mount here
    depends_on:
      postgres-local:
        condition: service_healthy
      neo4j-local:
        condition: service_healthy
    environment:
      BACKUP_SOURCES: /backup
      BACKUP_FILENAME_EXPAND: "true"
      BACKUP_CRON_EXPRESSION: "${BACKUP_CRON_EXPRESSION:-5 2 * * *}"
      BACKUP_ARCHIVE: "/archive"
      BACKUP_LATEST_SYMLINK: "backup-latest.tar.gz"
      BACKUP_RETENTION_DAYS: "${BACKUP_RETENTION_DAYS:-14}"
      BACKUP_PRUNING_PREFIX: "backup-"
    healthcheck:
      test: ["CMD-SHELL", "test -w /archive || exit 1"]
      interval: 300s
      timeout: 10s
      retries: 2
      start_period: 30s
    labels:
      rag.memory.mcp.instance: "local"
      rag.memory.mcp.service: "backup"
      description: "RAG Memory MCP - Automated Daily Backups"
    networks:
      - rag-memory-local

volumes:
  postgres_data_local:
    driver: local
  neo4j_data_local:
    driver: local
  neo4j_logs_local:
    driver: local

networks:
  rag-memory-local:
    driver: bridge
