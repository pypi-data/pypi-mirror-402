# 功能规范: UniTools SDK

**功能分支**: `001-unitools-sdk`
**创建时间**: 2026-01-14
**状态**: 草稿
**输入**: 用户描述: "UniTools SDK implementation"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 核心工具注册与执行 (优先级: P1)

作为一名开发者，我希望能够将现有的函数和类注册为工具，并通过统一的入口执行它们，以便于集中管理业务逻辑。

**优先级原因**: 这是框架的最基础功能，没有注册和执行机制，框架无法运行。

**独立测试**: 可以通过编写单元测试，验证被装饰的函数是否出现在注册表中，以及是否可以通过 `dispatch` 方法成功调用并返回结果。

**验收场景**: 

1. **给定** 一个用 `@u.tool` 装饰的函数，**当** 检查 `u._registry` 时，**那么** 该函数应包含在内且元数据正确。
2. **给定** 一个注册的工具，**当** 调用 `u.dispatch` 传入模拟的 ToolCall 时，**那么** 该工具函数应被执行并返回结果。
3. **给定** 一个带有 `Injected` 参数的工具，**当** 调用 `u.dispatch` 并提供 context 时，**那么** 参数应被正确注入，工具函数不应感知注入过程。

---

### 用户故事 2 - 中间件流水线治理 (优先级: P2)

作为一名开发者，我希望配置全局、作用域级和工具级的中间件，以便在不修改业务代码的情况下实现鉴权、日志和监控等功能。

**优先级原因**: 中间件机制是 "治理" 的核心，区分于普通函数调用的关键特性。

**独立测试**: 可以定义简单的日志或鉴权中间件，验证其执行顺序和拦截逻辑。

**验收场景**: 

1. **给定** 配置了全局中间件和工具级中间件，**当** 执行工具时，**那么** 中间件应按照 全局 -> 作用域 -> 局部 的顺序执行。
2. **给定** 多个相同 ID 的中间件，**当** 执行时，**那么** 应进行去重，仅执行优先级最高的一个。
3. **给定** 一个标记为 `critical=True` 的中间件抛出异常，**当** 执行流水线时，**那么** 整个执行应中断并抛出错误。
4. **给定** 一个标记为 `critical=False` 的中间件抛出异常，**当** 执行流水线时，**那么** 错误应被记录，且执行继续进行。

---

### 用户故事 3 - 协议适配与工具筛选 (优先级: P3)

作为一名开发者，我希望能够根据标签筛选工具集，并自动适配不同 LLM (如 OpenAI) 的协议，以便灵活切换模型。

**优先级原因**: 实现与 LLM 的解耦，支持多模型是框架的高级价值。

**独立测试**: 验证筛选表达式逻辑，以及 Driver 是否能生成符合 OpenAI 规范的 JSON Schema。

**验收场景**: 

1. **给定** 一组带有不同 Tag 的工具，**当** 使用 `u[Tag('a') & ~Tag('b')]` 查询时，**那么** 返回的 ToolSet 应仅包含符合条件的工具。
2. **给定** 一个 ToolSet，**当** 调用 `render('gpt-4o')` 时，**那么** 应返回符合 OpenAI Function Calling 格式的 JSON Schema。
3. **给定** 一个 OpenAI 格式的响应，**当** 调用 `u.dispatch` 时，**那么** 系统应能自动选择 OpenAIDriver 进行解析。

---

### 边界情况

- 当注册重名工具时会发生什么？(应报错，防止隐式覆盖)
- 当 `dispatch` 收到不支持的 LLM 响应格式时，系统如何处理？(应抛出无法解析的错误)
- 当依赖注入缺少必要的 Context Key 时，执行应如何反馈？(应抛出 ValidationError 或类似错误)
- 异步与同步工具混合在同一个流水线中时，执行顺序是否受影响？(应统一封装为异步处理)

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须提供一个**统一管理单元** (如 Universe)，作为单例或上下文管理器，协调注册表、中间件和驱动池。
- **FR-002**: 系统必须提供**函数注册机制** (如装饰器)，支持注册单个函数，并自动提取名称、参数模型和文档等元数据。注册时必须验证工具名称符合 `^[a-zA-Z0-9_-]+$` 规范，防止非法字符导致 LLM 调用失败。
- **FR-003**: 系统必须提供**批量绑定机制**，支持将类中的方法批量注册为工具，并支持前缀和排除配置。
- **FR-004**: 系统必须维护**工具元数据**结构，存储工具的静态属性 (名称、标签) 和运行时所需的依赖注入信息。参数模型必须基于 Pydantic 构建，以确保类型安全和自动 Schema 生成。
- **FR-005**: 系统必须支持**中间件配置**，允许注册全局、作用域级 (Scope) 和工具级 (Local) 的中间件，并支持关键性 (Critical) 设置。
- **FR-006**: 系统必须实现**流水线执行机制** (洋葱模型)，确保中间件按正确顺序执行，并具备去重和异常隔离能力。
- **FR-007**: 系统必须实现**依赖注入**机制，能够在工具执行前从上下文中自动填充标记为注入的参数。当依赖注入缺少必要的 Context Key 时，系统必须抛出 `MissingContextKeyError`，并提供可扩展的错误处理机制。当依赖注入的参数类型不匹配时，系统必须抛出 `InvalidContextTypeError`，并提供可扩展的错误处理机制。
- **FR-008**: 系统必须实现**工具筛选表达式**引擎，支持使用标签 (Tag) 和前缀 (Prefix) 以及逻辑运算符 (与/或/非) 来动态筛选工具集。
- **FR-009**: 系统必须实现**多协议驱动**架构，支持通过适配器模式生成不同 LLM (如 OpenAI) 所需的 Schema 并解析其响应。
- **FR-010**: 系统必须提供**统一分发** (Dispatch) 能力，自动协调驱动选择、响应解析、权限校验和流水线执行。当注册重名工具时，系统必须抛出 `DuplicateToolError`，禁止隐式覆盖。当收到不支持的 LLM 响应格式时，系统必须抛出 `UnsupportedResponseFormatError`，并提供可扩展的错误处理机制。
- **FR-011**: 系统必须实现**异步执行**机制，能够正确处理异步工具的执行顺序和结果聚合。当异步与同步工具混合在同一个流水线中时，系统必须统一封装为异步处理。当工具执行过程中发生异常时，系统必须抛出 `ToolExecutionError`，并提供可扩展的错误处理机制。
- **FR-012**: 系统必须实现**工具文档**机制，能够自动从函数文档中提取参数说明和示例，并生成符合 OpenAI 格式的 JSON Schema。
- **FR-013**: 系统必须实现**工具审计**机制，能够记录工具的执行历史，并提供审计日志功能。当工具执行过程中发生异常时，系统必须记录异常信息，并提供审计日志功能。
- **FR-014**: 系统必须实现**工具监控**机制，能够监控工具的执行状态，并提供监控日志功能。当工具执行过程中发生异常时，系统必须记录异常信息，并提供监控日志功能。
- **FR-015**: 系统必须实现**工具告警**机制，能够监控工具的执行状态，并提供告警日志功能。当工具执行过程中发生异常时，系统必须记录异常信息，并提供告警日志功能。

### 关键实体 *(如果功能涉及数据则包含)*

- **Universe (管理单元)**: 核心控制台，协调所有组件。
- **ToolMetadata (元数据)**: 工具的属性描述。
- **ToolExpression (表达式)**: 用于筛选工具的逻辑规则。
- **Middleware (中间件)**: 拦截和处理执行流程的组件。
- **Driver (驱动)**: 协议适配器，处理特定 LLM 的输入输出格式。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 开发者可以通过不到 5 行代码完成一个带依赖注入功能的工具注册。
- **SC-002**: 系统能够正确解析 OpenAI 格式的 Function Call 响应并执行对应工具，成功率 100% (在格式正确的前提下)。
- **SC-003**: 中间件流水线能够正确拦截异常，对于非关键中间件的失败，主流程不受影响。
- **SC-004**: 工具筛选表达式 (`Tag('A') & Tag('B')`) 能够准确过滤出符合条件的工具子集。
