# 功能规范: ToolExpression 增强

**功能分支**: `003-enhance-tool-expr`
**创建时间**: 2026-01-19
**状态**: 草稿
**输入**: 用户描述: "帮我实现@docs/roadmap.md 的`ToolExpression 增强`"

## 用户场景与测试

### 用户故事 1 - 表达式字符串化与解析 (DSL) (优先级: P2)

作为系统管理员或配置维护者，我希望能够以字符串形式（如配置文件）定义工具过滤规则（DSL），并将其解析为可执行的表达式对象，以便于动态调整策略而无需修改代码。

**优先级原因**: 支持配置化驱动，增强系统的灵活性。

**独立测试**: 编写 parser 测试，输入字符串，验证生成的表达式结构和匹配行为。

**验收场景**:

1. **给定** DSL 字符串 `"network | io"`, **当** 解析并用于匹配包含 "io" 标签的工具时, **那么** 结果应为 True。
2. **给定** DSL 字符串 `"(network | io) & ~deprecated"`, **当** 匹配包含 "network" 和 "deprecated" 标签的工具时, **那么** 结果应为 False。
3. **给定** 错误的语法字符串 `"(network |"`, **当** 解析时, **那么** 应抛出明确的语法错误。
4. **给定** 过滤条件以字符串输入并由 Universe 解析, **当** 输入 `"network | io"` 并用于过滤时, **那么** 匹配结果应与解析后的表达式对象一致。
5. **给定** DSL 字符串 `^tool_`, **当** 匹配名称为 `tool_fetch` 的工具时, **那么** 结果应为 True。
6. **给定** DSL 字符串 `` `check_balance` ``, **当** 匹配名称为 `check_balance` 的工具时, **那么** 结果应为 True。

---

### 用户故事 2 - 表达式诊断与调试 (优先级: P2)

作为开发者，当一个工具意外地被过滤掉或被选中时，我希望能获得详细的诊断信息（命中路径或拒绝原因），以便于快速定位过滤逻辑中的问题。

**优先级原因**: 随着表达式复杂度增加，调试变得困难，需要工具支持。

**独立测试**: 对特定表达式调用诊断方法，检查返回的 trace 信息。

**验收场景**:

1. **给定** 表达式 `Tag("a") & Tag("b")` 和仅有标签 "a" 的工具, **当** 请求诊断信息时, **那么** 应指出 `Tag("b")` 部分匹配失败导致整体失败。
2. **给定** 复杂表达式, **当** 匹配成功时, **那么** 应能展示命中的具体路径（例如 "Tag 命中了 'a'"）。

---

### 用户故事 3 - 表达式优化 (优先级: P3)

作为框架维护者，我希望系统能自动简化低效的表达式（如重复的 OR、双重否定），以保证在大规模匹配时的性能。

**优先级原因**: 性能优化，虽非功能阻塞，但对长期维护很重要。

**独立测试**: 构造冗余表达式，断言简化后的表达式结构。

**验收场景**:

1. **给定** 表达式 `Tag("a") | Tag("a")`, **当** 进行简化处理后, **那么** 应变为单一的 `Tag("a")`。
2. **给定** 表达式 `~~Tag("a")`, **当** 进行简化处理后, **那么** 应变为 `Tag("a")`。

---

### 边界情况
- **非法字符**: DSL 解析时遇到不支持的字符或格式。
- **非法标签**: 标签名包含空格或特殊字符时应视为非法输入并抛错。
- **关键字符冲突**: 标签名包含 DSL 关键字符（如 `:`, `|`, `&`, `~`）时应视为非法输入并抛错。
- **大小写敏感**: `name`、`prefix`、`tags` 以及标签匹配应区分大小写。
- **解析失败**: Universe 接收字符串过滤条件解析失败时应抛出明确的解析错误。
- **循环引用**: 虽然目前表达式是树状的，但需确保解析或组合不会导致栈溢出（深度过大）。
- **引号不支持**: 标签中包含空格、特殊符号一律非法，不提供引号转义或兼容路径。
- **前缀简写**: 支持以 `^` 开头的前缀简写（如 `^tool_`），等价于 `prefix:tool_`。

## 需求

### 功能需求

- **FR-001**: 系统必须提供表达式解析器，支持逻辑运算符 `|` (OR), `&` (AND), `~` (NOT) 以及括号分组。
- **FR-002**: 系统必须支持对表达式进行规范化和简化（如去重、扁平化）。
- **FR-003**: 系统必须提供诊断接口，返回匹配结果及详细原因（Trace）。
- **FR-004**: DSL 语法必须支持基本的标签引用，不支持通配符；语法仅限 `prefix:finance`, `name:check_balance`, `tags:(finance | ops)`。其中 `name` 为名称精准匹配、`prefix` 为前缀匹配；如果只有`tags`时,  `tags:(finance | ops)` 等价于 `finance | ops`；否定写法支持 `~(finance | ops)` 与 `~tags:(finance | ops)`。
- **FR-004a**: DSL 语法必须支持 `^tool_` 等价 `prefix:tool_`，以及 `` `tool_name` `` 等价 `name:tool_name` 的简写形式。
- **FR-005**: Universe 必须支持直接接收字符串过滤条件，并将其解析为 DSL 表达式后进行过滤；仅允许符合 DSL 的字符串，否则抛出明确的解析错误。

### 关键实体

- **ToolExpression**: 核心基类，增强诊断和序列化能力。
- **Universe**: 工具集合入口，支持字符串过滤条件的解析与匹配。
- **ExpressionParser**: 负责将字符串转换为 `ToolExpression` 对象。

## 约束与权衡

- DSL 解析必须使用 Lark 库。

## 成功标准

### 可衡量的结果

- **SC-001**: DSL 解析器通过率 100%，能够正确解析包含嵌套括号和所有操作符的复杂表达式。
- **SC-002**: 诊断模式下，能够准确指出表达式树中导致 True/False 的具体叶子节点。
- **SC-003**: 表达式简化逻辑能将 `A | A` 等简单冗余结构减少为最简形式。

## Clarifications

### Session 2026-01-19

- Q: 当 Tag 名称包含空格或特殊字符时，应该如何处理？ → A: 一律视为非法标签并报错。
- Q: Universe 是否可以直接接收字符串输入并解析为 DSL？ → A: 可以，且 DSL 解析使用 Lark 库。
- Q: Universe 接收字符串并解析 DSL 失败时如何处理？ → A: 抛出明确的解析错误。
- Q: Universe 接收字符串过滤条件的有效性范围是什么？ → A: 仅允许符合 DSL 的字符串，否则抛出明确的解析错误。
- Q: Universe 接收字符串时如何区分标签名与 DSL？ → A: 一律按 DSL 解析；同时 `name` 为精准匹配、`prefix` 为前缀匹配。
- Q: 当标签名包含 DSL 关键字符（如 `:`, `|`, `&`, `~`）时应如何处理？ → A: 一律视为非法标签并报错。
- Q: DSL 中的匹配是否区分大小写？ → A: `name`、`prefix`、`tags` 及标签匹配全部大小写敏感。
- Q: `排除` 写法: `~(finance | ops)` 等价于 `~tags:(finance | ops)`, 语义为: 排除任一标签; `~prefix:finance`,  语义为: 排除前缀为 `finance` 的工具; `~name:check_balance`, 语义为: 排除名称精准为 `check_balance` 的工具。
