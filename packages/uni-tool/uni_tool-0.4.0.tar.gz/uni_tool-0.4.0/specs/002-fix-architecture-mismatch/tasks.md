# ä»»åŠ¡: æ¶æ„ä¸€è‡´æ€§å¯¹é½

**è¾“å…¥**: æ¥è‡ª `/specs/002-fix-architecture-mismatch/` çš„è®¾è®¡æ–‡æ¡£
**å‰ç½®æ¡ä»¶**: plan.md(å¿…éœ€)ã€spec.md(ç”¨æˆ·æ•…äº‹å¿…éœ€)ã€research.mdã€data-model.mdã€contracts/

**æµ‹è¯•**: æµ‹è¯•ä»»åŠ¡ä»…åœ¨åŠŸèƒ½è§„èŒƒä¸­æ˜ç¡®è¦æ±‚æ—¶æ‰åŒ…å«ã€‚

**ç»„ç»‡ç»“æ„**: ä»»åŠ¡æŒ‰ç”¨æˆ·æ•…äº‹åˆ†ç»„, ä»¥ä¾¿æ¯ä¸ªæ•…äº‹èƒ½å¤Ÿç‹¬ç«‹å®æ–½å’Œæµ‹è¯•.

## æ ¼å¼: `[ID] [P?] [Story] æè¿°`
- **[P]**: å¯ä»¥å¹¶è¡Œè¿è¡Œ(ä¸åŒæ–‡ä»¶, æ— ä¾èµ–å…³ç³»)
- **[Story]**: æ­¤ä»»åŠ¡å±äºå“ªä¸ªç”¨æˆ·æ•…äº‹(ä¾‹å¦‚: US1ã€US2ã€US3)
- åœ¨æè¿°ä¸­åŒ…å«ç¡®åˆ‡çš„æ–‡ä»¶è·¯å¾„

## è·¯å¾„çº¦å®š
- å•ä¸€é¡¹ç›®: ä»“åº“æ ¹ç›®å½•ä¸‹çš„ `uni_tool/`ã€`tests/`

---

## é˜¶æ®µ 0: è®¾è®¡å®¡æŸ¥(é—¨æ§)

**ç›®çš„**: å¯¹ `Universe` ä¸ `Driver` æŠ½è±¡å˜æ›´è¿›è¡Œè®¾è®¡å®¡æŸ¥

- [X] T000 åœ¨ `specs/002-fix-architecture-mismatch/spec.md` ä¸ `specs/002-fix-architecture-mismatch/plan.md` å®Œæˆè®¾è®¡å®¡æŸ¥è®°å½•ä¸ç»“è®º

---

## é˜¶æ®µ 1: è®¾ç½®(å…±äº«åŸºç¡€è®¾æ–½)

**ç›®çš„**: é¡¹ç›®åˆå§‹åŒ–å’Œå…³é”®ç±»å‹å¯¹é½

- [X] T001 åœ¨ `uni_tool/core/models.py` è¡¥é½ `ModelProfile` æ•°æ®ç»“æ„å¹¶å¯¹é½ `ToolCall`/`ToolResult` å­—æ®µç±»å‹
- [X] T002 åœ¨ `uni_tool/drivers/base.py` å¢åŠ  `can_handle`/`can_handle_response` è¯„åˆ†æ¥å£

---

## é˜¶æ®µ 2: åŸºç¡€(é˜»å¡å‰ç½®æ¡ä»¶)

**ç›®çš„**: åœ¨ä»»ä½•ç”¨æˆ·æ•…äº‹å¯ä»¥å®æ–½ä¹‹å‰å¿…é¡»å®Œæˆçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½

**âš ï¸ å…³é”®**: åœ¨æ­¤é˜¶æ®µå®Œæˆä¹‹å‰, æ— æ³•å¼€å§‹ä»»ä½•ç”¨æˆ·æ•…äº‹å·¥ä½œ

- [X] T003 åœ¨ `uni_tool/core/expressions.py` å®ç° `ToolExpression`/`And`/`Or`/`Not`ï¼Œå¹¶åœ¨ `uni_tool/filters/__init__.py` å®ç° `Tag`/`Prefix`/`ToolName`
- [X] T004 åœ¨ `uni_tool/core/models.py` ä¸ `uni_tool/middlewares/base.py` è°ƒæ•´ `MiddlewareObj.uid` é»˜è®¤ç”Ÿæˆè§„åˆ™ä¸ºç±»å/å‡½æ•°åç¨³å®šå€¼
- [X] T005 åœ¨ `uni_tool/core/universe.py` å¢åŠ é©±åŠ¨è¯„åˆ†é€‰æ‹©çš„å†…éƒ¨å·¥å…·å‡½æ•°, ä¾› `render/dispatch` å…±ç”¨

**æ£€æŸ¥ç‚¹**: åŸºç¡€å°±ç»ª - ç°åœ¨å¯ä»¥å¼€å§‹å¹¶è¡Œå®æ–½ç”¨æˆ·æ•…äº‹

---

## é˜¶æ®µ 3: ç”¨æˆ·æ•…äº‹ 1 - æŒ‰æ ‡ç­¾è·å–å¹¶æ¸²æŸ“å·¥å…·é›†åˆ(ä¼˜å…ˆçº§: P1)ğŸ¯ MVP

**ç›®æ ‡**: é€šè¿‡æ ‡ç­¾ç­›é€‰å·¥å…·å¹¶ä¾æ®æ¨¡å‹èƒ½åŠ›æ¸²æŸ“å¯ç”¨å·¥å…·é›†åˆ

**ç‹¬ç«‹æµ‹è¯•**: ä½¿ç”¨å«/ä¸å«æ ‡ç­¾çš„å·¥å…·é›†å¹¶é€‰æ‹©ç›®æ ‡æ¨¡å‹, éªŒè¯ç­›é€‰ç»“æœä¸æ¸²æŸ“åè®®æ­£ç¡®æ€§

### ç”¨æˆ·æ•…äº‹ 1 çš„å®æ–½

- [X] T006 [US1] åœ¨ `uni_tool/core/universe.py` è°ƒæ•´ `__getitem__` å¯¹ `str` èµ° Tag è¿‡æ»¤å¹¶è¿”å› `ToolSet`, `get` ä»…ç”¨äºæŒ‰åç§°è·å–
- [X] T007 [P] [US1] åœ¨ `uni_tool/core/models.py` æ–°å¢ `ToolSet` æ•°æ®ç±»(åŒ…å« `tools/expression/drivers`)
- [X] T008 [US1] åœ¨ `uni_tool/core/universe.py` å®ç° `ToolSet.render` åå•†é€»è¾‘(æ¨¡å‹å -> `ModelProfile` -> `BaseDriver.can_handle`)
- [X] T009 [US1] åœ¨ `uni_tool/core/universe.py` å¤„ç†ç©ºæ ‡ç­¾è¿‡æ»¤è¿”å›ç©ºé›†åˆä¸”å¯å®‰å…¨æ¸²æŸ“

**æ£€æŸ¥ç‚¹**: æ­¤æ—¶, ç”¨æˆ·æ•…äº‹ 1 åº”è¯¥å®Œå…¨åŠŸèƒ½åŒ–ä¸”å¯ç‹¬ç«‹æµ‹è¯•

---

## é˜¶æ®µ 4: ç”¨æˆ·æ•…äº‹ 2 - å®‰å…¨è¿‡æ»¤ä¸åè®®è‡ªåŠ¨è¯†åˆ«çš„å·¥å…·è°ƒåº¦(ä¼˜å…ˆçº§: P2)

**ç›®æ ‡**: è°ƒåº¦æ—¶æ”¯æŒ ToolExpression å®‰å…¨è¿‡æ»¤å¹¶è‡ªåŠ¨è¯†åˆ«åè®®

**ç‹¬ç«‹æµ‹è¯•**: æ„é€ åŒ…å«å…è®¸ä¸ä¸å…è®¸å·¥å…·è°ƒç”¨çš„å“åº”éªŒè¯è¿‡æ»¤; ä½¿ç”¨ä¸åŒåè®®å“åº”éªŒè¯è‡ªåŠ¨è¯†åˆ«ä¸æ˜¾å¼åè®®è¦†ç›–

### ç”¨æˆ·æ•…äº‹ 2 çš„å®æ–½

- [X] T010 [US2] åœ¨ `uni_tool/core/universe.py` çš„ `dispatch` å¢åŠ  `tool_filter` å‚æ•°å¹¶åº”ç”¨ `ToolExpression`
- [X] T011 [US2] åœ¨ `uni_tool/core/universe.py` æ”¯æŒæœªæŒ‡å®šåè®®æ—¶åŸºäº `can_handle_response` è‡ªåŠ¨è¯†åˆ«, è¯†åˆ«å¤±è´¥è¿”å›é”™è¯¯ç»“æœä½†ä¸ä¸­æ–­è°ƒåº¦
- [X] T012 [P] [US2] åœ¨ `uni_tool/drivers/openai.py` å®ç° `can_handle`/`can_handle_response` å¹¶å¯¹é½ `parse` è¾“å‡ºç»“æ„
- [X] T013 [P] [US2] åœ¨ `uni_tool/drivers/anthropic.py` æ–°å¢é©±åŠ¨å®ç° `render/parse/can_handle/can_handle_response`
- [X] T014 [P] [US2] åœ¨ `uni_tool/drivers/xml.py` æ–°å¢é©±åŠ¨å®ç° `render/parse/can_handle/can_handle_response`
- [X] T015 [P] [US2] åœ¨ `uni_tool/drivers/markdown.py` æ–°å¢é©±åŠ¨å®ç° `render/parse/can_handle/can_handle_response`
- [X] T016 [US2] åœ¨ `uni_tool/drivers/__init__.py` å¯¼å‡ºæ–°é©±åŠ¨å¹¶è¡¥å……æ³¨å†Œå…¥å£

**æ£€æŸ¥ç‚¹**: æ­¤æ—¶, ç”¨æˆ·æ•…äº‹ 2 åº”è¯¥ç‹¬ç«‹å¯ç”¨ä¸”å¯ç‹¬ç«‹æµ‹è¯•

---

## é˜¶æ®µ 5: ç”¨æˆ·æ•…äº‹ 3 - å¯é…ç½®ç»‘å®šã€ä¸­é—´ä»¶å»é‡ä¸å¤šè°ƒç”¨æ€§èƒ½(ä¼˜å…ˆçº§: P3)

**ç›®æ ‡**: ç»‘å®šå¯æ’é™¤/å¯é…ç½®ä¸­é—´ä»¶, å»é‡ç¨³å®š, å¤šè°ƒç”¨å¹¶è¡Œä¸”é¡ºåºç¨³å®š

**ç‹¬ç«‹æµ‹è¯•**: é…ç½®æ’é™¤åˆ—è¡¨ä¸ä¸­é—´ä»¶å»é‡éªŒè¯è¦†ç›–è§„åˆ™; æ„é€ å¤šè°ƒç”¨å“åº”éªŒè¯å¹¶è¡Œæ‰§è¡Œä¸é¡ºåºç¨³å®š

### ç”¨æˆ·æ•…äº‹ 3 çš„å®æ–½

- [X] T017 [US3] åœ¨ `uni_tool/decorators/bind.py` å¢åŠ  `exclude`/`middlewares` å‚æ•°å¹¶ä¼ å…¥ `ToolMetadata`
- [X] T018 [US3] åœ¨ `uni_tool/middlewares/base.py` æ›´æ–° `deduplicate_middlewares` ä½¿ç”¨ç¨³å®š `uid` è¦†ç›–é€»è¾‘
- [X] T019 [US3] åœ¨ `uni_tool/core/execution.py` å°† `execute_tool_calls` æ”¹ä¸º `asyncio.gather` å¹¶ä¿æŒç»“æœé¡ºåº
- [X] T020 [US3] åœ¨ `uni_tool/core/execution.py` ä¸ºæ¯ä¸ª `ToolCall.context` åˆ›å»ºç‹¬ç«‹æ‹·è´ä»¥ä¿è¯éš”ç¦»

**æ£€æŸ¥ç‚¹**: æ‰€æœ‰ç”¨æˆ·æ•…äº‹ç°åœ¨åº”è¯¥ç‹¬ç«‹åŠŸèƒ½åŒ–

---

## é˜¶æ®µ N: å®Œå–„ä¸æ¨ªåˆ‡å…³æ³¨ç‚¹

**ç›®çš„**: å½±å“å¤šä¸ªç”¨æˆ·æ•…äº‹çš„æ”¹è¿›

- [X] T021 è¿è¡Œ `uv run pytest tests/unit` éªŒè¯æ ¸å¿ƒè¿‡æ»¤ã€é©±åŠ¨åå•†ä¸ä¸­é—´ä»¶å»é‡çš„åŸºçº¿
- [X] T022 åœ¨ `tests/contract/test_driver_contracts.py` è¡¥å…… OpenAI/Anthropic/XML/markdown é©±åŠ¨å¥‘çº¦æµ‹è¯•
- [X] T023 åœ¨ `tests/integration/test_execution.py` å¢åŠ å¹¶è¡Œæ‰§è¡Œæ€§èƒ½åŸºçº¿ä¸ â‰¥30% æå‡æ–­è¨€
- [X] T024 åœ¨ `tests/integration/test_full_flow.py` å¢åŠ åè®®è‡ªåŠ¨è¯†åˆ«æˆåŠŸç‡ 100% çš„ç”¨ä¾‹
- [X] T025 åœ¨ `tests/integration/test_full_flow.py` å¢åŠ å·¥å…·è¿‡æ»¤æ‹’ç»å‡†ç¡®ç‡ 100% çš„ç”¨ä¾‹

---

## ä¾èµ–å…³ç³»ä¸æ‰§è¡Œé¡ºåº

### é˜¶æ®µä¾èµ–å…³ç³»

- **è®¾è®¡å®¡æŸ¥(é˜¶æ®µ 0)**: æ— ä¾èµ–å…³ç³» - å¿…é¡»å…ˆå®Œæˆ
- **è®¾ç½®(é˜¶æ®µ 1)**: ä¾èµ–è®¾è®¡å®¡æŸ¥å®Œæˆ
- **åŸºç¡€(é˜¶æ®µ 2)**: ä¾èµ–äºè®¾ç½®å®Œæˆ - é˜»å¡æ‰€æœ‰ç”¨æˆ·æ•…äº‹
- **ç”¨æˆ·æ•…äº‹(é˜¶æ®µ 3+)**: éƒ½ä¾èµ–äºåŸºç¡€é˜¶æ®µå®Œæˆ
  - ç„¶åç”¨æˆ·æ•…äº‹å¯ä»¥å¹¶è¡Œè¿›è¡Œ(å¦‚æœæœ‰äººå‘˜)
  - æˆ–æŒ‰ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œ(P1 â†’ P2 â†’ P3)
- **å®Œå–„(æœ€ç»ˆé˜¶æ®µ)**: ä¾èµ–äºæ‰€æœ‰æœŸæœ›çš„ç”¨æˆ·æ•…äº‹å®Œæˆ

### ç”¨æˆ·æ•…äº‹ä¾èµ–å…³ç³»

- **ç”¨æˆ·æ•…äº‹ 1(P1)**: å¯åœ¨åŸºç¡€(é˜¶æ®µ 2)åå¼€å§‹ - æ— å…¶ä»–æ•…äº‹ä¾èµ–
- **ç”¨æˆ·æ•…äº‹ 2(P2)**: å¯åœ¨åŸºç¡€(é˜¶æ®µ 2)åå¼€å§‹ - å¯ä¸ US1 é›†æˆä½†åº”ç‹¬ç«‹å¯æµ‹è¯•
- **ç”¨æˆ·æ•…äº‹ 3(P3)**: å¯åœ¨åŸºç¡€(é˜¶æ®µ 2)åå¼€å§‹ - å¯ä¸ US1/US2 é›†æˆä½†åº”ç‹¬ç«‹å¯æµ‹è¯•

### æ¯ä¸ªç”¨æˆ·æ•…äº‹å†…éƒ¨

- æ¨¡å‹/ç±»å‹åœ¨æœåŠ¡ä¹‹å‰
- è¿‡æ»¤ä¸åå•†åœ¨è°ƒåº¦ä¹‹å‰
- æ ¸å¿ƒå®ç°å®Œæˆåæ‰ç§»è‡³ä¸‹ä¸€ä¸ªä¼˜å…ˆçº§

### å¹¶è¡Œæœºä¼š

- æ‰€æœ‰æ ‡è®°ä¸º [P] çš„åŸºç¡€ä»»åŠ¡å¯ä»¥å¹¶è¡Œè¿è¡Œ
- åŸºç¡€é˜¶æ®µå®Œæˆå, æ‰€æœ‰ç”¨æˆ·æ•…äº‹å¯ä»¥å¹¶è¡Œå¼€å§‹(å¦‚æœå›¢é˜Ÿå®¹é‡å…è®¸)
- ç”¨æˆ·æ•…äº‹ä¸­æ‰€æœ‰æ ‡è®°ä¸º [P] çš„é©±åŠ¨å®ç°å¯ä»¥å¹¶è¡Œè¿è¡Œ
- ä¸åŒç”¨æˆ·æ•…äº‹å¯ä»¥ç”±ä¸åŒå›¢é˜Ÿæˆå‘˜å¹¶è¡Œå¤„ç†

---

## å¹¶è¡Œç¤ºä¾‹: ç”¨æˆ·æ•…äº‹ 1

```bash
# ä¸€èµ·å¯åŠ¨ç”¨æˆ·æ•…äº‹ 1 çš„å¹¶è¡Œä»»åŠ¡:
ä»»åŠ¡: "åœ¨ uni_tool/core/models.py æ–°å¢ ToolSet æ•°æ®ç±»(åŒ…å« tools/expression/drivers)"
```

---

## å¹¶è¡Œç¤ºä¾‹: ç”¨æˆ·æ•…äº‹ 2

```bash
# ä¸€èµ·å¯åŠ¨ç”¨æˆ·æ•…äº‹ 2 çš„é©±åŠ¨å®ç°:
ä»»åŠ¡: "åœ¨ uni_tool/drivers/openai.py å®ç° can_handle/can_handle_response å¹¶å¯¹é½ parse è¾“å‡ºç»“æ„"
ä»»åŠ¡: "åœ¨ uni_tool/drivers/anthropic.py æ–°å¢é©±åŠ¨å®ç° render/parse/can_handle/can_handle_response"
ä»»åŠ¡: "åœ¨ uni_tool/drivers/xml.py æ–°å¢é©±åŠ¨å®ç° render/parse/can_handle/can_handle_response"
ä»»åŠ¡: "åœ¨ uni_tool/drivers/markdown.py æ–°å¢é©±åŠ¨å®ç° render/parse/can_handle/can_handle_response"
```

---

## å¹¶è¡Œç¤ºä¾‹: ç”¨æˆ·æ•…äº‹ 3

```bash
# ä¸€èµ·å¯åŠ¨ç”¨æˆ·æ•…äº‹ 3 çš„å®ç°:
ä»»åŠ¡: "åœ¨ uni_tool/middlewares/base.py æ›´æ–° deduplicate_middlewares ä½¿ç”¨ç¨³å®š uid è¦†ç›–é€»è¾‘"
ä»»åŠ¡: "åœ¨ uni_tool/core/execution.py å°† execute_tool_calls æ”¹ä¸º asyncio.gather å¹¶ä¿æŒç»“æœé¡ºåº"
```

---

## å®æ–½ç­–ç•¥

### ä»… MVP(ä»…ç”¨æˆ·æ•…äº‹ 1)

1. å®Œæˆé˜¶æ®µ 1: è®¾ç½®
2. å®Œæˆé˜¶æ®µ 2: åŸºç¡€(å…³é”® - é˜»å¡æ‰€æœ‰æ•…äº‹)
3. å®Œæˆé˜¶æ®µ 3: ç”¨æˆ·æ•…äº‹ 1
4. ç‹¬ç«‹æµ‹è¯•ç”¨æˆ·æ•…äº‹ 1
5. å¦‚å‡†å¤‡å¥½åˆ™éƒ¨ç½²/æ¼”ç¤º

### å¢é‡äº¤ä»˜

1. å®Œæˆè®¾ç½® + åŸºç¡€ â†’ åŸºç¡€å°±ç»ª
2. æ·»åŠ ç”¨æˆ·æ•…äº‹ 1 â†’ ç‹¬ç«‹æµ‹è¯• â†’ éƒ¨ç½²/æ¼”ç¤º(MVP)
3. æ·»åŠ ç”¨æˆ·æ•…äº‹ 2 â†’ ç‹¬ç«‹æµ‹è¯• â†’ éƒ¨ç½²/æ¼”ç¤º
4. æ·»åŠ ç”¨æˆ·æ•…äº‹ 3 â†’ ç‹¬ç«‹æµ‹è¯• â†’ éƒ¨ç½²/æ¼”ç¤º
5. æ¯ä¸ªæ•…äº‹åœ¨ä¸ç ´åå…ˆå‰æ•…äº‹çš„æƒ…å†µä¸‹å¢åŠ ä»·å€¼

