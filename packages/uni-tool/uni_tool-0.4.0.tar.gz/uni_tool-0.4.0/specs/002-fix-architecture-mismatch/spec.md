# 功能规范: 架构一致性对齐

**功能分支**: `002-fix-architecture-mismatch`
**创建时间**: 2026-01-16
**状态**: 草稿
**输入**: 用户描述: "@docs/architecture_mismatch_report.md  当前的实现与架构不一致, 请调整实现"

## Clarifications

### Session 2026-01-16

- Q: 需要支持哪些协议类型？ → A: 同时支持 OpenAI + Anthropic + XML + markdown
- Q: 标签筛选无匹配时的行为？ → A: 返回空集合并可安全渲染
- Q: 自动识别失败时的返回方式？ → A: 明确错误但不中断调度
- Q: 工具过滤规则支持形式？ → A: 仅支持 ToolExpression；工具名过滤应实现为 `ToolName(ToolExpression)` 以统一过滤方式
- Q: 中间件去重默认标识来源？ → A: 使用类名/函数名
- Q: ToolSet.render 接受什么输入？ → A: 仅接受模型名字符串，由内部映射生成模型画像

## 用户场景与测试 *(必填)*

### 用户故事 1 - 按标签获取并渲染工具集合 (优先级: P1)

作为 SDK 使用者，我希望通过标签快速筛选出一组可用工具，并基于目标模型能力获得可用的工具描述，这样我无需理解底层协议差异即可获得准确的工具集合。

**优先级原因**: 这是开发者使用 SDK 的核心入口，直接影响工具选择与渲染结果的正确性。

**独立测试**: 通过设置包含/不包含标签的工具集并选择目标模型，可独立验证筛选与渲染行为。

**验收场景**:

1. **给定** 工具集合包含多个标签，**当** 使用标签进行筛选时，**那么** 返回的工具集合仅包含匹配该标签的工具。
2. **给定** 目标模型能力信息可用，**当** 渲染筛选后的工具集合时，**那么** 输出使用与目标模型匹配的协议格式并不包含不兼容工具。
3. **给定** 用户显式指定渲染协议，**当** 渲染工具集合时，**那么** 系统使用显式指定并忽略自动匹配结果。

---

### 用户故事 2 - 安全过滤与协议自动识别的工具调度 (优先级: P2)

作为 SDK 使用者，我希望在执行模型响应中的工具调用时能够限制允许的工具，并让系统自动识别响应协议，以确保安全与兼容性。

**优先级原因**: 安全过滤与协议识别决定执行的正确性与安全性，是运行时核心能力。

**独立测试**: 通过构造包含允许与不允许工具调用的响应，可验证过滤与错误输出；通过不同协议的响应可验证自动识别。

**验收场景**:

1. **给定** 一段包含多个工具调用的响应与允许工具过滤规则，**当** 执行调度时，**那么** 被允许的调用正常执行，被拒绝的调用返回包含 `error_code` 的错误结果且不执行。
2. **给定** 未显式指定协议，**当** 输入不同协议格式的响应时，**那么** 系统能够自动选择正确的处理器完成解析。
3. **给定** 显式指定协议处理器，**当** 执行调度时，**那么** 系统使用该处理器并在不匹配时返回包含 `error_code` 的错误结果。

---

### 用户故事 3 - 可配置绑定、中间件去重与多调用性能 (优先级: P3)

作为 SDK 维护者，我希望工具绑定与中间件配置具备可控的排除与去重规则，并在多个工具调用时获得稳定且更快的执行结果。

**优先级原因**: 这些能力影响扩展性与性能，属于重要但非首要能力。

**独立测试**: 通过配置排除方法、中间件去重与多工具调用响应，可独立验证绑定、去重和性能提升。

**验收场景**:

1. **给定** 绑定配置包含排除列表与中间件配置，**当** 执行绑定时，**那么** 被排除的方法不会被注册，且中间件配置被正确关联。
2. **给定** 多个相同类型的中间件注册，**当** 发生去重时，**那么** 系统以稳定标识进行覆盖并保持最终配置一致。
3. **给定** 一个包含多于 3 个工具调用的响应，**当** 执行调度时，**那么** 总执行时间较顺序执行基线降低至少 30% 且结果顺序与调用顺序一致。

---

### 边界情况

- 当标签筛选结果为空时系统应返回空集合且可安全渲染。
- 当响应协议无法识别或被显式指定但不匹配时系统应返回清晰错误且不执行工具调用。
- 当过滤规则拒绝所有工具调用时系统应返回全量错误结果并无副作用。
- 当排除列表包含不存在的方法时系统应忽略该条目并保持其他绑定正常。
- 当并行执行涉及共享上下文时系统应保持隔离，避免交叉污染。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须允许用户通过标签字符串获取工具集合，并仅包含匹配标签的工具；当无匹配结果时返回空集合且可安全渲染。
- **FR-002**: 系统必须提供可重复使用的工具集合对象，用于后续渲染与查询。
- **FR-003**: 系统必须根据模型名字符串生成模型画像并自动匹配合适的协议处理器进行工具集合渲染，并允许显式覆盖选择。
- **FR-004**: 系统必须支持在调度工具调用时设置工具过滤规则，规则仅支持 ToolExpression（工具名过滤通过 `ToolName(ToolExpression)` 实现），并对不允许的调用返回明确错误结果且不执行。
- **FR-005**: 系统必须在未指定协议时自动识别响应协议，并在识别失败时返回包含 `error_code` 的错误结果但不中断整体调度。
- **FR-006**: 系统必须支持注册并使用 OpenAI、Anthropic、XML、markdown 四种协议类型的驱动或处理器。
- **FR-007**: 系统必须在中间件去重时使用稳定标识，默认使用类名或函数名以便同类型中间件可被覆盖或更新。
- **FR-008**: 系统必须支持在批量绑定时排除指定方法，并传入中间件配置用于注册。
- **FR-009**: 系统必须在一个响应包含多个工具调用时并行执行，同时保持结果顺序稳定且上下文隔离。

### 关键实体 *(如果功能涉及数据则包含)*

- **工具集合**: 一组可被筛选与渲染的工具元数据集合，包含标签、描述与调用信息。
- **工具调用**: 从模型响应中解析出的调用请求，包含工具名、参数与执行上下文。
- **工具结果**: 工具调用的执行结果或错误信息，必须可追踪到对应调用。
- **协议处理器**: 用于解析响应并渲染工具集合的能力单元，支持自动匹配与显式选择。
- **中间件**: 用于跨切面处理的执行拦截组件，具有稳定标识用于去重。

### 范围与非目标

- 本次范围仅包含不一致项清单中列出的行为对齐，未列出的行为保持现状。

### 假设与依赖

- 默认存在可被识别的模型能力信息或响应指纹可用于自动匹配。
- 工具过滤规则由调用方提供，且可被用于判断单个工具调用是否允许执行。
- 至少两种协议处理器具备可验证的响应样例用于测试。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 与不一致项清单相关的所有验收场景通过率达到 100%。
- **SC-002**: 在包含至少 4 个工具调用的响应中，整体执行时间较顺序基线降低至少 30%。
- **SC-003**: 在工具过滤场景中，不允许的调用被阻止的准确率达到 100%，且错误信息可被用户识别。
- **SC-004**: 在两种协议响应样例中，自动识别并成功解析的成功率达到 100%。
