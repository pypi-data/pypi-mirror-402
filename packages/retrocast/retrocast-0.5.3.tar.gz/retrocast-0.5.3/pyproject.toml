[project]
name = "retrocast"
description = "a framework for ingesting, validating, canonicalizing, and adapting retrosynthesis model outputs to a unified benchmark standard."
readme = "README.md"
requires-python = ">=3.11"
license = { text = "MIT" }
authors = [{ name = "Anton Morgunov", email = "anton@ischemist.com" }]
dependencies = [
  "packaging>=25.0",
  "pydantic",
  "pyyaml>=6.0.3",
  "rdkit",
  "rich>=14.2.0",
  "tqdm>=4.67.1",
]
dynamic = ["version"]

[project.urls]
Homepage = "https://github.com/ischemist/project-procrustes"
Issues = "https://github.com/ischemist/project-procrustes/issues"

[project.scripts]
retrocast = "retrocast.cli.main:main"

[project.optional-dependencies]
aizyn = [
  "aizynthfinder==4.4.0",
  "numpy<=2.2",  # Numba needs NumPy 2.2 or less. Got NumPy 2.3.
]
dms = ["directmultistep"]
retro-star = ["retro-star>=0.1.0", "torch"]
syntheseus = [
  "syntheseus[local-retro]>=0.5.0",
  "numpy<2",
  "pandas<2.2",
  "dgl",
  "torch<=2.1",
  "torchdata<=0.7.0",
  "faiss-cpu",
  "torch-scatter"
]
viz = [
  "ischemist>=0.2.0",
  "kaleido>=1.1.0",
  "plotly>=6.3.0",
]

[dependency-groups]
dev = [
  "hypothesis>=6.148.2",
  "ipykernel>=6.29.5",
  "pandas<2.2",
  "pytest",
  "pytest-cov",
  "pytest-mock>=3.14.1",
  "pytest-sugar>=1.1.1",
  "requests>=2.32.5",
  "rich>=13.9.4",
  "ruff",
  "ty>=0.0.1a24",
  "types-pyyaml>=6.0.12.20250822",
  "types-tqdm>=4.67.0.20241221",
  "zensical>=0.0.11",
]

[build-system]
requires = ["setuptools>=64", "setuptools-scm>=8"]
build-backend = "setuptools.build_meta"

[tool.coverage.run]
omit = [
  "*/analysis/*.py",
  "*/constants/*",
  "*/__init__.py",
  "*/retrocast/types.py",
  "*/retrocast/utils/logging.py",
  "*/retrocast/exceptions.py",
  "*/retrocast/visualization/*.py",
  "*/retrocast/cli/main.py"
]

[tool.coverage.report]
exclude_lines = [
  "pragma: no cover",
  "def __repr__",
  "def __str__",
  "raise NotImplementedError",
  "if __name__ == .__main__.:",
  "if TYPE_CHECKING:",
  "pass",
  "logger\\."
]

[tool.pytest.ini_options]
markers = [
  "unit: runs in <10ms, tests single functions/classes, no IO",
  "integration: tests workflow glue, uses tmp_path",
  "contract: verifies adapters output valid retrocast objects",
  "regression: runs against frozen json.gz files",
]

[tool.ruff]
line-length = 120
lint.select = [
  "E",  # pycodestyle
  "F",  # Pyflakes
  "UP",  # pyupgrade
  "B",  # flake8-bugbear
  "SIM",  # flake8-simplify
  "I",  # isort
]
lint.ignore = ["E501", "SIM108"]

[tool.setuptools]
package-dir = { "" = "src" }

[tool.setuptools_scm]
version_scheme = "guess-next-dev"
local_scheme = "no-local-version"

[tool.ty.src]
exclude = ["tests", "scripts"]

[tool.uv]
conflicts = [
  [
    { extra = "dms" },
    { extra = "aizyn" },
    { extra = "retro-star" },
    { extra = "syntheseus" },
  ]
]

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu126"
url = "https://download.pytorch.org/whl/cu126"
explicit = true

[tool.uv.sources]
dgl = [
  { url = "https://data.dgl.ai/wheels/dgl-2.2.1-cp311-cp311-macosx_11_0_arm64.whl", marker = "sys_platform == 'darwin'" },
]
retro_star = { git = "https://github.com/anmorgunov/retro_star", branch = "master" }
torch = [
  { index = "pytorch-cpu", extra = "retro-star" },
]

[tool.uv.extra-build-dependencies]
torch-scatter = ["torch"]
