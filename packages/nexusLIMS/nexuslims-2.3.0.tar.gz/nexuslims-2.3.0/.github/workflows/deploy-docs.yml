name: Deploy Documentation

on:
  # Trigger after the test workflow completes successfully
  workflow_run:
    workflows: ["Unit Tests"]
    types:
      - completed
    branches:
      - main

  # Allow manual deployment
  workflow_dispatch:

jobs:
  check-conditions:
    name: Check Deployment Conditions
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check if deployment should proceed
        id: check
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"

          # Check if manually triggered
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… Conditions met: manual deployment triggered"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if triggered by successful push to main
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" && \
                "${{ github.event.workflow_run.event }}" == "push" ]]; then
            echo "âœ… Conditions met: will deploy main branch documentation"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  Skipping deployment:"
            if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
              echo "  - Tests did not pass (conclusion: ${{ github.event.workflow_run.conclusion }})"
            fi
            if [[ "${{ github.event.workflow_run.event }}" != "push" ]]; then
              echo "  - Not triggered by a push to main (event: ${{ github.event.workflow_run.event }})"
            fi
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy-docs:
    name: Build/Deploy main Docs
    needs: check-conditions
    if: needs.check-conditions.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push to gh-pages branch
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Download coverage artifact from test workflow
        if: github.event_name == 'workflow_run'
        # Download coverage artifact from the workflow_run that triggered this
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const coverageArtifact = artifacts.data.artifacts.find(
              artifact => artifact.name === 'coverage-html-3.11'
            );

            if (coverageArtifact) {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: coverageArtifact.id,
                archive_format: 'zip',
              });

              const fs = require('fs');
              fs.writeFileSync('coverage.zip', Buffer.from(download.data));

              // Extract the zip file
              const { execSync } = require('child_process');
              execSync('unzip -q coverage.zip -d tests/coverage');
            }

      - name: Generate switcher.json
        # Create version switcher for PyData Sphinx Theme navigation
        run: |
          echo "ðŸ” Generating switcher.json for main branch deployment..."
          echo "Environment:"
          echo "  GITHUB_EVENT_NAME: ${GITHUB_EVENT_NAME}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          echo ""

          echo "Running generate_switcher_json.py..."
          python scripts/generate_switcher_json.py

          echo ""
          echo "âœ… Generated switcher.json:"
          cat docs/_static/switcher.json
          echo ""
          echo "ðŸ“Š switcher.json contains $(jq 'length' docs/_static/switcher.json) entries"

      - name: Build documentation
        # Build Sphinx documentation (includes API docs, coverage link, and switcher.json)
        run: ./scripts/build_docs.sh

      - name: Deploy to gh-pages branch
        # Deploy docs to gh-pages branch in latest/ directory for dev builds
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stash any local changes (e.g., uv.lock modifications from uv sync)
          git stash --include-untracked || true

          git fetch origin gh-pages
          git checkout gh-pages
          git pull origin gh-pages

          # Deploy to latest directory (main branch = latest dev build)
          rm -rf latest
          mkdir -p latest
          rsync -avr _build/ latest/
          mkdir -p latest/_static
          cp docs/_static/switcher.json latest/_static/switcher.json

          # Add coverage if available
          if [ -d "tests/coverage" ]; then
            mkdir -p latest/coverage
            rsync -avr tests/coverage/ latest/coverage/
          fi

          # Update switcher.json in all version directories
          # This ensures all versions have the latest switcher with all available versions
          echo "Updating switcher.json in all version directories..."
          for dir in */; do
            # Only process directories that look like version directories (X.Y.Z, latest, stable, pr-N)
            # Skip: _build, docs, nexusLIMS (source code), and hidden dirs
            if [ -d "$dir" ] && [ "$dir" != "_build/" ] && \
               [ "$dir" != "docs/" ] && [ "$dir" != "nexusLIMS/" ] && \
               [[ ! "$dir" =~ ^\. ]]; then
              # Check if this looks like a docs directory (has _static subdirectory)
              dir_clean="${dir%/}"
              if [ -d "$dir_clean/_static" ]; then
                mkdir -p "$dir_clean/_static"
                cp docs/_static/switcher.json "$dir_clean/_static/switcher.json"
                echo "  Updated switcher.json in $dir"
              fi
            fi
          done

          # Commit and push - add all changes in documentation directories
          # Note: We don't update index.html here because it should always point to the
          # latest stable release, not to the dev build. It gets updated by release.yml.
          git add -A latest/ 2>/dev/null || true
          git add -A [0-9]*/ 2>/dev/null || true
          git add -A pr-*/ 2>/dev/null || true
          git commit -m "Deploy docs to latest from main branch and update switcher.json" || echo "No changes to commit"
          git push origin gh-pages
          echo "âœ… Documentation deployed to latest!"
          echo "ðŸ”— https://datasophos.github.io/NexusLIMS/latest/"
