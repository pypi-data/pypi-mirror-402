import{r}from"./react-core.js";import{a as T}from"./http.js";import{f as O,c as W,l as z,a as B,b as P,h as G,o as H,G as K}from"./index.js";import{G as L,P as l,j as w,d as Y}from"./chakra.js";import{M as J,a as Q}from"./PageLoading.js";function tt({route:n,idField:a,itemName:b}){const{targetUrl:i,token:c}=O(),p=W(),u=L(),[D,m]=r.useState(!0),[h,x]=r.useState(null),[t,y]=r.useState([]),[C,M]=r.useState(!1),$=r.useCallback((e,s)=>e.map(o=>({...o,exists:s.some(d=>d[a]===o[a])})),[a]),S=r.useCallback(async()=>{m(!0),x(null);try{const[e,s]=await Promise.all([T.get(z(n)),T.get(B(i+n),{headers:P(c)})]);if(e.status===200&&s.status===200)y($(e.data,s.data));else throw new Error("Invalid response from server")}catch(e){x(e),e.response?.status===401&&p({type:"invalidate-token"})}finally{m(!1)}},[i,c,p,n,$]);r.useEffect(()=>{S()},[S]);const k=r.useCallback((e,s)=>{y(o=>o.map(d=>d[a]===e?{...d,exists:s}:d))},[a]),f=r.useCallback(async()=>{const e=t.filter(g=>!g.exists);if(e.length===0)return;M(!0);let s=0,o=0;(await Promise.allSettled(e.map(async g=>{const I=await G.post(B(i+n),H(g,"exists"),{headers:P(c)});return{item:g,response:I}}))).forEach(g=>{if(g.status==="fulfilled"){s+=1;const{item:I}=g.value;y(q=>q.map(A=>A[a]===I[a]?{...A,exists:!0}:A))}else o+=1}),M(!1);const R=`${b}${s!==1?"s":""}`;let j="success";s===0?j="error":o>0&&(j="warning");const U=()=>s===0?`All ${e.length} items failed to migrate. Check your connection and permissions.`:o>0?`${o} item${o!==1?"s":""} failed to migrate. You can retry individual items.`:`Successfully copied ${s} ${R} to target Airflow instance`;u({title:s>0?`Migrated ${s} ${R} to remote`:"Migration failed",description:U(),status:j,duration:5e3,isClosable:!0,variant:"outline"})},[t,i,c,u,n,a,b]),E=t.length,v=t.filter(e=>e.exists).length;return{loading:D,error:h,data:t,isMigratingAll:C,totalItems:E,migratedItems:v,fetchData:S,handleItemStatusChange:k,handleMigrateAll:f,targetUrl:i,token:c}}function V({route:n,headers:a={},existsInRemote:b=!1,sendData:i,isDisabled:c=!1,onStatusChange:p=null,itemName:u="item"}){const[D,m]=r.useState(!1),[h,x]=r.useState(null),[t,y]=r.useState(b),C=L(),M=r.useCallback(async()=>{m(!0),x(null);try{const f=await G({method:t?"delete":"post",url:n,headers:a,data:i}),v=[200,201,204].includes(f.status)?!t:t;y(v),p?.(v),C({title:t?`Deleted ${u} from remote`:`Migrated ${u} to remote`,description:t?"Successfully removed from target Airflow instance":"Successfully copied to target Airflow instance",status:"success",duration:4e3,isClosable:!0,variant:"outline"})}catch(f){x(f),C({title:`Failed to ${t?"delete":"migrate"} ${u}`,description:f.response?.data?.error||f.message,status:"error",duration:6e3,isClosable:!0,variant:"outline"})}finally{m(!1)}},[t,n,a,i,p,C,u]),$=()=>h?"Error!":t?"Delete":"Migrate",S=()=>h?w.jsx(J,{}):t?w.jsx(Q,{}):w.jsx(K,{}),k=()=>h||t?"red":"green";return w.jsx(Y,{size:"sm",variant:"outline",isDisabled:c,isLoading:D,loadingText:t?"Deleting...":"Migrating...",onClick:M,colorScheme:k(),leftIcon:S(),children:$()})}V.propTypes={route:l.string.isRequired,headers:l.objectOf(l.string),existsInRemote:l.bool,sendData:l.object.isRequired,isDisabled:l.bool,onStatusChange:l.func,itemName:l.string};export{V as M,tt as u};
