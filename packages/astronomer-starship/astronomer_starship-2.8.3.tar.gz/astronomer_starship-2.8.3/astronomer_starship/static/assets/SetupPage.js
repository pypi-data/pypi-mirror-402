import{j as e,m as Y,n as _,V as S,a as v,B as y,H as W,T as x,Q as Z,o as ee,C as se,P as t,p as z,q as O,r as E,s as L,t as P,v as N,b as w,i as $,D as te,w as re,x as oe,y as ie,L as j,E as k,z as ne,G as V,J as ae,S as le,u as I,K as ce,d as C,R as de,M as ue,N as pe,O as he,U as fe,W as me,X as ge}from"./chakra.js";import{r as h,b as xe}from"./react-core.js";import{G as ye}from"./icons.js";import{a as be}from"./router.js";import{a as B}from"./http.js";import{t as D,p as je,a as F,b as M,u as ke,c as we,g as ve,d as Ce}from"./index.js";function Re(s){return ye({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"32",d:"M39.93 327.56l-4.71-8.13A24 24 0 0144 286.64l86.87-50.07a16 16 0 0121.89 5.86l12.71 22a16 16 0 01-5.86 21.85l-86.85 50.07a24.06 24.06 0 01-32.83-8.79z"}},{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"32",d:"M170.68 273.72L147.12 233a24 24 0 018.8-32.78l124.46-71.75a16 16 0 0121.89 5.86l31.57 54.59a16 16 0 01-5.84 21.84L203.51 282.5a24 24 0 01-32.83-8.78zm171.17-71.51l-46.51-80.43a24 24 0 018.8-32.78l93.29-53.78A24.07 24.07 0 01430.27 44l46.51 80.43a24 24 0 01-8.8 32.79L374.69 211a24.06 24.06 0 01-32.84-8.79zM127.59 480l96.14-207.99m48.07-15.99L368.55 448"}}]})(s)}function U({stepNumber:s,title:o,tooltip:c,isComplete:r,showCheck:i,isOpen:n,onToggle:l,isDisabled:a=!1,children:u}){const d=r&&!a;return e.jsx(Y,{opacity:a?.5:1,pointerEvents:a?"none":"auto",transition:"all 0.3s",children:e.jsx(_,{py:3,children:e.jsxs(S,{align:"stretch",spacing:2,children:[e.jsxs(v,{mb:1,justify:"space-between",cursor:d?"pointer":"default",onClick:d?l:void 0,_hover:d?{bg:"gray.50"}:void 0,transition:"background 0.2s",borderRadius:"md",px:2,py:1,mx:-2,children:[e.jsxs(v,{children:[e.jsx(y,{display:"inline-flex",alignItems:"center",justifyContent:"center",w:6,h:6,borderRadius:"full",bg:r?"success.500":"brand.500",color:"white",fontWeight:"bold",fontSize:"xs",mr:2,transition:"all 0.3s",children:r&&i?"✓":s}),e.jsx(W,{size:"sm",children:o}),e.jsx(x,{label:c,placement:"top",hasArrow:!0,children:e.jsx(Z,{color:"gray.400",boxSize:3,cursor:"help"})})]}),r&&e.jsx(ee,{boxSize:4,transform:n?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"})]}),e.jsx(se,{in:n,animateOpacity:!0,children:u})]})})})}U.propTypes={stepNumber:t.oneOfType([t.string,t.number]).isRequired,title:t.string.isRequired,tooltip:t.string.isRequired,isComplete:t.bool.isRequired,showCheck:t.bool.isRequired,isOpen:t.bool.isRequired,onToggle:t.func.isRequired,isDisabled:t.bool,children:t.node.isRequired};function H({targetUrl:s,token:o=null,isAstro:c,isTouched:r,isTokenTouched:i,isValidUrl:n,onUrlChange:l,onTokenChange:a,onToggleIsAstro:u}){const d=f=>{const p=je(f.target.value);p.isValid&&p.isAstro!==c&&u(),l({targetUrl:p.isValid?p.targetUrl:f.target.value,urlOrgPart:p.urlOrgPart,urlDeploymentPart:p.urlDeploymentPart})};return e.jsxs(e.Fragment,{children:[e.jsxs(z,{className:"setup-form-field",isInvalid:r&&!n,isRequired:!0,children:[e.jsxs(v,{mb:1,children:[e.jsx(O,{mb:0,children:"Airflow URL"}),e.jsx(x,{label:"Copy the webserver URL from your Astronomer deployment",placement:"top",hasArrow:!0,children:e.jsx(E,{color:"gray.400",boxSize:3,cursor:"help"})})]}),e.jsx(L,{size:"sm",placeholder:"https://...",value:s,isInvalid:r&&!n,onChange:d}),e.jsx(P,{fontSize:"xs",children:"Paste the full webserver URL of your target Airflow deployment"}),e.jsx(N,{children:"Please enter a valid Airflow URL"})]}),e.jsxs(y,{mt:3,p:3,bg:"gray.50",borderRadius:"md",borderWidth:"1px",borderColor:"gray.200",children:[e.jsx(w,{fontSize:"xs",fontWeight:"semibold",color:"gray.600",mb:2,children:"Supported URL Formats"}),e.jsxs(S,{align:"stretch",spacing:2,children:[e.jsxs(y,{children:[e.jsx(w,{fontSize:"2xs",color:"gray.500",mb:.5,children:"Astro (Cloud)"}),e.jsx($,{fontSize:"2xs",px:2,py:1,borderRadius:"sm",display:"block",children:"https://claaabbbcccddd.astronomer.run/aabbccdd"})]}),e.jsxs(y,{children:[e.jsx(w,{fontSize:"2xs",color:"gray.500",mb:.5,children:"Astro Private Cloud (Software)"}),e.jsx($,{fontSize:"2xs",px:2,py:1,borderRadius:"sm",display:"block",children:"https://deployments.basedomain.com/release-name-1234/airflow"})]})]})]}),e.jsx(te,{my:3}),e.jsxs(z,{isInvalid:i&&!o,className:"setup-form-field",children:[e.jsxs(v,{mb:1,children:[e.jsx(O,{mb:0,children:"Authentication Token"}),e.jsx(x,{label:c?"Use an Organization, Workspace, or Personal access token":"Use a Workspace or Deployment service account token",placement:"top",hasArrow:!0,children:e.jsx(E,{color:"gray.400",boxSize:3,cursor:"help"})})]}),e.jsxs(re,{size:"sm",children:[e.jsx(L,{type:"password",autoComplete:"off",value:o||"",isInvalid:i&&!o,placeholder:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",onChange:f=>a(f.target.value)}),i&&o&&e.jsx(oe,{children:e.jsx(ie,{color:"success.500"})})]}),c?e.jsxs(P,{children:["Provide a token:"," ",e.jsx(x,{label:"Organization tokens have access to all workspaces and deployments",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:"https://docs.astronomer.io/astro/organization-api-tokens",children:["Organization",e.jsx(k,{mx:"2px"})]})}),","," ",e.jsx(x,{label:"Workspace tokens have access to all deployments in a workspace",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:"https://docs.astronomer.io/astro/workspace-api-tokens",children:["Workspace",e.jsx(k,{mx:"2px"})]})}),","," ",e.jsx(x,{label:"Personal tokens are user-specific access tokens",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:D(s),children:["Personal",e.jsx(k,{mx:"2px"})]})}),"."]}):e.jsxs(P,{children:["Provide a token:"," ",e.jsx(x,{label:"Workspace service accounts have access to all deployments",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:"https://docs.astronomer.io/software/manage-workspaces#service-accounts",children:["Workspace",e.jsx(k,{mx:"2px"})]})}),","," ",e.jsx(x,{label:"Deployment service accounts are deployment-specific tokens",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:"https://docs.astronomer.io/software/ci-cd#step-1-create-a-service-account",children:["Deployment",e.jsx(k,{mx:"2px"})]})}),s.startsWith("https://")&&n&&e.jsxs(e.Fragment,{children:[","," ",e.jsx(x,{label:"Personal tokens are user-specific access tokens",hasArrow:!0,children:e.jsxs(j,{isExternal:!0,href:D(s),children:["Personal",e.jsx(k,{mx:"2px"})]})})]}),"."]}),e.jsx(N,{children:"Please input a valid authentication token"})]})]})}H.propTypes={targetUrl:t.string.isRequired,token:t.string,isAstro:t.bool.isRequired,isTouched:t.bool.isRequired,isTokenTouched:t.bool.isRequired,isValidUrl:t.bool.isRequired,onUrlChange:t.func.isRequired,onTokenChange:t.func.isRequired,onToggleIsAstro:t.func.isRequired};function G(s){return s==="Airflow API"?"Airflow API":s==="Starship Plugin"?"Starship Plugin API":s}function Se(s,o,c){const r=G(o),i=s.response?.status,n=s.response?.statusText;if(s.code==="ERR_NETWORK"||s.message==="Network Error")return{title:`Network error connecting to ${r}`,description:`Unable to reach the server. This could be due to:
• The URL is incorrect
• The server is not running
• A firewall or network issue is blocking the connection
• CORS policy is blocking the request`};if(s.code==="ECONNABORTED"||s.message?.includes("timeout"))return{title:`Connection timeout for ${r}`,description:"The request took too long to complete. The server may be overloaded or unreachable. Please try again."};switch(i){case 400:return{title:`Bad request to ${r}`,description:`The server rejected the request. ${s.response?.data?.error||s.response?.data?.message||"Please verify the URL format is correct."}`};case 401:return{title:`Authentication failed for ${r}`,description:"The provided token is invalid or expired. Please check your authentication token and ensure it has the required permissions."};case 403:return{title:`Access denied to ${r}`,description:"The token is valid but lacks permission to access this resource. Please verify the token has the correct scope and permissions for this deployment."};case 404:return o==="Starship Plugin"?{title:"Starship Plugin not found",description:"The Starship plugin is not installed or enabled on the target Airflow instance. Please ensure astronomer-starship is installed and the webserver has been restarted."}:{title:`${r} endpoint not found`,description:`The endpoint at "${c}" was not found. Please verify:
• The URL is correct
• The Airflow webserver is running
• The API is accessible`};case 500:return{title:`Server error from ${r}`,description:`The server encountered an internal error. ${s.response?.data?.error||s.response?.data?.message||"Please check the target Airflow logs for more details."}`};case 502:return{title:`Bad gateway for ${r}`,description:"The server received an invalid response from an upstream server. The Airflow webserver may be starting up or experiencing issues."};case 503:return{title:`${r} unavailable`,description:"The service is temporarily unavailable. The Airflow webserver may be starting up, overloaded, or under maintenance."};case 504:return{title:`Gateway timeout for ${r}`,description:"The server timed out waiting for a response. Please try again or check if the Airflow instance is responsive."};default:{const l=s.response?.data?.error||s.response?.data?.message||s.response?.data?.detail||s.message||(typeof s.response?.data=="string"?s.response?.data:null);let a;if(l)a=typeof l=="string"?l:JSON.stringify(l);else{let u="";i&&(u=n?` (HTTP ${i}: ${n})`:` (HTTP ${i})`),a=`An unexpected error occurred${u}. Please check the URL and try again.`}return{title:`Failed to validate ${r}`,description:a}}}}const R=h.memo(({text:s,url:o,valid:c,setValid:r,token:i,...n})=>{const[l,a]=ne(!0),u=V();return h.useEffect(()=>{B.get(F(o),{headers:M(i),timeout:3e4}).then(d=>{const p=(d.headers["content-type"]||"").includes("application/json"),m=d.status===200&&d.data&&p;!m&&d.status===200&&u({title:`Unexpected response from ${G(s)}`,description:p?"The server returned an empty or invalid response. Please verify the endpoint is correct.":"The server returned a non-JSON response. You may have reached a login page or proxy. Please verify the URL and authentication.",status:"warning",isClosable:!0,duration:4e3,variant:"outline"}),r(m)}).catch(d=>{const{title:f,description:p}=Se(d,s,o);u({title:f,description:p,status:"error",isClosable:!0,duration:4e3,variant:"outline"}),r(!1)}).finally(()=>a.off())},[o,i,s,a,r,u]),e.jsxs(v,{spacing:2,children:[e.jsx(ae,{isReadOnly:!0,isInvalid:!c,isChecked:!l&&c,cursor:"default",...n,children:s}),l&&e.jsx(le,{size:"sm",color:"brand.400",thickness:"2px",speed:"0.8s",emptyColor:"gray.200"})]})});R.propTypes={text:t.string.isRequired,url:t.string.isRequired,valid:t.bool.isRequired,setValid:t.func.isRequired,token:t.string.isRequired};R.displayName="ValidatedUrlCheckbox";function J({targetUrl:s,token:o=null,isValidUrl:c,isAirflow:r,isStarship:i,onAirflowChange:n,onStarshipChange:l}){return s.startsWith("http")&&c&&o?e.jsxs(y,{children:[e.jsx(w,{fontSize:"xs",color:"gray.600",mb:1.5,children:"Verifying connectivity to your target Airflow instance"}),e.jsxs(y,{mb:1.5,p:2,bg:"gray.50",borderRadius:"md",children:[e.jsx(w,{fontSize:"2xs",color:"gray.500",mb:.5,children:"Target URL"}),e.jsxs(j,{isExternal:!0,href:s,color:"brand.600",fontWeight:"medium",wordBreak:"break-all",overflowWrap:"anywhere",display:"inline",children:[s,e.jsx(k,{mx:"2px",verticalAlign:"middle"})]})]}),e.jsxs(S,{align:"stretch",spacing:1.5,children:[e.jsx(R,{colorScheme:"success",text:"Airflow API",valid:r,setValid:n,url:`${s}/api/v1/health`,token:o}),e.jsx(R,{colorScheme:"success",text:"Starship Plugin",valid:i,setValid:l,url:`${s}/api/starship/info`,token:o})]})]}):e.jsx(w,{fontSize:"sm",color:"gray.500",fontStyle:"italic",children:"Complete Step 1 to verify connections"})}J.propTypes={targetUrl:t.string.isRequired,token:t.string,isValidUrl:t.bool.isRequired,isAirflow:t.bool.isRequired,isStarship:t.bool.isRequired,onAirflowChange:t.func.isRequired,onStarshipChange:t.func.isRequired};function Oe(){const s=ke(),o=we(),c=V(),r=I({defaultIsOpen:!0}),i=I({defaultIsOpen:!1}),n=I(),l=xe.useRef(),a=h.useRef(!1),[u,d]=h.useState(!1),[f,p]=h.useState(!1),m=s.isValidUrl&&s.token,b=s.isAirflow&&s.isStarship;h.useEffect(()=>{m&&!b&&!i.isOpen&&i.onOpen()},[m,b,i]),h.useEffect(()=>{m&&!u&&(d(!0),setTimeout(()=>{r.onClose(),i.onOpen()},1e3))},[m,u,r,i]),h.useEffect(()=>{b&&!f&&(p(!0),setTimeout(()=>i.onClose(),1e3))},[b,f,i]),h.useEffect(()=>{b&&!a.current&&(a.current=!0,c({title:"Setup Complete!",description:"Your Starship configuration is ready. Use the navigation links above to migrate your Airflow metadata.",status:"success",duration:6e3,isClosable:!0,variant:"outline"}))},[b,c]),h.useEffect(()=>{s.isSetupComplete&&!s.isAstro&&!(s.releaseName&&s.workspaceId&&s.deploymentId)&&B.post(F(ve(s.urlOrgPart)),{operationName:"workspaces",query:Ce,variables:{}},{headers:M(s.token)}).then(g=>{let T=!1;(g.data?.data?.workspaces||[]).forEach(q=>{T||q.deployments.forEach(A=>{T||A.releaseName===s.urlDeploymentPart&&(o({type:"set-software-info",deploymentId:A.id,releaseName:A.releaseName,workspaceId:q.id}),T=!0)})})}).catch(()=>{})},[s.isSetupComplete,s.isAstro,s.releaseName,s.workspaceId,s.deploymentId,s.urlOrgPart,s.urlDeploymentPart,s.token,o]);const Q=()=>{o({type:"reset"}),n.onClose(),d(!1),p(!1),a.current=!1,r.onOpen(),i.onOpen()},K=h.useCallback(g=>o({type:"set-is-airflow",isAirflow:g}),[o]),X=h.useCallback(g=>o({type:"set-is-starship",isStarship:g}),[o]);return e.jsxs(y,{children:[e.jsxs(ce,{direction:{base:"column",md:"row"},justify:"space-between",align:{base:"flex-start",md:"center"},mb:3,children:[e.jsxs(y,{children:[e.jsx(W,{size:"md",mb:.5,children:"Getting Started"}),e.jsx(w,{fontSize:"xs",color:"gray.600",children:"Configure Starship to migrate Airflow metadata between instances"})]}),e.jsxs(v,{children:[e.jsx(C,{size:"sm",leftIcon:e.jsx(Re,{}),as:be,to:"/telescope",variant:"outline",children:"Telescope"}),e.jsx(C,{size:"sm",leftIcon:e.jsx(de,{}),onClick:n.onOpen,variant:"outline",colorScheme:"red",children:"Reset"})]})]}),e.jsxs(S,{spacing:3,align:"stretch",w:"100%",children:[e.jsx(U,{stepNumber:"1",title:"Configure Target Airflow",tooltip:"Enter the URL and authentication token for your target deployment",isComplete:m,showCheck:u,isOpen:r.isOpen,onToggle:r.onToggle,children:e.jsx(H,{targetUrl:s.targetUrl,token:s.token,isAstro:s.isAstro,isTouched:s.isTouched,isTokenTouched:s.isTokenTouched,isValidUrl:s.isValidUrl,onUrlChange:g=>o({type:"set-url",...g}),onTokenChange:g=>o({type:"set-token",token:g}),onToggleIsAstro:()=>o({type:"toggle-is-astro"})})}),e.jsx(U,{stepNumber:"2",title:"Connection Status",tooltip:"Verifies that both Airflow API and Starship plugin are accessible",isComplete:b,showCheck:f,isOpen:i.isOpen,onToggle:i.onToggle,isDisabled:!m,children:e.jsx(J,{targetUrl:s.targetUrl,token:s.token,isValidUrl:s.isValidUrl,isAirflow:s.isAirflow,isStarship:s.isStarship,onAirflowChange:K,onStarshipChange:X})})]}),e.jsx(ue,{isOpen:n.isOpen,leastDestructiveRef:l,onClose:n.onClose,children:e.jsx(pe,{children:e.jsxs(he,{children:[e.jsx(fe,{fontSize:"lg",fontWeight:"bold",children:"Reset Configuration"}),e.jsx(me,{children:"Are you sure you want to reset all configuration? This will clear your deployment URL, authentication token, and connection status."}),e.jsxs(ge,{children:[e.jsx(C,{ref:l,onClick:n.onClose,size:"sm",variant:"outline",children:"Cancel"}),e.jsx(C,{colorScheme:"red",onClick:Q,ml:3,size:"sm",children:"Reset"})]})]})})})]})}export{Oe as default};
