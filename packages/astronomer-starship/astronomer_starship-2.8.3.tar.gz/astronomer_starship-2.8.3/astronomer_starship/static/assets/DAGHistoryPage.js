import{P as p,j as r,T as $,$ as Ee,Q as Ae,G as je,d as z,F as se,a0 as Ce,b as B,I as Ge,B as J,K as Ie,H as Ne,a as L,p as ne,w as oe,a1 as ie,a2 as le,a3 as ce,a4 as ue,a5 as de,a6 as he,R as ke,V as Me,a7 as fe,a8 as ge,L as me,E as pe,a9 as Pe}from"./chakra.js";import{c as Oe,g as $e,r as _}from"./react-core.js";import{a as P}from"./http.js";import{a as Fe,M as ze,b as xe,c as _e,d as be,P as Ue,D as Be}from"./PageLoading.js";import{G as Le,h as K,a as U,e as R,b as q,l as O,f as We,m as He,c as Ve,n as Ke}from"./index.js";import{c as qe}from"./table.js";import"./icons.js";import"./router.js";var Se={exports:{}};(function(u,h){(function(i,g){u.exports=g()})(Oe,function(){function i(e,t){var a,s,n;for(a=1,s=arguments.length;a<s;++a)if(t=arguments[a],t!=null)for(n in t)b(t,n)&&(e[n]=t[n]);return e}function g(e,t){return t.length-e.length}function A(e,t){return e.factor-t.factor}function w(e){return e.replace(/([.*+?=^!:${}()|[\]/\\])/g,"\\$1")}function j(e,t){var a,s;for(a=0,s=e.length;a<s;++a)t(e[a],a)}function y(e,t){var a;for(a in e)b(e,a)&&t(e[a],a)}var b=function(e){return function(a,s){return a!=null&&e.call(a,s)}}(Object.prototype.hasOwnProperty);function c(e,t){for(;typeof t=="string";)t=e[t];return t}function o(e){this._prefixes=e;var t=[],a=[];y(e,function(n,l){t.push(w(l)),a.push({factor:n,prefix:l})});var s=this._lcPrefixes={};y(e,function(n,l){var f=l.toLowerCase();b(e,f)||(s[f]=l)}),a.sort(A),this._list=a,t.sort(g),this._regexp=new RegExp("^\\s*(-)?\\s*(\\d+(?:\\.\\d+)?)\\s*("+t.join("|")+")\\s*(.*)\\s*?$","i")}o.create=function(t,a,s){var n={};return s===void 0&&(s=0),j(t,function(l,f){n[l]=Math.pow(a,f+s)}),new o(n)},o.prototype.findPrefix=function(t){for(var a=this._list,s=0,n=a.length-1,l,f;s!==n;)l=s+n+1>>1,f=a[l].factor,f>t?n=l-1:s=l;return a[s]},o.prototype.parse=function(t,a){var s=t.match(this._regexp);if(s!==null){var n=s[3],l;if(b(this._prefixes,n))l=this._prefixes[n];else if(!a&&(n=n.toLowerCase(),b(this._lcPrefixes,n)))n=this._lcPrefixes[n],l=this._prefixes[n];else return;var f=+s[2];return s[1]!==void 0&&(f=-f),{factor:l,prefix:n,unit:s[4],value:f}}};var S={binary:o.create(",Ki,Mi,Gi,Ti,Pi,Ei,Zi,Yi".split(","),1024),SI:o.create("y,z,a,f,p,n,Âµ,m,,k,M,G,T,P,E,Z,Y".split(","),1e3,-8)},I={maxDecimals:2,separator:" ",unit:""},C={scale:"SI",strict:!1};function x(e,t){t=i({},I,t);var a=t.decimals;a!==void 0&&delete t.maxDecimals;var s=d(e,t);e=a!==void 0?s.value.toFixed(a):String(s.value);var n=s.prefix+t.unit;return n===""?e:e+t.separator+n}var N={scale:"binary",unit:"B"};function k(e,t){return x(e,t===void 0?N:i({},N,t))}function G(e,t){var a=T(e,t);return a.value*a.factor}function T(e,t){if(typeof e!="string")throw new TypeError("str must be a string");t=i({},C,t);var a=c(S,t.scale);if(a===void 0)throw new Error("missing scale");var s=a.parse(e,t.strict);if(s===void 0)throw new Error("cannot parse str");return s}function d(e,t){if(e===0)return{value:0,prefix:""};if(e<0){var a=d(-e,t);return a.value=-a.value,a}if(typeof e!="number"||Number.isNaN(e))throw new TypeError("value must be a number");t=i({},C,t);var s=c(S,t.scale);if(s===void 0)throw new Error("missing scale");var n,l=t.maxDecimals,f=l==="auto";f?n=10:l!==void 0&&(n=Math.pow(10,l));var D=t.prefix,m;if(D!==void 0){if(!b(s._prefixes,D))throw new Error("invalid prefix");m=s._prefixes[D]}else{var v=s.findPrefix(e);if(n!==void 0)do{m=v.factor;var W=m/n;e=Math.round(e/W)*W}while((v=s.findPrefix(e)).factor!==m);else m=v.factor;D=v.prefix}return e=n===void 0?e/m:Math.round(e*n/m)/n,f&&Math.abs(e)>=10&&(e=Math.round(e)),{prefix:D,value:e}}return x.bytes=k,x.parse=G,G.raw=T,x.raw=d,x.Scale=o,x})})(Se);var Ye=Se.exports;const we=$e(Ye);function X({tooltip:u}){return r.jsx($,{hasArrow:!0,label:u,children:r.jsx(Ee,{variant:"ghost","aria-label":"Info",icon:r.jsx(Ae,{})})})}X.propTypes={tooltip:p.string.isRequired};function Te({isDisabled:u=!1,tooltipText:h="",children:i}){return u&&h?r.jsx($,{hasArrow:!0,label:h,children:i}):i}Te.propTypes={isDisabled:p.bool,tooltipText:p.string,children:p.node.isRequired};const M=Object.freeze({MIGRATE:{key:"MIGRATE",buttonText:"Migrate",icon:Le,color:"success.600",borderColor:"success.500",hoverBg:"success.50"},DELETE:{key:"DELETE",buttonText:"Delete",icon:Fe,color:"error.600",borderColor:"error.500",hoverBg:"error.50"},ERROR:{key:"ERROR",buttonText:"Error!",icon:ze,color:"error.600",borderColor:"error.500",hoverBg:"error.50"},MIGRATING:{key:"MIGRATING",buttonText:"Migrating",icon:null,color:"success.600",borderColor:"success.500",hoverBg:"success.50",progressColor:"green.400",minWidth:"140px"},DELETING:{key:"DELETING",buttonText:"Deleting",icon:null,color:"error.600",borderColor:"error.500",hoverBg:"error.50",progressColor:"red.400",minWidth:"140px"},NOT_IN_REMOTE:{key:"NOT_IN_REMOTE",tooltip:"Deploy DAG to remote before migrating",buttonText:"Not on Remote",icon:xe,color:"gray.600",borderColor:"gray.500",hoverBg:"gray.50",minWidth:"150px"},NO_DAG_RUNS:{key:"NO_DAG_RUNS",tooltip:"No DAG Runs to migrate",buttonText:"Nothing to Migrate",icon:xe,color:"gray.600",borderColor:"gray.500",hoverBg:"gray.50",minWidth:"150px"}});function ye({url:u,token:h,dagId:i,limit:g=1e3,batchSize:A=100,existsInRemote:w=!1,disabledReason:j=null,onMigrate:y=null,onDelete:b=null}){const[c,o]=_.useState(0),[S,I]=_.useState(null),[C,x]=_.useState(w),[N,k]=_.useState(!1),G=je(),T=c>0&&c<100,d=!!j;_.useEffect(()=>{T||x(w)},[w,T]);const e=T?N?M.DELETING:M.MIGRATING:j||(S?M.ERROR:C?M.DELETE:M.MIGRATE),t=()=>{o(0),k(!1)},a=(m,v="migrate")=>{x(!1),t(),I(m),G({title:`Failed to ${v} DAG history for "${i}"`,description:m.response?.data?.error||m.response?.data||m.message,status:"error",isClosable:!0,variant:"outline",duration:6e3})},s=m=>{o(100),x(m),setTimeout(t,500)},n=async()=>{k(!0),o(50);try{await K.delete(U(u+R.DAG_RUNS_ROUTE),{headers:q(h),params:{dag_id:i}}),s(!1),b?.(i)}catch(m){a(m,"delete")}},l=async()=>{o(1);const m=async(v=0,W=null,ee=null)=>{const re=Math.min(g-v,A),Y={dag_id:i,limit:re,offset:v};try{const[F,De,ve]=await Promise.all([P.get(O(R.DAG_RUNS_ROUTE),{params:Y}),P.get(O(R.TASK_INSTANCE_ROUTE),{params:Y}),P.get(O(R.TASK_INSTANCE_HISTORY_ROUTE),{params:Y})]),H=W||Math.min(F.data.dag_run_count,g);if(F.data.dag_runs.length===0){const V=ee??0;s(V>0),y?.(i,V);return}const Q={headers:q(h)},Z={params:{dag_id:i}},Re=await K.post(U(u+R.DAG_RUNS_ROUTE),{dag_runs:F.data.dag_runs},{...Z,...Q});await K.post(U(u+R.TASK_INSTANCE_ROUTE),{task_instances:De.data.task_instances},{...Z,...Q}),await K.post(U(u+R.TASK_INSTANCE_HISTORY_ROUTE),{task_instances:ve.data.task_instances},{...Z,...Q});const te=v+F.data.dag_runs.length,ae=Re?.data?.dag_run_count??ee;if(te<H){const V=Math.min(99,Math.round(te/H*100));o(V),await m(v+re,H,ae)}else s(!0),y?.(i,ae??H)}catch(F){a(F)}};await m(0)},f=()=>C?n():l(),D=()=>T?r.jsxs(se,{alignItems:"center",gap:2,children:[r.jsx(Ce,{value:c,size:"20px",thickness:"10px",color:e.progressColor,trackColor:"gray.200",isIndeterminate:c<2}),r.jsxs(B,{as:"span",m:0,lineHeight:"1",children:[e.buttonText," ",Math.round(c),"%"]})]}):r.jsxs(se,{alignItems:"center",gap:2,children:[e.icon&&r.jsx(Ge,{as:e.icon,boxSize:4}),r.jsx(B,{as:"span",m:0,lineHeight:"1",children:e.buttonText})]});return r.jsx(Te,{isDisabled:d,tooltipText:e.tooltip||"",children:r.jsx(z,{size:"sm",variant:"outline",isDisabled:d||T,colorScheme:void 0,onClick:f,minW:e.minWidth,color:e.color,borderColor:e.borderColor,_hover:{bg:e.hoverBg},_disabled:{color:e.color,borderColor:e.borderColor,opacity:T?.8:1,cursor:T?"progress":"not-allowed"},children:D()})})}ye.propTypes={url:p.string.isRequired,token:p.string.isRequired,dagId:p.string.isRequired,limit:p.number,batchSize:p.number,existsInRemote:p.bool,disabledReason:p.shape({key:p.string,tooltip:p.string,buttonText:p.string}),onMigrate:p.func,onDelete:p.func};function Qe(u,h){const i={};return u.forEach(g=>{i[g.dag_id]={local:g,remote:null}}),h.forEach(g=>{i[g.dag_id]&&(i[g.dag_id].remote=g)}),Object.values(i)}const E=qe();function Ze(u){const{row:h,getValue:i}=u;return r.jsx($,{hasArrow:!0,label:`File: ${h.original.local.fileloc}`,children:r.jsx(B,{fontWeight:"semibold",children:i()})})}function Je(u){const h=u.getValue();return!h||h.length===0?null:r.jsx(L,{spacing:1,flexWrap:"wrap",children:h.map(i=>r.jsx(Pe,{size:"sm",colorScheme:"amethyst",variant:"solid",children:i},i))})}function Xe(u){return u.getValue()||"None"}function er(u){const{targetUrl:h,token:i,limit:g,batchSize:A,handleMigrate:w,handleDelete:j,localAirflowVersion:y,handlePausedClick:b}=u;return[E.accessor(c=>c.local.dag_id,{id:"dagId",header:"ID",cell:Ze,meta:{minWidth:"150px"}}),E.accessor(c=>c.local.tags,{id:"tags",header:"Tags",cell:Je,meta:{minWidth:"120px"}}),E.accessor(c=>c.local.schedule_interval,{id:"schedule",header:"Schedule",cell:Xe,meta:{minWidth:"100px"}}),E.accessor(c=>c.local.description,{id:"description",header:"Description",meta:{minWidth:"200px"}}),E.accessor(c=>c.local.owners,{id:"owners",header:"Owners",meta:{minWidth:"120px"}}),E.display({id:"local_is_paused",enableSorting:!1,header:()=>r.jsxs(r.Fragment,{children:["Local",r.jsx(X,{tooltip:"Toggle to pause/unpause DAG in local"})]}),meta:{width:"100px"},cell:c=>{const{original:o}=c.row;return r.jsxs(r.Fragment,{children:[r.jsx(fe,{colorScheme:"success",isChecked:!o.local.is_paused,onChange:()=>b(!o.local.is_paused,o.local.dag_id,!0)}),r.jsx($,{hasArrow:!0,label:"DAG Run Count",children:r.jsx(ge,{mx:1,fontSize:"sm",variant:"outline",colorScheme:o.local.dag_run_count>0?"teal":"red",children:we(o.local.dag_run_count)})})]})}}),E.display({id:"local_url",header:"Local URL",meta:{width:"110px"},enableSorting:!1,cell:c=>{const{original:o}=c.row;return r.jsxs(me,{isExternal:!0,href:O(Ke(o.local.dag_id,y)),color:"brand.700",children:["View DAG ",r.jsx(pe,{mx:"2px"})]})}}),E.display({id:"remote_is_paused",enableSorting:!1,header:()=>r.jsxs(r.Fragment,{children:["Remote",r.jsx(X,{tooltip:"Toggle to pause/unpause DAG in remote"})]}),meta:{width:"100px"},cell:c=>{const{original:o}=c.row;return o.remote?r.jsxs(r.Fragment,{children:[r.jsx(fe,{colorScheme:"success",isChecked:!o.remote?.is_paused,onChange:()=>b(!o.remote?.is_paused,o.local.dag_id,!1)}),r.jsx($,{hasArrow:!0,label:"DAG Run Count",children:r.jsx(ge,{mx:1,fontSize:"sm",variant:"outline",colorScheme:o.remote?.dag_run_count>0?"teal":"red",children:we(o.remote?.dag_run_count||0)})})]}):null}}),E.display({id:"remote_url",header:"Remote URL",meta:{width:"110px"},enableSorting:!1,cell:c=>{const{original:o}=c.row;return o.remote?r.jsxs(me,{isExternal:!0,href:`${h}/dags/${o.remote.dag_id}`,color:"brand.700",children:["View DAG ",r.jsx(pe,{mx:"2px"})]}):null}}),E.display({id:"migrate",header:"Migrate",meta:{align:"right",width:"170px"},enableSorting:!1,cell:c=>{const{original:o}=c.row;let S=null;return o.remote?.dag_id?!o.local.dag_run_count&&!o.remote?.dag_run_count&&(S=M.NO_DAG_RUNS):S=M.NOT_IN_REMOTE,r.jsx(ye,{url:h,token:i,dagId:o.local.dag_id,limit:Number(g),batchSize:Number(A),existsInRemote:!!o.remote?.dag_run_count,disabledReason:S,onMigrate:w,onDelete:j})}})]}function cr(){const{targetUrl:u,token:h,localAirflowVersion:i}=We(),{limit:g,batchSize:A}=He(),w=Ve(),j=je(),[y,b]=_.useState(!0),[c,o]=_.useState(null),[S,I]=_.useState([]),C=_.useCallback(async()=>{b(!0),o(null);try{if(!i){const t=await P.get(O("/api/starship/info"));t.status===200&&t.data?.airflow_version&&w({type:"set-local-airflow-version",version:t.data.airflow_version})}const[d,e]=await Promise.all([P.get(O(R.DAGS_ROUTE)),P.get(U(u+R.DAGS_ROUTE),{headers:q(h)})]);if(d.status===200&&e.status===200)I(Qe(d.data,e.data));else throw new Error("Invalid response from server")}catch(d){o(d),d.response?.status===401&&w({type:"invalidate-token"})}finally{b(!1)}},[u,h,w,i]);_.useEffect(()=>{C()},[C]);const x=_.useCallback(async(d,e,t)=>{const a=t?O(R.DAGS_ROUTE):U(u+R.DAGS_ROUTE);try{const s=await P.patch(a,{dag_id:e,is_paused:d},{headers:q(h)});I(n=>n.map(l=>{if(l.local.dag_id!==e)return l;const f=t?"local":"remote";return{...l,[f]:{...l[f],is_paused:s.data.is_paused}}}))}catch(s){j({title:"Failed to update DAG pause state",description:s.message,status:"error",isClosable:!0,variant:"outline",duration:6e3})}},[u,h,j]),N=_.useCallback((d,e)=>{I(t=>t.map(a=>a.local.dag_id!==d||!a.remote?a:{...a,remote:{...a.remote,dag_run_count:e}}))},[]),k=_.useCallback(d=>{I(e=>e.map(t=>t.local.dag_id!==d||!t.remote?t:{...t,remote:{...t.remote,dag_run_count:0}}))},[]),G=_.useCallback(async(d,e)=>{const t=S.filter(f=>{const D=d?f.local:f.remote;return D&&D.is_paused!==e});if(t.length===0){j({title:"No changes needed",description:`All ${d?"local":"remote"} DAGs are already ${e?"paused":"active"}`,status:"info",duration:4e3,variant:"outline"});return}let a=0;for(const f of t)try{await x(e,f.local.dag_id,d),a+=1}catch{}const s=a!==1?"DAGs":"DAG",n=d?"local":"remote",l=t.length-a;j({title:`${e?"Paused":"Activated"} ${a} ${n} ${s}`,description:l>0?`${l} ${l!==1?"DAGs":"DAG"} failed to update`:`Successfully updated ${n} Airflow instance`,status:l>0?"warning":"success",duration:4e3,variant:"outline"})},[S,j,x]),T=_.useMemo(()=>er({targetUrl:u,token:h,limit:g,batchSize:A,handleMigrate:N,handleDelete:k,localAirflowVersion:i,handlePausedClick:x}),[u,h,g,A,N,k,i,x]);return r.jsxs(J,{children:[r.jsxs(Ie,{direction:{base:"column",md:"row"},justify:"space-between",align:{base:"flex-start",md:"center"},mb:3,children:[r.jsxs(J,{children:[r.jsx(Ne,{size:"md",mb:.5,children:"DAG History"}),r.jsx(B,{fontSize:"xs",color:"gray.600",children:"Migrate DAGs and task history to prevent rescheduling."})]}),r.jsxs(L,{spacing:2,children:[r.jsx($,{hasArrow:!0,label:"Total DAG Runs to migrate",children:r.jsx(ne,{minW:"40",children:r.jsxs(oe,{size:"sm",children:[r.jsx(ie,{children:"# DAG Runs"}),r.jsxs(le,{value:g,onChange:d=>w({type:"set-limit",limit:Number(d)}),children:[r.jsx(ce,{}),r.jsxs(ue,{children:[r.jsx(de,{}),r.jsx(he,{})]})]})]})})}),r.jsx($,{hasArrow:!0,label:"DAG Runs per batch",children:r.jsx(ne,{minW:"40",children:r.jsxs(oe,{size:"sm",children:[r.jsx(ie,{children:"Batch Size"}),r.jsxs(le,{value:A,onChange:d=>w({type:"set-batch-size",batchSize:Number(d)}),children:[r.jsx(ce,{}),r.jsxs(ue,{children:[r.jsx(de,{}),r.jsx(he,{})]})]})]})})}),r.jsx(z,{size:"sm",leftIcon:r.jsx(ke,{}),onClick:C,variant:"outline",isLoading:y,flexShrink:0,children:"Refresh"})]})]}),r.jsxs(L,{spacing:2,mb:3,justify:"space-between",children:[r.jsxs(L,{spacing:2,children:[r.jsx(B,{fontSize:"sm",fontWeight:"semibold",color:"gray.600",children:"Local:"}),r.jsx(z,{size:"sm",leftIcon:r.jsx(_e,{}),onClick:()=>G(!0,!0),colorScheme:"orange",variant:"outline",children:"Pause All"}),r.jsx(z,{size:"sm",leftIcon:r.jsx(be,{}),onClick:()=>G(!0,!1),colorScheme:"green",variant:"outline",children:"Unpause All"})]}),r.jsxs(L,{spacing:2,children:[r.jsx(B,{fontSize:"sm",fontWeight:"semibold",color:"gray.600",children:"Remote:"}),r.jsx(z,{size:"sm",leftIcon:r.jsx(_e,{}),onClick:()=>G(!1,!0),colorScheme:"orange",variant:"outline",children:"Pause All"}),r.jsx(z,{size:"sm",leftIcon:r.jsx(be,{}),onClick:()=>G(!1,!1),colorScheme:"green",variant:"outline",children:"Unpause All"})]})]}),r.jsx(Me,{spacing:3,align:"stretch",w:"100%",children:r.jsx(J,{children:y||c?r.jsx(Ue,{loading:y,error:c}):r.jsx(Be,{data:S,columns:T,searchPlaceholder:"Search DAGs by ID, tags, owners..."})})})]})}export{cr as default};
