import{P as n,G as M,j as e,d as w,B as T,K as L,H as U,b as z,a as B,R as G,V as q}from"./chakra.js";import{r as o}from"./react-core.js";import{a as S}from"./http.js";import{i as F,j as K,G as W,f as Y,c as Z,l as Q,e as P,a as C,b as N,k as $,g as J}from"./index.js";import{P as X}from"./ProgressSummary.js";import{M as ee,P as te,D as ae}from"./PageLoading.js";import{H as se}from"./HiddenValue.js";import{F as re}from"./index.esm.js";import{c as ne}from"./table.js";import"./router.js";import"./icons.js";function _({route:r,headers:s={},existsInRemote:i=!1,sendData:l,isAstro:b,deploymentId:h=null,releaseName:x=null,onStatusChange:u=null}){const[g,t]=o.useState(!1),[c,y]=o.useState(null),k=M(),[p,v]=o.useState(i),I=a=>{v(!1),t(!1),k({title:`Failed to migrate environment variable "${l?.key}"`,description:a.response?.data?.error||a.response?.data||a.message,status:"error",isClosable:!0,variant:"outline",duration:6e3}),y(a)},R=()=>{t(!0),S.post(r,{operationName:"deploymentVariables",query:F,variables:{deploymentUuid:h,releaseName:x}},{headers:s}).then(a=>{const d=a.data?.data?.deploymentVariables||[];return d.push(l),S.post(r,{operationName:"UpdateDeploymentVariables",query:K,variables:{deploymentUuid:h,releaseName:x,environmentVariables:d}},{headers:s})}).then(a=>{t(!1);const d=a.status===200;v(d),u&&u(d)}).catch(I)},j=()=>{t(!0),S.get(r,{headers:s}).then(a=>(a.data?.environmentVariables.push(l),S.post(r,a.data,{headers:s}))).then(a=>{t(!1);const d=a.status===200;v(d),u&&u(d)}).catch(I)},E=()=>g?e.jsx("span",{}):c?e.jsx(ee,{}):p?e.jsx(re,{}):e.jsx(W,{}),A=()=>p?"green":c?"red":"green",V=()=>p?"Ok":c?"Error!":"Migrate";return e.jsx(w,{size:"sm",variant:"outline",isDisabled:g||p,isLoading:g,loadingText:"Loading",leftIcon:E(),colorScheme:A(),onClick:()=>b?j():R(),children:V()})}_.propTypes={route:n.string.isRequired,headers:n.objectOf(n.string),existsInRemote:n.bool,isAstro:n.bool.isRequired,sendData:n.shape({key:n.string,value:n.string,isSecret:n.bool}).isRequired,deploymentId:n.string,releaseName:n.string,onStatusChange:n.func};const D=ne();function oe(r,s){return Object.entries(r).map(([i,l])=>({key:i,value:l})).map(i=>({...i,exists:i.key in s}))}function ie(r){return e.jsx(se,{value:r.getValue()})}function le(r){const{isAstro:s,organizationId:i,deploymentId:l,urlOrgPart:b,token:h,releaseName:x,handleItemStatusChange:u}=r;return[D.accessor("key",{header:"Key",meta:{minWidth:"150px"}}),D.accessor("value",{header:"Value",cell:ie,meta:{minWidth:"200px"},enableSorting:!1}),D.display({id:"migrate",header:"Migrate",meta:{align:"right",width:"120px"},enableSorting:!1,cell:g=>{const{original:t}=g.row;let c;return s?c=C($(i,l)):c=C(J(b)),e.jsx(_,{route:c,headers:N(h),existsInRemote:t.exists,sendData:{key:t.key,value:t.value,isSecret:!1},isAstro:s,deploymentId:l,releaseName:x,onStatusChange:y=>u(t.key,y)})}})]}function ve(){const{targetUrl:r,token:s,isAstro:i,organizationId:l,deploymentId:b,releaseName:h,urlOrgPart:x}=Y(),u=Z(),g=M(),[t,c]=o.useState(!0),[y,k]=o.useState(null),[p,v]=o.useState([]),[I,R]=o.useState(!1),j=o.useCallback(async()=>{c(!0),k(null);try{const[m,f]=await Promise.all([S.get(Q(P.ENV_VAR_ROUTE)),S.get(C(r+P.ENV_VAR_ROUTE),{headers:N(s)})]);if(m.status===200&&f.status===200)v(oe(m.data,f.data)),(f.data.ASTRO_ORGANIZATION_ID||f.data.ASTRO_DEPLOYMENT_ID)&&u({type:"set-organization-id",organizationId:f.data.ASTRO_ORGANIZATION_ID,deploymentId:f.data.ASTRO_DEPLOYMENT_ID});else throw new Error("Invalid response from server")}catch(m){k(m),m.response?.status===401&&u({type:"invalidate-token"})}finally{c(!1)}},[r,s,u]);o.useEffect(()=>{j()},[j]);const E=o.useCallback((m,f)=>{v(H=>H.map(O=>O.key===m?{...O,exists:f}:O))},[]),A=o.useCallback(()=>{g({title:"Bulk migration not yet supported for Environment Variables",description:"Please migrate environment variables individually",status:"info",duration:4e3,isClosable:!0,variant:"outline"}),R(!1)},[g]),V=o.useMemo(()=>le({isAstro:i,organizationId:l,deploymentId:b,urlOrgPart:x,token:s,releaseName:h,handleItemStatusChange:E}),[i,l,b,x,s,h,E]),a=p.length,d=p.filter(m=>m.exists).length;return e.jsxs(T,{children:[e.jsxs(L,{direction:{base:"column",md:"row"},justify:"space-between",align:{base:"flex-start",md:"center"},mb:3,children:[e.jsxs(T,{children:[e.jsx(U,{size:"md",mb:.5,children:"Environment Variables"}),e.jsx(z,{fontSize:"xs",color:"gray.600",children:"Environment variables for Airflow configurations and DAG access."})]}),e.jsx(B,{children:e.jsx(w,{leftIcon:e.jsx(G,{}),onClick:j,variant:"outline",isLoading:t,children:"Refresh"})})]}),e.jsxs(q,{spacing:3,align:"stretch",w:"100%",children:[!t&&!y&&e.jsx(X,{totalItems:a,migratedItems:d,onMigrateAll:A,isMigratingAll:I}),e.jsx(T,{children:t||y?e.jsx(te,{loading:t,error:y}):e.jsx(ae,{data:p,columns:V,searchPlaceholder:"Search by key..."})})]})]})}export{ve as default};
