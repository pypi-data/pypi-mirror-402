"""
Vulnerability Pattern Definitions

CWE-mapped security patterns for automated vulnerability detection.
"""

from dataclasses import dataclass
from enum import Enum


class VulnerabilityType(Enum):
    """CWE-mapped vulnerability types."""

    SQL_INJECTION = "CWE-89"
    COMMAND_INJECTION = "CWE-78"
    XSS = "CWE-79"
    PATH_TRAVERSAL = "CWE-22"
    XXE = "CWE-611"
    SSRF = "CWE-918"
    LDAP_INJECTION = "CWE-90"
    XPATH_INJECTION = "CWE-643"


@dataclass
class VulnerabilityPattern:
    """Definition of a security vulnerability pattern.

    Attributes
    ----------
        name: Human-readable vulnerability name
        cwe_id: Common Weakness Enumeration identifier
        sources: Taint source patterns (user input points)
        sinks: Dangerous sink patterns (vulnerable operations)
        sanitizers: Functions that properly clean/escape data
        severity: Risk level (Critical, High, Medium, Low)
        description: Vulnerability explanation
        mitigation: Recommended fix

    """

    name: str
    cwe_id: str
    sources: list[str]
    sinks: list[str]
    sanitizers: list[str]
    severity: str
    description: str
    mitigation: str


# Predefined vulnerability patterns based on OWASP Top 10
VULNERABILITY_PATTERNS = {
    VulnerabilityType.SQL_INJECTION: VulnerabilityPattern(
        name="SQL Injection",
        cwe_id="CWE-89",
        sources=[
            "request.GET",
            "request.POST",
            "request.args",
            "request.form",
            "request.COOKIES",
            "input(",
            "sys.argv",
        ],
        sinks=[
            "execute(",
            "executemany(",
            ".raw(",
            ".query(",
            "cursor.execute",
            "db.execute",
        ],
        sanitizers=[
            "escape(",
            "quote(",
            "parameterize(",
            "?",  # Parameterized query marker
        ],
        severity="Critical",
        description="User input flows to SQL query without proper parameterization",
        mitigation="Use parameterized queries (prepared statements) or ORM methods",
    ),

    VulnerabilityType.XSS: VulnerabilityPattern(
        name="Cross-Site Scripting (XSS)",
        cwe_id="CWE-79",
        sources=[
            "request.GET",
            "request.POST",
            "request.args",
            "request.form",
            "input(",
        ],
        sinks=[
            "render_template_string(",
            "mark_safe(",
            ".innerHTML",
            "document.write(",
            "eval(",
            "Response(",  # Django HttpResponse with HTML
        ],
        sanitizers=[
            "escape(",
            "bleach.clean(",
            "sanitize(",
            "DOMPurify.sanitize(",
        ],
        severity="High",
        description="User input rendered in HTML without proper escaping",
        mitigation="Use template auto-escaping or HTML sanitization libraries",
    ),

    VulnerabilityType.COMMAND_INJECTION: VulnerabilityPattern(
        name="Command Injection",
        cwe_id="CWE-78",
        sources=[
            "request.GET",
            "request.POST",
            "request.args",
            "request.form",
            "input(",
            "sys.argv",
        ],
        sinks=[
            "os.system(",
            "subprocess.call(",
            "subprocess.run(",
            "subprocess.Popen(",
            "exec(",
            "eval(",
            "shell_exec(",
            "system(",
        ],
        sanitizers=[
            "shlex.quote(",
            "pipes.quote(",
        ],
        severity="Critical",
        description="User input passed to shell command execution",
        mitigation="Avoid shell=True, use subprocess with list arguments, or validate input",
    ),

    VulnerabilityType.PATH_TRAVERSAL: VulnerabilityPattern(
        name="Path Traversal",
        cwe_id="CWE-22",
        sources=[
            "request.GET",
            "request.POST",
            "request.args",
            "request.form",
            "request.FILES",
        ],
        sinks=[
            "open(",
            "read(",
            "write(",
            "os.path.join(",
            "Path(",
        ],
        sanitizers=[
            "os.path.basename(",
            "secure_filename(",
            "Path.resolve(",
        ],
        severity="Medium",
        description="User-controlled file path without validation",
        mitigation="Use os.path.basename() or whitelist allowed paths",
    ),

    VulnerabilityType.XXE: VulnerabilityPattern(
        name="XML External Entity (XXE)",
        cwe_id="CWE-611",
        sources=[
            "request.data",
            "request.body",
            "request.FILES",
        ],
        sinks=[
            "etree.parse(",
            "ElementTree.parse(",
            "lxml.parse(",
            "parseString(",
        ],
        sanitizers=[
            "defusedxml.",
        ],
        severity="High",
        description="Unsafe XML parsing with user-controlled data",
        mitigation="Use defusedxml library or disable external entity processing",
    ),

    VulnerabilityType.SSRF: VulnerabilityPattern(
        name="Server-Side Request Forgery (SSRF)",
        cwe_id="CWE-918",
        sources=[
            "request.GET",
            "request.POST",
            "request.args",
            "request.form",
        ],
        sinks=[
            "requests.get(",
            "requests.post(",
            "urllib.request(",
            "http.request(",
            "fetch(",
        ],
        sanitizers=[
            "is_safe_url(",
            "validate_url(",
        ],
        severity="High",
        description="User-controlled URL in server-side HTTP request",
        mitigation="Whitelist allowed domains or use URL validation",
    ),
}


def get_pattern_by_type(vuln_type: VulnerabilityType) -> VulnerabilityPattern:
    """Get vulnerability pattern by type.

    Args:
    ----
        vuln_type: Vulnerability type enum

    Returns:
    -------
        Corresponding vulnerability pattern

    """
    return VULNERABILITY_PATTERNS[vuln_type]


def get_all_sources() -> list[str]:
    """Get all taint sources across all patterns.

    Returns
    -------
        Combined list of source patterns

    """
    sources = set()
    for pattern in VULNERABILITY_PATTERNS.values():
        sources.update(pattern.sources)
    return list(sources)


def get_all_sinks() -> list[str]:
    """Get all taint sinks across all patterns.

    Returns
    -------
        Combined list of sink patterns

    """
    sinks = set()
    for pattern in VULNERABILITY_PATTERNS.values():
        sinks.update(pattern.sinks)
    return list(sinks)
