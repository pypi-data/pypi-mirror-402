"""Celery configuration generator"""
from pathlib import Path
from core.decorators import Generator
from core.utils import FileOperations
from core.config_reader import ConfigReader


@Generator(
    category="config",
    priority=46,
    enabled_when=lambda c: c.has_celery(),
    requires=["RedisConfigGenerator"],
    description="Generate Celery configuration"
)
class CeleryConfigGenerator:
    """Celery configuration generator"""
    
    def __init__(self, project_path: Path, config_reader: ConfigReader):
        """Initialize Celery config generator
        
        Args:
            project_path: Project root directory path
            config_reader: Configuration reader instance
        """
        self.project_path = Path(project_path)
        self.config_reader = config_reader
        self.file_ops = FileOperations(base_path=project_path)
    
    def generate(self) -> None:
        """Generate Celery configuration"""
        if not self.config_reader.has_celery():
            return
        
        # Generate Celery configuration module
        self._generate_celery_config()
        
        # Note: Celery app instance is now generated by CeleryAppGenerator
        # Tasks are now generated by dedicated task generators
    
    def _generate_celery_config(self) -> None:
        """Generate Celery configuration settings"""
        # Celery requires Redis as message broker (Redis is always available when Celery is enabled)
        content = '''"""Celery configuration module"""

from app.core.config.base import EnvBaseSettings
from pydantic import Field


class CelerySettings(EnvBaseSettings):
    """Celery configuration"""
    
    CELERY_BROKER_URL: str = Field(
        default="redis://localhost:6379/1",
        description="Celery broker URL (Redis DB 1)",
    )
    
    CELERY_RESULT_BACKEND: str = Field(
        default="redis://localhost:6379/2",
        description="Celery result backend URL (Redis DB 2)",
    )
    
    CELERY_ACCEPT_CONTENT: list[str] = Field(
        default=["json"],
        description="Accepted content types for Celery",
    )
    
    CELERY_TASK_SERIALIZER: str = Field(
        default="json",
        description="Task serializer for Celery",
    )
    
    CELERY_RESULT_SERIALIZER: str = Field(
        default="json",
        description="Result serializer for Celery",
    )
    
    CELERY_TIMEZONE: str = Field(
        default="UTC",
        description="Timezone for Celery",
    )
    
    CELERY_ENABLE_UTC: bool = Field(
        default=True,
        description="Enable UTC for Celery",
    )
'''
        
        self.file_ops.create_python_file(
            file_path="app/core/config/modules/celery.py",
            content=content,
            overwrite=True
        )
    