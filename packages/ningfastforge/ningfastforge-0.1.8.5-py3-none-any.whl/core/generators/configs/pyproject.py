"""pyproject.toml generategenerator"""
from core.decorators import Generator
from ..templates.base import BaseTemplateGenerator


@Generator(
    category="config",
    priority=1,
    description="Generate pyproject.toml with dependencies"
)
class PyprojectGenerator(BaseTemplateGenerator):
    """pyproject.toml File generator"""
    
    def generate(self) -> None:
        """generate pyproject.toml file"""
        project_name = self.config_reader.get_project_name()
        
        content = self._build_project_section(project_name)
        content += self._build_dependencies_section()
        content += self._build_dev_dependencies_section()
        content += self._build_build_system_section()
        content += self._build_tool_configs_section()
        
        self.file_ops.create_file(
            file_path="pyproject.toml",
            content=content,
            overwrite=True
        )
    
    def _build_project_section(self, project_name: str) -> str:
        """Buildprojectbasic information section"""
        return f'''[project]
name = "{project_name}"
version = "0.1.0"
description = "FastAPI project generated by Forge"
readme = "README.md"
requires-python = ">=3.10"
'''
    
    def _build_dependencies_section(self) -> str:
        """Builddependencies section"""
        dependencies = self._get_dependencies()
        
        content = 'dependencies = [\n'
        for dep in dependencies:
            content += f'    "{dep}",\n'
        content += ']\n\n'
        
        return content
    
    def _build_dev_dependencies_section(self) -> str:
        """Builddevelopment dependencies section"""
        dev_dependencies = self._get_dev_dependencies()
        
        if not dev_dependencies:
            return ''
        
        content = '[project.optional-dependencies]\n'
        content += 'dev = [\n'
        for dep in dev_dependencies:
            content += f'    "{dep}",\n'
        content += ']\n\n'
        
        return content
    
    def _build_build_system_section(self) -> str:
        """BuildBuildsystem section"""
        return '''[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["app"]
'''
    
    def _build_tool_configs_section(self) -> str:
        """Buildutilityconfiguration section"""
        content = ''
        
        if self.config_reader.has_testing():
            content += self._build_pytest_config()
        
        if self.config_reader.has_dev_tools():
            content += self._build_black_config()
            content += self._build_ruff_config()
            content += self._build_mypy_config()
        
        return content
    
    def _get_dependencies(self) -> list:
        """Getprojectdependencieslist"""
        dependencies = [
            'fastapi>=0.104.0',
            'uvicorn[standard]>=0.24.0',
            'pydantic>=2.5.0',
            'pydantic-settings>=2.1.0',
            'loguru>=0.7.0',  # logginglibrary
        ]
        
        # databasedependencies(is nowrequired)
        dependencies.extend(self._get_database_dependencies())
        
        # authenticationdependencies
        if self.config_reader.has_auth():
            dependencies.extend(self._get_auth_dependencies())
        
        # Redis dependencies
        if self.config_reader.has_redis():
            dependencies.extend(self._get_redis_dependencies())
        
        # Celery dependencies
        if self.config_reader.has_celery():
            dependencies.extend(self._get_celery_dependencies())
        
        return dependencies
    
    def _get_database_dependencies(self) -> list:
        """Getdatabaserelateddependencies"""
        deps = []
        
        db_type = self.config_reader.get_database_type()
        orm_type = self.config_reader.get_orm_type()
        
        # ORM
        if orm_type == "SQLModel":
            deps.append('sqlmodel>=0.0.14')
        elif orm_type == "SQLAlchemy":
            deps.append('sqlalchemy>=2.0.0')
        
        # async SQLAlchemy need greenlet
        deps.append('greenlet>=3.0.0')
        
        # databasedriver
        if db_type == "PostgreSQL":
            deps.extend([
                'psycopg2-binary>=2.9.9',
                'asyncpg>=0.29.0'
            ])
        elif db_type == "MySQL":
            deps.extend([
                'pymysql>=1.1.0',
                'aiomysql>=0.2.0'
            ])
        elif db_type == "SQLite":
            deps.extend([
                'aiosqlite>=0.19.0'
            ])
        
        # migrationutility
        if self.config_reader.has_migration():
            deps.append('alembic>=1.13.0')
        
        return deps
    
    def _get_auth_dependencies(self) -> list:
        """Getauthenticationrelateddependencies"""
        deps = [
            'python-jose[cryptography]>=3.3.0',
            'argon2-cffi>=23.1.0',  # Argon2 Passwordhash
            'python-multipart>=0.0.6',
            'email-validator>=2.1.0',  # Email Validate
        ]
        
        # Complete JWT Auth needemailservicedependencies
        if self.config_reader.get_auth_type() == "complete":
            deps.extend([
                'jinja2>=3.1.0',
                'aiosmtplib>=3.0.0',  # Async SMTP client
            ])
        
        return deps
    
    def _get_dev_dependencies(self) -> list:
        """Get development dependencies list"""
        dev_deps = []
        
        if self.config_reader.has_testing():
            dev_deps.extend([
                'pytest>=7.4.0',
                'pytest-asyncio>=0.21.0',
                'httpx>=0.25.0',
                'aiosqlite>=0.19.0',  # SQLite for testing
            ])
        
        if self.config_reader.has_dev_tools():
            dev_deps.extend([
                'black>=23.12.0',
                'ruff>=0.1.0',
                'mypy>=1.7.0',
            ])
        
        return dev_deps
    
    def _get_redis_dependencies(self) -> list:
        """Get Redis related dependencies"""
        return [
            'redis>=5.0.0',  # Redis client
        ]
    
    def _get_celery_dependencies(self) -> list:
        """Get Celery related dependencies"""
        return [
            'celery>=5.3.0',  # Celery task queue
            'flower>=2.0.0',  # Celery monitoring tool
        ]
    
    def _build_pytest_config(self) -> str:
        """Build pytest configuration"""
        return '''
[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
'''
    
    def _build_black_config(self) -> str:
        """Build Black configuration"""
        return '''
[tool.black]
line-length = 88
target-version = ['py310']
include = '\\.pyi?$'
'''
    
    def _build_ruff_config(self) -> str:
        """Build Ruff configuration"""
        return '''
[tool.ruff]
line-length = 88
target-version = "py310"
select = ["E", "F", "I", "N", "W"]
ignore = []
'''
    
    def _build_mypy_config(self) -> str:
        """Build MyPy configuration"""
        return '''
[tool.mypy]
python_version = "3.10"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false
'''
