"""Environment variable file generator"""
from core.decorators import Generator
from ..templates.base import BaseTemplateGenerator


@Generator(
    category="config",
    priority=4,
    description="Generate .env.example file"
)
class EnvGenerator(BaseTemplateGenerator):
    """Environment variable file generator"""
    
    def generate(self) -> None:
        """generate environment variable files"""
        # generate .env.example
        self._generate_env_example()
        
        # generate .env.development
        self._generate_env_development()
        
        # generate .env.production
        self._generate_env_production()
    
    def _generate_env_example(self) -> None:
        """generate .env.example file(example configuration)"""
        content = self._build_header("Example Environment Variables")
        content += self._build_app_section(example=True)
        content += self._build_database_section(example=True)  # Database is nowrequired
        
        if self.config_reader.has_auth():
            content += self._build_auth_section(example=True)
        
        # Complete JWT Auth requires email configuration
        if self.config_reader.get_auth_type() == "complete":
            content += self._build_email_section(example=True)
        
        if self.config_reader.has_cors():
            content += self._build_cors_section(example=True)
        
        if self.config_reader.has_redis():
            content += self._build_redis_section(example=True)
        
        if self.config_reader.has_celery():
            content += self._build_celery_section(example=True)
        
        content += self._build_logging_section(example=True)
        
        self.file_ops.create_file(
            file_path="secret/.env.example",
            content=content,
            overwrite=True
        )
    
    def _generate_env_development(self) -> None:
        """generate .env.development file(development environment configuration)"""
        content = self._build_header("Development Environment Variables")
        content += self._build_app_section(env="development")
        content += self._build_database_section(env="development")  # Database is nowrequired
        
        if self.config_reader.has_auth():
            content += self._build_auth_section(env="development")
        
        # Complete JWT Auth requires email configuration
        if self.config_reader.get_auth_type() == "complete":
            content += self._build_email_section(env="development")
        
        if self.config_reader.has_cors():
            content += self._build_cors_section(env="development")
        
        if self.config_reader.has_redis():
            content += self._build_redis_section(env="development")
        
        if self.config_reader.has_celery():
            content += self._build_celery_section(env="development")
        
        content += self._build_logging_section(env="development")
        
        self.file_ops.create_file(
            file_path="secret/.env.development",
            content=content,
            overwrite=True
        )
    
    def _generate_env_production(self) -> None:
        """generate .env.production file(production environment configuration)"""
        content = self._build_header("Production Environment Variables")
        content += "# WARNING: This file contains production secrets\n"
        content += "# DO NOT commit this file to version control\n"
        content += "# Make sure to update all passwords and keys before deploying\n\n"
        content += self._build_app_section(env="production")
        
        content += self._build_database_section(env="production")  # Database is nowrequired
        
        if self.config_reader.has_auth():
            content += self._build_auth_section(env="production")
        
        # Complete JWT Auth requires email configuration
        if self.config_reader.get_auth_type() == "complete":
            content += self._build_email_section(env="production")
        
        if self.config_reader.has_cors():
            content += self._build_cors_section(env="production")
        
        if self.config_reader.has_redis():
            content += self._build_redis_section(env="production")
        
        if self.config_reader.has_celery():
            content += self._build_celery_section(env="production")
        
        content += self._build_logging_section(env="production")
        
        self.file_ops.create_file(
            file_path="secret/.env.production",
            content=content,
            overwrite=True
        )
    
    def _build_header(self, title: str) -> str:
        """BuildFile header"""
        return f'''# ============================================
# {title}
# ============================================
# generated by Forge
# DO NOT commit this file to version control
# ============================================

'''
    
    def _build_app_section(self, example: bool = False, env: str = "development") -> str:
        """BuildApplication configuration section"""
        project_name = self.config_reader.get_project_name()
        
        return f'''# ============================================
# Application Configuration
# ============================================
APP_NAME="{project_name}"
APP_VERSION="1.0.0"
APP_DESCRIPTION="{project_name} API"

'''
    
    def _build_server_section(self, example: bool = False, env: str = "development") -> str:
        """Buildservicegeneratorconfiguration section - alreadyDeleteï¼Œservicegeneratorconfigurationpassed via command line arguments"""
        return ''
    
    def _build_database_section(self, example: bool = False, env: str = "development") -> str:
        """BuildDatabase configuration section"""
        db_type = self.config_reader.get_database_type()
        project_name = self.config_reader.get_project_name()
        
        if example:
            if db_type == "PostgreSQL":
                return '''# ============================================
# Database Configuration (PostgreSQL)
# ============================================
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/dbname

# Connection Pool Configuration
ECHO=false
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
            elif db_type == "MySQL":
                return '''# ============================================
# Database Configuration (MySQL)
# ============================================
DATABASE_URL=mysql+aiomysql://user:password@localhost:3306/dbname

# Connection Pool Configuration
ECHO=false
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
            elif db_type == "SQLite":
                return '''# ============================================
# Database Configuration (SQLite)
# ============================================
DATABASE_URL=sqlite+aiosqlite:///./database.db

# Connection Pool Configuration
ECHO=false
POOL_PRE_PING=false
POOL_TIMEOUT=30

'''
        
        # Development/Production specific
        db_name = project_name  # Use project name as database name, consistent with Docker
        echo = "true" if env == "development" else "false"
        
        if db_type == "PostgreSQL":
            if env == "production":
                # Use Docker service name for production
                return f'''# ============================================
# Database Configuration (PostgreSQL)
# ============================================
DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/{db_name}

# Connection Pool Configuration
ECHO={echo}
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
            else:
                # Use localhost for development
                return f'''# ============================================
# Database Configuration (PostgreSQL)
# ============================================
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/{db_name}

# Connection Pool Configuration
ECHO={echo}
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
        elif db_type == "MySQL":
            if env == "production":
                # Use Docker service name for production
                return f'''# ============================================
# Database Configuration (MySQL)
# ============================================
DATABASE_URL=mysql+aiomysql://root:mysql@db:3306/{db_name}

# Connection Pool Configuration
ECHO={echo}
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
            else:
                # Use localhost for development
                return f'''# ============================================
# Database Configuration (MySQL)
# ============================================
DATABASE_URL=mysql+aiomysql://root:mysql@localhost:3306/{db_name}

# Connection Pool Configuration
ECHO={echo}
POOL_PRE_PING=true
POOL_TIMEOUT=30
POOL_SIZE=6
POOL_MAX_OVERFLOW=2

'''
        elif db_type == "SQLite":
            db_file = f"{project_name}_{env}.db" if env != "development" else f"{project_name}.db"
            return f'''# ============================================
# Database Configuration (SQLite)
# ============================================
DATABASE_URL=sqlite+aiosqlite:///./{db_file}

# Connection Pool Configuration
ECHO={echo}
POOL_PRE_PING=false
POOL_TIMEOUT=30

'''
        
        return ''
    
    def _build_auth_section(self, example: bool = False, env: str = "development") -> str:
        """BuildAuthentication configuration section"""
        if example:
            content = '''# ============================================
# Authentication Configuration
# ============================================
JWT_SECRET_KEY=your-secret-key-here-change-in-production-min-32-chars
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRATION=1800
'''
            
            if self.config_reader.has_refresh_token():
                content += '''JWT_REFRESH_TOKEN_EXPIRATION=86400
'''
            
            content += '''JWT_ISSUER=demo
JWT_AUDIENCE=demo_users

'''
            return content
        
        # generate a random secret key for development
        import secrets
        secret_key = secrets.token_urlsafe(32)
        project_name = self.config_reader.get_project_name()
        
        # Generate project identifier (for issuer and audience) - same logic as jwt.py
        project_identifier = project_name.lower().replace('-', '_').replace(' ', '_')
        
        content = f'''# ============================================
# Authentication Configuration
# ============================================
JWT_SECRET_KEY={secret_key}
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRATION=1800
'''
        
        if self.config_reader.has_refresh_token():
            content += '''JWT_REFRESH_TOKEN_EXPIRATION=86400
'''
        
        content += f'''JWT_ISSUER={project_identifier}
JWT_AUDIENCE={project_identifier}_users

'''
        return content
    
    def _build_cors_section(self, example: bool = False, env: str = "development") -> str:
        """Build CORS configuration section"""
        if example:
            return '''# ============================================
# CORS Configuration
# ============================================
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080
CORS_ALLOW_CREDENTIALS=true
CORS_ALLOW_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
CORS_ALLOW_HEADERS=*
CORS_EXPOSE_HEADERS=

'''
        
        if env == "development":
            return '''# ============================================
# CORS Configuration
# ============================================
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080,http://127.0.0.1:3000
CORS_ALLOW_CREDENTIALS=true
CORS_ALLOW_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
CORS_ALLOW_HEADERS=*
CORS_EXPOSE_HEADERS=

'''
        else:
            return '''# ============================================
# CORS Configuration
# ============================================
CORS_ALLOWED_ORIGINS=https://yourdomain.com
CORS_ALLOW_CREDENTIALS=true
CORS_ALLOW_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
CORS_ALLOW_HEADERS=*
CORS_EXPOSE_HEADERS=

'''
    
    def _build_email_section(self, example: bool = False, env: str = "development") -> str:
        """BuildEmail configuration section"""
        project_name = self.config_reader.get_project_name()
        
        if example:
            return f'''# ============================================
# Email Configuration (SMTP)
# ============================================
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
EMAIL_USE_TLS=true
EMAIL_USE_SSL=false
EMAIL_SSL_CERT_REQS=required
EMAIL_TIMEOUT=30
EMAIL_EXPIRATION=3600

# Email From Configuration
EMAIL_FROM_NAME="{project_name}"
EMAIL_FROM_EMAIL=noreply@yourdomain.com

'''
        
        return f'''# ============================================
# Email Configuration (SMTP)
# ============================================
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
EMAIL_USE_TLS=true
EMAIL_USE_SSL=false
EMAIL_SSL_CERT_REQS=required
EMAIL_TIMEOUT=30
EMAIL_EXPIRATION=3600

# Email From Configuration
EMAIL_FROM_NAME="{project_name}"
EMAIL_FROM_EMAIL=noreply@yourdomain.com

'''
    
    def _build_logging_section(self, example: bool = False, env: str = "development") -> str:
        """BuildLogging configuration section"""
        if example:
            return '''# ============================================
# Logging Configuration
# ============================================
LOG_LEVEL=INFO
LOG_TO_FILE=true
LOG_FILE_PATH=logs/app.log
LOG_TO_CONSOLE=true
LOG_CONSOLE_LEVEL=INFO
LOG_ROTATION=1 day
LOG_RETENTION_PERIOD=7 days

'''
        
        log_level = "DEBUG" if env == "development" else "INFO"
        log_file_path = f"logs/app_{env}.log"
        
        return f'''# ============================================
# Logging Configuration
# ============================================
LOG_LEVEL={log_level}
LOG_TO_FILE=true
LOG_FILE_PATH={log_file_path}
LOG_TO_CONSOLE=true
LOG_CONSOLE_LEVEL={log_level}
LOG_ROTATION=1 day
LOG_RETENTION_PERIOD=7 days

'''
    
    def _build_redis_section(self, example: bool = False, env: str = "development") -> str:
        """Build Redis configuration section"""
        if example:
            return '''# ============================================
# Redis Configuration
# ============================================
REDIS_CONNECTION_URL=redis://localhost:6379
REDIS_POOL_SIZE=5
REDIS_SOCKET_TIMEOUT=10
REDIS_DEFAULT_TTL=3600

'''
        
        # Environment-specific Redis configuration
        if env == "development":
            redis_url = "redis://localhost:6379"
            pool_size = "3"
        else:  # production
            redis_url = "redis://redis:6379"  # Use Docker service name for production
            pool_size = "5"
        
        return f'''# ============================================
# Redis Configuration
# ============================================
REDIS_CONNECTION_URL={redis_url}
REDIS_POOL_SIZE={pool_size}
REDIS_SOCKET_TIMEOUT=10
REDIS_DEFAULT_TTL=3600

'''
    
    def _build_celery_section(self, example: bool = False, env: str = "development") -> str:
        """Build Celery configuration section"""
        if example:
            return '''# ============================================
# Celery Configuration
# ============================================
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2
CELERY_TASK_SERIALIZER=json
CELERY_RESULT_SERIALIZER=json
CELERY_ACCEPT_CONTENT=["json"]
CELERY_TIMEZONE=UTC
CELERY_ENABLE_UTC=true
CELERY_TASK_ALWAYS_EAGER=false
CELERY_TASK_EAGER_PROPAGATES=true
CELERY_WORKER_CONCURRENCY=4
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_RESULT_EXPIRES=3600

# Task routing (JSON format)
CELERY_TASK_ROUTES={}

# Periodic tasks schedule (configured in code)
# CELERY_BEAT_SCHEDULE is configured in app/core/celery.py

'''
        
        # Environment-specific Celery configuration
        if env == "development":
            broker_url = "redis://localhost:6379/1"
            result_backend = "redis://localhost:6379/2"
            task_always_eager = "false"
            worker_concurrency = "2"
        else:  # production
            broker_url = "redis://redis:6379/1"  # Use Docker service name for production
            result_backend = "redis://redis:6379/2"  # Use Docker service name for production
            task_always_eager = "false"
            worker_concurrency = "4"
        
        return f'''# ============================================
# Celery Configuration
# ============================================
CELERY_BROKER_URL={broker_url}
CELERY_RESULT_BACKEND={result_backend}
CELERY_TASK_SERIALIZER=json
CELERY_RESULT_SERIALIZER=json
CELERY_ACCEPT_CONTENT=["json"]
CELERY_TIMEZONE=UTC
CELERY_ENABLE_UTC=true
CELERY_TASK_ALWAYS_EAGER={task_always_eager}
CELERY_TASK_EAGER_PROPAGATES=true
CELERY_WORKER_CONCURRENCY={worker_concurrency}
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_RESULT_EXPIRES=3600

# Task routing (JSON format)
CELERY_TASK_ROUTES={{}}

# Periodic tasks schedule (configured in code)
# CELERY_BEAT_SCHEDULE is configured in app/core/celery.py

'''