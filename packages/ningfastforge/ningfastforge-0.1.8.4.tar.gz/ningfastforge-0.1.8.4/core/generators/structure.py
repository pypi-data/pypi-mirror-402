"""Project structure generation module"""
from pathlib import Path
from core.utils import FileOperations
from .alembic import AlembicGenerator


class StructureGenerator:
    """Project structure generator - creates directory structure and initialization files"""

    def __init__(self, project_path: Path, config_reader: 'ConfigReader'):
        """Initialize structure generator
        
        Args:
            project_path: Project root directory path
            config_reader: Configuration reader instance
        """
        self.project_path = Path(project_path)
        self.config_reader = config_reader
        self.file_ops = FileOperations(base_path=project_path)

    def create_project_structure(self) -> None:
        """Create project directory structure"""
        self._create_directories()
        self._create_init_files()
        # Note: Project files are now generated by DynamicGeneratorOrchestrator
        # in ProjectGenerator.generate()
        self._init_alembic()
    
    def _create_directories(self) -> None:
        """Create all required directories"""
        directories = [
            "app", "app/core", "app/core/config", "app/core/config/modules",
            "app/core/database", "app/decorators", "app/schemas", "app/utils",
            "app/crud", "app/models", "app/services", "app/routers", "app/routers/v1",
            "script", "static",
        ]

        if self.config_reader.has_migration():
            directories.append("alembic")

        if self.config_reader.has_testing():
            directories.extend(["tests", "tests/api", "tests/unit"])
        
        for directory in directories:
            (self.project_path / directory).mkdir(parents=True, exist_ok=True)

    def _create_init_files(self) -> None:
        """Create all required __init__.py files"""
        init_files = [
            "app/__init__.py", "app/core/__init__.py", "app/decorators/__init__.py",
            "app/schemas/__init__.py", "app/utils/__init__.py", "app/crud/__init__.py",
            "app/models/__init__.py", "app/services/__init__.py", "app/routers/__init__.py",
            "app/routers/v1/__init__.py",
        ]

        if self.config_reader.has_testing():
            init_files.extend([
                "tests/__init__.py", "tests/api/__init__.py", "tests/unit/__init__.py",
            ])
        
        # Create special __init__.py files
        self._create_config_init()
        self._create_config_modules_init()
        self._create_database_init()
        
        # Batch create regular __init__.py files
        for init_file in init_files:
            self.file_ops.create_file(init_file, content="", overwrite=False)
    
    def _create_config_init(self) -> None:
        """Create app/core/config/__init__.py"""
        content = '''"""Configuration module"""
from .settings import settings

__all__ = ["settings"]
'''
        self.file_ops.create_file("app/core/config/__init__.py", content, overwrite=True)
    
    def _create_config_modules_init(self) -> None:
        """Create app/core/config/modules/__init__.py"""
        imports = [
            "from .app import AppSettings",
            "from .logger import LoggingSettings",
            "from .database import DatabaseSettings",
            "from .jwt import JWTSettings",
        ]
        exports = ["AppSettings", "LoggingSettings", "DatabaseSettings", "JWTSettings"]
        
        if self.config_reader.get_auth_type() == "complete":
            imports.append("from .email import EmailSettings")
            exports.append("EmailSettings")
        
        if self.config_reader.has_cors():
            imports.append("from .cors import CORSSettings")
            exports.append("CORSSettings")
        
        content = f'''"""Configuration module"""
{chr(10).join(imports)}

__all__ = [{', '.join([f'"{exp}"' for exp in exports])}]
'''
        self.file_ops.create_file("app/core/config/modules/__init__.py", content, overwrite=True)
    
    def _create_database_init(self) -> None:
        """Create app/core/database/__init__.py"""
        db_type = self.config_reader.get_database_type()
        
        if db_type == "SQLite":
            # SQLite uses a simpler structure
            content = '''"""Database module"""
from .connection import db_manager, get_database_session

async def get_db():
    """Get database session (async)"""
    async for session in get_database_session():
        yield session

__all__ = ["db_manager", "get_db"]
'''
        else:
            # PostgreSQL and MySQL use the manager pattern
            db_manager = "postgresql_manager" if db_type == "PostgreSQL" else "mysql_manager"
            content = f'''"""Database module"""
from .connection import db_manager
from .{db_type.lower()} import {db_manager}, Base

async def get_db():
    """Get database session (async)"""
    async for session in {db_manager}.get_db():
        yield session

__all__ = ["db_manager", "{db_manager}", "Base", "get_db"]
'''
        
        self.file_ops.create_file("app/core/database/__init__.py", content, overwrite=True)

    def _init_alembic(self) -> None:
        """Initialize Alembic migration tool"""
        if self.config_reader.has_migration():
            alembic_gen = AlembicGenerator(self.project_path, self.config_reader)
            alembic_gen.generate()
