# Generated by Django 5.2.9 on 2026-01-16 22:53

import uuid

import django.db.models.deletion
import pgvector.django.vector
from django.contrib.postgres.operations import CreateExtension
from django.db import migrations, models


class Migration(migrations.Migration):
    initial = True

    dependencies = []

    operations = [
        CreateExtension("vector"),
        migrations.CreateModel(
            name="LLMProviderConfig",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                (
                    "name",
                    models.CharField(
                        blank=True,
                        help_text="Optional custom name (auto: provider/model)",
                        max_length=100,
                    ),
                ),
                (
                    "model",
                    models.CharField(
                        help_text="Model identifier (e.g., gpt-4o-mini, claude-3-5-haiku-20241022)",
                        max_length=100,
                        unique=True,
                    ),
                ),
                (
                    "secret_ref",
                    models.CharField(
                        help_text="Reference to API key in secret store", max_length=255
                    ),
                ),
                (
                    "capabilities",
                    models.JSONField(
                        default=list, help_text='List of capabilities: ["summary", "embedding"]'
                    ),
                ),
                ("enabled", models.BooleanField(db_index=True, default=True)),
                (
                    "priority",
                    models.PositiveIntegerField(
                        db_index=True,
                        default=0,
                        help_text="Selection priority (lower number = higher priority)",
                    ),
                ),
                (
                    "base_url",
                    models.URLField(
                        blank=True, help_text="Custom API base URL (for self-hosted or proxy)"
                    ),
                ),
                (
                    "timeout_seconds",
                    models.PositiveIntegerField(default=30, help_text="Request timeout in seconds"),
                ),
                (
                    "max_tokens",
                    models.PositiveIntegerField(
                        default=1024, help_text="Maximum tokens for generation"
                    ),
                ),
            ],
            options={
                "verbose_name": "LLM Provider Config",
                "verbose_name_plural": "LLM Provider Configs",
                "db_table": "nazara_llm_provider_config",
                "ordering": ["priority", "model"],
            },
        ),
        migrations.CreateModel(
            name="DomainProfile",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("name", models.CharField(max_length=255, unique=True)),
                ("description", models.TextField(blank=True)),
                ("is_active", models.BooleanField(db_index=True, default=False)),
            ],
            options={
                "verbose_name": "Domain Profile",
                "verbose_name_plural": "Domain Profiles",
                "db_table": "nazara_domain_profile",
                "ordering": ["-is_active", "name"],
                "constraints": [
                    models.UniqueConstraint(
                        condition=models.Q(("is_active", True)),
                        fields=("is_active",),
                        name="unique_active_profile",
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="EnrichmentFlow",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                (
                    "target_type",
                    models.CharField(
                        choices=[
                            ("Incident", "Incident"),
                            ("CustomerCase", "Customer Case"),
                            ("TechnicalIssue", "Technical Issue"),
                        ],
                        help_text="Signal type this flow applies to",
                        max_length=50,
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        help_text="Flow name (e.g., 'Default', 'Auth Critical', 'MCP High')",
                        max_length=100,
                    ),
                ),
                (
                    "priority",
                    models.PositiveIntegerField(
                        default=0,
                        help_text="Higher priority flows are checked first. Use 0 for catch-all.",
                    ),
                ),
                (
                    "enabled",
                    models.BooleanField(
                        default=True, help_text="Disabled flows are skipped during routing"
                    ),
                ),
                (
                    "category_filter",
                    models.JSONField(
                        blank=True,
                        default=list,
                        help_text="Match signals with these categories (empty = all)",
                    ),
                ),
                (
                    "severity_filter",
                    models.JSONField(
                        blank=True,
                        default=list,
                        help_text="Match signals with these severities (empty = all)",
                    ),
                ),
                (
                    "service_filter",
                    models.JSONField(
                        blank=True,
                        default=list,
                        help_text="Match signals from these services (empty = all)",
                    ),
                ),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="enrichment_flows",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "Enrichment Flow",
                "verbose_name_plural": "Enrichment Flows",
                "db_table": "nazara_enrichment_flow",
                "ordering": ["profile", "target_type", "-priority"],
            },
        ),
        migrations.CreateModel(
            name="EnrichmentFlowStep",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                (
                    "enrichment_type",
                    models.CharField(
                        choices=[
                            ("summary.v1", "Summary (v1)"),
                            ("embedding.v1", "Embedding (v1)"),
                        ],
                        help_text="Enrichment to execute",
                        max_length=50,
                    ),
                ),
                (
                    "order",
                    models.PositiveIntegerField(
                        blank=True,
                        help_text="Execution order (lower = earlier). Leave blank to auto-assign.",
                        null=True,
                    ),
                ),
                (
                    "input_source",
                    models.CharField(
                        choices=[("raw", "Raw Signal Data"), ("dependent", "Previous Step Output")],
                        default="raw",
                        help_text="Where this step gets its input: raw signal data or output from previous steps",
                        max_length=20,
                    ),
                ),
                (
                    "flow",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="flow_steps",
                        to="nazara_intelligence.enrichmentflow",
                    ),
                ),
            ],
            options={
                "verbose_name": "Flow Step",
                "verbose_name_plural": "Flow Steps",
                "db_table": "nazara_enrichment_flow_step",
                "ordering": ["order"],
            },
        ),
        migrations.CreateModel(
            name="EnrichmentRecord",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                (
                    "target_type",
                    models.CharField(
                        choices=[
                            ("Incident", "Incident"),
                            ("CustomerCase", "Customer Case"),
                            ("TechnicalIssue", "Technical Issue"),
                        ],
                        max_length=50,
                    ),
                ),
                ("target_id", models.UUIDField(db_index=True)),
                (
                    "enrichment_type",
                    models.CharField(
                        choices=[
                            ("summary.v1", "Summary (v1)"),
                            ("embedding.v1", "Embedding (v1)"),
                        ],
                        max_length=50,
                    ),
                ),
                (
                    "input_hash",
                    models.CharField(
                        db_index=True,
                        help_text="SHA-256 hash of input content for idempotency",
                        max_length=64,
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[("success", "Success"), ("failed", "Failed")], max_length=20
                    ),
                ),
                ("error", models.TextField(blank=True, help_text="Error message if status=failed")),
                (
                    "attempts",
                    models.PositiveIntegerField(
                        default=0, help_text="Number of enrichment attempts"
                    ),
                ),
                (
                    "duration_ms",
                    models.PositiveIntegerField(
                        blank=True, help_text="Execution duration in milliseconds", null=True
                    ),
                ),
                (
                    "result",
                    models.JSONField(
                        blank=True,
                        help_text="Structured result for text enrichments (e.g., summary)",
                        null=True,
                    ),
                ),
                (
                    "embedding",
                    pgvector.django.vector.VectorField(
                        blank=True,
                        dimensions=1536,
                        help_text="Vector embedding for similarity search",
                        null=True,
                    ),
                ),
            ],
            options={
                "verbose_name": "Enrichment Record",
                "verbose_name_plural": "Enrichment Records",
                "db_table": "nazara_enrichment_record",
                "ordering": ["-created_at"],
                "indexes": [
                    models.Index(
                        fields=["target_type", "target_id"], name="nazara_enri_target__f3f92d_idx"
                    ),
                    models.Index(
                        fields=["enrichment_type", "input_hash"],
                        name="nazara_enri_enrichm_e1c2a8_idx",
                    ),
                    models.Index(
                        fields=["status", "created_at"], name="nazara_enri_status_31166b_idx"
                    ),
                ],
                "constraints": [
                    models.UniqueConstraint(
                        fields=("target_type", "target_id", "enrichment_type"),
                        name="one_record_per_signal_enrichment",
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="GlossaryTerm",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("term", models.CharField(max_length=100)),
                ("definition", models.TextField()),
                ("aliases", models.JSONField(blank=True, default=list)),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="glossary",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "Glossary Term",
                "verbose_name_plural": "Glossary Terms",
                "db_table": "nazara_glossary_term",
                "ordering": ["term"],
            },
        ),
        migrations.CreateModel(
            name="OperationalPolicy",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("key", models.CharField(max_length=100)),
                ("statement", models.TextField()),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="operational_policies",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "Operational Policy",
                "verbose_name_plural": "Operational Policies",
                "db_table": "nazara_operational_policy",
                "ordering": ["key"],
            },
        ),
        migrations.CreateModel(
            name="SeverityLevel",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("key", models.CharField(max_length=50)),
                ("label", models.CharField(max_length=100)),
                ("rank", models.PositiveIntegerField(help_text="Higher = more severe")),
                ("description", models.TextField(blank=True)),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="severities",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "Severity Level",
                "verbose_name_plural": "Severity Levels",
                "db_table": "nazara_severity_level",
                "ordering": ["rank"],
            },
        ),
        migrations.CreateModel(
            name="SystemCatalogEntry",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("key", models.CharField(max_length=100)),
                ("label", models.CharField(max_length=200)),
                ("description", models.TextField(blank=True)),
                (
                    "entry_type",
                    models.CharField(
                        choices=[
                            ("service", "Internal Service"),
                            ("infra", "Shared Infrastructure"),
                            ("external", "External Dependency"),
                            ("component", "Logical Component"),
                        ],
                        default="service",
                        max_length=50,
                    ),
                ),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="systems",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "System Catalog Entry",
                "verbose_name_plural": "System Catalog Entries",
                "db_table": "nazara_system_catalog_entry",
                "ordering": ["entry_type", "label"],
            },
        ),
        migrations.CreateModel(
            name="DomainCategory",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "version",
                    models.PositiveIntegerField(default=1, help_text="Optimistic locking version"),
                ),
                ("key", models.CharField(max_length=50)),
                ("label", models.CharField(max_length=100)),
                ("description", models.TextField(blank=True)),
                (
                    "profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="categories",
                        to="nazara_intelligence.domainprofile",
                    ),
                ),
            ],
            options={
                "verbose_name": "Domain Category",
                "verbose_name_plural": "Domain Categories",
                "db_table": "nazara_domain_category",
                "ordering": ["key"],
                "constraints": [
                    models.UniqueConstraint(
                        fields=("profile", "key"), name="unique_category_per_profile"
                    )
                ],
            },
        ),
        migrations.AddConstraint(
            model_name="enrichmentflow",
            constraint=models.UniqueConstraint(
                fields=("profile", "target_type", "name"),
                name="unique_flow_name_per_profile_target",
            ),
        ),
        migrations.AddConstraint(
            model_name="enrichmentflow",
            constraint=models.UniqueConstraint(
                fields=("profile", "target_type", "priority"),
                name="unique_priority_per_profile_target",
            ),
        ),
        migrations.AddConstraint(
            model_name="enrichmentflowstep",
            constraint=models.UniqueConstraint(
                fields=("flow", "enrichment_type"), name="unique_step_per_flow"
            ),
        ),
        migrations.AddConstraint(
            model_name="glossaryterm",
            constraint=models.UniqueConstraint(
                fields=("profile", "term"), name="unique_term_per_profile"
            ),
        ),
        migrations.AddConstraint(
            model_name="operationalpolicy",
            constraint=models.UniqueConstraint(
                fields=("profile", "key"), name="unique_operational_policy_per_profile"
            ),
        ),
        migrations.AddConstraint(
            model_name="severitylevel",
            constraint=models.UniqueConstraint(
                fields=("profile", "key"), name="unique_severity_per_profile"
            ),
        ),
        migrations.AddConstraint(
            model_name="severitylevel",
            constraint=models.UniqueConstraint(
                fields=("profile", "rank"), name="unique_rank_per_profile"
            ),
        ),
        migrations.AddConstraint(
            model_name="systemcatalogentry",
            constraint=models.UniqueConstraint(
                fields=("profile", "key"), name="unique_system_per_profile"
            ),
        ),
    ]
