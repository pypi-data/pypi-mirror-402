"""GitHub GraphQL API support for ghapi"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../05_graphql.ipynb.

# %% auto #0
__all__ = ['GhGql', 'list_queries', 'query_args', 'type_fields', 'gh_query']

# %% ../05_graphql.ipynb #373423dc
import os
from gql import gql, Client
from gql.transport.requests import RequestsHTTPTransport

# %% ../05_graphql.ipynb #553fc866
class GhGql:
    "GitHub GraphQL client with lazy-loaded schema"
    def __init__(self, token=None):
        self.token = token or os.getenv('GITHUB_TOKEN')
        self._client = None
    
    @property
    def client(self):
        "Lazy-load the GraphQL client and schema"
        if self._client is None:
            if not self.token: raise ValueError("GITHUB_TOKEN not set")
            transport = RequestsHTTPTransport(
                url='https://api.github.com/graphql',
                headers={'Authorization': f'bearer {self.token}'}
            )
            self._client = Client(transport=transport, fetch_schema_from_transport=True)
            self._client.execute(gql('{ __typename }'))  # Trigger schema fetch
        return self._client
    
    @property
    def schema(self): return self.client.schema
    
    def __call__(self, query, variables=None):
        "Execute a GraphQL query"
        return self.client.execute(gql(query), variable_values=variables)
    
    def list_queries(self):
        "List all available top-level GraphQL query types"
        return list(self.schema.query_type.fields.keys())
    
    def query_args(self, name):
        "Show arguments for a query type"
        return self.schema.query_type.fields[name].args
    
    def type_fields(self, name):
        "List fields on a GraphQL type (use PascalCase, e.g. 'Repository')"
        return list(self.schema.type_map[name].fields.keys())

# %% ../05_graphql.ipynb #b1464c99
_default_client = None

def _get_client():
    "Get or create the default client"
    global _default_client
    if _default_client is None: _default_client = GhGql()
    return _default_client

def list_queries():
    "List all available top-level GraphQL query types"
    return _get_client().list_queries()

def query_args(name:str):
    "Show arguments for a query type"
    return _get_client().query_args(name)

def type_fields(name:str):
    "List fields on a GraphQL type (use PascalCase, e.g. 'Repository')"
    return _get_client().type_fields(name)

def gh_query(query:str, variables:dict[str,any]=None):
    "Execute a GraphQL query"
    return _get_client()(query, variables)
