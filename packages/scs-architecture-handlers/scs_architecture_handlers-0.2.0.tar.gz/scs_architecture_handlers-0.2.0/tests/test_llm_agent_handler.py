import pytest
import requests

from llm_agent_handler import LLMAgentHandler


def test_validate_text_and_person_items():
    h = LLMAgentHandler(host="localhost", port=8000)
    assert h.validate_item({"kind": "text", "client_id": "c1", "utterance": "hi"}, {})
    assert not h.validate_item({"kind": "text", "client_id": 1, "utterance": "hi"}, {})
    pi = [{"name": "Alice", "age": 30, "autogenerated_name": False}]
    assert h.validate_item({"kind": "person", "client_id": "c1", "person_info": pi}, {})
    bad = [{"name": "Bob", "age": "x", "autogenerated_name": True}]
    assert not h.validate_item({"kind": "person", "client_id": "c1", "person_info": bad}, {})


def test_dry_run_text_and_person():
    h = LLMAgentHandler(dry_run=True)
    out_text = h.send_text("c1", "hello")
    assert out_text["client_id"] == "c1" and "response" in out_text
    out_person = h.send_person_batch("c2", [{"name": "A", "age": 20, "autogenerated_name": False}])
    assert out_person["client_id"] == "c2" and "updated_visible_faces" in out_person


def test_network_text_success(monkeypatch):
    h = LLMAgentHandler(host="host", port=8000)

    class DummyResp:
        def __init__(self, data):
            self._data = data
        def raise_for_status(self):
            return None
        def json(self):
            return self._data

    def fake_post(url, json, timeout):
        assert url.endswith("/input/text")
        assert json["client_id"] == "c1"
        assert json["utterance"] == "hello"
        return DummyResp({"client_id": "c1", "response": "Hi!"})

    monkeypatch.setattr(requests, "post", fake_post)
    out = h.send_text("c1", "hello")
    assert out["response"] == "Hi!"


def test_network_person_success(monkeypatch):
    h = LLMAgentHandler(host="host", port=8000)
    pi = [{"name": "A", "age": 20, "autogenerated_name": False}]

    class DummyResp:
        def __init__(self, data):
            self._data = data
        def raise_for_status(self):
            return None
        def json(self):
            return self._data

    def fake_post(url, json, timeout):
        assert url.endswith("/input/person")
        assert json["client_id"] == "c2"
        assert json["person_info"][0]["name"] == "A"
        return DummyResp({"client_id": "c2", "updated_visible_faces": ["A"]})

    monkeypatch.setattr(requests, "post", fake_post)
    out = h.send_person_batch("c2", pi)
    assert out["updated_visible_faces"] == ["A"]


def test_network_error(monkeypatch):
    h = LLMAgentHandler(host="host", port=8000)

    def fake_post(url, json, timeout):
        raise requests.RequestException("boom")

    monkeypatch.setattr(requests, "post", fake_post)
    with pytest.raises(requests.RequestException):
        h.send_text("c", "hi")
    assert h.network_error_count == 1


@pytest.mark.asyncio
async def test_async_wrappers():
    h = LLMAgentHandler(dry_run=True)
    out1 = await h.async_send_text("c3", "yo")
    assert "response" in out1
    out2 = await h.async_send_person_batch("c3", [{"name": "A", "age": 20, "autogenerated_name": False}])
    assert "updated_visible_faces" in out2

