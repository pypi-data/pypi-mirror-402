$schema: "http://json-schema.org/draft-07/schema#"
title: "YAMLpp Schema"
$ref: "#/definitions/node"

definitions:
  scalar:
    oneOf:
      - type: string
      - type: number
      - type: boolean
      - type: "null"

  sequence:
    type: array
    items:
      $ref: "#/definitions/node"

  mapping:
    type: object
    properties:
      .local:
        $ref: "#/definitions/mapping"

      .do:
        description: "Do a sequence of actions"
        $ref: "#/definitions/collection"

      .foreach:
        description: "Iterate through a sequence, for each item in a list"
        type: object
        properties:
          .values:
            description: Variable and list
            type: array
            items:
              type: string
            minItems: 2
          .do:
            $ref: "#/definitions/collection"
        required: [".values", ".do"]
        additionalProperties: false

      .switch:
        description: "Switch between different cases"
        type: object
        properties:
          .expr:
            type: string
          .cases:
            $ref: "#/definitions/mapping"
          .default:
            $ref: "#/definitions/collection"
        required: [".expr", ".cases"]
        additionalProperties: false

      .if:
        description: "Implements if/then/else"
        type: object
        properties:
          .cond:
            type: string
          .then:
            $ref: "#/definitions/collection"
          .else:
            $ref: "#/definitions/collection"
        required: [".cond", ".then"]
        additionalProperties: false

      .import_module:
        descrption: "Import an external YAML(pp) file"
        type: string

      .function:
        description: "Declare a YAMLpp function that returns a node"
        type: object
        properties:
          .name:
            type: string
          .args:
            type: array
            items:
              type: string
          .do:
            $ref: "#/definitions/collection"
        required: [".name", ".args", ".do"]
        additionalProperties: false

      .call:
        description: "Call a YAMLpp function"
        type: object
        properties:
          .name:
            type: string
          .args:
            type: array
            items:
              $ref: "#/definitions/node"
        required: [".name"]
        additionalProperties: false

      .module:
        description: "Imports an external Python module and adds it variables/functions/filters to the stack"
        type: string


      .export:
          description: "Export the current node to an external file"
          type: object
          properties:
            .filename:
              description: "The path to the export file"
              type: string
            .do:
              $ref: "#/definitions/collection"
          required: [".filename", ".do"]
          additionalProperties: false



    # For non-directive keys, allow generic nodes
    additionalProperties:
      $ref: "#/definitions/node"

  node:
    description: "A YAML node: scalar, sequence, or mapping"
    oneOf:
      - $ref: "#/definitions/scalar"
      - $ref: "#/definitions/sequence"
      - $ref: "#/definitions/mapping"

  collection:
    description: "A non-scalar YAML node (sequence or mapping)"
    oneOf:
      - $ref: "#/definitions/sequence"
      - $ref: "#/definitions/mapping"
