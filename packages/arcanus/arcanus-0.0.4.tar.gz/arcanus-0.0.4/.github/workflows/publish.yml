name: Publish to PyPI

on:
    push:
        tags:
            - "v*.*.*" # Trigger on semantic version tags like v0.0.1, v1.2.3

    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (build but don't publish)"
                required: false
                default: false
                type: boolean

permissions:
    contents: read
    id-token: write # Required for trusted publishing to PyPI

jobs:
    build:
        name: Build Distribution
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                  version: "latest"
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.11

            - name: Build package
              run: uv build

            - name: Store distribution packages
              uses: actions/upload-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

    publish-to-pypi:
        name: Publish to PyPI
        if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: pypi
            url: https://pypi.org/p/arcanus

        steps:
            - name: Download distribution packages
              uses: actions/download-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              # Uses trusted publishing - no API token needed
              # Requires configuring trusted publisher on PyPI

    # publish-to-testpypi:
    #     name: Publish to TestPyPI
    #     if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
    #     needs: build
    #     runs-on: ubuntu-latest
    #     environment:
    #         name: testpypi
    #         url: https://test.pypi.org/p/arcanus

    #     steps:
    #         - name: Download distribution packages
    #           uses: actions/download-artifact@v4
    #           with:
    #               name: python-package-distributions
    #               path: dist/

    #         - name: Publish to TestPyPI
    #           uses: pypa/gh-action-pypi-publish@release/v1
    #           with:
    #               repository-url: https://test.pypi.org/legacy/
    #           # Uses trusted publishing - no API token needed
    #           # Requires configuring trusted publisher on TestPyPI

    # github-release:
    #     name: Create GitHub Release
    #     if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
    #     needs: publish-to-pypi
    #     runs-on: ubuntu-latest
    #     permissions:
    #         contents: write

    #     steps:
    #         - uses: actions/checkout@v4

    #         - name: Download distribution packages
    #           uses: actions/download-artifact@v4
    #           with:
    #               name: python-package-distributions
    #               path: dist/

    #         - name: Create GitHub Release
    #           env:
    #               GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #           run: |
    #               gh release create "${{ github.ref_name }}" \
    #                 --title "${{ github.ref_name }}" \
    #                 --generate-notes \
    #                 dist/*
