# py2dist

[English Documentation](README.md)

py2dist æ˜¯ä¸€ä¸ªä½¿ç”¨ Cython å°† Python æºä»£ç ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ‰©å±•æ¨¡å—ï¼ˆ.so/.pydï¼‰çš„å·¥å…·ï¼Œç”¨äºç®€å•åœ°ä¿æŠ¤æºä»£ç ä¸è¢«æ›´æ”¹ï¼Œé€‚ç”¨äºå‘å¸ƒ Python é¡¹ç›®ã€Docker æœåŠ¡é•œåƒçš„æ„å»ºç­‰åœºæ™¯ã€‚

## åŠŸèƒ½

- æ”¯æŒ Linuxã€Macã€Windows å¹³å°
- æ”¯æŒå°†å•ä¸ª `.py` æ–‡ä»¶æˆ–æ•´ä¸ªç›®å½•ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶
- ä¿æŒç›®å½•ç»“æ„ï¼Œè‡ªåŠ¨å¤åˆ¶å…¶ä»–æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
- æ”¯æŒæ’é™¤æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•
- è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ ccache åŠ é€Ÿç¼–è¯‘
- è·å¾— Cython ç¼–è¯‘å¸¦æ¥çš„ä¸€ç‚¹æ€§èƒ½æå‡
- æä¾› CLI å’Œ Python API ä¸¤ç§ä½¿ç”¨æ–¹å¼

## å®‰è£…

```bash
pip3 install py2dist
```

å»ºè®®ä½¿ç”¨ [`uv`](https://docs.astral.sh/uv/) å®‰è£…å’Œç®¡ç†è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶å›ºå®š Python ç‰ˆæœ¬å·ï¼Œé¿å…ç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´ç¼–è¯‘ç»“æœä¸å®é™…è¿è¡Œç¯å¢ƒä¸ä¸€è‡´ã€‚ä»¥ Python 3.12 ä¸ºä¾‹ï¼š

```bash
uv python pin 3.12
uv venv
uv add --dev py2dist
```

> ä¸å»ºè®®ä½¿ç”¨ `uv tool install py2dist` æ–¹æ³•å®‰è£…ï¼Œå› ä¸ºè¿™æ ·çš„è¯ä¼šè°ƒç”¨ç³»ç»Ÿçš„ Python ç‰ˆæœ¬ç¼–è¯‘ï¼Œå¯¼è‡´ç¼–è¯‘ç»“æœä¸å®é™…è¿è¡Œçš„è™šæ‹Ÿç¯å¢ƒç¯å¢ƒä¸ä¸€è‡´ã€‚

## é‡è¦æç¤ºï¼šPython ç‰ˆæœ¬ä¸€è‡´æ€§

ç¼–è¯‘ç”Ÿæˆçš„äºŒè¿›åˆ¶æ‰©å±•æ¨¡å—ï¼ˆ.so/.pydï¼‰ä¸ç‰¹å®šçš„ Python ç‰ˆæœ¬ç»‘å®šã€‚**æ‚¨å¿…é¡»ç¡®ä¿ç¼–è¯‘æ—¶ä½¿ç”¨çš„ Python ç‰ˆæœ¬ä¸è¿è¡Œæ—¶ä½¿ç”¨çš„ Python ç‰ˆæœ¬å®Œå…¨ä¸€è‡´**ï¼ˆåŒ…æ‹¬æ¬¡è¦ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 3.10 å’Œ 3.11 æ˜¯ä¸å…¼å®¹çš„ï¼‰ã€‚

å¦‚æœç‰ˆæœ¬ä¸åŒ¹é…ï¼Œå¯¼å…¥æ¨¡å—æ—¶å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š
`ImportError: ... undefined symbol: _PyThreadState_UncheckedGet`
æˆ–è€…
`ModuleNotFoundError: No module named ...`

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œç•Œé¢ (CLI)

é»˜è®¤è¾“å‡ºç›®å½•ä¸º `dist` / `{-d å‚æ•°æŒ‡å®šçš„ç›®å½•å}`ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `-o` å‚æ•°æŒ‡å®šè¾“å‡ºç›®å½•ã€‚

ç¼–è¯‘å•ä¸ªæ–‡ä»¶ï¼š
```bash
python3 -m py2dist -f myscript.py
```

æˆ–ä½¿ç”¨ `uv` å‘½ä»¤ï¼š
```bash
uv run py2dist -f myscript.py
```

è¾“å‡ºæ–‡ä»¶ä½ç½®ä¸º `dist/myscript.so`

ç¼–è¯‘æ•´ä¸ªç›®å½•ï¼š
```bash
python3 -m py2dist -d myproject
```

æˆ–ä½¿ç”¨ `uv` å‘½ä»¤ï¼š
```bash
uv run py2dist -d myproject
```

è¾“å‡ºæ–‡ä»¶ä½ç½®ä¸º `dist/myproject`ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å¤åˆ¶é `.py` æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•ã€‚

## ç¤ºä¾‹ç”¨æ³•

æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ª Python FastAPI é¡¹ç›®ï¼Œæˆ‘æƒ³å°†å…¶æ‰“åŒ…ä¸ºä¸€ä¸ª Docker é•œåƒçš„åŒæ—¶ä¿æŠ¤æºä»£ç ä¸è¢«ä¿®æ”¹ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ py2dist å°†é¡¹ç›®æ ¸å¿ƒä»£ç ç›®å½•ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ‰©å±•æ¨¡å—ï¼Œç„¶åå°†å…¶å¤åˆ¶åˆ° Docker é•œåƒä¸­ï¼Œç›´æ¥å‘å¸ƒä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒåŸç†ç±»ä¼¼ã€‚

> æˆ‘å¹³æ—¶åœ¨å®é™…é¡¹ç›®ä¸­æ›´ä¹ æƒ¯é€šè¿‡ `uv`ã€`pyproject.toml`ã€`.python-version` ç­‰æ–‡ä»¶æ§åˆ¶é¡¹ç›®ä¾èµ–å’Œ Python ç‰ˆæœ¬ï¼ŒDocker é•œåƒçš„æ„å»ºä¹Ÿå¯ä»¥å®‰è£… `ccache`ã€`uv` æ¥ç­‰å·¥å…·æ¥ä¼˜åŒ–å·¥ä½œæµç¨‹ï¼Œæœ¬æ¼”ç¤ºä¸ºç®€åŒ–æµç¨‹ï¼Œä¸åœ¨æ­¤å±•å¼€ï¼Œå¯ä»¥è‡ªè¡Œç ”ç©¶æ”¹è¿›ã€‚


### ç¤ºä¾‹é¡¹ç›®ç¯å¢ƒ

- `ccache` æ¨èå®‰è£…ï¼Œç”¨äºåŠ é€Ÿåç»­æ”¹åŠ¨é¡¹ç›®æ—¶çš„ç¼–è¯‘é€Ÿåº¦ï¼Œ`py2dist` ä¼šè‡ªåŠ¨è¯†åˆ«ä½¿ç”¨ã€‚
- `python3.12` é¡¹ç›®ç¼–è¯‘æ—¶ä½¿ç”¨çš„ Python ç‰ˆæœ¬ï¼Œå› æ­¤Docker é•œåƒä¸­ä¹Ÿå¿…é¡»ä½¿ç”¨è¯¥ Python ç‰ˆæœ¬ï¼Œå¦åˆ™ä¼šæŠ¥é”™


### é¡¹ç›®ç¤ºä¾‹ç»“æ„ï¼š

```
myproject/
â”œâ”€â”€ Makefile (é¡¹ç›®æ„å»ºæ–‡ä»¶)
â”œâ”€â”€ run.py (æœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶ï¼Œä¸èƒ½è¢«ç¼–è¯‘)
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ server/ (é¡¹ç›®ä»£ç ç›®å½•ï¼Œè¢«ç¼–è¯‘çš„ç›®æ ‡)
â”‚   â”œâ”€â”€ __init__.py (æ¯ä¸ªæ¨¡å—å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ï¼Œå†…å®¹å¯ä»¥ä¸ºç©º)
â”‚   â”œâ”€â”€ main.pyï¼ˆFastAPI ä¸»å…¥å£æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ utils.py
â”‚   â”œâ”€â”€ router/ï¼ˆæ¨¡å—è·¯ç”±ç›®å½•ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py (æ¯ä¸ªæ¨¡å—å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ï¼Œå†…å®¹å¯ä»¥ä¸ºç©º)
â”‚   â”‚   â””â”€â”€ user.py
â”‚   â”œâ”€â”€ static/ï¼ˆå…¶ä»–æ–‡ä»¶ï¼Œä¼šåŸæ ·å¤åˆ¶ï¼‰
â”‚   â”‚   â””â”€â”€ image.png
â”‚   â””â”€â”€ templates/ (å…¶ä»–æ–‡ä»¶ï¼Œä¼šåŸæ ·å¤åˆ¶)
â”‚       â”œâ”€â”€ index.html
â”‚       â””â”€â”€ about.html
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_main.py
â”œâ”€â”€ models/
â””   â””â”€â”€ ...
```

`run.py` æ ·ä¾‹ï¼š
```python
import uvicorn

if __name__ == "__main__":
    uvicorn.run("server.main:app", host="0.0.0.0", port=3000)
```

> 1. `__init__.py` æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå†…å®¹å¯ä»¥ä¸ºç©ºã€‚ä»¥ä¾¿è¢«ç¼–è¯‘åèƒ½è¢«è¯†åˆ«ä¸ºä¸€ä¸ªæ¨¡å—ã€‚
> 
> 2. éœ€è¦ä¸€ä¸ªæœªç¼–è¯‘çš„ `run.py` æ–‡ä»¶æ¥å¯åŠ¨æœåŠ¡å™¨ã€‚
> 
> 3. æŒ‰é€šç”¨è§„èŒƒä¸å»ºè®®åœ¨æºç ç›®å½•ä¸­æ”¾ç½®èµ„æºæ–‡ä»¶ï¼Œä¸€èˆ¬æ”¾åœ¨å•ç‹¬çš„ç›®å½•ä¸­å»å¼•ç”¨ä½¿ç”¨ï¼Œä½†æ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œè¿˜æ˜¯æ”¾äº†ä¸€äº›èµ„æºæ–‡ä»¶æ¼”ç¤ºè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½ã€‚
>

é‚£ä¹ˆå¯ä»¥è¿™æ ·ç¼–å†™ `Makefile`:

```makefile
.PHONY: install compile build

install:
    pip3 install py2dist

compile:
    python3 -m py2dist -d server

build: compile
    docker build -t myproject .
```

è¿™æ ·ç¼–å†™ `Dockerfile`:

```dockerfile
FROM python:3.12-slim

WORKDIR /app

COPY models /app/models

RUN --mount=type=bind,source=requirements.txt,target=requirements.txt
    pip3 install -r requirements.txt

COPY dist/server /app/server
COPY run.py /app/run.py

EXPOSE 3000
CMD ["python3", "/app/run.py"]
```

ç„¶åé€šè¿‡å‘½ä»¤
```bash
cd myproject
make build
```

å³å¯æ„å»ºå‡ºå‘å¸ƒç‰ˆçš„é•œåƒã€‚
æ­¤æ—¶æˆ‘ä»¬æŸ¥çœ‹é•œåƒå†…æ–‡ä»¶ç»“æ„ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š

```
/app/
â”œâ”€â”€ run.py
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.so
â”‚   â”œâ”€â”€ utils.so
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.so
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â””â”€â”€ image.png
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ index.html
â”‚       â””â”€â”€ about.html
â”œâ”€â”€ models/
â””   â””â”€â”€ ...
```

è¾¾åˆ°ç®€å•ä¿æŠ¤æºä»£ç ä¸è¢«ä¿®æ”¹çš„ç›®çš„ã€‚

å¦‚æœä¸æƒ³ä½¿ç”¨ Docker é•œåƒï¼Œå¯ä»¥ç›´æ¥æ‰“åŒ…å‘å¸ƒé¡¹ç›®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼æµç¨‹ï¼ŒåŸç†ç›¸åŒã€‚

é¦–å…ˆä¿®æ”¹ `run.py` æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
```python
import sys
import os

# ================= Import lib =================

current_dir = os.path.dirname(os.path.abspath(__file__))

lib_path = os.path.join(current_dir, "lib")

if lib_path not in sys.path:
    sys.path.insert(0, lib_path)

# ================= End of Import lib =================
```

å¹¶ä¸”ä¿®æ”¹ `server/main.py` æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
```python
import sys
import os

# ================= Import lib =================

current_dir = os.path.dirname(os.path.abspath(__file__))

lib_path = os.path.join(current_dir, "../lib")

if lib_path not in sys.path:
    sys.path.insert(0, lib_path)

# ================= End of Import lib =================
```
ç›®çš„æ˜¯è®© Python è§£é‡Šå™¨èƒ½å¤Ÿè¯†åˆ«åˆ°ç¬¬ä¸‰æ–¹åº“æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥é€šè¿‡ç±»ä¼¼ä¸‹é¢çš„å‘½ä»¤æ‰“åŒ…å‘å¸ƒï¼š

```bash
cd myproject
make compile
mkdir -p build/lib
cp -r dist/server build/server
cp run.py build/run.py
pip install -r requirements.txt --target "./build/lib" --python-version "3.12" --only-binary=:all:
tar -czvf myproject.tar.gz build
```

å³å¯å‘å¸ƒé¡¹ç›®åˆ°ä»»æ„æœåŠ¡å™¨ï¼Œå½“ç„¶è¿™ç§æ–¹å¼ä¹Ÿéœ€è¦è¿è¡Œæ—¶ç¯å¢ƒæœ‰åŒç‰ˆæœ¬å·çš„ Python 3.12 ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œæ”¾ç½®ä¾¿æºç‰ˆ Python 3.12 ç¯å¢ƒï¼Œæˆ–è€…ä½¿ç”¨ `uv` ç­‰å·¥å…·æ¥æ§åˆ¶é¡¹ç›®ä¾èµ–å’Œ Python ç‰ˆæœ¬ï¼Œä¸åœ¨æ­¤å±•å¼€äº†ã€‚

### é«˜çº§

å‚æ•°è¯´æ˜ï¼š
- `-f, --file`: æŒ‡å®šè¦ç¼–è¯‘çš„å•ä¸ª .py æ–‡ä»¶
- `-d, --directory`: æŒ‡å®šè¦ç¼–è¯‘çš„ç›®å½•
- `-o, --output`: è¾“å‡ºç›®å½• (é»˜è®¤ä¸º `dist`)
- `-m, --maintain`: æ’é™¤çš„æ–‡ä»¶æˆ–ç›®å½• (é€—å·åˆ†éš”)
- `-x, --nthread`: ç¼–è¯‘çº¿ç¨‹æ•° (é»˜è®¤ä¸º 1)
- `-q, --quiet`: å®‰é™æ¨¡å¼
- `-r, --release`: å‘å¸ƒæ¨¡å¼ (æ¸…ç†ä¸´æ—¶æ„å»ºæ–‡ä»¶)
- `-c, --ccache`: ä½¿ç”¨ ccache (é»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼Œä¹Ÿå¯æŒ‡å®šè·¯å¾„)

### Python API

```python
from py2dist import compile_file, compile_dir

# ç¼–è¯‘å•ä¸ªæ–‡ä»¶
compile_file("myscript.py", output_dir="dist")

# ç¼–è¯‘ç›®å½•
compile_dir(
    "myproject",
    output_dir="dist",
    exclude=["tests", "setup.py"],
    nthread=4
)
```

## å…¶ä»–

### é¡¹ç›®èµ·æº


æœ‰æ—¶å€™éœ€è¦å‘å¸ƒ Python é¡¹ç›®ï¼Œä½†æ˜¯ä¸å¸Œæœ›å®¢æˆ·è‡ªå·±ä¹±æ”¹ä»£ç å¯¼è‡´å‡ºé—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦èƒ½å¤Ÿç®€å•çš„ä¿æŠ¤æºç æ–‡ä»¶ã€‚

å› ä¸º Python çš„è®¾è®¡å“²å­¦å°±æ˜¯å‘å¸ƒæºä»£ç ï¼Œæ‰€ä»¥ CPython å¹¶æ²¡æœ‰çœŸæ­£çš„ç¼–è¯‘åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰è®¸å¤šäººåšäº†è¿™æ–¹é¢çš„å·¥ä½œäº†ã€‚

æˆ‘æ¯”è¾ƒäº†ç°åœ¨æ¯”è¾ƒæµè¡Œçš„å‡ ä¸ªé¡¹ç›®ï¼š
- [`Nuitka`](https://nuitka.net/) çš„ç¼–è¯‘æ˜¯çœŸç¼–è¯‘ï¼Œç»è¿‡ç‰¹æ®Šä¼˜åŒ–å°† Python ä»£ç ç¼–è¯‘æˆ C ä»£ç ï¼Œå› æ­¤ä¸€äº›ç¬¬ä¸‰æ–¹åŒ…è¿˜è¦å•ç‹¬é€‚é…å’Œè®¾ç½®ï¼Œå¹¶ä¸”æœ‰æ—¶å€™åŒ…å¤šäº†ç¼–è¯‘æ—¶é—´ä¼šå¾ˆé•¿ï¼Œç”¨äº†ä¸€æ®µæ—¶é—´é‚æ”¾å¼ƒã€‚
- [`Pyarmor`](https://github.com/dashingsoft/pyarmor) ä¸“æ³¨äºæ··æ·†åŠ å¯†ï¼Œè¯•äº†ä¸€ä¸‹å…¶å®å·¥ä½œå€’æ˜¯æ­£å¸¸ï¼Œä½†æ˜¯æ²¡æœ‰é€‰æ‹©è¿™ä¸ªé¡¹ç›®ï¼Œå› ä¸ºæˆ‘å¹¶ä¸éœ€è¦å®ƒçš„è®¸å¤šåŠ å¯†æ··æ·†åŠŸèƒ½ï¼Œè€Œä¸”å®ƒæ˜¯å•†ä¸šè½¯ä»¶éœ€è¦ä»˜è´¹ä¹°æœºå™¨è®¸å¯è¯ï¼Œæ‰€ä»¥æ²¡æœ‰é€‰æ‹©è¿™ä¸ªå·¥å…·ã€‚
- [`Cython`](https://cython.org/) å®Œå…¨å…¼å®¹ç°ä»£ Python ç‰ˆæœ¬å’Œç”Ÿæ€ï¼Œè™½ç„¶çº¯ `.py` ä»£ç çš„ç¼–è¯‘å¹¶éçœŸçš„ç¼–è¯‘ä¸º C ä»£ç ï¼Œä½†æ˜¯ä¹Ÿè¶³å¤Ÿæ»¡è¶³ä¸€èˆ¬çš„ä¿æŠ¤æºä»£ç ä¸è¢«ä¿®æ”¹çš„ç›®çš„äº†ã€‚

å·¥ä½œæµå®Œå–„ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´äº†ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œæ‰€ä»¥å°†è¿™ä¸ªé¡¹ç›®å†™æˆä¸€ä¸ªå·¥å…·åŒ…æ–¹ä¾¿å®‰è£…ä½¿ç”¨å¹¶å‘å¸ƒğŸ˜Šã€‚

è¿™ä¸ªé¡¹ç›®ä¸æ¶‰åŠåŠ å¯†æ··æ·†ï¼Œæœ‰è¿™æ–¹é¢çš„éœ€è¦å¯ä»¥è‡ªè¡Œä¼˜åŒ–ã€‚

### Thanks

- [Cython](https://cython.org/) æˆäºˆç»“åˆ Python å’Œ C çš„å¼ºå¤§åŠ›é‡ã€‚
- æœ¬é¡¹ç›®å‚è€ƒäº† [`py2sec`](https://github.com/cckuailong/py2sec) è„šæœ¬ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†ä¼˜åŒ–å’Œæ”¹è¿›ï¼Œæ„Ÿè°¢è¿™ä¸ªä¼˜ç§€é¡¹ç›®çš„ä½œè€…ã€‚