[base]
name = entitysdk
path = src/{[base]name}
testdeps =
    pytest
    pytest-cov
    pytest-httpx
    coverage[toml]

[tox]
envlist =
    lint
    check-packaging
    py{310,311,312,313}

minversion = 3.18

[testenv]
deps =
    {[base]testdeps}
commands =
    python -m pytest --cov={[base]name} tests/unit {posargs}
    python -m coverage xml
    python -m coverage html

extras=staging

[testenv:lint]
deps =
    ruff
    mypy
    types-requests
commands =
	python -m ruff format --check
	python -m ruff check
    python -m mypy src

[testenv:format]
skip_install = true
deps =
    ruff
commands =
	python -m ruff format
	python -m ruff check --fix

[testenv:check-packaging]
skip_install = true
deps =
    build
    twine
commands =
    python -m build -o {envtmpdir}/dist
    twine check {envtmpdir}/dist/*

[testenv:notebooks]
deps =
    jupyter
    nbconvert
    rich
    pandoc
commands =
    jupyter nbconvert --execute --to markdown {posargs:examples/*.ipynb}
    jupyter nbconvert \
        --ClearOutputPreprocessor.enabled=True \
        --ClearMetadataPreprocessor.enabled=True \
        --inplace {posargs:examples/*.ipynb}

[testenv:integration]
deps =
    {[base]testdeps}
passenv =
    ACCESS_TOKEN
setenv =
    DB_API_URL = {env:DB_API_URL:http://localhost:8000}
commands =
    python -m pytest tests/integration {posargs}


[testenv:generate-server-schemas]
skip_install = true
deps =
    datamodel-code-generator[http, debug]>=0.52.2
    ruff
setenv =
    DB_API_URL = {env:DB_API_URL:https://staging.openbraininstitute.org/api/entitycore/openapi.json}
commands =
    datamodel-codegen \
        --url {env:DB_API_URL} \
        --input-file-type openapi \
        --openapi-scopes schemas \
        --output-model-type pydantic_v2.BaseModel \
        --target-python-version 3.10 \
        --use-subclass-enum \
        --use-union-operator \
        --use-standard-collections \
        --output {toxinidir}/src/entitysdk/_server_schemas.py \
        --custom-template-dir {toxinidir}/templates \
        --formatters ruff-format \
        --use-annotated \
        --output-datetime-class AwareDatetime \
        --custom-file-header-path templates/header.jinja2

[testenv:update-traces]
skip_install = true
deps =
setenv =
    ENTITYCORE_REPO_URL = "https://github.com/openbraininstitute/entitycore.git"
    ENTITYCORE_BRANCH_OR_TAG = {env:ENTITYCORE_BRANCH_OR_TAG:main}
    ENTITYCORE_CHECKOUT_DIR = {env:ENTITYCORE_CHECKOUT_DIR:tmp/entitycore}
    EXTRACTED_TRACES=extracted
    ENTITYSDK_TRACES_DIR=tests/unit/models/data/extracted
allowlist_externals =
    echo
    git
    rm
    mv
    make
commands =
    echo "Removing directory: {env:ENTITYCORE_CHECKOUT_DIR}"
    rm -Rf "{env:ENTITYCORE_CHECKOUT_DIR}"
    git clone --branch "{env:ENTITYCORE_BRANCH_OR_TAG}" --single-branch --depth 1 \
        "{env:ENTITYCORE_REPO_URL}" \
        "{env:ENTITYCORE_CHECKOUT_DIR}"
    make -C "{env:ENTITYCORE_CHECKOUT_DIR}" extract-traces VIRTUAL_ENV=
    rm -Rf "{env:ENTITYSDK_TRACES_DIR}"
    mv -vi "{env:ENTITYCORE_CHECKOUT_DIR}/{env:EXTRACTED_TRACES}" "{env:ENTITYSDK_TRACES_DIR}"
