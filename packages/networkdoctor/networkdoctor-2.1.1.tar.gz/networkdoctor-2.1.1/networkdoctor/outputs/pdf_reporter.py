"""
PDF Report Generator for NetworkDoctor - One-Click Full Report
"""
from typing import Dict, Any, List
from pathlib import Path
from datetime import datetime
import json


class PDFReporter:
    """Professional PDF report generation for ISP complaints and IT reports"""
    
    def __init__(self):
        self.name = "PDF Reporter"
    
    @staticmethod
    def generate(results: Dict[str, Any], output_file: str = None):
        """
        Generate comprehensive PDF report.
        Automatically creates outputs/pdf/ folder if not specified.
        
        Args:
            results: Complete diagnosis results
            output_file: Output file path (optional, defaults to outputs/pdf/report_TIMESTAMP.pdf)
        """
        if output_file is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_file = f"outputs/pdf/report_{timestamp}.pdf"
        
        output_path = Path(output_file)
        # Always use outputs/pdf/ structure
        if not output_path.parts[0] == "outputs" or "pdf" not in str(output_path):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = output_path.name if output_path.name.endswith('.pdf') else f"report_{timestamp}.pdf"
            output_path = Path(f"outputs/pdf/{filename}")
            output_file = str(output_path)
        
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        # Generate comprehensive report
        report = PDFReporter._generate_full_report(results)
        
        # Generate comprehensive report
        report = PDFReporter._generate_full_report(results)
        
        # Write report (for now as text/HTML - can be enhanced with reportlab for true PDF)
        # If output_file ends with .pdf, create HTML version that can be converted to PDF
        if output_file.endswith('.pdf'):
            html_file = output_file.replace('.pdf', '.html')
            html_path = Path(html_file)
            html_path.parent.mkdir(parents=True, exist_ok=True)
            with open(html_path, "w", encoding="utf-8") as f:
                f.write(report)
            # Also create text version
            text_file = output_file.replace('.pdf', '.txt')
            PDFReporter._write_text_report(results, text_file)
        else:
            with open(output_path, "w", encoding="utf-8") as f:
                f.write(report)
    
    @staticmethod
    def _generate_full_report(results: Dict[str, Any]) -> str:
        """Generate full HTML report"""
        html = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetworkDoctor - Full Diagnostic Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .header { background: #3498db; color: white; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
        .summary { background: #ecf0f1; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .issue { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 10px 0; }
        .critical { border-left-color: #dc3545; background: #f8d7da; }
        .high { border-left-color: #fd7e14; background: #fff3cd; }
        .medium { border-left-color: #ffc107; background: #fff3cd; }
        .low { border-left-color: #28a745; background: #d4edda; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #3498db; color: white; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ecf0f1; text-align: center; color: #7f8c8d; }
        .score { font-size: 48px; font-weight: bold; color: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ©º NetworkDoctor - Full Diagnostic Report</h1>
            <p><strong>Generated:</strong> {timestamp}</p>
        </div>
        
        {content}
        
        <div class="footer">
            <p>Generated by NetworkDoctor - Ultimate AI-Powered Network Diagnostic Tool</p>
            <p>For ISP Complaints and IT Reports</p>
        </div>
    </div>
</body>
</html>"""
        
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        content = PDFReporter._generate_report_content(results)
        
        return html.format(timestamp=timestamp, content=content)
    
    @staticmethod
    def _generate_report_content(results: Dict[str, Any]) -> str:
        """Generate report content sections"""
        sections = []
        
        # Executive Summary
        summary = PDFReporter._generate_executive_summary(results)
        sections.append(summary)
        
        # Issues Section
        issues = PDFReporter._generate_issues_section(results)
        sections.append(issues)
        
        # Findings Section
        findings = PDFReporter._generate_findings_section(results)
        sections.append(findings)
        
        # Recommendations
        recommendations = PDFReporter._generate_recommendations_section(results)
        sections.append(recommendations)
        
        # Detailed Results
        detailed = PDFReporter._generate_detailed_results(results)
        sections.append(detailed)
        
        return "\n".join(sections)
    
    @staticmethod
    def _generate_executive_summary(results: Dict[str, Any]) -> str:
        """Generate executive summary section"""
        analysis = results.get("analysis", {})
        summary_data = analysis.get("summary", {})
        
        health_score = summary_data.get("health_score", 0)
        total_issues = summary_data.get("total_issues", 0)
        critical_issues = sum(1 for issue in results.get("doctor_results", []) 
                             if issue.get("issues") 
                             and any(i.get("severity") == "critical" for i in issue.get("issues", [])))
        
        html = f"""
        <h2>Executive Summary</h2>
        <div class="summary">
            <div class="score">{health_score}/100</div>
            <p><strong>Overall Health Score:</strong> {health_score}/100</p>
            <p><strong>Total Issues Found:</strong> {total_issues}</p>
            <p><strong>Critical Issues:</strong> {critical_issues}</p>
            <p><strong>Targets Scanned:</strong> {', '.join(results.get('targets', []))}</p>
        </div>
        """
        return html
    
    @staticmethod
    def _generate_issues_section(results: Dict[str, Any]) -> str:
        """Generate issues section"""
        all_issues = []
        
        for doctor_result in results.get("doctor_results", []):
            issues = doctor_result.get("issues", [])
            for issue in issues:
                issue["doctor"] = doctor_result.get("doctor", "unknown")
                all_issues.append(issue)
        
        if not all_issues:
            return "<h2>Issues</h2><p>No issues detected. Network is healthy!</p>"
        
        html = "<h2>Issues Detected</h2>"
        
        # Group by severity
        by_severity = {
            "critical": [],
            "high": [],
            "medium": [],
            "low": [],
        }
        
        for issue in all_issues:
            severity = issue.get("severity", "medium")
            by_severity[severity].append(issue)
        
        for severity in ["critical", "high", "medium", "low"]:
            issues_list = by_severity[severity]
            if issues_list:
                html += f"<h3>{severity.upper()} Severity Issues</h3>"
                for issue in issues_list:
                    html += f"""
                    <div class="issue {severity}">
                        <h4>{issue.get('title', 'Unknown Issue')}</h4>
                        <p><strong>Type:</strong> {issue.get('type', 'unknown')} | <strong>Doctor:</strong> {issue.get('doctor', 'unknown')}</p>
                        <p>{issue.get('description', 'No description')}</p>
                        {PDFReporter._format_recommendations(issue.get('recommendations', []))}
                    </div>
                    """
        
        return html
    
    @staticmethod
    def _format_recommendations(recommendations: List[str]) -> str:
        """Format recommendations as HTML list"""
        if not recommendations:
            return ""
        
        html = "<p><strong>Recommendations:</strong></p><ul>"
        for rec in recommendations:
            html += f"<li>{rec}</li>"
        html += "</ul>"
        return html
    
    @staticmethod
    def _generate_findings_section(results: Dict[str, Any]) -> str:
        """Generate findings section"""
        all_findings = []
        
        for doctor_result in results.get("doctor_results", []):
            findings = doctor_result.get("findings", [])
            for finding in findings:
                finding["doctor"] = doctor_result.get("doctor", "unknown")
                all_findings.append(finding)
        
        if not all_findings:
            return ""
        
        html = "<h2>Key Findings</h2><table>"
        html += "<tr><th>Doctor</th><th>Finding</th><th>Details</th></tr>"
        
        for finding in all_findings[:20]:  # Limit to 20 findings
            finding_type = finding.get("finding", "unknown")
            doctor = finding.get("doctor", "unknown")
            details = json.dumps(finding, indent=2)[:200]  # Truncate long details
            
            html += f"<tr><td>{doctor}</td><td>{finding_type}</td><td><pre>{details}</pre></td></tr>"
        
        html += "</table>"
        return html
    
    @staticmethod
    def _generate_recommendations_section(results: Dict[str, Any]) -> str:
        """Generate recommendations section"""
        recommendations = []
        
        for doctor_result in results.get("doctor_results", []):
            for issue in doctor_result.get("issues", []):
                recs = issue.get("recommendations", [])
                recommendations.extend(recs)
        
        # Remove duplicates
        recommendations = list(dict.fromkeys(recommendations))
        
        if not recommendations:
            return ""
        
        html = "<h2>Action Plan & Recommendations</h2><ol>"
        for rec in recommendations[:20]:  # Limit to 20
            html += f"<li>{rec}</li>"
        html += "</ol>"
        return html
    
    @staticmethod
    def _generate_detailed_results(results: Dict[str, Any]) -> str:
        """Generate detailed results section"""
        html = "<h2>Detailed Results</h2>"
        
        for doctor_result in results.get("doctor_results", []):
            doctor_name = doctor_result.get("doctor", "unknown")
            summary = doctor_result.get("summary", {})
            
            html += f"<h3>{doctor_name.replace('_', ' ').title()}</h3>"
            html += "<table>"
            html += "<tr><th>Metric</th><th>Value</th></tr>"
            
            for key, value in summary.items():
                html += f"<tr><td>{key.replace('_', ' ').title()}</td><td>{value}</td></tr>"
            
            html += "</table>"
        
        return html
    
    @staticmethod
    def _write_text_report(results: Dict[str, Any], output_file: str):
        """Write text version of report"""
        with open(output_file, "w", encoding="utf-8") as f:
            f.write("=" * 70 + "\n")
            f.write("NetworkDoctor - Full Diagnostic Report\n")
            f.write("=" * 70 + "\n\n")
            f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"\n")
            
            # Summary
            analysis = results.get("analysis", {})
            summary = analysis.get("summary", {})
            f.write(f"Overall Health Score: {summary.get('health_score', 0)}/100\n")
            f.write(f"Total Issues: {summary.get('total_issues', 0)}\n\n")
            
            # Issues
            f.write("ISSUES DETECTED:\n")
            f.write("-" * 70 + "\n")
            for doctor_result in results.get("doctor_results", []):
                for issue in doctor_result.get("issues", []):
                    f.write(f"\n[{issue.get('severity', 'unknown').upper()}] {issue.get('title', 'Unknown')}\n")
                    f.write(f"Description: {issue.get('description', 'N/A')}\n")
                    f.write(f"Recommendations:\n")
                    for rec in issue.get("recommendations", []):
                        f.write(f"  - {rec}\n")







