# Copyright 2025 Softwell S.r.l. - Licensed under Apache License 2.0
"""
Cross-language tests: decode files generated by JavaScript.

Run cross_language_generate.js first to generate the test files.
"""

from datetime import date, datetime, time, timezone
from decimal import Decimal
from pathlib import Path
from typing import Any

import pytest

from genro_tytx import from_tytx, from_msgpack, from_xml
from genro_tytx.utils import tytx_equivalent

DATA_DIR = Path(__file__).parent / "cross_language_data_js"


def assert_equivalent(decoded: Any, expected: Any, path: str = "") -> None:
    """Compare decoded value against expected."""
    if expected is None:
        assert decoded is None, f"{path}: expected None"
        return

    if isinstance(expected, dict) and "_type" in expected:
        type_name = expected["_type"]
        value = expected["value"]

        if type_name == "Decimal":
            assert isinstance(decoded, Decimal), f"{path}: expected Decimal"
            assert float(decoded) == float(value), f"{path}: Decimal value mismatch"
            return

        if type_name == "date":
            assert isinstance(decoded, date) and not isinstance(
                decoded, datetime
            ), f"{path}: expected date"
            assert decoded.isoformat() == value, f"{path}: date value mismatch"
            return

        if type_name == "datetime":
            assert isinstance(decoded, datetime), f"{path}: expected datetime"
            # Compare components
            exp_dt = datetime.fromisoformat(value.replace("Z", "+00:00"))
            assert decoded.year == exp_dt.year, f"{path}: year"
            assert decoded.month == exp_dt.month, f"{path}: month"
            assert decoded.day == exp_dt.day, f"{path}: day"
            assert decoded.hour == exp_dt.hour, f"{path}: hour"
            assert decoded.minute == exp_dt.minute, f"{path}: minute"
            return

        if type_name == "time":
            assert isinstance(decoded, time), f"{path}: expected time"
            parts = value.split(":")
            assert decoded.hour == int(parts[0]), f"{path}: hour"
            assert decoded.minute == int(parts[1]), f"{path}: minute"
            return

    if isinstance(expected, list):
        assert isinstance(decoded, list), f"{path}: expected list"
        assert len(decoded) == len(expected), f"{path}: list length"
        for i, (d, e) in enumerate(zip(decoded, expected)):
            assert_equivalent(d, e, f"{path}[{i}]")
        return

    if isinstance(expected, dict):
        assert isinstance(decoded, dict), f"{path}: expected dict"
        for key in expected:
            assert_equivalent(decoded.get(key), expected[key], f"{path}.{key}")
        return

    # Primitives
    assert decoded == expected, f"{path}: primitive mismatch"


# Expected values (mirror of JS test cases)
EXPECTED = {
    "decimal_simple": {"price": Decimal("100.50")},
    "date_simple": {"d": date(2025, 1, 15)},
    "datetime_utc": {"dt": datetime(2025, 1, 15, 10, 30, 0, tzinfo=timezone.utc)},
    "time_simple": {"t": time(10, 30, 45)},
    "mixed_types": {
        "price": Decimal("999.99"),
        "date": date(2025, 6, 15),
        "datetime": datetime(2025, 6, 15, 14, 30, 0, tzinfo=timezone.utc),
        "time": time(8, 0, 0),
        "string": "hello",
        "integer": 42,
        "float": 3.14,
        "boolean": True,
        "null": None,
    },
    "nested_structure": {
        "invoice": {
            "total": Decimal("1234.56"),
            "issued": date(2025, 3, 1),
            "items": [
                {"name": "Item A", "price": Decimal("100.00"), "qty": 2},
                {"name": "Item B", "price": Decimal("200.00"), "qty": 1},
            ],
        }
    },
    "array_of_decimals": [Decimal("1.1"), Decimal("2.2"), Decimal("3.3")],
    "array_of_dates": [date(2025, 1, 1), date(2025, 2, 1), date(2025, 3, 1)],
}


@pytest.fixture(scope="module")
def check_data_dir():
    """Check that data directory exists."""
    if not DATA_DIR.exists():
        pytest.skip(
            "Run cross_language_generate.js first to generate test files"
        )


class TestCrossLanguageJSToPython:
    """Tests decoding files generated by JavaScript."""

    @pytest.mark.parametrize("name", list(EXPECTED.keys()))
    def test_json_text_format(self, name: str, check_data_dir) -> None:
        """Test decoding JSON text format (::JS suffix)."""
        file_path = DATA_DIR / f"{name}.tytx.json"
        if not file_path.exists():
            pytest.skip(f"File not found: {file_path}")

        content = file_path.read_text(encoding="utf-8")
        decoded = from_tytx(content)
        assert tytx_equivalent(decoded, EXPECTED[name])

    @pytest.mark.parametrize("name", list(EXPECTED.keys()))
    def test_msgpack_format(self, name: str, check_data_dir) -> None:
        """Test decoding MessagePack format."""
        pytest.importorskip("msgpack")

        file_path = DATA_DIR / f"{name}.tytx.msgpack"
        if not file_path.exists():
            pytest.skip(f"File not found: {file_path}")

        content = file_path.read_bytes()
        decoded = from_msgpack(content)
        assert tytx_equivalent(decoded, EXPECTED[name])


def extract_xml_value(xml_data: Any) -> Any:
    """Extract plain value from XML attrs/value structure."""
    if xml_data is None:
        return None

    if isinstance(xml_data, list):
        return [extract_xml_value(item) for item in xml_data]

    if isinstance(xml_data, dict):
        # Check if it's an attrs/value structure
        if "attrs" in xml_data and "value" in xml_data:
            return extract_xml_value(xml_data["value"])

        # Regular dict - extract values from each key
        return {k: extract_xml_value(v) for k, v in xml_data.items()}

    # Primitive value
    return xml_data


class TestCrossLanguageXMLJSToPython:
    """Tests decoding XML files generated by JavaScript."""

    @pytest.mark.parametrize("name", list(EXPECTED.keys()))
    def test_xml_format(self, name: str, check_data_dir) -> None:
        """Test decoding XML format."""
        file_path = DATA_DIR / f"{name}.tytx.xml"
        if not file_path.exists():
            pytest.skip(f"File not found: {file_path}")

        content = file_path.read_text(encoding="utf-8")
        decoded = from_xml(content)
        # XML decoded values have attrs/value structure, extract inner values
        extracted = extract_xml_value(decoded)
        assert tytx_equivalent(extracted, EXPECTED[name])


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
