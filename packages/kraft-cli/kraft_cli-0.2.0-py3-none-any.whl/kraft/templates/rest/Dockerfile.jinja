# syntax=docker/dockerfile:1
FROM python:{{ python_version }}-slim AS builder

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# Copy dependency files
COPY pyproject.toml .
COPY src/ src/

# Install dependencies
RUN uv pip install --system --no-cache .

# Production stage
FROM python:{{ python_version }}-slim

WORKDIR /app

# Copy installed packages from builder
COPY --from=builder /usr/local/lib/python{{ python_version }}/site-packages /usr/local/lib/python{{ python_version }}/site-packages
COPY --from=builder /app/src /app/src

# Create non-root user
RUN useradd --create-home appuser
USER appuser

EXPOSE {{ port }}

CMD ["python", "-m", "uvicorn", "{{ package_name }}.main:app", "--host", "0.0.0.0", "--port", "{{ port }}"]
