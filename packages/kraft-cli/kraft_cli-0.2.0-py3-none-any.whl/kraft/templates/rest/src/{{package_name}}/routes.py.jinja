"""API routes for books CRUD operations."""

import uuid

from fastapi import APIRouter, HTTPException

from {{ package_name }}.models import Book, BookCreate, BookUpdate

router = APIRouter(prefix="/books", tags=["books"])

# In-memory storage
_books: dict[str, Book] = {}


@router.get("", response_model=list[Book])
async def list_books() -> list[Book]:
    """List all books."""
    return list(_books.values())


@router.post("", response_model=Book, status_code=201)
async def create_book(book: BookCreate) -> Book:
    """Create a new book."""
    book_id = str(uuid.uuid4())
    new_book = Book(id=book_id, **book.model_dump())
    _books[book_id] = new_book
    return new_book


@router.get("/{book_id}", response_model=Book)
async def get_book(book_id: str) -> Book:
    """Get a book by ID."""
    if book_id not in _books:
        raise HTTPException(status_code=404, detail="Book not found")
    return _books[book_id]


@router.put("/{book_id}", response_model=Book)
async def update_book(book_id: str, book: BookUpdate) -> Book:
    """Update a book."""
    if book_id not in _books:
        raise HTTPException(status_code=404, detail="Book not found")
    
    existing = _books[book_id]
    update_data = book.model_dump(exclude_unset=True)
    updated = existing.model_copy(update=update_data)
    _books[book_id] = updated
    return updated


@router.delete("/{book_id}", status_code=204)
async def delete_book(book_id: str) -> None:
    """Delete a book."""
    if book_id not in _books:
        raise HTTPException(status_code=404, detail="Book not found")
    del _books[book_id]
