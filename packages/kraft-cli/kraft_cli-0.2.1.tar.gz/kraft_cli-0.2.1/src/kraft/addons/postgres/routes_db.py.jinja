"""Database-backed API routes for books CRUD operations."""

import uuid

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from {{ package_name }}.database import get_db
from {{ package_name }}.models import Book, BookCreate, BookUpdate
from {{ package_name }}.models_db import BookDB

router = APIRouter(prefix="/books", tags=["books"])


@router.get("", response_model=list[Book])
async def list_books(db: AsyncSession = Depends(get_db)) -> list[Book]:
    """List all books."""
    result = await db.execute(select(BookDB))
    books = result.scalars().all()
    return [Book(id=b.id, title=b.title, author=b.author, year=b.year) for b in books]


@router.post("", response_model=Book, status_code=201)
async def create_book(book: BookCreate, db: AsyncSession = Depends(get_db)) -> Book:
    """Create a new book."""
    book_id = str(uuid.uuid4())
    db_book = BookDB(id=book_id, **book.model_dump())
    db.add(db_book)
    await db.flush()
    return Book(id=db_book.id, title=db_book.title, author=db_book.author, year=db_book.year)


@router.get("/{book_id}", response_model=Book)
async def get_book(book_id: str, db: AsyncSession = Depends(get_db)) -> Book:
    """Get a book by ID."""
    result = await db.execute(select(BookDB).where(BookDB.id == book_id))
    db_book = result.scalar_one_or_none()
    if not db_book:
        raise HTTPException(status_code=404, detail="Book not found")
    return Book(id=db_book.id, title=db_book.title, author=db_book.author, year=db_book.year)


@router.put("/{book_id}", response_model=Book)
async def update_book(
    book_id: str, book: BookUpdate, db: AsyncSession = Depends(get_db)
) -> Book:
    """Update a book."""
    result = await db.execute(select(BookDB).where(BookDB.id == book_id))
    db_book = result.scalar_one_or_none()
    if not db_book:
        raise HTTPException(status_code=404, detail="Book not found")

    update_data = book.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        setattr(db_book, field, value)

    await db.flush()
    return Book(id=db_book.id, title=db_book.title, author=db_book.author, year=db_book.year)


@router.delete("/{book_id}", status_code=204)
async def delete_book(book_id: str, db: AsyncSession = Depends(get_db)) -> None:
    """Delete a book."""
    result = await db.execute(select(BookDB).where(BookDB.id == book_id))
    db_book = result.scalar_one_or_none()
    if not db_book:
        raise HTTPException(status_code=404, detail="Book not found")
    await db.delete(db_book)
