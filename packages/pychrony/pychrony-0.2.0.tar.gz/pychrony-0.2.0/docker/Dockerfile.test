# Test environment for pychrony with libchrony and chronyd
# Multi-stage build: builder stage compiles libchrony, runtime stage runs tests

# =============================================================================
# Stage 1: Builder - compile libchrony from vendored source
# =============================================================================
FROM fedora:43 AS builder

# Install build tools only
RUN dnf install -y \
    gcc \
    make \
    libtool \
    && dnf clean all

# Copy vendored libchrony source and build
COPY vendor/libchrony/ /tmp/libchrony/
WORKDIR /tmp/libchrony
RUN make && \
    make install prefix=/usr/local DESTDIR=/libchrony-install

# =============================================================================
# Stage 2: Runtime - minimal image with chrony and Python
# =============================================================================
FROM fedora:43

# Install runtime dependencies
# Note: gcc is needed to compile CFFI bindings at install time
RUN dnf install -y \
    chrony \
    python3 \
    python3-pip \
    python3-devel \
    libffi-devel \
    gcc \
    && dnf clean all

# Copy compiled libchrony from builder
COPY --from=builder /libchrony-install/usr/local/ /usr/local/
RUN echo "/usr/local/lib" > /etc/ld.so.conf.d/local.conf && ldconfig

# Create chrony socket directory with correct permissions
RUN mkdir -p /run/chrony && chown chrony:chrony /run/chrony && chmod 750 /run/chrony

# Configure chronyd for testing (local reference clock + Unix socket + NTP source)
RUN echo "local stratum 10" >> /etc/chrony.conf && \
    echo "allow 127.0.0.1" >> /etc/chrony.conf && \
    echo "cmdallow 127.0.0.1" >> /etc/chrony.conf && \
    echo "cmdport 0" >> /etc/chrony.conf && \
    echo "bindcmdaddress /run/chrony/chronyd.sock" >> /etc/chrony.conf && \
    echo "server pool.ntp.org iburst" >> /etc/chrony.conf

# Install UV for Python package management
RUN pip3 install uv

# Set working directory
WORKDIR /app

# Copy dependency specification first (better layer caching)
COPY pyproject.toml README.md LICENSE ./
COPY LICENSES/ LICENSES/

# Install project dependencies before copying source
# This layer will be cached if pyproject.toml doesn't change
RUN uv pip install --system pytest pytest-cov setuptools cffi

# Copy project source files
COPY src/ src/
COPY tests/ tests/

# Install the package in editable mode
RUN uv pip install --system -e "."

# Build CFFI bindings (requires libchrony headers)
# ffi.compile() outputs to /app/pychrony/_core/, but editable install is at /app/src/pychrony/
RUN python3 -c "from pychrony._core._build_bindings import ffi; ffi.compile(verbose=True)" && \
    cp /app/pychrony/_core/_cffi_bindings*.so /app/src/pychrony/_core/

# Default command: run all tests
CMD ["pytest", "tests/", "-v"]
