name: Publish to PyPI

on:
  # Auto-trigger after successful Release workflow
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  # Manual fallback
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish-pypi:
    name: Publish to Production PyPI
    runs-on: ubuntu-latest
    environment: pypi
    # Only run if: workflow_run succeeded, OR manual dispatch
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    steps:
    - name: Download artifacts (from triggering workflow_run)
      if: github.event_name == 'workflow_run'
      uses: dawidd6/action-download-artifact@v12
      with:
        workflow: release.yml
        run_id: ${{ github.event.workflow_run.id }}
        name: ^(wheels-.*|sdist)$
        name_is_regexp: true
        path: dist/
        merge_multiple: true
        if_no_artifact_found: fail

    - name: Download artifacts (from manual dispatch)
      if: github.event_name == 'workflow_dispatch'
      uses: dawidd6/action-download-artifact@v12
      with:
        workflow: release.yml
        name: ^(wheels-.*|sdist)$
        name_is_regexp: true
        path: dist/
        merge_multiple: true
        search_artifacts: true
        workflow_conclusion: success
        branch: ${{ github.event.inputs.release_tag }}
        if_no_artifact_found: fail

    - name: List artifacts
      run: ls -la dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
