name: cubit_setup
description: Setup a Cubit installation for testing
inputs:
  cubit_download_url:
    description: URL where Cubit can be downloaded from
    required: true
  cubit_email:
    description: Email to activate cubit
    required: true
  cubit_password:
    description: Password to activate cubit
    required: true
  cubit_activation_timeout:
    description: Timeout to try cubit activation in seconds
    required: false
    default: "900"
  cubit_activation_delay_between_retries:
    description: Delay between retries to try cubit activation in seconds
    required: false
    default: "60"
outputs:
  cubit_root:
    description: "Path to the Cubit installation"
    value: ${{ steps.cubit-setup.outputs.cubit_root }}
runs:
  using: composite
  steps:
    - name: Download and unpack Cubit
      id: cubit-setup
      shell: bash
      run: |
        # Check if secrets are available
        if [[ -z "${{ inputs.cubit_email }}" || -z "${{ inputs.cubit_password }}" ]]; then
          echo "cubit_email or cubit_password is empty or not injected. Cannot activate Cubit."
          exit 1
        fi
        # We need these packages for cubit to work
        sudo apt update
        sudo apt install -y libglu1-mesa libegl1
        # Download cubit and extract it
        cd ${GITHUB_WORKSPACE}
        wget -q ${{ inputs.cubit_download_url }}
        tar -xzf *.tar.gz
        # Remove the downloaded tarball
        rm *.tar.gz
        # Save cubit root path for following steps
        CUBIT_FOLDER=$(find . -maxdepth 1 -type d -name "Coreform-Cubit-*" | head -n 1 | sed 's|^\./||')
        CUBIT_ROOT="$(pwd)/$CUBIT_FOLDER"
        echo "cubit_root=$CUBIT_ROOT" >> "$GITHUB_OUTPUT"
        # Activate cubit. Retry login until success or timeout.
        timeout="${{ inputs.cubit_activation_timeout }}"
        delay="${{ inputs.cubit_activation_delay_between_retries }}"
        start=$(date +%s)
        until $CUBIT_ROOT/bin/rlm_activate --login "${{ inputs.cubit_email }}" "${{ inputs.cubit_password }}"; do
          now=$(date +%s)
          elapsed=$(( now - start ))
          if [ "$elapsed" -ge "$timeout" ]; then
            echo "Cubit activation timeout reached after $elapsed seconds."
            exit 1
          fi

          echo "Cubit activation failed after ${elapsed} seconds. Threshold is ${timeout} seconds. Retrying..."

          # Delay between retries.
          sleep $delay
        done
        echo "Cubit activation succeeded."
