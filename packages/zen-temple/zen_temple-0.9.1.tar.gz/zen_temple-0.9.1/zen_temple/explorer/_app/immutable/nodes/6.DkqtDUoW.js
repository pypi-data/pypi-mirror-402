import"../chunks/DsnmJJEf.js";import{o as rt,c as Wt,s as we}from"../chunks/jKWSmWmB.js";import{b as Gt,p as Ht,v as He,g as e,k as E,w as wt,q as $e,i as m,u as ge,F as Nt,f as Q,e as gt,be as St,m as le,s as X,c as R,n as bt,x as Vt,h as O,r as S,t as be,l as Ie,o as Ct,a as Yt,j as qt}from"../chunks/DAlzfk79.js";import{i as fe}from"../chunks/CuNXTB5A.js";import{b as jt}from"../chunks/gxe5upM2.js";import{C as Tt,H as Zt,D as Kt,n as Ze,l as Ot,r as Jt,F as vt,S as Qt,g as er,E as xe,b as tr,t as rr,B as ht,c as ar,W as mt}from"../chunks/CrYqV5xP.js";import{e as et,i as ot,u as or,g as nr,b as Bt}from"../chunks/B5O290y9.js";import{u as Rt}from"../chunks/Cg8MRuhV.js";import{M as Dt}from"../chunks/Btt3Sv-I.js";import{s as J,c as It,a as Lt}from"../chunks/D9U3jPEw.js";import{s as yt}from"../chunks/OA-GMRJU.js";import{p as sr}from"../chunks/CvLwV7-q.js";import{d as lr,n as ir,s as Fe,a as Pt,b as ur,c as pt,e as _t,y as cr,p as $t,i as xt,f as fr,T as dr,g as gr}from"../chunks/BMW1TMf0.js";import{d as vr}from"../chunks/CgsLtv0Y.js";import{E as hr}from"../chunks/D74ROtS8.js";const ke=140,tt=16,mr=50,yr=200,Xt=140,pr=32,Ae=5,nt=20,Mt=10,At=2,Ve=16,_r=40;let Z=[],Ye=[],qe=!1;function Ke(a,i){return a.reduce((t,d)=>t+i(d),0)}function xr(){Z.forEach(a=>{a.linksOut=Ye.filter(i=>i.source===a),a.linksIn=Ye.filter(i=>i.target===a)})}function wr(){Z.forEach(a=>{a.value=qe?1:Math.max(Ke(a.linksIn,i=>i.value),Ke(a.linksOut,i=>i.value))})}function br(){Z=Z.filter(a=>a.linksIn.length>0||a.linksOut.length>0)}function $r(){let a=0;const i=[];Ye.forEach(t=>{zt(t.source,t.target,i)?(t.causesCycle=!0,t.cycleIndex=++a):(t.causesCycle=!1,i.push(t))})}function zt(a,i,t){const d=t.filter(l=>l.source===i);return t.length==0||d.length==0?!1:d.some(l=>l.target===a||zt(a,l.target,t))}function Er(){let a=Z,i=[],t=0;for(;a.length;)i=[],a.forEach(d=>{d.x=t,d.linksOut.forEach(l=>{l.causesCycle||i.push(l.target)})}),a=i,t++;for(a=Z;a.length;)i=[],a.forEach(d=>{if(d.linksOut.length>0&&d.stickTo===null){const l=d.linksOut.filter(f=>!f.causesCycle).map(f=>f.target.x);l.length>0&&(d.x=Math.max(d.x,Math.min(...l)-1))}d.linksIn.forEach(l=>{l.causesCycle||i.push(l.source)})}),a=i;Z.forEach(d=>{d.stickTo==="right"&&(d.x=t-1)}),Cr(Xt+ke)}function Cr(a){Z.forEach(i=>{i.x*=a})}function Nr(){const a={};return Z.forEach(i=>{const t=i.x;a[t]||(a[t]=[]),a[t].push(i)}),Object.values(a).sort((i,t)=>i[0].x-t[0].x)}function st(a){return a.y+a.dy/2}function Sr(){const a=Nr();i(),f();for(let p=1,_=0;_<pr;++_,p*=.95)l(p),f(),d(p),f();function i(){const p=qe?_r:yr,_=Math.min(...Z.map(u=>u.value>1e-6?p/u.value:1/0));let x=0;Z.filter(u=>u.distinctRow).sort((u,w)=>u.x-w.x).forEach(u=>{u.y=x,u.dy=u.value*_,x+=u.dy+mr}),a.forEach(u=>{let w=0;u.filter(T=>!T.distinctRow).forEach(T=>{T.y=w,T.dy=T.value*_,w+=T.dy+tt})}),Ye.forEach(u=>{u.dy=qe?6:u.value*_})}function t(p){return qe?1:Math.max(p.value,1e-6)}function d(p){a.forEach(_=>{_.forEach(x=>{if(x.linksIn.length===0||x.distinctRow)return;const u=x.linksIn,w=Ke(u,T=>st(T.source)*t(T))/Ke(u,T=>t(T));x.y+=(w-st(x))*p})})}function l(p){a.slice().reverse().forEach(_=>{_.forEach(x=>{if(x.linksOut.length===0||x.distinctRow)return;const u=x.linksOut,w=Ke(u,T=>st(T.target)*t(T))/Ke(u,T=>t(T));x.y+=(w-st(x))*p})})}function f(){a.forEach(p=>{let _=p[0],x,u=0;const w=p.length;let T;for(p.sort((V,Ne)=>V.y-Ne.y),T=0;T<w;++T)_=p[T],x=u-_.y,_.distinctRow?x>0?(p[T-1].y=_.y+_.dy+tt,u=p[T-1].y+p[T-1].dy+tt):u=_.y+_.dy+tt:(x>0&&(_.y+=x),u=_.y+_.dy+tt)})}}function Ut(){const a=(t,d)=>(l,f)=>{const p=d?1:-1;return l.causesCycle&&f.causesCycle?p*(l.cycleIndex-f.cycleIndex):l.causesCycle?-p:f.causesCycle?p:l[t].y-f[t].y},i=Math.max(...Z.map(t=>t.y+t.dy));Z.forEach(t=>{t.linksIn.sort(a("source",t.y<i/2)),t.linksOut.sort(a("target",t.y<i/2))}),Z.forEach(t=>{let d=0,l=0;t.linksOut.forEach(f=>{qe?f.sy=(t.dy-f.dy)/2:(f.sy=d,d+=f.dy)}),t.linksIn.forEach(f=>{qe?f.ty=(t.dy-f.dy)/2:(f.ty=l,l+=f.dy)})})}function Tr(a,i,t){Z=a,Ye=i,qe=t,xr(),wr(),br(),$r(),Er(),Sr(),Ut()}function Or(a,i){a<0||a>=Z.length||(Z[a].y=i,Ut())}function kt(){const a=Z.map(t=>({label:t.label,color:t.color,value:t.value,unit:t.unit,unitSuffix:t.unitSuffix,showTotal:t.showTotal,x:t.x,y:t.y,dy:t.dy,linksIn:Ye.map((d,l)=>d.target===t?l:-1).filter(d=>d>=0),linksOut:Ye.map((d,l)=>d.source===t?l:-1).filter(d=>d>=0)})),i=Ye.map(t=>({source:a[Z.indexOf(t.source)],target:a[Z.indexOf(t.target)],value:t.value,color:t.color,unit:t.unit,causesCycle:t.causesCycle,cycleIndex:t.cycleIndex,dy:t.dy,sy:t.sy,ty:t.ty}));return[a,i]}const lt=a=>()=>a;function Et(a,{sourceEvent:i,subject:t,target:d,identifier:l,active:f,x:p,y:_,dx:x,dy:u,dispatch:w}){Object.defineProperties(this,{type:{value:a,enumerable:!0,configurable:!0},sourceEvent:{value:i,enumerable:!0,configurable:!0},subject:{value:t,enumerable:!0,configurable:!0},target:{value:d,enumerable:!0,configurable:!0},identifier:{value:l,enumerable:!0,configurable:!0},active:{value:f,enumerable:!0,configurable:!0},x:{value:p,enumerable:!0,configurable:!0},y:{value:_,enumerable:!0,configurable:!0},dx:{value:x,enumerable:!0,configurable:!0},dy:{value:u,enumerable:!0,configurable:!0},_:{value:w}})}Et.prototype.on=function(){var a=this._.on.apply(this._,arguments);return a===this._?this:a};function Br(a){return!a.ctrlKey&&!a.button}function Rr(){return this.parentNode}function Dr(a,i){return i??{x:a.x,y:a.y}}function Ir(){return navigator.maxTouchPoints||"ontouchstart"in this}function Lr(){var a=Br,i=Rr,t=Dr,d=Ir,l={},f=lr("start","drag","end"),p=0,_,x,u,w,T=0;function V(n){n.on("mousedown.drag",Ne).filter(d).on("touchstart.drag",Te).on("touchmove.drag",Oe,ir).on("touchend.drag touchcancel.drag",Ee).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function Ne(n,P){if(!(w||!a.call(this,n,P))){var z=Pe(this,i.call(this,n,P),n,P,"mouse");z&&(Fe(n.view).on("mousemove.drag",Le,Pt).on("mouseup.drag",Se,Pt),ur(n.view),pt(n),u=!1,_=n.clientX,x=n.clientY,z("start",n))}}function Le(n){if(_t(n),!u){var P=n.clientX-_,z=n.clientY-x;u=P*P+z*z>T}l.mouse("drag",n)}function Se(n){Fe(n.view).on("mousemove.drag mouseup.drag",null),cr(n.view,u),_t(n),l.mouse("end",n)}function Te(n,P){if(a.call(this,n,P)){var z=n.changedTouches,F=i.call(this,n,P),K=z.length,ve,Ce;for(ve=0;ve<K;++ve)(Ce=Pe(this,F,n,P,z[ve].identifier,z[ve]))&&(pt(n),Ce("start",n,z[ve]))}}function Oe(n){var P=n.changedTouches,z=P.length,F,K;for(F=0;F<z;++F)(K=l[P[F].identifier])&&(_t(n),K("drag",n,P[F]))}function Ee(n){var P=n.changedTouches,z=P.length,F,K;for(w&&clearTimeout(w),w=setTimeout(function(){w=null},500),F=0;F<z;++F)(K=l[P[F].identifier])&&(pt(n),K("end",n,P[F]))}function Pe(n,P,z,F,K,ve){var Ce=f.copy(),ie=$t(ve||z,P),Be,ue,ee;if((ee=t.call(n,new Et("beforestart",{sourceEvent:z,target:V,identifier:K,active:p,x:ie[0],y:ie[1],dx:0,dy:0,dispatch:Ce}),F))!=null)return Be=ee.x-ie[0]||0,ue=ee.y-ie[1]||0,function je(L,ce,Xe){var ae=ie,he;switch(L){case"start":l[K]=je,he=p++;break;case"end":delete l[K],--p;case"drag":ie=$t(Xe||ce,P),he=p;break}Ce.call(L,n,new Et(L,{sourceEvent:ce,subject:ee,target:V,identifier:K,active:he,x:ie[0]+Be,y:ie[1]+ue,dx:ie[0]-ae[0],dy:ie[1]-ae[1],dispatch:Ce}),F)}}return V.filter=function(n){return arguments.length?(a=typeof n=="function"?n:lt(!!n),V):a},V.container=function(n){return arguments.length?(i=typeof n=="function"?n:lt(n),V):i},V.subject=function(n){return arguments.length?(t=typeof n=="function"?n:lt(n),V):t},V.touchable=function(n){return arguments.length?(d=typeof n=="function"?n:lt(!!n),V):d},V.on=function(){var n=f.on.apply(f,arguments);return n===f?V:n},V.clickDistance=function(n){return arguments.length?(T=(n=+n)*n,V):Math.sqrt(T)},V}function Ft(a,i){let t=0;for(let d of a)(d=+d)&&(t+=d);return t}var Pr=(a,i,t)=>i(e(t).carrier),Mr=Q('<button class="flex items-center p-0 text-gray-600 dark:text-gray-400 text-sm"><svg width="40" height="12" class="me-1"><rect width="40" height="12"></rect></svg> <span> </span></button>'),Ar=Q('<div class="flex flex-wrap gap-2"></div>'),kr=Q('<h2 class="flex items-start font-bold text-lg me-4"><span class="me-2">Legend</span> <!></h2> <!>',1),Fr=Ct('<path class="cycle-link svelte-l7ef6a" stroke="none"><title> </title></path>'),Hr=Ct('<path class="link svelte-l7ef6a" fill="none"><title> </title></path>'),Yr=Ct('<g class="node svelte-l7ef6a"><rect stroke="black" stroke-width="1"></rect><text text-anchor="middle"> </text></g>'),jr=Q('<div class="flex justify-between text-xs px-2 text-nowrap"><div class="flex items-center me-1"><svg class="me-1" width="12" height="12"><rect width="12" height="12"></rect></svg> <span> </span></div> <div> </div></div>'),Xr=Q('<div class="flex justify-between text-xs px-2 pt-1 text-nowrap"><strong>Total:</strong> <div> </div></div>'),zr=Q('<div><div class="font-bold text-xs px-2">Inflows:</div> <!> <!></div>'),Ur=Q('<div class="flex justify-between text-xs px-2 text-nowrap"><div class="flex items-center me-1"><svg class="me-1" width="12" height="12"><rect width="12" height="12"></rect></svg> <span> </span></div> <div> </div></div>'),Wr=Q('<div class="flex justify-between text-xs px-2 pt-1 text-nowrap"><strong>Total:</strong> <div> </div></div>'),Gr=Q('<div class="font-bold mt-1 text-sm px-2">Outflows:</div> <!> <!>',1),Vr=Q('<div class="font-bold text-sm px-2"> </div> <!> <!>',1),qr=Q('<div class="relative resize-y overflow-y-hidden"><svg class="max-w-full"><g><g class="links"></g><g class="nodes"></g></g></svg> <!></div>'),Zr=Q("<!> <!>",1);function Kr(a,i){Ht(i,!0);let t=E(936),d=E(800),l=E(void 0),f=sr(i,"id",3,"diagram"),p=vr(V,100);He(()=>{e(te),i.nodes.length&&wt(()=>{T(i.nodes,i.links),p()})});let _=[],x=[],u=E($e([])),w=E($e([]));function T(r,c){_=r.map(s=>({label:s.label??"Unnamed",color:s.color??"#ccc",id:s.id??"",value:0,unit:s.unit??"",unitSuffix:s.unitSuffix??!1,stickTo:s.stickTo??null,showTotal:s.showTotal??!0,distinctRow:s.distinctRow??!1,linksIn:[],linksOut:[],x:0,y:0,dy:0})),x=c.flatMap(s=>{if(!e(te)&&s.value<1e-6)return[];let h=_.find($=>$.id===s.source.id&&$.label===s.source.label),b=_.find($=>$.id===s.target.id&&$.label===s.target.label);return!h||!b?(console.warn("Link refers to unknown node",s),[]):[{source:h,target:b,value:s.value,color:s.color,unit:s.unit,causesCycle:!1,cycleIndex:0,dy:0,sy:0,ty:0}]})}function V(){Tr(_,x,e(te)),(r=>{var c=Nt(r,2);m(u,c[0],!0),m(w,c[1],!0)})(kt())}function Ne(r,c){return s=>r*(1-s)+c*s}function Le(r){if(r.causesCycle){let M=Ae,W=r.source.x+ke,y=r.source.y+r.sy+r.dy,g=r.target.x,oe=r.target.y,N=W+nt,D=y,A=N,k=-Mt-r.cycleIndex*(M+At),j=g-nt,o=j,C=oe+r.ty+r.dy,I=D-r.dy,H=C-r.dy,re=Ve/2-Ae;return r.target.y>e(Ee)/2&&(k=e(Ee)-k,D=r.source.y+r.sy,C=r.target.y+r.ty,I=D+r.dy,H=C+r.dy,M=-Ae),`M${W},${D}L${N},${D}C${N+Ve},${D} ${A+Ve},${k} ${A},${k}H${j-Ae}C${j-Ve},${k} ${o-Ve},${C} ${o},${C}H${g}V${H}H${o}C${o-re},${H} ${j-re},${k+M} ${j},${k+M}H${A-Ae}C${A+re},${k+M} ${N+re},${D-r.dy} ${N},${I}L${W},${I}`}const c=r.source.x+ke,s=r.target.x,b=Ne(c,s)(.5),$=r.source.y+r.sy+r.dy/2,B=r.target.y+r.ty+r.dy/2;return`M${c},${$} C${b},${$} ${b},${B} ${s},${B}`}let Se=ge(()=>{if(!e(w).length)return 0;const r=Math.max(...e(w).map(c=>c.cycleIndex));return r==0?0:Mt+r*(Ae+At)}),Te=ge(()=>e(u).length&&e(u).some(r=>r.x===0&&r.linksIn.length>0)?-nt-Ae-Ve:0),Oe=ge(()=>{if(!e(u).length)return e(t);const r=Math.max(...e(u).map(c=>c.x+ke));return e(u).some(c=>c.x===r&&c.linksOut.length>0)?r+nt+Ae+Ve-e(Te):r-e(Te)}),Ee=ge(()=>e(u).length?Math.max(...e(u).map(r=>r.y+r.dy)):e(d));function Pe(r){let c,s,h,b=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/;const $=r.match(b);if($)c=parseInt($[1],10),s=parseInt($[2],10),h=parseInt($[3],10);else return!1;return .299*c+.587*s+.114*h<85}function n(){if(!e(l))return;const{width:r,height:c}=e(l).parentElement.getBoundingClientRect();m(t,r,!0),m(d,c,!0),p()}rt(n);const P=new ResizeObserver(n);rt(()=>{e(l)&&e(l).parentElement&&P.observe(e(l).parentElement)}),Wt(()=>{P.disconnect()});let z=E($e(xt.toString())),F=fr().scaleExtent([1,1/0]).on("zoom",r=>{m(z,r.transform.toString(),!0),Xe()}).on("end",()=>{Xe()});He(()=>{F=F.translateExtent([[e(Te)-5,-e(Se)-5],[e(Oe)+5,e(Ee)+e(Se)+5]])}),rt(()=>{e(l)&&Fe(e(l)).call(F)});function K(){e(l)&&Fe(e(l)).call(F.transform,xt)}function ve(r){const c=e(u).find(M=>M.label===r);if(!c||!e(l))return;const s=3*ke+2*Xt+8,h=e(Oe)/s,b=-(c.x+ke/2)*h+e(Oe)/2,$=-(c.y+c.dy/2)*h+e(Ee)/2,B=Fe(e(l));F.transform(B,xt.translate(b,$).scale(h))}let Ce=Lr().on("start",function(){this.parentNode&&this.parentNode.appendChild(this)}).on("drag",function(r){const c=Number(this.dataset.idx);isNaN(c)||(ie(r,c),ue(r))});He(()=>{e(u),e(l)&&Fe(e(l)).selectAll(".node").call(Ce)});function ie(r,c){if(r.clientY===0||c<0||c>=e(u).length)return;const s=e(u)[c].y+r.dy,h=Math.max(0,s);Or(c,h),(b=>{var $=Nt(b,2);m(u,$[0],!0),m(w,$[1],!0)})(kt())}let Be=E(null);function ue(r){e(l)&&m(Be,$t(r,e(l).parentElement),!0)}let ee=E(null);function je(){e(l)&&m(ee,e(l).getBoundingClientRect(),!0)}rt(je);let L=ge(()=>{if(!e(Be)||!e(l))return null;let[r,c]=e(Be),s=e(l).getBoundingClientRect(),h=Fe(e(l)).selectAll(".node").nodes().findLast($=>{let B=$.getBoundingClientRect(),M=B.left-s.left,W=B.top-s.top;return r>=M&&r<=M+B.width&&c>=W&&c<=W+B.height});if(!h)return null;let b=Number(h.dataset.idx);return isNaN(b)||b<0||b>=e(u).length?null:e(u)[b]}),ce=E(null);function Xe(){if(e(L)===null||!e(l))return;const r=e(u).findIndex(s=>s===e(L));if(r===-1)return;const c=Fe(e(l)).selectAll(`.node[data-idx="${r}"]`).nodes()[0];c&&m(ce,c.getBoundingClientRect(),!0)}He(Xe);let ae=ge(()=>e(ce)===null||e(ee)===null?0:e(ce).left-e(ee).left+e(ce).width/2),he=ge(()=>e(ce)===null||e(ee)===null?0:e(ce).top-e(ee).top+e(ce).height/2),it=ge(()=>e(ce)===null?0:e(ce).height/2),at=ge(()=>e(ce)===null||e(ee)===null?!1:e(ce).top-e(ee).top>e(d)/2);function v(r){return`${r.source.label} â†’ ${r.target.label}:
${r.value.toFixed(3)} ${r.unit}`}let te=E(!1);function Me(){return e(te)}function _e(){m(te,!e(te))}function Y(){e(l)&&gr(e(l),"sankey_diagram.svg")}var pe={resetZoom:K,getShowStructureOnly:Me,toggleShowStructureOnly:_e,downloadSVG:Y},q=Zr();gt("resize",St,n),gt("scroll",St,je);var me=le(q);Tt(me,{class:"flex",children:(r,c)=>{var s=kr(),h=le(s),b=X(R(h),2);Zt(b,{children:(M,W)=>{bt();var y=Vt("Click on legend items to focus on into in the diagram.");O(M,y)},$$slots:{default:!0}}),S(h);var $=X(h,2);{var B=M=>{var W=Ar();et(W,21,()=>i.legendItems,y=>y.carrier,(y,g)=>{var oe=Mr();oe.__click=[Pr,ve,g];var N=R(oe),D=R(N);S(N);var A=X(N,2),k=R(A,!0);S(A),S(oe),be(()=>{J(D,"fill",e(g).color),we(k,e(g).carrier)}),O(y,oe)}),S(W),O(M,W)};fe($,M=>{i.legendItems&&i.legendItems.length>0&&M(B)})}O(r,s)},$$slots:{default:!0}});var U=X(me,2);return Tt(U,{noPadding:!0,children:(r,c)=>{var s=qr(),h=R(s);h.__mousemove=ue,yt(h,"",{},{font:"9px sans-serif"});var b=R(h),$=R(b);et($,21,()=>e(w).toSorted((y,g)=>g.value-y.value),ot,(y,g)=>{var oe=Ie(),N=le(oe);{var D=k=>{var j=Fr();let o;var C=R(j),I=R(C,!0);S(C),S(j),be((H,re,de)=>{J(j,"d",H),o=yt(j,"",o,re),we(I,de)},[()=>Le(e(g)),()=>({fill:e(g).color,opacity:"0.3"}),()=>v(e(g))]),O(k,j)},A=k=>{var j=Hr();let o;var C=R(j),I=R(C,!0);S(C),S(j),be((H,re,de)=>{J(j,"d",H),o=yt(j,"",o,re),we(I,de)},[()=>Le(e(g)),()=>({"stroke-opacity":"0.3",stroke:e(g).color,"stroke-width":Math.max(1,e(g).dy)}),()=>v(e(g))]),O(k,j)};fe(N,k=>{e(g).causesCycle?k(D):k(A,!1)})}O(y,oe)}),S($);var B=X($);et(B,21,()=>e(u),ot,(y,g,oe)=>{var N=Yr();J(N,"data-idx",oe);var D=R(N),A=X(D),k=R(A);S(A),S(N),be((j,o)=>{J(D,"x",e(g).x),J(D,"y",e(g).y+.5),J(D,"width",ke),J(D,"height",j),J(D,"fill",e(g).color),J(A,"x",e(g).x+ke/2),J(A,"y",e(g).dy>16?e(g).y+e(g).dy/2:e(g).y-2),Lt(A,0,o),J(A,"dominant-baseline",e(g).dy>16?"middle":"auto"),we(k,`${e(g).label??""}
								${e(g).unitSuffix?` [${e(g).unit}]`:""}`)},[()=>Math.max(.1,e(g).dy-1),()=>It([e(g).dy>16&&(Pe(e(g).color)?"fill-white":"fill-black"),e(g).dy<=16&&"fill-black dark:fill-white"])]),O(y,N)}),S(B),S(b),S(h),jt(h,y=>m(l,y),()=>e(l));var M=X(h,2);{var W=y=>{dr(y,{get x(){return e(ae)},get y(){return e(he)},get yOffset(){return e(it)},get isOnTop(){return e(at)},minX:0,get maxX(){return e(t)},children:(g,oe)=>{var N=Vr(),D=le(N),A=R(D,!0);S(D);var k=X(D,2);{var j=I=>{var H=zr(),re=X(R(H),2);et(re,17,()=>e(L).linksIn,ot,(ne,G)=>{var ye=Ie(),Re=le(ye);{var se=ze=>{var Ue=jr(),We=R(Ue),Ge=R(We),ut=R(Ge);S(Ge);var Je=X(Ge,2),ct=R(Je);S(Je),S(We);var Qe=X(We,2),ft=R(Qe);S(Qe),S(Ue),be(dt=>{J(ut,"fill",e(w)[e(G)].source.color),we(ct,`${e(w)[e(G)].source.label??""}:`),we(ft,`${dt??""}
										${e(w)[e(G)].unit??""}`)},[()=>e(w)[e(G)].value.toFixed(3)]),O(ze,Ue)};fe(Re,ze=>{e(w)[e(G)].value&&ze(se)})}O(ne,ye)});var de=X(re,2);{var De=ne=>{var G=Xr(),ye=X(R(G),2),Re=R(ye);S(ye),S(G),be(se=>we(Re,`${se??""}
									${e(L).unit??""}`),[()=>Ft(e(L).linksIn.map(se=>e(w)[se]?.value||0)).toFixed(3)]),O(ne,G)};fe(de,ne=>{e(L).showTotal&&e(L).linksIn.length>1&&ne(De)})}S(H),be(()=>Lt(H,1,It([e(L).linksOut.length>0&&"border-b border-gray-400 pb-1"]))),O(I,H)};fe(k,I=>{e(L).linksIn.length>0&&I(j)})}var o=X(k,2);{var C=I=>{var H=Gr(),re=X(le(H),2);et(re,17,()=>e(L).linksOut,ot,(ne,G)=>{var ye=Ie(),Re=le(ye);{var se=ze=>{var Ue=Ur(),We=R(Ue),Ge=R(We),ut=R(Ge);S(Ge);var Je=X(Ge,2),ct=R(Je);S(Je),S(We);var Qe=X(We,2),ft=R(Qe);S(Qe),S(Ue),be(dt=>{J(ut,"fill",e(w)[e(G)].target.color),we(ct,`${e(w)[e(G)].target.label??""}:`),we(ft,`${dt??""}
									${e(w)[e(G)].unit??""}`)},[()=>e(w)[e(G)].value.toFixed(3)]),O(ze,Ue)};fe(Re,ze=>{e(w)[e(G)].value&&ze(se)})}O(ne,ye)});var de=X(re,2);{var De=ne=>{var G=Wr(),ye=X(R(G),2),Re=R(ye);S(ye),S(G),be(se=>we(Re,`${se??""}
								${e(L).unit??""}`),[()=>Ft(e(L).linksOut.map(se=>e(w)[se]?.value||0)).toFixed(3)]),O(ne,G)};fe(de,ne=>{e(L).showTotal&&e(L).linksOut.length>1&&ne(De)})}O(I,H)};fe(o,I=>{e(L).linksOut.length>0&&I(C)})}be(()=>we(A,e(L).label)),O(g,N)},$$slots:{default:!0}})};fe(M,y=>{e(L)!==null&&y(W)})}S(s),be(()=>{J(h,"id",f()),J(h,"width",e(t)),J(h,"height",e(d)),J(h,"viewBox",`${e(Te)-10} ${-e(Se)} ${e(Oe)+20} ${e(Ee)+2*e(Se)+20}`),J(b,"transform",e(z))}),gt("mouseleave",h,()=>m(Be,null)),O(r,s)},$$slots:{default:!0}}),O(a,q),Yt(pe)}Gt(["click","mousemove"]);var Jr=Q("<!> <!>",1),Qr=Q("<!> <!>",1),ea=Q("<!> <!>",1),ta=Q('<i class="bi bi-house me-2"></i> <div>Reset zoom</div>',1),ra=Q('<i class="bi bi-diagram-3 me-2"></i> <div> </div>',1),aa=Q('<i class="bi bi-download me-2"></i> <div>Download SVG</div>',1),oa=Q('<div class="flex justify-end items-end h-full gap-4"><!> <!> <!></div>');function xa(a,i){Ht(i,!0);let t=E($e([])),d=E(!1),l=E(!1),f=E(null),p=E($e([])),_=E($e([])),x=E(null),u=null,w=null,T="",V="",Ne="",Le=E(null),Se=E(null),Te=E(null),Oe=E(null),Ee=E(null),Pe=E(null),n=E(null),P=E(null),z=E(null),F=E(null),K=E(null),ve=E(null),Ce=E($e([])),ie=E($e([])),Be=E($e([])),ue=E($e([])),ee=E($e([])),je=E($e([])),L=E(void 0);He(()=>{if(!e(t).length){m(x,null);return}Ne&&e(t).includes(Number(Ne))?m(x,Ne,!0):m(x,e(t)[0].toString(),!0)}),He(()=>{e(x)&&(Ne=e(x))}),Rt(()=>e(ue),()=>!!e(f),()=>T,()=>u,v=>m(p,v,!0),v=>T=v,v=>u=v),Rt(()=>e(ee),()=>!!e(f),()=>V,()=>w,v=>m(_,v,!0),v=>V=v,v=>w=v),He(()=>{e(p),e(_),e(x),wt(()=>{at()})}),He(()=>{e(x),e(p),e(_),qt().then(()=>{wt(()=>{or({year:e(x),car:e(p).map(v=>e(ue).indexOf(v)).join("~")||null,nodes:e(_).map(v=>e(ee).indexOf(v)).join("~")||null})})})}),rt(()=>{m(x,nr("year"),!0),u=Bt("car"),w=Bt("nodes")});function ce(){Xe()}async function Xe(){if(!e(f))return;m(l,!0);let v=await er(e(f).solution_name,["flow_conversion_input","flow_conversion_output","flow_storage_charge","flow_storage_discharge","flow_import","flow_export","demand","shed_demand","flow_storage_inflow","flow_storage_spillage","flow_transport","flow_transport_loss"],e(f).scenario_name,"","demand");m(Le,xe.fromRows(v.flow_conversion_input?.data??[])),m(Se,xe.fromRows(v.flow_conversion_output?.data??[]),!0),m(Te,xe.fromRows(v.flow_storage_charge?.data??[]),!0),m(Oe,xe.fromRows(v.flow_storage_discharge?.data??[]),!0),m(Ee,xe.fromRows(v.flow_import?.data??[]),!0),m(Pe,xe.fromRows(v.flow_export?.data??[]),!0),m(n,xe.fromRows(v.demand?.data??[]),!0),m(P,xe.fromRows(v.shed_demand?.data??[]),!0),m(z,xe.fromRows(v.flow_storage_inflow?.data??[]),!0),m(F,xe.fromRows(v.flow_storage_spillage?.data??[]),!0),m(K,xe.fromRows(v.flow_transport?.data??[]),!0),m(ve,xe.fromRows(v.flow_transport_loss?.data??[]),!0),m(Ce,v.unit?.data||[],!0),m(l,!1),at()}function ae(v){let te=e(Ce).find(Me=>Me.carrier===v)||{};return te[0]||te.units||""}function he(v){return e(f)&&e(f).detail.reference_carrier[v]||""}function it(v){return e(f)?e(f).detail.system.set_technologies.filter(te=>{const Me=e(f)?.detail.carriers_input[te]||[],_e=e(f)?.detail.carriers_output[te]||[],Y=e(f)?.detail.reference_carrier[te];return[...Me,..._e].some(pe=>v.includes(pe))||Y&&v.includes(Y)}):[]}function at(){if(!e(f)||!e(Le)||!e(Se)||!e(Te)||!e(Oe)||!e(Ee)||!e(Pe)||!e(n)||!e(P)||!e(z)||!e(F)||!e(K)||!e(ve))return[];const v="rgb(180,180,180)",te=e(f)?.detail.system.set_storage_technologies||[],Me=e(f)?.detail.system.set_conversion_technologies||[],_e=e(f)?.detail.system.set_transport_technologies||[];function Y(o,C,I,H,re=!1,de=null,De=!0,ne=!1){return{id:o,label:C,color:I,unit:H,unitSuffix:re,stickTo:de,showTotal:De,distinctRow:ne}}Jt();const pe=[],q=e(ue).map(o=>{const C=Ze(o);return pe.push({color:C,carrier:o}),Y(o,o,C,ae(o),!0,null,!0,!0)}),me=Me.map(o=>Y(o,o,v,ae(he(o)),!1,null,!1)),U=te.map(o=>Y(o,o,v,ae(he(o)),!1,null,!1)),r=te.map(o=>Y(o,o+"_inflow",v,ae(he(o)))),c=te.map(o=>Y(o,o+"_spillage",v,ae(he(o)),!1,null,!1));let s=Ze();const h=e(ue).map(o=>Y(o,o+" import",s,ae(o),!0,"left"));s=Ze();const b=e(ue).map(o=>Y(o,o+" export",s,ae(o),!0,"right"));s=Ze();const $=e(ue).map(o=>Y(o,o+" shed demand",s,ae(o)));s=Ze();const B=e(ue).map(o=>Y(o,o+" demand",s,ae(o),!0,"right"));s=Ze();const M=_e.map(o=>Y(o,o+" transport in",s,ae(he(o)),!1,null,!1)),W=_e.map(o=>Y(o,o+" transport out",s,ae(he(o)),!1,null,!1)),y={carrier:e(p),node:e(_),technology:it(e(p))},g=e(t).indexOf(Number(e(x)));if(g===-1)return;const oe=[];function N(o,C,I,H,re=0){return de=>{let De=de.data[g]-re;Math.abs(De)<5e-4&&(De=0);const ne=o.find(se=>se.id===de.index[C]),G=I.find(se=>se.id===de.index[H]);if(!ne||!G){console.warn("Missing source or target node",{sourceNode:ne,targetNode:G},{sourceId:C,targetId:H});return}let ye=v;const Re=q.find(se=>se.id===de.index.carrier);Re&&(ye=Re.color||v),oe.push({source:ne,target:G,value:De,color:ye,unit:ae(de.index.carrier)})}}function D(o){const C=he(o.index.technology);C&&(o.index.carrier=C)}e(Le).filterByCriteria(y).groupBy(["technology","carrier"]).forEach(N(q,"carrier",me,"technology")),e(Se).filterByCriteria(y).groupBy(["technology","carrier"]).forEach(N(me,"technology",q,"carrier")),e(Te).filterByCriteria(y).groupBy(["technology"]).forEach(o=>{const C=he(o.index.technology);C&&(o.index.carrier=C)}).forEach(N(q,"carrier",U,"technology")),e(Oe).filterByCriteria(y).groupBy(["technology"]).forEach(D).forEach(N(U,"technology",q,"carrier")),e(z).filterByCriteria(y).groupBy(["technology"]).forEach(D).forEach(N(r,"technology",U,"technology")),e(F).filterByCriteria(y).groupBy(["technology"]).forEach(D).forEach(N(U,"technology",c,"technology")),e(Ee).filterByCriteria(y).groupBy(["carrier"]).forEach(N(h,"carrier",q,"carrier")),e(Pe).filterByCriteria(y).groupBy(["carrier"]).forEach(N(q,"carrier",b,"carrier"));const A=e(P).filterByCriteria(y).groupBy(["carrier"]);A.forEach(N($,"carrier",B,"carrier")),e(n).filterByCriteria(y).groupBy(["carrier"]).forEach(o=>{const C=A.find(H=>H.index.carrier===o.index.carrier),I=C?C.data[g]:0;N(q,"carrier",B,"carrier",I)(o)});const k=Ot(e(f).detail.edges,e(_),!0),j=e(ve).filterByCriteria({...y,edge:k}).groupBy(["technology"]);e(K).filterByCriteria({...y,edge:k}).groupBy(["technology"]).forEach(D).forEach(o=>{const C=j.find(H=>H.index.technology===o.index.technology),I=C?C.data[g]:0;N(M,"technology",q,"carrier",I)(o)}),e(K).filterByCriteria({...y,edge:Ot(e(f).detail.edges,e(_),!1)}).groupBy(["technology"]).forEach(D).forEach(N(q,"carrier",W,"technology")),m(ie,[...q,...me,...U,...r,...c,...h,...b,...$,...B,...M,...W],!0),m(Be,oe,!0),m(je,pe,!0)}Kt(a,{pageTitle:"The Energy System",subtitle:"Sankey diagram of energy flows",filters:_e=>{var Y=ea(),pe=le(Y);vt(pe,{title:"Solution Selection",children:(U,r)=>{{let c=ge(()=>e(l)||e(d));Qt(U,{solutionSelected:ce,get disabled(){return e(c)},get years(){return e(t)},set years(s){m(t,s,!0)},get selected_solution(){return e(f)},set selected_solution(s){m(f,s,!0)},get carriers(){return e(ue)},set carriers(s){m(ue,s,!0)},get nodes(){return e(ee)},set nodes(s){m(ee,s,!0)},get loading(){return e(d)},set loading(s){m(d,s,!0)}})}}});var q=X(pe,2);{var me=U=>{var r=Qr(),c=le(r);vt(c,{title:"Carrier Selection",children:(h,b)=>{Dt(h,{get options(){return e(ue)},label:"Carriers",get value(){return e(p)},set value($){m(p,$,!0)}})}});var s=X(c,2);vt(s,{title:"Data Selection",children:(h,b)=>{var $=Jr(),B=le($);{let W=ge(()=>rr(e(t).map(g=>g.toString()))),y=ge(()=>e(l)||e(d));tr(B,{get options(){return e(W)},label:"Year",get disabled(){return e(y)},get value(){return e(x)},set value(g){m(x,g,!0)}})}var M=X(B,2);Dt(M,{get options(){return e(ee)},label:"Nodes",get value(){return e(_)},set value(W){m(_,W,!0)}}),O(h,$)}}),O(U,r)};fe(q,U=>{e(f)!=null&&U(me)})}O(_e,Y)},buttons:_e=>{var Y=Ie(),pe=le(Y);{var q=me=>{var U=oa(),r=R(U);{let h=ge(()=>e(L)?.resetZoom);ht(r,{get onclick(){return e(h)},children:(b,$)=>{var B=ta();bt(2),O(b,B)},$$slots:{default:!0}})}var c=X(r,2);{let h=ge(()=>e(L)?.toggleShowStructureOnly);ht(c,{get onclick(){return e(h)},children:(b,$)=>{var B=ra(),M=X(le(B),2),W=R(M);S(M),be(y=>we(W,`Show only structure: ${y??""}`),[()=>e(L)?.getShowStructureOnly()?"On":"Off"]),O(b,B)},$$slots:{default:!0}})}var s=X(c,2);{let h=ge(()=>e(L)?.downloadSVG);ht(s,{get onclick(){return e(h)},children:(b,$)=>{var B=aa();bt(2),O(b,B)},$$slots:{default:!0}})}S(U),O(me,U)};fe(pe,me=>{e(L)&&me(q)})}O(_e,Y)},mainContent:_e=>{var Y=Ie(),pe=le(Y);{var q=U=>{ar(U)},me=U=>{var r=Ie(),c=le(r);{var s=b=>{mt(b,{message:"Please select a solution"})},h=b=>{var $=Ie(),B=le($);{var M=y=>{mt(y,{message:"Please select at least one carrier"})},W=y=>{var g=Ie(),oe=le(g);{var N=A=>{mt(A,{message:"Please select at least one node"})},D=A=>{var k=Ie(),j=le(k);{var o=I=>{hr(I,{message:"No data available for the selected filters"})},C=I=>{jt(Kr(I,{get nodes(){return e(ie)},get links(){return e(Be)},get legendItems(){return e(je)}}),H=>m(L,H,!0),()=>e(L))};fe(j,I=>{e(ie).length===0?I(o):I(C,!1)},!0)}O(A,k)};fe(oe,A=>{e(_).length===0?A(N):A(D,!1)},!0)}O(y,g)};fe(B,y=>{e(p).length===0?y(M):y(W,!1)},!0)}O(b,$)};fe(c,b=>{e(f)?b(h,!1):b(s)},!0)}O(U,r)};fe(pe,U=>{e(d)||e(l)?U(q):U(me,!1)})}O(_e,Y)}}),Yt()}export{xa as component};
