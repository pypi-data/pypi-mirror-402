name: Feature Branch CI

on:
  push:
    branches:
      - 'feature/**'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      tests: ${{ steps.filter.outputs.tests }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'src/**/*.py'
              - 'pyproject.toml'
              - 'requirements*.txt'
            tests:
              - 'tests/**/*.py'
              - 'src/**/*.py'

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,serve]"

      - name: Run ruff
        run: |
          ruff check . --output-format=github

      - name: Run black
        run: |
          black --check . --diff

      - name: Run mypy
        run: |
          mypy src/dbt_conceptual --pretty

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,serve]"

      - name: Run tests with coverage
        run: |
          pytest tests/ -v \
            --cov=src/dbt_conceptual \
            --cov-branch \
            --cov-report=xml \
            --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: python-${{ matrix.python-version }}
          fail_ci_if_error: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,serve]"
          pip install safety bandit[toml]

      - name: Run safety check
        continue-on-error: true
        run: |
          safety check --json --output safety-report.json || true

      - name: Run bandit security scan
        run: |
          bandit -r src/dbt_conceptual -f json -o bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
          retention-days: 30

  status:
    name: Feature Branch Status
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: always()
    steps:
      - name: Check status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"

          # Allow skipped (no relevant changes)
          lint_ok=$([[ "${{ needs.lint.result }}" == "success" || "${{ needs.lint.result }}" == "skipped" ]] && echo "true" || echo "false")
          test_ok=$([[ "${{ needs.test.result }}" == "success" || "${{ needs.test.result }}" == "skipped" ]] && echo "true" || echo "false")

          if [[ "$lint_ok" == "false" ]] || [[ "$test_ok" == "false" ]]; then
            echo "❌ Feature branch checks failed"
            exit 1
          fi

          echo "✅ Feature branch checks passed"
