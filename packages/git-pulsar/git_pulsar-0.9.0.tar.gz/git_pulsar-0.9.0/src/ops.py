import os
import shutil
import subprocess
import sys
import textwrap
from pathlib import Path

from .constants import BACKUP_BRANCH
from .git_wrapper import GitRepo


def bootstrap_env() -> None:
    """
    Scaffolds a macOS Python environment: uv, direnv, and VS Code.
    """
    if sys.platform != "darwin":
        print("‚ùå The --env workflow is currently optimized for macOS.")
        return

    cwd = Path.cwd()
    print(f"‚ö° Setting up dev environment in {cwd.name}...")

    # 1. Dependency Check
    missing = []
    if not shutil.which("uv"):
        missing.append("uv")
    if not shutil.which("direnv"):
        missing.append("direnv")

    if missing:
        print(f"‚ùå Missing tools: {', '.join(missing)}")
        print("   Please run:")
        print(f"     brew install {' '.join(missing)}")
        sys.exit(1)

    # 2. Project Scaffold (uv)
    if not (cwd / "pyproject.toml").exists():
        print("üì¶ Initializing Python project...")
        # 'uv init' is safe; it creates a standard pyproject.toml
        subprocess.run(["uv", "init", "--no-workspace", "--python", "3.12"], check=True)
    else:
        print("   Existing pyproject.toml found. Skipping init.")

    # 3. Direnv Configuration
    envrc_path = cwd / ".envrc"
    if not envrc_path.exists():
        print("üîå Creating .envrc...")
        envrc_content = textwrap.dedent("""\
            # Auto-generated by git-pulsar
            if [ ! -d ".venv" ]; then
                echo "Creating virtual environment..."
                uv sync
            fi
            source .venv/bin/activate
            
            source_env_if_exists .envrc.local
        """)
        with open(envrc_path, "w") as f:
            f.write(envrc_content)

        subprocess.run(["direnv", "allow"], check=True)
    else:
        print("   .envrc exists. Skipping.")

    # 4. VS Code Settings
    vscode_dir = cwd / ".vscode"
    settings_path = vscode_dir / "settings.json"

    if not settings_path.exists():
        vscode_dir.mkdir(exist_ok=True)
        print("‚öôÔ∏è  Configuring VS Code...")
        settings_content = textwrap.dedent("""\
            {
                "python.defaultInterpreterPath": ".venv/bin/python",
                "python.terminal.activateEnvironment": true,
                "files.exclude": {
                    "**/__pycache__": true,
                    "**/.ipynb_checkpoints": true,
                    "**/.DS_Store": true,
                    "**/.venv": true
                },
                "search.exclude": {
                    "**/.venv": true
                }
            }
        """)
        with open(settings_path, "w") as f:
            f.write(settings_content)

    print("\n‚úÖ Environment ready.")

    if "DIRENV_DIR" not in os.environ:
        print("\nüëâ Action Required: Enable direnv")
        print("   1. Open your config:")
        print("      code ~/.zshrc  (or nano ~/.zshrc)")
        print("   2. Add this line to the bottom:")
        print('      eval "$(direnv hook zsh)"')
        print("   3. Reload:")
        print("      source ~/.zshrc")


def restore_file(path_str: str, force: bool = False) -> None:
    repo = GitRepo(Path.cwd())
    path = Path(path_str)

    # 1. Safety Check: Is the file dirty?
    if not force and path.exists():
        # Check specifically for this file
        if repo.status_porcelain(path_str):
            print(f"‚ùå Aborted: '{path_str}' has uncommitted changes.")
            print("   Use --force to overwrite them.")
            sys.exit(1)

    # 2. Restore
    print(f"üöë Restoring '{path_str}' from {BACKUP_BRANCH}...")
    try:
        repo.checkout(BACKUP_BRANCH, file=path_str)
        print("‚úÖ Restore complete.")
    except Exception as e:
        print(f"‚ùå Failed to restore: {e}")
        sys.exit(1)


def finalize_work() -> None:
    print("üöÄ Finalizing work...")
    repo = GitRepo(Path.cwd())

    # 1. Check for uncommitted changes
    if repo.status_porcelain():
        print("‚ö†Ô∏è  You have uncommitted changes.")
        print("   Please commit or stash them before finalizing.")
        sys.exit(1)

    try:
        # 2. Checkout Main
        print("-> Switching to main...")
        repo.checkout("main")

        # 3. Merge Squash
        print(f"-> Squashing {BACKUP_BRANCH}...")
        repo.merge_squash(BACKUP_BRANCH)

        # 4. Commit (Interactive)
        print("-> Committing (opens editor)...")
        repo.commit_interactive()

        # 5. Reset Backup Branch
        print(f"-> Resetting {BACKUP_BRANCH} to main...")
        repo.branch_reset(BACKUP_BRANCH, "main")

        print("\n‚úÖ Work finalized!")
        print(
            f"   You are now on 'main'. "
            f"Run 'git-pulsar' to switch back to {BACKUP_BRANCH}."
        )

    except Exception as e:
        print(f"\n‚ùå Error during finalize: {e}")
        sys.exit(1)
