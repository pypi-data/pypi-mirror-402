"""Pytest fixtures for malware_detector tests."""

from pathlib import Path
from typing import Any

import pytest

from malware_detector import BaseDetector, BaseDetectorConfig


@pytest.fixture
def tmp_config(tmp_path: Path) -> BaseDetectorConfig:
    """Create a config using temporary directories.

    Args:
        tmp_path: Pytest temporary path fixture.

    Returns:
        BaseDetectorConfig with paths set to temporary directories.
    """
    return BaseDetectorConfig.from_dict(
        {
            "data": {
                "train": str(tmp_path / "data" / "train"),
                "test": str(tmp_path / "data" / "test"),
                "predict": str(tmp_path / "data" / "predict"),
            },
            "output": {
                "model": str(tmp_path / "output" / "model"),
                "feature": str(tmp_path / "output" / "features"),
                "prediction": str(tmp_path / "output" / "predictions.json"),
                "log": str(tmp_path / "output" / "logs"),
            },
        }
    )


@pytest.fixture
def sample_detector_class() -> type[BaseDetector]:
    """Create a minimal detector class for testing.

    Returns:
        A concrete BaseDetector subclass.
    """

    class SampleDetector(BaseDetector):
        """Sample detector implementation for testing."""

        def train(self) -> Path:
            """Train the detector model."""
            self.ensure_directory_exists(self.config.output.model)
            return self.config.output.model

        def evaluate(self) -> dict[str, Any]:
            """Evaluate the detector on test data."""
            return {"accuracy": 0.95, "precision": 0.92}

        def predict(self) -> Path:
            """Run prediction on input data."""
            self.ensure_directory_exists(self.config.output.prediction)
            return self.config.output.prediction

    return SampleDetector


@pytest.fixture
def sample_detector(
    sample_detector_class: type[BaseDetector],
    tmp_config: BaseDetectorConfig,
) -> BaseDetector:
    """Create a configured detector instance for testing.

    Args:
        sample_detector_class: The sample detector class fixture.
        tmp_config: The temporary config fixture.

    Returns:
        A configured detector instance.
    """
    return sample_detector_class(tmp_config)
