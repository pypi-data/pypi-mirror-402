"""Tests for CLI module."""

from pathlib import Path
from typing import Any

from typer.testing import CliRunner

from malware_detector.cli import create_cli
from malware_detector.detector import BaseDetector

runner = CliRunner()


class MockDetector(BaseDetector):
    """Mock detector for CLI testing."""

    def train(self) -> Path:
        """Train the detector model."""
        return self.config.output.model

    def evaluate(self) -> dict[str, Any]:
        """Evaluate the detector on test data."""
        return {"accuracy": 0.95, "f1_score": 0.93}

    def predict(self) -> Path:
        """Run prediction on input data."""
        return self.config.output.prediction


class TestCreateCli:
    """Tests for create_cli function."""

    def test_cli_creation(self) -> None:
        """Test that CLI is created successfully."""
        app = create_cli(MockDetector)
        assert app is not None

    def test_cli_help(self) -> None:
        """Test that --help works."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["--help"])
        assert result.exit_code == 0
        assert "MockDetector" in result.stdout or "CLI" in result.stdout

    def test_cli_init_command(self, tmp_path: Path) -> None:
        """Test init command creates config file."""
        app = create_cli(MockDetector)
        config_file = tmp_path / "test_config.json"
        result = runner.invoke(app, ["init", "--output", str(config_file)])
        assert result.exit_code == 0
        assert config_file.exists()

    def test_cli_init_command_default(self, tmp_path: Path, monkeypatch) -> None:
        """Test init command with default output path."""
        monkeypatch.chdir(tmp_path)
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["init"])
        assert result.exit_code == 0
        assert (tmp_path / "config.json").exists()

    def test_cli_train_command_help(self) -> None:
        """Test train command help."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["train", "--help"])
        assert result.exit_code == 0
        assert "--config" in result.stdout or "-c" in result.stdout

    def test_cli_train_command(self) -> None:
        """Test train command execution."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["train"])
        assert result.exit_code == 0
        assert "Model saved to" in result.stdout

    def test_cli_evaluate_command_help(self) -> None:
        """Test evaluate command help."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["evaluate", "--help"])
        assert result.exit_code == 0
        assert "--config" in result.stdout or "-c" in result.stdout

    def test_cli_evaluate_command(self) -> None:
        """Test evaluate command execution."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["evaluate"])
        assert result.exit_code == 0
        assert "Evaluation Results:" in result.stdout
        assert "accuracy" in result.stdout

    def test_cli_predict_command_help(self) -> None:
        """Test predict command help."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["predict", "--help"])
        assert result.exit_code == 0
        assert "--config" in result.stdout or "-c" in result.stdout

    def test_cli_predict_command(self) -> None:
        """Test predict command execution."""
        app = create_cli(MockDetector)
        result = runner.invoke(app, ["predict"])
        assert result.exit_code == 0
        assert "Predictions saved to" in result.stdout

    def test_cli_train_with_config_file(self, tmp_path: Path) -> None:
        """Test train command with config file."""
        app = create_cli(MockDetector)
        config_file = tmp_path / "config.json"
        config_file.write_text('{"config_version": "1.0"}')
        result = runner.invoke(app, ["train", "--config", str(config_file)])
        assert result.exit_code == 0

    def test_cli_train_with_log_options(self) -> None:
        """Test train command with logging options."""
        app = create_cli(MockDetector)
        result = runner.invoke(
            app, ["train", "--log-level", "DEBUG", "--log-format", "json"]
        )
        assert result.exit_code == 0
