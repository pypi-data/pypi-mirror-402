"""Tests for detector module."""

from pathlib import Path
from typing import Any

import pytest

from malware_detector.config import BaseDetectorConfig
from malware_detector.detector import BaseDetector


class SampleDetector(BaseDetector):
    """Sample detector implementation for testing."""

    def train(self) -> Path:
        """Train the detector model."""
        return self.config.output.model

    def evaluate(self) -> dict[str, Any]:
        """Evaluate the detector on test data."""
        return {"accuracy": 0.95, "precision": 0.92}

    def predict(self) -> Path:
        """Run prediction on input data."""
        return self.config.output.prediction


class TestBaseDetector:
    """Tests for BaseDetector."""

    def test_abstract_methods_required(self) -> None:
        """Test that BaseDetector cannot be instantiated without implementing abstract methods."""
        with pytest.raises(TypeError, match="abstract"):
            BaseDetector()  # type: ignore[abstract]

    def test_sample_detector_instantiation(self) -> None:
        """Test that concrete detector can be instantiated."""
        detector = SampleDetector()
        assert detector.config is not None
        assert detector.logger is not None

    def test_sample_detector_with_custom_config(self) -> None:
        """Test detector instantiation with custom config."""
        config = BaseDetectorConfig()
        detector = SampleDetector(config)
        assert detector.config is config

    def test_train_method(self) -> None:
        """Test train method returns model path."""
        detector = SampleDetector()
        result = detector.train()
        assert result == detector.config.output.model

    def test_evaluate_method(self) -> None:
        """Test evaluate method returns metrics dict."""
        detector = SampleDetector()
        result = detector.evaluate()
        assert isinstance(result, dict)
        assert "accuracy" in result
        assert result["accuracy"] == 0.95

    def test_predict_method(self) -> None:
        """Test predict method returns prediction path."""
        detector = SampleDetector()
        result = detector.predict()
        assert result == detector.config.output.prediction

    def test_ensure_directory_exists_for_file(self, tmp_path: Path) -> None:
        """Test ensure_directory_exists creates parent directory for file path."""
        detector = SampleDetector()
        file_path = tmp_path / "subdir" / "output.json"
        detector.ensure_directory_exists(file_path)
        assert (tmp_path / "subdir").exists()
        assert (tmp_path / "subdir").is_dir()

    def test_ensure_directory_exists_for_directory(self, tmp_path: Path) -> None:
        """Test ensure_directory_exists creates directory for path without suffix."""
        detector = SampleDetector()
        dir_path = tmp_path / "new_directory"
        detector.ensure_directory_exists(dir_path)
        assert dir_path.exists()
        assert dir_path.is_dir()

    def test_create_cli(self) -> None:
        """Test create_cli returns a Typer application."""
        app = SampleDetector.create_cli()
        assert app is not None

    def test_config_class_attribute(self) -> None:
        """Test that config_class is properly set."""
        assert SampleDetector.config_class is BaseDetectorConfig

    def test_custom_config_class(self) -> None:
        """Test detector with custom config class."""

        class CustomConfig(BaseDetectorConfig):
            custom_param: int = 42

        class CustomDetector(BaseDetector):
            config_class = CustomConfig

            def train(self) -> Path:
                return Path("./model")

            def evaluate(self) -> dict[str, Any]:
                return {}

            def predict(self) -> Path:
                return Path("./predictions.json")

        detector = CustomDetector()
        assert isinstance(detector.config, CustomConfig)
        assert detector.config.custom_param == 42  # type: ignore[attr-defined]
