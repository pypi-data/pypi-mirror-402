"""Configuration system using Pydantic v2 and pydantic-settings.

This module provides a hierarchical configuration system that supports:
- Default values
- TOML configuration files
- Environment variables
- Programmatic overrides

Configuration priority (later overrides earlier):
    1. Default values (defined in models)
    2. Config file (config.toml)
    3. Environment variables (MALWARE_DETECTOR_*)
    4. Direct assignment

Typical usage:
    from malware_detector.config import BaseDetectorConfig

    # Load with defaults
    config = BaseDetectorConfig()

    # Load from file
    config = BaseDetectorConfig.load(Path("config.toml"))

    # Subclass for custom configs
    class MyConfig(BaseDetectorConfig):
        batch_size: int = 32
"""

from pathlib import Path
from typing import Self

from pydantic import BaseModel, ConfigDict
from pydantic_settings import BaseSettings, SettingsConfigDict


class PathConfig(BaseModel):
    """Path configuration for input/output files.

    Attributes:
        input: Path to input dataset directory or file.
        output: Path to output prediction file.
        config: Path to configuration file.
    """

    model_config = ConfigDict(extra="allow")

    input: Path = Path("./Dataset/program")
    output: Path = Path("./Predict/predict.json")
    config: Path = Path("./config.toml")


class FolderConfig(BaseModel):
    """Folder configuration for data storage directories.

    Attributes:
        dataset: Directory for raw dataset files.
        feature: Directory for extracted features.
        vectorize: Directory for vectorized data.
        model: Directory for trained models.
        predict: Directory for prediction outputs.
    """

    model_config = ConfigDict(extra="allow")

    dataset: Path = Path("./Dataset/")
    feature: Path = Path("./Feature/")
    vectorize: Path = Path("./Vectorize/")
    model: Path = Path("./Model/")
    predict: Path = Path("./Predict/")

    @property
    def all_folders(self) -> list[Path]:
        """Return all folder paths defined in this config.

        Returns:
            List of all Path-typed field values.
        """
        return [
            getattr(self, name)
            for name, field_info in type(self).model_fields.items()
            if field_info.annotation is Path
        ]


class BaseDetectorConfig(BaseSettings):
    """Base configuration for malware detectors.

    This class can be subclassed to add detector-specific configuration
    options. All fields support loading from environment variables with
    the MALWARE_DETECTOR_ prefix.

    Attributes:
        path: Path configuration for input/output files.
        folder: Folder configuration for data directories.
        classify: Whether to perform family classification (vs detection).

    Example:
        class MyDetectorConfig(BaseDetectorConfig):
            model_config = SettingsConfigDict(
                env_prefix="MY_DETECTOR_",
                toml_file="my_config.toml",
            )
            batch_size: int = 32
    """

    model_config = SettingsConfigDict(
        env_prefix="MALWARE_DETECTOR_",
        env_nested_delimiter="__",
        extra="allow",
    )

    path: PathConfig = PathConfig()
    folder: FolderConfig = FolderConfig()
    classify: bool = False

    def save(self, path: Path | None = None) -> None:
        """Save configuration to a JSON file.

        Args:
            path: Output file path. Defaults to self.path.config.
        """
        save_path = path or self.path.config
        save_path.write_text(self.model_dump_json(indent=2))

    @classmethod
    def load(cls, path: Path) -> Self:
        """Load configuration from a JSON file.

        Args:
            path: Path to the configuration file.

        Returns:
            Loaded configuration instance.
        """
        return cls.model_validate_json(path.read_text())
