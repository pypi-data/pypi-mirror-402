"""Tests for config module."""

from pathlib import Path

import pytest
from pydantic import ValidationError

from malware_detector.config import (
    BaseDetectorConfig,
    DataConfig,
    LogConfig,
    OutputConfig,
)
from malware_detector.constants import (
    DEFAULT_DATA_PATH_PREDICT,
    DEFAULT_DATA_PATH_TEST,
    DEFAULT_DATA_PATH_TRAIN,
    DEFAULT_LOG_FORMAT,
    DEFAULT_LOG_LEVEL,
    DEFAULT_OUTPUT_PATH_FEATURE,
    DEFAULT_OUTPUT_PATH_LOG,
    DEFAULT_OUTPUT_PATH_MODEL,
    DEFAULT_OUTPUT_PATH_PREDICTION,
)


class TestDataConfig:
    """Tests for DataConfig."""

    def test_default_values(self) -> None:
        """Test default data path values."""
        config = DataConfig()
        assert config.train == DEFAULT_DATA_PATH_TRAIN
        assert config.test == DEFAULT_DATA_PATH_TEST
        assert config.predict == DEFAULT_DATA_PATH_PREDICT

    def test_custom_values(self) -> None:
        """Test custom data path values."""
        config = DataConfig(train=Path("/custom/train"))
        assert config.train == Path("/custom/train")

    def test_frozen(self) -> None:
        """Test that DataConfig is immutable."""
        config = DataConfig()
        with pytest.raises(ValidationError):
            config.train = Path("/new/path")


class TestOutputConfig:
    """Tests for OutputConfig."""

    def test_default_values(self) -> None:
        """Test default output path values."""
        config = OutputConfig()
        assert config.model == DEFAULT_OUTPUT_PATH_MODEL
        assert config.feature == DEFAULT_OUTPUT_PATH_FEATURE
        assert config.prediction == DEFAULT_OUTPUT_PATH_PREDICTION
        assert config.log == DEFAULT_OUTPUT_PATH_LOG

    def test_frozen(self) -> None:
        """Test that OutputConfig is immutable."""
        config = OutputConfig()
        with pytest.raises(ValidationError):
            config.model = Path("/new/path")


class TestLogConfig:
    """Tests for LogConfig."""

    def test_default_values(self) -> None:
        """Test default log config values."""
        config = LogConfig()
        assert config.level == DEFAULT_LOG_LEVEL
        assert config.format == DEFAULT_LOG_FORMAT

    def test_frozen(self) -> None:
        """Test that LogConfig is immutable."""
        config = LogConfig()
        with pytest.raises(ValidationError):
            config.level = "DEBUG"


class TestBaseDetectorConfig:
    """Tests for BaseDetectorConfig."""

    def test_default_values(self) -> None:
        """Test default config values."""
        config = BaseDetectorConfig()
        assert config.config_version == "1.0"
        assert isinstance(config.data, DataConfig)
        assert isinstance(config.output, OutputConfig)
        assert isinstance(config.log, LogConfig)

    def test_frozen(self) -> None:
        """Test that BaseDetectorConfig is immutable."""
        config = BaseDetectorConfig()
        with pytest.raises(ValidationError):
            config.config_version = "2.0"

    def test_save_and_from_file_json(self, tmp_path: Path) -> None:
        """Test config serialization and deserialization with JSON."""
        config = BaseDetectorConfig()
        config_file = tmp_path / "test_config.json"
        config.save(config_file)

        loaded = BaseDetectorConfig.from_file(config_file)
        assert loaded.config_version == config.config_version
        assert loaded.data.train == config.data.train

    def test_from_file_toml(self, tmp_path: Path) -> None:
        """Test config loading from TOML file."""
        toml_content = """
config_version = "1.0"

[data]
train = "./custom/train"
test = "./custom/test"
predict = "./custom/predict"

[output]
model = "./custom/model"
feature = "./custom/features"
prediction = "./custom/predictions.json"
log = "./custom/logs"

[log]
level = "DEBUG"
format = "json"
"""
        config_file = tmp_path / "test_config.toml"
        config_file.write_text(toml_content)

        loaded = BaseDetectorConfig.from_file(config_file)
        assert loaded.data.train == Path("./custom/train")
        assert loaded.log.level == "DEBUG"
        assert loaded.log.format == "json"

    def test_from_file_unsupported_format(self, tmp_path: Path) -> None:
        """Test that unsupported file format raises ValueError."""
        config_file = tmp_path / "test_config.yaml"
        config_file.write_text("key: value")

        with pytest.raises(ValueError, match="Unsupported config format"):
            BaseDetectorConfig.from_file(config_file)

    def test_from_env(self) -> None:
        """Test config loading from environment."""
        config = BaseDetectorConfig.from_env()
        assert config.config_version == "1.0"

    def test_from_dict(self) -> None:
        """Test config loading from dictionary."""
        data = {
            "config_version": "1.0",
            "data": {"train": "./my/train"},
            "log": {"level": "DEBUG"},
        }
        config = BaseDetectorConfig.from_dict(data)
        assert config.data.train == Path("./my/train")
        assert config.log.level == "DEBUG"

    def test_version_validation(self) -> None:
        """Test that invalid config version raises error."""
        with pytest.raises(ValueError, match="Unsupported config version"):
            BaseDetectorConfig(config_version="999.0")

    def test_extra_fields_allowed(self) -> None:
        """Test that extra fields are allowed."""
        config = BaseDetectorConfig(custom_field="value")
        assert config.custom_field == "value"  # type: ignore[attr-defined]


def test_public_api_imports() -> None:
    """Test that all public API is importable from package root."""
    from malware_detector import (
        BaseDetector,
        BaseDetectorConfig,
        DataConfig,
        DetectorError,
        LogConfig,
        OutputConfig,
        configure_logging,
        create_cli,
        get_logger,
    )

    assert BaseDetector is not None
    assert BaseDetectorConfig is not None
    assert DataConfig is not None
    assert OutputConfig is not None
    assert LogConfig is not None
    assert DetectorError is not None
    assert configure_logging is not None
    assert create_cli is not None
    assert get_logger is not None
