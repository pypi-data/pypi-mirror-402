"""Tests for detector module."""

from pathlib import Path

import pytest

from malware_detector.config import BaseDetectorConfig
from malware_detector.detector import BaseDetector


class SampleDetector(BaseDetector):
    """Sample detector implementation for testing."""

    def stage_extract(self) -> str:
        return "extracted"

    def stage_vectorize(self) -> str:
        return "vectorized"

    def stage_train(self) -> str:
        return "trained"

    def stage_predict(self) -> str:
        return "predicted"


class TestBaseDetector:
    """Tests for BaseDetector."""

    def test_base_detector_run_without_stages_raises(self) -> None:
        """Test that BaseDetector.run raises when no stages implemented."""

        class EmptyDetector(BaseDetector):
            pass

        detector = EmptyDetector()
        with pytest.raises(NotImplementedError, match="extract"):
            detector.run()

    def test_sample_detector_instantiation(self) -> None:
        """Test that concrete detector can be instantiated."""
        detector = SampleDetector()
        assert detector.config is not None

    def test_run_all_stages(self) -> None:
        """Test running all default stages."""
        detector = SampleDetector()
        results = detector.run()

        assert results["extract"] == "extracted"
        assert results["vectorize"] == "vectorized"
        assert results["train"] == "trained"
        assert results["predict"] == "predicted"

    def test_run_partial_stages(self) -> None:
        """Test running only selected stages."""
        detector = SampleDetector()
        results = detector.run(stages=["extract", "vectorize"])

        assert list(results.keys()) == ["extract", "vectorize"]
        assert "train" not in results

    def test_run_unknown_stage_raises(self) -> None:
        """Test that unknown stage raises NotImplementedError."""
        detector = SampleDetector()
        with pytest.raises(NotImplementedError, match="unknown"):
            detector.run(stages=["unknown"])

    def test_setup_creates_folders(self, tmp_path: Path) -> None:
        """Test that setup creates all configured folders."""
        config = BaseDetectorConfig()
        config.folder.dataset = tmp_path / "dataset"
        config.folder.feature = tmp_path / "feature"
        config.folder.vectorize = tmp_path / "vectorize"
        config.folder.model = tmp_path / "model"
        config.folder.predict = tmp_path / "predict"

        detector = SampleDetector(config)
        detector.setup()

        assert (tmp_path / "dataset").exists()
        assert (tmp_path / "feature").exists()

    def test_custom_pipeline(self) -> None:
        """Test detector with custom pipeline stages."""

        class CustomDetector(BaseDetector):
            default_stages = ["load", "process"]

            def stage_load(self) -> str:
                return "loaded"

            def stage_process(self) -> str:
                return "processed"

        detector = CustomDetector()
        results = detector.run()

        assert list(results.keys()) == ["load", "process"]
