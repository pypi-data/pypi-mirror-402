"""CLI factory for malware detectors.

This module provides factory functions to create CLI applications for
any BaseDetector subclass. The generated CLI includes commands for
train, evaluate, predict, and init operations.

Typical usage:
    from malware_detector import create_cli
    from my_detector import MyDetector

    app = create_cli(MyDetector)

    # Add custom commands
    @app.command()
    def custom():
        ...

    if __name__ == "__main__":
        app()
"""

from pathlib import Path
from typing import Annotated

import typer

from .config import BaseDetectorConfig
from .detector import BaseDetector
from .logging import configure_logging


def build_cli(
    detector_class: type[BaseDetector],
    config_class: type[BaseDetectorConfig],
) -> typer.Typer:
    """Build CLI application for a detector class.

    Args:
        detector_class: The detector class to create CLI for.
        config_class: Configuration class to use.

    Returns:
        Configured Typer application.
    """
    app = typer.Typer(help=f"CLI for {detector_class.__name__}")

    @app.command()
    def init(
        output: Annotated[
            Path,
            typer.Option("--output", "-o", help="Output config file path"),
        ] = Path("config.json"),
    ) -> None:
        """Generate a default configuration file."""
        config = config_class()
        config.save(output)
        typer.echo(f"Configuration saved to {output}")

    @app.command()
    def train(
        config: Annotated[
            Path | None,
            typer.Option("--config", "-c", help="Path to config file"),
        ] = None,
        log_level: Annotated[
            str,
            typer.Option("--log-level", "-l", help="Logging level"),
        ] = "INFO",
        log_format: Annotated[
            str,
            typer.Option("--log-format", help="Logging format"),
        ] = "console",
    ) -> None:
        """Train the detector model."""
        configure_logging(level=log_level, format=log_format)
        cfg = config_class.from_file(config) if config else config_class()
        detector = detector_class(cfg)
        model_path = detector.train()
        typer.echo(f"Model saved to {model_path}")

    @app.command()
    def evaluate(
        config: Annotated[
            Path | None,
            typer.Option("--config", "-c", help="Path to config file"),
        ] = None,
        log_level: Annotated[
            str,
            typer.Option("--log-level", "-l", help="Logging level"),
        ] = "INFO",
        log_format: Annotated[
            str,
            typer.Option("--log-format", help="Logging format"),
        ] = "console",
    ) -> None:
        """Evaluate the detector on test data."""
        configure_logging(level=log_level, format=log_format)
        cfg = config_class.from_file(config) if config else config_class()
        detector = detector_class(cfg)
        metrics = detector.evaluate()
        typer.echo("Evaluation Results:")
        for key, value in metrics.items():
            typer.echo(f"  {key}: {value}")

    @app.command()
    def predict(
        config: Annotated[
            Path | None,
            typer.Option("--config", "-c", help="Path to config file"),
        ] = None,
        log_level: Annotated[
            str,
            typer.Option("--log-level", "-l", help="Logging level"),
        ] = "INFO",
        log_format: Annotated[
            str,
            typer.Option("--log-format", help="Logging format"),
        ] = "console",
    ) -> None:
        """Run prediction on input data."""
        configure_logging(level=log_level, format=log_format)
        cfg = config_class.from_file(config) if config else config_class()
        detector = detector_class(cfg)
        output_path = detector.predict()
        typer.echo(f"Predictions saved to {output_path}")

    return app


def create_cli(
    detector_class: type[BaseDetector],
    config_class: type[BaseDetectorConfig] | None = None,
) -> typer.Typer:
    """Create a CLI application for a detector class.

    This is a convenience wrapper around build_cli().

    Args:
        detector_class: The detector class to create CLI for.
        config_class: Configuration class. If None, uses detector_class.config_class.

    Returns:
        Configured Typer application.
    """
    cfg_class = config_class or detector_class.config_class
    return build_cli(detector_class, cfg_class)
