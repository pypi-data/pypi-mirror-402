{% set cf = ctx.currency_format %}
<div class="budget-sidebar-summary">
  <div class="font-bold">
    <h1>Available balance</h1>
    <div>{{ cf(budget_sidebar.available) }}</div>
  </div>
  <div>
    <div>Cash leftover</div>
    <div>{{ cf(budget_sidebar.leftover) }}</div>
  </div>
  <div>
    <div>Assigned this month</div>
    <div>{{ cf(budget_sidebar.assigned) }}</div>
  </div>
  {% if budget_sidebar.future_assigned is not none %}
    <div>
      <div>Assigned in future</div>
      <div>{{ cf(budget_sidebar.future_assigned) }}</div>
    </div>
  {% endif %}
  <div>
    <div>Activity this month</div>
    <div>{{ cf(budget_sidebar.activity) }}</div>
  </div>
  <input
    id="budget-sidebar-uri"
    name="sidebar"
    value="{{ budget_sidebar.uri or '' }}"
    hidden
  />
</div>
<div
  class="budget-sidebar-target"
  hx-target="#dialog"
  hx-swap="innerHTML show:#dialog:top"
  hx-push-url="#dialog"
>
  {% if budget_sidebar.uri is none %}
    <h1 class="font-bold">Targets</h1>
    <div>
      <h2>Total to go</h2>
      <div>{{ cf(budget_sidebar.to_go) }}</div>
    </div>
    <label class="input-outlined">
      <select class="w-full" autocomplete="off">
        <option value="" selected disabled hidden></option>
        {% for uri, name in budget_sidebar.no_target.items() %}
          <option
            value="{{ uri }}"
            hx-get="{{ url_for('budgeting.target', uri=uri) }}"
            hx-disabled-elt="this"
          >
            {{ name }}
          </option>
        {% endfor %}
      </select>
      <div>
        <div>New target</div>
      </div>
    </label>
  {% else %}
    {% if budget_sidebar.target %}
      {% set target = budget_sidebar.target %}
      <div class="font-bold">
        <h1>Target</h1>
        <button
          class="btn-text btn-sq"
          hx-get="{{ url_for('budgeting.sidebar', month=ctx.month) }}"
          hx-disabled-elt="this"
          hx-target="#budget-sidebar"
          hx-swap="innerHTML"
        >
          <icon>close</icon>
        </button>
      </div>
      <div>{{ budget_sidebar.name }}</div>
      <hr />
      {% set money_suffix = ("/week" if target.period == "WEEK") %}
      {% if target.type == "BALANCE" %}
        {% set money_prefix = "Have" %}
      {% elif target.type == "REFILL" %}
        {% set money_prefix = "Refill up to" %}
      {% else %}
        {% set money_prefix = "Assign" %}
      {% endif %}
      <h2 class="font-bold">
        {{ money_prefix }} {{ cf(target.target) }}{{ money_suffix }}
      </h2>
      <div>By {{ target.next_due_date }}</div>
      <hr />
      <div class="relative my-1 w-full">
        <canvas id="budget-sidebar-canvas" hx-preserve></canvas>
      </div>
      {% if target.total_to_go == 0 %}
        <div class="status-success w-full">
          <span class="grow text-center">Target is achieved</span>
        </div>
      {% elif target.on_track %}
        <div class="status-success w-full">
          <span class="grow text-center">On track to achieve target</span>
        </div>
      {% else %}
        <div class="status-tertiary w-full">
          <span class="grow text-center">
            Assign {{ cf(target.to_go) }} more to meet target
          </span>
        </div>
      {% endif %}
      {% if target.type == "BALANCE" %}
        {% set label_target = "Target Balance" %}
        {% set label_assigned = "Current Balance" %}
      {% else %}
        {% set label_target = "Amount to assign" %}
        {% set label_assigned = "Assigned so far" %}
      {% endif %}
      <div>
        <div>{{ label_target }}</div>
        <div>{{ cf(target.total_target) }}</div>
      </div>
      <div>
        <div>{{ label_assigned }}</div>
        <div>{{ cf(target.total_assigned) }}</div>
      </div>
      <hr />
      <div>
        <div>To go</div>
        <div>{{ cf(target.total_to_go) }}</div>
      </div>
      <button
        class="btn-tonal mx-auto"
        hx-get="{{ url_for('budgeting.target', uri=budget_sidebar.uri) }}"
        hx-disabled-elt="this"
      >
        <icon>edit</icon>
        Edit Target
      </button>
      <script>
        onLoad(() => {
          // prettier-ignore
          budgeting.update(
            Number("{{ target.total_assigned }}"),
            Number("{{ target.total_target }}"),
            Number("{{ target.on_track | lower }}"),
            JSON.parse('{{ ctx.currency_format._asdict() | tojson(precision=4) }}'),
          );
        });
      </script>
    {% else %}
      <div class="font-bold">
        <div>Target</div>
        <button
          class="btn-text btn-sq"
          hx-get="{{ url_for('budgeting.sidebar', month=ctx.month) }}"
          hx-disabled-elt="this"
          hx-target="#budget-sidebar"
          hx-swap="innerHTML"
        >
          <icon>close</icon>
        </button>
      </div>
      <div class="font-bold">How much is needed for</div>
      <div>{{ budget_sidebar["name"] }}?</div>
      <div class="text-on-surface-variant w-full text-center">
        With a target, nummus can guide you to stay on track over time.
      </div>
      <button
        class="btn-tonal mx-auto"
        hx-get="{{ url_for('budgeting.target', uri=budget_sidebar.uri) }}"
        hx-disabled-elt="this"
      >
        <icon>add</icon>
        Create Target
      </button>
    {% endif %}
  {% endif %}
</div>
