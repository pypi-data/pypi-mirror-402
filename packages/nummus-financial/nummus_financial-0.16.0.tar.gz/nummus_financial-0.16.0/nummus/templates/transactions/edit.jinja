{% if txn.uri %}
  {% with headline="Edit transaction", save_url=url_for("transactions.transaction", uri=txn.uri), include_error=True %}
    {% include "shared/dialog-headline.jinja" %}
  {% endwith %}
{% else %}
  {% with headline="New transaction", save_url=url_for("transactions.new"), save_method="post", include_error=True %}
    {% include "shared/dialog-headline.jinja" %}
  {% endwith %}
{% endif %}
{% set is_split = (txn.splits | length) > 1 %}
{% if is_split %}
  {% set form_class = "full-screen grid-cols-2 md:grid-cols-4 md:w-3xl" %}
  {% set parent_class = "md:col-span-2" %}
  {% set split_class = "" %}
{% else %}
  {% set form_class = "grid-cols-1 md:grid-cols-2 md:w-lg" %}
  {% set parent_class = "" %}
  {% set split_class = "md:col-span-2" %}
{% endif %}
{% set cf=txn.currency_format %}
<form class="{{ form_class }} grid gap-x-2 gap-y-1" onsubmit="return false">
  <datalist id="payees">
    {% for item in txn.payees %}
      <option value="{{ item | e }}">{{ item }}</option>
    {% endfor %}
  </datalist>
  <datalist id="labels">
    {% for item in txn.labels %}
      <option value="{{ item | e }}">{{ item }}</option>
    {% endfor %}
  </datalist>
  {% if txn.cleared %}
    <div class="{{ parent_class }} flex items-center gap-1">
      <icon>account_balance</icon>Account: {{ txn.account }}
    </div>
    <div class="{{ parent_class }} flex items-center gap-1">
      <icon>attach_money</icon>Amount: {{ cf(txn.amount) }}
    </div>
    <input name="account" type="hidden" value="{{ txn.account_uri }}" />
    <input name="amount" type="hidden" value="{{ txn.amount }}" />
  {% else %}
    <label
      class="input-outlined input-bg-surface-container-high {{ parent_class }}"
    >
      <select name="account" required autocomplete="off">
        <option
          value=""
          {% if not txn.account_uri %}selected{% endif %}
          disabled
          hidden
        ></option>
        {% for value, label, disabled in txn.accounts %}
          <option
            value="{{ value }}"
            {% if value == txn.account_uri %}selected{% endif %}
            {% if disabled %}disabled hidden{% endif %}
          >
            {{ label }}
          </option>
        {% endfor %}
      </select>
      <icon>account_balance</icon>
      <div>
        <div>Account</div>
      </div>
    </label>
    <label
      class="input-outlined input-bg-surface-container-high {{ parent_class }}"
    >
      <input
        name="amount"
        required
        value="{{ txn.amount | input_value }}"
        placeholder=""
        autocomplete="off"
        enterkeyhint="next"
        inputmode="tel"
        hx-get="{{ url_for('transactions.validation') }}"
        hx-trigger="input delay:200ms"
        hx-target="next error"
        hx-include="this{{ ', #dialog [name=split-amount], #dialog [name=account]' if is_split }}"
      />
      <icon>attach_money</icon>
      <div>
        <div>Amount</div>
      </div>
      <div>
        <error></error>
        <span>Inflow (+)/Outflow(-)</span>
      </div>
    </label>
  {% endif %}
  <label
    class="input-outlined input-bg-surface-container-high {{ parent_class }}"
    title="Original statement: {{ txn.statement }}"
  >
    <input
      name="payee"
      required
      value="{{ txn.payee or '' }}"
      list="payees"
      placeholder=""
      autocomplete="off"
      enterkeyhint="next"
      hx-get="{{ url_for('transactions.validation') }}"
      hx-trigger="input delay:200ms"
      hx-target="next error"
      hx-include="this"
    />
    <icon>store</icon>
    <div>
      <div>Payee/Payor</div>
    </div>
    <div>
      <error></error>
      <span>Statement: {{ txn.statement }}</span>
    </div>
  </label>
  <label
    class="input-outlined input-bg-surface-container-high {{ parent_class }}"
  >
    <input
      name="date"
      required
      type="date"
      value="{{ txn.date or '' }}"
      max="{{ txn.date_max }}"
      placeholder=""
      autocomplete="off"
      enterkeyhint="next"
      hx-get="{{ url_for('transactions.validation') }}"
      hx-trigger="input delay:200ms"
      hx-target="next error"
      hx-include="this"
    />
    <icon>event</icon>
    <div>
      <div>Date</div>
    </div>
    <div>
      <error></error>
    </div>
  </label>
  {% for split in txn.splits %}
    {% set split_i=loop.index0 %}
    <hr />
    {% if split.asset_name %}
      <div
        class="{{ parent_class if is_split else split_class }} flex items-center gap-1"
      >
        <icon>box</icon>
        {% if split.asset_quantity > 0 %}
          Buy
        {% elif split.asset_quantity == 0 %}
          {% if split.amount > 0 %}
            Dividend from
          {% else %}
            Fee from
          {% endif %}
        {% else %}
          Sell
        {% endif %}
        {% if split.asset_ticker %}{{ split.asset_ticker }}:{% endif %}
        {{ split.asset_name }}
      </div>
      <div
        class="{{ parent_class if is_split else split_class }} flex items-center gap-1"
      >
        {% if split.asset_quantity %}
          <icon>money_bag</icon>
          {{ split.asset_quantity | abs | qty }} shares @
          {{ cf(split.asset_price) }}
        {% endif %}
      </div>
      <div
        class="{{ 'md:mt-1 md:mb-5' if is_split }} {{ split_class }} flex items-center gap-1"
      >
        <icon>category</icon>{{ split.category }}
        <input name="category" type="hidden" value="{{ split.category_uri }}" />
      </div>
    {% else %}
      <label
        class="input-outlined input-bg-surface-container-high {{ split_class }}"
      >
        <select
          name="category"
          required
          autocomplete="off"
          onkeyup="onSelectKey(event)"
        >
          {% with category_groups=txn.category_groups, selected_uri=split.category_uri, hide_asset_linked=True %}
            {% include "shared/category-options.jinja" %}
          {% endwith %}
        </select>
        {% if not is_split %}<icon>category</icon>{% endif %}
        <div>
          <div>Category</div>
        </div>
      </label>
    {% endif %}
    <label
      class="input-outlined input-bg-surface-container-high {{ split_class }}"
    >
      <input
        name="memo"
        value="{{ split.memo or '' }}"
        placeholder=""
        autocomplete="off"
        spellcheck="true"
        enterkeyhint="next"
        hx-get="{{ url_for('transactions.validation') }}"
        hx-trigger="input delay:200ms"
        hx-target="next error"
        hx-include="this"
      />
      {% if not is_split %}<icon>notes</icon>{% endif %}
      <div>
        <div>Memo (optional)</div>
      </div>
      <div>
        <error></error>
      </div>
    </label>
    <label
      class="input-outlined input-bg-surface-container-high {{ split_class }}"
    >
      <chips>
        <div>
          {% for item in split.labels %}
            {% with name="label-" + split_i | string, value=item.name %}
              {% include "shared/chip.jinja" %}
            {% endwith %}
          {% endfor %}
          <input
            name="label"
            list="labels"
            placeholder=""
            autocomplete="off"
            spellcheck="true"
            enterkeyhint="next"
            hx-get="{{ url_for('transactions.validation') }}"
            hx-trigger="keydown[keyCode==13],input delay:200ms"
            hx-target="next error"
            hx-include="this"
            hx-on::after-request="chips.append(event, 'label-{{ split_i }}')"
          />
        </div>
      </chips>
      {% if not is_split %}<icon>label</icon>{% endif %}
      <div>
        <div>Labels (optional)</div>
      </div>
      <div>
        <error></error>
      </div>
    </label>
    {% if is_split %}
      <label
        class="input-outlined input-bg-surface-container-high {{ split_class }}"
      >
        <input
          name="split-amount"
          value="{{ split.amount | input_value }}"
          placeholder=""
          autocomplete="off"
          enterkeyhint="next"
          inputmode="tel"
          hx-get="{{ url_for('transactions.validation',  split=True) }}"
          hx-trigger="input delay:200ms"
          hx-target="next error"
          hx-include="this, #dialog [name=split-amount], #dialog [name=amount], #dialog [name=account]"
        />
        <icon>attach_money</icon>
        <div>
          <div>Split Amount</div>
        </div>
        <div>
          <error></error>
        </div>
      </label>
    {% endif %}
  {% endfor %}
</form>
{% if is_split %}
  <div class="text-center text-sm italic">
    Simply leave a split amount empty when saving to remove
  </div>
{% endif %}
<div class="flex flex-wrap justify-around" hx-target="#dialog-error">
  {% if not txn.any_asset_splits %}
    {% if txn.uri %}
      <button
        class="btn-text"
        hx-put="{{ url_for('transactions.split', uri=txn.uri) }}"
        hx-disabled-elt="this"
        hx-target="#dialog"
        hx-swap="innerHTML show:#dialog:bottom"
        hx-push-url="#dialog"
        hx-include="#dialog form"
      >
        Add Splits
      </button>
    {% else %}
      <button
        class="btn-text"
        hx-put="{{ url_for('transactions.new', uri=txn.uri, split=True) }}"
        hx-disabled-elt="this"
        hx-target="#dialog"
        hx-swap="innerHTML show:#dialog:bottom"
        hx-push-url="#dialog"
        hx-include="#dialog form"
      >
        Add Splits
      </button>
    {% endif %}
    {% if txn.similar_uri %}
      {# TODO (WattsUp): #364 enable button #}
      <button
        class="btn-text"
        disabled
        hx-delete="{{ url_for('transactions.split', uri='arst') }}"
        hx-disabled-elt="this"
      >
        Copy Similar
      </button>
    {% endif %}
  {% endif %}
  {% if txn.uri and not txn.cleared %}
    <button
      class="btn-text"
      hx-patch="{{ url_for('transactions.transaction', uri=txn.uri) }}"
      hx-trigger="clear"
      hx-disabled-elt="this"
      onclick="txn.confirmClear(event)"
    >
      Manually clear
    </button>
    <button
      class="btn-text-error"
      hx-delete="{{ url_for('transactions.transaction', uri=txn.uri) }}"
      hx-trigger="delete"
      hx-disabled-elt="this"
      onclick="txn.confirmDelete(event)"
    >
      Delete
    </button>
  {% endif %}
</div>
<div id="dialog-error" class="status-error"></div>
<script>
  dialog.onLoad();
</script>
