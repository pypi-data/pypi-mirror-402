"""JSON schemas and utilities for workflow settings"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/settings/schemas.ipynb.

# %% auto #0
__all__ = ['WORKFLOW_SETTINGS_SCHEMA', 'WorkflowSettings']

# %% ../../nbs/settings/schemas.ipynb #121380d6
from dataclasses import dataclass, field
from typing import Dict, Any, List, Optional, ClassVar

from fastcore.basics import patch

from cjm_fasthtml_jsonschema.core.dataclass import (
    SCHEMA_TITLE, SCHEMA_DESC, SCHEMA_MIN, SCHEMA_MAX, SCHEMA_ENUM,
    SCHEMA_MIN_LEN, SCHEMA_MAX_LEN, SCHEMA_PATTERN, SCHEMA_FORMAT,
    dataclass_to_jsonschema
)
from cjm_fasthtml_file_browser.core.config import BrowserConfig

from ..core.config import SingleFileWorkflowConfig
from ..storage.config import StorageConfig

# %% ../../nbs/settings/schemas.ipynb #d3k0b7n0sfa
@dataclass
class WorkflowSettings:
    """User-configurable settings for single-file transcription workflow."""
    
    # Class-level schema metadata (ClassVar excludes these from dataclass fields)
    __schema_name__: ClassVar[str] = "single_file_workflow"
    __schema_title__: ClassVar[str] = "Single File Transcription Settings"
    __schema_description__: ClassVar[str] = "Configure file scanning, storage, and workflow behavior"
    
    # File browser settings (field names match BrowserConfig for seamless config loading)
    directories: List[str] = field(
        default_factory=list,
        metadata={
            SCHEMA_TITLE: "Media Directories",
            SCHEMA_DESC: "Directories to scan for media files"
        }
    )
    enabled_types: List[str] = field(
        default_factory=lambda: ["audio", "video"],
        metadata={
            SCHEMA_TITLE: "Enabled File Types",
            SCHEMA_DESC: "File types to include in scan (audio, video)"
        }
    )
    recursive_scan: bool = field(
        default=True,
        metadata={
            SCHEMA_TITLE: "Recursive Scan",
            SCHEMA_DESC: "Scan subdirectories"
        }
    )
    items_per_page: int = field(
        default=30,
        metadata={
            SCHEMA_TITLE: "Items Per Page",
            SCHEMA_DESC: "Number of files to show per page",
            SCHEMA_MIN: 10,
            SCHEMA_MAX: 100
        }
    )
    default_view: str = field(
        default="list",
        metadata={
            SCHEMA_TITLE: "Default View",
            SCHEMA_DESC: "Default view mode for file selection",
            SCHEMA_ENUM: ["list"]  # Currently only list view is implemented
        }
    )
    
    # Storage settings
    auto_save: bool = field(
        default=True,
        metadata={
            SCHEMA_TITLE: "Auto-save Results",
            SCHEMA_DESC: "Automatically save transcription results when complete"
        }
    )
    results_directory: str = field(
        default="transcription_results",
        metadata={
            SCHEMA_TITLE: "Results Directory",
            SCHEMA_DESC: "Directory to save transcription results"
        }
    )
    
    # Resource management settings
    gpu_memory_threshold_percent: float = field(
        default=45.0,
        metadata={
            SCHEMA_TITLE: "GPU Memory Threshold (%)",
            SCHEMA_DESC: "GPU memory usage threshold for conflict detection (0-100)",
            SCHEMA_MIN: 0,
            SCHEMA_MAX: 100
        }
    )

# %% ../../nbs/settings/schemas.ipynb #ivm5mjdhnea
WORKFLOW_SETTINGS_SCHEMA = dataclass_to_jsonschema(WorkflowSettings) # Auto-generate schema from WorkflowSettings dataclass

# %% ../../nbs/settings/schemas.ipynb #54p74mwmwr8
@patch(cls_method=True)
def from_configs(
    cls: WorkflowSettings,
    browser_config: BrowserConfig,  # BrowserConfig instance with file browser settings
    storage_config: StorageConfig,  # StorageConfig instance with result storage settings
    workflow_config: Optional[SingleFileWorkflowConfig] = None  # Optional workflow config for additional settings
) -> "WorkflowSettings":  # WorkflowSettings instance with values from configs
    """Create WorkflowSettings from runtime config objects."""
    return cls(
        # File browser settings
        directories=browser_config.directories,
        enabled_types=browser_config.enabled_types,
        recursive_scan=browser_config.recursive_scan,
        items_per_page=browser_config.items_per_page,
        default_view=browser_config.default_view,
        # Storage settings
        auto_save=storage_config.auto_save,
        results_directory=storage_config.results_directory,
        # Workflow settings
        gpu_memory_threshold_percent=workflow_config.gpu_memory_threshold_percent if workflow_config else 45.0
    )

# %% ../../nbs/settings/schemas.ipynb #pykyoa1jd5
@patch
def apply_to_configs(
    self: WorkflowSettings,
    browser_config: BrowserConfig,  # BrowserConfig instance to update
    storage_config: StorageConfig,  # StorageConfig instance to update
    workflow_config: Optional[SingleFileWorkflowConfig] = None  # Optional workflow config to update
) -> None:
    """Apply settings to runtime config objects."""
    # File browser settings
    browser_config.directories = self.directories
    browser_config.enabled_types = self.enabled_types
    browser_config.recursive_scan = self.recursive_scan
    browser_config.items_per_page = self.items_per_page
    browser_config.default_view = self.default_view
    
    # Storage settings
    storage_config.auto_save = self.auto_save
    storage_config.results_directory = self.results_directory
    
    # Workflow settings
    if workflow_config:
        workflow_config.gpu_memory_threshold_percent = self.gpu_memory_threshold_percent

# %% ../../nbs/settings/schemas.ipynb #dhx8prgp6lq
@patch
def to_dict(
    self: WorkflowSettings
) -> Dict[str, Any]:  # Dictionary of settings values
    """Convert settings to a dictionary for serialization."""
    return {
        "directories": self.directories,
        "enabled_types": self.enabled_types,
        "recursive_scan": self.recursive_scan,
        "items_per_page": self.items_per_page,
        "default_view": self.default_view,
        "auto_save": self.auto_save,
        "results_directory": self.results_directory,
        "gpu_memory_threshold_percent": self.gpu_memory_threshold_percent,
    }
