[tox]
envlist = py3{10,11,12,13},lint,type,jslint,jstest
isolated_build = true
skip_missing_interpreters = true

[testenv]
skip_install = false
deps = .[test]
# Run unit tests by default (not e2e which requires playwright)
commands = pytest tests/unit/ {posargs}

[testenv:integration]
skip_install = false
deps = .[test]
commands = pytest tests/integration/ {posargs}

[testenv:lint]
skip_install = true
deps = .[devel]
commands = ruff check src/ tests/

[testenv:type]
skip_install = true
deps = .[devel]
commands = mypy --ignore-missing-imports src/mykrok/

[testenv:cov]
skip_install = false
deps = .[test]
commands = pytest --cov=mykrok --cov-report=term-missing --cov-report=xml {posargs:tests/}

[testenv:format]
skip_install = true
deps = .[devel]
commands = ruff format src/ tests/

[testenv:jslint]
skip_install = true
allowlist_externals = npm
description = Lint JavaScript code with ESLint
commands_pre = npm install --silent
commands = npm run lint

[testenv:jstest]
skip_install = true
allowlist_externals = npm
description = Run JavaScript tests with Jest
commands_pre = npm install --silent
commands = npm test

[testenv:e2e]
skip_install = false
deps = .[e2e]
passenv =
    DISPLAY
    PLAYWRIGHT_BROWSERS_PATH
    HOME
# Note: Run 'playwright install chromium' manually first, or with sudo for deps:
#   sudo playwright install-deps chromium
#   playwright install chromium
commands_pre = playwright install chromium
commands = pytest tests/e2e/ {posargs:-v}

[testenv:screenshots]
skip_install = false
deps = .[e2e]
passenv =
    DISPLAY
    PLAYWRIGHT_BROWSERS_PATH
    HOME
description = Generate screenshots for documentation
# Note: Requires playwright and system deps. First run:
#   sudo playwright install-deps chromium
#   playwright install chromium
commands_pre = playwright install chromium
commands = python scripts/generate_screenshots.py {posargs:--print-readme}

[testenv:gh-pages]
skip_install = false
deps = .[e2e]
passenv =
    HOME
    GIT_*
    SSH_AUTH_SOCK
description = Generate GitHub Pages demo website
commands = mykrok gh-pages {posargs}

[testenv:docs]
skip_install = true
deps = .[docs]
description = Build documentation with MkDocs
commands = mkdocs build --strict

[testenv:docs-serve]
skip_install = true
deps = .[docs]
description = Serve documentation locally with live reload
commands = mkdocs serve

[gh-actions]
python =
    3.10: py310
    3.11: py311
    3.12: py312, lint, type, cov, jslint, jstest
    3.13: py313
