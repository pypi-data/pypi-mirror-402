name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for PyPI package availability
        run: |
          VERSION="${{ steps.release.outputs.version }}"

          # Wait for package to be available on PyPI (up to 5 minutes)
          MAX_RETRIES=30
          RETRY_COUNT=0
          RETRY_DELAY=10

          echo "Waiting for sot $VERSION to be available on PyPI..."

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -sL -w "%{http_code}" -o /dev/null "https://pypi.org/pypi/sot/$VERSION/json")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Package sot $VERSION is available on PyPI"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Package not yet available (HTTP $HTTP_CODE), waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "❌ Package not available on PyPI after $MAX_RETRIES attempts"
          exit 1

      - name: Trigger homebrew-tools update
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.HOMEBREW_TAP_TOKEN }}" \
            https://api.github.com/repos/anistark/homebrew-tools/dispatches \
            -d '{
              "event_type": "update-formula",
              "client_payload": {
                "formula": "sot",
                "version": "${{ steps.release.outputs.version }}"
              }
            }'
