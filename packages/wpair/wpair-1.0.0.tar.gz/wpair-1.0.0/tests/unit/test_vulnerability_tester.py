"""Unit tests for vulnerability tester."""

import pytest
from wpair.core.vulnerability_tester import VulnerabilityTester
from wpair.core.device import DeviceStatus


def test_vulnerability_tester_initialization():
    """Test vulnerability tester can be initialized."""
    tester = VulnerabilityTester()
    assert tester is not None


def test_build_test_request():
    """Test building KBP test request."""
    address = "AA:BB:CC:DD:EE:FF"

    request = VulnerabilityTester._build_test_request(address)

    assert len(request) == 16
    assert request[0] == 0x00  # Message type
    assert request[1] == 0x11  # Flags
    # Bytes 2-7 should be the address
    assert request[2:8] == bytes.fromhex("AABBCCDDEEFF")
    # Bytes 8-15 are random salt, just check length
    assert len(request[8:16]) == 8


def test_extract_error_code_valid():
    """Test extracting error code from exception message."""
    from bleak.exc import BleakError

    # Simulate error with hex code
    error = BleakError("GATT error 0x0e: request rejected")

    code = VulnerabilityTester._extract_error_code(error)
    assert code == 0x0E


def test_extract_error_code_no_match():
    """Test extracting error code when no hex code present."""
    from bleak.exc import BleakError

    error = BleakError("Some generic error")

    code = VulnerabilityTester._extract_error_code(error)
    assert code == 0xFF  # Default value


@pytest.mark.asyncio
async def test_test_device_invalid_address():
    """Test that invalid MAC address returns ERROR."""
    tester = VulnerabilityTester()

    status = await tester.test_device("INVALID")

    assert status == DeviceStatus.ERROR
