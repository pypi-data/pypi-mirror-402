"""Vulnerability tester for CVE-2025-36911."""

import asyncio
import logging
import secrets
from typing import Optional
from bleak import BleakClient
from bleak.exc import BleakError

from wpair.core.device import DeviceStatus
from wpair.utils.validators import validate_mac_address

logger = logging.getLogger(__name__)


class VulnerabilityTester:
    """
    Tests Fast Pair devices for CVE-2025-36911 vulnerability.

    This is a DEFENSIVE security tool that checks if devices are patched.
    It does NOT exploit the vulnerability - it only tests if the device
    accepts pairing requests without proper authentication.
    """

    # Fast Pair GATT UUIDs
    SERVICE_UUID = "0000fe2c-0000-1000-8000-00805f9b34fb"
    KEY_BASED_PAIRING_UUID = "fe2c1234-8366-4814-8eb0-01de32100bea"

    # Timeouts
    CONNECTION_TIMEOUT = 15.0  # seconds
    OPERATION_TIMEOUT = 10.0   # seconds

    # GATT error codes
    GATT_SUCCESS = 0x00
    GATT_WRITE_NOT_PERMITTED = 0x03
    GATT_INSUFFICIENT_AUTHORIZATION = 0x08
    GATT_INSUFFICIENT_ENCRYPTION = 0x0F
    GATT_LIKELY_REJECTED = 0x0E  # Common rejection code for this vulnerability

    async def test_device(self, address: str) -> DeviceStatus:
        """
        Test a device for CVE-2025-36911 vulnerability.

        The test sends a Key-Based Pairing request to the device.
        - If accepted (GATT_SUCCESS): Device is VULNERABLE
        - If rejected (error codes): Device is PATCHED
        - Connection/service errors: Returns ERROR status

        Args:
            address: Bluetooth MAC address (XX:XX:XX:XX:XX:XX)

        Returns:
            DeviceStatus indicating vulnerability state
        """
        if not validate_mac_address(address):
            logger.error(f"Invalid MAC address: {address}")
            return DeviceStatus.ERROR

        logger.info(f"Starting vulnerability test for device: {address}")

        try:
            async with BleakClient(
                address,
                timeout=self.CONNECTION_TIMEOUT
            ) as client:

                if not client.is_connected:
                    logger.error(f"Failed to connect to {address}")
                    return DeviceStatus.ERROR

                logger.debug(f"Connected to {address}, discovering services...")

                # Discover Fast Pair service
                services = client.services
                fp_service = services.get_service(self.SERVICE_UUID)

                if fp_service is None:
                    logger.error("Fast Pair service not found")
                    return DeviceStatus.ERROR

                # Get Key-Based Pairing characteristic
                kbp_char = fp_service.get_characteristic(self.KEY_BASED_PAIRING_UUID)

                if kbp_char is None:
                    logger.error("Key-Based Pairing characteristic not found")
                    return DeviceStatus.ERROR

                # Build test request
                request = self._build_test_request(address)
                logger.debug(f"Sending test request ({len(request)} bytes)")

                # Write the request and check response
                try:
                    await asyncio.wait_for(
                        client.write_gatt_char(kbp_char, request, response=True),
                        timeout=self.OPERATION_TIMEOUT
                    )

                    # Device accepted the request = VULNERABLE
                    logger.warning(f"Device ACCEPTED pairing request - VULNERABLE!")
                    return DeviceStatus.VULNERABLE

                except BleakError as e:
                    # Check error code to determine if patched
                    error_code = self._extract_error_code(e)

                    if error_code in [
                        self.GATT_LIKELY_REJECTED,
                        self.GATT_INSUFFICIENT_AUTHORIZATION,
                        self.GATT_INSUFFICIENT_ENCRYPTION,
                        self.GATT_WRITE_NOT_PERMITTED
                    ]:
                        logger.info(f"Device REJECTED pairing request - PATCHED (error: 0x{error_code:02x})")
                        return DeviceStatus.PATCHED
                    else:
                        logger.warning(f"Unexpected error code: 0x{error_code:02x} - treating as PATCHED")
                        return DeviceStatus.PATCHED

        except asyncio.TimeoutError:
            logger.error(f"Connection timeout for device: {address}")
            return DeviceStatus.ERROR

        except Exception as e:
            logger.error(f"Test failed with exception: {e}")
            return DeviceStatus.ERROR

    @staticmethod
    def _build_test_request(address: str) -> bytes:
        """
        Build a test Key-Based Pairing request.

        Format (16 bytes):
        - Byte 0: Message type (0x00 = Key-Based Pairing Request)
        - Byte 1: Flags (0x11 = INITIATE_BONDING | EXTENDED_RESPONSE)
        - Bytes 2-7: Provider BLE address (6 bytes)
        - Bytes 8-15: Random salt (8 bytes)

        Args:
            address: MAC address of target device

        Returns:
            16-byte KBP request
        """
        # Parse MAC address to bytes
        address_bytes = bytes.fromhex(address.replace(":", ""))

        # Generate random salt
        salt = secrets.token_bytes(8)

        # Build request
        request = bytearray(16)
        request[0] = 0x00  # Message type: Key-Based Pairing Request
        request[1] = 0x11  # Flags: INITIATE_BONDING | EXTENDED_RESPONSE
        request[2:8] = address_bytes
        request[8:16] = salt

        return bytes(request)

    @staticmethod
    def _extract_error_code(error: BleakError) -> int:
        """
        Extract GATT error code from BleakError exception.

        Args:
            error: Bleak exception

        Returns:
            GATT error code (default 0xFF if cannot extract)
        """
        # Bleak exceptions contain error codes in their string representation
        error_str = str(error)

        # Try to find hex error code (e.g., "0x0e")
        import re
        match = re.search(r'0x([0-9a-fA-F]{2})', error_str)
        if match:
            return int(match.group(1), 16)

        # Default to unknown error
        return 0xFF
