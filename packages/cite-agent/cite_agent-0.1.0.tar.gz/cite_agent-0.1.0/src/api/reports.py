"""
Report Generation API
Synthesizes data into comprehensive Markdown reports
"""

import structlog
from fastapi import APIRouter, HTTPException, Depends, Query
from typing import Optional
from datetime import datetime

from src.models.user import User, PricingTier
from src.auth.dependencies import get_current_user, require_tier
from src.data_sources.market_data import MarketDataSource, MarketDataInterval
from src.data_sources.aggregator import get_aggregator
from src.intelligence.insights_engine import InsightsEngine

logger = structlog.get_logger(__name__)
router = APIRouter()

@router.get("/report/{ticker}")
async def generate_deep_report(
    ticker: str,
    user: User = Depends(require_tier(PricingTier.STARTER))
):
    """
    Generate a comprehensive 'Deep Report' (Markdown)
    
    **Required Tier:** Starter+
    
    **Content:**
    - Executive Summary (AI recommendation)
    - Price Analysis (Trend, Momentum)
    - Sentiment Analysis (News, Social)
    - Key Fundamentals (Valuation, Growth)
    - Recent News (with Citations)
    """
    ticker = ticker.upper()
    logger.info("Generating Deep Report", ticker=ticker, user_id=user.user_id)
    
    try:
        # Initialize engines
        market_data = MarketDataSource({})
        aggregator = get_aggregator()
        insights_engine = InsightsEngine()
        
        # Parallel data fetch (conceptually, awaiting sequentially for simplicity here)
        # 1. Price Data (6mo)
        prices = await market_data.get_historical_prices(
            ticker=ticker, period="6mo", interval=MarketDataInterval.ONE_DAY
        )
        
        # 2. Real-time Quote
        try:
            quote = await market_data.get_realtime_quote(ticker)
        except:
            quote = {}
            
        # 3. Sentiment & News
        sentiment = await aggregator.get_news_sentiment(ticker=ticker, tier=user.tier, days=7)
        
        # 4. Fundamentals
        fundamentals = await aggregator.get_fundamentals(ticker=ticker, tier=user.tier)
        
        # 5. Generate Insights
        insights = await insights_engine.generate_all_insights(
            ticker=ticker,
            price_data=prices,
            quote_data=quote,
            sentiment_data=sentiment
        )
        
        # 6. Overall Recommendation
        rec = insights_engine.get_overall_recommendation(insights)
        
        # --- Synthesize Markdown ---
        
        md = f"# üìÑ Deep Report: {ticker}\n"
        md += f"**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}\n"
        md += f"**Signal:** {rec['recommendation'].upper()} (Confidence: {rec['confidence']:.0%})\n\n"
        
        md += "## 1. Executive Summary\n"
        md += f"{rec['reasoning']}\n\n"
        
        md += "## 2. Market Data\n"
        if quote:
            md += f"- **Price:** ${quote.get('price', 0):.2f}\n"
            md += f"- **Day Range:** ${quote.get('day_low', 0):.2f} - ${quote.get('day_high', 0):.2f}\n"
        
        md += "## 3. Intelligence & Insights\n"
        for i in insights[:5]: # Top 5 insights
            icon = "üü¢" if i.signal == "bullish" else "üî¥" if i.signal == "bearish" else "‚ö†Ô∏è"
            md += f"### {icon} {i.title}\n"
            md += f"{i.reason}\n"
            md += f"*Confidence: {i.confidence:.0% }*\n\n"
            
        md += "## 4. Sentiment Analysis\n"
        social = sentiment.get("social_sentiment", {})
        md += f"- **Social Score:** {social.get('overall_score', 0):.2f} (-1 to +1)\n"
        md += f"- **Reddit Mentions:** {social.get('reddit', {}).get('mentions', 0)}\n\n"
        
        md += "## 5. Recent News (Cited)\n"
        for article in sentiment.get("news", [])[:3]:
            md += f"- [{article.get('headline')}]({article.get('url')}) - *{article.get('source')}*\n"
            
        md += "\n---
*Generated by Cite-Finance API*"
        
        return {
            "ticker": ticker,
            "report_markdown": md,
            "credits_deducted": 10
        }

    except Exception as e:
        logger.error("Report generation failed", error=str(e))
        raise HTTPException(status_code=500, detail="Failed to generate report")
