# {{ project_name }} Guardian Security Service Dockerfile
# Generated by ABI-Core scaffolding

FROM smarbuy/abi-image:latest

# Set working directory
WORKDIR /app

# Install system dependencies for cryptography and security
USER root
RUN apt-get update && apt-get install -y \
    build-essential \
    libffi-dev \
    libssl-dev \
    python3-dev \
    pkg-config \
    wget \
    {% if provision_models == 'distributed' %}tar \{% endif %}
    && rm -rf /var/lib/apt/lists/*

# Install Guardian dependencies
COPY requirements.txt /tmp/guardian-requirements.txt
RUN pip install --no-cache-dir -r /tmp/guardian-requirements.txt && \
    rm /tmp/guardian-requirements.txt

# Copy Guardian agent files
COPY ./agent /app/agent

# Copy configuration files
COPY ./config /app/config

# Copy OPA policies
COPY ./opa/policies /app/opa/policies

# Copy alerting configuration
COPY ./alerting_config.json /app/alerting_config.json

# Create emergency logs directory with proper permissions
RUN mkdir -p {{ emergency_log_dir | default('/app/emergency_logs') }} && \
    chmod 755 {{ emergency_log_dir | default('/app/emergency_logs') }}

# Create audit database directory
RUN mkdir -p /app/data && chmod 755 /app/data

RUN mkdir -p /app/agent/agent_cards && chmod 755 /app/agent/agent_cards
RUN mv /app/agent_cards/guardian_agent.json /app/agent/agent_cards/guardian_agent.json
RUN rm -rf /app/agent_cards/

# Environment variables for abi-entrypoint.sh
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV ABI_ROLE="Guardian Security Service"
ENV ABI_NODE="ABI SERVICE"
ENV AGENT_HOST=0.0.0.0
ENV AGENT_PORT={{ guardian_port | default('11438') }}

# ABI Entrypoint configuration
{% if provision_models == 'distributed' %}
ENV START_OLLAMA=true
ENV LOAD_MODELS=true
{% else %}
ENV START_OLLAMA=false
ENV LOAD_MODELS=false
ENV OLLAMA_HOST={{ ollama_host | default('http://ollama:11434') }}
{% endif %}
ENV SERVICE_MODULE=agent.main
ENV SERVICE_PORT={{ guardian_port | default('11438') }}
ENV PATH="/usr/local/bin:${PATH}"

{% if provision_models == 'distributed' %}
# Health check - verify both Ollama and Guardian are ready
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags >/dev/null 2>&1 && \
        wget -qO- http://localhost:{{ guardian_port | default('11438') }}/health >/dev/null 2>&1 || exit 1

# Expose Guardian API, Dashboard, and Ollama ports
EXPOSE {{ guardian_port | default('11438') }}
EXPOSE {{ dashboard_port | default('8080') }}
EXPOSE 11434

# Volume for model data
VOLUME ["/root/.ollama"]
{% else %}
# Health check - verify Guardian is ready (centralized mode)
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD wget -qO- http://localhost:{{ guardian_port | default('11438') }}/health >/dev/null 2>&1 || exit 1

# Expose Guardian API and Dashboard ports only
EXPOSE {{ guardian_port | default('11438') }}
EXPOSE {{ dashboard_port | default('8080') }}
{% endif %}

# Use abi-entrypoint.sh (inherited from abi-image)
# The entrypoint will handle Ollama startup (distributed) or connect to centralized Ollama
# No need to override CMD - entrypoint will use SERVICE_MODULE