# ğŸ›¡ï¸ **ValidaciÃ³n de Acceso SemÃ¡ntico**

## ğŸ“‹ **Resumen**

Sistema de validaciÃ³n de acceso para la capa semÃ¡ntica que utiliza:
1. **PolÃ­tica OPA** (`semantic_access.rego`) con reglas de autorizaciÃ³n
2. **Decorador Python** (`@validate_semantic_access`) para interceptar requests
3. **Agent Cards** como fuente de verdad para agentes registrados

## ğŸ—ï¸ **Arquitectura**

```
Request MCP â†’ @validate_semantic_access â†’ OPA Policy â†’ Agent Card â†’ Allow/Deny
```

### **Flujo de ValidaciÃ³n**

1. **Request llega** a funciÃ³n MCP decorada
2. **Decorador extrae** informaciÃ³n del agente (headers, contexto)
3. **Carga Agent Card** desde filesystem
4. **Prepara input OPA** con toda la informaciÃ³n
5. **EvalÃºa polÃ­tica** `abi.semantic_access` en OPA
6. **Procesa resultado** y permite/deniega acceso
7. **Ejecuta funciÃ³n** original si estÃ¡ autorizado

## ğŸ”’ **PolÃ­tica OPA: `semantic_access.rego`**

### **UbicaciÃ³n**
```
{{ project_name }}/agents/guardial/opa/policies/semantic_access.rego
```

### **Reglas Principales**

#### **âœ… Permitir Acceso**
- Agente registrado en sistema (tiene agent card)
- Agent card activo (`status != "inactive"`)
- No estÃ¡ en lista negra
- No excede rate limit
- IP autorizada (si estÃ¡ configurada)
- Dentro de horario permitido (si estÃ¡ configurado)
- Tiene permisos para herramienta MCP solicitada

#### **âŒ Denegar Acceso**
- Agente no registrado
- Agent card inactivo o blacklisted
- Rate limit excedido
- IP no autorizada
- Fuera de horario permitido
- Sin permisos para herramienta MCP

#### **ğŸ“Š CÃ¡lculo de Riesgo**
- **Base**: Por tipo de acciÃ³n (0.1 - 0.9)
- **IP**: +0.2 si IP desconocida, +0.1 si externa
- **Tiempo**: +0.1 si fuera de horario laboral
- **Herramienta**: +0.0 a +0.4 segÃºn herramienta MCP
- **Agente**: +0.0 a +0.2 segÃºn nivel de confianza

## ğŸ”§ **Decorador: `@validate_semantic_access`**

### **UbicaciÃ³n**
```
{{ project_name }}/semantic_layer/layer/mcp_server/semantic_access_validator.py
```

### **Uso**

```python
from layer.mcp_server.semantic_access_validator import validate_semantic_access

@validate_semantic_access
def find_agent(query: str, _request_context: dict = None) -> dict:
    # Esta funciÃ³n solo se ejecuta si el agente estÃ¡ autorizado
    return search_agents(query)
```

### **ExtracciÃ³n de Agente**

El decorador identifica agentes usando:

1. **Header `X-Agent-ID`**
   ```
   X-Agent-ID: orchestrator
   ```

2. **User-Agent parsing**
   ```
   User-Agent: ABI-Agent/orchestrator/1.0
   ```

3. **Contexto del request**
   ```python
   _request_context = {"agent_id": "orchestrator"}
   ```

### **Respuesta de Error**

Si el acceso es denegado:

```json
{
  "error": {
    "code": "ACCESS_DENIED",
    "message": "Agent not registered in system",
    "agent_id": "unknown_agent",
    "risk_score": 1.0,
    "timestamp": "2025-01-XX..."
  }
}
```

## ğŸ“‹ **Agent Cards Requeridos**

### **Estructura MÃ­nima**

```json
{
  "@type": "Agent",
  "id": "agent://orchestrator",
  "name": "Orchestrator Agent",
  "url": "http://localhost:8002",
  "metadata": {
    "status": "active",
    "trust_level": "high",
    "enabled": true
  }
}
```

### **ConfiguraciÃ³n de Seguridad (Opcional)**

```json
{
  "security": {
    "allowed_ips": ["127.0.0.1", "192.168.1.0/24"],
    "allowed_mcp_tools": ["find_agent", "get_agent_card"],
    "access_schedule": {
      "start_hour": 8,
      "end_hour": 18
    }
  }
}
```

## ğŸ§ª **Testing**

### **Script de Prueba**
```bash
cd {{ project_name }}/semantic_layer
python test_semantic_validation.py
```

### **Casos de Prueba**
1. âœ… Agente autorizado con agent card vÃ¡lido
2. âŒ Agente con agent card inactivo
3. âŒ Agente no registrado (sin agent card)
4. âŒ Request sin identificaciÃ³n de agente
5. âœ… Diferentes herramientas MCP autorizadas

### **Prueba Manual con OPA**

```bash
# 1. Iniciar OPA
docker run -p 8181:8181 openpolicyagent/opa:latest run --server

# 2. Cargar polÃ­tica
curl -X PUT http://localhost:8181/v1/policies/semantic_access \
  --data-binary @{{ project_name }}/agents/guardial/opa/policies/semantic_access.rego

# 3. Probar evaluaciÃ³n
curl -X POST http://localhost:8181/v1/data/abi/semantic_access \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "action": "semantic_layer_access",
      "source_agent": "orchestrator",
      "agent_card": {
        "id": "agent://orchestrator",
        "metadata": {"status": "active"}
      },
      "request_metadata": {
        "source_ip": "127.0.0.1",
        "mcp_tool": "find_agent"
      }
    }
  }'
```

## ğŸ”„ **IntegraciÃ³n con Semantic Layer**

### **Servidor MCP Modificado**

```python
# En server.py
from layer.mcp_server.semantic_access_validator import validate_semantic_access

@mcp.tool(name='find_agent')
@validate_semantic_access
def find_agent(query: str, _request_context: dict = None) -> dict:
    # FunciÃ³n protegida por validaciÃ³n
    return search_agent(query)
```

### **ConfiguraciÃ³n de Agentes**

Los agentes deben incluir identificaciÃ³n en requests:

```python
# En cliente MCP
headers = {
    "X-Agent-ID": "orchestrator",
    "User-Agent": "ABI-Agent/orchestrator/1.0"
}
```

## ğŸ“Š **Monitoreo y Logs**

### **Logs de ValidaciÃ³n**

```
âœ… Semantic access granted for 'orchestrator' (risk: 0.15)
âŒ Semantic access denied for 'unauthorized': Agent marked as inactive (risk: 1.0)
```

### **MÃ©tricas Disponibles**

- Requests validados por minuto
- Agentes autorizados vs denegados
- DistribuciÃ³n de risk scores
- Tipos de violaciones mÃ¡s comunes
- Performance de validaciÃ³n (latencia)

## ğŸš€ **Despliegue**

### **Variables de Entorno**

```bash
# ConfiguraciÃ³n del validador
AGENT_CARDS_BASE=/app/agent_cards
OPA_URL=http://{{ project_dir }}-opa:8181
GUARDIAN_URL=http://{{ project_dir }}-guardian:11438

# ConfiguraciÃ³n de cache
VALIDATION_CACHE_TTL=300  # 5 minutos
```

### **Dependencias**

```bash
# En requirements.txt del semantic layer
httpx>=0.24.0
```

## ğŸ”§ **ConfiguraciÃ³n Avanzada**

### **Rate Limiting**

Configurar en OPA data:

```json
{
  "rate_limits": {
    "requests_per_minute": 60
  },
  "agent_request_counts": {
    "orchestrator": 45,
    "planner": 30
  }
}
```

### **Lista Negra**

```json
{
  "blacklisted_agents": ["malicious_agent", "test_agent"]
}
```

### **Agentes de Confianza**

En la polÃ­tica, modificar:

```rego
trusted_agents := {
    "orchestrator",
    "planner", 
    "observer",
    "your_trusted_agent"
}
```

## âœ… **Estado de ImplementaciÃ³n**

- âœ… PolÃ­tica OPA completa con todas las reglas
- âœ… Decorador funcional con extracciÃ³n de agente
- âœ… IntegraciÃ³n con agent cards
- âœ… CÃ¡lculo de risk score
- âœ… Logging y auditorÃ­a
- âœ… Script de pruebas
- âœ… DocumentaciÃ³n completa

**Sistema listo para validar acceso a la capa semÃ¡ntica** ğŸ›¡ï¸