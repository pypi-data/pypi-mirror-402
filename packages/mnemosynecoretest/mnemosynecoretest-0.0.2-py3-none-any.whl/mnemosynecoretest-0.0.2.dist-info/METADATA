Metadata-Version: 2.4
Name: mnemosynecoretest
Version: 0.0.2
Summary: Internal analytics toolkit for data pipelines
Author-email: rostilin <rostilin@ozon.ru>
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: vertica-python>=1.3
Requires-Dist: pandas>=2.0
Requires-Dist: mattermostdriver>=2.0
Requires-Dist: requests>=2.30
Requires-Dist: python-dotenv>=1.2.1
Requires-Dist: typing-extensions>=4.0.0
Provides-Extra: airflow
Requires-Dist: apache-airflow<3.1,>=2.6; extra == "airflow"
Requires-Dist: apache-airflow-providers-postgres>=5.0; extra == "airflow"
Requires-Dist: apache-airflow-providers-vertica>=2.0; extra == "airflow"
Requires-Dist: sqlalchemy<2.0; extra == "airflow"

mnemosynecore

Internal analytics toolkit for data pipelines
Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Vertica, Airflow, Vault, Mattermost Ð¸ pandas DataFrame.

ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
pip install mnemosynecore

Ð¡ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ Airflow
pip install "mnemosynecore[airflow]"

ðŸ” Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸ (Vault / Env / Tests)
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸

ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

Vault

Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ JSON-Ñ„Ð°Ð¹Ð»Ñ‹ (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²)

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐµÐºÑ€ÐµÑ‚Ð° (JSON)
{
  "host": "vertica.host",
  "port": 5433,
  "login": "user",
  "password": "password",
  "schema": "dwh"
}

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð°
from mnemosynecore.vault import get_secret

cfg = get_secret("VERTICA_PROD")

Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (Ð±ÐµÐ· Vault)
from mnemosynecore.vault import get_secret_test

cfg = get_secret_test("VERTICA_TEST", dir_path="./secrets")

ðŸŸ£ Vertica
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
from mnemosynecore.vertica import vertica_conn

conn = vertica_conn("VERTICA_PROD")

Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ SQL
from mnemosynecore.vertica import vertica_sql

vertica_sql(
    conn_id="VERTICA_PROD",
    sql="DELETE FROM mart.events WHERE dt = CURRENT_DATE"
)

SELECT â†’ pandas DataFrame
from mnemosynecore.vertica import vertica_select

df = vertica_select(
    conn_id="VERTICA_PROD",
    sql="SELECT * FROM mart.events LIMIT 100"
)

Upsert DataFrame Ð² Vertica
from mnemosynecore.vertica import vertica_upsert

vertica_upsert(
    df=df,
    table_name="mart.events",
    unique_keys=["event_id"],
    conn=conn,
    date_col="dt",
    days_back=7
)

Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð´ÑƒÐ±Ð»ÐµÐ¹ (dedupe)
from mnemosynecore.vertica import vertica_dedupe

vertica_dedupe(
    table_name="mart.events",
    unique_keys=["event_id"],
    date_col="updated_at",
    conn_id="VERTICA_PROD"
)

SQLAlchemy Engine
from mnemosynecore.vertica import get_vertica_engine

engine = get_vertica_engine("VERTICA_PROD")

ðŸŸ¦ Airflow
Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° SQL-Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ°Ðº VerticaOperator

Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°

sql/
 â”œâ”€â”€ users.sql
 â”œâ”€â”€ events.sql

from mnemosynecore.airflow import load_sql_tasks_from_dir

tasks = load_sql_tasks_from_dir(
    dir_sql="/opt/airflow/sql",
    vertica_conn_id="VERTICA_PROD"
)


ðŸ“Œ

ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð±ÐµÑ€Ñ‘Ñ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ DAG

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ .sql â†’ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ VerticaOperator

ðŸ’¬ Mattermost
ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Vault)
from mnemosynecore.mattermost import send_message

send_message(
    channel_id="channel_id",
    bot_id="MM_BOT_PROD",
    text="ðŸš€ Pipeline ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
)

Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ JSON)
from mnemosynecore.mattermost import send_message_test

send_message_test(
    channel_id="channel_id",
    bot_id="MM_BOT_TEST",
    text="Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",
    dir_path="./secrets"
)

ðŸ§ª Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð±ÐµÐ· Airflow Ð¸ Vault
secrets/
 â”œâ”€â”€ VERTICA_TEST.json
 â””â”€â”€ MM_BOT_TEST.json

export VERTICA_TEST='{"host": "..."}'


Ð¸Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· get_secret_test
