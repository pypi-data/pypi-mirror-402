Metadata-Version: 2.4
Name: mnemosynecoretest
Version: 0.0.1
Summary: Internal analytics toolkit for data pipelines
Author-email: rostilin <rostilin@ozon.ru>
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: vertica-python>=1.3
Requires-Dist: pandas>=2.0
Requires-Dist: mattermostdriver>=2.0
Requires-Dist: requests>=2.30
Requires-Dist: python-dotenv>=1.2.1
Requires-Dist: typing-extensions>=4.0.0
Provides-Extra: airflow
Requires-Dist: apache-airflow<3.1,>=3.0; extra == "airflow"
Requires-Dist: apache-airflow-providers-postgres>=5.0; extra == "airflow"
Requires-Dist: apache-airflow-providers-vertica>=2.0; extra == "airflow"
Requires-Dist: sqlalchemy<2.0; extra == "airflow"

# mnemosynecore Documentation

## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ mnemosynecore –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Vertica –ë–î, 
Airflow, Mattermost –∏ –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –û–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ 
—Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
pip install mnemosynecore

–î–ª—è Airflow:
pip install mnemosynecore[airflow]

–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
1. –†–∞–±–æ—Ç–∞ —Å Vertica (mnemosynecore.db.vertica)
–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
vertica_conn(conn_id) - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Vertica
from mnemosynecore.db.vertica import vertica_conn

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Vertica
conn = vertica_conn("VERTICA_CONN_ID")
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
result = vertica_sql(conn=conn, sql="SELECT * FROM table")
conn.close()

**vertica_sql(kwargs) - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

from mnemosynecore.db.vertica import vertica_sql

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å ID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
vertica_sql(
    conn_id="VERTICA_CONN_ID",
    sql="INSERT INTO table VALUES (%s, %s)",
    params=[1, "test"]
)

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –≥–æ—Ç–æ–≤—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
vertica_sql(conn=conn, sql="UPDATE table SET col = %s WHERE id = %s", params=[100, 1])

**vertica_select(kwargs) - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SELECT –∑–∞–ø—Ä–æ—Å–æ–≤

from mnemosynecore.db.vertica import vertica_select

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ DataFrame
df = vertica_select(
    conn_id="VERTICA_CONN_ID",
    sql="SELECT * FROM table WHERE id = %s",
    params=[123]
)
print(df.head())

**vertica_dedupe(table_name, unique_keys, kwargs) - –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

from mnemosynecore.db.vertica import vertica_dedupe

# –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É –∫–ª—é—á—É
vertica_dedupe(
    table_name="schema.table",
    unique_keys="id",
    conn_id="VERTICA_CONN_ID"
)

# –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–ª—é—á–∞–º —Å —É—á–µ—Ç–æ–º –¥–∞—Ç—ã
vertica_dedupe(
    table_name="schema.table",
    unique_keys=["id", "date"],
    conn_id="VERTICA_CONN_ID",
    date_col="created_at",
    keep="last"
)

**vertica_upsert(df, table_name, unique_keys, kwargs) - Upsert –æ–ø–µ—Ä–∞—Ü–∏–∏

from mnemosynecore.db.vertica import vertica_upsert
import pandas as pd

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df = pd.DataFrame({
    'id': [1, 2, 3],
    'name': ['Alice', 'Bob', 'Charlie'],
    'value': [100, 200, 300]
})

# Upsert –¥–∞–Ω–Ω—ã—Ö
vertica_upsert(
    df=df,
    table_name="schema.table",
    unique_keys=["id"],
    conn_id="VERTICA_CONN_ID"
)

load_sql_tasks_from_dir(dir_sql, vertica_conn_id) - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ SQL —Ñ–∞–π–ª–æ–≤

from mnemosynecore.db.vertica import load_sql_tasks_from_dir

# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ SQL —Ñ–∞–π–ª–æ–≤
tasks = load_sql_tasks_from_dir("/path/to/sql/files", "VERTICA_CONN_ID")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Airflow DAG
from airflow import DAG
from airflow.utils.task_group import TaskGroup

with DAG("my_dag") as dag:
    with TaskGroup("vertica_tasks") as vertica_group:
        for task in tasks.values():
            task

read_sql_file(file_path) - –ß—Ç–µ–Ω–∏–µ SQL —Ñ–∞–π–ª–æ–≤
from mnemosynecore.db.vertica import read_sql_file

# –ß—Ç–µ–Ω–∏–µ SQL —Ñ–∞–π–ª–∞
sql_content = read_sql_file("/path/to/query.sql")
if sql_content:
    print("SQL –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ")

2. –†–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ (mnemosynecore.vault)
get_secret(conn_id) - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
from mnemosynecore.vault import get_secret

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –∏–∑ Vault
secret = get_secret("SECRET_ID")
print(secret["host"])  # –•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
print(secret["password"])  # –ü–∞—Ä–æ–ª—å

3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Mattermost (mnemosynecore.mattermost)
send_message(channel_id, bot_id, text, silent=False) - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

from mnemosynecore.mattermost import send_message

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª
send_message(
    channel_id="s5c11srqkf8j3pbdwfbn9imrde",
    bot_id="MATTERMOST_BOT_ID",
    text="–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ Markdown —Å–æ–æ–±—â–µ–Ω–∏—è
send_message(
    channel_id="s5c11srqkf8j3pbdwfbn9imrde",
    bot_id="MATTERMOST_BOT_ID",
    text="""
    üìä **–û—Ç—á–µ—Ç –ø–æ –¥–∞–Ω–Ω—ã–º** üìä
    
    - –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: 1000
    - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 2 –º–∏–Ω—É—Ç—ã
    
    [–ü–æ–¥—Ä–æ–±–Ω–µ–µ](https://your-dashboard.com)
    """
)

4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Superset (mnemosynecore.superset)
superset_request(endpoint, method="GET", payload=None, vault_conn_id) - –ó–∞–ø—Ä–æ—Å—ã –∫ Superset
from mnemosynecore.superset import superset_request

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞—à–±–æ—Ä–¥–µ
response = superset_request(
    endpoint="/api/v1/dashboard/123",
    method="GET",
    vault_conn_id="SUPERSET_CONN_ID"
)

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
new_dashboard = superset_request(
    endpoint="/api/v1/dashboard/",
    method="POST",
    payload={"name": "New Dashboard"},
    vault_conn_id="SUPERSET_CONN_ID"
)

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
–§–æ—Ä–º–∞—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤ –¥–ª—è Vault
–î–ª—è Vertica:
{
    "host": "vertica-host.com",
    "port": "5433",
    "login": "username",
    "password": "password",
    "schema": "database_schema"
}

–î–ª—è Mattermost:
{
    "host": "https://mattermost.company.com",
    "password": "bot_token_here",
    "scheme": "https",
    "port": 443,
    "basepath": "/api/v4"
}

–î–ª—è Superset:
{
    "host": "https://superset.company.com",
    "password": "access_token_here",
    "scheme": "https",
    "port": 443,
    "basepath": "/api/v1"
}

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã —Å Vertica
from mnemosynecore.db.vertica import vertica_conn, vertica_sql, vertica_select, vertica_upsert
from mnemosynecore.mattermost import send_message
import pandas as pd

def process_data_pipeline():
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Vertica
    conn = vertica_conn("VERTICA_CONN_ID")
    
    try:
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        df = vertica_select(
            conn=conn,
            sql="SELECT * FROM source_table WHERE date > %s",
            params=['2023-01-01']
        )
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        processed_df = df.groupby('category').sum()
        
        # Upsert –≤ —Ü–µ–ª–µ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        vertica_upsert(
            df=processed_df,
            table_name="analytics.summary",
            unique_keys=["category"],
            conn=conn
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        send_message(
            channel_id="s5c11srqkf8j3pbdwfbn9imrde",
            bot_id="MATTERMOST_BOT_ID",
            text="‚úÖ –ü–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
        )
        
    except Exception as e:
        send_message(
            channel_id="s5c11srqkf8j3pbdwfbn9imrde",
            bot_id="MATTERMOST_BOT_ID",
            text=f"‚ùå –û—à–∏–±–∫–∞ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ: {str(e)}"
        )
        raise
    finally:
        conn.close()

–ü—Ä–∏–º–µ—Ä 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

from mnemosynecore.db.vertica import vertica_dedupe

def remove_duplicates():
    vertica_dedupe(
        table_name="analytics.user_events",
        unique_keys=["user_id", "event_time"],
        conn_id="VERTICA_CONN_ID",
        date_col="event_time",
        keep="last"
    )

