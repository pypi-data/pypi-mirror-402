name: Build and Publish pp_primp

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'æ˜¯å¦å‘å¸ƒåˆ° PyPI (true/false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # æ¨é€è§¦å‘ï¼štag æˆ–åˆ†æ”¯
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
      - master

permissions:
  contents: read

env:
  GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}
  MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}

jobs:
  # ==================== Linux å¹³å°æ„å»º ====================
  build-linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}
      MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Linux x64 (æœ€å¸¸ç”¨)
#          - aarch64       # Linux ARM64 (æœåŠ¡å™¨)
    steps:
      - uses: actions/checkout@v4

      - name: Configure git to use GitHub token
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libclang-dev \
            clang \
            cmake \
            build-essential \
            pkg-config \
            gcc-multilib \
            libssl-dev

      - name: Find and set libclang path
        run: |
          # æŸ¥æ‰¾ libclang.so å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          LIBCLANG_PATH=$(find /usr/lib -name "libclang.so*" | head -1 | xargs dirname)
          echo "LIBCLANG_PATH=$LIBCLANG_PATH" >> $GITHUB_ENV
          echo "Found libclang at: $LIBCLANG_PATH"
          ls -la $LIBCLANG_PATH/libclang.so* || true

      - name: Build wheels
        env:
          MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: ${{ matrix.target == 'x86_64' && '2_28' || '2_28' }}
          before-script-linux: |
            # Configure Git credentials in manylinux container
            git config --global url."https://x-access-token:$MATURIN_GIT_TOKEN@github.com/".insteadOf "https://github.com/"

            # æ£€æµ‹åŒ…ç®¡ç†å™¨å¹¶å®‰è£…ä¾èµ–
            if command -v yum &> /dev/null; then
              echo "Using yum (manylinux container)"
              yum install -y clang llvm-devel cmake glibc-devel glibc-headers kernel-headers

              # è®¾ç½® bindgen çš„ clang å‚æ•°ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°ç³»ç»Ÿå¤´æ–‡ä»¶
              ARCH=$(uname -m)
              export BINDGEN_EXTRA_CLANG_ARGS="-I/usr/include -I/usr/include/$ARCH-linux-gnu"
              echo "BINDGEN_EXTRA_CLANG_ARGS=$BINDGEN_EXTRA_CLANG_ARGS"

              # æŸ¥æ‰¾å¹¶è®¾ç½® libclang
              export LIBCLANG_PATH="${LIBCLANG_PATH:-$(find /usr/lib* -name "libclang.so*" 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo "/usr/lib64")}"
              echo "Using LIBCLANG_PATH=$LIBCLANG_PATH"
            else
              echo "Not in manylinux container, using host dependencies"
            fi

            # éªŒè¯
            ls -la $LIBCLANG_PATH/libclang* 2>/dev/null || echo "libclang not found, relying on system defaults"
            clang --version 2>/dev/null || echo "clang not in PATH"

      - name: List built wheels
        run: ls -lh dist/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  # ==================== Windows å¹³å°æ„å»º ====================
  build-windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}
      MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        target: [x64]
    steps:
      - uses: actions/checkout@v4

      - name: Configure git to use GitHub token
        shell: bash
        run: |
          git config --global url."https://x-access-token:$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}


      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: ${{ matrix.target }}

      - name: Build wheels
        env:
          MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: dir dist

      - name: Debug wheel contents
        shell: powershell
        run: |
          $wheel = Get-ChildItem dist\*.whl | Select-Object -First 1
          Write-Host "=== Wheel contents ==="
          python -m zipfile -l $wheel
          Write-Host "`n=== Looking for never_primp files ==="
          python -m zipfile -l $wheel | Select-String "never_primp"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  # ==================== macOS å¹³å°æ„å»º ====================
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest
    env:
      GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Intel Mac
          - aarch64       # Apple Silicon (M1/M2/M3)
    steps:
      - uses: actions/checkout@v4

      - name: Configure git to use GitHub token
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Build wheels
        env:
          MATURIN_GIT_TOKEN: ${{ secrets.DD_TOKEN }}
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: ls -lh dist/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  # ==================== æ„å»ºæºç åˆ†å‘åŒ… ====================
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure git to use GitHub token
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: List sdist
        run: ls -lh dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # ==================== å‘å¸ƒåˆ° PyPI ====================
  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-sdist]
    env:
      GITHUB_TOKEN: ${{ secrets.DD_TOKEN }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List all packages
        run: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ‰€æœ‰åŒ…ï¼š"
          echo "========================================="
          ls -lh dist/
          echo ""
          echo "========================================="
          echo "ğŸ“‹ åŒ…åˆ—è¡¨ï¼š"
          echo "========================================="
          for file in dist/*; do
            echo "  âœ“ $(basename $file)"
          done
          echo ""
          echo "========================================="

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

      - name: Success message
        run: |
          echo "========================================="
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"
          echo "========================================="
          echo "ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š"
          echo "  pip install pp_primp"
          echo ""
          echo "æŸ¥çœ‹é¡¹ç›®ï¼š"
          echo "  https://pypi.org/project/pp_primp/"
          echo "========================================="