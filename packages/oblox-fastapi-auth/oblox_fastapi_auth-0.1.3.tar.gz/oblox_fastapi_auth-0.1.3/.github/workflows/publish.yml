name: Publish Python üêç distribution üì¶ to PyPI

on:
    push:
        branches:
            - main
            - master
        tags:
            - "v*"
    pull_request:
        branches:
            - main
            - master

jobs:
    test:
        name: Run tests üß™
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: write

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: postgres
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        env:
            TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/fastapi_auth_test
            AUTH_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/fastapi_auth_test

        steps:
            - uses: actions/checkout@v6

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies
              run: |
                  uv sync --all-groups --all-extras

            - name: Run tests with coverage
              run: |
                  uv run pytest --cov-branch --cov=fastapi_auth --cov-report=xml --cov-report=term --cov-report=json
                  # Verify .coverage file exists and check its format
                  if [ -f .coverage ]; then
                      echo ".coverage file exists"
                      uv run python -m coverage json -o /dev/null 2>&1 | head -5 || echo "Coverage JSON conversion check"
                  else
                      echo "ERROR: .coverage file not found!"
                      exit 1
                  fi

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
                  verbose: true

            - name: Comment PR with coverage diff
              if: github.event_name == 'pull_request'
              continue-on-error: true
              uses: py-cov-action/python-coverage-comment-action@v3
              with:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  MINIMUM_GREEN: 80
                  MINIMUM_ORANGE: 70
                  VERBOSE: "true"
                  ANNOTATE_MISSING_LINES: "false"

    lint:
        name: Lint code üîç
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies
              run: |
                  uv sync --all-groups --all-extras

            - name: Run ruff linter
              run: |
                  uv run ruff check .

            - name: Check code formatting
              run: |
                  uv run ruff format --check . || (echo "::error::Code formatting issues found. Run 'ruff format .' to fix them." && exit 1)

    build:
        name: Build distribution üì¶
        runs-on: ubuntu-latest
        needs:
            - test
            - lint
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

        steps:
            - uses: actions/checkout@v6
              with:
                  persist-credentials: false

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies
              run: |
                  uv sync --all-groups --all-extras

            - name: Build a binary wheel and a source tarball
              run: |
                  uv run python -m build

            - name: Store the distribution packages
              uses: actions/upload-artifact@v5
              with:
                  name: python-package-distributions
                  path: dist/

    publish-to-pypi:
        name: Publish Python üêç distribution üì¶ to PyPI
        if: startsWith(github.ref, 'refs/tags/') # only publish to PyPI on tag pushes
        needs:
            - build
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Download all the dists
              uses: actions/download-artifact@v6
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Publish distribution üì¶ to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  password: ${{ secrets.PYPI_API_TOKEN }}
