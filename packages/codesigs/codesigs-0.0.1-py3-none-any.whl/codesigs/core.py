# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto #0
__all__ = ['get_docstring', 'py_sigs', 'js_sigs', 'java_sigs', 'rust_sigs', 'csharp_sigs', 'css_selectors', 'go_sigs',
           'kotlin_sigs', 'swift_sigs', 'lua_sigs', 'php_sigs', 'ruby_sigs', 'ext_sigs', 'file_sigs']

# %% ../nbs/00_core.ipynb #033c76fd
from fastcore.utils import *
from fastcore.meta import delegates
from ast_grep_py import SgRoot

import ast

# %% ../nbs/00_core.ipynb #8b98c134
def get_docstring(node, lines):
    "Get docstring from source lines if present"
    if not (node.body and isinstance(node.body[0], ast.Expr) and isinstance(node.body[0].value, ast.Constant)): return None
    doc_node = node.body[0]
    return '\n'.join(lines[doc_node.lineno-1:doc_node.end_lineno])

def _node_sig(node, lines):
    body_start = max(node.body[0].lineno - 1, node.lineno)
    sig = '\n'.join(lines[node.lineno-1:body_start])
    doc = get_docstring(node, lines)
    return (f"{sig}\n{doc}" if doc else sig).strip('\r\n') + ' ...'

def py_sigs(src):
    "Extract class/function/method signatures from Python source"
    tree,lines = ast.parse(src),src.splitlines()
    def _collect(nodes):
        sigs = []
        for n in nodes:
            if isinstance(n, (ast.FunctionDef, ast.AsyncFunctionDef, ast.ClassDef)):
                sigs.append(_node_sig(n, lines))
                sigs.extend(_collect(n.body))
        return sigs
    return _collect(tree.body)

# %% ../nbs/00_core.ipynb #5c60cc8c
def _get_sigs(src, lang, kinds, name_kind, params_kind, fmt):
    root = SgRoot(src, lang).root()
    sigs = []
    for kind in kinds:
        for n in root.find_all(kind=kind):
            name,params = n.find(kind=name_kind),n.find(kind=params_kind)
            if name and params: sigs.append(fmt(n, name.text(), params.text()))
    return sigs

# %% ../nbs/00_core.ipynb #ea058abf
def js_sigs(src, lang="javascript"):
    "Extract function signatures from JS/TS source"
    sigs = _get_sigs(src, lang, ["function_declaration"], "identifier", "formal_parameters",
                     lambda n,nm,ps: f"function {nm}{ps} {{...}}")
    sigs += _get_sigs(src, lang, ["method_definition"], "property_identifier", "formal_parameters",
                      lambda n,nm,ps: f"{nm}{ps} {{...}}")
    return sigs

# %% ../nbs/00_core.ipynb #d175e1f3
def java_sigs(src):
    "Extract method signatures from Java source"
    def fmt(n, nm, ps):
        typ = n.find(kind="type_identifier") or n.find(kind="void_type") or n.find(kind="integral_type")
        return f"{typ.text() if typ else 'void'} {nm}{ps};"
    return _get_sigs(src, "java", ["method_declaration"], "identifier", "formal_parameters", fmt)

# %% ../nbs/00_core.ipynb #4492b94d
def rust_sigs(src):
    "Extract function signatures from Rust source"
    return _get_sigs(src, "rust", ["function_item"], "identifier", "parameters",
                     lambda n,nm,ps: f"fn {nm}{ps} {{...}}")

# %% ../nbs/00_core.ipynb #db15d753
def csharp_sigs(src):
    "Extract method signatures from C# source"
    def fmt(n, nm, ps):
        typ = n.find(kind="predefined_type") or n.find(kind="identifier")
        return f"{typ.text() if typ else 'void'} {nm}{ps};"
    return _get_sigs(src, "csharp", ["method_declaration"], "identifier", "parameter_list", fmt)

# %% ../nbs/00_core.ipynb #62eb97fb
def css_selectors(src):
    "Extract CSS selectors from source"
    root = SgRoot(src, "css").root()
    return [f"{n.text()} {{...}}" for n in root.find_all(kind="selectors")]

# %% ../nbs/00_core.ipynb #148e8adb
def go_sigs(src):
    "Extract function signatures from Go source"
    root = SgRoot(src, "go").root()
    sigs = []
    for n in root.find_all(kind="function_declaration"):
        name,params = n.find(kind="identifier"),n.find(kind="parameter_list")
        if name and params: sigs.append(f"func {name.text()}{params.text()} {{...}}")
    for n in root.find_all(kind="method_declaration"):
        recv,name = n.find(kind="parameter_list"),n.find(kind="field_identifier")
        params = n.find_all(kind="parameter_list")
        if name and len(params) > 1: sigs.append(f"func {recv.text()} {name.text()}{params[1].text()} {{...}}")
    return sigs

# %% ../nbs/00_core.ipynb #ac7ea6f5
def kotlin_sigs(src):
    "Extract function signatures from Kotlin source"
    return _get_sigs(src, "kotlin", ["function_declaration"], "simple_identifier", "function_value_parameters",
                     lambda n,nm,ps: f"fun {nm}{ps} {{...}}")

# %% ../nbs/00_core.ipynb #a6ee3031
def swift_sigs(src):
    "Extract function signatures from Swift source"
    return _get_sigs(src, "swift", ["function_declaration"], "simple_identifier", "parameter",
                     lambda n,nm,ps: f"func {nm}({ps}) {{...}}")

# %% ../nbs/00_core.ipynb #726f9ab9
def lua_sigs(src):
    "Extract function signatures from Lua source"
    return _get_sigs(src, "lua", ["function_declaration"], "identifier", "parameters",
                     lambda n,nm,ps: f"function {nm}{ps} ... end")

# %% ../nbs/00_core.ipynb #94cad5be
def php_sigs(src):
    "Extract function signatures from PHP source"
    return _get_sigs(src, "php", ["function_definition", "method_declaration"], "name", "formal_parameters",
                     lambda n,nm,ps: f"function {nm}{ps} {{...}}")

# %% ../nbs/00_core.ipynb #11cdf226
def ruby_sigs(src):
    "Extract method signatures from Ruby source"
    return _get_sigs(src, "ruby", ["method"], "identifier", "method_parameters",
                     lambda n,nm,ps: f"def {nm}{ps} ... end")

# %% ../nbs/00_core.ipynb #f58e9a0e
_sigs_fns = {'.py': py_sigs, '.js': js_sigs, '.ts': lambda s: js_sigs(s, "typescript"), '.jsx': js_sigs, 
             '.tsx': lambda s: js_sigs(s, "typescript"), '.java': java_sigs, '.rs': rust_sigs, 
             '.cs': csharp_sigs, '.css': css_selectors, '.go': go_sigs, '.rb': ruby_sigs,
             '.php': php_sigs, '.kt': kotlin_sigs, '.kts': kotlin_sigs, '.swift': swift_sigs, '.lua': lua_sigs}

# %% ../nbs/00_core.ipynb #6244c5c8
def ext_sigs(src, ext):
    "Read retrieve signatures for `src` based on suitable langage for `ext`"
    if not ext.startswith('.'): ext = '.'+ext
    fn = _sigs_fns.get(ext)
    return [] if fn is None else fn(src)

# %% ../nbs/00_core.ipynb #69100796
def file_sigs(fname):
    "Read file content and retrieve signatures"
    fname = Path(fname).expanduser()
    return ext_sigs(fname.read_text(), fname.suffix)
