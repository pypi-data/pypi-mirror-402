#
# SQL queries for DjVu files of
# Genealogie Wiki https://wiki.genealogy.net
# WF 2025-02-28
#


# Gesamtanzahl der Dateien und Seiten ermitteln
'total':
  param_list:
  sql: |
    SELECT
      count(*) as files,
      sum(page_count) as pages
    FROM DjVu

# Bilder nach DPI zählen
'dpi':
  param_list:
  sql: |
    SELECT count(*), dpi
    FROM Page
    GROUP BY dpi

# Seitenanzahl-Informationen
'page_and_size':
  param_list:
  sql: |
    SELECT
      path,
      page_count,
      filesize
    FROM DjVu
    ORDER BY page_count DESC,filesize DESC

# Sizes and compression ratio for bundled files
'bundled_sizes_and_ratio':
  param_list:
  sql: |
    SELECT
      ROUND(SUM(filesize)/1024/1024/1024.0, 1) AS total_djvu_gb,
      ROUND(SUM(package_filesize)/1024/1024/1024.0, 1) AS total_package_gb,
      ROUND(CAST(SUM(package_filesize) AS REAL) / SUM(filesize), 1) AS average_ratio
    FROM DjVu
    WHERE bundled = 1

# Alle DjVu-Datensätze abrufen
'all_djvu':
  param_list:
    - name: limit
      type: int
      default_value: 10000
  sql: |
    SELECT
      *
    FROM DjVu
    ORDER BY page_count
    LIMIT {{ limit }}

# Einen DjVu-Datensatz für einen path abrufen
'djvu_for_path':
  param_list:
    - name: path
      type: str
      default_value: "/images/1/1e/AB1953-Gohr.djvu"
  sql: |
    SELECT
      *
    FROM DjVu
    WHERE path= "{{ path }}"

# Alle Bild-Datensätze mit konfigurierbarem Limit abrufen
'all_pages':
  param_list:
    - name: limit
      type: int
      default_value: 50
  sql: |
    SELECT
      *
    FROM page
    ORDER BY path
    LIMIT {{ limit }}

 # Alle Bild-Datensätze für einen Pfad mit konfigurierbarem Limit abrufen
'all_pages_for_path':
  param_list:
    - name: limit
      type: int
      default_value: 50
    - name: djvu_path
      type: str
      default_value: "/images/1/1e/AB1953-Gohr.djvu"
  sql: |
    SELECT
      *
    FROM page
    WHERE djvu_path= "{{ djvu_path }}"
    ORDER BY page_index
    LIMIT {{ limit }}

# Seiten nach DjVu-Pfad abrufen
'pages_of_djvu':
  param_list:
    - name: djvu_path
      type: text
      default_value: /images//a/a1/Treuen-Vogtland-AB-1905.djvu
  sql: |
    SELECT
      *
    FROM page
    WHERE djvu_path = "{{ djvu_path }}"
    ORDER BY page_index

# Gültige und ungültige Seiten pro DjVu zählen
'djvu_by_valid_pages':
  param_list:
  sql: |
    SELECT
      djvu_path,
      COUNT(*) as total_pages,
      SUM(CASE WHEN valid THEN 1 ELSE 0 END) as valid_pages,
      SUM(CASE WHEN NOT valid THEN 1 ELSE 0 END) as invalid_pages
    FROM page
    GROUP BY djvu_path
    ORDER BY valid_pages DESC