# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto #0
__all__ = ['emoji_map', 'Subscript', 'Superscript', 'Highlight', 'Emoji', 'FootnoteEntry', 'FootnoteRef', 'Strikethrough',
           'AutoLink', 'ExtendedHtmlRenderer', 'parse_attrs']

# %% ../nbs/00_core.ipynb #4be85a97
from fastcore.utils import *

import re
from mistletoe import Document
from mistletoe.html_renderer import HtmlRenderer
from mistletoe.span_token import SpanToken
from mistletoe.block_token import BlockToken

# %% ../nbs/00_core.ipynb #0d4a8105
class Subscript(SpanToken):
    pattern = re.compile(r"~([^~\s]+)~")
    parse_inner = False
    def __init__(self, match): self.content = match.group(1)

class Superscript(SpanToken):
    pattern = re.compile(r"\^([^\^\s]+)\^")
    parse_inner = False
    def __init__(self, match): self.content = match.group(1)

class Highlight(SpanToken):
    pattern = re.compile(r"==([^=]+)==")
    parse_inner = True
    def __init__(self, match): pass

# %% ../nbs/00_core.ipynb #d6a10481
emoji_map = {
    ':smile:':'ğŸ˜Š', ':laughing:':'ğŸ˜†', ':joy:':'ğŸ˜‚', ':grin:':'ğŸ˜', ':wink:':'ğŸ˜‰',
    ':heart:':'â¤ï¸', ':blue_heart:':'ğŸ’™', ':green_heart:':'ğŸ’š', ':yellow_heart:':'ğŸ’›', ':purple_heart:':'ğŸ’œ',
    ':thumbsup:':'ğŸ‘', ':thumbsdown:':'ğŸ‘', ':clap:':'ğŸ‘', ':wave:':'ğŸ‘‹', ':raised_hands:':'ğŸ™Œ',
    ':rocket:':'ğŸš€', ':fire:':'ğŸ”¥', ':star:':'â­', ':sparkles:':'âœ¨', ':zap:':'âš¡',
    ':check:':'âœ“', ':x:':'âœ—', ':warning:':'âš ï¸', ':no_entry:':'â›”', ':white_check_mark:':'âœ…',
    ':eyes:':'ğŸ‘€', ':thinking:':'ğŸ¤”', ':tada:':'ğŸ‰', ':100:':'ğŸ’¯', ':muscle:':'ğŸ’ª',
    ':pray:':'ğŸ™', ':ok_hand:':'ğŸ‘Œ', ':point_right:':'ğŸ‘‰', ':point_left:':'ğŸ‘ˆ',
    ':bug:':'ğŸ›', ':construction:':'ğŸš§', ':pencil:':'âœï¸', ':memo:':'ğŸ“', ':books:':'ğŸ“š',
    ':bulb:':'ğŸ’¡', ':gear:':'âš™ï¸', ':link:':'ğŸ”—', ':lock:':'ğŸ”’', ':key:':'ğŸ”‘',
    ':package:':'ğŸ“¦', ':inbox_tray:':'ğŸ“¥', ':outbox_tray:':'ğŸ“¤', ':email:':'ğŸ“§',
    ':camera:':'ğŸ“·', ':computer:':'ğŸ’»', ':iphone:':'ğŸ“±', ':hourglass:':'â³',
    ':sunny:':'â˜€ï¸', ':cloud:':'â˜ï¸', ':umbrella:':'â˜‚ï¸', ':snowflake:':'â„ï¸',
    ':pizza:':'ğŸ•', ':coffee:':'â˜•', ':beer:':'ğŸº', ':cake:':'ğŸ°',
    ':cat:':'ğŸ±', ':dog:':'ğŸ¶', ':whale:':'ğŸ³', ':snake:':'ğŸ'
}

class Emoji(SpanToken):
    pattern = re.compile(r':(\w+):')
    parse_inner = False
    def __init__(self, match): self.name = match.group(1)

# %% ../nbs/00_core.ipynb #8e730486
class FootnoteEntry(BlockToken):
    @staticmethod
    def start(line): return line.startswith('[^') and ']: ' in line
    
    @staticmethod
    def read(lines):
        line = next(lines)
        match = re.match(r'^\[\^(\w+)\]: (.+)$', line)
        return match
    
    def __init__(self, match):
        self.label = match.group(1)
        self.content = match.group(2)
        self.children = []

class FootnoteRef(SpanToken):
    pattern = re.compile(r'\[\^(\w+)\]')
    parse_inner = False
    def __init__(self, match): self.label = match.group(1)

# %% ../nbs/00_core.ipynb #37d30cba
class Strikethrough(SpanToken):
    pattern = re.compile(r'~~([^~]+)~~')
    parse_inner = True
    def __init__(self, match): pass

class AutoLink(SpanToken):
    pattern = re.compile(r'(?<!\()(https?://[^\s<>]+)')
    parse_inner = False
    precedence = 6
    def __init__(self, match): self.url = match.group(1)

# %% ../nbs/00_core.ipynb #be9bbac9
class ExtendedHtmlRenderer(HtmlRenderer):
    def __init__(self, *args, **kwargs): 
        super().__init__(Subscript, Superscript, Highlight, Emoji, FootnoteRef, FootnoteEntry, Strikethrough, AutoLink, *args, **kwargs)
        self.footnotes = {}
    def render_subscript(self, token): return f'<sub>{token.content}</sub>'
    def render_superscript(self, token): return f'<sup>{token.content}</sup>'
    def render_highlight(self, token): return f'<mark>{self.render_inner(token)}</mark>'
    def render_strikethrough(self, token): return f'<del>{self.render_inner(token)}</del>'
    def render_emoji(self, token): return emoji_map.get(f':{token.name}:', f':{token.name}:')
    def render_auto_link(self, token): return f'<a href="{token.url}">{token.url}</a>'
    def render_footnote_ref(self, token): 
        return f'<sup><a href="#fn-{token.label}" id="fnref-{token.label}">[{token.label}]</a></sup>'
    def render_footnote_entry(self, token):
        return f'<div id="fn-{token.label}" class="footnote"><sup>{token.label}</sup> {token.content} <a href="#fnref-{token.label}">â†©</a></div>\n'
    def render_list_item(self, token):
        inner = self.render_inner(token)
        match = re.match(r'\[( |x|X)\] ', inner)
        if not match: return f'<li>{inner}</li>\n'
        checked = 'checked' if match.group(1).lower() == 'x' else ''
        checkbox = f'<input type="checkbox" disabled {checked}>'
        content = inner[match.end():]
        return f'<li>{checkbox} {content}</li>\n'

# %% ../nbs/00_core.ipynb #5768db34
def parse_attrs(text):
    if not text: return ''
    pattern = r'#([^}\s]+)|\.([^}\s]+)|([\w-]+)="([^"]*)"'
    id_,classes,attrs = '',[],{}
    for match in re.finditer(pattern, text):
        id_m,cls,key,val = match.groups()
        if id_m: id_ = id_m
        elif cls: classes.append(cls)
        elif key: attrs[key] = val
    parts = []
    if id_: parts.append(f'id="{id_}"')
    if classes: parts.append(f'class="{" ".join(classes)}"')
    for k,v in attrs.items(): parts.append(f'{k}="{v}"')
    return ' ' + ' '.join(parts) if parts else ''

# %% ../nbs/00_core.ipynb #eeb3170d
@patch
def render_heading(self:ExtendedHtmlRenderer, token):
    inner = self.render_inner(token)
    attr_match = re.search(r'\s*\{([^}]+)\}$', inner)
    if attr_match:
        attrs = parse_attrs(attr_match.group(0))
        inner = inner[:attr_match.start()]
        return f'<h{token.level}{attrs}>{inner}</h{token.level}>'
    return f'<h{token.level}>{inner}</h{token.level}>'
