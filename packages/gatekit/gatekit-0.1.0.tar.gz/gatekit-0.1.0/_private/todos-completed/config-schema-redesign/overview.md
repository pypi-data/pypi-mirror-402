# Configuration Schema Redesign

## Problem Statement

The current plugin configuration schema system has fundamental limitations that prevent the TUI from properly serializing configurations back to YAML:

1. **Complex type unions** (`oneOf`) - The tool_manager's `allow` field can contain mixed types (strings and objects), which the TUI cannot properly handle
2. **Dynamic keys** (`additionalProperties`) - Objects with arbitrary keys cannot be represented in forms
3. **Missing serialization metadata** - Schemas describe validation but not how to structure the output

## Key Insight

We've been optimizing YAML configuration for human readability, but in reality:
- Configs are too complex for manual editing (hence why we built the TUI)
- Configs will primarily be generated by either the TUI or AI assistants
- Users will rarely look at raw config files

**Therefore: We should optimize for machine-friendliness, not human aesthetics.**

## Proposed Solution: Adopt JSON Schema Standard

Instead of our custom schema format, adopt the industry-standard JSON Schema specification.

### Benefits

1. **Massive ecosystem**:
   - Validation libraries in every language
   - IDE autocomplete support (VSCode, IntelliJ, etc.)
   - Documentation generators
   - Form generators for TUI
   - CLI validation tools

2. **No custom code**:
   - Remove our schema.py validation logic
   - Use jsonschema library for validation
   - Leverage existing tools instead of building our own

3. **User familiarity**:
   - Industry standard that developers recognize
   - Extensive documentation already exists
   - Can tell users "it's just JSON Schema"

### Implementation Approach

1. **Restructure problematic patterns**:
   - Convert mixed-type arrays to homogeneous structures
   - Replace dynamic keys with explicit fields
   - Flatten nested structures where possible

2. **Add JSON Schema references**:
   ```yaml
   # In config file
   # yaml-language-server: $schema=./schemas/gatekit.json
   tool_manager:
     rules: [...]
   ```

3. **Generate schemas from plugins**:
   ```python
   class ToolManagerPlugin:
       @classmethod
       def get_json_schema(cls):
           return {
               "$schema": "http://json-schema.org/draft-07/schema#",
               "type": "object",
               "properties": {...}
           }
   ```

## Example: Tool Manager Redesign

### Current (Human-Optimized)
```yaml
allow:
  - read_file
  - execute:
      name: execute_sql_query
      description: "SQL only"
```

Problems:
- Mixed types in array
- Dynamic object keys
- Complex to validate and serialize

### Proposed (Machine-Optimized)
```yaml
tool_policies:
  - name: read_file
    action: allow
    
  - name: execute
    action: allow
    display_name: execute_sql_query
    display_description: "SQL only"
```

Benefits:
- Homogeneous array structure
- All fields explicit
- Simple to validate and serialize
- TUI can easily generate forms

## Next Steps

1. Analyze all existing plugins for schema compatibility issues
2. Design standardized patterns for common configurations
3. Create migration path from current to new format
4. Update plugin base classes to support JSON Schema
5. Integrate JSON Schema validation into the pipeline

## Open Questions

1. Should we support both old and new formats during transition?
2. How do we handle plugin-specific validation logic that goes beyond schema?
3. Should we generate TypeScript types from schemas for better tooling?
4. Do we need to maintain backward compatibility for v0.1.x?

## References

- JSON Schema Specification: https://json-schema.org/
- JSON Schema Python library: https://python-jsonschema.readthedocs.io/
- VSCode YAML extension: https://marketplace.visualstudio.com/items?itemName=redhat.vscode-yaml
- JSON Schema to Form generators: https://github.com/rjsf-team/react-jsonschema-form
