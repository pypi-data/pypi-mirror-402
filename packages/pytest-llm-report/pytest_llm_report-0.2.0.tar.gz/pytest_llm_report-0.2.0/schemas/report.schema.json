{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://github.com/palakpsheth/pytest-llm-report/schemas/report.schema.json",
    "title": "pytest-llm-report Report Schema",
    "description": "JSON schema for pytest-llm-report output files",
    "type": "object",
    "required": [
        "schema_version",
        "run_meta",
        "summary",
        "tests"
    ],
    "properties": {
        "schema_version": {
            "type": "string",
            "description": "Schema version (semver format)",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "run_meta": {
            "$ref": "#/$defs/RunMeta"
        },
        "summary": {
            "$ref": "#/$defs/Summary"
        },
        "tests": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/TestCaseResult"
            }
        },
        "collection_errors": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/CollectionError"
            }
        },
        "warnings": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/ReportWarning"
            }
        },
        "artifacts": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/ArtifactEntry"
            }
        },
        "source_coverage": {
            "type": "array",
            "items": {
                "$ref": "#/$defs/SourceCoverageEntry"
            }
        },
        "custom_metadata": {
            "type": "object",
            "description": "User-provided custom metadata"
        },
        "sha256": {
            "type": "string",
            "description": "SHA256 hash of this report (computed after serialization)"
        },
        "hmac_signature": {
            "type": "string",
            "description": "Optional HMAC signature for tamper evidence"
        }
    },
    "$defs": {
        "RunMeta": {
            "type": "object",
            "required": [
                "start_time",
                "end_time",
                "duration",
                "pytest_version",
                "plugin_version",
                "python_version",
                "platform",
                "exit_code"
            ],
            "properties": {
                "start_time": {
                    "type": "string",
                    "format": "date-time"
                },
                "end_time": {
                    "type": "string",
                    "format": "date-time"
                },
                "duration": {
                    "type": "number"
                },
                "pytest_version": {
                    "type": "string"
                },
                "plugin_version": {
                    "type": "string"
                },
                "python_version": {
                    "type": "string"
                },
                "platform": {
                    "type": "string"
                },
                "git_sha": {
                    "type": "string"
                },
                "git_dirty": {
                    "type": "boolean"
                },
                "config_hash": {
                    "type": "string"
                },
                "pytest_invocation": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Sanitized pytest command line arguments"
                },
                "pytest_config_summary": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Sanitized pytest ini options"
                },
                "exit_code": {
                    "type": "integer"
                },
                "interrupted": {
                    "type": "boolean"
                },
                "collect_only": {
                    "type": "boolean"
                },
                "collected_count": {
                    "type": "integer"
                },
                "selected_count": {
                    "type": "integer"
                },
                "deselected_count": {
                    "type": "integer"
                },
                "rerun_count": {
                    "type": "integer"
                },
                "run_id": {
                    "type": "string"
                },
                "run_group_id": {
                    "type": "string"
                },
                "is_aggregated": {
                    "type": "boolean"
                },
                "aggregation_policy": {
                    "type": "string",
                    "enum": [
                        "latest",
                        "merge",
                        "all"
                    ]
                },
                "run_count": {
                    "type": "integer"
                },
                "source_reports": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/SourceReport"
                    }
                }
            }
        },
        "SourceReport": {
            "type": "object",
            "required": [
                "path",
                "sha256"
            ],
            "properties": {
                "path": {
                    "type": "string"
                },
                "sha256": {
                    "type": "string"
                },
                "run_id": {
                    "type": "string"
                }
            }
        },
        "Summary": {
            "type": "object",
            "required": [
                "total",
                "passed",
                "failed",
                "skipped",
                "xfailed",
                "xpassed",
                "error",
                "total_duration"
            ],
            "properties": {
                "total": {
                    "type": "integer"
                },
                "passed": {
                    "type": "integer"
                },
                "failed": {
                    "type": "integer"
                },
                "skipped": {
                    "type": "integer"
                },
                "xfailed": {
                    "type": "integer"
                },
                "xpassed": {
                    "type": "integer"
                },
                "error": {
                    "type": "integer"
                },
                "total_duration": {
                    "type": "number"
                },
                "coverage_total_percent": {
                    "type": "number",
                    "description": "Total coverage percentage (if available)"
                }
            }
        },
        "TestCaseResult": {
            "type": "object",
            "required": [
                "nodeid",
                "outcome",
                "duration",
                "phase"
            ],
            "properties": {
                "nodeid": {
                    "type": "string"
                },
                "outcome": {
                    "type": "string",
                    "enum": [
                        "passed",
                        "failed",
                        "skipped",
                        "xfailed",
                        "xpassed",
                        "error"
                    ]
                },
                "duration": {
                    "type": "number"
                },
                "phase": {
                    "type": "string",
                    "enum": [
                        "setup",
                        "call",
                        "teardown"
                    ]
                },
                "error_message": {
                    "type": "string"
                },
                "param_id": {
                    "type": "string"
                },
                "param_summary": {
                    "type": "string"
                },
                "rerun_count": {
                    "type": "integer"
                },
                "final_outcome": {
                    "type": "string"
                },
                "coverage": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/CoverageEntry"
                    }
                },
                "llm_annotation": {
                    "$ref": "#/$defs/LlmAnnotation"
                },
                "llm_opt_out": {
                    "type": "boolean"
                },
                "llm_context_override": {
                    "type": "string",
                    "enum": [
                        "minimal",
                        "balanced",
                        "complete"
                    ]
                },
                "captured_stdout": {
                    "type": "string"
                },
                "captured_stderr": {
                    "type": "string"
                },
                "requirements": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "CoverageEntry": {
            "type": "object",
            "required": [
                "file_path",
                "line_ranges",
                "line_count"
            ],
            "properties": {
                "file_path": {
                    "type": "string"
                },
                "line_ranges": {
                    "type": "string"
                },
                "line_count": {
                    "type": "integer"
                }
            }
        },
        "SourceCoverageEntry": {
            "type": "object",
            "required": [
                "file_path",
                "statements",
                "missed",
                "covered",
                "coverage_percent",
                "covered_ranges",
                "missed_ranges"
            ],
            "properties": {
                "file_path": {
                    "type": "string"
                },
                "statements": {
                    "type": "integer"
                },
                "missed": {
                    "type": "integer"
                },
                "covered": {
                    "type": "integer"
                },
                "coverage_percent": {
                    "type": "number"
                },
                "covered_ranges": {
                    "type": "string"
                },
                "missed_ranges": {
                    "type": "string"
                }
            }
        },
        "LlmAnnotation": {
            "type": "object",
            "required": [
                "scenario",
                "why_needed",
                "key_assertions"
            ],
            "properties": {
                "scenario": {
                    "type": "string"
                },
                "why_needed": {
                    "type": "string"
                },
                "key_assertions": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "confidence": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                },
                "error": {
                    "type": "string"
                },
                "context_summary": {
                    "type": "object",
                    "properties": {
                        "mode": {
                            "type": "string"
                        },
                        "included_files": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "bytes": {
                            "type": "integer"
                        },
                        "truncated": {
                            "type": "boolean"
                        }
                    }
                }
            }
        },
        "CollectionError": {
            "type": "object",
            "required": [
                "nodeid",
                "message"
            ],
            "properties": {
                "nodeid": {
                    "type": "string"
                },
                "message": {
                    "type": "string"
                }
            }
        },
        "ReportWarning": {
            "type": "object",
            "required": [
                "code",
                "message"
            ],
            "properties": {
                "code": {
                    "type": "string"
                },
                "message": {
                    "type": "string"
                },
                "detail": {
                    "type": "string"
                }
            }
        },
        "ArtifactEntry": {
            "type": "object",
            "required": [
                "path",
                "sha256",
                "size_bytes"
            ],
            "properties": {
                "path": {
                    "type": "string"
                },
                "sha256": {
                    "type": "string"
                },
                "size_bytes": {
                    "type": "integer"
                }
            }
        }
    }
}
