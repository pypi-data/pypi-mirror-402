---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: github2gerrit
description: "Creates Gerrit changes from GitHub pull requests"

inputs:
  # Optional
  GERRIT_SSH_PRIVKEY_G2G:
    description: "SSH private key content used to authenticate to Gerrit"
    required: true
  SUBMIT_SINGLE_COMMITS:
    description: "Submit one commit at a time to the Gerrit repository"
    required: false
    default: "false"
  USE_PR_AS_COMMIT:
    description: "Use PR title and body as the commit message"
    required: false
    default: "false"
  FETCH_DEPTH:
    description: "Fetch depth for checkout"
    required: false
    default: "10"
  PR_NUMBER:
    description: "Pull request number to process, use 0 to process all open"
    required: false
    default: "0"
  GERRIT_KNOWN_HOSTS:
    description: "Known hosts entries for Gerrit SSH (single or multi-line)"
    required: false
  GERRIT_SSH_USER_G2G:
    description: "Gerrit SSH username; derived if not supplied explicitly"
    required: false
    default: ""
  GERRIT_SSH_USER_G2G_EMAIL:
    description: "Gerrit user email address; derived if not supplied explicitly"
    required: false
    default: ""
  ORGANIZATION:
    description: "GitHub organization/owner (defaults to repo owner)"
    required: false
    default: "${{ github.repository_owner }}"
  REVIEWERS_EMAIL:
    description: "Comma-separated list of reviewer emails (optional)"
    required: false
    default: ""
  ALLOW_GHE_URLS:
    description: "Allow GitHub Enterprise URLs in direct URL mode"
    required: false
    default: "false"
  PRESERVE_GITHUB_PRS:
    description: "Do not close GitHub PRs after pushing to Gerrit"
    required: false
    default: "true"
  CLOSE_MERGED_PRS:
    description: "Close GitHub PRs when corresponding Gerrit changes are merged"
    required: false
    default: "true"
  DRY_RUN:
    description: "Validate settings/PR metadata; do not write to Gerrit"
    required: false
    default: "false"
  ALLOW_DUPLICATES:
    description: "Allow submitting duplicate changes without error"
    required: false
    default: "true"
  CI_TESTING:
    description: "Enable CI testing mode; overrides .gitreview, creates orphan commits"
    required: false
    default: "false"
  FORCE:
    description: "Force PR closure regardless of Gerrit change status (abandoned, etc)"
    required: false
    default: "false"
  ISSUE_ID:
    description: "Issue ID to include (e.g., ABC-123)"
    required: false
    default: ""
  USE_LOCAL_ACTION:
    description: >-
      Use local repository action/code instead of the PyPI package.
      Set to 'true' when testing changes in a fork or branch before merging.
    required: false
    default: "false"
  G2G_USE_SSH_AGENT:
    description: "Use SSH agent for authentication instead of file-based keys (recommended)"
    required: false
    default: "true"
  DUPLICATE_TYPES:
    description: "Comma-separated Gerrit states for evaluating duplicates"
    required: false
    default: "open"
  NORMALISE_COMMIT:
    description: "Normalize commit messages to conventional commit format"
    required: false
    default: "false"
  VERBOSE:
    description: "Enable verbose output (sets log level to DEBUG)"
    required: false
    default: "false"
  GERRIT_SERVER:
    description: "Gerrit server hostname; derived if not supplied explicitly"
    required: false
    default: ""
  GERRIT_SERVER_PORT:
    description: "Gerrit serverSSH TCP/port"
    required: false
    default: "29418"
  GERRIT_PROJECT:
    description: "Gerrit project; optional if .gitreview exists"
    required: false
    default: ""
  GERRIT_HTTP_BASE_PATH:
    description: "Optional HTTP base path for Gerrit REST (e.g. /r)"
    required: false
    default: ""
  GERRIT_HTTP_USER:
    description: "Optional Gerrit HTTP user (for REST authenticated checks)"
    required: false
    default: ""
  GERRIT_HTTP_PASSWORD:
    description: "Optional Gerrit HTTP password/token (for REST authentication)"
    required: false
    default: ""
  ISSUE_ID_LOOKUP_JSON:
    description: >-
      JSON array mapping GitHub actors to Issue IDs
      (format: [{"key": "username", "value": "ISSUE-ID"}])
    required: false
    default: "[]"
  AUTOMATION_ONLY:
    description: "Only accept pull requests from known automation tools"
    required: false
    default: "true"
  CLEANUP_ABANDONED:
    description: "Close GitHub PRs when their Gerrit changes are abandoned"
    required: false
    default: "true"
  CLEANUP_GERRIT:
    description: "Abandon Gerrit changes when their GitHub PRs are closed"
    required: false
    default: "true"

outputs:
  gerrit_change_request_url:
    description: "Gerrit change URL(s) (newline-separated if multiple)"
    value: ${{ steps.capture-outputs.outputs.gerrit_change_request_url }}
  gerrit_change_request_num:
    description: "Gerrit change number(s) (newline-separated if multiple)"
    value: ${{ steps.capture-outputs.outputs.gerrit_change_request_num }}
  gerrit_commit_sha:
    description: "Patch set commit sha(s) (newline-separated if multiple)"
    value: ${{ steps.capture-outputs.outputs.gerrit_commit_sha }}

runs:
  using: "composite"
  steps:
    - name: "Setup Python"
      # yamllint disable-line rule:line-length
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
      with:
        python-version-file: '${{ github.action_path }}/pyproject.toml'

    - name: "Setup uv"
      # yamllint disable-line rule:line-length
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b  # v7.2.0
      with:
        enable-cache: false

    - name: "Checkout repository"
      # yamllint disable-line rule:line-length
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      with:
        fetch-depth: ${{ inputs.FETCH_DEPTH }}
        # Ensure we are on the PR's head SHA when triggered by PR events
        ref: ${{ github.event.pull_request.head.sha || github.sha }}

    - name: "Setup github2gerrit"
      shell: bash
      env:
        # Provide version for hatch-vcs (via setuptools-scm)
        # when git metadata is unavailable
        # GitHub Actions shallow checkout doesn't include .git history
        SETUPTOOLS_SCM_PRETEND_VERSION: "0.0.0+dev"
      run: |
        # Setup github2gerrit
        set -euo pipefail
        uv --version
        # Install locally for self-testing, use uvx for external repos
        if [[ "${{ inputs.USE_LOCAL_ACTION }}" == "true" ]] || \
           [[ "${{ github.repository }}" =~ lfreleng-actions/github2gerrit-action ]]; then
          echo "Installing with: uv pip install --system ${{ github.action_path }}"
          uv pip install --system ${{ github.action_path }}
        else
          echo "uvx will install GitHub2Gerrit from PyPI"
        fi

    - name: "Validate PR_NUMBER usage"
      # yamllint disable-line rule:line-length
      if: ${{ github.event_name != 'workflow_dispatch' && inputs.PR_NUMBER != '' && inputs.PR_NUMBER != '0' }}
      shell: bash
      run: |
        # Validate PR_NUMBER usage
        set -euo pipefail
        echo "Error: PR_NUMBER only valid during workflow_dispatch events."
        exit 2

    - name: "Normalize PR_NUMBER"
      if: ${{ github.event_name == 'workflow_dispatch' }}
      shell: bash
      run: |
        # Normalize PR_NUMBER
        set -euo pipefail
        pr_in="${{ inputs.PR_NUMBER }}"
        if [[ -z "${pr_in}" || "${pr_in}" == "null" ]]; then
          pr_in="0"
        fi
        if ! [[ "${pr_in}" =~ ^[0-9]+$ ]]; then
          echo "Error: PR_NUMBER must be a numeric value"
          exit 2
        fi
        if [[ "${pr_in}" == "0" ]]; then
          echo "SYNC_ALL_OPEN_PRS=true" >> "$GITHUB_ENV"
        else
          echo "PR_NUMBER=${pr_in}" >> "$GITHUB_ENV"
        fi

    - name: "Extract PR number, validate context"
      shell: bash
      run: |
        # Extract PR number, validate context
        set -euo pipefail

        # Push events don't need PR_NUMBER (used for closing merged PRs)
        # The CLI handles push events specially via _process_close_merged_prs()
        if [[ "${{ github.event_name }}" == "push" ]]; then
          echo "Push event detected - will process merged commits for PR closure"
          # Set PR_NUMBER to empty to indicate this is intentional for push events
          echo "PR_NUMBER=" >> "$GITHUB_ENV"
          exit 0
        fi

        # Honor PR_NUMBER or SYNC_ALL_OPEN_PRS set by workflow_dispatch
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ -n "${SYNC_ALL_OPEN_PRS:-}" ]]; then
            echo "Processing all open pull requests via workflow_dispatch."
          else
            if [[ -z "${PR_NUMBER:-}" || "${PR_NUMBER}" == "null" ]]; then
              echo "Error: provide PR_NUMBER or set 0 to process all PRs."
              exit 2
            fi
            echo "PR_NUMBER=${PR_NUMBER}" >> "$GITHUB_ENV"
          fi
        else
          PR_NUMBER_EVT="${{ github.event.pull_request.number || github.event.issue.number || '' }}"
          # Do not override PR_NUMBER if previously set
          if [[ -z "${PR_NUMBER:-}" ]]; then
            PR_NUMBER="${PR_NUMBER_EVT}"
            echo "PR_NUMBER=${PR_NUMBER}" >> "$GITHUB_ENV"
          fi
          if [[ -z "${PR_NUMBER}" || "${PR_NUMBER}" == "null" ]]; then
            echo "Error: PR_NUMBER is empty."
            echo "This action requires a valid pull request context."
            echo "Current event: ${{ github.event_name }}"
            exit 2
          fi
        fi

    - name: "Run github2gerrit Python CLI"
      id: run-cli
      shell: bash
      env:
        # GitHub token for API access
        GITHUB_TOKEN: ${{ github.token }}

        # Primary inputs
        SUBMIT_SINGLE_COMMITS: ${{ inputs.SUBMIT_SINGLE_COMMITS }}
        USE_PR_AS_COMMIT: ${{ inputs.USE_PR_AS_COMMIT }}
        FETCH_DEPTH: ${{ inputs.FETCH_DEPTH }}
        GERRIT_KNOWN_HOSTS: ${{ inputs.GERRIT_KNOWN_HOSTS }}
        GERRIT_SSH_PRIVKEY_G2G: ${{ inputs.GERRIT_SSH_PRIVKEY_G2G }}
        GERRIT_SSH_USER_G2G: ${{ inputs.GERRIT_SSH_USER_G2G }}
        GERRIT_SSH_USER_G2G_EMAIL: ${{ inputs.GERRIT_SSH_USER_G2G_EMAIL }}
        ORGANIZATION: ${{ inputs.ORGANIZATION }}
        REVIEWERS_EMAIL: ${{ inputs.REVIEWERS_EMAIL }}
        ALLOW_GHE_URLS: ${{ inputs.ALLOW_GHE_URLS }}
        PRESERVE_GITHUB_PRS: ${{ inputs.PRESERVE_GITHUB_PRS }}
        DRY_RUN: ${{ inputs.DRY_RUN }}
        ALLOW_DUPLICATES: ${{ inputs.ALLOW_DUPLICATES }}
        ISSUE_ID: ${{ inputs.ISSUE_ID }}
        ISSUE_ID_LOOKUP_JSON: ${{ inputs.ISSUE_ID_LOOKUP_JSON }}
        CI_TESTING: ${{ inputs.CI_TESTING }}
        CLOSE_MERGED_PRS: ${{ inputs.CLOSE_MERGED_PRS }}
        FORCE: ${{ inputs.FORCE }}
        DUPLICATE_TYPES: ${{ inputs.DUPLICATE_TYPES }}
        NORMALISE_COMMIT: ${{ inputs.NORMALISE_COMMIT }}
        G2G_USE_SSH_AGENT: ${{ inputs.G2G_USE_SSH_AGENT }}
        G2G_VERBOSE: ${{ inputs.VERBOSE }}
        AUTOMATION_ONLY: ${{ inputs.AUTOMATION_ONLY }}
        CLEANUP_ABANDONED: ${{ inputs.CLEANUP_ABANDONED }}
        CLEANUP_GERRIT: ${{ inputs.CLEANUP_GERRIT }}

        # Optional Gerrit overrides (when .gitreview is missing)
        GERRIT_SERVER: ${{ inputs.GERRIT_SERVER }}
        GERRIT_SERVER_PORT: ${{ inputs.GERRIT_SERVER_PORT }}
        GERRIT_PROJECT: ${{ inputs.GERRIT_PROJECT }}

        # Optional REST path/creds (non-fatal in dry-run)
        GERRIT_HTTP_BASE_PATH: ${{ inputs.GERRIT_HTTP_BASE_PATH }}
        GERRIT_HTTP_USER: ${{ inputs.GERRIT_HTTP_USER }}
        GERRIT_HTTP_PASSWORD: ${{ inputs.GERRIT_HTTP_PASSWORD }}

        # Pass-through GitHub context used by the CLI
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_BASE_REF: ${{ github.base_ref }}
        GITHUB_HEAD_REF: ${{ github.head_ref }}
        GITHUB_ACTOR: ${{ github.actor }}
        SYNC_ALL_OPEN_PRS: ${{ env.SYNC_ALL_OPEN_PRS }}
        PR_NUMBER: ${{ env.PR_NUMBER }}
        G2G_TEST_MODE: "false"
      run: |
        # Run github2gerrit Python CLI
        set -euo pipefail
        # Use different invocation methods based on repository or USE_LOCAL_ACTION flag
        if [[ "${{ inputs.USE_LOCAL_ACTION }}" == "true" ]] || \
           [[ "${{ github.repository }}" =~ lfreleng-actions/github2gerrit-action ]]; then
          echo "Running:python -m github2gerrit.cli"
          python -m github2gerrit.cli
        else
          echo "Running: uvx --from github2gerrit github2gerrit"
          uvx --from github2gerrit github2gerrit
        fi

    - name: "Capture outputs"
      id: capture-outputs
      shell: bash
      # yamllint disable rule:line-length
      run: |
        # Capture outputs
        set -euo pipefail
        # Use GitHub Actions multiline output format
        {
          echo "gerrit_change_request_url<<G2G"
          printf '%s\n' "${GERRIT_CHANGE_REQUEST_URL:-}"
          echo "G2G"
          echo "gerrit_change_request_num<<G2G"
          printf '%s\n' "${GERRIT_CHANGE_REQUEST_NUM:-}"
          echo "G2G"
          echo "gerrit_commit_sha<<G2G"
          printf '%s\n' "${GERRIT_COMMIT_SHA:-}"
          echo "G2G"
        } >> "$GITHUB_OUTPUT"
