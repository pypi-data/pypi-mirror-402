# Generated by Django 5.1.14 on 2026-01-18 04:22

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("django_forms_workflows", "0007_add_userprofile_ldap_enhancements"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name="FileUploadConfig",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        help_text="Display name for this configuration",
                        max_length=200,
                        unique=True,
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True,
                        help_text="Description of this file upload configuration",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True, help_text="Whether this configuration is active"
                    ),
                ),
                (
                    "naming_pattern",
                    models.CharField(
                        default="{user.username}_{field_name}_{datetime}.{ext}",
                        help_text="File naming pattern. Tokens: {user.id}, {user.username}, {user.employee_id}, {field_name}, {form_slug}, {submission_id}, {status}, {date}, {datetime}, {original_name}, {ext}",
                        max_length=500,
                    ),
                ),
                (
                    "pending_prefix",
                    models.CharField(
                        blank=True,
                        default="pending_",
                        help_text="Prefix to add to pending files",
                        max_length=100,
                    ),
                ),
                (
                    "approved_prefix",
                    models.CharField(
                        blank=True,
                        default="",
                        help_text="Prefix to add to approved files (empty means no prefix)",
                        max_length=100,
                    ),
                ),
                (
                    "rejected_prefix",
                    models.CharField(
                        blank=True,
                        default="rejected_",
                        help_text="Prefix to add to rejected files",
                        max_length=100,
                    ),
                ),
                (
                    "upload_to",
                    models.CharField(
                        default="form_uploads/{form_slug}/{user.username}/",
                        help_text="Upload directory pattern. Supports same tokens as naming_pattern.",
                        max_length=500,
                    ),
                ),
                (
                    "approved_storage_path",
                    models.CharField(
                        blank=True,
                        help_text="Move approved files to this path. Leave empty to keep in place.",
                        max_length=500,
                    ),
                ),
                (
                    "rejected_storage_path",
                    models.CharField(
                        blank=True,
                        help_text="Move rejected files to this path. Leave empty to keep in place.",
                        max_length=500,
                    ),
                ),
                (
                    "allowed_extensions",
                    models.CharField(
                        blank=True,
                        help_text="Comma-separated: pdf,doc,docx,xls,xlsx. Leave empty to use field settings.",
                        max_length=200,
                    ),
                ),
                (
                    "max_file_size_mb",
                    models.IntegerField(
                        blank=True,
                        help_text="Maximum file size in MB. Leave empty to use field settings.",
                        null=True,
                    ),
                ),
                (
                    "allowed_mime_types",
                    models.TextField(
                        blank=True,
                        help_text="Comma-separated MIME types. Leave empty to allow any.",
                    ),
                ),
                (
                    "enable_versioning",
                    models.BooleanField(
                        default=False, help_text="Keep previous versions of files"
                    ),
                ),
                (
                    "max_versions",
                    models.IntegerField(
                        default=5, help_text="Maximum number of versions to keep"
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
            ],
            options={
                "verbose_name": "File Upload Configuration",
                "verbose_name_plural": "File Upload Configurations",
                "ordering": ["name"],
            },
        ),
        migrations.CreateModel(
            name="FileWorkflowHook",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        help_text="Descriptive name for this hook", max_length=200
                    ),
                ),
                (
                    "description",
                    models.TextField(
                        blank=True, help_text="Description of what this hook does"
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True, help_text="Whether this hook is active"
                    ),
                ),
                (
                    "order",
                    models.IntegerField(
                        default=0, help_text="Execution order (lower numbers run first)"
                    ),
                ),
                (
                    "field_name",
                    models.CharField(
                        blank=True,
                        help_text="Specific field name (leave empty for all file fields)",
                        max_length=100,
                    ),
                ),
                (
                    "trigger",
                    models.CharField(
                        choices=[
                            ("on_upload", "On Upload"),
                            ("on_submit", "On Submission"),
                            ("on_approve", "On Approval"),
                            ("on_reject", "On Rejection"),
                            ("on_supersede", "On Supersede"),
                        ],
                        help_text="When to execute this hook",
                        max_length=20,
                    ),
                ),
                (
                    "action",
                    models.CharField(
                        choices=[
                            ("rename", "Rename File"),
                            ("move", "Move File"),
                            ("copy", "Copy File"),
                            ("delete", "Delete File"),
                            ("webhook", "Call Webhook"),
                            ("api", "API Call"),
                            ("custom", "Custom Handler"),
                        ],
                        help_text="Action to perform",
                        max_length=20,
                    ),
                ),
                (
                    "target_pattern",
                    models.CharField(
                        blank=True,
                        help_text="Target path/name pattern. Supports same tokens as FileUploadConfig.",
                        max_length=500,
                    ),
                ),
                (
                    "webhook_url",
                    models.URLField(
                        blank=True, help_text="Webhook URL to call", max_length=500
                    ),
                ),
                (
                    "webhook_method",
                    models.CharField(
                        blank=True,
                        default="POST",
                        help_text="HTTP method for webhook",
                        max_length=10,
                    ),
                ),
                (
                    "webhook_headers",
                    models.JSONField(
                        blank=True,
                        default=dict,
                        help_text="Headers to send with webhook request",
                    ),
                ),
                (
                    "webhook_payload_template",
                    models.TextField(
                        blank=True,
                        help_text="JSON template for webhook payload. Use {field} for tokens.",
                    ),
                ),
                (
                    "custom_handler_path",
                    models.CharField(
                        blank=True,
                        help_text="Python path to custom handler (e.g., 'myapp.handlers.process_file')",
                        max_length=500,
                    ),
                ),
                (
                    "custom_handler_config",
                    models.JSONField(
                        blank=True,
                        default=dict,
                        help_text="Configuration passed to custom handler",
                    ),
                ),
                (
                    "condition_field",
                    models.CharField(
                        blank=True,
                        help_text="Form field to check for conditional execution",
                        max_length=100,
                    ),
                ),
                (
                    "condition_operator",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("equals", "Equals"),
                            ("not_equals", "Not Equals"),
                            ("contains", "Contains"),
                            ("greater_than", "Greater Than"),
                            ("less_than", "Less Than"),
                            ("is_true", "Is True"),
                            ("is_false", "Is False"),
                            ("file_ext_equals", "File Extension Equals"),
                            ("file_size_greater", "File Size Greater Than (MB)"),
                            ("file_size_less", "File Size Less Than (MB)"),
                        ],
                        help_text="Comparison operator for condition",
                        max_length=20,
                    ),
                ),
                (
                    "condition_value",
                    models.CharField(
                        blank=True, help_text="Value to compare against", max_length=500
                    ),
                ),
                (
                    "fail_silently",
                    models.BooleanField(
                        default=False,
                        help_text="If True, errors won't block the workflow",
                    ),
                ),
                (
                    "retry_on_failure",
                    models.BooleanField(
                        default=False, help_text="Retry failed actions"
                    ),
                ),
                (
                    "max_retries",
                    models.IntegerField(default=3, help_text="Maximum retry attempts"),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "form_definition",
                    models.ForeignKey(
                        blank=True,
                        help_text="Specific form (leave empty for all forms)",
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="file_hooks",
                        to="django_forms_workflows.formdefinition",
                    ),
                ),
                (
                    "upload_config",
                    models.ForeignKey(
                        blank=True,
                        help_text="Specific upload config (leave empty for all)",
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="hooks",
                        to="django_forms_workflows.fileuploadconfig",
                    ),
                ),
            ],
            options={
                "verbose_name": "File Workflow Hook",
                "verbose_name_plural": "File Workflow Hooks",
                "ordering": ["order", "name"],
            },
        ),
        migrations.CreateModel(
            name="ManagedFile",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "original_filename",
                    models.CharField(
                        help_text="Original filename as uploaded", max_length=500
                    ),
                ),
                (
                    "stored_filename",
                    models.CharField(
                        help_text="Filename as stored (after naming pattern applied)",
                        max_length=500,
                    ),
                ),
                (
                    "file_path",
                    models.CharField(
                        help_text="Full path to file storage", max_length=1000
                    ),
                ),
                (
                    "file_size",
                    models.BigIntegerField(default=0, help_text="File size in bytes"),
                ),
                (
                    "mime_type",
                    models.CharField(
                        blank=True, help_text="MIME type of the file", max_length=200
                    ),
                ),
                (
                    "file_hash",
                    models.CharField(
                        blank=True,
                        db_index=True,
                        help_text="SHA-256 hash of file content for integrity/dedup",
                        max_length=64,
                    ),
                ),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("approved", "Approved"),
                            ("rejected", "Rejected"),
                            ("superseded", "Superseded"),
                            ("deleted", "Deleted"),
                        ],
                        db_index=True,
                        default="pending",
                        max_length=20,
                    ),
                ),
                (
                    "status_changed_at",
                    models.DateTimeField(
                        blank=True, help_text="When status last changed", null=True
                    ),
                ),
                (
                    "status_notes",
                    models.TextField(
                        blank=True,
                        help_text="Notes about the status change (e.g., rejection reason)",
                    ),
                ),
                (
                    "version",
                    models.IntegerField(
                        default=1, help_text="Version number for this file"
                    ),
                ),
                (
                    "is_current",
                    models.BooleanField(
                        db_index=True,
                        default=True,
                        help_text="Is this the current version?",
                    ),
                ),
                ("uploaded_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "metadata",
                    models.JSONField(
                        blank=True,
                        default=dict,
                        help_text="Additional metadata as JSON",
                    ),
                ),
                (
                    "form_field",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="managed_files",
                        to="django_forms_workflows.formfield",
                    ),
                ),
                (
                    "previous_version",
                    models.ForeignKey(
                        blank=True,
                        help_text="Link to previous version of this file",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="newer_versions",
                        to="django_forms_workflows.managedfile",
                    ),
                ),
                (
                    "status_changed_by",
                    models.ForeignKey(
                        blank=True,
                        help_text="User who changed the status",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="file_status_changes",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "submission",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="managed_files",
                        to="django_forms_workflows.formsubmission",
                    ),
                ),
                (
                    "upload_config",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="managed_files",
                        to="django_forms_workflows.fileuploadconfig",
                    ),
                ),
                (
                    "uploaded_by",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.PROTECT,
                        related_name="uploaded_files",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "verbose_name": "Managed File",
                "verbose_name_plural": "Managed Files",
                "ordering": ["-uploaded_at"],
                "indexes": [
                    models.Index(
                        fields=["submission", "status"],
                        name="django_form_submiss_073952_idx",
                    ),
                    models.Index(
                        fields=["status", "is_current"],
                        name="django_form_status_454c82_idx",
                    ),
                ],
            },
        ),
    ]
