# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/user/application_security/secret_detection/pipeline/configure
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
stages:
  - code-validation
  - test
  - build
  - fuzz
  - docs
  - publish

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.latest.gitlab-ci.yml

variables:
  SECRET_DETECTION_ENABLED: "true"
  GIT_STRATEGY: clone
  GIT_CLEAN_FLAGS: -ffdx
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache fÃ¼r Dependencies
cache:
  paths:
    - .cache/pip

# Set the tag to the runner you want to use (also works for individual jobs)
# KIT runners: https://docs.gitlab.kit.edu/en/gitlab_runner/

# CODE VALIDATION
lint:
  stage: code-validation
  image: python:3.12-slim
  variables:
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PYTHONDONTWRITEBYTECODE: "1"
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv venv .venv
    - uv pip install ruff black
  script:
    - .venv/bin/ruff check .
    - .venv/bin/black --check --diff .
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip lint\]/'
      when: never
    - when: always

typecheck:
  stage: code-validation
  image: python:3.12-slim
  variables:
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PYTHONDONTWRITEBYTECODE: "1"
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv venv .venv
    - uv pip install mypy
    - uv pip install -e .
  script:
    - .venv/bin/mypy src

  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip lint\]/'
      when: never
    - when: always

# TEST
# Tests run unit tests in the GPU-enabled Docker image
tests:
  stage: test
  image: nvidia/cuda:12.8.0-runtime-ubuntu24.04
  variables:
    UV_PYTHON_VERSIONS: "3.12"
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends curl ca-certificates
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv python install $UV_PYTHON_VERSIONS
  script:
    - for version in $UV_PYTHON_VERSIONS; do
        echo "Running tests with Python $version";
        uv venv --python $version .venv-$version;
        uv pip install --python .venv-$version/bin/python --index-url https://download.pytorch.org/whl/cu128 torch torchvision;
        uv pip install --python .venv-$version/bin/python pytest pytest-xdist;
        uv pip install --python .venv-$version/bin/python -e .;
        .venv-$version/bin/pytest -n auto -v --junitxml=junit-$version.xml tests/ || exit 1;
      done
  artifacts:
    when: on_failure
    expire_in: 1 week
    reports:
      junit: junit-*.xml
    paths:
      - junit-*.xml
  # Change to gpu enabled runner and remove allow_failure once available
  # deleted 'gpu' tag so we don't need max's runner
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip test\]/'
      when: never

    - when: always

# BUILD
build_project:
  stage: build
  image: python:3.12-slim
  tags:
    - kgr2-instance-standard
  variables:
    PIP_NO_CACHE_DIR: "1"
  before_script:
    - apt-get update && apt-get install -y git curl jq
    - pip install build
    - pip install hatchling
    - pip install "torch>=2.5.0" --index-url https://download.pytorch.org/whl/cpu
    - pip install numpy typer
  script:
    - |
      BASE_VERSION=$(grep -m 1 '^version = ' pyproject.toml | tr -s ' ' | tr -d '"' | tr -d "'" | cut -d' ' -f3)
      PACKAGE_NAME=$(grep -m 1 '^name = ' pyproject.toml | tr -s ' ' | tr -d '"' | tr -d "'" | cut -d' ' -f3)
      BUILD_VERSION="$BASE_VERSION"

      echo "Fetching existing versions from PyPI..."
      PYPI_RESPONSE=$(curl -s "https://pypi.org/pypi/$PACKAGE_NAME/json" 2>/dev/null || echo '{"releases":{}}')

      if echo "$PYPI_RESPONSE" | jq -e '.releases' > /dev/null 2>&1; then
        PACKAGE_EXISTS=true
        echo "âœ… Package found on PyPI"
      else
        PACKAGE_EXISTS=false
        echo "â„¹ï¸  Package not yet published on PyPI"
      fi
      echo ""


      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" = "main" ]; then
        echo "Building stable version: $BUILD_VERSION"

        if [ "$PACKAGE_EXISTS" = "true" ] && echo "$PYPI_RESPONSE" | jq -e ".releases.\"$BUILD_VERSION\"" > /dev/null 2>&1; then
          echo "âŒ ERROR: Version $BUILD_VERSION already exists on PyPI!"
          echo ""
          echo "Please bump the version before merging to main:"
          echo "--> cz bump"
          exit 1
        fi

      elif [ "$CI_COMMIT_BRANCH" = "develop" ]; then
        echo "Checking existing dev versions on PyPI..."

        if [ "$PACKAGE_EXISTS" = "true" ]; then
          EXISTING_VERSIONS=$(echo "$PYPI_RESPONSE" | jq -r '.releases | keys[]' | grep "^${BASE_VERSION}\.dev" || echo "")
        else
          EXISTING_VERSIONS=""
        fi

        if [ -z "$EXISTING_VERSIONS" ]; then
          DEV_NUMBER=0
          echo "No existing dev versions found, starting with dev0"
        else
          echo "Existing dev versions:"
          echo "$EXISTING_VERSIONS"

          HIGHEST_DEV=$(echo "$EXISTING_VERSIONS" | sed "s/${BASE_VERSION}\.dev//" | sort -n | tail -1)
          DEV_NUMBER=$((HIGHEST_DEV + 1))
          echo "Highest existing: dev${HIGHEST_DEV}"
          echo "Using: dev${DEV_NUMBER}"
        fi

        BUILD_VERSION="${BASE_VERSION}.dev${DEV_NUMBER}"
        echo "Building development version: $BUILD_VERSION"

      else
        SHORT_SHA=$(git rev-parse --short=8 HEAD)
        BUILD_VERSION="${BASE_VERSION}.dev0+${SHORT_SHA}"
        echo "Building feature branch version: $BUILD_VERSION"
        echo "âš ï¸  Note: This version should NOT be published"
      fi

      sed -i "s/^version = .*/version = \"$BUILD_VERSION\"/" pyproject.toml

      echo "Updated pyproject.toml version:"
      grep -m 1 '^version = ' pyproject.toml
      echo ""

      echo "Building package..."
      python -m build --no-isolation --skip-dependency-check --sdist --wheel --outdir dist

      echo "BUILD_VERSION=${BUILD_VERSION}" >> build.env
      echo "PACKAGE_NAME=${PACKAGE_NAME}" >> build.env

      echo ""
      echo "âœ… Successfully built version: $BUILD_VERSION"
      echo ""

  artifacts:
    when: on_success
    expire_in: 1 week
    reports:
      dotenv: build.env
    paths:
      - dist/*.whl
      - dist/*.tar.gz
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip build\]/'
      when: never

    - if: $CI_COMMIT_BRANCH == "main"
      when: never

    # Allowing Merge Requests
    - if: $CI_MERGE_REQUEST_ID
      when: on_success

    # build if pushed on develop (and feature branches)
    - if: $CI_COMMIT_BRANCH == "develop"
      when: on_success

    # Fallback if we will use other branches in future
    - when: on_success

fuzz:
  stage: fuzz
  image: python:3.12-slim
  variables:
    PIP_DISABLE_PIP_VERSION_CHECK: "1"
    PYTHONDONTWRITEBYTECODE: "1"
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv venv .venv
    - uv pip install pytest hypothesis
    - uv pip install "torch>=2.5.0" --index-url https://download.pytorch.org/whl/cpu
    - uv pip install numpy
    - uv pip install -e .
  script:
    - .venv/bin/pytest -q tests/fuzz_gmtorch.py
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip fuzz\]/'
      when: never

    - when: always


# DOCS
generate_docs:
  stage: docs
  image: python:3.12-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv venv .venv
    - uv pip install sphinx pydata-sphinx-theme
    - uv pip install myst-parser
    - uv pip install --index-url https://download.pytorch.org/whl/cpu torch torchvision
    - uv pip install -e .
  script:
    - |
      echo "Generating Sphinx documentation..."
      .venv/bin/sphinx-apidoc -f --private -o docs/ src/
      .venv/bin/sphinx-build -b html docs/ docs/_build/html

      echo "âœ… Documentation generated"
  artifacts:
    paths:
      - docs/_build
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip docs\]/'
      when: never

    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"

# Publishes documentation to Gitlab Pages
publish_docs:
  stage: publish
  image: alpine:latest
  when: manual
  dependencies:
    - generate_docs
  before_script:
    - apk add --no-cache git
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - |
      echo "Publishing documentation to GitHub Pages..."

      git clone --depth 1 --branch main https://oauth2:${GITHUB_DOCS_TOKEN}@github.com/SebastianRoll05/gmtorch_pse.git gh-pages
      # Remove old documentation
      rm -rf gh-pages/*

      # Copy new documentation
      cp -r docs/_build/html/* gh-pages/

      # Add .nojekyll file to prevent GitHub from processing with Jekyll
      touch gh-pages/.nojekyll

      # Commit and push
      cd gh-pages
      git add .
      git commit -m "Update documentation from GitLab CI - ${CI_COMMIT_SHORT_SHA}" || echo "No changes to commit"
      git push origin main

      echo "âœ… Documentation published to GitHub Pages"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
      when: always

release:
  stage: publish
  image: python:3.12
  dependencies:
    - build_project
  variables:
    UV_PUBLISH_TOKEN: $PYPI_TOKEN

  before_script:
    - pip install uv
    - uv venv .venv
    - source .venv/bin/activate

  script:
      - echo "Checking artifacts..."
      - ls -l dist/

      - echo "ðŸš€ Publishing existing artifacts to PyPI..."
      - uv publish

      - echo "âœ… Publish completed!"

  artifacts:
    paths:
      - dist/
    expire_in: 30 days

  rules:

    - if: $CI_COMMIT_BRANCH == "develop"
