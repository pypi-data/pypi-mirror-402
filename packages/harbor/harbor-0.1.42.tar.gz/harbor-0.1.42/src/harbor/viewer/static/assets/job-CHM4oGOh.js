import{x as fe,B as ye,v as Ne,b as n,t as e,A as Ce}from"./index-CYR-HZan.js";import{d as _e,u as M,B as ke,a as we,b as Q,q as Se,r as Te,e as De,f as B,g as Fe,t as Pe,L as Ee,v as Me,w as Ke,x as Ae,y as Ie}from"./api-BIjnJNxI.js";import{u as Z,t as v,l as Re}from"./index-JVv6katd.js";import{u as Y,X as Le,E as qe,a as Be,b as Ve,c as Oe,d as ze}from"./empty-NX9twF5u.js";import{u as f,a as y,p as w,T as Ue,I as ee,S as $e,C as S}from"./input-Jt_yp_86.js";import{C as Je,B as Qe}from"./code-block-D6lALSLz.js";import{u as Ge,a as He,D as We,P as Xe,b as Ze,d,e as Ye,f as T,g as G,h as es,S as u,C as ss}from"./hooks-S5scq3iY.js";import{T as as,a as rs,b as H,c as W,F as ts,D as ns,d as ls,e as os,f as is,g as cs,h as ds,L as R,S as us,i as ms,j as hs,k as xs,l as L}from"./tabs-Cl6rAQnG.js";import{K as N}from"./kbd-DMs_pQ4B.js";import"./mutation--h5hHClj.js";import"./index-0vLPmRNj.js";import"./compare-Br3z3FUS-D09VrqaM.js";import"./scroll-area-ROIR1FUv.js";function ps({value:s}){const a=async()=>{await navigator.clipboard.writeText(s),v("Copied to clipboard",{description:s})};return e.jsx("span",{onClick:a,className:"cursor-default hover:text-foreground transition-colors",children:s})}function gs({jobName:s}){const a=Z(),[l,m]=n.useState(!1),[h,j]=n.useState("haiku"),[t,i]=n.useState(32),[b,D]=n.useState(!0),c=Y({mutationFn:()=>Pe(s,h,t,b),onSuccess:o=>{a.invalidateQueries({queryKey:["job-summary",s]}),m(!1),o.n_trials_summarized>0&&o.job_summary_created?v.success(`Summarized ${o.n_trials_summarized} trial${o.n_trials_summarized===1?"":"s"}`):o.job_summary_created?v.success("Job summary updated"):v.info("No trials to summarize")},onError:o=>{v.error("Failed to generate summary",{description:o.message})}});return e.jsxs(ns,{open:l,onOpenChange:m,children:[e.jsx(ls,{asChild:!0,children:e.jsx(B,{children:"Generate Summary"})}),e.jsxs(os,{children:[e.jsxs(is,{children:[e.jsx(cs,{children:"Generate Summary"}),e.jsx(ds,{children:"Use Claude to analyze all failing trials and generate a summary. This can take a couple minutes."})]}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"model",children:"Model"}),e.jsxs(us,{value:h,onValueChange:j,children:[e.jsx(ms,{id:"model",children:e.jsx(hs,{})}),e.jsxs(xs,{children:[e.jsx(L,{value:"haiku",children:"Haiku (Recommended)"}),e.jsx(L,{value:"sonnet",children:"Sonnet"}),e.jsx(L,{value:"opus",children:"Opus"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"n-concurrent",children:"Concurrent Claude Codes"}),e.jsx(ee,{id:"n-concurrent",type:"number",min:1,max:100,value:t,onChange:o=>i(parseInt(o.target.value)||1)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ss,{id:"only-failed",checked:b,onCheckedChange:o=>D(o===!0)}),e.jsx(R,{htmlFor:"only-failed",className:"font-normal",children:"Only analyze failed trials"})]}),e.jsx(B,{className:"w-full",onClick:()=>c.mutate(),disabled:c.isPending,children:c.isPending?e.jsx(Ee,{text:"Generating"}):"Generate"})]})]})]})}function js({reward:s}){const a=Math.max(0,Math.min(1,s)),l=Math.round(a*100);return e.jsx(Qe,{variant:"outline",className:"tabular-nums border-transparent rounded-none",style:{backgroundColor:`color-mix(in oklab, var(--foreground) ${l}%, transparent)`,color:a>.5?"var(--background)":void 0},children:s.toFixed(2)})}function X(s,a){const l=s.source||"_",m=s.agent_name||"_",h=s.model_provider||"_",j=s.model_name||"_";return`/jobs/${encodeURIComponent(a)}/tasks/${encodeURIComponent(l)}/${encodeURIComponent(m)}/${encodeURIComponent(h)}/${encodeURIComponent(j)}/${encodeURIComponent(s.task_name)}`}const vs=[{accessorKey:"task_name",header:({column:s})=>e.jsx(u,{column:s,children:"Task"})},{accessorKey:"agent_name",header:({column:s})=>e.jsx(u,{column:s,children:"Agent"}),cell:({row:s})=>s.original.agent_name||"-"},{accessorKey:"model_provider",header:({column:s})=>e.jsx(u,{column:s,children:"Provider"}),cell:({row:s})=>s.original.model_provider||"-"},{accessorKey:"model_name",header:({column:s})=>e.jsx(u,{column:s,children:"Model"}),cell:({row:s})=>s.original.model_name||"-"},{accessorKey:"source",header:({column:s})=>e.jsx(u,{column:s,children:"Dataset"}),cell:({row:s})=>s.original.source||"-"},{accessorKey:"n_trials",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(u,{column:s,children:"Trials"})}),cell:({row:s})=>{const{n_trials:a,n_completed:l}=s.original;return l<a?e.jsxs("div",{className:"text-right",children:[l,"/",a]}):e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"n_errors",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(u,{column:s,children:"Errors"})}),cell:({row:s})=>{const a=s.original.n_errors;return e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"exception_types",header:({column:s})=>e.jsx(u,{column:s,children:"Exceptions"}),sortingFn:(s,a)=>{const l=s.original.exception_types[0]??"",m=a.original.exception_types[0]??"";return l.localeCompare(m)},cell:({row:s})=>{const a=s.original.exception_types;return a.length===0?e.jsx("span",{className:"text-muted-foreground",children:"-"}):a.length===1?e.jsx("span",{className:"text-sm",children:a[0]}):e.jsxs("span",{className:"text-sm",children:[a[0]," ",e.jsxs("span",{className:"text-muted-foreground",children:["+",a.length-1," more"]})]})}},{accessorKey:"avg_reward",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(u,{column:s,children:"Avg Reward"})}),cell:({row:s})=>{const a=s.original.avg_reward;return a===null?e.jsx("div",{className:"text-right text-muted-foreground",children:"-"}):e.jsx("div",{className:"text-right",children:e.jsx(js,{reward:a})})}}],q=100,Es=fe(function(){const{jobName:a}=ye(),l=Ne(),m=Z(),[h,j]=n.useState(!1),[t,i]=n.useState(1),[b,D]=f("q",y.withDefault("")),[c,o]=f("agent",w(y).withDefault([])),[C,se]=f("provider",w(y).withDefault([])),[_,ae]=f("model",w(y).withDefault([])),[k,re]=f("task",w(y).withDefault([])),[F,te]=f("hide",w(y).withDefault([])),V=n.useRef(null),P=n.useMemo(()=>[{value:"task_name",label:"Task"},{value:"agent_name",label:"Agent"},{value:"model_provider",label:"Provider"},{value:"model_name",label:"Model"},{value:"source",label:"Dataset"},{value:"n_trials",label:"Trials"},{value:"n_errors",label:"Errors"},{value:"exception_types",label:"Exceptions"},{value:"avg_reward",label:"Avg Reward"}],[]),ne=n.useMemo(()=>{const r={};for(const E of F)r[E]=!1;return r},[F]),le=n.useMemo(()=>P.filter(r=>!F.includes(r.value)).map(r=>r.value),[P,F]),oe=r=>{const E=P.filter(I=>!r.includes(I.value)).map(I=>I.value);te(E.length>0?E:null)};_e("mod+k",r=>{r.preventDefault(),V.current?.focus()},{enableOnFormTags:!0});const K=Ge(b,300);n.useEffect(()=>{i(1)},[K,c,C,_,k]);const{data:x,isLoading:ie}=M({queryKey:["job",a],queryFn:()=>Me(a),enabled:!!a}),{data:p}=M({queryKey:["task-filters",a],queryFn:()=>Ke(a),enabled:!!a,staleTime:6e4}),ce=n.useMemo(()=>(p?.agents??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.agents]),de=n.useMemo(()=>(p?.providers??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.providers]),ue=n.useMemo(()=>(p?.models??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.models]),me=n.useMemo(()=>(p?.tasks??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.tasks]),{data:A,isLoading:he}=M({queryKey:["tasks",a,t,K,c,C,_,k],queryFn:()=>Ae(a,t,q,{search:K||void 0,agents:c.length>0?c:void 0,providers:C.length>0?C:void 0,models:_.length>0?_:void 0,tasks:k.length>0?k:void 0}),enabled:!!a,placeholderData:Re}),O=A?.items??[],g=A?.total_pages??0,z=A?.total??0,[U,xe]=n.useState("results"),{highlightedIndex:pe}=He({rows:O,onNavigate:r=>l(X(r,a)),onEscapeUnhighlighted:()=>l("/"),enabled:U==="results"}),{data:$}=M({queryKey:["job-summary",a],queryFn:()=>Ie(a),enabled:!!a}),J=Y({mutationFn:()=>Fe(a),onSuccess:()=>{m.invalidateQueries({queryKey:["jobs"]}),v("Job deleted",{description:a}),l("/")},onError:r=>{v.error("Failed to delete job",{description:r.message}),j(!1)}}),ge=()=>{h?J.mutate():j(!0)};if(!ie&&!x)return e.jsx("div",{className:"container mx-auto py-10",children:e.jsx("div",{className:"text-destructive",children:"Failed to load job"})});const je=x?.stats.n_trials??0,ve=x?.n_total_trials??0,be=x?.stats.n_errors??0;return e.jsxs("div",{className:"container mx-auto py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(ke,{className:"mb-4",children:e.jsxs(we,{children:[e.jsx(Q,{children:e.jsx(Se,{asChild:!0,children:e.jsx(Ce,{to:"/",children:"Jobs"})})}),e.jsx(Te,{}),e.jsx(Q,{children:e.jsx(De,{children:a})})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-4xl font-medium",children:a}),e.jsxs(B,{variant:h?"destructive":"secondary",onClick:ge,onBlur:()=>j(!1),disabled:J.isPending,children:[e.jsx(Ue,{className:"h-4 w-4"}),h?"Confirm delete":"Delete"]})]}),e.jsxs("div",{className:"flex gap-2 text-sm text-muted-foreground mt-2",children:[e.jsxs("span",{children:[je,"/",ve," trials completed"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("span",{children:[be," errors"]})]}),x?.job_uri&&e.jsx("div",{className:"text-xs text-muted-foreground mt-3",children:e.jsx(ps,{value:x.job_uri.startsWith("file://")?x.job_uri.slice(7):x.job_uri})})]}),e.jsxs(as,{value:U,onValueChange:xe,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between bg-card border border-b-0",children:[e.jsxs(rs,{className:"border-0",children:[e.jsx(H,{value:"results",children:"Results"}),e.jsx(H,{value:"summary",children:"Summary"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"j"}),e.jsx(N,{children:"k"}),e.jsx("span",{children:"to navigate"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"Enter"}),e.jsx("span",{children:"to open"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"Esc"}),e.jsx("span",{children:"to deselect"})]})]})]}),e.jsxs(W,{value:"results",children:[e.jsxs("div",{className:"grid grid-cols-7 -mb-px",children:[e.jsxs("div",{className:"col-span-2 relative",children:[e.jsx(ee,{ref:V,placeholder:"Search for tasks...",value:b,onChange:r=>D(r.target.value||null),size:"lg",variant:"card",className:"peer pl-9 pr-16 shadow-none"}),e.jsx($e,{className:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-border transition-colors peer-focus-visible:text-ring"}),b?e.jsx("button",{type:"button",onClick:()=>D(null),className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors",children:e.jsx(Le,{className:"h-4 w-4"})}):e.jsxs("div",{className:"pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-0.5",children:[e.jsx(N,{children:"âŒ˜"}),e.jsx(N,{children:"K"})]})]}),e.jsx(S,{options:ce,value:c,onValueChange:o,placeholder:"All agents",searchPlaceholder:"Search agents...",emptyText:"No agents found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(S,{options:de,value:C,onValueChange:se,placeholder:"All providers",searchPlaceholder:"Search providers...",emptyText:"No providers found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(S,{options:ue,value:_,onValueChange:ae,placeholder:"All models",searchPlaceholder:"Search models...",emptyText:"No models found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(S,{options:me,value:k,onValueChange:re,placeholder:"All tasks",searchPlaceholder:"Search tasks...",emptyText:"No tasks found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(S,{options:P,value:le,onValueChange:oe,placeholder:"Columns",searchPlaceholder:"Search columns...",emptyText:"No columns.",variant:"card",className:"w-full border-l-0 shadow-none",multiSelectLabel:"columns"})]}),e.jsx(We,{columns:vs,data:O,onRowClick:r=>l(X(r,a)),isLoading:he,className:"border-t-0",highlightedIndex:pe,columnVisibility:ne}),g>1&&e.jsxs("div",{className:"grid grid-cols-3 items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",(t-1)*q+1,"-",Math.min(t*q,z)," of ",z," tasks"]}),e.jsx(Xe,{children:e.jsxs(Ze,{children:[e.jsx(d,{children:e.jsx(Ye,{onClick:()=>i(r=>Math.max(1,r-1)),className:t===1?"pointer-events-none opacity-50":"cursor-pointer"})}),t>2&&e.jsx(d,{children:e.jsx(T,{onClick:()=>i(1),className:"cursor-pointer",children:"1"})}),t>3&&e.jsx(d,{children:e.jsx(G,{})}),t>1&&e.jsx(d,{children:e.jsx(T,{onClick:()=>i(t-1),className:"cursor-pointer",children:t-1})}),e.jsx(d,{children:e.jsx(T,{isActive:!0,children:t})}),t<g&&e.jsx(d,{children:e.jsx(T,{onClick:()=>i(t+1),className:"cursor-pointer",children:t+1})}),t<g-2&&e.jsx(d,{children:e.jsx(G,{})}),t<g-1&&e.jsx(d,{children:e.jsx(T,{onClick:()=>i(g),className:"cursor-pointer",children:g})}),e.jsx(d,{children:e.jsx(es,{onClick:()=>i(r=>Math.min(g,r+1)),className:t===g?"pointer-events-none opacity-50":"cursor-pointer"})})]})}),e.jsx("div",{})]})]}),e.jsx(W,{value:"summary",children:$?.summary?e.jsx(Je,{code:$.summary,lang:"markdown",wrap:!0}):e.jsxs(qe,{className:"bg-card border",children:[e.jsxs(Be,{children:[e.jsx(Ve,{variant:"icon",children:e.jsx(ts,{})}),e.jsx(Oe,{children:"No summary"}),e.jsx(ze,{children:"Generate a summary of all trials in this job using Claude."})]}),e.jsx(gs,{jobName:a})]})})]})]})});export{Es as default};
