# Configuration file for aqua-analysis.sh

# Variables $AQUA_CORE, $AQUA_DIAGNOSTICS $AQUA_CONFIG and $OUTPUT can be used to refer to
# the directory of the AQUA-core module,
# the directory of the AQUA-diagnostics module,
# the config directory (i.e. .aqua) and the output directory respectively.

job:
    # The max_threads variable serves as a mechanism to control the maximum number of diagnostics being run concurrently
    # - If max_threads is set to 0 or a negative value: There is no limit on the number of parallel diagnostics,
    #                                                   and all processes run in parallel without waiting. 
    #                                                   This is suitable for situations where you want to utilize
    #                                                   the maximum available resources without any restrictions.
    # - If max_threads is set to a positive value: It limits the number of concurrent processes to the specified value. 
    #                                              After launching the designated number of diagnostics, the script waits
    #                                              for these to complete before launching additional ones. 
    #                                              This is useful when you are working on a system with limited
    #                                              resources, such as a login node

    max_threads: 0  # Set to the desired maximum number of threads, or leave it as 0 for no limit
    loglevel: "WARNING" # DEBUG, INFO, WARNING, ERROR, CRITICAL

    # Run a check analysis to test the configuration and the presence of needed data
    # This also rebuild the area files, to avoid error with corrupted files
    run_checker: true
    
    # Default output directory for the analysis. Can be overridden by the command line arguments
    outputdir: "./output"

    # Default values, overriden from command line arguments
    catalog: null  # The catalog to use for the analysis
    model: "IFS-NEMO"
    exp: "historical-1990"
    source: "lra-r100-monthly"
    regrid: null
    startdate: null
    enddate: null

    script_path_base: "${AQUA_DIAGNOSTICS}"  # Base directory for the diagnostic scripts

cluster:  # options for dask cluster (this works well on lumi)
    workers: 32
    threads: 1  # per worker
    memory_limit: 7GiB  # per worker
    connect_timeout: 120  # seconds to wait for client to connect to the cluster
    # ftp_timeout: 60  # timeout in seconds for ftp connections. Will not be set if omitted.

# List of available CLI tools (diagnostics)
cli:
  biases: "global_biases/cli_global_biases.py"
  boxplots: "boxplots/cli_boxplots.py"
  drift: "ocean_drift/cli_ocean_drift.py"
  ecmean: "ecmean/cli_ecmean.py"
  enso: "teleconnections/cli_teleconnections.py"
  gregory: "timeseries/cli_timeseries.py"
  lat_lon_profiles: "lat_lon_profiles/cli_lat_lon_profiles.py"
  nao: "teleconnections/cli_teleconnections.py"
  seaice: "seaice/cli_seaice.py"
  seasonal_cycles: "timeseries/cli_timeseries.py"  # not used
  stratification: "ocean_stratification/cli_ocean_stratification.py"
  timeseries: "timeseries/cli_timeseries.py"
  trends: "ocean_trends/cli_ocean_trends.py"
  tropical_rainfall: "../../diagnostics/tropical_rainfall/cli/cli_tropical_rainfall.py"

run: 
    #['climate_metrics']
    - ["teleconnections", "climate_metrics", "ocean2d"] # very fast ones first, a few min
    - ["atmosphere2d", "atmosphere3d", "radiation-surface", "ocean3d-part1", "ocean3d-part2", "seaice", "radiation-toa", "water_cycle"]

  # List of diagnostics

  # Each diagnostic can have the following options (all optional):
  #    nworkers: the number of workers to use for the diagnostic if a global dask cluster is not used. Default is 1.
  #              Notice: these are still provided mostly for testing the local cluster option, using a global cluster (not using this option) is the new default.
  #    config: the configuration file for the diagnostic.
  #    extra: extra command line arguments to pass to the diagnostic script.
  #    outname: the name of the output directory for the diagnostic. Default is the diagnostic name itself.
  #    script_path: the location of the script to run the diagnostic.
  #                 Default script_path is "$script_path_base/$diagnostic/cli/cli_${diagnostic}.py"
  #    nocluster: boolean, if set to true, the diagnostic will not use the global dask cluster. Default is false (needed for ECmean)
diagnostics:
  atmosphere2d: 
    biases: 
      config: ["${AQUA_CONFIG}/diagnostics/atmosphere2d/config-atmosphere2d-berkeley.yaml", 
               "${AQUA_CONFIG}/diagnostics/atmosphere2d/config-atmosphere2d-era5.yaml"]
    timeseries:
      config: ["${AQUA_CONFIG}/diagnostics/atmosphere2d/config-atmosphere2d-berkeley.yaml",
               "${AQUA_CONFIG}/diagnostics/atmosphere2d/config-atmosphere2d-era5.yaml"]
    lat_lon_profiles:
      config: "${AQUA_CONFIG}/diagnostics/atmosphere2d/config-atmosphere2d-berkeley.yaml"

  atmosphere3d:
    biases:
      config: "${AQUA_CONFIG}/diagnostics/atmosphere3d/config-atmosphere3d-era5.yaml"

  climate_metrics:
    ecmean:
      config: "${AQUA_CONFIG}/diagnostics/climate_metrics/config-climate_metrics-ecmean.yaml"
      nocluster: true  # ECmean does not use the global dask cluster
      source_oce: true  # if a --source_oce argument was passed use it
    gregory:
      config: "${AQUA_CONFIG}/diagnostics/climate_metrics/config-climate_metrics-gregory.yaml"

  ocean2d:
    biases:
      config: "${AQUA_CONFIG}/diagnostics/ocean2d/config-ocean2d-esacci.yaml"

  ocean3d-part1:
    trends:
      config: "${AQUA_CONFIG}/diagnostics/ocean3d/config-ocean3d-en4-trend-drift.yaml"  # these diagnostics need a different chunking
      outname: "ocean3d"
    drift:
      config: "${AQUA_CONFIG}/diagnostics/ocean3d/config-ocean3d-en4-trend-drift.yaml"  # these diagnostics need a different chunking
      outname: "ocean3d"

  ocean3d-part2:
    stratification:
      config: "${AQUA_CONFIG}/diagnostics/ocean3d/config-ocean3d-en4-stratification.yaml"
      outname: "ocean3d"

  radiation-toa:
    biases:
      config: "${AQUA_CONFIG}/diagnostics/radiation_toa/config-radiation_toa-ceres.yaml"
    boxplots:
      config: "${AQUA_CONFIG}/diagnostics/radiation_toa/config-radiation_toa-boxplots.yaml"
    timeseries:
      config: "${AQUA_CONFIG}/diagnostics/radiation_toa/config-radiation_toa-ceres.yaml"

  radiation-surface:
    biases:
      config: ["${AQUA_CONFIG}/diagnostics/radiation_surface/config-radiation_surface-ceres.yaml",
               "${AQUA_CONFIG}/diagnostics/radiation_surface/config-radiation_surface-era5.yaml"]
    boxplots:
      config: "${AQUA_CONFIG}/diagnostics/radiation_surface/config-radiation_surface-boxplots.yaml"
    timeseries:
      config: ["${AQUA_CONFIG}/diagnostics/radiation_surface/config-radiation_surface-ceres.yaml",
               "${AQUA_CONFIG}/diagnostics/radiation_surface/config-radiation_surface-era5.yaml"]

  seaice:
    seaice:
      config: ["${AQUA_CONFIG}/diagnostics/seaice/config-seaice-osi.yaml",
               "${AQUA_CONFIG}/diagnostics/seaice/config-seaice-psc.yaml"]

  teleconnections:
    nao:
      config: "${AQUA_CONFIG}/diagnostics/teleconnections/config-teleconnections-nao.yaml"
    enso:
      config: "${AQUA_CONFIG}/diagnostics/teleconnections/config-teleconnections-enso.yaml"

  water_cycle:
    timeseries:
      config: "${AQUA_CONFIG}/diagnostics/water_cycle/config-water_cycle-mswep.yaml"
    biases:
      config: "${AQUA_CONFIG}/diagnostics/water_cycle/config-water_cycle-mswep.yaml"
    lat_lon_profiles:
      config: "${AQUA_CONFIG}/diagnostics/water_cycle/config-water_cycle-mswep.yaml"
    tropical_rainfall:
      config: "${AQUA_CONFIG}/diagnostics/water_cycle/config-water_cycle-tropical_rainfall.yaml"
      extra: "--regrid=r100 --freq=M --xmax=75 --bufferdir=${OUTPUT}/tropical_rainfall/"
