# Local development overlay - optimized for AMD GPU workstation
# Your machine: 16 CPUs, 32GB RAM, AMD GPU (ROCm)
#
# Note: AMD GPU support in Docker Desktop requires:
#   1. ROCm drivers installed on Windows/WSL2
#   2. Docker configured with AMD GPU passthrough
#   3. amdgpu-dkms in WSL2 kernel (for WSL2-based Docker)
#
# For now, this uses CPU-only Ray. GPU support can be added once ROCm is configured.
#
# Resource allocation:
#   Ray Head:   4 CPUs, 8GB RAM (for dashboard, GCS, scheduling)
#   Ray Worker: 4 CPUs, 8GB RAM x 2 = 8 CPUs, 16GB total for tasks
#   Django:     ~1 CPU, 1GB RAM
#   Postgres:   ~0.5 CPU, 0.5GB RAM
#   Total:      ~14 CPUs, 26GB RAM (leaves headroom for system)
#
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: django-ray

resources:
  - ../../base

patches:
  # Enable Django DEBUG mode
  - patch: |-
      - op: replace
        path: /data/DJANGO_DEBUG
        value: "True"
    target:
      kind: ConfigMap
      name: django-ray-config

  # 2 Ray workers for parallelism
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
    target:
      kind: Deployment
      name: ray-worker

  # Ray Head - generous resources for dashboard and coordination
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - |
            ray start --head \
              --port=6379 \
              --dashboard-host=0.0.0.0 \
              --dashboard-port=8265 \
              --metrics-export-port=8080 \
              --num-cpus=4 \
              --memory=6000000000 \
              --object-store-memory=2000000000 \
              --disable-usage-stats \
              --block
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "6Gi"
            cpu: "2"
          limits:
            memory: "10Gi"
            cpu: "4"
    target:
      kind: Deployment
      name: ray-head

  # Ray Workers - where the actual work happens
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - |
            ray start \
              --address=ray-head-svc:6379 \
              --metrics-export-port=8080 \
              --num-cpus=4 \
              --memory=6000000000 \
              --object-store-memory=2000000000 \
              --block
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "6Gi"
            cpu: "2"
          limits:
            memory: "10Gi"
            cpu: "4"
    target:
      kind: Deployment
      name: ray-worker

  # Django Web - scale up for stress testing
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
    target:
      kind: Deployment
      name: django-web

  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: GUNICORN_WORKERS
            value: "8"
          - name: GUNICORN_THREADS
            value: "4"
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 5
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
    target:
      kind: Deployment
      name: django-web

  # PostgreSQL - more resources for stress testing
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2"
    target:
      kind: Deployment
      name: postgres

images:
  - name: django-ray
    newName: django-ray
    newTag: latest
  - name: django-ray-worker
    newName: django-ray-worker
    newTag: latest

