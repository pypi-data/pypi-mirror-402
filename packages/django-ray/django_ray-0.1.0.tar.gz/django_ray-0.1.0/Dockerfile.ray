# Ray Worker Image with django-ray installed
# This image is used for Ray head and workers so they can execute django-ray tasks
#
# Build: docker build -f Dockerfile.ray -t django-ray-worker:latest .

ARG RAY_VERSION=2.53.0
ARG PYTHON_VERSION=py312

FROM rayproject/ray:${RAY_VERSION}-${PYTHON_VERSION}

# Install uv for fast dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Copy source code
COPY src/ src/
COPY testproject/ testproject/
COPY README.md ./

# Install django-ray and dependencies using uv
# Include postgres for database driver, plus testproject dependencies
RUN uv pip install --system -e ".[postgres]" django-ninja whitenoise --no-cache-dir

# Set environment variables
ENV DJANGO_SETTINGS_MODULE=testproject.settings \
    PYTHONPATH=/app/src:/app

# Verify installation
RUN python -c "import django_ray; import psycopg; import ninja; print('django-ray and dependencies installed successfully')"

