FROM maxwinch/flask-py3.12:slim-bookworm as build
COPY ./requirements.txt /var/requirements.txt
COPY . /var/{{swagger.name}}
WORKDIR /var/{{swagger.name}}
ENV PIP_INDEX_URL https://mirrors.aliyun.com/pypi/simple
RUN sed -i 's|deb.debian.org|mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list \
    && apt-get update && apt-get install -y --no-install-recommends \
                build-essential \
                make \
                gcc \
                libc6-dev \
                libjpeg-dev \
                zlib1g-dev \
                linux-headers-amd64 \
                python3-dev \
                # 解决 ImageFont.truetype 出错的问题
                libfreetype6 \
                libfreetype6-dev \
    && pip install --upgrade pip \
    && pip3 install -r /var/requirements.txt \
    && python /var/{{swagger.name}}/setup.py install \
    && find /var/{{swagger.name}} -depth \
		\( \
		    \( -type d -a -name app -o -name docs -o -name build -o -name .git  -o -name migrations \
		      -o -name .idea -o -name __pycache__ -o -name swagger -o -name seeds -o -name tests \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' -o -name '*.sql' -o -name '.*'\
		       -o -name '*.md' -o -name '*.pot' -o -name 'config-sample.ini' \
		       -o -name 'migrate_run.*' -o -name '*.mdj' -o -name '*.sqlite' -o -name '*.yaml' -o -name '*.yml' \
		        -o -name 'gen_code_run.py' -o -name '*.sh' -o -name 'uwsgi-dev.ini' \
		       -o -name 'setup.py' -o -name 'requirements.txt' \
			   -o -name 'Dockerfile*' \
		       -o -name '*.png' -o -name '*.jpg' \) \
		\) -exec rm -rf '{}' + \
	# 删除APP package 中的源码
	&& find /usr/local/lib/python3.12/site-packages/app -depth \
		\( \
		    \( -type d -a -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' -o -name '*.py' \) \
		\) -exec rm -rf '{}' + \
    && find /usr/local -depth \
		\( \
		    \( -type d -a -name test -o -name tests -o -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo' \) \
		\) -exec rm -rf '{}' + \
	# 在Debian中不需要scanelf，直接清理构建依赖
	&& apt-get remove --purge -y \
                build-essential \
                make \
                gcc \
                libc6-dev \
                libjpeg-dev \
                zlib1g-dev \
                linux-headers-amd64 \
                python3-dev \
                libfreetype6-dev \
    && apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*
FROM maxwinch/flask-py3.12:slim-bookworm
COPY --from=build /var/{{swagger.name}} /var/{{swagger.name}}
COPY --from=build /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
