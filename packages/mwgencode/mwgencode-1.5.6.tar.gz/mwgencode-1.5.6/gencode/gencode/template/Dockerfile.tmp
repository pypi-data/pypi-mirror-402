FROM maxwinch/flask-py3.12:slim-bookworm as build
COPY ./requirements.txt /var/requirements.txt
COPY . /var/{{swagger.name}}
WORKDIR /var/{{swagger.name}}
ENV DEBIAN_FRONTEND=noninteractive
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV PIP_PROGRESS_BAR=off
ENV DPKG_DEB_USE_COMPRESSION=gzip
RUN rm -f /etc/apt/apt.conf.d/docker-clean &&  echo "Acquire::ForceIPv4 \"true\";" > /etc/apt/apt.conf.d/99force-ipv4
RUN pip install --upgrade pip \
    && pip3 install -r /var/requirements.txt \
    && python /var/{{swagger.name}}/setup.py install \
    && find /var/{{swagger.name}} -depth \
		\( \
		    \( -type d -a -name app -o -name docs -o -name build -o -name .git  -o -name migrations \
		      -o -name .idea -o -name __pycache__ -o -name swagger -o -name seeds -o -name tests \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' -o -name '*.sql' -o -name '.*' \
		       -o -name '*.md' -o -name '*.pot' -o -name 'config-sample.ini' \
		       -o -name 'migrate_run.*' -o -name '*.mdj' -o -name '*.sqlite' -o -name '*.yaml' -o -name '*.yml' \
		        -o -name 'gen_code_run.py' -o -name '*.sh' -o -name 'uwsgi-dev.ini' \
		       -o -name 'setup.py' -o -name 'requirements.txt' \
			   -o -name 'Dockerfile*' \
		       -o -name '*.png' -o -name '*.jpg' \) \
		\) -exec rm -rf '{}' + \
	# 删除APP package 中的源码
	&& find /usr/local/lib/python3.12/site-packages/app -depth \
		\( \
		    \( -type d -a -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo'  -o -name '*.c' -o -name '*.py' \) \
		\) -exec rm -rf '{}' + \
    && find /usr/local -depth \
		\( \
		    \( -type d -a -name test -o -name tests -o -name __pycache__ \) \
		    -o \
		    \( -type f -a -name '*.pyc' -o -name '*.pyo' \) \
		\) -exec rm -rf '{}' + 
FROM maxwinch/flask-py3.12:slim-bookworm
COPY --from=build /var/{{swagger.name}} /var/{{swagger.name}}
COPY --from=build /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
