"""Tests for the check_workflows tool.

Generated by GRIMLOCK MCP Factory
"""

import json

import httpx
import pytest
import respx

from n8n_mcp.tools.check_workflows import check_workflows, CheckWorkflowsInput


class TestCheckWorkflowsInput:
    """Tests for CheckWorkflowsInput schema."""

    def test_empty_input_valid(self) -> None:
        """Test that empty input is valid."""
        input_data = CheckWorkflowsInput()
        assert input_data is not None

    def test_input_with_extra_fields_ignored(self) -> None:
        """Test that extra fields are handled gracefully."""
        # Pydantic by default ignores extra fields
        input_data = CheckWorkflowsInput(**{"extra_field": "value"})
        assert input_data is not None


class TestCheckWorkflowsTool:
    """Tests for check_workflows tool function."""

    @pytest.mark.asyncio
    async def test_check_workflows_success(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
        sample_workflows_response: dict,
        sample_executions_response: dict,
    ) -> None:
        """Test successful check_workflows call."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(200, json=sample_workflows_response))

        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/executions"
        ).mock(return_value=httpx.Response(200, json=sample_executions_response))

        result = await check_workflows({})

        assert len(result) == 1
        assert result[0].type == "text"

        data = json.loads(result[0].text)
        assert data["total_workflows"] == 3
        assert data["active_workflows"] == 2
        assert data["inactive_workflows"] == 1

    @pytest.mark.asyncio
    async def test_check_workflows_auth_error(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
    ) -> None:
        """Test authentication error handling."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(401, json={"message": "Unauthorized"}))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["error"] is True
        assert data["code"] == "AUTH_FAILED"
        assert "N8N_API_KEY" in data["message"]

    @pytest.mark.asyncio
    async def test_check_workflows_forbidden_error(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
    ) -> None:
        """Test 403 forbidden error handling."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(403, json={"message": "Forbidden"}))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["error"] is True
        assert data["code"] == "AUTH_FAILED"

    @pytest.mark.asyncio
    async def test_check_workflows_connection_error(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
    ) -> None:
        """Test connection error handling."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(side_effect=httpx.ConnectError("Connection refused"))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["error"] is True
        assert data["code"] == "CONNECTION_FAILED"
        assert "N8N_BASE_URL" in data["message"]

    @pytest.mark.asyncio
    async def test_check_workflows_timeout_error(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
    ) -> None:
        """Test timeout error handling."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(side_effect=httpx.TimeoutException("Request timed out"))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["error"] is True
        assert data["code"] == "CONNECTION_FAILED"
        assert "timed out" in data["message"].lower()

    @pytest.mark.asyncio
    async def test_check_workflows_generic_error(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
    ) -> None:
        """Test generic error handling."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(side_effect=Exception("Unexpected error"))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["error"] is True
        assert "Unexpected error" in data["message"]

    @pytest.mark.asyncio
    async def test_check_workflows_empty_instance(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
        sample_empty_workflows_response: dict,
        sample_empty_executions_response: dict,
    ) -> None:
        """Test with empty n8n instance."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(200, json=sample_empty_workflows_response))

        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/executions"
        ).mock(return_value=httpx.Response(200, json=sample_empty_executions_response))

        result = await check_workflows({})

        assert len(result) == 1
        data = json.loads(result[0].text)
        assert data["total_workflows"] == 0
        assert data["active_workflows"] == 0
        assert data["workflows"] == []

    @pytest.mark.asyncio
    async def test_check_workflows_with_extra_arguments(
        self,
        mock_env: None,
        mock_httpx_client: respx.MockRouter,
        sample_workflows_response: dict,
        sample_executions_response: dict,
    ) -> None:
        """Test that extra arguments are ignored gracefully."""
        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/workflows"
        ).mock(return_value=httpx.Response(200, json=sample_workflows_response))

        mock_httpx_client.get(
            "https://test-n8n.app.n8n.cloud/api/v1/executions"
        ).mock(return_value=httpx.Response(200, json=sample_executions_response))

        # Pass extra arguments that should be ignored
        result = await check_workflows({"unexpected_param": "value"})

        assert len(result) == 1
        data = json.loads(result[0].text)
        # Should still succeed
        assert data["total_workflows"] == 3
