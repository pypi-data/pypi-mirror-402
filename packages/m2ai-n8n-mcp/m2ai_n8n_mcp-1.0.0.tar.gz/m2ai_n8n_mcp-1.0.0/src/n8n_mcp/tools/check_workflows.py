"""check_workflows - Review all workflows and report status.

Generated by GRIMLOCK MCP Factory
"""

import json
import logging
from typing import Any

import httpx
from mcp.types import TextContent
from pydantic import BaseModel

from ..clients.n8n import N8nClient

logger = logging.getLogger("n8n_mcp")


class CheckWorkflowsInput(BaseModel):
    """Input schema for check_workflows.

    This tool takes no parameters - it reviews all workflows.
    """

    pass


CheckWorkflowsSchema = CheckWorkflowsInput


async def check_workflows(arguments: dict[str, Any]) -> list[TextContent]:
    """Review all workflows and report their status.

    Args:
        arguments: Tool arguments from MCP call (unused - no parameters)

    Returns:
        List of TextContent with workflow status summary
    """
    try:
        # Validate input (even though empty)
        CheckWorkflowsInput(**arguments)

        logger.info("check_workflows called", extra={"tool": "check_workflows"})

        client = N8nClient()
        result = await client.check_workflows()

        logger.info(
            "check_workflows completed",
            extra={
                "tool": "check_workflows",
                "total": result.get("total_workflows", 0),
                "active": result.get("active_workflows", 0),
            },
        )

        return [
            TextContent(
                type="text",
                text=json.dumps(result, indent=2),
            )
        ]

    except (httpx.ConnectError, httpx.TimeoutException) as e:
        error_msg = str(e)
        return [
            TextContent(
                type="text",
                text=json.dumps(
                    {
                        "error": True,
                        "code": "CONNECTION_FAILED",
                        "message": f"Failed to connect to n8n instance. Check your N8N_BASE_URL. Error: {error_msg}",
                    },
                    indent=2,
                ),
            )
        ]

    except Exception as e:
        error_msg = str(e)

        # Handle authentication errors
        if "401" in error_msg or "403" in error_msg or "unauthorized" in error_msg.lower():
            return [
                TextContent(
                    type="text",
                    text=json.dumps(
                        {
                            "error": True,
                            "code": "AUTH_FAILED",
                            "message": "n8n API key is invalid or expired. Check your N8N_API_KEY.",
                        },
                        indent=2,
                    ),
                )
            ]

        # Handle connection errors by message content
        if "connect" in error_msg.lower() or "timeout" in error_msg.lower():
            return [
                TextContent(
                    type="text",
                    text=json.dumps(
                        {
                            "error": True,
                            "code": "CONNECTION_FAILED",
                            "message": f"Failed to connect to n8n instance. Check your N8N_BASE_URL. Error: {error_msg}",
                        },
                        indent=2,
                    ),
                )
            ]

        logger.error(f"check_workflows error: {error_msg}")
        return [
            TextContent(
                type="text",
                text=json.dumps({"error": True, "message": error_msg}, indent=2),
            )
        ]
