steps:
  # Authenticate with service account first
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "$$SERVICE_ACCOUNT_KEY" | base64 -d > /workspace/sa-key.json
        gcloud auth activate-service-account --key-file=/workspace/sa-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json
    id: 'authenticate'
    secretEnv: ['SERVICE_ACCOUNT_KEY']

  # Download Terraform files from GCS
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir -p /workspace
        gsutil -m cp -r gs://${_TERRAFORM_FILES_BUCKET}/${_WORKSPACE_NAME}/terraform/* /workspace/ || echo "No terraform files found in GCS"
    id: 'download-terraform-files'
    env:
      - 'GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json'
    secretEnv: ['SERVICE_ACCOUNT_KEY']
    waitFor: ['authenticate']

  # Initialize Terraform (try remote backend first, fallback to local state)
  - name: 'hashicorp/terraform:1.5.0'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd /workspace
        export GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json
        
        # Try to initialize with remote backend if state bucket is provided
        if [ -n "${_TERRAFORM_STATE_BUCKET}" ] && [ "${_TERRAFORM_STATE_BUCKET}" != "" ]; then
          terraform init \
            -backend-config="bucket=${_TERRAFORM_STATE_BUCKET}" \
            -backend-config="prefix=${_WORKSPACE_NAME}/terraform/state" \
            -reconfigure || terraform init -reconfigure
        else
          # Use local state file if available
          if [ -f "terraform.tfstate" ]; then
            terraform init -reconfigure
          else
            echo "No state file found. Attempting to initialize..."
            terraform init -reconfigure
          fi
        fi
    id: 'terraform-init'
    env:
      - 'GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json'
    secretEnv: ['SERVICE_ACCOUNT_KEY']
    waitFor: ['download-terraform-files']

  # Destroy infrastructure
  - name: 'hashicorp/terraform:1.5.0'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd /workspace
        export GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json
        terraform destroy -auto-approve
    id: 'terraform-destroy'
    env:
      - 'GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json'
    secretEnv: ['SERVICE_ACCOUNT_KEY']
    waitFor: ['terraform-init']

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'

availableSecrets:
  secretManager:
    - versionName: projects/${PROJECT_ID}/secrets/deployml-teardown-sa-key-${_WORKSPACE_NAME_NO_DASH}/versions/latest
      env: 'SERVICE_ACCOUNT_KEY'

substitutions:
  _WORKSPACE_NAME: ''
  _WORKSPACE_NAME_NO_DASH: ''
  _TERRAFORM_STATE_BUCKET: ''
  _TERRAFORM_FILES_BUCKET: ''

timeout: '1800s'  # 30 minutes
