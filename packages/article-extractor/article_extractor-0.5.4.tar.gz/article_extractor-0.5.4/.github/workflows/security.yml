# Security scanning workflow
# Runs multiple security checks on the codebase

name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 6 AM UTC to catch new vulnerabilities
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # Scan Python dependencies for known vulnerabilities
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      - name: Install pip-audit
        run: uv pip install pip-audit

      - name: Run pip-audit
        run: uv run pip-audit --strict --progress-spinner off
        continue-on-error: true

      - name: Export SBOM
        run: |
          uv pip freeze > requirements-frozen.txt
          echo "::notice::Dependencies exported to requirements-frozen.txt"

  # Security linting with bandit via ruff
  security-lint:
    name: Security Linting (Bandit rules)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      - name: Run Ruff security checks
        run: |
          echo "Running flake8-bandit security rules..."
          uv run ruff check . --select=S --output-format=github

  # Scan for secrets in code
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

  # SARIF upload for GitHub Security tab integration
  sarif-upload:
    name: SARIF Security Report
    runs-on: ubuntu-latest
    needs: [security-lint]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      - name: Generate SARIF report
        run: |
          uv run ruff check . --select=S --output-format=sarif > ruff-security.sarif || true
        continue-on-error: true

      - name: Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ruff-security.sarif
          category: ruff-security
        continue-on-error: true
