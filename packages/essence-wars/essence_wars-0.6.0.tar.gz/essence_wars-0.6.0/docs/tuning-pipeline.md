# Tuning Pipeline Reference

**Complete guide to training and using optimized bot weights for Essence Wars**

## Quick Start

```bash
# 1. Train generalist weights (works with all decks)
cargo run --release --bin tune -- --tag generalist-v0.4

# 2. Train faction specialist (e.g., Argentum)
cargo run --release --bin tune -- --mode faction-specialist --faction argentum --tag argentum-v0.4

# 3. Analyze results
./scripts/analyze-tuning.sh --latest

# 4. Weights automatically deployed! Test them:
cargo run --release --bin arena -- --bot1 mcts --bot2 random --games 100
```

---

## Table of Contents

1. [Directory Structure](#directory-structure)
2. [Tuning Modes](#tuning-modes)
3. [Performance: MCTS Simulations](#performance-mcts-simulations)
4. [Complete Workflow](#complete-workflow)
5. [Auto-Deploy System](#auto-deploy-system)
6. [Cloud Training with Modal](#cloud-training-with-modal-optional)
7. [Analysis & Visualization](#analysis--visualization)
8. [Using Tuned Weights](#using-tuned-weights)
9. [How MCTS Uses Weights](#how-mcts-uses-weights)
10. [Troubleshooting](#troubleshooting)

---

## Directory Structure

### Experiment Outputs

```
experiments/mcts/YYYY-MM-DD_HHMM_tag/
â”œâ”€â”€ train.log                    # Full training log with all generations
â”œâ”€â”€ weights.toml                 # Best weights found (24 parameters)
â”œâ”€â”€ summary.txt                  # Quick stats (fitness, win rate, time)
â”œâ”€â”€ version.toml                 # Engine version for reproducibility
â”œâ”€â”€ stats.csv                    # Parsed metrics (generated by analysis)
â””â”€â”€ plots/                       # Visualizations (generated by analysis)
    â”œâ”€â”€ overview.png             # Win rate & fitness over time
    â”œâ”€â”€ efficiency.png           # Time per generation analysis
    â”œâ”€â”€ convergence.png          # Weight parameter evolution
    â”œâ”€â”€ comparison.png           # Multi-run comparison (if applicable)
    â””â”€â”€ summary_report.txt       # Detailed text analysis
```

### Weight Storage

```
data/weights/
â”œâ”€â”€ default.toml                 # Legacy fallback (deprecated)
â”œâ”€â”€ generalist.toml              # Auto-deployed generalist weights
â””â”€â”€ specialists/
    â”œâ”€â”€ argentum.toml            # Auto-deployed Argentum specialist
    â”œâ”€â”€ symbiote.toml            # Auto-deployed Symbiote specialist
    â””â”€â”€ obsidion.toml            # Auto-deployed Obsidion specialist
```

**Important:** Bots automatically load weights from these files. No manual copying needed!

---

## Tuning Modes

All modes now test against **Random, Greedy, AND MCTS opponents** for robust training.

### 1. Generalist (Recommended)

Trains weights that work well across **all deck matchups**.

```bash
cargo run --release --bin tune -- \
  --mode generalist \
  --tag generalist-v0.4 \
  --generations 100 \
  --games 100 \
  --mcts-sims 50
```

**When to use:**
- Creating a single bot that plays all decks competently
- First-time tuning to establish a baseline
- Training for tournament play with unknown opponents

**Auto-deploys to:** `data/weights/generalist.toml`

### 2. Faction Specialist (Focused)

Trains weights for **all decks in a specific faction** vs other factions.

```bash
cargo run --release --bin tune -- \
  --mode faction-specialist \
  --faction argentum \
  --tag argentum-v0.4 \
  --generations 100 \
  --games 100 \
  --mcts-sims 50
```

**Available factions:** `argentum`, `symbiote`, `obsidion`

**When to use:**
- Optimizing for a specific faction's playstyle
- Creating specialists for rock-paper-scissors meta
- Training against known opponent factions

**Auto-deploys to:** `data/weights/specialists/{faction}.toml`

### 3. Specialist (Experimental)

Trains weights for **one specific deck** vs **one specific opponent**.

```bash
cargo run --release --bin tune -- \
  --mode specialist \
  --deck argentum_control \
  --opponent symbiote_aggro \
  --tag argentum-vs-symbiote \
  --generations 100 \
  --games 100 \
  --mcts-sims 50
```

**When to use:**
- Counter-tuning for a known opponent deck
- Exploring matchup-specific strategies
- Research/experimentation

**Auto-deploys to:** `data/weights/specialists/{faction}.toml` (inferred from deck name)

**Note:** This mode is less general-purpose than faction-specialist but can achieve higher win rates in specific matchups.

---

## Performance: MCTS Simulations

### The Critical Parameter

The `--mcts-sims` flag controls how many MCTS simulations the **opponent** runs per move during training. This has a **massive impact** on training time.

### The Math

MCTS simulations scale linearly in time, but opponent strength improves with **diminishing returns**:

| MCTS Sims | Opponent Strength | Time/Gen | 100 Gens Total |
|-----------|-------------------|----------|----------------|
| 25        | ~70% optimal      | 3s       | 5 min          |
| **50**    | **~85% optimal**  | **6s**   | **10 min** â­  |
| 100       | ~92% optimal      | 15s      | 25 min         |
| 200       | ~95% optimal      | 63s      | 105 min        |
| 500       | ~97% optimal      | 180s     | 300 min        |

**Real benchmark** (faction-specialist, 100 gens, 100 games):
- `--mcts-sims 200`: **4087.6s** (68 min) ðŸŒ
- `--mcts-sims 50`: **239.7s** (4 min) ðŸš€
- **17x speedup** with minimal quality loss!

### Why 50 is the Sweet Spot

1. **More generations > stronger opponent**
   - Fast iteration allows CMA-ES to explore the weight space better
   - 100 gens @ 50 sims beats 10 gens @ 200 sims every time

2. **50-sim MCTS is already very strong**
   - Much better than GreedyBot baseline
   - Provides consistent, challenging evaluation

3. **Weights converge to high win rates anyway**
   - Example: Gen 0 @ 75% WR â†’ Gen 50 @ 88% WR
   - Already crushing the 50-sim opponent; 200 sims just slows training

### Recommended Workflow

âœ… **DO:** Use `--mcts-sims 50` for tuning (default, fast iteration)  
âœ… **DO:** Validate with `--mcts-sims 200` in arena after tuning (rigorous test)  
âŒ **DON'T:** Use 200+ sims during tuning (wastes 10x time for ~5% quality gain)

```bash
# STEP 1: Fast tuning (50 sims - default)
cargo run --release --bin tune -- \
  --mode faction-specialist --faction symbiote \
  --tag symbiote-v0.4

# STEP 2: Thorough validation (200 sims)
cargo run --release --bin arena -- \
  --bot1 mcts --weights1 data/weights/specialists/symbiote.toml \
  --bot2 mcts --mcts-sims2 200 \
  --games 500 --progress
```

**Fast iteration + rigorous testing = best results!**

---

## Complete Workflow

### Step 1: Choose Your Strategy

**Option A: Train Generalist (Safe Choice)**
```bash
cargo run --release --bin tune -- \
  --mode generalist \
  --tag generalist-v0.4 \
  --generations 100 \
  --games 100 \
  --mcts-sims 50
```
- Takes ~10-15 minutes
- Works well with all decks
- Auto-deploys to `data/weights/generalist.toml`

**Option B: Train All Faction Specialists (Best Performance)**
```bash
# Run these in parallel or sequentially
cargo run --release --bin tune -- --mode faction-specialist --faction argentum --tag argentum-v0.4
cargo run --release --bin tune -- --mode faction-specialist --faction symbiote --tag symbiote-v0.4
cargo run --release --bin tune -- --mode faction-specialist --faction obsidion --tag obsidion-v0.4
```
- Takes ~10 minutes each
- Optimized for specific faction playstyles
- Auto-deploys to `data/weights/specialists/{faction}.toml`

### Step 2: Analyze Results

```bash
# Analyze the latest tuning run
./scripts/analyze-tuning.sh --latest

# Or analyze specific experiment
./scripts/analyze-tuning.sh experiments/mcts/2026-01-14_0719_generalist-v0.4

# Compare multiple experiments
./scripts/analyze-tuning.sh --all
```

This generates:
- `stats.csv` - Parsed training metrics
- `plots/` directory with visualizations
- `plots/summary_report.txt` - Detailed analysis

### Step 3: Weights Are Ready!

**No manual copying needed!** Weights are automatically deployed during training.

Verify deployment:
```bash
# Check generalist weights
ls -lh data/weights/generalist.toml

# Check specialist weights
ls -lh data/weights/specialists/
```

### Step 4: Test Your Weights

```bash
# Test with GreedyBot
cargo run --release --bin arena -- \
  --bot1 greedy --bot2 random \
  --games 100 --progress

# Test with MctsBot (uses weights for rollouts)
cargo run --release --bin arena -- \
  --bot1 mcts --bot2 random \
  --games 50 --progress

# Test specific specialist
cargo run --release --bin arena -- \
  --bot1 greedy --deck1 argentum_control \
  --bot2 greedy --deck2 symbiote_aggro \
  --weights1 data/weights/specialists/argentum.toml \
  --games 100 --progress
```

### Step 5: Commit Good Weights (Optional)

```bash
# If weights show improvement, commit them
git add data/weights/generalist.toml
git add data/weights/specialists/*.toml
git commit -m "Update tuned weights v0.4: [summary of improvements]"
```

---

## Auto-Deploy System

### How It Works

After training completes, weights are **automatically copied** to the appropriate location:

| Tuning Mode         | Auto-Deploy Location                      |
|---------------------|-------------------------------------------|
| `generalist`        | `data/weights/generalist.toml`            |
| `faction-specialist`| `data/weights/specialists/{faction}.toml` |
| `specialist`        | `data/weights/specialists/{faction}.toml` |

You'll see this in the output:
```
âœ“ Weights saved to "experiments/mcts/2026-01-14_0735_argentum-v0.4/weights.toml"
âœ… Auto-deployed to "data/weights/specialists/argentum.toml"
```

### Loading Priority

Bots load weights in this order:

1. **Command-line override**: `--weights1 path/to/custom.toml` (highest priority)
2. **Auto-deployed weights**: `data/weights/generalist.toml` or `specialists/{faction}.toml`
3. **Hardcoded fallback**: Default weights in `src/bots/weights.rs` (lowest priority)

### Manual Override

If you want to test different weights without overwriting auto-deployed ones:

```bash
# Test experimental weights without deploying
cargo run --release --bin arena -- \
  --bot1 greedy \
  --weights1 experiments/mcts/2026-01-14_1200_experimental/weights.toml \
  --bot2 greedy \
  --games 100
```

---

## Cloud Training with Modal (Optional)

For **4x faster parallel training**, use Modal's serverless platform. Instead of training 4 specialists sequentially (~60 min), run them all in parallel (~15 min).

### Quick Start

```bash
# One-time setup (2 minutes)
uv tool install modal
modal token new

# Full pipeline: train all 4 + validate + auto-deploy to local repo
modal run modal_tune.py

# Train only (skip validation)
modal run modal_tune.py --mode train-only

# Single configuration
modal run modal_tune.py --single argentum
```

### What Happens

1. **Phase 1:** 4 parallel training jobs (generalist + 3 faction specialists)
2. **Phase 2:** Balance validation (round-robin: 40 deck matchups Ã— 2 directions Ã— games)
3. **Auto-deploy:** Trained weights automatically copied to `data/weights/`

### When to Use Cloud vs Local

| Scenario | Use | Time | Cost |
|----------|-----|------|------|
| Quick experiment | Local | ~10 min | Free |
| Single specialist | Local | ~10 min | Free |
| All 4 configs | **Cloud** | ~15 min | ~$0.32 |
| Hyperparameter search | **Cloud** | ~15 min | ~$0.50 |

### Full Documentation

See **[modal-cloud-setup.md](modal-cloud-setup.md)** for:
- Detailed setup instructions
- Cost breakdown and optimization
- Troubleshooting
- Advanced configuration

---

## Analysis & Visualization

### Using the Analysis Script

```bash
# Analyze latest experiment
./scripts/analyze-tuning.sh --latest

# Analyze specific experiment by path
./scripts/analyze-tuning.sh experiments/mcts/2026-01-14_0719_generalist-v0.4

# Analyze all experiments in experiments/mcts/
./scripts/analyze-tuning.sh --all

# Force re-generate plots (useful if you updated plotting code)
./scripts/analyze-tuning.sh --latest --force
```

### Generated Outputs

#### `stats.csv`
Parsed training metrics:
```csv
generation,best_fitness,best_win_rate,sigma,time_seconds
0,73.20,0.760,0.2776,4.1
5,74.80,0.760,0.2570,7.0
10,79.60,0.827,0.2297,4.1
...
```

#### `plots/overview.png`
- Top panel: Win rate over generations
- Bottom panel: Fitness score over generations
- Shows convergence trends

#### `plots/efficiency.png`
- Time per generation
- Cumulative training time
- Helps identify performance bottlenecks

#### `plots/convergence.png`
- Weight parameter evolution
- Shows which parameters changed most
- Useful for understanding tuning dynamics

#### `plots/summary_report.txt`
Text-based analysis:
```
=== Tuning Summary ===
Best Win Rate: 88.0%
Best Fitness: 86.80
Total Generations: 100
Total Time: 508.8s (8.5 min)
Average Time/Gen: 5.1s
...
```

---

## Using Tuned Weights

### With GreedyBot

GreedyBot uses weights for **direct state evaluation**:

```rust
score = w.own_life * state.life
      + w.enemy_life_damage * damage_dealt
      + w.creature_count * creatures.len()
      + ... (24 total weight parameters)
```

**Usage:**
```bash
# Auto-loads from data/weights/generalist.toml
cargo run --release --bin arena -- --bot1 greedy --bot2 random --games 100

# Override with specific weights
cargo run --release --bin arena -- \
  --bot1 greedy --weights1 data/weights/specialists/argentum.toml \
  --bot2 random --games 100
```

### With MctsBot (Most Powerful!)

MctsBot uses weights for **rollout evaluation** during tree search:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MctsBot    â”‚  Selects best action via UCB1 tree search
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tree Search   â”‚  For each node, runs simulations:
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Selection (UCB1)   â”‚  Navigate tree to leaf
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Expansion          â”‚  Add new node
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Rollout            â”‚  Simulate game to end using GreedyBot
  â”‚  (Uses Tuned        â”‚  â† Tuned weights make this smarter!
  â”‚   Weights!)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Backpropagation    â”‚  Update tree with results
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key insight:** Better rollouts = more accurate value estimates = better move selection

**Usage:**
```bash
# Auto-loads from data/weights/generalist.toml
cargo run --release --bin arena -- --bot1 mcts --bot2 random --games 50

# Override with specific weights
cargo run --release --bin arena -- \
  --bot1 mcts --weights1 data/weights/specialists/symbiote.toml \
  --bot2 mcts --games 50
```

### Comparing Weights

Test if new weights improved performance:

```bash
# Generalist vs default
cargo run --release --bin arena -- \
  --bot1 greedy --weights1 data/weights/generalist.toml \
  --bot2 greedy \
  --games 500 --progress

# Specialist vs generalist
cargo run --release --bin arena -- \
  --bot1 greedy --weights1 data/weights/specialists/argentum.toml \
  --bot2 greedy --weights2 data/weights/generalist.toml \
  --deck1 argentum_control --deck2 symbiote_aggro \
  --games 500 --progress
```

---

## How MCTS Uses Weights

### The Evaluation Chain

```
User calls MctsBot.select_action()
  â”‚
  â”œâ”€â–º Run N simulations (e.g., 200)
  â”‚     â”‚
  â”‚     â”œâ”€â–º For each simulation:
  â”‚     â”‚     â”‚
  â”‚     â”‚     â”œâ”€â–º Selection: Navigate tree using UCB1
  â”‚     â”‚     â”‚
  â”‚     â”‚     â”œâ”€â–º Expansion: Add new node
  â”‚     â”‚     â”‚
  â”‚     â”‚     â”œâ”€â–º Rollout: Play random game to end
  â”‚     â”‚     â”‚   â”‚
  â”‚     â”‚     â”‚   â””â”€â–º Uses GreedyBot with tuned weights!
  â”‚     â”‚     â”‚       (Makes better decisions during simulation)
  â”‚     â”‚     â”‚
  â”‚     â”‚     â””â”€â–º Backpropagate: Update win counts
  â”‚     â”‚
  â”‚     â””â”€â–º Aggregate results
  â”‚
  â””â”€â–º Return action with highest win rate
```

### Why Weights Matter for MCTS

**Without tuned weights (random rollouts):**
- Simulations explore randomly
- Tree values are noisy
- Needs many sims to converge
- Poor move quality

**With tuned weights (greedy rollouts):**
- Simulations play intelligently
- Tree values are accurate faster
- Needs fewer sims for same quality
- Excellent move quality

**Empirical results:**
- MCTS (tuned weights, 50 sims) beats MCTS (default weights, 200 sims)
- ~10% win rate improvement in most matchups

---

## Troubleshooting

### Training is very slow

**Problem:** 100 generations taking >1 hour

**Solutions:**
1. Check `--mcts-sims` is set to 50 (not 200+)
2. Verify `--parallel true` (default)
3. Reduce `--games` (e.g., 50 instead of 100)
4. Use faster mode: `specialist` < `faction-specialist` < `generalist`

### Weights not auto-deploying

**Problem:** No "âœ… Auto-deployed" message after training

**Check:**
1. Mode is `generalist`, `faction-specialist`, or `specialist`
2. For `faction-specialist`: `--faction` is specified
3. For `specialist`: `--deck` is specified (faction inferred from deck name)
4. Directory `data/weights/specialists/` exists and is writable

### Win rate not improving

**Problem:** Best win rate stuck at low value (e.g., 30-40%)

**Possible causes:**
1. **Tough matchup**: Some faction vs faction matchups are naturally hard (e.g., control vs aggro)
2. **Not enough generations**: Try 150-200 generations
3. **MCTS opponent too strong**: Try `--mcts-sims 25` to make opponent weaker
4. **CMA-ES stuck**: Try different `--sigma` (e.g., 0.5 for more exploration)

### Analysis script fails

**Problem:** `./scripts/analyze-tuning.sh --latest` errors

**Solutions:**
1. Ensure Python dependencies installed: `uv sync --all-groups`
2. Check experiment directory has `train.log` file
3. Try manual analysis: `uv run python python/scripts/analyze_tuning.py experiments/mcts/2026-01-14_HHMM_tag`

### Weights don't seem to help

**Problem:** Tuned weights perform same as defaults in arena

**Verification steps:**
1. Check bot is actually loading weights: Add `--verbose` or check code
2. Verify weights are different from defaults: Compare TOML files
3. Test with enough games: 100+ for statistical significance
4. Use MCTS bot (benefits more from weights than GreedyBot alone)

---

## Advanced Topics

### Custom Initial Weights

Start tuning from existing weights instead of defaults:

```bash
cargo run --release --bin tune -- \
  --mode generalist \
  --initial-weights data/weights/generalist.toml \
  --tag generalist-refine
```

### Early Stopping

Stop when target win rate achieved:

```bash
cargo run --release --bin tune -- \
  --mode faction-specialist --faction symbiote \
  --target-win-rate 0.90 \
  --generations 200
```

Stops when win rate â‰¥ 90% or 200 generations reached.

### Hyperparameter Tuning

Adjust CMA-ES behavior:

```bash
cargo run --release --bin tune -- \
  --mode generalist \
  --sigma 0.5 \              # Larger initial step size (more exploration)
  --min-sigma 0.0001 \       # Stricter convergence threshold
  --population 20            # Larger population (slower but more thorough)
```

### Seed Control

Ensure reproducibility:

```bash
# Same seed = same results (deterministic)
cargo run --release --bin tune -- --mode generalist --seed 12345
```

---

## Command Reference

### All CLI Flags

```bash
cargo run --release --bin tune -- --help
```

**Essential flags:**
- `--mode <MODE>`: generalist | specialist | faction-specialist
- `--tag <TAG>`: Experiment name (default: "default")
- `--generations <N>`: Number of CMA-ES generations (default: 100)
- `--games <N>`: Games per evaluation (default: 100)
- `--mcts-sims <N>`: MCTS sims for opponents (default: 50)

**Mode-specific flags:**
- `--faction <FACTION>`: For faction-specialist (argentum, symbiote, obsidion)
- `--deck <DECK_ID>`: For specialist (e.g., argentum_control)
- `--opponent <DECK_ID>`: For specialist (e.g., symbiote_aggro)

**CMA-ES flags:**
- `--sigma <F>`: Initial step size (default: 0.3)
- `--min-sigma <F>`: Convergence threshold (default: 0.001)
- `--population <N>`: Population size (default: auto)
- `--target-win-rate <F>`: Early stopping threshold (0.0-1.0)
- `--initial-weights <PATH>`: Start from existing weights

**System flags:**
- `--seed <N>`: Random seed (default: 42)
- `--parallel <BOOL>`: Enable parallelism (default: true)
- `--verbose`: Print each generation
- `--experiment-dir <PATH>`: Base output dir (default: experiments)
- `--cards <PATH>`: Card database path (default: data/cards/core_set)
- `--decks <PATH>`: Deck registry path (default: data/decks)

---

## See Also

- [design-engine.md](design-engine.md) - Game rules and mechanics
- [data-strategy.md](data-strategy.md) - Data management conventions
- [CLAUDE.md](../CLAUDE.md) - Full project documentation
- [roadmap.txt](../roadmap.txt) - Future work and planned features
