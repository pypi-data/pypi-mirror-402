"""Auto-generated API classes{% if client_type == 'websocket' %} for WebSocket{% endif %}"""

from enum import Enum
from typing import Callable, Any, List, Awaitable

import msgspec

{% if client_type == 'http' %}
from derive_client._clients.rest{% if is_async %}.async_http{% else %}.http{% endif %}.session import {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}
from derive_client.config import PUBLIC_HEADERS
from derive_client.data_types import EnvConfig
from derive_client._clients.utils import decode_envelope, decode_result, AuthContext, encode_json_exclude_none
from derive_client._clients.rest.endpoints import PublicEndpoints, PrivateEndpoints
{% else %}
from derive_client._clients.websockets.session import WebSocketSession
from derive_client._clients.utils import decode_envelope, decode_result, encode_json_exclude_none
{% endif %}
from derive_client.data_types.generated_models import (
{% for schema in rpc_schema_imports -%}
    {% if schema in rpc_import_aliases -%}
    {{ schema }} as {{ rpc_import_aliases[schema] }},
    {% else -%}
    {{ schema }},
    {% endif -%}
{% endfor %}
)
{% if client_type == 'websocket' and channel_schema_imports %}
from derive_client.data_types.channel_models import (
{% for schema in channel_schema_imports -%}
    {% if schema in channel_import_aliases -%}
    {{ schema }} as {{ channel_import_aliases[schema] }},
    {% else -%}
    {{ schema }},
    {% endif -%}
{% endfor %}
)
{% endif %}


class SubscriptionResult(msgspec.Struct):
    status: dict[str, str]
    current_subscriptions: list[str]


# ============================================================================
# RPC API Classes
# ============================================================================

class {{ api_prefix }}PublicRPC:
    """{{ api_prefix }} public RPC methods"""

    def __init__(self, session{% if client_type == 'http' %}: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig{% else %}: WebSocketSession{% endif %}):
        self._session = session
{% if client_type == 'http' %}
        self._config = config
        self._endpoints = PublicEndpoints(config.base_url)

    @property
    def headers(self) -> dict:
        return PUBLIC_HEADERS
{% endif %}

{% for method in public_rpc_methods %}
    {% if is_async %}async {% endif %}def {{ method.name }}(self, params: {{ method.request_type if method.request_type not in rpc_import_aliases else rpc_import_aliases[method.request_type] }},) -> {{ method.result_type | replace('List[', 'list[') }}:
        {% if method.description %}
        """
        {{ method.description | format_docstring }}
        """
        {% endif %}
{% if client_type == 'http' %}
        url = self._endpoints.{{ method.name }}
        data = encode_json_exclude_none(params)
        message = {% if is_async %}await {% endif %}self._session._send_request(url, data, headers=self.headers)
        envelope = decode_envelope(message)
{%- else %}
        method = "public/{{ method.name }}"
        envelope = {% if is_async %}await {% endif %}self._session._send_request(method, params=params)
{%- endif %}
        result = decode_result(envelope, {{ method.result_type | replace('List[', 'list[') }})

        return result
{% endfor %}


class {{ api_prefix }}PrivateRPC:
    """{{ api_prefix }} private RPC methods"""

    def __init__(self, session{% if client_type == 'http' %}: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig, auth: AuthContext{% else %}: WebSocketSession{% endif %}):
        self._session = session
{% if client_type == 'http' %}
        self._config = config
        self._auth = auth
        self._endpoints = PrivateEndpoints(config.base_url)

    @property
    def headers(self) -> dict:
        return {**PUBLIC_HEADERS, **self._auth.signed_headers}
{% endif %}

{% for method in private_rpc_methods %}
    {% if is_async %}async {% endif %}def {{ method.name }}(self, params: {{ method.request_type }},) -> {{ method.result_type }}:
        {% if method.description %}
        """
        {{ method.description | format_docstring }}
        """
        {% endif %}
{% if client_type == 'http' %}
        url = self._endpoints.{{ method.name }}
        data = encode_json_exclude_none(params)
        message = {% if is_async %}await {% endif %}self._session._send_request(url, data, headers=self.headers)
        envelope = decode_envelope(message)
{%- else %}
        method = "private/{{ method.name }}"
        envelope = {% if is_async %}await {% endif %}self._session._send_request(method, params=params)
{%- endif %}
        result = decode_result(envelope, {{ method.result_type | replace('List[', 'list[') }})

        return result
{% endfor %}

{% if client_type == 'websocket' %}

# ============================================================================
# Channel Subscription Classes
# ============================================================================

class {{ api_prefix }}PublicChannels:
    """{{ api_prefix }} public channel subscriptions"""

    def __init__(self, session: WebSocketSession):
        self._session = session

{% for channel in public_channels %}
    {% if is_async %}async {% endif %}def {{ channel.name }}(
        self,
        {% for param in channel.params -%}
        {{ param.name }}: {{ param.type_annotation }},
        {% endfor -%}
        callback: Callable[[{{ channel.notification_data_type }}], None | Awaitable[None]],
    ) -> SubscriptionResult:
        {% if channel.description %}
        """
        {{ channel.description | format_docstring }}

        Args:
            {% for param in channel.params -%}
            {{ param.name }}: {{ param.name | replace('_', ' ') | title }}
            {% endfor -%}
            callback: Callback function to handle notifications

        Returns:
            Subscription result with status and current subscriptions
        """
        {% endif %}
        channel = "{{ channel.channel_pattern }}".format(
            {% for param in channel.params -%}
            {{ param.name }}={{ param.name }}.value if isinstance({{ param.name }}, Enum) else {{ param.name }},
            {% endfor -%}
        )
        envelope = {% if is_async %}await {% endif %}self._session.subscribe(channel, callback, {{ channel.notification_data_type }})
        result = decode_result(envelope, SubscriptionResult)

        return result

{% endfor %}

class {{ api_prefix }}PrivateChannels:
    """{{ api_prefix }} private channel subscriptions"""

    def __init__(self, session: WebSocketSession):
        self._session = session

{% for channel in private_channels %}
    {% if is_async %}async {% endif %}def {{ channel.name }}(
        self,
        {% for param in channel.params -%}
        {{ param.name }}: {{ param.type_annotation }},
        {% endfor -%}
        callback: Callable[[{{ channel.notification_data_type }}], None | Awaitable[None]],
    ) -> SubscriptionResult:
        {% if channel.description %}
        """
        {{ channel.description | format_docstring }}

        Args:
            {% for param in channel.params -%}
            {{ param.name }}: {{ param.name | replace('_', ' ') | title }}
            {% endfor -%}
            callback: Callback function to handle notifications

        Returns:
            Subscription result with status and current subscriptions
        """
        {% endif %}
        channel = "{{ channel.channel_pattern }}".format(
            {% for param in channel.params -%}
            {{ param.name }}={{ param.name }}.value if isinstance({{ param.name }}, Enum) else {{ param.name }},
            {% endfor -%}
        )
        envelope = {% if is_async %}await {% endif %}self._session.subscribe(channel, callback, {{ channel.notification_data_type }})
        result = decode_result(envelope, SubscriptionResult)

        return result

{% endfor %}
{% endif %}

# ============================================================================
# Combined API Classes
# ============================================================================

class {{ api_prefix }}PublicAPI:
    """Combined {{ api_prefix }} public API{% if client_type == 'websocket' %} - RPC and channels{% endif %}"""

    def __init__(self, session{% if client_type == 'http' %}: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig{% else %}: WebSocketSession{% endif %}):
        self.rpc = {{ api_prefix }}PublicRPC(session{% if client_type == 'http' %}, config{% endif %})
{% if client_type == 'websocket' %}
        self.channels = {{ api_prefix }}PublicChannels(session)
{% endif %}


class {{ api_prefix }}PrivateAPI:
    """Combined {{ api_prefix }} private API{% if client_type == 'websocket' %} - RPC and channels{% endif %}"""

    def __init__(self, session{% if client_type == 'http' %}: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig, auth: AuthContext{% else %}: WebSocketSession{% endif %}):
        self.rpc = {{ api_prefix }}PrivateRPC(session{% if client_type == 'http' %}, config, auth{% endif %})
{% if client_type == 'websocket' %}
        self.channels = {{ api_prefix }}PrivateChannels(session)
{% endif %}