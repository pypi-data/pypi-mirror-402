name: Auto Labeler

on:
  pull_request:
    types: [opened, edited, synchronized, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  label-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR based on title
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;
            const labelsToAdd = new Set();
            
            // Map regex patterns to labels
            // Patterns cover "type:", "type/", and "type " formats
            const mappings = [
              { label: 'feat', regex: /^(feat|feature|Feat)(\/|:|\s|\()/i },
              { label: 'fix', regex: /^(fix|bug|Fix)(\/|:|\s|\()/i },
              { label: 'docs', regex: /^(docs|doc|documentation|Docs)(\/|:|\s|\()/i },
              { label: 'style', regex: /^(style|format)(\/|:|\s|\()/i },
              { label: 'refactor', regex: /^(refactor)(\/|:|\s|\()/i },
              { label: 'perf', regex: /^(perf|performance)(\/|:|\s|\()/i },
              { label: 'test', regex: /^(test|tests)(\/|:|\s|\()/i },
              { label: 'build', regex: /^(build)(\/|:|\s|\()/i },
              { label: 'ci', regex: /^(ci|workflow|actions)(\/|:|\s|\()/i },
              { label: 'chore', regex: /^(chore|misc|remove)(\/|:|\s|\()/i },
              { label: 'dependencies', regex: /^(deps|dep|depbot|dependencies)(\/|:|\s|\()/i }
            ];

            for (const { label, regex } of mappings) {
              if (regex.test(title)) {
                labelsToAdd.add(label);
              }
            }

            if (labelsToAdd.size > 0) {
              console.log(`Adding labels: ${Array.from(labelsToAdd)}`);
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labelsToAdd)
                });
              } catch (error) {
                console.log("Error adding labels. Ensure they exist in the repository.");
                console.error(error);
              }
            } else {
              console.log("No matching label patterns found in title.");
            }
